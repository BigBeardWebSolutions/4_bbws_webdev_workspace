name: Sync Website to S3 & CloudFront

on:
  # Auto-trigger on push to extracted_sites folders
  push:
    paths:
      - 'website_extractor/website-migrator/extracted_sites/dev/**'
      - 'website_extractor/website-migrator/extracted_sites/sit/**'
      - 'website_extractor/website-migrator/extracted_sites/prod/**'
    branches:
      - main

  # Manual trigger (still available)
  workflow_dispatch:
    inputs:
      folder_name:
        description: 'Website folder to sync (from extracted_sites directory)'
        required: true
        type: string
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
          - sit
      dry_run:
        description: 'Dry run (preview changes without executing)'
        required: false
        type: boolean
        default: false
      delete_removed:
        description: 'Delete files from S3 that are not in local folder'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write   # Required for AWS OIDC authentication
  contents: read    # Required to checkout repository

jobs:
  # Detect changed folders and environment
  detect-changes:
    name: Detect Changed Folders
    runs-on: ubuntu-latest
    outputs:
      folders: ${{ steps.detect.outputs.folders }}
      environment: ${{ steps.detect.outputs.environment }}
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: ğŸ” Detect Changed Folders
        id: detect
        run: |
          # For manual trigger, use inputs
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "folders=[{\"name\":\"${{ inputs.folder_name }}\",\"env\":\"${{ inputs.environment }}\"}]" >> $GITHUB_OUTPUT
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "Manual trigger: ${{ inputs.folder_name }} â†’ ${{ inputs.environment }}"
            exit 0
          fi

          # For push events, detect changed folders
          echo "ğŸ” Detecting changed folders from git diff..."

          # Get changed files
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Extract unique folder/environment combinations
          FOLDERS_JSON="["
          FIRST=true

          for FILE in $CHANGED_FILES; do
            # Check if file is in website_extractor/website-migrator/extracted_sites/{env}/{folder}/
            if [[ $FILE =~ ^website_extractor/website-migrator/extracted_sites/(dev|sit|prod)/([^/]+)/ ]]; then
              ENV="${BASH_REMATCH[1]}"
              FOLDER="${BASH_REMATCH[2]}"

              echo "ğŸ“ Detected change: $FOLDER (environment: $ENV)"

              # Add to JSON array (avoiding duplicates with simple check)
              if [[ $FIRST == true ]]; then
                FOLDERS_JSON="${FOLDERS_JSON}{\"name\":\"${FOLDER}\",\"env\":\"${ENV}\"}"
                FIRST=false
              else
                # Simple duplicate check - could be enhanced
                if ! echo "$FOLDERS_JSON" | grep -q "\"name\":\"${FOLDER}\",\"env\":\"${ENV}\""; then
                  FOLDERS_JSON="${FOLDERS_JSON},{\"name\":\"${FOLDER}\",\"env\":\"${ENV}\"}"
                fi
              fi
            fi
          done

          FOLDERS_JSON="${FOLDERS_JSON}]"

          echo "folders=$FOLDERS_JSON" >> $GITHUB_OUTPUT
          echo ""
          echo "ğŸ“‹ Detected folders to deploy:"
          echo "$FOLDERS_JSON" | jq '.'

  validate-and-sync:
    name: Deploy ${{ matrix.folder.name }} â†’ ${{ matrix.folder.env }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.folders != '[]'
    strategy:
      matrix:
        folder: ${{ fromJson(needs.detect-changes.outputs.folders) }}
      fail-fast: false  # Continue deploying other folders even if one fails
    environment: ${{ matrix.folder.env }}

    steps:
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 1: Checkout Repository
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 2: Configure AWS Credentials (OIDC)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-west-1
          role-session-name: GitHubActions-${{ matrix.folder.env }}-${{ github.run_id }}

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 3: Verify AWS Credentials
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: âœ… Verify AWS Credentials
        run: |
          echo "ğŸ” Verifying AWS credentials..."
          AWS_IDENTITY=$(aws sts get-caller-identity)
          echo "âœ… Authenticated as:"
          echo "$AWS_IDENTITY" | jq '.'
          echo ""
          echo "ğŸ“ Region: eu-west-1"
          echo "ğŸ·ï¸  Environment: ${{ matrix.folder.env }}"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 4: Run Validation Only
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸ” Validate Deployment Prerequisites
        id: validate
        run: |
          echo "ğŸ” Validating deployment prerequisites..."
          chmod +x website_extractor/website-migrator/scripts/03_upload/sync.sh

          # Run validation (outputs to stdout and GITHUB_OUTPUT)
          website_extractor/website-migrator/scripts/03_upload/sync.sh \
            "${{ matrix.folder.name }}" \
            "${{ matrix.folder.env }}" \
            --github-actions

          echo "âœ… Validation completed successfully"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 5: Display Deployment Plan
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸ“‹ Deployment Plan
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              DEPLOYMENT PLAN                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ Folder:           ${{ matrix.folder.name }}"
          echo "ğŸŒ Environment:      ${{ matrix.folder.env }}"
          echo "ğŸ·ï¸  Mode:             LIVE DEPLOYMENT (auto-triggered)"
          echo "ğŸ—‘ï¸  Delete Removed:   No"
          echo ""
          echo "ğŸ“‚ Local Folder:     ${{ steps.validate.outputs.local_folder }}"
          echo "ğŸ“¦ S3 Bucket:        ${{ steps.validate.outputs.s3_bucket_uri }}"
          echo "â˜ï¸  CloudFront ID:    ${{ steps.validate.outputs.distribution_id }}"
          echo ""
          if [ -n "${{ steps.validate.outputs.cloudfront_domain }}" ]; then
            echo "ğŸŒ CloudFront Domain: ${{ steps.validate.outputs.cloudfront_domain }}"
          fi
          echo ""

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 6: Sync to S3
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸ“¤ Sync Files to S3
        run: |
          echo "ğŸ“¤ Syncing files to S3..."

          # Build sync command (no delete by default for auto-triggered deployments)
          SYNC_CMD="aws s3 sync \"${{ steps.validate.outputs.local_folder }}\" \"${{ steps.validate.outputs.s3_bucket_uri }}\" --region eu-west-1"

          echo "ğŸ”§ Running: $SYNC_CMD"
          eval $SYNC_CMD

          echo "âœ… S3 sync completed successfully"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 7: Create CloudFront Invalidation
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: â™»ï¸  Invalidate CloudFront Cache
        id: invalidate
        run: |
          echo "â™»ï¸  Creating CloudFront invalidation..."

          DISTRIBUTION_ID="${{ steps.validate.outputs.distribution_id }}"

          # Create invalidation
          INVALIDATION_OUTPUT=$(aws cloudfront create-invalidation \
            --distribution-id "$DISTRIBUTION_ID" \
            --paths "/*" \
            --query 'Invalidation.{Id:Id,Status:Status,CreateTime:CreateTime}' \
            --output json)

          INVALIDATION_ID=$(echo "$INVALIDATION_OUTPUT" | jq -r '.Id')

          echo "invalidation_id=$INVALIDATION_ID" >> $GITHUB_OUTPUT

          echo "âœ… Invalidation created"
          echo "ğŸ†” Invalidation ID: $INVALIDATION_ID"
          echo "$INVALIDATION_OUTPUT" | jq '.'
          echo ""

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 9: Wait for Invalidation to Complete (if not dry run)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: â³ Wait for Cache Invalidation
        if: ${{ !inputs.dry_run }}
        run: |
          echo "â³ Waiting for CloudFront invalidation to complete..."

          DISTRIBUTION_ID="${{ steps.validate.outputs.distribution_id }}"
          INVALIDATION_ID="${{ steps.invalidate.outputs.invalidation_id }}"

          echo "ğŸ”„ Monitoring invalidation: $INVALIDATION_ID"
          echo "â±ï¸  This typically takes 1-5 minutes..."
          echo ""

          # Wait for invalidation with timeout
          TIMEOUT=900  # 15 minutes
          ELAPSED=0
          INTERVAL=10

          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(aws cloudfront get-invalidation \
              --distribution-id "$DISTRIBUTION_ID" \
              --id "$INVALIDATION_ID" \
              --query 'Invalidation.Status' \
              --output text)

            echo "â±ï¸  Elapsed: ${ELAPSED}s | Status: $STATUS"

            if [ "$STATUS" = "Completed" ]; then
              echo ""
              echo "âœ… CloudFront cache invalidation completed successfully!"
              exit 0
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo ""
          echo "âš ï¸  Warning: Invalidation did not complete within ${TIMEOUT}s"
          echo "âš ï¸  The invalidation is still in progress and will complete soon."
          echo "âš ï¸  Check AWS Console for status: $INVALIDATION_ID"
          exit 0  # Don't fail the workflow

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 10: Deployment Summary
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸ‰ Deployment Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              DEPLOYMENT SUMMARY                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ Folder:             ${{ matrix.folder.name }}"
          echo "ğŸŒ Environment:        ${{ matrix.folder.env }}"
          echo "ğŸ·ï¸  Mode:               LIVE DEPLOYMENT (auto-triggered)"
          echo "ğŸ“¦ S3 Bucket:          ${{ steps.validate.outputs.s3_bucket_uri }}"
          echo "â˜ï¸  CloudFront ID:      ${{ steps.validate.outputs.distribution_id }}"

          if [ -n "${{ steps.validate.outputs.cloudfront_domain }}" ]; then
            echo "ğŸŒ CloudFront Domain:  ${{ steps.validate.outputs.cloudfront_domain }}"
            echo "ğŸ”— URL:                https://${{ steps.validate.outputs.cloudfront_domain }}"
          fi

          if [ -n "${{ steps.invalidate.outputs.invalidation_id }}" ]; then
            echo "â™»ï¸  Invalidation ID:    ${{ steps.invalidate.outputs.invalidation_id }}"
          fi

          echo ""
          echo "ğŸ•’ Started:            ${{ github.event.head_commit.timestamp || github.event.created_at }}"
          echo "ğŸ‘¤ Triggered by:       ${{ github.actor }}"
          echo "ğŸ”¢ Run ID:             ${{ github.run_id }}"
          echo ""

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Status: DEPLOYMENT SUCCESSFUL"
          else
            echo "âŒ Status: DEPLOYMENT FAILED"
          fi

          echo ""
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
