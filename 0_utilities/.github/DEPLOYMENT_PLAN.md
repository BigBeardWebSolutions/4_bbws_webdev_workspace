# GitHub Actions Deployment Workflow - Validation & Execution Plan

## üìã Overview

This document provides a comprehensive validation plan for the GitHub Actions workflow that syncs website folders from the repository to S3 and invalidates CloudFront distributions.

## üîç Current Workflow Analysis

### ‚úÖ Strengths (Your Proposed Workflow)
1. **Manual trigger** - Uses `workflow_dispatch` for controlled deployments
2. **Parameterized** - Accepts folder name and environment as inputs
3. **Multi-environment support** - Handles dev and prod environments
4. **CloudFront integration** - Automated invalidation with wait

### ‚ùå Critical Issues Identified

#### 1. **AWS Authentication Issues**
```yaml
env:
  AWS_WEB_IDENTITY_TOKEN_FILE: ${{ secrets.AWS_WEB_IDENTITY_TOKEN_FILE }}
```
**Problem**:
- You're referencing `AWS_WEB_IDENTITY_TOKEN_FILE` as a secret, but this should be automatically generated by GitHub OIDC
- Missing `permissions` block for OIDC token generation
- Not using the official `aws-actions/configure-aws-credentials` action

**Impact**: Authentication will fail

#### 2. **Local Folder Path Resolution**
```yaml
LOCAL_FOLDER=$(find ~ -type d -path "*/0_utilities/website_extractor/website-migrator/extracted_sites/prod/$FOLDER_NAME" | head -n 1)
```
**Problem**:
- Searches from `~` (home directory) in GitHub Actions runner
- The repository is checked out to `$GITHUB_WORKSPACE`, not home directory
- This will fail to find the folder

**Impact**: Sync step will fail

#### 3. **Redundant Validation**
```yaml
# Step 3 runs sync.sh, but steps 4 and 5 duplicate the logic
```
**Problem**:
- The sync.sh script validates everything but doesn't perform the actual sync
- Steps 4 and 5 re-implement the same logic (folder lookup, CloudFront query)
- Inefficient and error-prone

**Impact**: Duplicated code and potential inconsistencies

#### 4. **Missing Error Handling**
**Problem**:
- No `set -e` or error handling in bash scripts
- CloudFront wait command may hang indefinitely
- No timeout on invalidation wait

**Impact**: Failed deployments may not be detected

#### 5. **Region Parameter Issues**
```yaml
aws cloudfront create-invalidation ... --region $REGION
```
**Problem**:
- CloudFront is a global service and doesn't use `--region` parameter
- This will cause the command to fail

**Impact**: Invalidation will fail

## üéØ Recommended Solution

### Strategy: Enhance sync.sh to Support Full Deployment

Instead of duplicating logic, enhance the `sync.sh` script to:
1. Validate (current functionality)
2. **Optionally execute sync** (new)
3. **Optionally execute invalidation** (new)
4. **Export outputs for GitHub Actions** (new)

### Benefits:
- ‚úÖ Single source of truth
- ‚úÖ Testable locally
- ‚úÖ Reusable in GitHub Actions
- ‚úÖ Consistent behavior across environments
- ‚úÖ Easier to maintain

## üìù Execution Plan

### Phase 1: Enhance sync.sh Script (30 minutes)

**Tasks:**
1. Add `--sync` flag to perform actual S3 sync
2. Add `--invalidate` flag to trigger CloudFront invalidation
3. Add `--github-actions` flag to export outputs in GitHub Actions format
4. Add `--dry-run` flag for testing
5. Improve error handling with proper exit codes
6. Add timeout handling for CloudFront operations

**File to modify**: `scripts/03_upload/sync.sh`

### Phase 2: Create GitHub Actions Workflow (20 minutes)

**Tasks:**
1. Create new workflow file: `.github/workflows/website-sync.yml`
2. Use proper OIDC authentication
3. Leverage enhanced sync.sh script
4. Add proper error handling and notifications
5. Support dev, prod, and sit environments
6. Add deployment summary and artifacts

**File to create**: `.github/workflows/website-sync.yml`

### Phase 3: Testing Strategy (30 minutes)

**Tasks:**
1. Test locally with `--dry-run`
2. Test dev environment deployment
3. Validate CloudFront invalidation
4. Test error scenarios
5. Document common issues and solutions

### Phase 4: Documentation (15 minutes)

**Tasks:**
1. Update README with workflow usage
2. Create troubleshooting guide
3. Document secrets configuration
4. Add runbook for common operations

## üîß Technical Implementation Details

### 1. Enhanced sync.sh Script Structure

```bash
#!/bin/bash

# New flags:
# --sync              Perform S3 sync after validation
# --invalidate        Create CloudFront invalidation after sync
# --github-actions    Export outputs in GitHub Actions format
# --dry-run          Preview changes without executing
# --delete           Delete files from S3 not present locally

# GitHub Actions outputs:
# - distribution_id
# - local_folder
# - s3_bucket_uri
# - cloudfront_domain (if available)
```

### 2. GitHub Actions Workflow Structure

```yaml
name: Sync Website to S3 & CloudFront

on:
  workflow_dispatch:
    inputs:
      folder_name:
        description: 'Website folder to sync'
        required: true
      environment:
        description: 'Environment (dev/prod/sit)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
          - sit
      dry_run:
        description: 'Dry run (preview changes only)'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required to checkout code

jobs:
  sync-and-deploy:
    name: Sync ${{ inputs.folder_name }} to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-west-1
          role-session-name: GitHubActions-${{ inputs.environment }}-${{ github.run_id }}

      - name: Sync and Deploy
        run: |
          chmod +x scripts/03_upload/sync.sh
          scripts/03_upload/sync.sh \
            "${{ inputs.folder_name }}" \
            "${{ inputs.environment }}" \
            --sync \
            --invalidate \
            --github-actions \
            ${{ inputs.dry_run && '--dry-run' || '' }}
```

### 3. Required GitHub Secrets

| Secret Name | Description | Example Value |
|------------|-------------|---------------|
| `AWS_ROLE_ARN` | IAM Role ARN for OIDC | `arn:aws:iam::536580886816:role/GitHubActionsRole` |

**Note**: No need for `AWS_WEB_IDENTITY_TOKEN_FILE` - this is automatically handled by the `configure-aws-credentials` action.

### 4. Required IAM Permissions

The GitHub Actions role needs:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket",
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": [
        "arn:aws:s3:::bigbeard-migrated-site-dev",
        "arn:aws:s3:::bigbeard-migrated-site-dev/*",
        "arn:aws:s3:::bigbeard-migrated-site-prod",
        "arn:aws:s3:::bigbeard-migrated-site-prod/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudfront:ListDistributions",
        "cloudfront:GetDistribution",
        "cloudfront:CreateInvalidation",
        "cloudfront:GetInvalidation"
      ],
      "Resource": "*"
    }
  ]
}
```

## üß™ Testing Strategy

### Local Testing (Before GitHub Actions)

```bash
# 1. Dry run validation
./scripts/03_upload/sync.sh stafpro dev --dry-run

# 2. Validation only (current behavior)
./scripts/03_upload/sync.sh stafpro dev

# 3. Full sync (new)
./scripts/03_upload/sync.sh stafpro dev --sync

# 4. Full deployment (new)
./scripts/03_upload/sync.sh stafpro dev --sync --invalidate

# 5. GitHub Actions output format
./scripts/03_upload/sync.sh stafpro dev --github-actions
```

### GitHub Actions Testing Sequence

1. **Test with dry-run first**
   - Trigger workflow with `dry_run: true`
   - Verify validation passes
   - Check outputs

2. **Test dev environment**
   - Deploy a test folder to dev
   - Verify S3 sync
   - Verify CloudFront invalidation
   - Check site accessibility

3. **Test prod environment**
   - Use a safe test folder
   - Verify production deployment
   - Validate CloudFront cache cleared

### Error Scenario Testing

1. **Missing folder**
   - Attempt to sync non-existent folder
   - Verify clear error message

2. **AWS credential failure**
   - Temporarily invalidate credentials
   - Verify error handling

3. **CloudFront not found**
   - Attempt sync for folder without distribution
   - Verify graceful handling

## üìä Success Criteria

### Phase 1 Success Criteria
- ‚úÖ sync.sh accepts new flags
- ‚úÖ `--sync` performs S3 sync correctly
- ‚úÖ `--invalidate` creates CloudFront invalidation
- ‚úÖ `--github-actions` exports proper outputs
- ‚úÖ `--dry-run` previews without executing
- ‚úÖ Error handling works correctly

### Phase 2 Success Criteria
- ‚úÖ Workflow file is valid YAML
- ‚úÖ OIDC authentication works
- ‚úÖ Workflow can be triggered manually
- ‚úÖ All environments supported (dev/prod/sit)
- ‚úÖ Proper error messages displayed

### Phase 3 Success Criteria
- ‚úÖ Local dry-run test passes
- ‚úÖ Dev deployment succeeds
- ‚úÖ Site is accessible via CloudFront
- ‚úÖ Cache invalidation completes
- ‚úÖ Error scenarios handled gracefully

### Phase 4 Success Criteria
- ‚úÖ README updated with usage instructions
- ‚úÖ Troubleshooting guide created
- ‚úÖ Secrets documented
- ‚úÖ Common operations documented

## üöÄ Rollout Plan

### Step 1: Prepare (Day 1 - Morning)
1. Review this plan with team
2. Create feature branch: `feature/github-actions-sync`
3. Back up current workflow file

### Step 2: Implement (Day 1 - Afternoon)
1. Enhance sync.sh script
2. Test locally with multiple folders
3. Create new workflow file
4. Commit changes

### Step 3: Test (Day 2 - Morning)
1. Test workflow in dev environment
2. Verify S3 sync and CloudFront invalidation
3. Test error scenarios
4. Document any issues

### Step 4: Deploy (Day 2 - Afternoon)
1. Merge to main branch
2. Test production deployment with safe folder
3. Monitor for issues
4. Update documentation

## üîí Security Considerations

1. **OIDC over Static Credentials**
   - Use AWS OIDC for authentication
   - No long-lived credentials stored
   - Automatic token rotation

2. **Least Privilege**
   - IAM role has minimum required permissions
   - Scoped to specific S3 buckets
   - CloudFront permissions limited

3. **Environment Protection**
   - Use GitHub environments for approval gates
   - Require reviews for prod deployments
   - Separate dev and prod roles

4. **Audit Trail**
   - All deployments logged in GitHub Actions
   - AWS CloudTrail captures API calls
   - S3 versioning enabled

## üìà Monitoring & Observability

### Metrics to Track

1. **Deployment Success Rate**
   - Track successful vs. failed deployments
   - Monitor by environment

2. **Deployment Duration**
   - S3 sync time
   - CloudFront invalidation time
   - Total deployment time

3. **Invalidation Status**
   - Track invalidation completion
   - Monitor propagation time

### Alerts to Configure

1. **Deployment Failures**
   - Alert on workflow failures
   - Slack/email notification

2. **Long-Running Invalidations**
   - Alert if invalidation takes > 15 minutes
   - May indicate CloudFront issues

## üêõ Troubleshooting Guide

### Issue 1: "AWS credentials not configured"

**Cause**: OIDC authentication failed

**Solution**:
1. Verify `AWS_ROLE_ARN` secret is set correctly
2. Check IAM role trust policy includes GitHub OIDC
3. Verify `permissions.id-token: write` is set

### Issue 2: "Local folder not found"

**Cause**: Folder path resolution failed

**Solution**:
1. Verify folder exists in repository
2. Check folder name spelling
3. Ensure checkout action completed successfully

### Issue 3: "CloudFront distribution not found"

**Cause**: No distribution for the folder

**Solution**:
1. Check if distribution exists for folder
2. Verify OriginPath matches folder name
3. Consider creating distribution first

### Issue 4: "Invalidation timeout"

**Cause**: CloudFront invalidation taking too long

**Solution**:
1. Check AWS CloudFront console for status
2. Invalidations can take up to 15 minutes
3. Consider increasing timeout threshold

## üìö Next Steps

After successful implementation:

1. **Automate Further**
   - Trigger on push to specific paths
   - Auto-deploy dev on main branch updates

2. **Enhanced Validation**
   - Add HTML validation
   - Add accessibility checks (Lighthouse)
   - Add broken link detection

3. **Notifications**
   - Slack integration for deployments
   - Email summaries
   - Deployment status badges

4. **Multi-Site Support**
   - Deploy multiple folders in one workflow
   - Batch invalidations
   - Parallel deployments

## üéì Learning Resources

- [GitHub Actions - OIDC with AWS](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)
- [AWS CLI - S3 Sync](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html)
- [CloudFront Invalidations](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Invalidation.html)
- [GitHub Actions - Workflow Syntax](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions)

## ‚úÖ Approval Checklist

Before proceeding with implementation:

- [ ] Plan reviewed and approved by team
- [ ] AWS OIDC trust policy configured
- [ ] IAM role created with proper permissions
- [ ] GitHub secrets configured
- [ ] Test folder identified for validation
- [ ] Rollback plan documented
- [ ] Team trained on new workflow

---

**Status**: Ready for Implementation
**Last Updated**: 2025-12-05
**Author**: Claude Code
**Reviewers**: [Add names]
