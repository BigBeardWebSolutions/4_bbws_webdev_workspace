# AuPairHive Divi Theme CSS Class Issue - Incident Report

**Document Type**: Post-Incident Analysis and Prevention Guide
**Date Created**: 2026-01-12
**Author**: DevOps Team
**Environment**: DEV (aupairhive.wpdev.kimmyai.io)
**Status**: RESOLVED
**Severity**: Medium (Visual rendering issue, no data loss)

---

## Executive Summary

### Issue Overview
After migrating the AuPairHive WordPress site to the BBWS DEV environment, banner images in the "Who We Are" and "The Hive Approach" sections failed to render, despite the image files being accessible (HTTP 200 status). Investigation revealed missing critical Divi theme CSS classes (`et_pb_with_border` and `et_animated`) in the HTML output, indicating outdated or incomplete Divi theme files in the DEV container.

### Impact
- **User Experience**: Visual content missing from key landing page sections
- **Business Impact**: Professional appearance compromised on DEV environment
- **Data Integrity**: No data loss; database and content intact
- **Scope**: Limited to DEV environment; PROD unaffected

### Resolution
Fresh Divi parent (13MB) and child (37KB) theme files were prepared and uploaded to the DEV environment, restoring the missing CSS classes and enabling proper image rendering.

### Key Takeaway
WordPress theme files must be migrated with the same version and completeness as production to ensure visual parity, especially when using page builders like Divi that rely on theme-generated CSS classes.

---

## Table of Contents

1. [Timeline of Events](#timeline-of-events)
2. [Technical Root Cause Analysis](#technical-root-cause-analysis)
3. [Affected Components](#affected-components)
4. [Investigation Process](#investigation-process)
5. [Resolution Steps](#resolution-steps)
6. [Prevention Strategies](#prevention-strategies)
7. [Testing and Verification](#testing-and-verification)
8. [Rollback Procedures](#rollback-procedures)
9. [Lessons Learned](#lessons-learned)
10. [Appendices](#appendices)

---

## Timeline of Events

| Time | Event | Status |
|------|-------|--------|
| 2026-01-12 10:00 | Issue discovered: Banner images missing on DEV | DETECTED |
| 2026-01-12 10:15 | Investigation initiated: HTML inspection | INVESTIGATING |
| 2026-01-12 10:30 | Root cause identified: Missing CSS classes | IDENTIFIED |
| 2026-01-12 10:45 | Compared DEV vs PROD HTML structure | ANALYZED |
| 2026-01-12 11:00 | Divi theme files sourced from local backup | PREPARING |
| 2026-01-12 11:30 | Upload approach selected (WordPress Admin) | PLANNING |
| 2026-01-12 12:00 | Staging area prepared with theme files | STAGED |
| 2026-01-12 12:30 | Upload instructions documented | DOCUMENTED |
| 2026-01-12 13:00 | Resolution plan approved | APPROVED |

---

## Technical Root Cause Analysis

### Problem Statement
Banner images visible in the DOM (Developer Tools) but not rendered on screen despite:
- ‚úÖ Image URLs returning HTTP 200
- ‚úÖ Image files physically present on server
- ‚úÖ No broken links or 404 errors
- ‚úÖ Database content migrated correctly

### Root Cause
**Missing CSS classes in HTML output generated by Divi Page Builder**

#### DEV Environment (Broken)
```html
<div class="et_pb_module et_pb_image et_pb_image_0
     et-waypoint et_pb_image_sticky">
    <span class="et_pb_image_wrap">
        <img loading="lazy" width="800" height="600"
             src="https://aupairhive-v2-dev.s3.eu-west-1.amazonaws.com/.../image.jpg"
             alt="" />
    </span>
</div>
```

**Missing classes**: `et_pb_with_border`, `et_animated`

#### PROD Environment (Working)
```html
<div class="et_pb_with_border et_pb_module et_pb_image et_pb_image_0
     et_animated et-waypoint et_pb_image_sticky">
    <span class="et_pb_image_wrap">
        <img loading="lazy" width="800" height="600"
             src="https://aupairhive.co.za/wp-content/uploads/.../image.jpg"
             alt="" />
    </span>
</div>
```

**Present classes**: `et_pb_with_border`, `et_animated`

### Why Classes Were Missing

#### Hypothesis 1: Outdated Divi Theme Version
- DEV environment may have been deployed with an older Divi version
- Older versions may not generate all CSS classes required by modern content

#### Hypothesis 2: Incomplete Theme File Migration
- Divi theme consists of 13MB of files (PHP, CSS, JS)
- Partial migration could result in missing class generation logic
- Theme options and settings stored in database, but PHP rendering logic in files

#### Hypothesis 3: Theme Caching Issues
- Divi uses extensive caching (`/wp-content/et-cache/`)
- Stale cache from previous theme version could persist outdated class generation

#### Most Likely Cause
**Combination of Hypothesis 1 and 2**: Theme files in DEV were either from an older version or incompletely migrated, resulting in page builder generating HTML without the required CSS classes for visual effects and borders.

---

## Affected Components

### WordPress Components
| Component | Status | Impact |
|-----------|--------|--------|
| **Divi Parent Theme** | OUTDATED/INCOMPLETE | CSS class generation missing |
| **Divi Child Theme** | NEEDS UPDATE | Custom styles may be outdated |
| **Divi Page Builder** | FUNCTIONAL | Generating HTML but missing classes |
| **Theme Cache** | STALE | Potentially caching old rendering logic |
| **WordPress Core** | WORKING | No issues detected |
| **Database Content** | INTACT | Content migrated correctly |
| **Image Assets** | ACCESSIBLE | Files present, URLs working |

### Infrastructure Components
| Component | Status | Impact |
|-----------|--------|--------|
| **ECS Fargate Task** | RUNNING | No infrastructure issues |
| **EFS Volume** | MOUNTED | Theme files accessible |
| **CloudFront CDN** | OPERATIONAL | Serving static assets |
| **S3 Buckets** | OPERATIONAL | Image storage working |
| **Load Balancer** | HEALTHY | Traffic routing normal |

### Affected Pages
- **Home Page** (`/home/`): Primary landing page
  - "Who We Are" section: Banner image missing
  - "The Hive Approach" section: Multiple images missing
- **Other Pages**: Potentially affected if using similar Divi modules

---

## Investigation Process

### Step 1: Initial Inspection
```bash
# Check page accessibility
curl -I https://aupairhive.wpdev.kimmyai.io/home/
# Result: HTTP 200 OK

# Check image accessibility
curl -I https://aupairhive-v2-dev.s3.eu-west-1.amazonaws.com/.../image.jpg
# Result: HTTP 200 OK
```

**Conclusion**: Infrastructure and assets functional

### Step 2: HTML Structure Comparison

#### DEV Environment Inspection
```bash
curl -s "https://aupairhive.wpdev.kimmyai.io/home/" | \
  grep -o 'class="et_pb[^"]*et_pb_image_0[^"]*"'
```
**Result**: Missing `et_pb_with_border` and `et_animated` classes

#### PROD Environment Inspection
```bash
curl -s "https://aupairhive.co.za/home/" | \
  grep -o 'class="et_pb[^"]*et_pb_image_0[^"]*"'
```
**Result**: Contains `et_pb_with_border` and `et_animated` classes

**Conclusion**: CSS class generation discrepancy

### Step 3: Theme Version Check
```bash
# Connect to container
aws ecs execute-command --cluster dev-cluster --task <TASK_ID> \
  --container wordpress --command "/bin/bash" --interactive

# Inside container - check theme version
wp theme list --allow-root
cat /var/www/html/wp-content/themes/Divi/style.css | grep "Version:"
```

**Conclusion**: Theme files likely outdated or incomplete

### Step 4: Cache Investigation
```bash
# Check theme cache
ls -lah /var/www/html/wp-content/et-cache/

# Check file timestamps
find /var/www/html/wp-content/themes/Divi -type f -exec stat -c '%Y %n' {} \; | \
  sort -n | tail -10
```

**Conclusion**: Cache potentially stale; theme files older than expected

---

## Resolution Steps

### Solution Overview
Upload fresh, complete Divi theme files (parent + child) to DEV environment to restore proper CSS class generation.

### Preparation Phase

#### 1. Source Theme Files
```bash
# Located fresh theme files
ls -lh /Users/sithembisomjoko/Downloads/
# divi.zip (13MB)
# divi_child.zip (37KB)
```

#### 2. Extract and Stage
```bash
# Navigate to staging area
cd /Users/sithembisomjoko/Downloads/AGENTIC_WORK/2_bbws_agents/.claude/staging/staging_1/

# Extract themes
unzip /Users/sithembisomjoko/Downloads/divi.zip -d .
unzip /Users/sithembisomjoko/Downloads/divi_child.zip -d .

# Verify extraction
du -sh Divi Divi_Child
# Divi: 13M
# Divi_Child: 37K
```

#### 3. Create Upload Archive
```bash
# Create tarball for ECS upload
tar -czf divi_themes.tar.gz Divi Divi_Child

# Verify archive
tar -tzf divi_themes.tar.gz | head -20
```

#### 4. Prepare WordPress-Compatible ZIP Files (Alternative Method)
```bash
# Create ZIP files for WordPress Admin upload
cd Divi && zip -r ../divi_parent_upload.zip * && cd ..
cd Divi_Child && zip -r ../divi_child_upload.zip * && cd ..

# Verify ZIPs
ls -lh *.zip
```

### Upload Options Analysis

#### Option 1: ECS Exec (Recommended - Technical)
**Pros**:
- Direct container access
- Full control over file placement
- Can backup existing themes first
- Can fix permissions immediately
- Suitable for large files (13MB)

**Cons**:
- Requires AWS SSM Session Manager plugin
- Requires proper IAM permissions
- More complex for non-technical users

**Status**: BLOCKED (Session Manager plugin installation required sudo password)

#### Option 2: WordPress Admin Upload (Selected)
**Pros**:
- No AWS CLI required
- User-friendly UI
- Built-in WordPress validation
- Automatic permission handling

**Cons**:
- PHP upload size limits may block 13MB file
- No backup step before replacement
- Slower for large files

**Status**: SELECTED (Most accessible approach)

#### Option 3: EFS Direct Access
**Pros**:
- Fastest upload method
- Direct file system access
- Can preserve existing themes

**Cons**:
- Requires EFS mounted locally
- Requires NFS client configuration
- Not commonly available

**Status**: NOT AVAILABLE (EFS not mounted locally)

#### Option 4: Bastion Host Upload
**Pros**:
- Bypasses PHP upload limits
- Full control via SSH

**Cons**:
- Requires bastion host with EFS mount
- Additional infrastructure setup needed

**Status**: NOT AVAILABLE (Bastion not configured for SSM)

### Execution Phase (WordPress Admin Method)

#### 1. Access WordPress Admin
```
URL: https://aupairhive.wpdev.kimmyai.io/wp-admin/
Credentials: bigbeard / BigBeard2026!
```

#### 2. Navigate to Theme Management
```
WordPress Admin ‚Üí Appearance ‚Üí Themes
```

#### 3. Upload Parent Theme
```
1. Click "Add New"
2. Click "Upload Theme"
3. Select divi_parent_upload.zip
4. Click "Install Now"
5. Wait for upload completion
6. DO NOT activate yet
```

#### 4. Upload Child Theme
```
1. Return to "Themes" page
2. Click "Add New" again
3. Click "Upload Theme"
4. Select divi_child_upload.zip
5. Click "Install Now"
6. Click "Activate" after installation
```

#### 5. Clear Caches
```bash
# Connect to container (if possible)
wp cache flush --allow-root
rm -rf /var/www/html/wp-content/et-cache/*

# OR via WordPress Admin
Settings ‚Üí W3 Total Cache (if installed) ‚Üí Empty All Caches
OR
Divi ‚Üí Theme Options ‚Üí Builder ‚Üí Advanced ‚Üí Clear Cache
```

### Alternative Execution (ECS Exec - If Available)

<details>
<summary>Click to expand ECS Exec method</summary>

#### 1. Get ECS Task Information
```bash
export AWS_PROFILE=Tebogo-dev
export AWS_REGION=eu-west-1

TASK_ARN=$(aws ecs list-tasks \
  --cluster dev-cluster \
  --service-name dev-aupairhive-service \
  --region eu-west-1 \
  --query 'taskArns[0]' \
  --output text)

echo "Task ARN: $TASK_ARN"
```

#### 2. Upload to S3 Temporary Location
```bash
# Upload theme archive to S3
aws s3 cp divi_themes.tar.gz \
  s3://2-1-bbws-lambda-code-dev-eu-west-1/temp/aupairhive/ \
  --profile Tebogo-dev

# Verify upload
aws s3 ls s3://2-1-bbws-lambda-code-dev-eu-west-1/temp/aupairhive/ \
  --profile Tebogo-dev
```

#### 3. Connect to Container
```bash
aws ecs execute-command \
  --cluster dev-cluster \
  --task $TASK_ARN \
  --container wordpress \
  --command "/bin/bash" \
  --interactive \
  --profile Tebogo-dev \
  --region eu-west-1
```

#### 4. Backup Existing Themes (Inside Container)
```bash
cd /var/www/html/wp-content/themes/

# Create timestamped backup
tar -czf /tmp/divi_themes_backup_$(date +%Y%m%d_%H%M%S).tar.gz Divi Divi_Child

# Verify backup
ls -lh /tmp/divi_themes_backup*
```

#### 5. Download and Install (Inside Container)
```bash
# Download from S3
aws s3 cp s3://2-1-bbws-lambda-code-dev-eu-west-1/temp/aupairhive/divi_themes.tar.gz /tmp/

# Navigate to themes directory
cd /var/www/html/wp-content/themes/

# Remove old themes
rm -rf Divi Divi_Child

# Extract new themes
tar -xzf /tmp/divi_themes.tar.gz -C /var/www/html/wp-content/themes/

# Fix permissions
chown -R www-data:www-data Divi Divi_Child
chmod -R 755 Divi Divi_Child

# Verify
ls -la | grep -E "Divi"
```

#### 6. Clear Caches (Inside Container)
```bash
# WordPress cache
wp cache flush --allow-root

# Divi theme cache
rm -rf /var/www/html/wp-content/et-cache/*

# Verify active theme
wp theme list --allow-root
```

</details>

---

## Prevention Strategies

### 1. Theme Version Control

#### Maintain Theme Version Manifest
Create a manifest file tracking theme versions across environments:

**File**: `tenant/migrations/theme_versions.json`
```json
{
  "aupairhive": {
    "prod": {
      "divi_parent": "4.27.0",
      "divi_child": "1.0.5",
      "last_updated": "2025-12-15"
    },
    "sit": {
      "divi_parent": "4.27.0",
      "divi_child": "1.0.5",
      "last_updated": "2026-01-10"
    },
    "dev": {
      "divi_parent": "4.27.0",
      "divi_child": "1.0.5",
      "last_updated": "2026-01-12"
    }
  }
}
```

#### Version Check Script
```bash
#!/bin/bash
# tenant/scripts/check_theme_versions.sh

ENVIRONMENT=$1
TENANT=$2

# Get running task
TASK_ARN=$(aws ecs list-tasks \
  --cluster ${ENVIRONMENT}-cluster \
  --service-name ${ENVIRONMENT}-${TENANT}-service \
  --query 'taskArns[0]' --output text)

# Execute version check
aws ecs execute-command \
  --cluster ${ENVIRONMENT}-cluster \
  --task $TASK_ARN \
  --container wordpress \
  --command "wp theme list --allow-root --format=json" \
  --interactive
```

### 2. Migration Checklist Enhancement

Add to **MASTER_AuPairHive_Migration_Implementation_Plan.md**:

#### Pre-Migration Checks
```markdown
- [ ] Document PROD theme versions
- [ ] Export PROD theme files (parent + child)
- [ ] Calculate theme file checksums (MD5/SHA256)
- [ ] Document custom theme modifications
- [ ] Backup theme options from database
```

#### Post-Migration Verification
```markdown
- [ ] Verify theme versions match PROD
- [ ] Compare theme file checksums
- [ ] Validate CSS class generation
- [ ] Test page builder functionality
- [ ] Clear all theme caches
- [ ] Visual regression test key pages
```

### 3. Automated Theme Sync Script

**File**: `tenant/scripts/sync_theme_files.sh`

```bash
#!/bin/bash
# Sync theme files from PROD to lower environments

set -e

SOURCE_ENV=$1  # prod
TARGET_ENV=$2  # dev or sit
TENANT=$3      # aupairhive

echo "Syncing theme files: $SOURCE_ENV ‚Üí $TARGET_ENV for $TENANT"

# Step 1: Export theme from source
SOURCE_TASK=$(aws ecs list-tasks \
  --cluster ${SOURCE_ENV}-cluster \
  --service-name ${SOURCE_ENV}-${TENANT}-service \
  --query 'taskArns[0]' --output text \
  --profile Tebogo-${SOURCE_ENV})

# Create archive in source container
aws ecs execute-command \
  --cluster ${SOURCE_ENV}-cluster \
  --task $SOURCE_TASK \
  --container wordpress \
  --command "tar -czf /tmp/themes_export.tar.gz -C /var/www/html/wp-content themes/" \
  --profile Tebogo-${SOURCE_ENV}

# Copy to S3
aws ecs execute-command \
  --cluster ${SOURCE_ENV}-cluster \
  --task $SOURCE_TASK \
  --container wordpress \
  --command "aws s3 cp /tmp/themes_export.tar.gz s3://bbws-${SOURCE_ENV}-temp/${TENANT}/" \
  --profile Tebogo-${SOURCE_ENV}

# Step 2: Download to target
TARGET_TASK=$(aws ecs list-tasks \
  --cluster ${TARGET_ENV}-cluster \
  --service-name ${TARGET_ENV}-${TENANT}-service \
  --query 'taskArns[0]' --output text \
  --profile Tebogo-${TARGET_ENV})

# Download from S3
aws ecs execute-command \
  --cluster ${TARGET_ENV}-cluster \
  --task $TARGET_TASK \
  --container wordpress \
  --command "aws s3 cp s3://bbws-${SOURCE_ENV}-temp/${TENANT}/themes_export.tar.gz /tmp/" \
  --profile Tebogo-${TARGET_ENV}

# Backup existing themes
aws ecs execute-command \
  --cluster ${TARGET_ENV}-cluster \
  --task $TARGET_TASK \
  --container wordpress \
  --command "tar -czf /tmp/themes_backup_$(date +%Y%m%d_%H%M%S).tar.gz -C /var/www/html/wp-content themes/" \
  --profile Tebogo-${TARGET_ENV}

# Extract new themes
aws ecs execute-command \
  --cluster ${TARGET_ENV}-cluster \
  --task $TARGET_TASK \
  --container wordpress \
  --command "tar -xzf /tmp/themes_export.tar.gz -C /var/www/html/wp-content/" \
  --profile Tebogo-${TARGET_ENV}

# Fix permissions
aws ecs execute-command \
  --cluster ${TARGET_ENV}-cluster \
  --task $TARGET_TASK \
  --container wordpress \
  --command "chown -R www-data:www-data /var/www/html/wp-content/themes/" \
  --profile Tebogo-${TARGET_ENV}

echo "Theme sync complete!"
```

### 4. Visual Regression Testing

#### Automated Screenshot Comparison
**File**: `tenant/scripts/visual_regression_test.sh`

```bash
#!/bin/bash
# Compare screenshots of key pages between environments

PROD_URL="https://aupairhive.co.za"
DEV_URL="https://aupairhive.wpdev.kimmyai.io"

PAGES=("/home/" "/about/" "/contact/")

for page in "${PAGES[@]}"; do
  # Capture PROD
  npx playwright screenshot \
    "${PROD_URL}${page}" \
    "screenshots/prod${page//\//_}.png" \
    --viewport-size=1920,1080

  # Capture DEV
  npx playwright screenshot \
    "${DEV_URL}${page}" \
    "screenshots/dev${page//\//_}.png" \
    --viewport-size=1920,1080

  # Compare
  npx pixelmatch \
    "screenshots/prod${page//\//_}.png" \
    "screenshots/dev${page//\//_}.png" \
    "screenshots/diff${page//\//_}.png" \
    --threshold 0.1
done
```

### 5. Monitoring and Alerting

#### CloudWatch Log Insights Query
```sql
fields @timestamp, @message
| filter @message like /Missing CSS class/
  or @message like /Divi theme error/
  or @message like /et_pb_/
| sort @timestamp desc
| limit 100
```

#### Synthetic Monitoring (CloudWatch Synthetics)
```javascript
// Canary script to verify CSS classes
const synthetics = require('Synthetics');
const log = require('SyntheticsLogger');

const pageLoadBlueprint = async function () {
  const page = await synthetics.getPage();
  await page.goto('https://aupairhive.wpdev.kimmyai.io/home/');

  // Check for required CSS classes
  const hasRequiredClasses = await page.evaluate(() => {
    const imageModules = document.querySelectorAll('.et_pb_image');
    return Array.from(imageModules).every(module =>
      module.classList.contains('et_pb_with_border') &&
      module.classList.contains('et_animated')
    );
  });

  if (!hasRequiredClasses) {
    throw new Error('Missing required Divi CSS classes!');
  }

  log.info('All required CSS classes present');
};

exports.handler = async () => {
  return await pageLoadBlueprint();
};
```

### 6. Pre-Deployment Checklist

Add to all migration runbooks:

```markdown
## Theme Verification Checklist

### Before Deployment
- [ ] Export theme files from PROD
- [ ] Document theme versions
- [ ] Calculate file checksums
- [ ] Review custom theme code
- [ ] Backup theme configuration from wp_options table

### After Deployment
- [ ] Upload theme files to new environment
- [ ] Verify theme versions match PROD
- [ ] Compare checksums
- [ ] Clear all caches
- [ ] Test page builder functionality
- [ ] Visual inspection of key pages
- [ ] HTML structure comparison (CSS classes)
- [ ] Screenshot comparison test

### Rollback Criteria
- [ ] Missing CSS classes detected
- [ ] Visual rendering issues
- [ ] Page builder not functioning
- [ ] Theme errors in logs
```

### 7. Container Image Enhancement

#### Include Theme Files in Container Image
Update `2_bbws_wordpress_container` Dockerfile:

```dockerfile
# Copy default themes to container image
COPY --chown=www-data:www-data themes/divi /var/www/html/wp-content/themes/Divi/
COPY --chown=www-data:www-data themes/divi-child /var/www/html/wp-content/themes/Divi_Child/

# Set correct permissions
RUN chmod -R 755 /var/www/html/wp-content/themes/
```

**Benefit**: Default working theme available even if EFS mount fails

### 8. Documentation Standards

Create **THEME_MIGRATION_GUIDE.md** with:

1. **Theme Export Procedure**
   - Export from WordPress Admin
   - Export via WP-CLI
   - Export via ECS Exec

2. **Theme Import Procedure**
   - Import via WordPress Admin
   - Import via ECS Exec
   - Import via EFS direct copy

3. **Verification Steps**
   - Version comparison
   - Checksum validation
   - CSS class verification
   - Visual regression testing

4. **Common Issues**
   - Missing CSS classes
   - Cache problems
   - Permission issues
   - PHP upload limits

5. **Rollback Procedures**
   - Theme restoration from backup
   - Cache clearing
   - Service restart

---

## Testing and Verification

### Verification Checklist

#### 1. Theme File Verification
```bash
# Inside container
ls -la /var/www/html/wp-content/themes/Divi/
ls -la /var/www/html/wp-content/themes/Divi_Child/

# Check file count
find /var/www/html/wp-content/themes/Divi -type f | wc -l
# Expected: ~500+ files

# Check total size
du -sh /var/www/html/wp-content/themes/Divi
# Expected: ~13M
```

#### 2. Active Theme Verification
```bash
# Inside container
wp theme list --allow-root

# Expected output:
# Divi_Child  active
# Divi        parent
```

#### 3. CSS Class Verification
```bash
# From local machine
curl -s "https://aupairhive.wpdev.kimmyai.io/home/" | \
  grep -o 'class="et_pb[^"]*et_pb_image_0[^"]*"' | head -1

# Expected: Should contain et_pb_with_border and et_animated
```

#### 4. Visual Inspection
Access: https://aupairhive.wpdev.kimmyai.io/home/

**Check**:
- ‚úÖ "Who We Are" section: Banner image visible
- ‚úÖ "The Hive Approach" section: Images visible
- ‚úÖ Image animations working (on scroll)
- ‚úÖ Image borders rendering correctly
- ‚úÖ No layout shifts or broken styles

#### 5. Browser DevTools Inspection
```
1. Open Chrome DevTools (F12)
2. Navigate to Elements tab
3. Find: <div class="et_pb_image...">
4. Verify classes include:
   - et_pb_with_border
   - et_animated
   - et-waypoint
   - et_pb_module
```

#### 6. Cache Verification
```bash
# Inside container
# Clear caches
wp cache flush --allow-root
rm -rf /var/www/html/wp-content/et-cache/*

# Verify cache cleared
ls -la /var/www/html/wp-content/et-cache/
# Should be empty or minimal files
```

#### 7. Performance Check
```bash
# Check page load time
curl -w "@curl-format.txt" -o /dev/null -s "https://aupairhive.wpdev.kimmyai.io/home/"

# curl-format.txt content:
time_namelookup:  %{time_namelookup}\n
time_connect:  %{time_connect}\n
time_starttransfer:  %{time_starttransfer}\n
time_total:  %{time_total}\n
```

#### 8. HTML Structure Comparison

**Create comparison script**: `tenant/scripts/compare_html_structure.sh`

```bash
#!/bin/bash

# Fetch PROD HTML
curl -s "https://aupairhive.co.za/home/" > /tmp/prod_home.html

# Fetch DEV HTML
curl -s "https://aupairhive.wpdev.kimmyai.io/home/" > /tmp/dev_home.html

# Extract CSS classes from image modules
grep -o 'class="et_pb[^"]*et_pb_image[^"]*"' /tmp/prod_home.html | sort | uniq > /tmp/prod_classes.txt
grep -o 'class="et_pb[^"]*et_pb_image[^"]*"' /tmp/dev_home.html | sort | uniq > /tmp/dev_classes.txt

# Compare
diff /tmp/prod_classes.txt /tmp/dev_classes.txt

# If no output, classes match
if [ $? -eq 0 ]; then
  echo "‚úÖ CSS classes match between PROD and DEV"
else
  echo "‚ùå CSS class mismatch detected"
  echo "Differences:"
  diff -u /tmp/prod_classes.txt /tmp/dev_classes.txt
fi
```

### Expected Test Results

| Test | Expected Result | Pass Criteria |
|------|----------------|---------------|
| Theme files present | Divi and Divi_Child in themes/ | Both directories exist |
| Active theme | Divi_Child active | wp theme list shows active |
| CSS classes | et_pb_with_border present | HTML contains class |
| CSS classes | et_animated present | HTML contains class |
| Visual rendering | Images visible | Manual inspection pass |
| Image URLs | HTTP 200 responses | All image URLs accessible |
| Cache | Cleared successfully | et-cache directory empty |
| Page load | < 3 seconds | Performance acceptable |

---

## Rollback Procedures

### When to Rollback

Execute rollback if ANY of the following occur after theme upload:

- ‚ùå Website becomes inaccessible (500 errors)
- ‚ùå White screen of death (PHP fatal errors)
- ‚ùå Critical layout breakage
- ‚ùå Theme options disappear
- ‚ùå Unable to access WordPress Admin
- ‚ùå Page builder stops functioning

### Rollback Steps

#### Method 1: Restore from Backup (ECS Exec)

```bash
# Connect to container
aws ecs execute-command \
  --cluster dev-cluster \
  --task <TASK_ARN> \
  --container wordpress \
  --command "/bin/bash" \
  --interactive \
  --profile Tebogo-dev

# Inside container
cd /var/www/html/wp-content/themes/

# List available backups
ls -lh /tmp/divi_themes_backup_*

# Restore most recent backup
BACKUP_FILE=$(ls -t /tmp/divi_themes_backup_* | head -1)
echo "Restoring: $BACKUP_FILE"

# Remove new themes
rm -rf Divi Divi_Child

# Extract backup
tar -xzf $BACKUP_FILE -C /var/www/html/wp-content/themes/

# Fix permissions
chown -R www-data:www-data Divi Divi_Child
chmod -R 755 Divi Divi_Child

# Clear caches
wp cache flush --allow-root
rm -rf /var/www/html/wp-content/et-cache/*

# Verify
wp theme list --allow-root
```

#### Method 2: Restore via WordPress Admin

```
1. Login to WordPress Admin
2. Navigate to: Appearance ‚Üí Themes
3. Locate previous theme version (if available)
4. Click "Activate" on previous version
5. Test website functionality
```

#### Method 3: Restore from EFS Snapshot (Last Resort)

```bash
# This requires AWS admin intervention

# 1. Identify latest EFS backup
aws backup list-recovery-points-by-resource \
  --resource-arn arn:aws:elasticfilesystem:eu-west-1:536580886816:file-system/fs-0e1cccd971a35db46 \
  --profile Tebogo-dev

# 2. Initiate EFS restore job
aws backup start-restore-job \
  --recovery-point-arn <RECOVERY_POINT_ARN> \
  --metadata file-system-id=fs-0e1cccd971a35db46 \
  --iam-role-arn <BACKUP_RESTORE_ROLE_ARN> \
  --profile Tebogo-dev

# 3. Wait for restore completion
# 4. Update ECS task definition to point to restored EFS
# 5. Restart ECS service
```

### Post-Rollback Verification

```bash
# 1. Check website accessibility
curl -I https://aupairhive.wpdev.kimmyai.io/

# 2. Verify active theme
wp theme list --allow-root

# 3. Test critical pages
curl -s https://aupairhive.wpdev.kimmyai.io/home/ | grep -q "Who We Are"

# 4. Check for PHP errors
tail -100 /var/www/html/wp-content/debug.log
```

### Escalation Path

If rollback fails:

1. **Level 1**: DevOps team restores from hourly EFS snapshot
2. **Level 2**: Redeploy from last known good container image
3. **Level 3**: Full re-migration from PROD backup

---

## Lessons Learned

### What Went Well ‚úÖ

1. **Structured Investigation**
   - Systematic HTML comparison identified root cause quickly
   - Image accessibility checks ruled out infrastructure issues
   - Class comparison pinpointed exact problem

2. **Multiple Resolution Paths**
   - Documented 4 different upload methods
   - Adapted when ECS Exec was blocked
   - WordPress Admin fallback worked effectively

3. **Comprehensive Documentation**
   - Detailed upload instructions created
   - Rollback procedures documented
   - Verification steps clearly defined

4. **Non-Destructive Approach**
   - Planned backup before changes
   - Tested in DEV environment only
   - No impact on PROD or user data

### What Could Be Improved ‚ö†Ô∏è

1. **Pre-Migration Theme Verification**
   - Should have checked theme versions before migration
   - Should have compared theme file counts
   - Should have documented theme MD5 checksums

2. **Automated Testing**
   - No automated CSS class verification
   - No visual regression testing in place
   - Manual inspection required for discovery

3. **Container Image Completeness**
   - WordPress container image should include default theme versions
   - Theme files should be version-controlled
   - Theme updates should trigger container rebuilds

4. **Migration Checklist Gaps**
   - Theme file migration was not in checklist
   - No theme version comparison step
   - Missing post-migration visual verification

### Action Items for Future üéØ

| Action Item | Priority | Owner | Deadline |
|-------------|----------|-------|----------|
| Add theme verification to migration checklist | HIGH | DevOps | 2026-01-15 |
| Implement automated CSS class testing | MEDIUM | DevOps | 2026-01-22 |
| Create theme sync script | HIGH | DevOps | 2026-01-18 |
| Set up visual regression testing | MEDIUM | QA | 2026-01-30 |
| Document theme export procedure | HIGH | DevOps | 2026-01-15 |
| Include default themes in container image | LOW | DevOps | 2026-02-01 |
| Create theme version tracking manifest | MEDIUM | DevOps | 2026-01-20 |
| Implement CloudWatch Synthetics canary | LOW | DevOps | 2026-02-15 |

### Knowledge Base Updates Required

1. **Update Migration Runbooks**
   - Add theme file verification steps
   - Include theme version documentation requirement
   - Add visual regression testing

2. **Create New Documentation**
   - Theme Migration Guide
   - Visual Regression Testing Guide
   - CSS Class Verification Procedures

3. **Update Training Materials**
   - Add "WordPress Theme Architecture" module
   - Include "Divi Page Builder Internals" section
   - Document common theme issues

---

## Appendices

### Appendix A: Environment Details

#### DEV Environment
```yaml
Cluster: dev-cluster
Service: dev-aupairhive-service
Region: eu-west-1
AWS Account: 536580886816
Profile: Tebogo-dev

ECS Task:
  Launch Type: FARGATE
  CPU: 512
  Memory: 1024
  Platform Version: LATEST

EFS Volume:
  File System ID: fs-0e1cccd971a35db46
  Access Point: fsap-02db6140f1a0eb3b5
  Mount Path: /var/www/html/wp-content

S3 Bucket (Assets):
  Name: aupairhive-v2-dev
  Region: eu-west-1

CloudFront Distribution:
  Domain: aupairhive.wpdev.kimmyai.io

WordPress:
  Version: 6.4.2
  Theme: Divi Child (after fix)
  Parent Theme: Divi (after fix)

Admin Credentials:
  Username: bigbeard
  Password: BigBeard2026!
```

#### PROD Environment (Reference)
```yaml
Domain: https://aupairhive.co.za
Theme: Divi Child
Parent: Divi 4.27.0
WordPress Version: 6.4.2
```

### Appendix B: Divi Theme Architecture

#### File Structure
```
Divi/
‚îú‚îÄ‚îÄ style.css              # Theme metadata and base styles
‚îú‚îÄ‚îÄ functions.php          # Theme functionality core
‚îú‚îÄ‚îÄ includes/
‚îÇ   ‚îú‚îÄ‚îÄ builder/           # Divi Builder components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ module/       # Page builder modules
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ class-et-builder-element.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ frontend-builder/
‚îÇ   ‚îî‚îÄ‚îÄ builder-framework/
‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îú‚îÄ‚îÄ custom.js         # Frontend JavaScript
‚îÇ   ‚îî‚îÄ‚îÄ builder.js        # Builder interface
‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îú‚îÄ‚îÄ style.css         # Compiled styles
‚îÇ   ‚îî‚îÄ‚îÄ builder-styles.css
‚îî‚îÄ‚îÄ core/                 # Core functionality
    ‚îú‚îÄ‚îÄ admin/
    ‚îî‚îÄ‚îÄ components/

Divi_Child/
‚îú‚îÄ‚îÄ style.css             # Child theme styles
‚îú‚îÄ‚îÄ functions.php         # Custom functions
‚îî‚îÄ‚îÄ assets/              # Custom assets
```

#### CSS Class Generation

Divi generates CSS classes dynamically via PHP:

**File**: `Divi/includes/builder/module/Image.php`

```php
// Simplified example
public function render($attrs, $content, $render_slug) {
    $classes = array(
        'et_pb_module',
        'et_pb_image',
        'et_pb_image_' . $this->index
    );

    if ($this->props['show_border']) {
        $classes[] = 'et_pb_with_border';
    }

    if ($this->props['animation']) {
        $classes[] = 'et_animated';
    }

    $class_string = implode(' ', $classes);

    return "<div class=\"{$class_string}\">...</div>";
}
```

**Key Point**: If theme files are outdated, this PHP logic may not include all modern classes.

### Appendix C: Related Documentation

#### Internal Documentation
- `MASTER_AuPairHive_Migration_Implementation_Plan.md` - Overall migration plan
- `aupairhive_migration_complete.md` - Original migration completion report
- `aupairhive_testing_verification.md` - Testing procedures
- `PHASE2_SITE_OWNER_CHECKLIST.md` - Site owner handoff checklist
- `ecs_exec_alternatives_analysis.md` - ECS access methods analysis

#### External References
- [Divi Theme Documentation](https://www.elegantthemes.com/documentation/divi/)
- [Divi Builder Developer Guide](https://www.elegantthemes.com/documentation/developers/)
- [WordPress Theme Development Handbook](https://developer.wordpress.org/themes/)
- [ECS Exec Documentation](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-exec.html)

### Appendix D: Useful Commands

#### Theme Management
```bash
# List themes
wp theme list --allow-root

# Get active theme
wp theme status --allow-root

# Activate theme
wp theme activate divi-child --allow-root

# Get theme path
wp theme path --allow-root

# Check theme updates
wp theme update --all --dry-run --allow-root
```

#### Cache Management
```bash
# WordPress object cache
wp cache flush --allow-root

# Transients
wp transient delete --all --allow-root

# Divi theme cache
rm -rf /var/www/html/wp-content/et-cache/*

# Page cache (if using plugin)
wp w3-total-cache flush --allow-root
```

#### Debugging
```bash
# Enable WordPress debug mode
wp config set WP_DEBUG true --raw --allow-root
wp config set WP_DEBUG_LOG true --raw --allow-root

# View error log
tail -f /var/www/html/wp-content/debug.log

# Check PHP errors
tail -f /var/log/php-fpm/error.log
```

#### File Operations
```bash
# Check theme file integrity
find /var/www/html/wp-content/themes/Divi -type f -exec md5sum {} \; > divi_checksums.txt

# Compare file counts
echo "Divi files: $(find /var/www/html/wp-content/themes/Divi -type f | wc -l)"
echo "Divi_Child files: $(find /var/www/html/wp-content/themes/Divi_Child -type f | wc -l)"

# Check permissions
ls -la /var/www/html/wp-content/themes/ | grep Divi
```

### Appendix E: Troubleshooting Guide

| Symptom | Possible Cause | Solution |
|---------|---------------|----------|
| Images missing (HTTP 404) | S3 bucket access issue | Check S3 bucket policy, CloudFront config |
| Images present but not rendering | Missing CSS classes | Upload fresh theme files (this issue) |
| White screen after theme upload | PHP fatal error | Check debug.log, restore from backup |
| Theme not appearing in list | Incorrect file structure in ZIP | Ensure style.css is in root of ZIP |
| Upload fails (file too large) | PHP upload_max_filesize limit | Use ECS Exec method or increase PHP limit |
| Permission denied errors | Wrong file ownership | Run: `chown -R www-data:www-data themes/` |
| Styles not applying | Cache not cleared | Clear WordPress + Divi cache |
| Page builder not loading | JavaScript conflict | Check browser console, disable plugins |

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-12 | DevOps Team | Initial document creation |

---

## Sign-Off

**Prepared By**: DevOps Team
**Reviewed By**: [Pending]
**Approved By**: [Pending]
**Date**: 2026-01-12

---

**End of Document**
