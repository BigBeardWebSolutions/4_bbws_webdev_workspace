# HLD 2.5.1: User Management

## High-Level Design Document

**Version**: 1.0
**Author**: Platform Architecture Team
**Date**: 2026-02-17
**Status**: Draft

---

## Document History

| Version | Date | Changes | Owner |
|---------|------|---------|-------|
| 1.0 | 2026-02-17 | Initial HLD for User Management domain | Platform Architecture |

---

## 1. Executive Summary

### Purpose

This document provides the architectural design for the User Management capability of the BBWS platform. It describes how the platform manages user profiles, user directory/search, role assignments, and user preferences as a dedicated domain, decoupled from tenant-specific and authentication concerns.

### Scope

This HLD defines the architectural boundaries and design for:
- User profile entity management (CRUD, status lifecycle)
- Platform-wide user directory and search
- Role definition and assignment independent of tenant context
- User preference management (notifications, language, timezone)
- Integration patterns with Auth Management and Tenant Management

> **Note:** Authentication and identity (registration, login, sessions) is covered by [HLD 2.1.2: Auth Management](../../2_bbws_auth_management/docs/hld/2.1.2_HLD_Authentication_Management.md). Tenant-scoped user assignments are covered by [HLD 2.5: Tenant Management](../../2_bbws_tenant_management/docs/hld/2.5_HLD_Tenant_Management.md). For detailed API specifications, see `docs/openapi/`. For implementation details, see `docs/lld/`.

### Relationship to Other Documents

| Document | Relationship |
|----------|--------------|
| **BRS 2.5.1** | Business requirements this architecture implements |
| **LLD 2.5.1** | Detailed implementation specifications |
| **HLD 2.1.2** | Auth Management - provides identity (Cognito sub) |
| **HLD 2.5** | Tenant Management - user-to-tenant associations |
| **HLD 2.5.2** | Organization Management - user-to-org-unit assignments |

---

## 2. Architecture Overview

### 2.1 Design Philosophy

| Principle | Implementation |
|-----------|----------------|
| **User as First-Class Entity** | User profile exists independently of tenants or orgs |
| **Identity Separation** | Cognito handles credentials; this service handles profile data |
| **Serverless First** | Lambda + API Gateway + DynamoDB |
| **Event-Driven Updates** | SQS events for cross-service synchronisation |

### 2.2 High-Level Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BBWS Platform                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                       User Management Service                          │ │
│   │                                                                        │ │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │ │
│   │   │   Profile   │  │  Directory  │  │    Role     │  │ Preference  │ │ │
│   │   │   Service   │  │   Service   │  │  Service    │  │  Service    │ │ │
│   │   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘ │ │
│   │          │                │                │                │        │ │
│   └──────────┼────────────────┼────────────────┼────────────────┼────────┘ │
│              │                │                │                │          │
│              └────────────────┼────────────────┼────────────────┘          │
│                               │                │                            │
│                      ┌────────▼────────────────▼────────┐                  │
│                      │          DynamoDB Table          │                  │
│                      │      (Single Table Design)       │                  │
│                      └──────────────────────────────────┘                  │
│                                      │                                      │
│                                      │ Events                               │
│                                      ▼                                      │
│                      ┌────────────────────────────────┐                    │
│                      │         SQS Queues             │                    │
│                      │  USER_CREATED / USER_UPDATED   │                    │
│                      │  USER_ROLE_CHANGED             │                    │
│                      └────────────────────────────────┘                    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. System Context

### 3.1 Context Diagram

```
                              ┌─────────────────┐
                              │    Platform     │
                              │  Admin/User     │
                              └────────┬────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│                        BBWS User Management                               │
│                                                                           │
│   ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐     │
│   │  Profile   │   │ Directory  │   │    Role    │   │ Preference │     │
│   │  Service   │   │  Service   │   │  Service   │   │  Service   │     │
│   └────────────┘   └────────────┘   └────────────┘   └────────────┘     │
│                                                                           │
└───────────────────────────────────┬───────────────────────────────────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
            ▼                       ▼                       ▼
    ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
    │     Auth      │      │    Tenant     │      │ Organization  │
    │  Management   │      │  Management   │      │  Management   │
    │  (HLD 2.1.2)  │      │   (HLD 2.5)   │      │  (HLD 2.5.2)  │
    └───────────────┘      └───────────────┘      └───────────────┘
```

### 3.2 Integration Points

| System | Direction | Purpose |
|--------|-----------|---------|
| **Auth Management (2.1.2)** | Inbound | Receives user creation event on registration (cognitoId, email) |
| **Tenant Management (2.5)** | Both | Provides user context for tenant assignments; receives user profile data |
| **Organization Management (2.5.2)** | Outbound | Provides user context for org-unit assignments |
| **Cognito** | Inbound | Cognito sub used as identity reference (no credential storage) |
| **DynamoDB Streams** | Outbound | Audit events and cross-service notifications |

---

## 4. Component Architecture

### 4.1 Profile Service

**Responsibility**: Manage core user profile entity.

| Operation | Description | Triggers |
|-----------|-------------|----------|
| Create | New user profile (triggered by Auth registration) | SQS: USER_REGISTERED |
| Read | Get user by ID | None |
| Update | Modify user profile fields | SQS: USER_UPDATED |
| Deactivate | Soft deactivation of user | SQS: USER_DEACTIVATED |
| List | Query users with filters | None |

### 4.2 Directory Service

**Responsibility**: Platform-wide user lookup and search.

| Capability | Description |
|------------|-------------|
| Search by name | Full-text search across first/last name |
| Search by email | Exact match and prefix search |
| Filter by status | Active, suspended, deactivated |
| Filter by role | Admin, Operator, Viewer |
| Pagination | Cursor-based pagination for large result sets |

### 4.3 Role Service

**Responsibility**: Manage platform-wide role definitions and user role assignments.

| Role | Capabilities |
|------|--------------|
| **Platform Admin** | Full platform access, user management, tenant creation |
| **Admin** | Full tenant management, user management within tenant |
| **Operator** | Tenant operations, site management |
| **Viewer** | Read-only access |

### 4.4 Preference Service

**Responsibility**: Manage user-specific settings.

| Preference | Description | Default |
|------------|-------------|---------|
| Notification channels | Email, in-app, SMS | Email + in-app |
| Language | UI language | en-ZA |
| Timezone | Display timezone | Africa/Johannesburg |
| Theme | Light/dark mode | System |

---

## 5. User Status State Machine

```
                        ┌─────────────┐
                        │   (new)     │
                        └──────┬──────┘
                               │ Registration complete
                               ▼
                        ┌─────────────┐
                        │   ACTIVE    │
                        └──────┬──────┘
                               │
               ┌───────────────┼───────────────┐
               │               │               │
               │ Suspend       │ Deactivate    │
               ▼               │               ▼
        ┌─────────────┐        │        ┌──────────────┐
        │  SUSPENDED  │        │        │ DEACTIVATED  │
        └──────┬──────┘        │        └──────────────┘
               │               │           (terminal)
               │ Reactivate    │
               └───────────────┘
                       │
                       ▼
                ┌─────────────┐
                │   ACTIVE    │
                └─────────────┘
```

---

## 6. Security Architecture

### 6.1 Authentication & Authorization

| Component | Mechanism |
|-----------|-----------|
| API Authentication | Cognito JWT tokens |
| Authorization | Role-based (Platform Admin, Admin, Operator, Viewer) |
| User Scoping | JWT claims include userId and role |
| Self-Service | Users can update their own profile and preferences |
| Service-to-Service | IAM roles for Lambda-to-SQS |

### 6.2 Data Protection

| Data Type | Protection |
|-----------|------------|
| At Rest | DynamoDB encryption (KMS) |
| In Transit | TLS 1.2+ |
| PII | Email, name encrypted at rest; access logged |
| Credentials | None stored (Cognito handles auth) |

### 6.3 Access Control

| Operation | Required Role |
|-----------|---------------|
| View own profile | Any authenticated user |
| Update own profile | Any authenticated user |
| View other profiles | Admin, Operator (within tenant) |
| Create/deactivate users | Platform Admin, Admin |
| Assign roles | Platform Admin, Admin |

---

## 7. Technology Decisions

### 7.1 Technology Stack

| Component | Technology | Rationale |
|-----------|------------|-----------|
| API Layer | API Gateway + Lambda | Serverless, auto-scaling |
| Data Store | DynamoDB | Serverless, fast, single-table design |
| Search | DynamoDB GSIs + optional OpenSearch | Structured queries; full-text at scale |
| Async Messaging | SQS | Reliable, serverless queuing |
| Identity Reference | Cognito sub | Managed identity, JWT |

### 7.2 Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Data Model | Single Table Design | Efficient access patterns, consistent with platform |
| User Creation Trigger | SQS event from Auth | Decoupled from registration flow |
| Search Strategy | GSIs first, OpenSearch later | Start simple, scale when needed |
| Profile Scope | Platform-wide | User exists independently of tenants |

---

## 8. Non-Functional Requirements

### 8.1 Performance

| Metric | Target | Rationale |
|--------|--------|-----------|
| Profile Read | < 100ms P95 | Frequent lookups by other services |
| Profile Update | < 200ms P95 | User experience |
| Directory Search | < 500ms P95 | Acceptable for search operations |

### 8.2 Availability

| Metric | Target |
|--------|--------|
| API Availability | 99.9% |
| Data Durability | 99.999999999% (DynamoDB) |

### 8.3 Scalability

| Dimension | Target | Approach |
|-----------|--------|----------|
| Total Users | 100,000+ | DynamoDB auto-scaling |
| Concurrent API Calls | 100/second | Lambda concurrency |
| Search Results | < 1 second for 10,000+ users | GSI design, pagination |

---

## 9. Constraints

| Constraint | Impact | Mitigation |
|------------|--------|------------|
| DynamoDB Item Size | 400KB limit | Store large preferences in S3 |
| GSI Throughput | May throttle on hot partitions | Distribute partition keys evenly |
| Lambda Cold Start | First request latency | Provisioned concurrency for critical paths |

---

## 10. Platform Services

| Service | HLD | Repo | Description |
|---------|-----|------|-------------|
| Tenant Management | 2.5 | `2_bbws_tenant_management` | Tenant lifecycle and metadata |
| User Management | 2.5.1 | `2_bbws_user_management` | User profiles, directory, roles |
| Organization Management | 2.5.2 | `2_bbws_organization_management` | Org hierarchy (Division > Group > Team) |
| Site Management | 2.6 | `2_bbws_site_management` | WordPress site lifecycle |
| Instance Management | 2.7 | `2_bbws_instance_management` | Environment provisioning |
| Auth Management | 2.1.2 | `2_bbws_auth_management` | Registration, login, sessions |

---

## 11. Related Repositories

| Repository | Purpose |
|------------|---------|
| `2_bbws_tenant_management` | Tenant lifecycle service |
| `2_bbws_user_management` | User profile and role service |
| `2_bbws_organization_management` | Organization hierarchy service |
| `2_bbws_site_management` | WordPress site management service |
| `2_bbws_instance_management` | Environment provisioning service |
| `2_bbws_auth_management` | Authentication service |
| `2_bbws_ecs_terraform` | Shared ECS infrastructure as code |
| `2_bbws_ecs_operations` | Dashboards, alerts, runbooks |
| `2_bbws_wordpress_container` | WordPress Docker image |
| `2_bbws_agents` | AI agents and utilities |
| `2_bbws_docs` | Central documentation |

---

## 12. References

| Document | Path |
|----------|------|
| BRS 2.5.1: User Management | `docs/brs/2.5.1_BRS_User_Management.md` |
| LLD 2.5.1: User Management | `docs/lld/2.5.1_LLD_User_Management.md` |
| HLD 2.1.2: Authentication Management | `HLDs/2.1.2_HLD_Authentication_Management.md` |
| HLD 2.5: Tenant Management | `HLDs/2.5_HLD_Tenant_Management.md` |
| HLD 2.5.2: Organization Management | `HLDs/2.5.2_HLD_Organization_Management.md` |
| User API OpenAPI Spec | `docs/openapi/user_api_openapi.yaml` |

---

**End of Document**
