# HLD 2.1.8: Order Management

**Version**: 1.0
**Document ID**: HLD-2.1.8
**Created**: 2026-01-06
**Last Updated**: 2026-01-06
**Status**: Draft
**Author**: Platform Architecture Team
**Parent BRS**: [BRS 2.1.8 Order Management](../BRS/2.1.8_BRS_Order_Management.md)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-06 | Platform Architecture | Initial version |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [Architecture Overview](#2-architecture-overview)
3. [Component Architecture](#3-component-architecture)
4. [Integration Architecture](#4-integration-architecture)
5. [Data Architecture](#5-data-architecture)
6. [Security Architecture](#6-security-architecture)
7. [Non-Functional Requirements](#7-non-functional-requirements)
8. [Deployment Architecture](#8-deployment-architecture)
9. [References](#9-references)

---

## 1. Introduction

### 1.1 Purpose

This High-Level Design document describes the architecture for the Order Management capability within the BBWS Customer Portal. It defines how orders are created, processed, documented, and tracked throughout their lifecycle.

### 1.2 Scope

This document covers:
- Order creation from shopping cart
- Event-driven order processing architecture
- Invoice generation and storage
- Email notification system
- Order lifecycle management

### 1.3 Design Principles

| Principle | Application |
|-----------|-------------|
| **Event-Driven** | Order creation triggers async processing via SQS |
| **Eventual Consistency** | API returns immediately; processing continues async |
| **Fault Tolerance** | Dead-letter queues for failed message processing |
| **Scalability** | Independent scaling of each processing function |
| **Tenant Isolation** | Orders partitioned by tenant in DynamoDB |

---

## 2. Architecture Overview

### 2.1 Solution Context

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Customer Portal                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────────────┐  │
│  │   Cart   │───>│  ORDER   │───>│ Payment  │───>│ Tenant Provision │  │
│  │   Mgmt   │    │   MGMT   │    │   Mgmt   │    │                  │  │
│  │ (2.1.7)  │    │ (2.1.8)  │    │ (2.1.9)  │    │     (2.5)        │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────────────┘  │
│                       │                                                  │
│                       ▼                                                  │
│              ┌────────────────┐                                         │
│              │  Order Events  │                                         │
│              │     (SQS)      │                                         │
│              └────────────────┘                                         │
│                       │                                                  │
│         ┌─────────────┼─────────────┬─────────────┐                     │
│         ▼             ▼             ▼             ▼                     │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐               │
│  │  Record   │ │   PDF     │ │ Internal  │ │ Customer  │               │
│  │  Creator  │ │ Generator │ │   Notify  │ │  Notify   │               │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘               │
│        │             │             │             │                      │
│        ▼             ▼             ▼             ▼                      │
│   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐                │
│   │DynamoDB │   │   S3    │   │   SES   │   │   SES   │                │
│   └─────────┘   └─────────┘   └─────────┘   └─────────┘                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Key Architecture Decisions

| Decision | Rationale |
|----------|-----------|
| **Event-Driven Processing** | API responds immediately (202 Accepted); heavy processing done async |
| **Fan-Out Pattern** | Single SQS message triggers multiple parallel Lambda functions |
| **Single-Table DynamoDB** | Orders stored with tenant as partition key for isolation |
| **S3 for Documents** | PDF invoices stored in S3 with 7-year retention |
| **SES for Email** | Managed email service with bounce/complaint handling |

---

## 3. Component Architecture

### 3.1 Component Overview

| Component | Type | Purpose |
|-----------|------|---------|
| **Order API** | Lambda (API Gateway) | Handles REST endpoints for orders |
| **Order Creation Queue** | SQS | Buffers order events for processing |
| **Order Record Creator** | Lambda (SQS) | Persists order to DynamoDB |
| **Order PDF Creator** | Lambda (SQS) | Generates PDF invoice |
| **Internal Notifier** | Lambda (SQS) | Sends alerts to staff |
| **Customer Notifier** | Lambda (SQS) | Sends confirmation to customer |
| **Orders Table** | DynamoDB | Stores order data |
| **Orders Bucket** | S3 | Stores PDF invoices |

### 3.2 API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/tenants/{tenantId}/orders` | Create order for tenant |
| POST | `/v1.0/orders` | Create order (guest checkout) |
| GET | `/v1.0/orders/{orderId}` | Get order details |
| GET | `/v1.0/tenants/{tenantId}/orders` | List tenant orders |
| PUT | `/v1.0/orders/{orderId}` | Update order (cancel) |
| POST | `/v1.0/orders/{orderId}/paymentconfirmation` | Confirm payment |

### 3.3 Event-Driven Processing Flow

```
                           ┌─────────────────────────────────────────┐
                           │           API Gateway                    │
                           │  POST /v1.0/tenants/{tenantId}/orders   │
                           └──────────────────┬──────────────────────┘
                                              │
                                              ▼
                           ┌─────────────────────────────────────────┐
                           │         Order API Lambda                 │
                           │  - Validate request                      │
                           │  - Generate order ID                     │
                           │  - Publish to SQS                        │
                           │  - Return 202 Accepted                   │
                           └──────────────────┬──────────────────────┘
                                              │
                                              ▼
                           ┌─────────────────────────────────────────┐
                           │      Order Creation Queue (SQS)          │
                           │  - Standard queue                        │
                           │  - 3 retry attempts                      │
                           │  - Dead Letter Queue                     │
                           └──────────────────┬──────────────────────┘
                                              │
              ┌───────────────┬───────────────┼───────────────┬───────────────┐
              │               │               │               │               │
              ▼               ▼               ▼               ▼               │
    ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
    │  Order Record   │ │   Order PDF     │ │   Internal      │ │   Customer      │
    │    Creator      │ │    Creator      │ │   Notifier      │ │   Notifier      │
    │                 │ │                 │ │                 │ │                 │
    │  Concurrency: 5 │ │  Concurrency:10 │ │  Concurrency: 5 │ │  Concurrency: 5 │
    └────────┬────────┘ └────────┬────────┘ └────────┬────────┘ └────────┬────────┘
             │                   │                   │                   │
             ▼                   ▼                   ▼                   ▼
    ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
    │    DynamoDB     │ │       S3        │ │      SES        │ │      SES        │
    │  Orders Table   │ │  Orders Bucket  │ │  Internal Email │ │ Customer Email  │
    └─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘
```

### 3.4 Guest Checkout - Tenant Resolution

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Guest Checkout Flow                                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│   Customer                   API                    Order Record Creator      │
│      │                        │                              │                │
│      │  POST /v1.0/orders    │                              │                │
│      │  (no tenantId)        │                              │                │
│      │───────────────────────>│                              │                │
│      │                        │                              │                │
│      │                        │  Validate (email required)   │                │
│      │                        │─────────────────────────────>│                │
│      │                        │                              │                │
│      │                        │  Publish event               │                │
│      │                        │  (tenantId = null)           │                │
│      │                        │─────────────────────────────>│ SQS            │
│      │                        │                              │                │
│      │  202 Accepted          │                              │                │
│      │<───────────────────────│                              │                │
│      │                        │                              │                │
│      │                        │                              │ Query by email │
│      │                        │                              │──────────────> │
│      │                        │                              │ Tenants Table  │
│      │                        │                              │                │
│      │                        │                 ┌────────────┴────────────┐   │
│      │                        │                 │                         │   │
│      │                        │           Tenant Found           Tenant Not   │
│      │                        │                 │                  Found      │
│      │                        │                 ▼                    │        │
│      │                        │           Use existing          Create new   │
│      │                        │           tenant ID             UNVALIDATED  │
│      │                        │                 │                tenant       │
│      │                        │                 │                    │        │
│      │                        │                 └────────┬───────────┘        │
│      │                        │                          │                    │
│      │                        │                          ▼                    │
│      │                        │                   Save order with             │
│      │                        │                   resolved tenantId           │
│      │                        │                                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Integration Architecture

### 4.1 Upstream Integration: Cart Management

| Aspect | Detail |
|--------|--------|
| **Trigger** | Customer clicks "Checkout" in cart |
| **Data Passed** | Cart ID, items, customer email, campaign code |
| **Protocol** | Internal API call |
| **Cart Cleanup** | Cart marked inactive after order creation |

### 4.2 Downstream Integration: Payment Management

| Aspect | Detail |
|--------|--------|
| **Trigger** | Payment confirmation webhook from PayFast |
| **Endpoint** | POST `/v1.0/orders/{orderId}/paymentconfirmation` |
| **Data Passed** | Order ID, payment ID, payment status |
| **Result** | Order status updated to PAID |

### 4.3 SQS Integration Pattern

```
                    ┌─────────────────────────────────────────────────────┐
                    │              Order Creation Event                    │
                    ├─────────────────────────────────────────────────────┤
                    │  {                                                   │
                    │    "messageId": "uuid",                              │
                    │    "timestamp": "2026-01-06T10:30:00Z",              │
                    │    "eventType": "ORDER_CREATED",                     │
                    │    "version": "1.0",                                 │
                    │    "payload": {                                      │
                    │      "orderId": "order_xxx",                         │
                    │      "tenantId": "tenant_yyy",  // null for guest   │
                    │      "customerEmail": "user@example.com",            │
                    │      "cartId": "cart_zzz",                           │
                    │      "campaignCode": "SUMMER2025",                   │
                    │      "billingAddress": {...},                        │
                    │      "paymentMethod": "payfast",                     │
                    │      "currency": "ZAR"                               │
                    │    }                                                 │
                    │  }                                                   │
                    └─────────────────────────────────────────────────────┘
```

### 4.4 Error Handling and Dead Letter Queue

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        Error Handling Flow                                │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   Order Creation Queue                    Dead Letter Queue               │
│         │                                        │                        │
│         │  Message received                      │                        │
│         │                                        │                        │
│         ▼                                        │                        │
│   ┌───────────┐                                  │                        │
│   │  Lambda   │                                  │                        │
│   │ Processing│                                  │                        │
│   └─────┬─────┘                                  │                        │
│         │                                        │                        │
│    ┌────┴────┐                                   │                        │
│    │         │                                   │                        │
│ Success   Failure                                │                        │
│    │         │                                   │                        │
│    ▼         ▼                                   │                        │
│  Delete   Retry (up to 3x)                       │                        │
│  Message     │                                   │                        │
│              │                                   │                        │
│         Still fails                              │                        │
│              │                                   │                        │
│              └──────────────────────────────────>│                        │
│                                                  │                        │
│                                      ┌───────────▼───────────┐            │
│                                      │  CloudWatch Alarm     │            │
│                                      │  (DLQ Depth > 0)      │            │
│                                      └───────────┬───────────┘            │
│                                                  │                        │
│                                                  ▼                        │
│                                      ┌───────────────────────┐            │
│                                      │    SNS Alert          │            │
│                                      │    → Ops Team         │            │
│                                      └───────────────────────┘            │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Data Architecture

### 5.1 DynamoDB Single-Table Design

| Access Pattern | Key Structure | Index |
|----------------|---------------|-------|
| Get order for tenant | PK=`TENANT#{tenantId}`, SK=`ORDER#{orderId}` | Base table |
| List orders for tenant | PK=`TENANT#{tenantId}`, SK begins_with `ORDER#` | Base table |
| Orders by date | GSI1_PK=`TENANT#{tenantId}`, GSI1_SK=`{date}#{orderId}` | GSI1 |
| Get order by ID (admin) | GSI2_PK=`ORDER#{orderId}` | GSI2 |

### 5.2 Order Status State Machine

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        Order Status Transitions                           │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                              ┌─────────────┐                              │
│                              │   PENDING   │                              │
│                              └──────┬──────┘                              │
│                                     │                                     │
│                    ┌────────────────┼────────────────┐                    │
│                    │                │                │                    │
│                    ▼                ▼                ▼                    │
│           ┌─────────────┐   ┌─────────────┐   ┌─────────────┐            │
│           │ PAYMENT_    │   │  CANCELLED  │   │   EXPIRED   │            │
│           │   PENDING   │   │  (terminal) │   │  (terminal) │            │
│           └──────┬──────┘   └─────────────┘   └─────────────┘            │
│                  │                                                        │
│         ┌────────┼────────┐                                               │
│         │        │        │                                               │
│         ▼        ▼        ▼                                               │
│  ┌─────────────┐ │ ┌─────────────┐                                       │
│  │  CANCELLED  │ │ │    PAID     │                                       │
│  │  (terminal) │ │ └──────┬──────┘                                       │
│  └─────────────┘ │        │                                               │
│                  │        ▼                                               │
│                  │ ┌─────────────┐                                        │
│                  │ │ PROCESSING  │                                        │
│                  │ └──────┬──────┘                                        │
│                  │        │                                               │
│                  │   ┌────┼────┐                                          │
│                  │   │         │                                          │
│                  │   ▼         ▼                                          │
│                  │ ┌─────────────┐ ┌─────────────┐                        │
│                  │ │  COMPLETED  │ │  REFUNDED   │                        │
│                  │ │  (terminal) │ │  (terminal) │                        │
│                  │ └─────────────┘ └─────────────┘                        │
│                  │                       ▲                                │
│                  │                       │                                │
│                  └───────────────────────┘                                │
│                   (refund from any paid state)                            │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

### 5.3 S3 Storage Structure

```
s3://bbws-orders-{environment}/
├── {tenantId}/
│   └── {orderId}/
│       ├── invoice_{orderId}.pdf
│       └── receipt_{orderId}.pdf (after payment)
│
s3://bbws-email-templates-{environment}/
├── customer/
│   ├── order_confirmation.html
│   ├── order_status_update.html
│   └── order_cancelled.html
└── internal/
    └── order_notification.html
```

---

## 6. Security Architecture

### 6.1 Authentication and Authorization

| Aspect | Implementation |
|--------|----------------|
| **API Authentication** | Cognito JWT tokens |
| **Tenant Isolation** | Orders partitioned by tenant ID in DynamoDB |
| **Authorization** | Customer can only access own tenant's orders |
| **Admin Access** | GSI2 allows cross-tenant queries for support |

### 6.2 Data Protection

| Data | Protection |
|------|------------|
| **Order Data** | Encrypted at rest (DynamoDB default) |
| **PDF Invoices** | S3 server-side encryption (AES-256) |
| **Email Templates** | S3 server-side encryption |
| **In Transit** | TLS 1.2+ for all communications |

### 6.3 Sensitive Data Handling

| Data Type | Handling |
|-----------|----------|
| **Billing Address** | Stored encrypted in DynamoDB |
| **Customer Email** | Used as identifier, stored in DynamoDB |
| **Payment Details** | Minimal data; full details in Payment service |

---

## 7. Non-Functional Requirements

### 7.1 Performance

| Metric | Target |
|--------|--------|
| API Response (create order) | < 300ms (202 Accepted) |
| Order Record Creation | < 2 seconds |
| PDF Generation | < 5 seconds |
| Email Delivery | < 10 seconds |
| End-to-End Processing | < 15 seconds |

### 7.2 Scalability

| Component | Scaling Strategy |
|-----------|------------------|
| **API Lambda** | Auto-scales with API Gateway |
| **SQS Queue** | Virtually unlimited throughput |
| **Processing Lambdas** | Reserved concurrency per function |
| **DynamoDB** | On-demand capacity mode |

### 7.3 Availability

| Metric | Target |
|--------|--------|
| API Availability | 99.9% |
| Order Processing | 99.95% success rate |
| Data Durability | 99.999999999% (11 nines) |

### 7.4 Disaster Recovery

| Aspect | Configuration |
|--------|---------------|
| **Primary Region** | af-south-1 |
| **Failover Region** | eu-west-1 |
| **DynamoDB Replication** | Global Tables (cross-region) |
| **S3 Replication** | Cross-Region Replication enabled |
| **RTO** | < 1 hour |
| **RPO** | < 5 minutes |

---

## 8. Deployment Architecture

### 8.1 Environment Promotion

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Environment Promotion Flow                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐       │
│   │     DEV     │────────>│     SIT     │────────>│    PROD     │       │
│   │  eu-west-1  │         │  eu-west-1  │         │ af-south-1  │       │
│   │             │         │             │         │             │       │
│   │ Development │         │  Testing    │         │ Production  │       │
│   │ & Debugging │         │ & QA        │         │ (Read-only  │       │
│   │             │         │             │         │  deploy)    │       │
│   └─────────────┘         └─────────────┘         └─────────────┘       │
│                                                                          │
│   Defects fixed in DEV → Promoted to SIT → Promoted to PROD             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Infrastructure Components

| Component | DEV | SIT | PROD |
|-----------|-----|-----|------|
| API Gateway | bbws-order-api-dev | bbws-order-api-sit | bbws-order-api-prod |
| Lambda Functions | 6 API + 4 SQS | 6 API + 4 SQS | 6 API + 4 SQS |
| DynamoDB Table | bbws-orders-dev | bbws-orders-sit | bbws-orders-prod |
| SQS Queues | bbws-order-creation-dev | bbws-order-creation-sit | bbws-order-creation-prod |
| S3 Buckets | bbws-orders-dev | bbws-orders-sit | bbws-orders-prod |

---

## 9. References

### 9.1 Related Documents

| Document | Relationship |
|----------|--------------|
| [BRS 2.1.8: Order Management](../BRS/2.1.8_BRS_Order_Management.md) | Parent business requirements |
| [LLD 2.1.8: Order Lambda](../LLDs/2.1.8_LLD_Order_Lambda.md) | Implementation details |
| [HLD 2.1.7: Cart Management](./2.1.7_HLD_Cart_Management.md) | Upstream component |
| [HLD 2.1.9: Payment Management](./2.1.9_HLD_Payment_Management.md) | Downstream component |

### 9.2 AWS Services Used

| Service | Purpose |
|---------|---------|
| API Gateway | REST API endpoints |
| Lambda | Serverless compute |
| SQS | Message queuing |
| DynamoDB | Order data storage |
| S3 | PDF and template storage |
| SES | Email delivery |
| CloudWatch | Monitoring and alerting |
| SNS | Alert notifications |

---

**End of Document**
