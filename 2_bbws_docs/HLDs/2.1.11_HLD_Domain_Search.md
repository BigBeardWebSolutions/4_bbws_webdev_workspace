# HLD 2.1.11: Domain Search & Management

## High-Level Design Document

**Version**: 1.1
**Author**: Platform Architecture Team
**Date**: 2026-01-08
**Status**: Approved

---

## Document History

| Version | Date | Changes | Owner |
|---------|------|---------|-------|
| 1.0 | 2026-01-08 | Initial HLD for Domain Search & Management | Platform Architecture |
| 1.1 | 2026-01-08 | Added TLD-based registrar router architecture (Section 3.5) | Platform Architecture |

---

## Executive Summary

### Purpose

This document provides the architectural design for the Domain Search & Management capability of the BBWS Customer Portal. It describes how the platform enables customers to search for, purchase, and transfer domain names using AWS Route 53 Domains API and COZA Registry API as a **stateless orchestrator** with no dedicated domain storage.

### Scope

This HLD covers the technical architecture for:
- Domain availability search (Route 53 Domains API + COZA Registry API)
- Domain pricing retrieval (SSM Parameter Store)
- Domain purchase flow (creates Order via Order Service)
- Domain transfer initiation (creates Order via Order Service)
- Payment webhook handling (triggers domain registration/transfer)
- Integration with Order Service and Payment Service

### Relationship to Other Documents

| Document | Relationship |
|----------|--------------|
| **BRS 2.1** | Business requirements for Customer Portal Public - Epic 6 |
| **LLD 2.1.11** | Detailed implementation specifications for Domain Lambda |
| **HLD 2.1.8** | Order Management - receives domain orders |
| **HLD 2.1.9** | Payment Management - processes domain payments |
| **HLD 2.1** | Customer Portal Public - parent architecture |

---

## 1. Architecture Overview

### 1.1 Design Philosophy

| Principle | Implementation |
|-----------|----------------|
| **Stateless Orchestrator** | No DynamoDB - pure API orchestration |
| **External State** | Route 53 Domains and COZA Registry are source of truth |
| **Order-Based** | Domain purchases/transfers create orders |
| **Event-Driven** | Payment webhooks trigger domain actions |
| **Pricing via SSM** | Domain pricing stored in Parameter Store |

### 1.2 High-Level Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Customer Journey                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐       │
│   │ Customer │      │ Search   │      │ Purchase │      │ Payment  │       │
│   │ searches │─────>│ available│─────>│ or       │─────>│ via      │       │
│   │ domain   │      │ domains  │      │ transfer │      │ PayFast  │       │
│   └──────────┘      └──────────┘      └──────────┘      └──────────┘       │
│        │                                    │                 │             │
│        │                                    │                 │             │
│        ▼                                    ▼                 ▼             │
├─────────────────────────────────────────────────────────────────────────────┤
│                    BBWS Domain Service (STATELESS)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────┐              ┌─────────────────┐                      │
│   │ Search API      │              │ Webhook Handler │                      │
│   │                 │              │                 │                      │
│   │ - Check avail.  │              │ - Order paid    │                      │
│   │ - Get pricing   │              │ - Register/     │                      │
│   │ - Create order  │              │   transfer      │                      │
│   └────────┬────────┘              └────────┬────────┘                      │
│            │                                │                                │
│            └────────────────┬───────────────┘                                │
│                             │                                                │
│                    ┌────────▼────────┐                                       │
│                    │  SSM Parameter  │                                       │
│                    │     Store       │                                       │
│                    │  (Pricing Only) │                                       │
│                    └─────────────────┘                                       │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                          ┌───────────┼───────────┐
                          │           │           │
                          ▼           ▼           ▼
        ┌─────────────────────┐   ┌──────────────┐   ┌──────────────┐
        │   Route 53 Domains  │   │  COZA        │   │  Order       │
        │   API               │   │  Registry    │   │  Service     │
        │                     │   │  API         │   │              │
        │  - Check avail.     │   │  (.co.za)    │   │  - Create    │
        │  - Register domain  │   │              │   │  - Get       │
        │  - Transfer domain  │   │              │   │  - Update    │
        └─────────────────────┘   └──────────────┘   └──────────────┘
```

### 1.3 Integration Model

| Pattern | Description |
|---------|-------------|
| **API Orchestration** | Domain Lambda orchestrates calls to Route 53, COZA, Order Service |
| **No Persistence** | Domain Lambda is stateless - no DynamoDB tables |
| **Order Creation** | Domain purchases/transfers create orders via Order Service API |
| **Payment Webhooks** | Order Service notifies Domain Service when payment succeeds |
| **SSM Pricing** | Domain pricing stored in SSM Parameter Store |

---

## 2. System Context

### 2.1 Context Diagram

```
                              ┌─────────────────┐
                              │    Customer     │
                              │    (Browser)    │
                              └────────┬────────┘
                                       │
                         ┌─────────────┼─────────────┐
                         │             │             │
                         ▼             │             ▼
                 ┌───────────────┐     │     ┌───────────────┐
                 │   Customer    │     │     │    PayFast    │
                 │    Portal     │     │     │    Gateway    │
                 │ (Frontend)    │     │     │               │
                 └───────┬───────┘     │     └───────┬───────┘
                         │             │             │
                         ▼             │             │
┌──────────────────────────────────────┼─────────────┼─────────────────────────┐
│                                      │             │                          │
│                BBWS Domain Management (STATELESS)  │                          │
│                                      │             │                          │
│   ┌────────────┐   ┌────────────┐   │   ┌────────▼────────┐                 │
│   │  Search    │   │  Purchase  │   │   │  Payment        │                 │
│   │    API     │   │  Transfer  │   │   │  Webhook        │                 │
│   │            │   │    API     │   │   │  Handler        │                 │
│   └────────────┘   └────────────┘   │   └─────────────────┘                 │
│                                      │                                        │
└──────────────────────────────────────┼────────────────────────────────────────┘
                                       │
            ┌──────────────────────────┼──────────────────────────┐
            │                          │                          │
            ▼                          ▼                          ▼
    ┌───────────────┐          ┌───────────────┐          ┌───────────────┐
    │  Route 53     │          │    COZA       │          │     SSM       │
    │  Domains API  │          │  Registry     │          │  Parameter    │
    │               │          │     API       │          │    Store      │
    └───────────────┘          └───────────────┘          └───────────────┘
            │                          │                          │
            ▼                          ▼                          ▼
    ┌───────────────┐          ┌───────────────┐          ┌───────────────┐
    │     Order     │          │   Payment     │          │    Email      │
    │   Service     │          │   Service     │          │   Service     │
    │  (BRS 2.1.8)  │          │  (BRS 2.1.9)  │          │    (SES)      │
    └───────────────┘          └───────────────┘          └───────────────┘
```

### 2.2 External Integrations

| System | Integration Type | Purpose |
|--------|------------------|---------|
| **Route 53 Domains** | AWS SDK | Domain availability, registration, transfer |
| **COZA Registry** | HTTPS API | .co.za domain operations |
| **Order Service** | Internal API | Create orders for domain purchases/transfers |
| **Payment Service** | Webhook | Receive payment confirmation |
| **SSM Parameter Store** | AWS SDK | Retrieve domain pricing |
| **Email Service (SES)** | AWS SDK | Send domain confirmations |

---

## 3. Component Architecture

### 3.1 Domain Search Service

**Responsibility**: Check domain availability and pricing (stateless orchestrator).

| Operation | Description | Output |
|-----------|-------------|--------|
| Check Availability | Query Route 53 / COZA for availability | Available/Unavailable + Price |
| Get Pricing | Retrieve pricing from SSM Parameter Store | Price per TLD |
| Get Domain Status | Query Route 53 for domain status | Domain status info |

### 3.2 Domain Purchase Service

**Responsibility**: Create domain purchase orders (no persistence).

| Operation | Description | Validation |
|-----------|-------------|------------|
| Create Purchase Order | Call Order Service with domain details | Domain available |
| Handle Payment Webhook | Register domain after payment | Payment confirmed |
| Register Domain | Call Route 53/COZA to register | Payment complete |

### 3.3 Domain Transfer Service

**Responsibility**: Create domain transfer orders (no persistence).

| Operation | Description | Validation |
|-----------|-------------|------------|
| Check Transferability | Verify domain can be transferred | Domain unlocked |
| Create Transfer Order | Call Order Service with transfer details | Auth code valid |
| Handle Payment Webhook | Initiate transfer after payment | Payment confirmed |
| Initiate Transfer | Call Route 53/COZA to transfer | Payment complete |

### 3.4 Webhook Handler Service

**Responsibility**: Process payment notifications and trigger domain actions.

| Operation | Description | Action |
|-----------|-------------|--------|
| Order Paid Webhook | Receive notification from Order Service | Register or transfer domain |
| Verify Payment | Confirm payment amount matches | Exact match |
| Register Domain | Execute domain registration | Route 53/COZA API |
| Send Confirmation | Email customer domain details | SES |

### 3.5 TLD-Based Registrar Router

**Responsibility**: Route domain operations to the correct registrar API based on TLD.

**Critical Design Decision**: Route 53 Domains API and COZA Registry API have different endpoints, authentication, and request/response formats. A router/dispatcher is required to determine which API to call.

#### 3.5.1 Routing Logic

```
┌─────────────────────────────────────────────────────────────────┐
│                    TLD-Based Routing Logic                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Input: Domain Name (e.g., "myboutique.co.za")                │
│                                                                  │
│   Step 1: Extract TLD                                           │
│   ┌──────────────────────────────────────────────────────────┐ │
│   │  TLD = domain.split('.')[-2:]  # ["co", "za"]            │ │
│   │  TLD = '.'.join(TLD)           # ".co.za"                │ │
│   └──────────────────────────────────────────────────────────┘ │
│                                                                  │
│   Step 2: Route to Appropriate Registrar                        │
│   ┌──────────────────────────────────────────────────────────┐ │
│   │  if TLD == ".co.za":                                      │ │
│   │      return CozaRegistryService()                         │ │
│   │  elif TLD in [".com", ".net", ".org"]:                    │ │
│   │      return Route53DomainsService()                       │ │
│   │  else:                                                     │ │
│   │      raise UnsupportedTLDError(TLD)                       │ │
│   └──────────────────────────────────────────────────────────┘ │
│                                                                  │
│   Step 3: Execute Operation via Selected Service                │
│   ┌──────────────────────────────────────────────────────────┐ │
│   │  registrar_service.check_availability(domain)             │ │
│   │  registrar_service.register_domain(domain, registrant)    │ │
│   │  registrar_service.transfer_domain(domain, auth_code)     │ │
│   └──────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.5.2 Registrar Service Interface

Both Route 53 and COZA services implement a common interface to ensure consistent behavior:

```python
class RegistrarServiceInterface(ABC):
    @abstractmethod
    def check_availability(self, domain: str) -> DomainAvailability:
        """Check if domain is available for registration"""
        pass

    @abstractmethod
    def register_domain(self, domain: str, registrant: RegistrantInfo,
                       years: int) -> RegistrationResult:
        """Register a new domain"""
        pass

    @abstractmethod
    def transfer_domain(self, domain: str, auth_code: str,
                       registrant: RegistrantInfo) -> TransferResult:
        """Transfer domain from another registrar"""
        pass

    @abstractmethod
    def get_domain_status(self, domain: str) -> DomainStatus:
        """Get current status of domain"""
        pass
```

#### 3.5.3 TLD to Registrar Mapping

| TLD | Registrar Service | API Endpoint | Authentication |
|-----|------------------|--------------|----------------|
| `.co.za` | COZA Registry | `https://registry.net.za/api/` | API Key (Secrets Manager) |
| `.com` | Route 53 Domains | AWS API | IAM Role |
| `.net` | Route 53 Domains | AWS API | IAM Role |
| `.org` | Route 53 Domains | AWS API | IAM Role |

#### 3.5.4 Error Handling per Registrar

Different registrars return different error formats. The router normalizes these into consistent error responses:

| Scenario | COZA Response | Route 53 Response | Normalized Error |
|----------|---------------|-------------------|------------------|
| Domain unavailable | `{"status": "taken"}` | `{"Availability": "UNAVAILABLE"}` | `DomainUnavailableError` |
| Invalid auth code | `{"error": "Invalid EPP code"}` | `InvalidAuthCode` exception | `InvalidAuthorizationCodeError` |
| Domain locked | `{"error": "Domain locked"}` | `DomainLocked` exception | `DomainLockedError` |
| API timeout | HTTP 504 | `RequestTimeout` exception | `RegistrarTimeoutError` |

---

## 4. Key Operations

### 4.1 Domain Search Flow

```
┌──────────┐   ┌────────────┐   ┌──────────┐   ┌───────────┐   ┌──────────┐
│ Customer │   │   Portal   │   │ Domain   │   │  Route 53 │   │   SSM    │
│          │   │  Frontend  │   │  Service │   │  Domains  │   │  Params  │
└────┬─────┘   └─────┬──────┘   └────┬─────┘   └─────┬─────┘   └────┬─────┘
     │               │               │               │               │
     │  Search domain│               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ POST /domains/│               │               │
     │               │     search    │               │               │
     │               │──────────────>│               │               │
     │               │               │               │               │
     │               │               │ Get pricing   │               │
     │               │               │──────────────────────────────>│
     │               │               │               │               │
     │               │               │ Pricing data  │               │
     │               │               │<──────────────────────────────│
     │               │               │               │               │
     │               │               │ Check avail.  │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ Availability  │               │
     │               │               │<──────────────│               │
     │               │               │               │               │
     │               │ Results +     │               │               │
     │               │ pricing       │               │               │
     │               │<──────────────│               │               │
     │               │               │               │               │
     │  Display      │               │               │               │
     │  results      │               │               │               │
     │<──────────────│               │               │               │
```

### 4.2 Domain Purchase Flow (via Order Service)

```
┌──────────┐   ┌────────────┐   ┌──────────┐   ┌───────────┐   ┌──────────┐
│ Customer │   │   Portal   │   │ Domain   │   │  Order    │   │ Payment  │
│          │   │  Frontend  │   │  Service │   │  Service  │   │ Service  │
└────┬─────┘   └─────┬──────┘   └────┬─────┘   └─────┬─────┘   └────┬─────┘
     │               │               │               │               │
     │  Click Buy    │               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ POST /domains/│               │               │
     │               │    register   │               │               │
     │               │──────────────>│               │               │
     │               │               │               │               │
     │               │               │ Create order  │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ Order created │               │
     │               │               │<──────────────│               │
     │               │               │               │               │
     │               │ Order details │               │               │
     │               │<──────────────│               │               │
     │               │               │               │               │
     │  Redirect to  │               │               │               │
     │  payment      │               │               │               │
     │──────────────────────────────────────────────────────────────>│
     │               │               │               │               │
     │  Payment      │               │               │               │
     │  complete     │               │               │               │
     │<──────────────────────────────────────────────────────────────│
     │               │               │               │               │
     │               │               │               │ Payment       │
     │               │               │               │ confirmed     │
     │               │               │               │<──────────────│
     │               │               │               │               │
     │               │               │ POST /webhooks│               │
     │               │               │ /order-paid   │               │
     │               │               │<──────────────│               │
     │               │               │               │               │
     │               │               │ Register      │               │
     │               │               │ domain via    │               │
     │               │               │ Route 53      │               │
     │               │               │               │               │
     │               │               │ Send email    │               │
     │               │               │ confirmation  │               │
```

### 4.3 Domain Transfer Flow

```
┌──────────┐   ┌────────────┐   ┌──────────┐   ┌───────────┐   ┌──────────┐
│ Customer │   │   Portal   │   │ Domain   │   │  Order    │   │  Route   │
│          │   │  Frontend  │   │  Service │   │  Service  │   │  53/COZA │
└────┬─────┘   └─────┬──────┘   └────┬─────┘   └─────┬─────┘   └────┬─────┘
     │               │               │               │               │
     │  Enter domain │               │               │               │
     │  + auth code  │               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ POST /domains/│               │               │
     │               │    transfer   │               │               │
     │               │──────────────>│               │               │
     │               │               │               │               │
     │               │               │ Check         │               │
     │               │               │ transferable  │               │
     │               │               │──────────────────────────────>│
     │               │               │               │               │
     │               │               │ Eligible      │               │
     │               │               │<──────────────────────────────│
     │               │               │               │               │
     │               │               │ Create order  │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ Order created │               │
     │               │               │<──────────────│               │
     │               │               │               │               │
     │               │ Order details │               │               │
     │               │<──────────────│               │               │
     │               │               │               │               │
     │  Proceed to   │               │               │               │
     │  payment      │               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ [Payment flow]│               │               │
     │               │               │               │               │
     │               │               │ POST /webhooks│               │
     │               │               │ /transfer-paid│               │
     │               │               │<──────────────│               │
     │               │               │               │               │
     │               │               │ Initiate      │               │
     │               │               │ transfer      │               │
     │               │               │──────────────────────────────>│
     │               │               │               │               │
     │               │               │ Transfer      │               │
     │               │               │ initiated     │               │
     │               │               │<──────────────────────────────│
     │               │               │               │               │
     │               │               │ Send email    │               │
     │               │               │ confirmation  │               │
```

---

## 5. API Endpoints

### 5.1 API Structure

**Base URL (PROD)**: `https://api.kimmyai.io`
**Base URL (SIT)**: `https://sit.api.kimmyai.io`
**Base URL (DEV)**: `https://dev.api.kimmyai.io`

> **Note**: API version (`/v1.0`) is included in each endpoint path, not the base URL.

### 5.2 HATEOAS Operations: Domain

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/domains/search` | Search for available domains |
| POST | `/v1.0/domains/register` | Create order for domain registration |
| POST | `/v1.0/domains/transfer` | Create order for domain transfer |
| GET | `/v1.0/domains/{domain}/availability` | Check single domain availability |
| GET | `/v1.0/domains/{domain}/status` | Get domain status from Route 53 |
| GET | `/v1.0/domains/pricing` | Get current domain pricing |
| POST | `/v1.0/webhooks/order-paid` | Order Service webhook - domain purchase paid |
| POST | `/v1.0/webhooks/transfer-paid` | Order Service webhook - domain transfer paid |

#### 5.2.1 POST `/v1.0/domains/search` - Search Domains

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Request Body:**
```json
{
  "domainName": "myboutique",
  "tlds": [".co.za", ".com", ".net", ".org"]
}
```

**Success Response (200 OK):**
```json
{
  "results": [
    {
      "domain": "myboutique.co.za",
      "available": true,
      "price": 95,
      "currency": "ZAR"
    },
    {
      "domain": "myboutique.com",
      "available": false,
      "price": null,
      "currency": null,
      "suggestions": ["myboutique-shop.com", "my-boutique.com"]
    },
    {
      "domain": "myboutique.net",
      "available": true,
      "price": 250,
      "currency": "ZAR"
    },
    {
      "domain": "myboutique.org",
      "available": true,
      "price": 250,
      "currency": "ZAR"
    }
  ]
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Invalid domain name format",
  "details": [
    {
      "field": "domainName",
      "message": "Domain name can only contain letters, numbers, and hyphens"
    }
  ]
}
```

#### 5.2.2 POST `/v1.0/domains/register` - Create Domain Purchase Order

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Request Body:**
```json
{
  "domain": "myboutique.co.za",
  "registrationYears": 1,
  "registrantInfo": {
    "fullName": "Jane Smith",
    "organization": "My Boutique",
    "email": "jane@myboutique.co.za",
    "phone": "+27821234567",
    "address": {
      "street": "123 Main Street",
      "city": "Cape Town",
      "state": "Western Cape",
      "postalCode": "8001",
      "country": "ZA"
    }
  },
  "privacyProtection": true,
  "autoRenew": true
}
```

**Success Response (201 Created):**
```json
{
  "orderId": "ord_550e8400-e29b-41d4-a716-446655440000",
  "domain": "myboutique.co.za",
  "registrationYears": 1,
  "totalPrice": 95,
  "currency": "ZAR",
  "status": "PENDING_PAYMENT",
  "paymentUrl": "https://portal.kimmyai.io/checkout?orderId=ord_550e8400",
  "dateCreated": "2026-01-08T10:30:00Z"
}
```

**Error Response (400 Bad Request - Domain Unavailable):**
```json
{
  "error": "DomainUnavailable",
  "message": "Domain 'myboutique.co.za' is no longer available"
}
```

**Error Response (422 Unprocessable Entity - Missing Registrant Info):**
```json
{
  "error": "ValidationError",
  "message": "Incomplete registrant information",
  "details": [
    {
      "field": "registrantInfo.phone",
      "message": "Phone number is required by ICANN regulations"
    }
  ]
}
```

#### 5.2.3 POST `/v1.0/domains/transfer` - Create Domain Transfer Order

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Request Body:**
```json
{
  "domain": "existing-domain.co.za",
  "authorizationCode": "EPP-ABC-12345",
  "registrantInfo": {
    "fullName": "Jane Smith",
    "organization": "My Boutique",
    "email": "jane@myboutique.co.za",
    "phone": "+27821234567",
    "address": {
      "street": "123 Main Street",
      "city": "Cape Town",
      "state": "Western Cape",
      "postalCode": "8001",
      "country": "ZA"
    }
  }
}
```

**Success Response (201 Created):**
```json
{
  "orderId": "ord_660e8400-e29b-41d4-a716-446655440001",
  "domain": "existing-domain.co.za",
  "transferPrice": 95,
  "currency": "ZAR",
  "estimatedCompletionDays": 7,
  "status": "PENDING_PAYMENT",
  "paymentUrl": "https://portal.kimmyai.io/checkout?orderId=ord_660e8400",
  "dateCreated": "2026-01-08T11:00:00Z"
}
```

**Error Response (400 Bad Request - Invalid Auth Code):**
```json
{
  "error": "InvalidAuthorizationCode",
  "message": "Authorization code is invalid or has expired"
}
```

**Error Response (422 Unprocessable Entity - Domain Locked):**
```json
{
  "error": "DomainLocked",
  "message": "Domain is locked and cannot be transferred. Please unlock at current registrar."
}
```

#### 5.2.4 GET `/v1.0/domains/{domain}/availability` - Check Single Domain

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Success Response (200 OK):**
```json
{
  "domain": "myboutique.co.za",
  "available": true,
  "price": 95,
  "currency": "ZAR"
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "InvalidDomain",
  "message": "Invalid domain format"
}
```

#### 5.2.5 GET `/v1.0/domains/{domain}/status` - Get Domain Status

**Request Headers:**
```json
{
  "Authorization": "Bearer <token>"
}
```

**Success Response (200 OK):**
```json
{
  "domain": "myboutique.co.za",
  "status": "REGISTERED",
  "registeredAt": "2026-01-08T12:00:00Z",
  "expiresAt": "2027-01-08T12:00:00Z",
  "autoRenew": true,
  "nameservers": [
    "ns1.kimmyai.io",
    "ns2.kimmyai.io"
  ]
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Domain 'myboutique.co.za' not found in your account"
}
```

#### 5.2.6 GET `/v1.0/domains/pricing` - Get Domain Pricing

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Success Response (200 OK):**
```json
{
  "pricing": [
    {
      "tld": ".co.za",
      "registrationPrice": 95,
      "renewalPrice": 95,
      "transferPrice": 95,
      "currency": "ZAR"
    },
    {
      "tld": ".com",
      "registrationPrice": 250,
      "renewalPrice": 250,
      "transferPrice": 250,
      "currency": "ZAR"
    },
    {
      "tld": ".net",
      "registrationPrice": 250,
      "renewalPrice": 250,
      "transferPrice": 250,
      "currency": "ZAR"
    },
    {
      "tld": ".org",
      "registrationPrice": 250,
      "renewalPrice": 250,
      "transferPrice": 250,
      "currency": "ZAR"
    }
  ]
}
```

#### 5.2.7 POST `/v1.0/webhooks/order-paid` - Domain Purchase Paid

**Description**: This endpoint receives notifications from Order Service when a domain purchase order is paid.

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "X-Webhook-Signature": "sha256=<signature>"
}
```

**Request Body:**
```json
{
  "orderId": "ord_550e8400-e29b-41d4-a716-446655440000",
  "domain": "myboutique.co.za",
  "paymentAmount": 95,
  "paymentReference": "PF123456789",
  "registrantInfo": {
    "fullName": "Jane Smith",
    "organization": "My Boutique",
    "email": "jane@myboutique.co.za",
    "phone": "+27821234567",
    "address": {
      "street": "123 Main Street",
      "city": "Cape Town",
      "state": "Western Cape",
      "postalCode": "8001",
      "country": "ZA"
    }
  },
  "registrationYears": 1,
  "privacyProtection": true,
  "autoRenew": true
}
```

**Success Response (200 OK):**
```json
{
  "status": "success",
  "message": "Domain registration initiated",
  "domain": "myboutique.co.za",
  "registrationStatus": "IN_PROGRESS"
}
```

**Error Response (400 Bad Request - Invalid Signature):**
```json
{
  "error": "InvalidSignature",
  "message": "Webhook signature validation failed"
}
```

**Error Response (422 Unprocessable Entity - Registration Failed):**
```json
{
  "error": "RegistrationFailed",
  "message": "Domain registration failed at registrar",
  "details": "Domain was sniped by another customer"
}
```

#### 5.2.8 POST `/v1.0/webhooks/transfer-paid` - Domain Transfer Paid

**Description**: This endpoint receives notifications from Order Service when a domain transfer order is paid.

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "X-Webhook-Signature": "sha256=<signature>"
}
```

**Request Body:**
```json
{
  "orderId": "ord_660e8400-e29b-41d4-a716-446655440001",
  "domain": "existing-domain.co.za",
  "authorizationCode": "EPP-ABC-12345",
  "paymentAmount": 95,
  "paymentReference": "PF987654321",
  "registrantInfo": {
    "fullName": "Jane Smith",
    "organization": "My Boutique",
    "email": "jane@myboutique.co.za",
    "phone": "+27821234567",
    "address": {
      "street": "123 Main Street",
      "city": "Cape Town",
      "state": "Western Cape",
      "postalCode": "8001",
      "country": "ZA"
    }
  }
}
```

**Success Response (200 OK):**
```json
{
  "status": "success",
  "message": "Domain transfer initiated",
  "domain": "existing-domain.co.za",
  "transferStatus": "PENDING",
  "estimatedCompletionAt": "2026-01-15T12:00:00Z"
}
```

**Error Response (400 Bad Request - Invalid Auth Code):**
```json
{
  "error": "InvalidAuthorizationCode",
  "message": "Authorization code rejected by current registrar"
}
```

---

## 6. Authentication

### 6.1 Authentication Method

**Authentication Type**: AWS Cognito Bearer Token (for customer operations) + Webhook Signature (for Order Service callbacks)

**Protected Endpoints:**
- Domain registration/transfer endpoints require valid Cognito token
- Customer can only access their own domains
- Admin role can access all domains

**Unprotected Endpoints:**
- `/v1.0/domains/search` - Public domain search
- `/v1.0/domains/{domain}/availability` - Public availability check
- `/v1.0/domains/pricing` - Public pricing information
- `/v1.0/webhooks/order-paid` - Validated by webhook signature
- `/v1.0/webhooks/transfer-paid` - Validated by webhook signature

### 6.2 Protected Endpoints

| Endpoint Pattern | Auth Required | Roles |
|-----------------|---------------|-------|
| `POST /v1.0/domains/search` | No | Public |
| `POST /v1.0/domains/register` | Yes | Customer, Admin |
| `POST /v1.0/domains/transfer` | Yes | Customer, Admin |
| `GET /v1.0/domains/{domain}/availability` | No | Public |
| `GET /v1.0/domains/{domain}/status` | Yes | Customer (own domain), Admin |
| `GET /v1.0/domains/pricing` | No | Public |
| `POST /v1.0/webhooks/order-paid` | Signature | Order Service |
| `POST /v1.0/webhooks/transfer-paid` | Signature | Order Service |

---

## 7. Data Architecture

### 7.1 NO DynamoDB Tables

**IMPORTANT**: Domain Service is a **stateless orchestrator** with NO dedicated DynamoDB tables.

| State | Storage Location |
|-------|------------------|
| Domain availability | Route 53 Domains API / COZA Registry API |
| Domain pricing | SSM Parameter Store |
| Domain purchase orders | Order Service DynamoDB |
| Domain transfer orders | Order Service DynamoDB |
| Domain registration status | Route 53 Domains API / COZA Registry API |
| Payment status | Payment Service DynamoDB |

### 7.2 SSM Parameter Store Schema

Domain pricing is stored in SSM Parameter Store with the following structure:

| Parameter Name | Type | Value Example | Description |
|---------------|------|---------------|-------------|
| `/bbws/domain/pricing/co.za` | String | `{"registration": 95, "renewal": 95, "transfer": 95, "currency": "ZAR"}` | .co.za pricing |
| `/bbws/domain/pricing/com` | String | `{"registration": 250, "renewal": 250, "transfer": 250, "currency": "ZAR"}` | .com pricing |
| `/bbws/domain/pricing/net` | String | `{"registration": 250, "renewal": 250, "transfer": 250, "currency": "ZAR"}` | .net pricing |
| `/bbws/domain/pricing/org` | String | `{"registration": 250, "renewal": 250, "transfer": 250, "currency": "ZAR"}` | .org pricing |

**Pricing Update Process**:
1. Business Owner updates SSM parameters via AWS Console or CLI
2. Domain Lambda reads from SSM (cached for 5 minutes)
3. No database schema changes required

### 7.3 Integration with Order Service

Domain orders are stored in the Order Service DynamoDB table with `orderType: "DOMAIN_REGISTRATION"` or `"DOMAIN_TRANSFER"`.

**Order Record Example (in Order Service DynamoDB)**:
```json
{
  "orderId": "ord_550e8400-e29b-41d4-a716-446655440000",
  "tenantId": "ten_660e8400-e29b-41d4-a716-446655440001",
  "orderType": "DOMAIN_REGISTRATION",
  "status": "PENDING_PAYMENT",
  "items": [
    {
      "itemType": "DOMAIN",
      "domain": "myboutique.co.za",
      "registrationYears": 1,
      "price": 95,
      "currency": "ZAR"
    }
  ],
  "total": 95,
  "currency": "ZAR",
  "metadata": {
    "registrantInfo": { ... },
    "privacyProtection": true,
    "autoRenew": true
  },
  "dateCreated": "2026-01-08T10:30:00Z",
  "dateLastUpdated": "2026-01-08T10:30:00Z"
}
```

---

## 8. Non-Functional Requirements

### 8.1 Performance

| Metric | Target | Rationale |
|--------|--------|-----------|
| Domain Search | < 2s P95 | User experience |
| Domain Registration | < 30s P95 | Route 53 API latency |
| Transfer Initiation | < 30s P95 | Route 53 API latency |
| Webhook Processing | < 5s P95 | Order Service timeout |

### 8.2 Availability

| Metric | Target | Rationale |
|--------|--------|-----------|
| Domain API | 99.9% | Revenue critical |
| Search Endpoint | 99.99% | Public-facing |

### 8.3 Security

| Control | Implementation |
|---------|----------------|
| No Card Storage | Payment via Order Service + Payment Service |
| Webhook Validation | HMAC signature verification |
| Registrant PII | Encrypted at rest in Order Service |
| Auth Code Storage | Encrypted, deleted after transfer |
| API Rate Limiting | WAF rules: 100 req/min per IP |

---

## 9. Security Architecture

### 9.1 Domain Service Security

```
┌─────────────────────────────────────────────────────────────────┐
│                     Security Controls                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   1. Public Endpoints (Search, Pricing)                         │
│      ┌──────────────┐                                           │
│      │ WAF Rate     │──────> 100 req/min per IP                 │
│      │ Limiting     │        1000 req/hour per IP               │
│      └──────────────┘                                           │
│                                                                  │
│   2. Protected Endpoints (Register, Transfer)                   │
│      ┌──────────────┐                                           │
│      │ Cognito JWT  │──────> Bearer token validation            │
│      │ Validation   │        Tenant isolation                   │
│      └──────────────┘                                           │
│                                                                  │
│   3. Webhook Endpoints (Order Paid)                             │
│      ┌──────────────┐                                           │
│      │ HMAC         │──────> Signature with shared secret       │
│      │ Signature    │        Timestamp validation (5 min)       │
│      └──────────────┘                                           │
│                                                                  │
│   4. Registrant Data Protection                                 │
│      ┌──────────────┐                                           │
│      │ Encryption   │──────> At-rest in Order Service           │
│      │              │        In-transit via TLS 1.3             │
│      └──────────────┘                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 Credential Management

| Credential | Storage | Rotation |
|------------|---------|----------|
| Route 53 IAM Role | IAM | Managed by AWS |
| COZA API Key | Secrets Manager | Annual |
| Webhook Secret | Secrets Manager | Quarterly |
| SSM Parameters | SSM (encrypted) | On business request |

---

## 10. Technology Decisions

### 10.1 Technology Stack

| Component | Technology | Rationale |
|-----------|------------|-----------|
| **API Layer** | AWS Lambda + API Gateway | Serverless, auto-scaling |
| **Domain Registrar** | AWS Route 53 Domains | Integrated AWS service |
| **COZA Registrar** | COZA Registry API | .co.za domains |
| **Pricing Storage** | SSM Parameter Store | Simple, no database overhead |
| **Order Management** | Order Service API | Reuse existing service |
| **Email** | Amazon SES | Reliable email delivery |
| **Monitoring** | CloudWatch | Integrated logging/metrics |

### 10.2 Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Domain Registration | Route 53 + COZA | AWS-native + local .co.za support |
| State Management | Stateless (no DynamoDB) | Domain state lives in Route 53/COZA |
| Pricing Storage | SSM Parameter Store | Business can update without code changes |
| Order Creation | Via Order Service API | Reuse existing checkout/payment flow |
| Payment Handling | Webhook from Order Service | Event-driven, decoupled |
| **TLD Routing** | **Router pattern with interface** | **Route 53 and COZA have different APIs - router dispatches to correct service based on TLD** |
| Registrar Abstraction | Common interface (ABC) | Enables adding new TLDs without changing handlers |

---

## 11. Error Handling

### 11.1 Error Scenarios

| Scenario | Handling |
|----------|----------|
| Domain unavailable (sniped) | 400, refund customer via Order Service |
| Route 53 API timeout | Retry 3x with backoff, fail gracefully |
| COZA API failure | Fallback to generic error, manual support |
| Invalid auth code | 400, clear error message |
| Domain locked | 422, instructions to unlock |
| Payment webhook fails | DLQ, manual intervention |
| Registrant info incomplete | 422, clear field-level errors |

### 11.2 Retry Strategy

| Operation | Retries | Backoff |
|-----------|---------|---------|
| Route 53 API calls | 3 | Exponential (1s, 2s, 4s) |
| COZA API calls | 3 | Exponential |
| Order Service API | 3 | Fixed 1s |
| Email send | 3 | Fixed 1s |

---

## 12. Monitoring

### 12.1 Key Metrics

| Metric | Alert Threshold |
|--------|-----------------|
| Domain Registration Success Rate | < 95% |
| Domain Search Latency | > 3s P95 |
| Route 53 API Errors | > 5/hour |
| COZA API Errors | > 5/hour |
| Webhook Processing Failures | Any |

### 12.2 Dashboards

| Dashboard | Content |
|-----------|---------|
| Domain Overview | Search volume, registration count, transfer count |
| Error Analysis | Failed registrations/transfers by reason |
| Performance | API latency, Route 53 response times |
| Revenue | Domain sales by TLD |

---

## 13. Repositories

### 13.1 Repository List

Following the naming convention: `[HLD_Prefix]_[project]_[service]_lambda`

| # | Repository | Type | Description |
|---|------------|------|-------------|
| 1 | `2_1_11_bbws_domain_lambda` | Backend | Domain service with Route 53 + COZA integration (Python 3.12) |
| 2 | `2_1_bbws_operations` | Operations | CloudWatch dashboards, alarms, budgets, WAF rules (shared) |
| 3 | `2_1_bbws_web_public` | Frontend | React SPA - already exists with domain UI |

### 13.2 Repository Structure

```
2_1_11_bbws_domain_lambda/
├── src/
│   ├── handlers/
│   │   ├── search_domains.py
│   │   ├── register_domain.py
│   │   ├── transfer_domain.py
│   │   ├── get_domain_status.py
│   │   ├── get_pricing.py
│   │   ├── webhook_order_paid.py
│   │   └── webhook_transfer_paid.py
│   ├── services/
│   │   ├── registrar/
│   │   │   ├── __init__.py
│   │   │   ├── registrar_interface.py      # ABC interface for all registrars
│   │   │   ├── registrar_router.py         # TLD-based router/dispatcher
│   │   │   ├── route53_service.py          # Route 53 implementation (.com/.net/.org)
│   │   │   └── coza_service.py             # COZA Registry implementation (.co.za)
│   │   ├── order_service_client.py
│   │   ├── pricing_service.py
│   │   └── email_service.py
│   ├── models/
│   │   ├── domain_search.py
│   │   ├── domain_registration.py
│   │   ├── domain_transfer.py
│   │   └── registrar_response.py           # Normalized registrar responses
│   └── utils/
│       ├── webhook_validator.py
│       ├── response_builder.py
│       └── tld_extractor.py                # Extract TLD from domain name
├── tests/
│   ├── unit/
│   │   ├── test_registrar_router.py        # Test TLD routing logic
│   │   ├── test_route53_service.py
│   │   └── test_coza_service.py
│   └── integration/
│       ├── test_domain_search_flow.py
│       └── test_domain_registration_flow.py
├── terraform/
│   ├── main.tf
│   ├── api_gateway.tf
│   ├── lambda.tf
│   ├── iam.tf
│   ├── ssm.tf
│   ├── secrets.tf                          # COZA API key
│   ├── variables.tf
│   └── outputs.tf
├── requirements.txt
├── pytest.ini
└── README.md
```

---

## 14. Business Approval Requirements

### 14.1 Artefacts Requiring Business Approval

The following artefacts **MUST** have Business Owner (BO) approval before deployment:

| Category | Artefacts | Approval Required |
|----------|-----------|-------------------|
| **Domain Pricing** | SSM Parameter Store pricing values | BO Sign-off |
| **Email Templates** | Domain registration confirmation, transfer initiation, transfer completion | BO Sign-off |
| **Customer Messaging** | Error messages for domain unavailable, transfer failures, registration failures | BO Sign-off |
| **Domain Registration Flow** | Registration process, ICANN compliance messaging | BO Sign-off |
| **Transfer Flow** | Transfer instructions, auth code collection, timeline messaging | BO Sign-off |

### 14.2 Business Approval Process

```
┌─────────────────────────────────────────────────────────────────┐
│              BUSINESS APPROVAL PROCESS                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. DEVELOPMENT                                                 │
│     └── Dev team completes domain integration                  │
│                                                                 │
│  2. DEV REVIEW                                                  │
│     └── Technical review (Route 53, COZA APIs, error handling) │
│                                                                 │
│  3. PRICING APPROVAL                                            │
│     └── BO approves domain pricing structure                   │
│                                                                 │
│  4. STAGING DEPLOYMENT                                          │
│     └── Deploy to SIT for business review (sandbox mode)       │
│                                                                 │
│  5. BUSINESS OWNER REVIEW                                       │
│     ├── BO reviews domain search flow in SIT                   │
│     ├── BO tests registration flow (Route 53 sandbox)          │
│     ├── BO tests transfer flow                                 │
│     ├── BO reviews email notifications                         │
│     ├── BO provides feedback or approval                       │
│     └── Iterate until BO sign-off obtained                     │
│                                                                 │
│  6. PRODUCTION DEPLOYMENT                                       │
│     └── Only after BO sign-off documented                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 15. Implementation Plan

### 15.1 Development Approach

**Backend-First Approach**: Domain integration requires backend implementation first due to Route 53 API and Order Service integration.

### 15.2 Milestones (with Business Owner Gates)

> **IMPORTANT**: Each milestone requires **Business Owner (BO) Review** before proceeding to the next milestone. No milestone is considered complete without documented BO sign-off.

| # | Milestone | Deliverables | Tech Review | BO Review |
|---|-----------|--------------|-------------|-----------|
| 0.1 | SSM Pricing Setup | SSM parameters for domain pricing | Dev Review | **BO Sign-off Required** |
| 0.2 | Route 53 Integration | Domain search via Route 53 Domains API | Dev Review | **BO Sign-off Required** |
| 0.3 | COZA Integration | .co.za domain operations via COZA API | Dev Review | **BO Sign-off Required** |
| 0.4 | Order Service Integration | Create domain orders via Order Service API | Dev Review | **BO Sign-off Required** |
| 0.5 | Payment Webhook Handler | Process order-paid webhooks, register domains | Dev Review | **BO Sign-off Required** |
| 0.6 | Transfer Flow | Domain transfer with auth code validation | Dev Review | **BO Sign-off Required** |
| 0.7 | Email Notifications | Registration/transfer confirmation emails | Dev Review | **BO Sign-off Required** |
| 0.8 | Integration Testing | Full flow testing with Route 53 sandbox | QA Review | **BO Approval Required** |
| 0.9 | UAT | User Acceptance Testing in SIT | QA Review | **BO Final Approval** |
| 1.0 | Production | Live deployment with Route 53 production credentials | Tech Lead | **BO Go-Live Approval** |

---

## 16. LLDs Reference

### 16.1 Parent HLD Information

| Attribute | Value |
|-----------|-------|
| HLD Document | `2.1.11_HLD_Domain_Search.md` |
| HLD Version | v1.1 |
| HLD Prefix | `2.1.11` |
| Total LLDs | 1 technical + 2 operational |

### 16.2 Technical LLDs

Following the naming convention: `[HLD_Prefix]_LLD_[Name].md`

| LLD ID | LLD Name | Description | Repository | Status |
|--------|----------|-------------|------------|--------|
| 2.1.11 | `2.1.11_LLD_Domain_Lambda.md` | Domain service implementation with Route 53 + COZA integration | `2_1_11_bbws_domain_lambda` | To be created |

### 16.3 Operational Runbooks

Following the naming convention: `[HLD_Prefix]_OPS_[Name].md`

| OPS ID | Runbook Name | Description | Status |
|--------|--------------|-------------|--------|
| 2.1.11.1 | `2.1.11_OPS_Domain_Monitoring.md` | CloudWatch dashboards, alarms for domain failures | Draft |
| 2.1.11.2 | `2.1.11_OPS_Route53_COZA_Troubleshooting.md` | Troubleshooting Route 53 and COZA API issues | Draft |

---

## 17. References

| Document | Path |
|----------|------|
| BRS 2.1: Customer Portal Public | `BRS/2.1_BRS_Customer_Portal_Public.md` (Epic 6) |
| LLD 2.1.11: Domain Lambda | `LLDs/2.1.11_LLD_Domain_Lambda.md` (to be created) |
| HLD 2.1: Customer Portal Public | `HLDs/2.1_BBWS_Customer_Portal_Public_HLD_V1.1.md` |
| HLD 2.1.8: Order Management | `HLDs/2.1.8_HLD_Order_Management.md` |
| HLD 2.1.9: Payment Management | `HLDs/2.1.9_HLD_Payment_Management.md` |
| AWS Route 53 Domains Developer Guide | https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/domain-register.html |
| COZA Registry API Documentation | https://www.registry.net.za/content.php?gen=1&contentid=75&title=API |

---

**End of Document**
