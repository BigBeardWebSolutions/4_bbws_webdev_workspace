# HLD 2.1.9: Payment Management

## High-Level Design Document

**Version**: 1.1
**Author**: Platform Architecture Team
**Date**: 2026-01-08
**Status**: Draft

---

## Document History

| Version | Date | Changes | Owner |
|---------|------|---------|-------|
| 1.0 | 2026-01-05 | Initial HLD extracted from LLD | Platform Architecture |
| 1.1 | 2026-01-08 | Added Section 5 (API Endpoints), Section 6 (Authentication), updated Section 7 (DynamoDB with Activatable Entity Pattern), added Section 13 (Repositories), Section 14 (Business Approval), Section 15 (Implementation Plan), Section 16 (LLDs Reference) | HLD Architect |

---

## Executive Summary

### Purpose

This document provides the architectural design for the Payment Management capability of the BBWS Customer Portal. It describes how the platform integrates with PayFast to process customer payments for WordPress hosting orders.

### Scope

This HLD covers the technical architecture for:
- Payment initiation and redirect to PayFast
- Instant Transaction Notification (ITN) processing
- Order status updates on payment completion
- Payment status tracking and history

### Relationship to Other Documents

| Document | Relationship |
|----------|--------------|
| **BRS 2.1.9** | Business requirements this architecture implements |
| **LLD 2.1.9** | Detailed implementation specifications |
| **HLD 2.1.8** | Order Management - creates orders to be paid |
| **HLD 2.1** | Customer Portal Public - parent architecture |

---

## 1. Architecture Overview

### 1.1 Design Philosophy

| Principle | Implementation |
|-----------|----------------|
| **Redirect Model** | Customer redirected to PayFast - no card data touches our system |
| **Webhook-Driven** | Payment status via ITN callbacks from PayFast |
| **Idempotent Processing** | Duplicate ITN notifications handled safely |
| **PCI DSS Compliant** | No storage of payment card data |

### 1.2 High-Level Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Customer Journey                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐       │
│   │ Customer │      │ Customer │      │ PayFast  │      │ Customer │       │
│   │ selects  │─────>│ redirects│─────>│ payment  │─────>│ returns  │       │
│   │ pay      │      │ to PayFast      │ page     │      │ to portal│       │
│   └──────────┘      └──────────┘      └──────────┘      └──────────┘       │
│        │                                    │                 │             │
│        │                                    │                 │             │
│        ▼                                    ▼                 ▼             │
├─────────────────────────────────────────────────────────────────────────────┤
│                           BBWS Payment Service                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────┐              ┌─────────────────┐                      │
│   │ Initiate        │              │ ITN Webhook     │                      │
│   │ Payment API     │              │ Handler         │                      │
│   │                 │              │                 │                      │
│   │ - Generate URL  │              │ - Validate sig  │                      │
│   │ - Create record │              │ - Update status │                      │
│   │ - Redirect      │              │ - Send email    │                      │
│   └────────┬────────┘              └────────┬────────┘                      │
│            │                                │                                │
│            └────────────────┬───────────────┘                                │
│                             │                                                │
│                    ┌────────▼────────┐                                       │
│                    │    DynamoDB     │                                       │
│                    │  Payment Table  │                                       │
│                    └─────────────────┘                                       │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ ITN Callback
                                      │
┌─────────────────────────────────────▼────────────────────────────────────────┐
│                            PayFast Gateway                                    │
│                                                                               │
│   - Handles card/EFT transactions                                            │
│   - Sends ITN notifications                                                  │
│   - Provides transaction verification                                        │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 Integration Model

| Pattern | Description |
|---------|-------------|
| **Redirect** | Customer browser redirected to PayFast hosted page |
| **ITN Callback** | PayFast server posts payment result to webhook |
| **Verification** | Platform verifies ITN with PayFast server |

---

## 2. System Context

### 2.1 Context Diagram

```
                              ┌─────────────────┐
                              │    Customer     │
                              │    (Browser)    │
                              └────────┬────────┘
                                       │
                         ┌─────────────┼─────────────┐
                         │             │             │
                         ▼             │             ▼
                 ┌───────────────┐     │     ┌───────────────┐
                 │   Customer    │     │     │    PayFast    │
                 │    Portal     │     │     │    Gateway    │
                 │ (Frontend)    │     │     │               │
                 └───────┬───────┘     │     └───────┬───────┘
                         │             │             │
                         ▼             │             │
┌──────────────────────────────────────┼─────────────┼─────────────────────────┐
│                                      │             │                          │
│                     BBWS Payment Management       │                          │
│                                      │             │                          │
│   ┌────────────┐   ┌────────────┐   │   ┌────────▼────────┐                 │
│   │  Initiate  │   │   Status   │   │   │  ITN Webhook    │                 │
│   │    API     │   │    API     │   │   │    Handler      │                 │
│   └────────────┘   └────────────┘   │   └─────────────────┘                 │
│                                      │                                        │
└──────────────────────────────────────┼────────────────────────────────────────┘
                                       │
            ┌──────────────────────────┼──────────────────────────┐
            │                          │                          │
            ▼                          ▼                          ▼
    ┌───────────────┐          ┌───────────────┐          ┌───────────────┐
    │     Order     │          │    Email      │          │    Tenant     │
    │   Management  │          │   Service     │          │  Management   │
    │   (BRS 2.1.8) │          │    (SES)      │          │   (BRS 2.5)   │
    └───────────────┘          └───────────────┘          └───────────────┘
```

### 2.2 External Integrations

| System | Integration Type | Purpose |
|--------|------------------|---------|
| **PayFast** | HTTPS Redirect + Webhook | Payment processing |
| **Order Service** | Internal API | Get order details, update status |
| **Email Service (SES)** | AWS SDK | Send payment confirmations |
| **Tenant Service** | Internal Event | Trigger provisioning on payment |

---

## 3. Component Architecture

### 3.1 Payment Initiation Service

**Responsibility**: Generate PayFast payment URL and create payment record.

| Operation | Description | Output |
|-----------|-------------|--------|
| Initiate Payment | Create payment record, generate PayFast URL | Redirect URL |
| Calculate Signature | Generate MD5 signature for PayFast | Signature string |
| Validate Order | Verify order exists and is payable | Boolean |

### 3.2 ITN Webhook Handler

**Responsibility**: Process payment notifications from PayFast.

| Operation | Description | Validation |
|-----------|-------------|------------|
| Receive ITN | Accept POST from PayFast | Source IP check |
| Validate Signature | Verify MD5 signature | Cryptographic |
| Verify Amount | Confirm amount matches order | Exact match |
| Server Verification | Confirm with PayFast API | Server-to-server |
| Update Payment | Record payment result | Idempotent |
| Update Order | Set order to PAID | Conditional |
| Send Notification | Email customer | Async |

### 3.3 Payment Status Service

**Responsibility**: Provide payment status information.

| Operation | Description |
|-----------|-------------|
| Get Payment | Retrieve payment by ID |
| Get By Order | Find payment for order |
| List Payments | Payment history for customer |

---

## 4. Key Operations

### 4.1 Payment Initiation Flow

```
┌──────────┐   ┌────────────┐   ┌──────────┐   ┌───────────┐   ┌──────────┐
│ Customer │   │   Portal   │   │ Payment  │   │  Order    │   │ PayFast  │
│          │   │  Frontend  │   │  Service │   │  Service  │   │          │
└────┬─────┘   └─────┬──────┘   └────┬─────┘   └─────┬─────┘   └────┬─────┘
     │               │               │               │               │
     │  Click Pay    │               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ POST /payments│               │               │
     │               │──────────────>│               │               │
     │               │               │               │               │
     │               │               │ Get Order     │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ Order details │               │
     │               │               │<──────────────│               │
     │               │               │               │               │
     │               │               │ Create payment│               │
     │               │               │ record        │               │
     │               │               │               │               │
     │               │               │ Generate URL  │               │
     │               │               │ + signature   │               │
     │               │               │               │               │
     │               │ Payment URL   │               │               │
     │               │<──────────────│               │               │
     │               │               │               │               │
     │  Redirect     │               │               │               │
     │<──────────────│               │               │               │
     │               │               │               │               │
     │  Payment Page │               │               │               │
     │──────────────────────────────────────────────────────────────>│
     │               │               │               │               │
```

### 4.2 ITN Processing Flow

```
┌──────────┐   ┌──────────┐   ┌───────────┐   ┌──────────┐   ┌──────────┐
│ PayFast  │   │   ITN    │   │  Payment  │   │  Order   │   │  Email   │
│          │   │ Handler  │   │  Service  │   │ Service  │   │ Service  │
└────┬─────┘   └────┬─────┘   └─────┬─────┘   └────┬─────┘   └────┬─────┘
     │              │               │               │               │
     │ POST /webhook│               │               │               │
     │─────────────>│               │               │               │
     │              │               │               │               │
     │              │ Validate IP   │               │               │
     │              │──────────────>│               │               │
     │              │               │               │               │
     │              │ Validate sig  │               │               │
     │              │──────────────>│               │               │
     │              │               │               │               │
     │              │ Verify amount │               │               │
     │              │──────────────>│               │               │
     │              │               │               │               │
     │              │ Server verify │               │               │
     │<─────────────────────────────│               │               │
     │              │               │               │               │
     │ VALID        │               │               │               │
     │─────────────────────────────>│               │               │
     │              │               │               │               │
     │              │ Update payment│               │               │
     │              │──────────────>│               │               │
     │              │               │               │               │
     │              │               │ Update order  │               │
     │              │               │ to PAID       │               │
     │              │               │──────────────>│               │
     │              │               │               │               │
     │              │               │ Send email    │               │
     │              │               │──────────────────────────────>│
     │              │               │               │               │
     │ 200 OK       │               │               │               │
     │<─────────────│               │               │               │
```

---

## 5. Data Architecture

### 5.1 Payment Entity

| Attribute | Description |
|-----------|-------------|
| Payment ID | Unique identifier (UUID) |
| Order ID | Reference to order |
| Tenant ID | Customer tenant |
| Amount | Payment amount (cents) |
| Currency | ZAR |
| Status | PENDING, PROCESSING, COMPLETED, FAILED |
| PayFast Reference | pf_payment_id from PayFast |
| Payment Method | Card type or EFT |
| Error Message | Failure reason if applicable |
| ITN Data | Raw callback data for audit |
| Timestamps | Created, Updated |

### 5.2 Payment Status Flow

```
    ┌─────────────┐
    │   PENDING   │ ◄── Payment initiated
    └──────┬──────┘
           │
           │ ITN received
           ▼
    ┌─────────────┐
    │ PROCESSING  │ ◄── Being validated
    └──────┬──────┘
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
┌─────────┐  ┌─────────┐
│COMPLETED│  │ FAILED  │
└─────────┘  └─────────┘
     │
     │ (Future)
     ▼
┌─────────┐
│REFUNDED │
└─────────┘
```

---

## 5. API Endpoints

### 5.1 API Structure

**Base URL (PROD)**: `https://api.kimmyai.io`
**Base URL (SIT)**: `https://sit.api.kimmyai.io`
**Base URL (DEV)**: `https://dev.api.kimmyai.io`

> **Note**: API version (`/v1.0`) is included in each endpoint path, not the base URL.

### 5.2 HATEOAS Operations: Payment

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/payments` | Create a new payment (initiate PayFast transaction) |
| GET | `/v1.0/payments/{id}` | Get payment details by ID |
| GET | `/v1.0/payments` | List all payments (active only by default, use `?include_inactive=true` for all) |
| PUT | `/v1.0/payments/{id}` | Update payment details |
| PUT | `/v1.0/payments/{id}` | Soft delete payment (set active=false) |
| POST | `/v1.0/payments/webhook/itn` | PayFast ITN (Instant Transaction Notification) callback handler |
| GET | `/v1.0/payments/order/{orderId}` | Get payments by order ID |

#### 5.2.1 POST `/v1.0/payments` - Initiate Payment

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Request Body:**
```json
{
  "orderId": "ord_550e8400-e29b-41d4-a716-446655440000",
  "tenantId": "ten_660e8400-e29b-41d4-a716-446655440001",
  "amount": 29900,
  "currency": "ZAR",
  "returnUrl": "https://portal.kimmyai.io/payment/return",
  "cancelUrl": "https://portal.kimmyai.io/payment/cancel",
  "notifyUrl": "https://api.kimmyai.io/v1.0/payments/webhook/itn",
  "itemName": "WordPress Hosting - Starter Plan",
  "itemDescription": "Monthly subscription for WordPress hosting"
}
```

**Success Response (201 Created):**
```json
{
  "id": "pay_770e8400-e29b-41d4-a716-446655440002",
  "orderId": "ord_550e8400-e29b-41d4-a716-446655440000",
  "tenantId": "ten_660e8400-e29b-41d4-a716-446655440001",
  "amount": 29900,
  "currency": "ZAR",
  "status": "PENDING",
  "paymentUrl": "https://www.payfast.co.za/eng/process?cmd=_paynow&amount=299.00&merchant_id=10000100&merchant_key=46f0cd694581a&return_url=...",
  "payfastRef": null,
  "paymentMethod": null,
  "errorMessage": null,
  "itemName": "WordPress Hosting - Starter Plan",
  "itemDescription": "Monthly subscription for WordPress hosting",
  "dateCreated": "2026-01-08T10:30:00Z",
  "dateLastUpdated": "2026-01-08T10:30:00Z",
  "lastUpdatedBy": "customer@example.com",
  "active": true
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Invalid payment request",
  "details": [
    {
      "field": "orderId",
      "message": "Order not found or already paid"
    }
  ]
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Order with id 'ord_550e8400-e29b-41d4-a716-446655440000' not found"
}
```

#### 5.2.2 GET `/v1.0/payments/{id}` - Get Payment

**Request Headers:**
```json
{
  "Authorization": "Bearer <token>"
}
```

**Success Response (200 OK):**
```json
{
  "id": "pay_770e8400-e29b-41d4-a716-446655440002",
  "orderId": "ord_550e8400-e29b-41d4-a716-446655440000",
  "tenantId": "ten_660e8400-e29b-41d4-a716-446655440001",
  "amount": 29900,
  "currency": "ZAR",
  "status": "COMPLETED",
  "paymentUrl": "https://www.payfast.co.za/eng/process?cmd=_paynow&...",
  "payfastRef": "1234567890",
  "paymentMethod": "Credit Card",
  "errorMessage": null,
  "itemName": "WordPress Hosting - Starter Plan",
  "itemDescription": "Monthly subscription for WordPress hosting",
  "itnData": {
    "m_payment_id": "pay_770e8400-e29b-41d4-a716-446655440002",
    "pf_payment_id": "1234567890",
    "payment_status": "COMPLETE",
    "amount_gross": "299.00",
    "amount_fee": "8.97",
    "amount_net": "290.03"
  },
  "dateCreated": "2026-01-08T10:30:00Z",
  "dateLastUpdated": "2026-01-08T10:35:00Z",
  "lastUpdatedBy": "system",
  "active": true
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Payment with id 'pay_770e8400-e29b-41d4-a716-446655440002' not found"
}
```

#### 5.2.3 GET `/v1.0/payments` - List Payments

**Query Parameters:**
- `include_inactive` (boolean, optional): Include soft-deleted records. Default: `false`
- `pageSize` (integer, optional): Number of items to return per page. Default: `50`, Max: `100`
- `startAt` (string, optional): Pagination token to start at a specific position
- `tenantId` (string, optional): Filter by tenant ID
- `orderId` (string, optional): Filter by order ID
- `status` (string, optional): Filter by status (PENDING, PROCESSING, COMPLETED, FAILED, REFUNDED)

**Request Headers:**
```json
{
  "Authorization": "Bearer <token>"
}
```

**Success Response (200 OK):**
```json
{
  "items": [
    {
      "id": "pay_770e8400-e29b-41d4-a716-446655440002",
      "orderId": "ord_550e8400-e29b-41d4-a716-446655440000",
      "tenantId": "ten_660e8400-e29b-41d4-a716-446655440001",
      "amount": 29900,
      "currency": "ZAR",
      "status": "COMPLETED",
      "payfastRef": "1234567890",
      "paymentMethod": "Credit Card",
      "dateCreated": "2026-01-08T10:30:00Z",
      "dateLastUpdated": "2026-01-08T10:35:00Z",
      "lastUpdatedBy": "system",
      "active": true
    },
    {
      "id": "pay_880e8400-e29b-41d4-a716-446655440003",
      "orderId": "ord_990e8400-e29b-41d4-a716-446655440004",
      "tenantId": "ten_660e8400-e29b-41d4-a716-446655440001",
      "amount": 59900,
      "currency": "ZAR",
      "status": "PENDING",
      "payfastRef": null,
      "paymentMethod": null,
      "dateCreated": "2026-01-08T11:00:00Z",
      "dateLastUpdated": "2026-01-08T11:00:00Z",
      "lastUpdatedBy": "customer@example.com",
      "active": true
    }
  ],
  "startAt": "pay_880e8400-e29b-41d4-a716-446655440003",
  "moreAvailable": false
}
```

#### 5.2.4 PUT `/v1.0/payments/{id}` - Update Payment

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Request Body (Update Status):**
```json
{
  "status": "CANCELLED",
  "errorMessage": "Customer cancelled payment"
}
```

**Success Response (200 OK):**
```json
{
  "id": "pay_770e8400-e29b-41d4-a716-446655440002",
  "orderId": "ord_550e8400-e29b-41d4-a716-446655440000",
  "tenantId": "ten_660e8400-e29b-41d4-a716-446655440001",
  "amount": 29900,
  "currency": "ZAR",
  "status": "CANCELLED",
  "payfastRef": null,
  "paymentMethod": null,
  "errorMessage": "Customer cancelled payment",
  "dateCreated": "2026-01-08T10:30:00Z",
  "dateLastUpdated": "2026-01-08T11:15:00Z",
  "lastUpdatedBy": "admin@example.com",
  "active": true
}
```

#### 5.2.5 PUT `/v1.0/payments/{id}` - Soft Delete Payment

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Request Body (Soft Delete):**
```json
{
  "active": false
}
```

**Success Response (200 OK):**
```json
{
  "id": "pay_770e8400-e29b-41d4-a716-446655440002",
  "orderId": "ord_550e8400-e29b-41d4-a716-446655440000",
  "tenantId": "ten_660e8400-e29b-41d4-a716-446655440001",
  "amount": 29900,
  "currency": "ZAR",
  "status": "CANCELLED",
  "dateCreated": "2026-01-08T10:30:00Z",
  "dateLastUpdated": "2026-01-08T11:20:00Z",
  "lastUpdatedBy": "admin@example.com",
  "active": false
}
```

#### 5.2.6 POST `/v1.0/payments/webhook/itn` - PayFast ITN Webhook

**Description**: This endpoint receives Instant Transaction Notifications (ITN) from PayFast servers. It is called by PayFast, not by clients.

**Request Headers:**
```json
{
  "Content-Type": "application/x-www-form-urlencoded"
}
```

**Request Body (Form Data from PayFast):**
```
m_payment_id=pay_770e8400-e29b-41d4-a716-446655440002
pf_payment_id=1234567890
payment_status=COMPLETE
item_name=WordPress+Hosting+-+Starter+Plan
item_description=Monthly+subscription+for+WordPress+hosting
amount_gross=299.00
amount_fee=8.97
amount_net=290.03
custom_str1=ord_550e8400-e29b-41d4-a716-446655440000
custom_str2=ten_660e8400-e29b-41d4-a716-446655440001
name_first=John
name_last=Doe
email_address=customer@example.com
merchant_id=10000100
signature=af3a876a2e8c9fd4b6c7d8e9f0a1b2c3
```

**Success Response (200 OK):**
```json
{
  "status": "success",
  "message": "Payment notification processed successfully",
  "paymentId": "pay_770e8400-e29b-41d4-a716-446655440002",
  "paymentStatus": "COMPLETED"
}
```

**Error Response (400 Bad Request - Invalid Signature):**
```json
{
  "error": "InvalidSignature",
  "message": "Payment notification signature validation failed"
}
```

**Error Response (400 Bad Request - Amount Mismatch):**
```json
{
  "error": "AmountMismatch",
  "message": "Payment amount does not match order amount"
}
```

#### 5.2.7 GET `/v1.0/payments/order/{orderId}` - Get Payments by Order

**Request Headers:**
```json
{
  "Authorization": "Bearer <token>"
}
```

**Success Response (200 OK):**
```json
{
  "items": [
    {
      "id": "pay_770e8400-e29b-41d4-a716-446655440002",
      "orderId": "ord_550e8400-e29b-41d4-a716-446655440000",
      "tenantId": "ten_660e8400-e29b-41d4-a716-446655440001",
      "amount": 29900,
      "currency": "ZAR",
      "status": "COMPLETED",
      "payfastRef": "1234567890",
      "paymentMethod": "Credit Card",
      "dateCreated": "2026-01-08T10:30:00Z",
      "dateLastUpdated": "2026-01-08T10:35:00Z",
      "lastUpdatedBy": "system",
      "active": true
    }
  ],
  "startAt": "pay_770e8400-e29b-41d4-a716-446655440002",
  "moreAvailable": false
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "No payments found for order 'ord_550e8400-e29b-41d4-a716-446655440000'"
}
```

---

## 6. Authentication

### 6.1 Authentication Method

**Authentication Type**: AWS Cognito Bearer Token

All API endpoints (except ITN webhook) require authentication using JWT tokens issued by AWS Cognito.

**Protected Endpoints:**
- All `/v1.0/payments/*` endpoints require valid Cognito token
- Customer can only access their own tenant's payments
- Admin role can access all payments

**Unprotected Endpoints:**
- `/v1.0/payments/webhook/itn` - Called by PayFast servers (validated by signature and IP whitelist)

### 6.2 Protected Endpoints

| Endpoint Pattern | Auth Required | Roles |
|-----------------|---------------|-------|
| `POST /v1.0/payments` | Yes | Customer, Admin |
| `GET /v1.0/payments/{id}` | Yes | Customer (own tenant), Admin |
| `GET /v1.0/payments` | Yes | Customer (own tenant), Admin |
| `PUT /v1.0/payments/{id}` | Yes | Admin only |
| `POST /v1.0/payments/webhook/itn` | No (signature validation) | N/A |
| `GET /v1.0/payments/order/{orderId}` | Yes | Customer (own tenant), Admin |

---

## 7. DynamoDB Schema

### 7.1 Core Entity Rules

| Entity | Tenant Association | Rule |
|--------|-------------------|------|
| Payment | Required | Every payment must belong to a tenant |
| Order | Required | Every payment must reference an order |

### 7.2 Entities

> **Soft Delete Pattern**: All entities have an `active` boolean field (default=true). To delete, set `active=false`. Queries filter by `active=true` by default.

| Entity | PK | SK | Attributes |
|--------|----|----|------------|
| Payment | `PAYMENT#{id}` | `METADATA` | id, orderId, tenantId, amount, currency, status, payfastRef, paymentMethod, paymentUrl, errorMessage, itnData, itemName, itemDescription, dateCreated, dateLastUpdated, lastUpdatedBy, active |

### 7.3 GSIs

| GSI Name | PK | SK | Purpose |
|----------|----|----|---------|
| ActiveIndex | active | dateCreated | Filter by active status (sparse index, all payments) |
| TenantIndex | tenantId | dateCreated | List all payments for a tenant |
| OrderIndex | orderId | dateCreated | Find payments for a specific order |
| StatusIndex | status | dateCreated | Query payments by status (PENDING, COMPLETED, etc.) |

> **Query Pattern**: All list queries include `active=true` filter by default. Use `include_inactive=true` parameter to include soft-deleted records.

### 7.4 Entity Details

#### 7.4.1 Payment

| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| id | String (UUID) | Yes | Unique payment identifier (prefixed with `pay_`) |
| orderId | String (UUID) | Yes | Reference to the order being paid |
| tenantId | String (UUID) | Yes | Customer tenant identifier |
| amount | Integer | Yes | Payment amount in cents (e.g., 29900 = R299.00) |
| currency | String | Yes | Currency code (always "ZAR" for PayFast) |
| status | String | Yes | Payment status: PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED, REFUNDED |
| payfastRef | String | No | PayFast payment reference (pf_payment_id) |
| paymentMethod | String | No | Payment method used (Credit Card, EFT, etc.) |
| paymentUrl | String | No | Generated PayFast redirect URL |
| errorMessage | String | No | Error description if payment failed |
| itnData | Object | No | Raw ITN callback data from PayFast (for audit) |
| itemName | String | Yes | Product/service name displayed on PayFast |
| itemDescription | String | No | Product/service description |
| dateCreated | String (ISO 8601) | Yes | Creation timestamp |
| dateLastUpdated | String (ISO 8601) | Yes | Last update timestamp |
| lastUpdatedBy | String | Yes | Email or ID of user/system who last updated the payment |
| active | Boolean | Yes | Active status (default=true, false=soft deleted) |

---

## 8. Non-Functional Requirements

### 8.1 Performance

| Metric | Target | Rationale |
|--------|--------|-----------|
| Payment Initiation | < 500ms P95 | User experience |
| ITN Processing | < 1000ms P95 | PayFast timeout |
| URL Generation | < 200ms | Redirect delay |

### 8.2 Availability

| Metric | Target | Rationale |
|--------|--------|-----------|
| Payment API | 99.9% | Revenue critical |
| ITN Endpoint | 99.99% | Must not miss notifications |

### 8.3 Security

| Control | Implementation |
|---------|----------------|
| No Card Storage | Redirect model - PayFast handles |
| Signature Validation | MD5 with passphrase |
| IP Whitelist | PayFast server IPs only |
| Server Verification | Confirm ITN with PayFast API |
| Encryption | TLS 1.2+ all connections |

---

## 9. Security Architecture

### 9.1 PayFast Integration Security

```
┌─────────────────────────────────────────────────────────────────┐
│                     Security Controls                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   1. IP Whitelist Validation                                    │
│      ┌──────────────┐                                           │
│      │ PayFast IPs  │──────> Only accept from:                  │
│      │              │        197.97.145.144/28                  │
│      │              │        197.97.145.160/28                  │
│      │              │        41.74.179.192/27                   │
│      └──────────────┘                                           │
│                                                                  │
│   2. Signature Validation                                       │
│      ┌──────────────┐                                           │
│      │ MD5 Signature│──────> Calculated with passphrase         │
│      │              │        Exact parameter order               │
│      │              │        URL encoded values                  │
│      └──────────────┘                                           │
│                                                                  │
│   3. Amount Verification                                        │
│      ┌──────────────┐                                           │
│      │ Order Amount │──────> Must match ITN amount_gross        │
│      └──────────────┘                                           │
│                                                                  │
│   4. Server-to-Server Verification                              │
│      ┌──────────────┐                                           │
│      │ PayFast API  │──────> POST to /eng/query/validate        │
│      │              │        Response must be "VALID"           │
│      └──────────────┘                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 Credential Management

| Credential | Storage | Rotation |
|------------|---------|----------|
| Merchant ID | Secrets Manager | On compromise |
| Merchant Key | Secrets Manager | On compromise |
| Passphrase | Secrets Manager | Annual |

---

## 10. Technology Decisions

### 10.1 Technology Stack

| Component | Technology | Rationale |
|-----------|------------|-----------|
| **API Layer** | AWS Lambda + API Gateway | Serverless, auto-scaling |
| **Data Store** | DynamoDB | Fast, serverless |
| **Email** | Amazon SES | Reliable email delivery |
| **Secrets** | Secrets Manager | Secure credential storage |
| **Monitoring** | CloudWatch | Integrated logging/metrics |

### 10.2 Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Payment Gateway | PayFast | South African leader, ZAR native |
| Integration Model | Redirect | PCI DSS compliance, simplicity |
| Notification | ITN Webhook | Real-time, reliable |
| Data Model | Single table | Payment lifecycle is simple |

---

## 11. Error Handling

### 11.1 Error Scenarios

| Scenario | Handling |
|----------|----------|
| Order not found | 404, log warning |
| Order already paid | 400, return existing payment |
| Invalid signature | 400, log security alert |
| Amount mismatch | 400, log fraud alert |
| PayFast unavailable | Retry with backoff |
| Duplicate ITN | Return 200, no-op |

### 11.2 Retry Strategy

| Operation | Retries | Backoff |
|-----------|---------|---------|
| PayFast verification | 3 | Exponential |
| Email send | 3 | Fixed 1s |
| Order update | 3 | Exponential |

---

## 12. Monitoring

### 12.1 Key Metrics

| Metric | Alert Threshold |
|--------|-----------------|
| Payment Success Rate | < 95% |
| ITN Processing Time | > 2s P95 |
| Failed Payments | > 5/hour |
| Invalid Signature | Any |

### 12.2 Dashboards

| Dashboard | Content |
|-----------|---------|
| Payment Overview | Success rate, volume, revenue |
| Error Analysis | Failed payments by reason |
| Security | Invalid signatures, IP violations |

---

## 13. Repositories

### 13.1 Repository List

Following the naming convention: `[HLD_Prefix]_[project]_[service]_lambda`

| # | Repository | Type | Description |
|---|------------|------|-------------|
| 1 | `2_1_9_bbws_payment_lambda` | Backend | Payment service with PayFast integration (Python 3.12) |
| 2 | `2_1_bbws_dynamodb_schemas` | Database | Shared DynamoDB table schemas and GSIs |
| 3 | `2_1_bbws_operations` | Operations | CloudWatch dashboards, alarms, budgets, WAF rules |

### 13.2 Repository Structure

```
2_1_9_bbws_payment_lambda/
├── src/
│   ├── handlers/
│   │   ├── create_payment.py
│   │   ├── get_payment.py
│   │   ├── list_payments.py
│   │   ├── update_payment.py
│   │   ├── itn_webhook.py
│   │   └── get_payments_by_order.py
│   ├── services/
│   │   ├── payfast_service.py
│   │   └── payment_service.py
│   ├── models/
│   │   └── payment.py
│   └── utils/
│       ├── signature_validator.py
│       └── response_builder.py
├── tests/
│   ├── unit/
│   └── integration/
├── terraform/
│   ├── main.tf
│   ├── api_gateway.tf
│   ├── lambda.tf
│   ├── iam.tf
│   ├── cloudfront.tf
│   ├── variables.tf
│   └── outputs.tf
├── requirements.txt
├── pytest.ini
└── README.md
```

---

## 14. Business Approval Requirements

### 14.1 Artefacts Requiring Business Approval

The following artefacts **MUST** have Business Owner (BO) approval before deployment:

| Category | Artefacts | Approval Required |
|----------|-----------|-------------------|
| **Email Templates** | Payment confirmation email, payment failed email | BO Sign-off |
| **Customer Messaging** | Payment error messages, success messages, email content | BO Sign-off |
| **Payment Flow** | Payment initiation flow, redirect behavior, return handling | BO Sign-off |

### 14.2 Business Approval Process

```
┌─────────────────────────────────────────────────────────────────┐
│              BUSINESS APPROVAL PROCESS                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. DEVELOPMENT                                                 │
│     └── Dev team completes payment integration                 │
│                                                                 │
│  2. DEV REVIEW                                                  │
│     └── Technical review (security, error handling)            │
│                                                                 │
│  3. STAGING DEPLOYMENT                                          │
│     └── Deploy to SIT for business review                      │
│                                                                 │
│  4. BUSINESS OWNER REVIEW                                       │
│     ├── BO reviews payment flow in SIT (sandbox mode)          │
│     ├── BO tests email notifications                           │
│     ├── BO provides feedback or approval                       │
│     └── Iterate until BO sign-off obtained                     │
│                                                                 │
│  5. PRODUCTION DEPLOYMENT                                       │
│     └── Only after BO sign-off documented                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 15. Implementation Plan

### 15.1 Development Approach

**Backend-First Approach**: Payment integration requires backend implementation first due to security and PayFast integration requirements.

### 15.2 Milestones (with Business Owner Gates)

> **IMPORTANT**: Each milestone requires **Business Owner (BO) Review** before proceeding to the next milestone. No milestone is considered complete without documented BO sign-off.

| # | Milestone | Deliverables | Tech Review | BO Review |
|---|-----------|--------------|-------------|-----------|
| 0.1 | DynamoDB Schema | Payment table schema + GSIs | Dev Review | **BO Sign-off Required** |
| 0.2 | Payment Initiation | Create payment, generate PayFast URL | Dev Review | **BO Sign-off Required** |
| 0.3 | ITN Webhook Handler | Process PayFast callbacks, validation | Dev Review | **BO Sign-off Required** |
| 0.4 | Payment Status API | Get/list payment endpoints | Dev Review | **BO Sign-off Required** |
| 0.5 | Email Notifications | Payment confirmation emails | Dev Review | **BO Sign-off Required** |
| 0.6 | Integration Testing | Full flow testing with PayFast sandbox | QA Review | **BO Approval Required** |
| 0.7 | UAT | User Acceptance Testing in SIT | QA Review | **BO Final Approval** |
| 0.8 | Production | Live deployment with PayFast production credentials | Tech Lead | **BO Go-Live Approval** |

---

## 16. LLDs Reference

### 16.1 Parent HLD Information

| Attribute | Value |
|-----------|-------|
| HLD Document | `2.1.9_HLD_Payment_Management.md` |
| HLD Version | v1.0 |
| HLD Prefix | `2.1.9` |
| Total LLDs | 1 technical + 2 operational |

### 16.2 Technical LLDs

Following the naming convention: `[HLD_Prefix]_LLD_[Name].md`

| LLD ID | LLD Name | Description | Repository | Status |
|--------|----------|-------------|------------|--------|
| 2.1.9 | `2.1.9_LLD_Payment_Lambda.md` | Payment service implementation with PayFast integration | `2_1_9_bbws_payment_lambda` | Exists |

### 16.3 Operational Runbooks

Following the naming convention: `[HLD_Prefix]_OPS_[Name].md`

| OPS ID | Runbook Name | Description | Status |
|--------|--------------|-------------|--------|
| 2.1.9.1 | `2.1.9_OPS_Payment_Monitoring.md` | CloudWatch dashboards, alarms for payment failures | Draft |
| 2.1.9.2 | `2.1.9_OPS_PayFast_Integration_Troubleshooting.md` | Troubleshooting ITN issues, signature failures | Draft |

---

## 17. References

| Document | Path |
|----------|------|
| BRS 2.1.9: Payment Management | `BRS/2.1.9_BRS_Payment_Management.md` |
| LLD 2.1.9: Payment Lambda | `LLDs/2.1.9_LLD_Payment_Lambda.md` |
| HLD 2.1: Customer Portal Public | `HLDs/2.1_BBWS_Customer_Portal_Public_HLD_V1.1.md` |
| PayFast Developer Docs | https://developers.payfast.co.za/ |

---

**End of Document**
