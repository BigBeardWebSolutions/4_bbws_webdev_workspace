# HLD 2.7: WordPress Instance Management

## High-Level Design Document

**Version**: 1.1
**Author**: Platform Architecture Team
**Date**: 2026-02-17
**Status**: Draft

---

## Document History

| Version | Date | Changes | Owner |
|---------|------|---------|-------|
| 1.0 | 2026-01-05 | Initial HLD extracted from BRS 2.7 restructure | Platform Architecture |
| 1.1 | 2026-02-17 | HLD remediation: removed API specs (moved to OpenAPI), added Platform Services and Related Repositories, added cross-reference to Organization Management (2.5.2) | Platform Architecture |

---

## Executive Summary

### Purpose

This document provides the architectural design for the WordPress Instance Management capability of the BBWS platform. It describes how the platform provisions, manages, and decommissions dedicated WordPress environments for each customer organisation.

### Scope

This HLD defines the architectural boundaries and design for:
- Per-tenant environment provisioning (compute, storage, database, identity resources)
- Environment lifecycle state management (suspend, resume, scale, update)
- Per-tenant authentication resource provisioning via Cognito
- Resource decommissioning and clean-up orchestration
- Rollback and failure recovery patterns

> **Note:** Organisation hierarchy context is provided by [HLD 2.5.2: Organization Management](../../2_bbws_organization_management/docs/hld/2.5.2_HLD_Organization_Management.md). For detailed API specifications, see `docs/openapi/`. For implementation details, see `docs/lld/`.

### Relationship to Other Documents

| Document | Relationship |
|----------|--------------|
| **BRS 2.7** | Business requirements this architecture implements |
| **LLD 2.7** | Detailed implementation specifications |
| **HLD 2.6** | Site Management - operates within environments this creates |
| **HLD 2.5** | Tenant Management - creates logical tenant, triggers provisioning |
| **HLD 2.5.2** | Organization Management - org hierarchy context |
| **HLD 2.0** | Platform architecture - shared infrastructure foundation |

---

## 1. Architecture Overview

### 1.1 Design Philosophy

The WordPress Instance Management architecture follows these principles:

| Principle | Implementation |
|-----------|----------------|
| **Shared Infrastructure, Isolated Resources** | Common platform, dedicated per-tenant resources |
| **Automation First** | Zero manual intervention for standard operations |
| **Rollback by Default** | All provisioning steps are reversible |
| **State Machine Driven** | Explicit states prevent partial/stuck operations |

### 1.2 High-Level Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BBWS Platform Infrastructure                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                    Instance Management Service                        │   │
│  │                                                                       │   │
│  │   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    │   │
│  │   │ Provision  │  │ Lifecycle  │  │  Identity  │  │Deprovision │    │   │
│  │   │  Service   │  │  Service   │  │  Service   │  │  Service   │    │   │
│  │   └──────┬─────┘  └──────┬─────┘  └──────┬─────┘  └──────┬─────┘    │   │
│  │          │               │               │               │           │   │
│  └──────────┼───────────────┼───────────────┼───────────────┼───────────┘   │
│             │               │               │               │               │
│             └───────────────┼───────────────┼───────────────┘               │
│                             │               │                                │
│                    ┌────────▼───────────────▼────────┐                      │
│                    │      Resource Orchestrator       │                      │
│                    └────────────────┬─────────────────┘                      │
│                                     │                                        │
├─────────────────────────────────────┼────────────────────────────────────────┤
│                                     │                                        │
│    ┌────────────────────────────────┼────────────────────────────────────┐  │
│    │                                │                                     │  │
│    ▼                                ▼                                     ▼  │
│  ┌─────────────┐              ┌─────────────┐                    ┌──────────┐│
│  │   Compute   │              │   Storage   │                    │ Identity ││
│  │  (Fargate)  │              │ (EFS + RDS) │                    │(Cognito) ││
│  └──────┬──────┘              └──────┬──────┘                    └────┬─────┘│
│         │                            │                                │      │
│         └────────────────────────────┼────────────────────────────────┘      │
│                                      │                                        │
│                             ┌────────▼────────┐                              │
│                             │    Networking   │                              │
│                             │   (ALB + VPC)   │                              │
│                             └─────────────────┘                              │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 Resource Allocation Model

Each customer environment receives dedicated resources within shared infrastructure:

| Resource Type | Allocation | Isolation Mechanism |
|---------------|------------|---------------------|
| **Compute** | Dedicated ECS Task(s) | Fargate microVM isolation |
| **Persistent Storage** | Dedicated EFS Access Point | IAM + directory isolation |
| **Database** | Dedicated MySQL database | Separate credentials, schema isolation |
| **Network Routing** | Dedicated ALB Target Group | Path-based routing rules |
| **Identity** | Dedicated Cognito User Pool | Complete tenant separation |

---

## 2. System Context

### 2.1 Context Diagram

```
                              ┌─────────────────┐
                              │    Platform     │
                              │    Operator     │
                              └────────┬────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│                    BBWS WordPress Instance Management                     │
│                                                                           │
│   ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐     │
│   │ Provision  │   │ Lifecycle  │   │  Identity  │   │Deprovision │     │
│   │  Service   │   │  Service   │   │  Service   │   │  Service   │     │
│   └────────────┘   └────────────┘   └────────────┘   └────────────┘     │
│                                                                           │
└───────────────────────────────────┬───────────────────────────────────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
            ▼                       ▼                       ▼
    ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
    │    Tenant     │      │     Site      │      │    Shared     │
    │  Management   │      │  Management   │      │Infrastructure │
    │   (HLD 2.5)   │      │   (HLD 2.6)   │      │   (HLD 2.0)   │
    └───────────────┘      └───────────────┘      └───────────────┘
```

### 2.2 System Boundaries

| Boundary | Responsibility |
|----------|----------------|
| **Tenant Management (Upstream)** | Creates logical tenant record; triggers provisioning |
| **Instance Management (This)** | Creates physical AWS resources for tenant |
| **Site Management (Downstream)** | Operates within provisioned environment |
| **Shared Infrastructure** | Provides VPC, ECS cluster, RDS instance, EFS filesystem |

---

## 3. Component Architecture

### 3.1 Provision Service

**Responsibility**: Orchestrate creation of all resources for a new customer environment.

| Resource | Creation Order | Rollback Order |
|----------|---------------|----------------|
| EFS Access Point | 1st | 6th (last) |
| MySQL Database + User | 2nd | 5th |
| Secrets Manager Secret | 3rd | 4th |
| ECS Task Definition | 4th | 3rd |
| ECS Service | 5th | 2nd |
| ALB Target Group + Rule | 6th | 1st (first) |

### 3.2 Lifecycle Service

**Responsibility**: Manage environment state transitions.

| Operation | From State | To State | Resources Affected |
|-----------|------------|----------|-------------------|
| **Suspend** | ACTIVE | SUSPENDED | ECS (scale to 0), ALB (optional remove rule) |
| **Resume** | SUSPENDED | ACTIVE | ECS (scale to desired), ALB (restore rule) |
| **Scale Up** | ACTIVE | ACTIVE | ECS (increase task count or resources) |
| **Scale Down** | ACTIVE | ACTIVE | ECS (decrease task count or resources) |
| **Update** | ACTIVE | ACTIVE | ECS (rolling deployment of new image) |

### 3.3 Identity Service

**Responsibility**: Provision and configure per-tenant authentication.

| Component | Purpose |
|-----------|---------|
| **Cognito User Pool** | Tenant-specific user directory |
| **App Client** | OAuth client for WordPress integration |
| **Domain** | Unique hosted domain for login |
| **Groups** | Role-based access (Admin, Editor, Viewer) |
| **WordPress Plugin Config** | SSO configuration in WordPress |

### 3.4 Deprovision Service

**Responsibility**: Complete removal of all tenant resources.

| Resource | Deprovisioning Step | Data Handling |
|----------|---------------------|---------------|
| ALB Rule | Remove routing | N/A |
| ALB Target Group | Delete | N/A |
| ECS Service | Scale to 0, delete | N/A |
| Cognito User Pool | Delete | User data lost |
| Secrets Manager | Delete | N/A |
| MySQL Database | Archive snapshot, drop | Data archived |
| EFS Access Point | Delete | Content archived to S3 |

---

## 4. State Management

### 4.1 Environment States

```
                   PENDING_PROVISIONING
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           │               ▼               │
           │          PROVISIONING         │
           │               │               │
           ▼               │               ▼
        FAILED ◄───────────┼──────────► ACTIVE
           │               │               │
           │               │       ┌───────┴───────┐
           │               │       │               │
           │               │       ▼               ▼
           │               │   SUSPENDED     PENDING_DEPRO
           │               │       │               │
           │               │       │               ▼
           │               │       │         DEPROVISIONED
           │               │       │
           │               │       │
           └───────────────┴───────┴───────────────┘
                           │
                           ▼
                    (Rollback/Cleanup)
```

### 4.2 State Transition Rules

| From State | To State | Trigger | Validation |
|------------|----------|---------|------------|
| PENDING_PROVISIONING | PROVISIONING | API call | Tenant exists, not already provisioned |
| PROVISIONING | ACTIVE | All resources created | Health checks passing |
| PROVISIONING | FAILED | Any step fails | Rollback initiated |
| ACTIVE | SUSPENDED | Suspend API call | Tenant is active |
| SUSPENDED | ACTIVE | Resume API call | Tenant is suspended |
| ACTIVE | PENDING_DEPRO | Deprovision API call | Tenant is active |
| SUSPENDED | PENDING_DEPRO | Deprovision API call | Tenant is suspended |
| PENDING_DEPRO | DEPROVISIONED | All resources removed | Verification complete |

---

## 5. Non-Functional Requirements

### 5.1 Performance

| Metric | Target | Rationale |
|--------|--------|-----------|
| Provisioning Time | < 15 minutes | Customer SLA |
| Suspension Time | < 2 minutes | Quick response to non-payment |
| Resumption Time | < 5 minutes | Customer experience |
| Offboarding Time | < 10 minutes | Clean exit |
| API Response Time | < 500ms | Operator experience |

### 5.2 Availability

| Metric | Target | Rationale |
|--------|--------|-----------|
| Instance Availability | 99.9% per tenant | Customer SLA |
| API Availability | 99.9% | Operations continuity |
| Provisioning Success Rate | > 99% | Customer experience |

### 5.3 Scalability

| Dimension | Target | Approach |
|-----------|--------|----------|
| Total Tenants | 100 initial, 1000+ at scale | Horizontal resource allocation |
| Concurrent Provisioning | 10 tenants | Queue-based throttling |
| Tasks per Tenant | 2-10 (auto-scaling) | ECS auto-scaling policies |

### 5.4 Reliability

| Requirement | Implementation |
|-------------|----------------|
| Rollback on Failure | Automatic cleanup of partial provisioning |
| Orphan Detection | Daily scan for untracked resources |
| Data Archival | Database and storage archived before deletion |
| Retry Handling | Exponential backoff for transient failures |

---

## 6. Security Architecture

### 6.1 Tenant Isolation

| Layer | Isolation Mechanism |
|-------|---------------------|
| **Compute** | Fargate microVM per task |
| **Storage** | EFS access points with IAM |
| **Database** | Separate database per tenant |
| **Network** | Security groups, no cross-tenant access |
| **Identity** | Dedicated Cognito User Pool |

### 6.2 Credential Management

| Credential | Storage | Rotation |
|------------|---------|----------|
| Database passwords | Secrets Manager | Automatic (30 days) |
| Cognito client secrets | Secrets Manager | Manual |
| WordPress admin | Secrets Manager | On request |

### 6.3 Network Security

| Control | Implementation |
|---------|----------------|
| VPC | Private subnets for all compute |
| Security Groups | Least-privilege per tier |
| ALB | Internal only, no public access |
| Encryption | TLS 1.2+ for all connections |

---

## 7. Technology Decisions

### 7.1 Technology Stack

| Component | Technology | Rationale |
|-----------|------------|-----------|
| **Orchestration** | AWS Lambda + Step Functions | Serverless, state machine support |
| **Compute** | ECS Fargate | Serverless containers, no EC2 management |
| **Storage** | EFS | Shared filesystem for WordPress |
| **Database** | RDS MySQL | Managed, automated backups |
| **Identity** | Cognito | Managed user pools, OAuth support |
| **Routing** | ALB | Path-based routing, health checks |
| **State Store** | DynamoDB | Serverless, fast lookups |

### 7.2 Key Architecture Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Compute Isolation | ECS Fargate | MicroVM isolation without EC2 overhead |
| Database Isolation | Database per tenant | Schema isolation, easier backup/restore |
| Storage Isolation | EFS Access Points | Directory isolation with IAM |
| Identity Isolation | User Pool per tenant | Complete authentication separation |
| Provisioning Pattern | Step Functions | Explicit state management, rollback |

---

## 8. Constraints

| Constraint | Impact | Mitigation |
|------------|--------|------------|
| Fargate Platform Version | Must use 1.4.0+ for EFS | Explicit platform version in task definition |
| ALB Listener Rules | Max 100 per listener | Multiple listeners or ALBs at scale |
| Cognito User Pools | 60 per account default | Request limit increase proactively |
| RDS Connections | Connection pooling needed | PgBouncer or application-level pooling |
| EFS Throughput | Burst model, may hit limits | Monitor, consider provisioned throughput |

---

## 9. Platform Services

| Service | HLD | Repo | Description |
|---------|-----|------|-------------|
| Tenant Management | 2.5 | `2_bbws_tenant_management` | Tenant lifecycle and metadata |
| User Management | 2.5.1 | `2_bbws_user_management` | User profiles, directory, roles |
| Organization Management | 2.5.2 | `2_bbws_organization_management` | Org hierarchy (Division > Group > Team) |
| Site Management | 2.6 | `2_bbws_site_management` | WordPress site lifecycle |
| Instance Management | 2.7 | `2_bbws_instance_management` | Environment provisioning |
| Auth Management | 2.1.2 | `2_bbws_auth_management` | Registration, login, sessions |

---

## 10. Related Repositories

| Repository | Purpose |
|------------|---------|
| `2_bbws_tenant_management` | Tenant lifecycle service |
| `2_bbws_user_management` | User profile and role service |
| `2_bbws_organization_management` | Organization hierarchy service |
| `2_bbws_site_management` | WordPress site management service |
| `2_bbws_instance_management` | Environment provisioning service |
| `2_bbws_auth_management` | Authentication service |
| `2_bbws_ecs_terraform` | Shared ECS infrastructure as code |
| `2_bbws_ecs_operations` | Dashboards, alerts, runbooks |
| `2_bbws_wordpress_container` | WordPress Docker image |
| `2_bbws_agents` | AI agents and utilities |
| `2_bbws_docs` | Central documentation |

---

## 11. References

| Document | Path |
|----------|------|
| BRS 2.7: WordPress Instance Management | `BRS/2.7_BRS_WordPress_Instance_Management.md` |
| LLD 2.7: WordPress Instance Management | `LLDs/2.7_LLD_WordPress_Instance_Management.md` |
| HLD 2.0: BBWS ECS WordPress | `HLDs/2.0_BBWS_ECS_WordPress_HLD.md` |
| HLD 2.6: WordPress Site Management | `HLDs/2.6_HLD_WordPress_Site_Management.md` |
| HLD 2.5.2: Organization Management | `HLDs/2.5.2_HLD_Organization_Management.md` |
| Instance API OpenAPI Spec | `docs/openapi/instance_api_openapi.yaml` |

---

**End of Document**
