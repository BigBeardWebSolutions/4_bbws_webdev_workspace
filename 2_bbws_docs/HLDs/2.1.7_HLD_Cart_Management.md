# HLD 2.1.7: Cart Management

**Version**: 1.0
**Document ID**: HLD-2.1.7
**Created**: 2026-01-06
**Last Updated**: 2026-01-06
**Status**: Draft
**Author**: Platform Architecture Team
**Parent BRS**: [BRS 2.1.7 Cart Management](../BRS/2.1.7_BRS_Cart_Management.md)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-06 | Platform Architecture | Initial version |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [Architecture Overview](#2-architecture-overview)
3. [Component Architecture](#3-component-architecture)
4. [Integration Architecture](#4-integration-architecture)
5. [Data Architecture](#5-data-architecture)
6. [Security Architecture](#6-security-architecture)
7. [Non-Functional Requirements](#7-non-functional-requirements)
8. [Deployment Architecture](#8-deployment-architecture)
9. [References](#9-references)

---

## 1. Introduction

### 1.1 Purpose

This High-Level Design document describes the architecture for the Cart Management capability within the BBWS Customer Portal. It defines how shopping carts are created, managed, and prepared for checkout.

### 1.2 Scope

This document covers:
- Anonymous (guest) cart management
- Registered customer cart management
- Cart merge on login
- Cart persistence and expiry
- Integration with product catalog

### 1.3 Design Principles

| Principle | Application |
|-----------|-------------|
| **Zero Friction** | No registration required to start shopping |
| **Persistence** | Cart survives browser close and returns |
| **Seamless Merge** | Guest to registered transition preserves cart |
| **Real-time** | Immediate feedback on all cart operations |
| **Tenant Isolation** | Registered carts partitioned by tenant |

---

## 2. Architecture Overview

### 2.1 Solution Context

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Customer Portal                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────────────┐  │
│  │ Product  │───>│   CART   │───>│  Order   │───>│     Payment      │  │
│  │   Mgmt   │    │   MGMT   │    │   Mgmt   │    │                  │  │
│  │ (2.1.4)  │    │ (2.1.7)  │    │ (2.1.8)  │    │     (2.1.9)      │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────────────┘  │
│                       │                                                  │
│         ┌─────────────┴─────────────┐                                   │
│         ▼                           ▼                                   │
│  ┌─────────────────┐      ┌─────────────────┐                          │
│  │   Guest Cart    │      │  Tenant Cart    │                          │
│  │   (Cookie ID)   │─────>│  (Account ID)   │                          │
│  │                 │ merge│                 │                          │
│  │  30-day expiry  │      │   No expiry     │                          │
│  └─────────────────┘      └─────────────────┘                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Cart Types

| Cart Type | Identifier | Expiry | Use Case |
|-----------|------------|--------|----------|
| **Guest (Unregistered)** | UUID in cookie | 30 days | Anonymous visitors |
| **Tenant (Registered)** | Tenant ID | Never | Logged-in customers |

### 2.3 Key Architecture Decisions

| Decision | Rationale |
|----------|-----------|
| **Cookie-based Guest Cart** | Works without registration, persists across sessions |
| **Single-Table DynamoDB** | Efficient access patterns for both cart types |
| **Price at Add Time** | Customer sees price they expect at checkout |
| **Automatic Cart Merge** | Zero friction when visitor becomes customer |
| **Soft Delete Pattern** | Items marked inactive, not physically deleted |

---

## 3. Component Architecture

### 3.1 Component Overview

| Component | Type | Purpose |
|-----------|------|---------|
| **Cart API** | Lambda (API Gateway) | Handles REST endpoints for carts |
| **Cart Service** | Lambda Layer | Business logic for cart operations |
| **Product Service** | Lambda Layer | Validates products and fetches prices |
| **Cart Repository** | Lambda Layer | DynamoDB data access |
| **Carts Table** | DynamoDB | Stores cart and item data |

### 3.2 API Endpoints

**Guest Cart Endpoints:**

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/v1.0/cart/{cartId}` | Get guest cart |
| POST | `/v1.0/cart/{cartId}/items` | Add item to guest cart |
| PUT | `/v1.0/cart/{cartId}/items/{itemId}` | Update cart item |
| PUT | `/v1.0/cart/{cartId}` | Update cart (clear) |

**Tenant Cart Endpoints:**

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/v1.0/tenants/{tenantId}/cart` | Get tenant cart |
| POST | `/v1.0/tenants/{tenantId}/cart/items` | Add item to tenant cart |
| PUT | `/v1.0/tenants/{tenantId}/cart/items/{itemId}` | Update tenant cart item |
| PUT | `/v1.0/tenants/{tenantId}/cart` | Update tenant cart |

**Merge Endpoint:**

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/cart/merge` | Merge guest cart into tenant cart |

### 3.3 Guest Cart Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         Guest Cart Flow                                   │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   Browser                    API Gateway                Cart Lambda       │
│      │                           │                          │             │
│      │  Visit website            │                          │             │
│      │  (no cart cookie)         │                          │             │
│      │                           │                          │             │
│      │  Click "Add to Cart"      │                          │             │
│      │──────────────────────────>│                          │             │
│      │                           │                          │             │
│      │                           │  Generate cartId (UUID)  │             │
│      │                           │  Set-Cookie: cartId=xxx  │             │
│      │                           │─────────────────────────>│             │
│      │                           │                          │             │
│      │                           │                   Create cart in       │
│      │                           │                   DynamoDB              │
│      │                           │                   (type=UNREGISTERED)   │
│      │                           │                          │             │
│      │                           │                   Add item             │
│      │                           │<─────────────────────────│             │
│      │                           │                          │             │
│      │  Response + Set-Cookie    │                          │             │
│      │<──────────────────────────│                          │             │
│      │                           │                          │             │
│      │  Subsequent requests      │                          │             │
│      │  include cartId cookie    │                          │             │
│      │──────────────────────────>│                          │             │
│      │                           │                          │             │
└──────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Cart Merge Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         Cart Merge on Login                               │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   Before Login:                                                           │
│   ┌─────────────────────────┐     ┌─────────────────────────┐            │
│   │     Guest Cart          │     │     Tenant Cart         │            │
│   │     (from cookie)       │     │     (in account)        │            │
│   ├─────────────────────────┤     ├─────────────────────────┤            │
│   │ Product A (qty: 2)      │     │ Product B (qty: 1)      │            │
│   │ Product C (qty: 1)      │     │ Product A (qty: 1)      │            │
│   └─────────────────────────┘     └─────────────────────────┘            │
│                                                                           │
│   After Login + Merge:                                                    │
│   ┌─────────────────────────┐     ┌─────────────────────────┐            │
│   │     Guest Cart          │     │     Tenant Cart         │            │
│   │     (deactivated)       │     │     (merged)            │            │
│   ├─────────────────────────┤     ├─────────────────────────┤            │
│   │ active: false           │     │ Product A (qty: 3) ←────│── Combined │
│   │                         │     │ Product B (qty: 1)      │            │
│   │                         │     │ Product C (qty: 1) ←────│── Added    │
│   └─────────────────────────┘     └─────────────────────────┘            │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Integration Architecture

### 4.1 Upstream Integration: Product Management

| Aspect | Detail |
|--------|--------|
| **Trigger** | Customer clicks "Add to Cart" on product |
| **Validation** | Product exists, is active, and available |
| **Data Captured** | Product ID, name, price at time of add |
| **Price Handling** | Stored at add time; validated at checkout |

### 4.2 Downstream Integration: Order Management

| Aspect | Detail |
|--------|--------|
| **Trigger** | Customer clicks "Checkout" |
| **Data Passed** | Cart ID, all active items |
| **Validation** | Products still available, prices validated |
| **Cart Cleanup** | Cart marked inactive after order created |

### 4.3 Auth Integration: Login/Merge

| Aspect | Detail |
|--------|--------|
| **Trigger** | Successful login with guest cart present |
| **Process** | POST `/v1.0/cart/merge` with both cart IDs |
| **Result** | Guest items added to tenant cart |
| **Cleanup** | Guest cart deactivated |

---

## 5. Data Architecture

### 5.1 DynamoDB Single-Table Design

| Access Pattern | Key Structure | Index |
|----------------|---------------|-------|
| Get guest cart | PK=`CART#{cartId}`, SK=`METADATA` | Base table |
| Get cart items | PK=`CART#{cartId}`, SK begins_with `ITEM#` | Base table |
| Get tenant cart | Query TenantIndex by tenantId | GSI |
| List expired carts | GSI on expiresAt (for cleanup) | GSI |

### 5.2 Entity Structure

**Cart Entity:**
```
PK: CART#{cartId} or TENANT#{tenantId}#CART#{cartId}
SK: METADATA
Attributes:
  - cartId: UUID
  - tenantId: (optional for registered)
  - type: UNREGISTERED | REGISTERED
  - totalAmount: Decimal
  - active: Boolean
  - createdAt: ISO 8601
  - updatedAt: ISO 8601
  - expiresAt: ISO 8601 (guest only, 30 days)
```

**CartItem Entity:**
```
PK: CART#{cartId}
SK: ITEM#{itemId}
Attributes:
  - itemId: UUID
  - productId: String
  - productName: String (denormalized)
  - quantity: Number (1-99)
  - unitPrice: Decimal (captured at add time)
  - active: Boolean
```

### 5.3 Cart Lifecycle

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         Cart State Transitions                            │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                              ┌─────────────┐                              │
│                              │   CREATED   │                              │
│                              └──────┬──────┘                              │
│                                     │                                     │
│                                     │ Add first item                      │
│                                     ▼                                     │
│                              ┌─────────────┐                              │
│                              │   ACTIVE    │◄────────┐                    │
│                              └──────┬──────┘         │                    │
│                                     │                │ Add/Update items   │
│                    ┌────────────────┼────────────────┘                    │
│                    │                │                                     │
│                    │                │                                     │
│           ┌────────▼────────┐  ┌────▼─────┐  ┌──────────────┐            │
│           │   CONVERTED     │  │ CLEARED  │  │   EXPIRED    │            │
│           │  (to Order)     │  │          │  │ (30 days)    │            │
│           └─────────────────┘  └──────────┘  └──────────────┘            │
│                    │                │               │                     │
│                    ▼                ▼               ▼                     │
│           ┌─────────────────────────────────────────────────┐            │
│           │                    INACTIVE                      │            │
│           │                 (active=false)                   │            │
│           └─────────────────────────────────────────────────┘            │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Security Architecture

### 6.1 Authentication and Authorization

| Cart Type | Authentication | Authorization |
|-----------|----------------|---------------|
| **Guest Cart** | None (cookie-based) | CartId must match cookie |
| **Tenant Cart** | Cognito JWT required | TenantId in JWT must match |

### 6.2 Cart Access Control

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         Cart Access Rules                                 │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   Guest Cart:                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  Browser Cookie: cartId=abc123                                   │    │
│   │                                                                  │    │
│   │  Request: GET /v1.0/cart/abc123                                  │    │
│   │  Validation: Cookie cartId == Path cartId                        │    │
│   │  Result: ✅ Access granted                                       │    │
│   │                                                                  │    │
│   │  Request: GET /v1.0/cart/xyz789 (different ID)                   │    │
│   │  Validation: Cookie cartId != Path cartId                        │    │
│   │  Result: ❌ 403 Forbidden                                        │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│   Tenant Cart:                                                            │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  JWT Token: { sub: "user@example.com", tenant_id: "tenant123" }  │    │
│   │                                                                  │    │
│   │  Request: GET /v1.0/tenants/tenant123/cart                       │    │
│   │  Validation: JWT tenant_id == Path tenantId                      │    │
│   │  Result: ✅ Access granted                                       │    │
│   │                                                                  │    │
│   │  Request: GET /v1.0/tenants/tenant456/cart (different tenant)    │    │
│   │  Validation: JWT tenant_id != Path tenantId                      │    │
│   │  Result: ❌ 403 Forbidden                                        │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

### 6.3 Data Protection

| Data | Protection |
|------|------------|
| **Cart Data** | Encrypted at rest (DynamoDB default) |
| **Cart Cookie** | HttpOnly, Secure, SameSite=Strict |
| **In Transit** | TLS 1.2+ for all communications |

---

## 7. Non-Functional Requirements

### 7.1 Performance

| Metric | Target |
|--------|--------|
| Get Cart | < 200ms |
| Add Item | < 500ms |
| Update Item | < 300ms |
| Cart Merge | < 1 second |

### 7.2 Scalability

| Component | Scaling Strategy |
|-----------|------------------|
| **API Lambda** | Auto-scales with API Gateway |
| **DynamoDB** | On-demand capacity mode |
| **Concurrent Carts** | Virtually unlimited |

### 7.3 Availability

| Metric | Target |
|--------|--------|
| API Availability | 99.9% |
| Data Durability | 99.999999999% (11 nines) |

### 7.4 Cart Limits

| Limit | Value | Rationale |
|-------|-------|-----------|
| Max items per cart | 50 | Performance and practical |
| Max quantity per item | 99 | Reasonable purchase limit |
| Guest cart expiry | 30 days | Data cleanup |
| Max cart size (data) | 400 KB | DynamoDB item limit |

---

## 8. Deployment Architecture

### 8.1 Environment Configuration

| Component | DEV | SIT | PROD |
|-----------|-----|-----|------|
| API Gateway | bbws-cart-api-dev | bbws-cart-api-sit | bbws-cart-api-prod |
| Lambda | bbws-cart-lambda-dev | bbws-cart-lambda-sit | bbws-cart-lambda-prod |
| DynamoDB | bbws-carts-dev | bbws-carts-sit | bbws-carts-prod |

### 8.2 Cart Cleanup Job

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         Cart Cleanup Architecture                         │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐    │
│   │  EventBridge    │────>│  Cleanup Lambda │────>│    DynamoDB     │    │
│   │  (Daily @ 2AM)  │     │                 │     │  (Soft delete)  │    │
│   └─────────────────┘     └─────────────────┘     └─────────────────┘    │
│                                                                           │
│   Process:                                                                │
│   1. Query GSI for carts where expiresAt < now()                         │
│   2. Set active=false for expired carts                                   │
│   3. Log cleanup statistics                                               │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 9. References

### 9.1 Related Documents

| Document | Relationship |
|----------|--------------|
| [BRS 2.1.7: Cart Management](../BRS/2.1.7_BRS_Cart_Management.md) | Parent business requirements |
| [LLD 2.1.7: Cart Lambda](../LLDs/2.1.7_LLD_Cart_Lambda.md) | Implementation details |
| [HLD 2.1.4: Product Management](./2.1.4_HLD_Product_Management.md) | Upstream component |
| [HLD 2.1.8: Order Management](./2.1.8_HLD_Order_Management.md) | Downstream component |

### 9.2 AWS Services Used

| Service | Purpose |
|---------|---------|
| API Gateway | REST API endpoints |
| Lambda | Serverless compute |
| DynamoDB | Cart data storage |
| CloudWatch | Monitoring and logging |

---

**End of Document**
