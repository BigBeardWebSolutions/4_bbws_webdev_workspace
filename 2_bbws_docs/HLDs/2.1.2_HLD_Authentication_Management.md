# HLD 2.1.2: Authentication Management

**Version**: 1.1
**Document ID**: HLD-2.1.2
**Created**: 2026-01-06
**Last Updated**: 2026-02-17
**Status**: Draft
**Author**: Platform Architecture Team
**Parent BRS**: [BRS 2.1.2 Authentication Management](../BRS/2.1.2_BRS_Authentication_Management.md)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-06 | Platform Architecture | Initial version |
| 1.1 | 2026-02-17 | Platform Architecture | HLD remediation: removed API endpoints table and sequence diagrams (moved to OpenAPI/LLD), added Platform Services and Related Repositories, added cross-reference to User Management (2.5.1) |

---

## 1. Introduction

### 1.1 Purpose

This High-Level Design document describes the architecture for the Authentication Management capability within the BBWS Customer Portal. It defines how customer registration, login, and password management are implemented.

### 1.2 Scope

This HLD defines the architectural boundaries and design for:
- Identity provider integration architecture (AWS Cognito)
- Authentication flow patterns (registration, login, password reset)
- Token-based session management architecture
- Security controls (rate limiting, brute force protection, password policy)
- Integration with downstream services via JWT claims

> **Note:** User profile management (CRUD, preferences, directory) is covered by [HLD 2.5.1: User Management](../../2_bbws_user_management/docs/hld/2.5.1_HLD_User_Management.md). For detailed API specifications, see `docs/openapi/`. For flow diagrams, see `docs/lld/`.

### 1.3 Design Principles

| Principle | Application |
|-----------|-------------|
| **Managed Identity** | Leverage AWS Cognito for identity management |
| **Secure by Default** | Strong passwords, encrypted tokens, rate limiting |
| **Self-Service** | No manual intervention for standard operations |
| **Separation of Concerns** | Auth separate from business logic |
| **Fail Secure** | Deny access on any authentication failure |

---

## 2. Architecture Overview

### 2.1 Solution Context

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Customer Portal                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                         Public Zone                               │   │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐                   │   │
│  │  │ Register │    │  Login   │    │  Reset   │                   │   │
│  │  │          │    │          │    │ Password │                   │   │
│  │  └────┬─────┘    └────┬─────┘    └────┬─────┘                   │   │
│  │       │               │               │                          │   │
│  │       └───────────────┴───────────────┘                          │   │
│  │                       │                                           │   │
│  │                       ▼                                           │   │
│  │              ┌─────────────────┐                                  │   │
│  │              │   AUTH MGMT     │                                  │   │
│  │              │     (2.1.2)     │                                  │   │
│  │              └────────┬────────┘                                  │   │
│  └───────────────────────┼──────────────────────────────────────────┘   │
│                          │                                               │
│                          ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                      Protected Zone                               │   │
│  │  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐      │   │
│  │  │  Cart    │   │  Order   │   │ Payment  │   │  Tenant  │      │   │
│  │  │  2.1.7   │   │  2.1.8   │   │  2.1.9   │   │   2.5    │      │   │
│  │  └──────────┘   └──────────┘   └──────────┘   └──────────┘      │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Key Architecture Decisions

| Decision | Rationale |
|----------|-----------|
| **AWS Cognito** | Managed identity service, handles passwords, MFA-ready |
| **JWT Tokens** | Stateless authentication, scalable |
| **Email Verification** | Ensures valid contact information |
| **Tenant Creation on Register** | Seamless onboarding flow |
| **Rate Limiting** | Protects against brute force attacks |

---

## 3. Component Architecture

### 3.1 Component Overview

| Component | Type | Purpose |
|-----------|------|---------|
| **Auth API** | Lambda (API Gateway) | Handles registration, login, password endpoints |
| **Auth Service** | Lambda Layer | Business logic for authentication |
| **Cognito Client** | Lambda Layer | Wrapper for Cognito operations |
| **Email Service** | Lambda Layer | Sends verification and notification emails |
| **User Pool** | Cognito | Stores user credentials and handles authentication |
| **Tenants Table** | DynamoDB | Links Cognito users to tenant records |

---

## 4. Integration Architecture

### 4.1 Downstream Integration: Tenant Management

| Aspect | Detail |
|--------|--------|
| **Trigger** | Successful registration |
| **Action** | Create tenant record with UNVALIDATED status |
| **Data Passed** | Email, cognitoId, firstName, lastName |
| **Status Update** | VALIDATED after email verification |

### 4.2 Token Usage by Other Services

| Service | Token Required | Claims Used |
|---------|----------------|-------------|
| Cart (merge) | accessToken | tenantId, email |
| Order | accessToken | tenantId, email |
| Payment | accessToken | tenantId |
| Tenant Mgmt | accessToken | tenantId, role |
| User Mgmt | accessToken | tenantId, userId, role |

### 4.3 Email Service Integration

| Email Type | Trigger | Content |
|------------|---------|---------|
| Verification | Registration | Link to verify email |
| Password Reset | Forgot password | Reset code |
| Welcome | Email verified | Onboarding info |
| Password Changed | Password updated | Security notification |

---

## 5. Data Architecture

### 5.1 Cognito User Pool

| Attribute | Type | Purpose |
|-----------|------|---------|
| email | Required | Primary identifier |
| email_verified | System | Verification status |
| sub | System | Cognito user ID |
| given_name | Custom | First name |
| family_name | Custom | Last name |

### 5.2 Tenant Record (DynamoDB)

| Attribute | Purpose |
|-----------|---------|
| tenantId | Primary key, links to all tenant data |
| email | User identifier (GSI) |
| cognitoId | Links to Cognito user |
| status | UNVALIDATED > VALIDATED > REGISTERED |
| createdAt | Audit timestamp |
| updatedAt | Audit timestamp |

### 5.3 Account Status State Machine

```
┌──────────────────────────────────────────────────────────────────────────┐
│                       Account Status Transitions                          │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                         ┌─────────────────┐                               │
│                         │   UNVALIDATED   │                               │
│                         │  (registered)   │                               │
│                         └────────┬────────┘                               │
│                                  │                                        │
│                                  │ Email verified                         │
│                                  ▼                                        │
│                         ┌─────────────────┐                               │
│                         │    VALIDATED    │                               │
│                         │ (email confirmed)│                              │
│                         └────────┬────────┘                               │
│                                  │                                        │
│                                  │ First order completed                  │
│                                  ▼                                        │
│                         ┌─────────────────┐                               │
│                         │   REGISTERED    │                               │
│                         │  (full customer) │                              │
│                         └────────┬────────┘                               │
│                                  │                                        │
│                    ┌─────────────┼─────────────┐                          │
│                    │             │             │                          │
│                    ▼             │             ▼                          │
│           ┌───────────────┐     │     ┌───────────────┐                  │
│           │   SUSPENDED   │     │     │    PARKED     │                  │
│           │ (payment issue)│◄───┴────►│ (by request)  │                  │
│           └───────────────┘           └───────────────┘                  │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Security Architecture

### 6.1 Authentication Security

| Control | Implementation |
|---------|----------------|
| **Password Hashing** | Cognito SRP protocol (never transmitted) |
| **Token Signing** | RS256 (asymmetric) |
| **Token Expiry** | Access: 1 hour, Refresh: 7 days |
| **Secure Transmission** | TLS 1.2+ only |

### 6.2 Rate Limiting

| Operation | Limit | Window |
|-----------|-------|--------|
| Login attempts | 5 | Per minute per email |
| Password reset | 3 | Per hour per email |
| Registration | 10 | Per hour per IP |
| Verification resend | 5 | Per hour per email |

### 6.3 Password Policy

| Requirement | Value |
|-------------|-------|
| Minimum length | 8 characters |
| Uppercase | Required |
| Lowercase | Required |
| Number | Required |
| Symbol | Required |

### 6.4 Protection Against Common Attacks

| Attack | Protection |
|--------|------------|
| Brute Force | Rate limiting, account lockout |
| Credential Stuffing | Strong password policy, rate limiting |
| Account Enumeration | Same response for valid/invalid emails |
| Session Hijacking | Secure cookies, token refresh |
| CSRF | Token-based auth (no cookies for auth) |

---

## 7. Non-Functional Requirements

### 7.1 Performance

| Metric | Target |
|--------|--------|
| Registration | < 2 seconds |
| Login | < 500ms |
| Password Reset Request | < 1 second |
| Email Delivery | < 30 seconds |

### 7.2 Availability

| Metric | Target |
|--------|--------|
| API Availability | 99.9% |
| Cognito SLA | 99.9% (AWS) |

### 7.3 Scalability

| Component | Scaling |
|-----------|---------|
| Lambda | Auto-scales to 1000 concurrent |
| Cognito | 400 requests/second (can increase) |
| DynamoDB | On-demand capacity |

---

## 8. Deployment Architecture

### 8.1 Environment Configuration

| Component | DEV | SIT | PROD |
|-----------|-----|-----|------|
| User Pool | bbws-users-dev | bbws-users-sit | bbws-users-prod |
| API Gateway | bbws-auth-api-dev | bbws-auth-api-sit | bbws-auth-api-prod |
| Lambda | bbws-auth-lambda-dev | bbws-auth-lambda-sit | bbws-auth-lambda-prod |
| Tenants Table | bbws-tenants-dev | bbws-tenants-sit | bbws-tenants-prod |

### 8.2 Cognito Configuration

| Setting | Value |
|---------|-------|
| MFA | Optional (Phase 2) |
| Email Verification | Required |
| Account Recovery | Email only |
| Password Expiry | None |
| Self-Service Signup | Enabled |

---

## 9. Platform Services

| Service | HLD | Repo | Description |
|---------|-----|------|-------------|
| Tenant Management | 2.5 | `2_bbws_tenant_management` | Tenant lifecycle and metadata |
| User Management | 2.5.1 | `2_bbws_user_management` | User profiles, directory, roles |
| Organization Management | 2.5.2 | `2_bbws_organization_management` | Org hierarchy (Division > Group > Team) |
| Site Management | 2.6 | `2_bbws_site_management` | WordPress site lifecycle |
| Instance Management | 2.7 | `2_bbws_instance_management` | Environment provisioning |
| Auth Management | 2.1.2 | `2_bbws_auth_management` | Registration, login, sessions |

---

## 10. Related Repositories

| Repository | Purpose |
|------------|---------|
| `2_bbws_tenant_management` | Tenant lifecycle service |
| `2_bbws_user_management` | User profile and role service |
| `2_bbws_organization_management` | Organization hierarchy service |
| `2_bbws_site_management` | WordPress site management service |
| `2_bbws_instance_management` | Environment provisioning service |
| `2_bbws_auth_management` | Authentication service |
| `2_bbws_ecs_terraform` | Shared ECS infrastructure as code |
| `2_bbws_ecs_operations` | Dashboards, alerts, runbooks |
| `2_bbws_wordpress_container` | WordPress Docker image |
| `2_bbws_agents` | AI agents and utilities |
| `2_bbws_docs` | Central documentation |

---

## 11. References

### 11.1 Related Documents

| Document | Relationship |
|----------|--------------|
| [BRS 2.1.2: Authentication Management](../BRS/2.1.2_BRS_Authentication_Management.md) | Parent business requirements |
| [LLD 2.1.2: Auth Lambda](../LLDs/2.1.2_LLD_Auth_Lambda.md) | Implementation details (includes flow diagrams) |
| [HLD 2.5: Tenant Management](./2.5_HLD_Tenant_Management.md) | Downstream integration |
| [HLD 2.5.1: User Management](./2.5.1_HLD_User_Management.md) | User profile domain |
| Auth API OpenAPI Spec | `docs/openapi/auth_api_openapi.yaml` |

### 11.2 AWS Services Used

| Service | Purpose |
|---------|---------|
| Cognito | User pool, authentication |
| Lambda | Auth API handlers |
| API Gateway | REST endpoints |
| DynamoDB | Tenant data |
| SES | Email delivery |
| Secrets Manager | Credentials storage |

---

**End of Document**
