# BBWS Customer Portal (Public) - High-Level Design

**Version**: 1.1.4
**Created**: 2025-12-14
**Status**: Draft
**Document Type**: High-Level Design (HLD)
**Application**: Customer Portal (Public)
**Phase**: 0 (First to Market)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0.0 | 2025-12-14 | Agentic Architect | Initial version - Monolith |
| 1.1.1 | 2025-12-14 | Agentic Architect | Cut down scope to MVP Scope (Only dupport Order the Tenant Creation from order. Product management and campaing management.) |
| 1.1.2 | 2026-01-02 | Agentic Architect | Added POST /v1.0/orders public endpoint with tenant auto-resolution by email |
| 1.1.3 | 2026-01-05 | Agentic Architect | Added POST /v1.0/orders/{orderId}/paymentconfirmation endpoint for payment confirmation |
| 1.1.4 | 2026-01-05 | Agentic Architect | Moved authentication workflow to Private HLD (2.2) |

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Application Overview](#2-application-overview)
3. [Screens](#3-screens)
4. [Microservices](#4-microservices)
5. [API Endpoints](#5-api-endpoints)
6. [Authentication](#6-authentication)
7. [Anonymous Shopping](#7-anonymous-shopping)
8. [DynamoDB Schema](#8-dynamodb-schema)
9. [Infrastructure](#9-infrastructure)
10. [Repositories](#10-repositories)
11. [Business Approval Requirements](#11-business-approval-requirements)
12. [Implementation Plan](#12-implementation-plan)
13. [LLDs Reference](#13-llds-reference)
14. [Appendices](#14-appendices)

---

## 1. Executive Summary

### 1.1 Purpose

The BBWS Customer Portal (Public) is the public-facing website for marketing, pricing, registration, and anonymous shopping. It allows visitors to browse products, and complete purchases without mandatory registration.

In this cut-dowm MVP scope we focus laserly on being able to allow customers to oder and pay for services online without BBWS staff assistance. This allows automation of tenant creation and websites at the back with agents. This should see BBWS being able to handle more business.

### 1.2 Business Value

- **First Impression**: Professional landing pages
- **Conversion Funnel**: Product Creation → Campaign Creation (Including Code) → Oder Creation + Payment → Tenant Creation (Using Back office Agent)
- **Anonymous Shopping**: Purchase without registration barrier
- **Lead Generation**: Newsletter subscriptions, contact forms
- **SEO Optimized**: Public content for search engines

### 1.3 Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Backend | Lambda (Python 3.12) | Serverless, pay-per-use, team expertise |
| Anonymous Shopping | Cookie-based ID | Lower friction, higher conversion |
| Tenant Creation | Auto on checkout | Email-based, OTP verification |
| Infrastructure | Per-component Terraform | Independent deployment, isolation |
| Development | UI-first + API mocks | Faster feedback, PO approval early |
| Data Deletion | Soft delete (active=false) | Audit trail, recovery, data integrity |
| API Pattern | No DELETE operations | Status updates for all state changes |
| API Structure | Hierarchical HATEOAS | URLs reflect entity relationships, explicit ownership context |
| Pagination | pageSize/startAt/moreAvailable | Client-friendly, simpler than limit/next_token |
| Entity Pattern | Activatable Entity Pattern | All entities: id, dateCreated, dateLastUpdated, lastUpdatedBy, active |

---

## 2. Application Overview

### 2.1 Application Definition

| Attribute | Value |
|-----------|-------|
| **HLD File** | `BBWS_Customer_Portal_Public_HLD.md` |
| **URL (PROD)** | `https://kimmyai.io` |
| **URL (SIT)** | `https://sit.kimmyai.io` |
| **URL (DEV)** | `https://dev.kimmyai.io` |
| **API Base (PROD)** | `https://api.kimmyai.io` |
| **API Base (SIT)** | `https://sit.api.kimmyai.io` |
| **API Base (DEV)** | `https://dev.api.kimmyai.io` |
| **Authentication** | None (public) + Cognito (login/register) |
| **Target Users** | Prospects, new customers, anonymous shoppers |
| **Priority** | Phase 0 (First to Market) |

### 2.2 Scope

**In Scope:**
- Landing pages (home, features, pricing, about, contact)
- Marketing pages (campaigns, offers)
- Pricing display (all products)
- Registration flow
- Login page (redirects to Private portal)
- Password reset
- Email verification
- Checkout flow (anonymous + registered)
- Payment processing
- Newsletter subscription
- Contact forms

**Out of Scope:**
- Authenticated dashboard (Private Portal)
- Site management (Private Portal)
- Admin functions (Admin Portal)

---

## 3. Screens

### 3.1 Screen Summary (21 Total)

| Category | Screens | Count |
|----------|---------|-------|
| Marketing | CPP-001 to CPP-005 | 5 |
| Auth | CPP-006 to CPP-011 | 6 |
| Campaign | CPP-012 | 1 |
| Legal | CPP-013 to CPP-015 | 3 |
| Shopping | CPP-016 to CPP-021 | 6 |
| **Total** | | **21** |

### 3.2 Screen List

#### Marketing Screens (5)

| # | Screen ID | Screen Name | Description |
|---|-----------|-------------|-------------|
| 1 | CPP-001 | Home | Landing page |
| 2 | CPP-002 | Features | Feature overview |
| 3 | CPP-003 | Pricing | All products on offer |
| 4 | CPP-004 | About | Company info |
| 5 | CPP-005 | Contact | Contact form (all types) |

#### Auth Screens (6)

| # | Screen ID | Screen Name | Description |
|---|-----------|-------------|-------------|
| 6 | CPP-006 | Register | Customer registration |
| 7 | CPP-007 | Login | Login form |
| 8 | CPP-008 | Forgot Password | Password reset request |
| 9 | CPP-009 | Reset Password | Set new password |
| 10 | CPP-010 | Verify Email | Email verification |
| 11 | CPP-011 | Accept Invitation | Accept org/tenant invite |

#### Campaign Screens (1)

| # | Screen ID | Screen Name | Description |
|---|-----------|-------------|-------------|
| 12 | CPP-012 | Campaign Landing | Promo campaign page (with status/validity) |

#### Legal Screens (3)

| # | Screen ID | Screen Name | Description |
|---|-----------|-------------|-------------|
| 13 | CPP-013 | Terms of Service | Legal terms |
| 14 | CPP-014 | Privacy Policy | Privacy policy |
| 15 | CPP-015 | Cookie Policy | Cookie consent |

#### Shopping Screens (6)

| # | Screen ID | Screen Name | Description |
|---|-----------|-------------|-------------|
| 17 | CPP-017 | Checkout | Order details, email capture |
| 18 | CPP-018 | Payment | PayFast payment |
| 19 | CPP-019 | Order Confirmation | Success page |
| 20 | CPP-020 | Payment Failed | Retry options |
---

## 4. Microservices

### 4.1 Service Overview (3 Total)

| # | Service | Repository | API Prefix | Functions | Description |
|---|---------|------------|------------|-----------|-------------|
| 1 | Product Service | `2_1_bbws_product_lambda` | `/v1.0/products` | 5 | Product management |
| 2 | Order Service | `2_1_bbws_order_lambda` | `/v1.0/tenants/*/orders/*` | 4 | Order management |
| 3 | Campaign Service | `2_1_bbws_campaign_lambda` | `/v1.0/campaigns` | 5 | Campaign management |

### 4.2 Lambda Function Count

| Service | Functions | Total |
|---------|-----------|-------|
| Product | create-product, get-product, update-product, list-products, soft-delete-product | 5 |
| Order | create-order, get-order, list-orders, update-order | 4 |
| Campaign | create-campaign, get-campaign, update-campaign, list-campaigns, soft-delete-campaign | 5 |
| **Total** | | **14** |

### 4.3 Lambda Configuration

| Setting | Value |
|---------|-------|
| Runtime | Python 3.12 |
| Memory | 256MB |
| Timeout | 30s |
| Architecture | arm64 |

---

## 5. API Endpoints

### 5.1 API Structure

**Base URL (PROD)**: `https://api.kimmyai.io`
**Base URL (SIT)**: `https://sit.api.kimmyai.io`
**Base URL (DEV)**: `https://dev.api.kimmyai.io`

> **Note**: API version (`/v1.0`) is included in each endpoint path, not the base URL.

### 5.2 HATEOAS Operations: Product

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/products` | Create a new product |
| GET | `/v1.0/products/{productId}` | Get product details |
| GET | `/v1.0/products` | List all products (active only by default, use `?includeInactive=true` for all) |
| PUT | `/v1.0/products/{productId}` | Update product details |
| PUT | `/v1.0/products/{productId}` | Soft delete product (set active=false) |

#### 5.2.1 POST `/v1.0/products` - Create Product

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "name": "WordPress Professional Plan",
  "description": "Professional WordPress hosting with advanced features",
  "price": 299.99,
  "features": [
    "Up to 10 WordPress sites",
    "100GB storage",
    "Unlimited bandwidth",
    "Daily backups",
    "Priority support"
  ],
  "billingCycle": "monthly"
}
```

**Success Response (201 Created):**
```json
{
  "id": "prod_550e8400-e29b-41d4-a716-446655440000",
  "name": "WordPress Professional Plan",
  "description": "Professional WordPress hosting with advanced features",
  "price": 299.99,
  "features": [
    "Up to 10 WordPress sites",
    "100GB storage",
    "Unlimited bandwidth",
    "Daily backups",
    "Priority support"
  ],
  "billingCycle": "monthly",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:30:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Invalid product data",
  "details": [
    {
      "field": "price",
      "message": "Price must be a positive number"
    }
  ]
}
```

#### 5.2.2 GET `/v1.0/products/{productId}` - Get Product

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Success Response (200 OK):**
```json
{
  "id": "prod_550e8400-e29b-41d4-a716-446655440000",
  "name": "WordPress Professional Plan",
  "description": "Professional WordPress hosting with advanced features",
  "price": 299.99,
  "features": [
    "Up to 10 WordPress sites",
    "100GB storage",
    "Unlimited bandwidth",
    "Daily backups",
    "Priority support"
  ],
  "billingCycle": "monthly",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:30:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Product with id 'prod_550e8400-e29b-41d4-a716-446655440000' not found"
}
```

#### 5.2.3 GET `/v1.0/products` - List Products

**Query Parameters:**
- `includeInactive` (boolean, optional): Include soft-deleted products. Default: `false`
- `pageSize` (integer, optional): Number of items to return per page. Default: `50`, Max: `100`
- `startAt` (string, optional): Pagination token to start at a specific position

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Success Response (200 OK):**
```json
{
  "items": [
    {
      "id": "prod_550e8400-e29b-41d4-a716-446655440000",
      "name": "WordPress Professional Plan",
      "description": "Professional WordPress hosting with advanced features",
      "price": 299.99,
      "billingCycle": "monthly",
      "dateCreated": "2025-12-19T10:30:00Z",
      "dateLastUpdated": "2025-12-19T10:30:00Z",
      "lastUpdatedBy": "admin@kimmyai.io",
      "active": true
    },
    {
      "id": "prod_660e8400-e29b-41d4-a716-446655440001",
      "name": "WordPress Starter Plan",
      "description": "Basic WordPress hosting for small websites",
      "price": 99.99,
      "billingCycle": "monthly",
      "dateCreated": "2025-12-19T09:00:00Z",
      "dateLastUpdated": "2025-12-19T09:00:00Z",
      "lastUpdatedBy": "admin@kimmyai.io",
      "active": true
    }
  ],
  "startAt": "prod_660e8400-e29b-41d4-a716-446655440001",
  "moreAvailable": false
}
```

#### 5.2.4 PUT `/v1.0/products/{productId}` - Update Product

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "price": 279.99,
  "description": "Professional WordPress hosting with advanced features - Special offer!"
}
```

**Success Response (200 OK):**
```json
{
  "id": "prod_550e8400-e29b-41d4-a716-446655440000",
  "name": "WordPress Professional Plan",
  "description": "Professional WordPress hosting with advanced features - Special offer!",
  "price": 279.99,
  "features": [
    "Up to 10 WordPress sites",
    "100GB storage",
    "Unlimited bandwidth",
    "Daily backups",
    "Priority support"
  ],
  "billingCycle": "monthly",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T14:00:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

#### 5.2.5 PUT `/v1.0/products/{productId}` - Soft Delete Product

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "active": false
}
```

**Success Response (200 OK):**
```json
{
  "id": "prod_550e8400-e29b-41d4-a716-446655440000",
  "name": "WordPress Professional Plan",
  "description": "Professional WordPress hosting with advanced features",
  "price": 279.99,
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T15:00:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": false
}
```

### 5.3 HATEOAS Operations: Campaign

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/campaigns` | Create a new campaign |
| GET | `/v1.0/campaigns/{code}` | Get campaign details by code |
| GET | `/v1.0/campaigns` | List all campaigns (active only by default, use `?includeInactive=true` for all) |
| PUT | `/v1.0/campaigns/{code}` | Update campaign details |
| PUT | `/v1.0/campaigns/{code}` | Soft delete campaign (set active=false) |

#### 5.3.1 POST `/v1.0/campaigns` - Create Campaign

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "code": "SUMMER2025",
  "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
  "discountPercentage": 20.0,
  "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
  "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
  "fromDate": "2025-06-01",
  "toDate": "2025-08-31"
}
```

**Success Response (201 Created):**
```json
{
  "id": "camp_770e8400-e29b-41d4-a716-446655440002",
  "code": "SUMMER2025",
  "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
  "discountPercentage": 20.0,
  "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
  "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
  "fromDate": "2025-06-01",
  "toDate": "2025-08-31",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:30:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Invalid campaign data",
  "details": [
    {
      "field": "discountPercentage",
      "message": "Discount percentage must be between 0 and 100"
    },
    {
      "field": "fromDate",
      "message": "From date must be before to date"
    }
  ]
}
```

**Error Response (409 Conflict):**
```json
{
  "error": "ConflictError",
  "message": "Campaign with code 'SUMMER2025' already exists"
}
```

#### 5.3.2 GET `/v1.0/campaigns/{code}` - Get Campaign

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Success Response (200 OK):**
```json
{
  "id": "camp_770e8400-e29b-41d4-a716-446655440002",
  "code": "SUMMER2025",
  "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
  "discountPercentage": 20.0,
  "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
  "productName": "WordPress Professional Plan",
  "originalPrice": 299.99,
  "discountedPrice": 239.99,
  "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
  "fromDate": "2025-06-01",
  "toDate": "2025-08-31",
  "isValid": true,
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:30:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Campaign with code 'SUMMER2025' not found"
}
```

#### 5.3.3 GET `/v1.0/campaigns` - List Campaigns

**Query Parameters:**
- `includeInactive` (boolean, optional): Include soft-deleted campaigns. Default: `false`
- `validOnly` (boolean, optional): Only return campaigns valid today. Default: `false`
- `productId` (string, optional): Filter by product ID
- `pageSize` (integer, optional): Number of items to return per page. Default: `50`, Max: `100`
- `startAt` (string, optional): Pagination token to start at a specific position

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Success Response (200 OK):**
```json
{
  "items": [
    {
      "id": "camp_770e8400-e29b-41d4-a716-446655440002",
      "code": "SUMMER2025",
      "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
      "discountPercentage": 20.0,
      "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
      "productName": "WordPress Professional Plan",
      "fromDate": "2025-06-01",
      "toDate": "2025-08-31",
      "isValid": false,
      "dateCreated": "2025-12-19T10:30:00Z",
      "dateLastUpdated": "2025-12-19T10:30:00Z",
      "lastUpdatedBy": "admin@kimmyai.io",
      "active": true
    },
    {
      "id": "camp_880e8400-e29b-41d4-a716-446655440003",
      "code": "NEWYEAR2025",
      "description": "New Year 2025 - 30% off all plans",
      "discountPercentage": 30.0,
      "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
      "productName": "WordPress Professional Plan",
      "fromDate": "2025-01-01",
      "toDate": "2025-01-31",
      "isValid": false,
      "dateCreated": "2025-12-15T08:00:00Z",
      "dateLastUpdated": "2025-12-15T08:00:00Z",
      "lastUpdatedBy": "admin@kimmyai.io",
      "active": true
    }
  ],
  "startAt": "camp_880e8400-e29b-41d4-a716-446655440003",
  "moreAvailable": false
}
```

#### 5.3.4 PUT `/v1.0/campaigns/{code}` - Update Campaign

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "discountPercentage": 25.0,
  "description": "Summer 2025 Extended Offer - 25% off all WordPress plans",
  "toDate": "2025-09-15"
}
```

**Success Response (200 OK):**
```json
{
  "id": "camp_770e8400-e29b-41d4-a716-446655440002",
  "code": "SUMMER2025",
  "description": "Summer 2025 Extended Offer - 25% off all WordPress plans",
  "discountPercentage": 25.0,
  "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
  "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
  "fromDate": "2025-06-01",
  "toDate": "2025-09-15",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T16:00:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

#### 5.3.5 PUT `/v1.0/campaigns/{code}` - Soft Delete Campaign

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "active": false
}
```

**Success Response (200 OK):**
```json
{
  "id": "camp_770e8400-e29b-41d4-a716-446655440002",
  "code": "SUMMER2025",
  "description": "Summer 2025 Extended Offer - 25% off all WordPress plans",
  "discountPercentage": 25.0,
  "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T17:00:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": false
}
```

### 5.4 HATEOAS Operations: Order

Orders are always associated with a tenant (auto-created for anonymous).

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/tenants/{tenantId}/orders` | Create order (tenant known) |
| POST | `/v1.0/orders` | Create order (public - tenant resolved by email) |
| GET | `/v1.0/tenants/{tenantId}/orders` | List orders (active only by default) |
| GET | `/v1.0/orders/{orderId}` | Get order details |
| PUT | `/v1.0/orders/{orderId}` | Update order (status=CANCELLED or active=false) |
| POST | `/v1.0/orders/{orderId}/paymentconfirmation` | Confirm payment (triggers PDF & email) |

#### 5.4.1 POST `/v1.0/tenants/{tenantId}/orders` - Create Order

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Request Body:**
```json
{
  "customerEmail": "customer@example.com",
  "billingAddress": {
    "street": "123 Main Street",
    "city": "Cape Town",
    "province": "Western Cape",
    "postalCode": "8001",
    "country": "ZA"
  },
  "paymentMethod": "payfast",
  "campaignCode": "SUMMER2025"
}
```

**Success Response (201 Created):**
```json
{
  "id": "order_aa0e8400-e29b-41d4-a716-446655440005",
  "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
  "customerEmail": "customer@example.com",
  "status": "PENDING_PAYMENT",
  "items": [
    {
      "id": "item_cc0e8400-e29b-41d4-a716-446655440007",
      "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
      "productName": "WordPress Professional Plan",
      "quantity": 1,
      "unitPrice": 299.99,
      "discount": 60.00,
      "subtotal": 239.99,
      "dateCreated": "2025-12-19T10:30:00Z",
      "dateLastUpdated": "2025-12-19T10:30:00Z",
      "lastUpdatedBy": "system",
      "active": true
    }
  ],
  "subtotal": 239.99,
  "tax": 35.99,
  "total": 275.98,
  "currency": "ZAR",
  "campaign": {
    "id": "camp_770e8400-e29b-41d4-a716-446655440002",
    "code": "SUMMER2025",
    "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
    "discountPercentage": 20.0,
    "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
    "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
    "fromDate": "2025-06-01",
    "toDate": "2025-08-31",
    "isValid": true,
    "dateCreated": "2025-12-19T10:30:00Z",
    "dateLastUpdated": "2025-12-19T10:30:00Z",
    "lastUpdatedBy": "admin@kimmyai.io",
    "active": true
  },
  "billingAddress": {
    "street": "123 Main Street",
    "city": "Cape Town",
    "province": "Western Cape",
    "postalCode": "8001",
    "country": "ZA"
  },
  "paymentMethod": "payfast",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:30:00Z",
  "lastUpdatedBy": "customer@example.com",
  "active": true
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Invalid order data",
  "details": [
    {
      "field": "customerEmail",
      "message": "Valid email address is required"
    }
  ]
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Order with id 'order_990e8400-e29b-41d4-a716-446655440004' not found or is empty"
}
```

#### 5.4.1.1 POST `/v1.0/orders` - Create Order (Public - No Registration Required)

This endpoint enables anonymous checkout without requiring tenant registration. The tenant is automatically resolved or created based on the customer's email address.

**Behavior:**
- If a tenant with the provided `customerEmail` exists → uses existing tenant
- If no tenant exists → creates new tenant with status `UNVALIDATED`
- Tenant resolution happens asynchronously after `202 Accepted` response

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "X-Api-Key": "<api-key>"
}
```

**Request Body:**
```json
{
  "customerId": "anonymous-session-123",
  "customerEmail": "newcustomer@example.com",
  "totalAmount": 299.99,
  "currency": "ZAR",
  "items": [
    {
      "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
      "productName": "WordPress Professional Plan",
      "quantity": 1,
      "unitPrice": 299.99,
      "totalPrice": 299.99
    }
  ],
  "billingAddress": {
    "street": "456 Oak Avenue",
    "city": "Johannesburg",
    "province": "Gauteng",
    "postalCode": "2001",
    "country": "ZA"
  },
  "campaign": {
    "campaignId": "camp_770e8400-e29b-41d4-a716-446655440002",
    "campaignName": "Summer 2025",
    "source": "google",
    "medium": "cpc"
  }
}
```

**Success Response (202 Accepted):**
```json
{
  "orderId": "order-20260102150030-AB",
  "status": "PENDING",
  "message": "Order creation initiated",
  "_links": {
    "self": "/v1.0/orders/order-20260102150030-AB"
  }
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Invalid order data",
  "details": [
    {
      "field": "customerEmail",
      "message": "Valid email address is required"
    }
  ]
}
```

**Notes:**
- Returns `202 Accepted` (not `201 Created`) because processing is asynchronous
- The `tenantId` is NOT returned in the immediate response - it's resolved async
- To verify the order was created, use `GET /v1.0/orders/{orderId}` after a short delay
- Auto-created tenants have status `UNVALIDATED` and can be upgraded via OTP verification

#### 5.4.2 GET `/v1.0/tenants/{tenantId}/orders` - List Tenant Orders

**Query Parameters:**
- `includeInactive` (boolean, optional): Include soft-deleted orders. Default: `false`
- `status` (string, optional): Filter by order status. Values: `PENDING_PAYMENT`, `PAID`, `PROCESSING`, `COMPLETED`, `CANCELLED`, `REFUNDED`
- `pageSize` (integer, optional): Number of items to return per page. Default: `50`, Max: `100`
- `startAt` (string, optional): Pagination token to start at a specific position

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Success Response (200 OK):**
```json
{
  "items": [
    {
      "id": "order_aa0e8400-e29b-41d4-a716-446655440005",
      "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
      "customerEmail": "customer@example.com",
      "status": "PAID",
      "total": 275.98,
      "currency": "ZAR",
      "itemsCount": 1,
      "dateCreated": "2025-12-19T10:30:00Z",
      "dateLastUpdated": "2025-12-19T10:45:00Z",
      "lastUpdatedBy": "system",
      "active": true
    },
    {
      "id": "order_dd0e8400-e29b-41d4-a716-446655440008",
      "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
      "customerEmail": "customer@example.com",
      "status": "COMPLETED",
      "total": 99.99,
      "currency": "ZAR",
      "itemsCount": 1,
      "dateCreated": "2025-11-15T08:00:00Z",
      "dateLastUpdated": "2025-11-15T09:00:00Z",
      "lastUpdatedBy": "system",
      "active": true
    }
  ],
  "startAt": "order_dd0e8400-e29b-41d4-a716-446655440008",
  "moreAvailable": false
}
```

#### 5.4.3 GET `/v1.0/orders/{orderId}` - Get Order Details

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Success Response (200 OK):**
```json
{
  "id": "order_aa0e8400-e29b-41d4-a716-446655440005",
  "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
  "customerEmail": "customer@example.com",
  "status": "PAID",
  "items": [
    {
      "id": "item_cc0e8400-e29b-41d4-a716-446655440007",
      "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
      "productName": "WordPress Professional Plan",
      "quantity": 1,
      "unitPrice": 299.99,
      "discount": 60.00,
      "subtotal": 239.99,
      "dateCreated": "2025-12-19T10:30:00Z",
      "dateLastUpdated": "2025-12-19T10:30:00Z",
      "lastUpdatedBy": "system",
      "active": true
    }
  ],
  "subtotal": 239.99,
  "tax": 35.99,
  "total": 275.98,
  "currency": "ZAR",
  "campaign": {
    "id": "camp_770e8400-e29b-41d4-a716-446655440002",
    "code": "SUMMER2025",
    "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
    "discountPercentage": 20.0,
    "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
    "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
    "fromDate": "2025-06-01",
    "toDate": "2025-08-31",
    "isValid": true,
    "dateCreated": "2025-12-19T10:30:00Z",
    "dateLastUpdated": "2025-12-19T10:30:00Z",
    "lastUpdatedBy": "admin@kimmyai.io",
    "active": true
  },
  "billingAddress": {
    "street": "123 Main Street",
    "city": "Cape Town",
    "province": "Western Cape",
    "postalCode": "8001",
    "country": "ZA"
  },
  "paymentMethod": "payfast",
  "paymentDetails": {
    "paymentId": "payment_ee0e8400-e29b-41d4-a716-446655440009",
    "payfastPaymentId": "1234567",
    "status": "COMPLETED",
    "paidAt": "2025-12-19T10:45:00Z"
  },
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:45:00Z",
  "lastUpdatedBy": "system",
  "active": true
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Order with id 'order_aa0e8400-e29b-41d4-a716-446655440005' not found"
}
```

**Error Response (403 Forbidden):**
```json
{
  "error": "Forbidden",
  "message": "You do not have permission to access this order"
}
```

#### 5.4.4 PUT `/v1.0/orders/{orderId}` - Update Order

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Request Body (Cancel Order):**
```json
{
  "status": "CANCELLED",
  "cancellationReason": "Customer requested cancellation"
}
```

**Success Response (200 OK):**
```json
{
  "id": "order_aa0e8400-e29b-41d4-a716-446655440005",
  "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
  "customerEmail": "customer@example.com",
  "status": "CANCELLED",
  "cancellationReason": "Customer requested cancellation",
  "total": 275.98,
  "currency": "ZAR",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T11:00:00Z",
  "lastUpdatedBy": "customer@example.com",
  "active": true
}
```

**Request Body (Soft Delete Order):**
```json
{
  "active": false
}
```

**Success Response (200 OK):**
```json
{
  "id": "order_aa0e8400-e29b-41d4-a716-446655440005",
  "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
  "status": "CANCELLED",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T11:30:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": false
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Cannot cancel order",
  "details": [
    {
      "field": "status",
      "message": "Order with status 'COMPLETED' cannot be cancelled"
    }
  ]
}
```

#### 5.4.5 POST `/v1.0/orders/{orderId}/paymentconfirmation` - Confirm Payment

This endpoint confirms payment for an order, triggering asynchronous processing:
- Order status updated to `PAID`
- PDF invoice generation (via SQS → OrderPDFCreator Lambda)
- Customer confirmation email (via SQS → CustomerOrderConfirmationSender Lambda)

**Why POST (not PUT)?**
- This is an **action/command** that triggers side effects, not a simple resource update
- Follows REST conventions where POST is used for operations/actions
- Idempotency is handled via `paymentReference` tracking

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Path Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| orderId | string | Yes | The order ID (format: `order_{uuid}`) |

**Request Body:**
```json
{
  "paymentReference": "PAY-2026-001234",
  "paymentMethod": "CARD",
  "paymentAmount": 1500.00,
  "paymentCurrency": "ZAR"
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| paymentReference | string | Yes | External payment reference from payment gateway |
| paymentMethod | string | Yes | Payment method: `CARD`, `EFT`, `CASH` |
| paymentAmount | number | Yes | Amount paid |
| paymentCurrency | string | Yes | Currency code (ISO 4217) |

**Success Response (200 OK):**
```json
{
  "id": "order_123e4567-e89b-12d3-a456-426614174000",
  "status": "PAID",
  "paymentReference": "PAY-2026-001234",
  "paymentConfirmedAt": "2026-01-05T14:30:00Z",
  "pdfUrl": "https://cdn.example.com/invoices/order_123e4567.pdf",
  "_links": {
    "self": { "href": "/v1.0/orders/order_123e4567-e89b-12d3-a456-426614174000" },
    "invoice": { "href": "/v1.0/orders/order_123e4567-e89b-12d3-a456-426614174000/invoice" }
  }
}
```

**Error Response (400 Bad Request) - Invalid Payment Data:**
```json
{
  "error": "ValidationError",
  "message": "Payment amount does not match order total",
  "details": {
    "orderTotal": 1500.00,
    "paymentAmount": 1000.00
  }
}
```

**Error Response (404 Not Found) - Order Not Found:**
```json
{
  "error": "NotFound",
  "message": "Order with id 'order_xxx' not found"
}
```

**Error Response (409 Conflict) - Already Paid:**
```json
{
  "error": "Conflict",
  "message": "Order has already been paid",
  "details": {
    "currentStatus": "PAID",
    "paymentConfirmedAt": "2026-01-05T10:00:00Z"
  }
}
```

**Error Response (422 Unprocessable Entity) - Invalid Status Transition:**
```json
{
  "error": "InvalidStatusTransition",
  "message": "Cannot confirm payment for order with status 'CANCELLED'",
  "details": {
    "currentStatus": "CANCELLED",
    "allowedStatuses": ["PENDING", "PAYMENT_PENDING"]
  }
}
```

**Async Processing Triggered:**

Upon successful payment confirmation, the following are triggered via SQS:
1. **OrderPDFCreator**: Generates PDF invoice → S3
2. **CustomerOrderConfirmationSender**: Sends confirmation email with invoice link
3. **OrderInternalNotificationSender**: Notifies admin of successful payment

---

## 6. Authentication

### 6.1 Public Access

Most endpoints are public (no auth required):
- Marketing pages
- Product listing
- Campaign display
- Anonymous checkout

### 6.2 Auth Screens (Entry Points)

The Public Portal hosts authentication entry point screens that redirect to the Private Portal:

| Screen ID | Screen Name | Description |
|-----------|-------------|-------------|
| CPP-006 | Register | Customer registration |
| CPP-007 | Login | Login form → redirects to Private Portal |
| CPP-008 | Forgot Password | Password reset request |
| CPP-009 | Reset Password | Set new password |
| CPP-010 | Verify Email | Email verification |
| CPP-011 | Accept Invitation | Accept org/tenant invite |

> **Full Authentication Workflow**: See [BBWS Customer Portal Private HLD (2.2)](./2.2_BBWS_Customer_Portal_Private_HLD.md#7-authentication) Section 7 for detailed Cognito integration, JWT structure, MFA, and authentication flows.

### 6.3 Summary

| Aspect | Value |
|--------|-------|
| Provider | AWS Cognito |
| User Pool | `bbws-customer-pool` (shared with Private Portal) |
| On Success | Redirect to Private Portal (`portal.kimmyai.io`) |
| JWT Storage | HttpOnly cookie or localStorage |

---

## 7. Anonymous Shopping

### 7.1 Core Business Rules

| Rule | Description |
|------|-------------|
| **ORDER requires TENANT#** | Orders MUST always have a TENANT# (PK), even if tenant status is UNVALIDATED |
| **PAYMENT requires TENANT#** | Payments MUST always have a TENANT# (via Order), even if tenant status is UNVALIDATED |
| **CART is flexible** | Cart may or may not have a tenant association |
| **Cart Type** | `UNREGISTERED` (cookie-based) or `REGISTERED` (tenant-based) |
| **Order creates Tenant** | On order creation, always create tenant OR associate with existing one by email |

### 7.2 Anonymous User Flow

```
┌────────────────────────────────────────────────────────────────┐
│                  ANONYMOUS SHOPPING FLOW                       │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  1. BROWSE                                                     │
│     └── User visits site, browses products                       
│                                                                │
│  2. CART (Type: UNREGISTERED)                                  │
│     ├── System assigns cookie-based cart ID                    │
│     ├── Cart stored with type=UNREGISTERED                     │
│     ├── NO tenant association at this stage                    │
│     └── Endpoint: /v1.0/cart/{cartId}                          │
│                                                                │
│  3. CHECKOUT (Tenant Creation)                                 │
│     ├── User enters email address                              │
│     ├── System looks up existing tenant by email               │
│     │   ├── EXISTS: Use existing tenant                        │
│     │   └── NOT EXISTS: Create tenant (status=UNVALIDATED)     │
│     ├── OTP sent to email for verification                     │
│     └── Tenant ID returned for order creation                  │
│                                                                │
│  4. ORDER (Always has TENANT#)                                 │
│     ├── Order created with PK=TENANT#{tenantId}                │
│     ├── Tenant status may be UNVALIDATED                       │
│     ├── Endpoint: /v1.0/tenants/{tenantId}/orders              │
│     └── Cart items transferred to order                        │
│                                                                │
│  5. PAYMENT (Always has TENANT# via Order)                     │
│     ├── Payment created under order (which has TENANT#)        │
│     ├── Endpoint: /v1.0/tenants/{id}/orders/{id}/payments      │
│     └── PayFast redirect                                       │
│                                                                │
│  6. COMPLETION                                                 │
│     ├── PayFast webhook confirms payment                       │
│     ├── Order status updated                                   │
│     ├── Tenant status updated to VALIDATED (on successful OTP) │
│     └── User can later register with same email                │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 7.3 Cart Types

| Type | Description | PK Pattern | Tenant Association |
|------|-------------|------------|-------------------|
| `UNREGISTERED` | Anonymous cart (cookie-based) | `CART#{cartId}` | None |
| `REGISTERED` | Logged-in user cart | `TENANT#{tenantId}` | Yes |

### 7.4 Tenant Status Lifecycle

| Status | Description | Can Create Orders? |
|--------|-------------|-------------------|
| `UNVALIDATED` | Created at checkout, email not verified | Yes |
| `VALIDATED` | Email verified via OTP | Yes |
| `REGISTERED` | Full Cognito registration complete | Yes |
| `SUSPENDED` | Account suspended | No |

### 7.5 Tenant Auto-Creation Rules

| Scenario | Action |
|----------|--------|
| Anonymous checkout (new email) | Create tenant with status=UNVALIDATED |
| Anonymous checkout (existing email) | Associate with existing tenant |
| OTP verified | Update tenant status to VALIDATED |
| User registers later | Update tenant status to REGISTERED, link Cognito user |
| Repeat purchase (same email) | Same tenant used (lookup by email) |

### 7.6 Cart Merge on Login

When anonymous user logs in:
1. Check if anonymous cart exists (cookie ID, type=UNREGISTERED)
2. Check if tenant cart exists (type=REGISTERED)
3. Merge anonymous cart items into tenant cart
4. Update cart type to REGISTERED
5. Associate anonymous cart record with newly validated tenant (set tenantId, update type)

> **Note**: Tenant validation is just a status change on a pre-created tenant record. No new tenant is created during login - the tenant already exists from checkout or registration.

### 7.7 Future Consideration: Tenant Merge

> **DESIGN NOTE**: Customers may want to merge tenants later (e.g., consolidate multiple email addresses into one account). This functionality should be considered in the Organisation Management feature of the Private Portal. The Order and Payment history must be preserved during any tenant merge operation.

**Implications for Order/Payment design:**
- Orders reference tenant by ID (immutable)
- Payment history linked to orders
- Tenant merge would update tenant reference OR maintain history with merge audit trail
- Organisation Management (Private Portal) will need "Merge Tenants" feature

---

## 8. DynamoDB Schema

### 8.1 Core Entity Rules

| Entity | Tenant Association | Rule |
|--------|-------------------|------|
| Order | **REQUIRED** | Always has TENANT# in PK |
| Payment | **REQUIRED** | Always has TENANT# via Order |
| Tenant | N/A | Created at checkout if not exists |

### 8.2 Public Portal Entities

> **Soft Delete Pattern**: All entities have an `active` boolean field (default=true). To delete, set `active=false`. Queries filter by `active=true` by default.

| Entity | PK | SK | Attributes |
|--------|----|----|------------|
| Tenant | `TENANT#{tenantId}` | `METADATA` | id, email, status (UNVALIDATED/VALIDATED/REGISTERED), active, dateCreated |
| Order | `TENANT#{tenantId}` | `ORDER#{orderId}` | id, status, total, campaign (embedded object), active, dateCreated |
| OrderItem | `TENANT#{tenantId}#ORDER#{orderId}` | `ITEM#{itemId}` | id, productId, quantity, price, active |
| Payment | `TENANT#{tenantId}#ORDER#{orderId}` | `PAYMENT#{paymentId}` | id, amount, status, payfastId, active, paidAt |
| Product | `PRODUCT#{productId}` | `METADATA` | id, name, description, price, active, dateCreated, dateLastUpdated |
| NewsletterSub | `NEWSLETTER#{email}` | `METADATA` | id, active, subscribedAt, preferences |
| Campaign | `CAMPAIGN#{code}` | `METADATA` | id, code, description, discountPercentage, productId, termsConditionsLink, fromDate, toDate, active, dateCreated, dateLastUpdated |

### 8.3 GSIs

| GSI Name | PK | SK | Purpose |
|----------|----|----|---------|
| EmailIndex | email | entityType | Find tenant by email |
| OrderStatusIndex | status | dateCreated | List orders by status |
| OrderTenantIndex | tenantId | dateCreated | List orders by tenant |
| PaymentOrderIndex | orderId | dateCreated | List payments by order |
| ProductActiveIndex | active | dateCreated | List active products |
| CampaignActiveIndex | active | fromDate | List active campaigns by date |
| CampaignProductIndex | productId | fromDate | List campaigns by product |
| TenantStatusIndex | status | dateCreated | List tenants by status |
| ActiveIndex | active | dateCreated | Filter by active status (sparse index, all entities) |

> **Query Pattern**: All list queries include `active=true` filter by default. Use `includeInactive=true` parameter to include soft-deleted records.

### 8.4 Key Relationships

```

┌─────────────────────────────────────────────────────────────────┐
│                    ENTITY RELATIONSHIPS                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  TENANT                                                         │
│  PK: TENANT#{tenantId}                                          │
│  SK: METADATA                                                   │
│  status: UNVALIDATED/VALIDATED                                  │
│       │                                                         │
│       │                                                         │
│       ▼                                                         │
│  ORDER                                                          │
│  PK: TENANT#{tenantId}                                          │
│  SK: ORDER#{orderId}                                            │
│       │                                                         │
│       │                                                         │
│       ▼                                                         │
│  ORDERITEM                                                      │
│  PK: TENANT#{id}#ORDER#{id}                                     │
│  SK: ITEM#{itemId}                                              │
│       │                                                         │
│       │                                                         │
│       ▼                                                         │
│  PAYMENT                                                        │
│  PK: TENANT#{id}#ORDER#{id}                                     │
│  SK: PAYMENT#{paymentId}                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```


### 8.5 Product Entity Details

| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| id | String | Yes | Unique product identifier (UUID) |
| name | String | Yes | Product name |
| description | String | Yes | Product description |
| price | Number | Yes | Product price |
| active | Boolean | Yes | Active status (default=true, false=soft deleted) |
| created_at | String | Yes | Creation timestamp (ISO 8601) |
| updated_at | String | Yes | Last update timestamp (ISO 8601) |

### 8.6 Campaign Entity Details

| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| id | String | Yes | Unique campaign identifier (UUID) |
| code | String | Yes | Campaign code (used in PK and URLs) |
| description | String | Yes | Campaign description |
| discountPercentage | Number | Yes | Discount percentage (0-100) |
| productId | String | Yes | Associated product identifier |
| termsConditionsLink | String | Yes | URL to terms and conditions document |
| fromDate | String | Yes | Campaign start date (ISO 8601 format: YYYY-MM-DD) |
| toDate | String | Yes | Campaign end date (ISO 8601 format: YYYY-MM-DD) |
| active | Boolean | Yes | Active status (default=true, false=soft deleted) |
| created_at | String | Yes | Creation timestamp (ISO 8601) |
| updated_at | String | Yes | Last update timestamp (ISO 8601) |

---

## 9. Infrastructure

### 9.1 Per-Component Architecture

Each component manages its own infrastructure (See example below):

```
2_bbws_product_lambda/
├── src/
│   └── handlers/
├── tests/
├── terraform/
│   ├── main.tf
│   ├── api_gateway.tf
│   ├── lambda.tf
│   ├── cloudfront.tf
│   └── variables.tf
└── README.md
```

### 9.2 AWS Services (Per Component)

| Service | Purpose |
|---------|---------|
| API Gateway | REST API (created per component) |
| Lambda | Python 3.12 handlers |
| CloudFront | CDN routing (per component) |
| DynamoDB | Shared table (accessed by component) |
| S3 | Static assets, deployment artifacts |
| Cognito | Shared user pool |
| SES | Email sending |

### 9.3 No Shared Infrastructure Repo

- Each Lambda component has its own `/terraform` folder
- Each component creates its own API Gateway resources
- CloudFront routing configured per component
- Domain routing managed at component level

---

## 10. Repositories

### 10.1 Repository List (6 Total)

| # | Repository | Type | Description |
|---|------------|------|-------------|
| 1 | `2_1_bbws_web_public` | Frontend | React SPA |
| 2 | `2_1_bbws_product_lambda` | Backend | Product service (Python) |
| 3 | `2_1_bbws_campaign_lambda` | Backend | Campaign service (Python) |
| 4 | `2_1_bbws_order_lambda` | Backend | Order service (Python) |
| 5 | `2_1_bbws_dynamodb_schemas` | Database | DynamoDB table schemas, GSIs, migrations |
| 6 | `2_1_bbws_operations` | Operations | Dashboards, Alerts, Budgets, Config, Guardrails, Firewall, SCPs etc |

### 10.2 Repository Naming Convention

```
2_bbws_web_public          # Frontend application
2_bbws_{service}_lambda    # Lambda backend services
```

**Rules:**
- Prefix: `2_bbws_` (project identifier)
- Lambda services end with `_lambda`
- No `svc` in names
- Each repo contains its own `/terraform` folder

### 10.3 Repository Structure

```
2_bbws_{service}_lambda/
├── src/
│   ├── handlers/          # Lambda handlers
│   ├── services/          # Business logic
│   ├── models/            # Data models
│   └── utils/             # Utilities
├── tests/
│   ├── unit/
│   └── integration/
├── terraform/
│   ├── main.tf
│   ├── api_gateway.tf
│   ├── lambda.tf
│   ├── iam.tf
│   ├── cloudfront.tf
│   ├── variables.tf
│   └── outputs.tf
├── requirements.txt
├── pytest.ini
└── README.md
```

### 10.4 Operations Repository - JSON Configuration Examples

The `2_1_bbws_operations` repository contains JSON configurations for monitoring, alerting, budgets, and security specific to the BBWS Customer Portal (Public). Below are example JSON payloads for operational configurations.

#### 10.4.1 CloudWatch Alarm - Product Lambda Error Rate

**Purpose**: Alert when Product Lambda error rate exceeds threshold

```json
{
  "AlarmName": "2-1-bbws-product-lambda-error-rate-alarm",
  "AlarmDescription": "Alert when Product Lambda error rate exceeds 5 errors in 5 minutes",
  "MetricName": "Errors",
  "Namespace": "AWS/Lambda",
  "Statistic": "Sum",
  "Period": 300,
  "EvaluationPeriods": 2,
  "Threshold": 5.0,
  "ComparisonOperator": "GreaterThanThreshold",
  "Dimensions": [
    {
      "Name": "FunctionName",
      "Value": "2-1-bbws-product-lambda-list-products"
    }
  ],
  "ActionsEnabled": true,
  "AlarmActions": [
    "arn:aws:sns:af-south-1:536580886816:2-1-bbws-critical-alerts"
  ],
  "TreatMissingData": "notBreaching",
  "Tags": [
    {
      "Key": "Project",
      "Value": "2.1"
    },
    {
      "Key": "Environment",
      "Value": "DEV"
    }
  ]
}
```

#### 10.4.2 CloudWatch Dashboard - Customer Portal Public

**Purpose**: Monitor all Customer Portal Public services performance

```json
{
  "DashboardName": "2-1-bbws-customer-portal-public-dashboard",
  "DashboardBody": {
    "widgets": [
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/Lambda", "Invocations", {"stat": "Sum", "label": "Product Lambda"}],
            ["...", {"stat": "Sum", "label": "Campaign Lambda"}],
            ["...", {"stat": "Sum", "label": "Order Lambda"}]
          ],
          "period": 300,
          "stat": "Sum",
          "region": "af-south-1",
          "title": "Lambda Invocations",
          "yAxis": {
            "left": {
              "label": "Count"
            }
          }
        }
      },
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/Lambda", "Errors", {"stat": "Sum", "label": "Product Errors", "color": "#d62728"}],
            ["...", {"stat": "Sum", "label": "Campaign Errors", "color": "#ff7f0e"}],
            ["...", {"stat": "Sum", "label": "Order Errors", "color": "#e377c2"}]
          ],
          "period": 300,
          "stat": "Sum",
          "region": "af-south-1",
          "title": "Lambda Errors",
          "yAxis": {
            "left": {
              "label": "Errors"
            }
          }
        }
      },
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/DynamoDB", "ConsumedReadCapacityUnits", {"stat": "Sum"}],
            [".", "ConsumedWriteCapacityUnits", {"stat": "Sum"}]
          ],
          "period": 300,
          "stat": "Sum",
          "region": "af-south-1",
          "title": "DynamoDB Capacity - Customer Portal",
          "yAxis": {
            "left": {
              "label": "Units"
            }
          }
        }
      },
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/ApiGateway", "Count", {"stat": "Sum", "label": "API Requests"}],
            [".", "4XXError", {"stat": "Sum", "label": "Client Errors"}],
            [".", "5XXError", {"stat": "Sum", "label": "Server Errors"}]
          ],
          "period": 300,
          "stat": "Sum",
          "region": "af-south-1",
          "title": "API Gateway Metrics"
        }
      }
    ]
  }
}
```

#### 10.4.3 AWS Budget - DEV Environment

**Purpose**: Track monthly costs for Customer Portal Public in DEV

```json
{
  "Budget": {
    "BudgetName": "2-1-bbws-customer-portal-public-dev-budget",
    "BudgetLimit": {
      "Amount": "500",
      "Unit": "USD"
    },
    "TimeUnit": "MONTHLY",
    "BudgetType": "COST",
    "CostFilters": {
      "TagKeyValue": [
        "user:Project$2.1",
        "user:Environment$DEV",
        "user:Application$CustomerPortalPublic"
      ]
    }
  },
  "NotificationsWithSubscribers": [
    {
      "Notification": {
        "NotificationType": "ACTUAL",
        "ComparisonOperator": "GREATER_THAN",
        "Threshold": 80,
        "ThresholdType": "PERCENTAGE",
        "NotificationState": "ALARM"
      },
      "Subscribers": [
        {
          "SubscriptionType": "EMAIL",
          "Address": "devops@bigbeard.co.za"
        }
      ]
    },
    {
      "Notification": {
        "NotificationType": "FORECASTED",
        "ComparisonOperator": "GREATER_THAN",
        "Threshold": 100,
        "ThresholdType": "PERCENTAGE",
        "NotificationState": "ALARM"
      },
      "Subscribers": [
        {
          "SubscriptionType": "EMAIL",
          "Address": "finance@bigbeard.co.za"
        }
      ]
    }
  ]
}
```

#### 10.4.4 SNS Topic - Critical Alerts

**Purpose**: Notification topic for critical alerts

```json
{
  "TopicName": "2-1-bbws-critical-alerts",
  "DisplayName": "BBWS Customer Portal Critical Alerts",
  "Attributes": {
    "DeliveryPolicy": {
      "http": {
        "defaultHealthyRetryPolicy": {
          "minDelayTarget": 20,
          "maxDelayTarget": 20,
          "numRetries": 3,
          "numMaxDelayRetries": 0,
          "numNoDelayRetries": 0,
          "numMinDelayRetries": 0,
          "backoffFunction": "linear"
        }
      }
    }
  },
  "Subscriptions": [
    {
      "Protocol": "email",
      "Endpoint": "oncall@bigbeard.co.za"
    },
    {
      "Protocol": "lambda",
      "Endpoint": "arn:aws:lambda:af-south-1:536580886816:function:2-1-bbws-alert-handler"
    }
  ],
  "Tags": [
    {
      "Key": "Project",
      "Value": "2.1"
    },
    {
      "Key": "Application",
      "Value": "CustomerPortalPublic"
    },
    {
      "Key": "Environment",
      "Value": "DEV"
    }
  ]
}
```

#### 10.4.5 WAF Web ACL - API Gateway Protection

**Purpose**: Protect Customer Portal Public API Gateway from attacks

```json
{
  "Name": "2-1-bbws-customer-portal-api-waf",
  "Scope": "REGIONAL",
  "DefaultAction": {
    "Allow": {}
  },
  "Rules": [
    {
      "Name": "RateLimitAnonymousUsers",
      "Priority": 1,
      "Statement": {
        "RateBasedStatement": {
          "Limit": 2000,
          "AggregateKeyType": "IP"
        }
      },
      "Action": {
        "Block": {
          "CustomResponse": {
            "ResponseCode": 429,
            "CustomResponseBodyKey": "rate-limit-response"
          }
        }
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "RateLimitAnonymousUsers"
      }
    },
    {
      "Name": "AWSManagedRulesCommonRuleSet",
      "Priority": 2,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesCommonRuleSet",
          "ExcludedRules": []
        }
      },
      "OverrideAction": {
        "None": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "AWSManagedRulesCommonRuleSet"
      }
    },
    {
      "Name": "AWSManagedRulesKnownBadInputsRuleSet",
      "Priority": 3,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesKnownBadInputsRuleSet"
        }
      },
      "OverrideAction": {
        "None": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "AWSManagedRulesKnownBadInputsRuleSet"
      }
    }
  ],
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "2-1-bbws-customer-portal-api-waf"
  },
  "CustomResponseBodies": {
    "rate-limit-response": {
      "ContentType": "APPLICATION_JSON",
      "Content": "{\"error\":\"TooManyRequests\",\"message\":\"Rate limit exceeded. Please try again later.\"}"
    }
  },
  "Tags": [
    {
      "Key": "Project",
      "Value": "2.1"
    },
    {
      "Key": "Application",
      "Value": "CustomerPortalPublic"
    }
  ]
}
```

#### 10.4.7 Lambda Dead Letter Queue

**Purpose**: Capture failed Lambda invocations for investigation

```json
{
  "QueueName": "2-1-bbws-lambda-dlq",
  "Attributes": {
    "MessageRetentionPeriod": "1209600",
    "VisibilityTimeout": "300",
    "ReceiveMessageWaitTimeSeconds": "20",
    "MaximumMessageSize": "262144",
    "KmsMasterKeyId": "alias/aws/sqs",
    "KmsDataKeyReusePeriodSeconds": "300"
  },
  "Tags": {
    "Project": "2.1",
    "Application": "CustomerPortalPublic",
    "Purpose": "DeadLetterQueue",
    "Service": "Lambda",
    "Environment": "DEV"
  }
}
```

**Associated CloudWatch Alarm:**
```json
{
  "AlarmName": "2-1-bbws-dlq-messages-alarm",
  "AlarmDescription": "Alert when messages appear in DLQ",
  "MetricName": "ApproximateNumberOfMessagesVisible",
  "Namespace": "AWS/SQS",
  "Dimensions": [
    {
      "Name": "QueueName",
      "Value": "2-1-bbws-lambda-dlq"
    }
  ],
  "Threshold": 1,
  "ComparisonOperator": "GreaterThanOrEqualToThreshold",
  "EvaluationPeriods": 1,
  "Period": 300,
  "Statistic": "Average",
  "ActionsEnabled": true,
  "AlarmActions": [
    "arn:aws:sns:af-south-1:536580886816:2-1-bbws-critical-alerts"
  ],
  "TreatMissingData": "notBreaching"
}
```

---

## 11. Business Approval Requirements

### 11.1 Artefacts Requiring Business Approval

The following artefacts **MUST** have Business Owner (BO) approval before deployment:

| Category | Artefacts | Approval Required |
|----------|-----------|-------------------|
| **UI/UX** | All screens, layouts, components, branding | BO Sign-off |
| **Email Templates** | Registration confirmation, password reset, OTP, order confirmation, payment receipt | BO Sign-off |
| **Customer Messaging** | Error messages, success messages, notifications, tooltips | BO Sign-off |
| **Marketing Content** | Landing page copy, feature descriptions, pricing display, campaign pages | BO Sign-off |
| **Legal Content** | Terms of Service, Privacy Policy, Cookie Policy | BO + Legal Sign-off |
| **Transactional Content** | Order summaries, payment confirmations, invoice text | BO + Finance Sign-off |

### 11.2 Business Approval Process

```
┌─────────────────────────────────────────────────────────────────┐
│              BUSINESS APPROVAL PROCESS                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. DEVELOPMENT                                                 │
│     └── Dev team completes artefact                            │
│                                                                 │
│  2. DEV REVIEW                                                  │
│     └── Technical review (code quality, security)              │
│                                                                 │
│  3. STAGING DEPLOYMENT                                          │
│     └── Deploy to SIT for business review                      │
│                                                                 │
│  4. BUSINESS OWNER REVIEW                                       │
│     ├── BO reviews UI/messaging/content in SIT                 │
│     ├── BO provides feedback or approval                       │
│     └── Iterate until BO sign-off obtained                     │
│                                                                 │
│  5. PRODUCTION DEPLOYMENT                                       │
│     └── Only after BO sign-off documented                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 11.3 Sign-off Documentation

| Milestone | Sign-off Required From | Documentation |
|-----------|------------------------|---------------|
| UI Screens | Product Owner, Business Owner | JIRA ticket with BO approval comment |
| Email Templates | Business Owner, Marketing | Confluence page with approved templates |
| Customer Messaging | Business Owner, UX Lead | Messaging matrix in Confluence |
| Legal Pages | Business Owner, Legal | Legal review ticket closed |
| Go-Live | Business Owner, Tech Lead | Release sign-off form |

---

## 12. Implementation Plan

### 12.1 UI-First Development Approach

```
┌─────────────────────────────────────────────────────────────────┐
│               UI-FIRST IMPLEMENTATION FLOW                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Phase 1: UI SCREENS                                            │
│  ├── Build all 21 screens in React                             │
│  ├── Use mock data (static JSON)                               │
│  ├── Component library setup                                   │
│  └── Responsive design                                         │
│                                                                 │
│  Phase 2: API MOCKS                                             │
│  ├── MSW (Mock Service Worker) setup                           │
│  ├── JSON Server for REST endpoints                            │
│  ├── Mock all 24 endpoints                                     │
│  └── Realistic test data                                       │
│                                                                 │
│  Phase 3: PLAYBACK & PO APPROVAL                                │
│  ├── Demo to Product Owner                                     │
│  ├── User flow walkthroughs                                    │
│  ├── Gather feedback                                           │
│  └── Iterate on UI/UX                                          │
│                                                                 │
│  Phase 4: BACKEND IMPLEMENTATION                                │
│  ├── Lambda functions (Python 3.12)                            │
│  ├── DynamoDB tables                                           │
│  ├── API Gateway configuration                                 │
│  └── Per-component Terraform                                   │
│                                                                 │
│  Phase 5: INTEGRATION                                           │
│  ├── Connect frontend to real APIs                             │
│  ├── E2E testing                                               │
│  ├── PayFast integration                                       │
│  └── Production deployment                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 12.2 Milestones (with Business Owner Gates)

> **IMPORTANT**: Each milestone requires **Business Owner (BO) Review** before proceeding to the next milestone. No milestone is considered complete without documented BO sign-off.

| # | Milestone | Deliverables | Tech Review | BO Review |
|---|-----------|--------------|-------------|-----------|
| 0.1 | UI Screens | 21 React screens with mock data | Dev Review | **BO Sign-off Required** |
| 0.2 | API Mocks | MSW handlers for all endpoints | Dev Review | **Arch Sign-off Required** |
| 0.3 | Playback | Demo walkthrough, feedback collection | PO Review | **BO Approval Required** |
| 0.4 | Email Templates | All transactional email templates | Dev Review | **BO Sign-off Required** |
| 0.5 | Customer Messaging | Error/success messages, notifications | Dev Review | **BO Sign-off Required** |
| 0.6 | DynamoDB Schemas | 2_1_bbws_dynamodb_schemas + migrations | Dev Review | **Arch Sign-off Required** |
| 0.8 | Product Lambda | 2_1_bbws_product_lambda + TF | Dev Review | **Arch Sign-off Required** |
| 0.9 | Campaign Lambda | 2_1_bbws_campaign_lambda + TF | Dev Review | **Arch Sign-off Required** |
| 0.11 | Order Lambda | 2_1_bbws_order_lambda + TF | Dev Review | **Arch Sign-off Required** |
| 0.12 | Payment Lambda | 2_1_bbws_payment_lambda + TF | Dev Review | **Arch Sign-off Required** |
| 0.16 | Integration | Frontend + Backend connected | QA Review | **Qaulity Engineer Sign-off Required** |
| 0.17 | E2E Testing | Full flow tests | QA Approval | **BO and QE Sign-off Required** |
| 0.18 | UAT | User Acceptance Testing in SIT | QA Review | **BO and QE Final Approval** |
| 0.19 | Production | Live deployment | Tech Lead | **BO and QE Go-Live Sanity Test Approval** |

### 12.3 Milestone Gate Process

```
┌─────────────────────────────────────────────────────────────────┐
│              MILESTONE GATE PROCESS                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  For EACH milestone:                                            │
│                                                                 │
│  1. COMPLETE DELIVERABLES                                       │
│     └── Dev team completes all deliverables                    │
│                                                                 │
│  2. TECHNICAL REVIEW                                            │
│     └── Code review, security scan, unit tests pass            │
│                                                                 │
│  3. DEPLOY TO DEV                                               │
│     └── Deploy to DEV environment                              │
│                                                                 │
│  4. DEV TESTING                                                 │
│     └── Dev team validates in DEV                              │
│                                                                 │
│  5. DEPLOY TO SIT                                               │
│     └── Promote to SIT for BO review                           │
│                                                                 │
│  6. BUSINESS OWNER REVIEW                                       │
│     ├── BO reviews deliverables in SIT                         │
│     ├── BO provides feedback OR approval                       │
│     ├── If feedback: return to step 1                          │
│     └── If approved: document sign-off in JIRA                 │
│                                                                 │
│  7. MILESTONE COMPLETE                                          │
│     └── Proceed to next milestone                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 13. LLDs Reference

### 13.1 Parent HLD Information

| Attribute | Value |
|-----------|-------|
| HLD Document | `2.1_HLD_Customer_Portal_Public.md` |
| HLD Version | v1.3.0 |
| HLD Prefix | `2.1` |
| Total LLDs | 10 technical + 5 operational |

### 13.2 Technical LLDs (10 Documents)

Following the naming convention: `[HLD_Prefix].[LLD_Number]_LLD_[Name].md`

> **Repository Naming Convention:** All repositories follow the pattern `{HLD_Prefix}_bbws_{service}` where dots in the HLD prefix are replaced with underscores. Example: HLD `2.1` → Repository prefix `2_1`.

| LLD ID | LLD Name | Description | Repository | Status |
|--------|----------|-------------|------------|--------|
| 2.1.1 | `2.1.1_LLD_Frontend_Architecture.md` | React SPA, routing, state management | `2_1_bbws_web_public` | Draft |
| 2.1.3 | `2.1.3_LLD_Campaign_Lambda.md` | Campaign service design (CRUD operations) | `2_1_bbws_campaign_lambda` | Draft |
| 2.1.4 | `2.1.4_LLD_Product_Lambda.md` | Product service design (CRUD operations) | `2_1_bbws_product_lambda` | Draft |
| 2.1.8 | `2.1.8_LLD_Order_Lambda.md` | Order management service design | `2_1_bbws_order_lambda` | Draft |
| 2.1.9 | `2.1.9_LLD_Payment_Lambda.md` | PayFast payment integration | `2_1_bbws_payment_lambda` | Draft |

### 13.3 Operational Runbooks (5 Documents)

Following the naming convention: `[HLD_Prefix].[LLD_Number]_OPS_[Name].md`

| OPS ID | Runbook Name | Description | Status |
|--------|--------------|-------------|--------|
| 2.1.11 | `2.1.11_OPS_Deployment_Runbook.md` | Per-component deployment procedures | Draft |
| 2.1.12 | `2.1.12_OPS_Monitoring_Runbook.md` | CloudWatch dashboards and alerts | Draft |
| 2.1.13 | `2.1.13_OPS_Incident_Response_Runbook.md` | Incident and DR procedures | Draft |
| 2.1.14 | `2.1.14_OPS_Security_Runbook.md` | Security configuration and best practices | Draft |
| 2.1.15 | `2.1.15_OPS_Troubleshooting_Runbook.md` | General troubleshooting and issue resolution | Draft |

### 13.4 LLD Naming Convention

All LLDs derived from this HLD follow the hierarchical naming pattern:

**Pattern**: `[HLD_Prefix].[Sequential_Number]_[Type]_[Name].md`

**Example**:
- HLD Prefix: `2.1` (from `2.1_HLD_Customer_Portal_Public.md`)
- First LLD: `2.1.1_LLD_Frontend_Architecture.md`
- Second LLD: `2.1.2_LLD_Auth_Lambda.md`
- First OPS: `2.1.11_OPS_Deployment_Runbook.md`

This convention ensures:
- Clear parent-child relationship between HLD and LLDs
- Traceability across documentation hierarchy
- Easy navigation in document repositories
- Alignment with repository naming (e.g., `2.1.2_LLD_Auth_Lambda.md` → `2_1_bbws_auth_lambda`)

---

## 14. Appendices

### Appendix A: User Stories

| Story ID | User Story | Priority |
|----------|------------|----------|
| US-CPP-001 | As a visitor, I want to view the home page | P0 |
| US-CPP-002 | As a visitor, I want to view all products | P0 |
| US-CPP-004 | As a visitor, I want to checkout without registering | P0 |
| US-CPP-005 | As a visitor, I want to pay via PayFast | P0 |
| US-CPP-009 | As a visitor, I want to view campaign offers | P1 |

### Appendix B: Screen-to-Service Matrix

| Screen | Campaign | Product | Order | Payment |
|--------|------|----------|---------|---------|
| CPP-001 Home | - | - | - | - | - | - | - | - | - |
| CPP-012 Campaign | - | ✓ | - | - | - | - | - | - | - |
| CPP-017 Checkout | ✓ | - | - | - | - | ✓ | ✓ | - | - |
| CPP-018 Payment | - | - | - | - | - | - | ✓ | ✓ | - |

### Appendix C: Removed Endpoints (from v1.1)

| Endpoint | Reason |
|----------|--------|
| `POST /v1.0/campaigns/{code}/validate` | GET returns status/validity |
| `POST /v1.0/contact/enquiry` | /contact handles all types |
| `GET /v1.0/products/compare` | Compare functionality not needed |

---

## Related Documents

- [BBWS Customer Portal Private HLD](./BBWS_Customer_Portal_Private_HLD.md)
- [BBWS Admin Portal HLD](./BBWS_Admin_Portal_HLD.md)
- [Master Plan](/.claude/plans/twinkling-mapping-hamster.md)

---

**End of Document**
