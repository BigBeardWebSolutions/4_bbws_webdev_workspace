# HLD 2.5: Tenant Management

## High-Level Design Document

**Version**: 1.0
**Author**: Platform Architecture Team
**Date**: 2026-01-05
**Status**: Draft

---

## Document History

| Version | Date | Changes | Owner |
|---------|------|---------|-------|
| 1.0 | 2026-01-05 | Initial HLD created from BRS 2.5 | Platform Architecture |

---

## Executive Summary

### Purpose

This document provides the architectural design for the Tenant Management capability of the BBWS platform. It describes how the platform manages customer organisations (tenants) as logical entities, including their hierarchy, user assignments, and lifecycle states.

### Scope

This HLD covers the technical architecture for:
- Tenant CRUD operations (create, read, update, delete/deprovision)
- Organisation hierarchy management (Division → Group → Team)
- User-to-tenant assignments with roles
- Tenant status lifecycle (PENDING → ACTIVE → SUSPENDED → PARKED → DEPROVISIONED)
- Async integration with Instance Management for physical provisioning

### Relationship to Other Documents

| Document | Relationship |
|----------|--------------|
| **BRS 2.5** | Business requirements this architecture implements |
| **LLD 2.5** | Detailed implementation specifications |
| **HLD 2.7** | Instance Management - triggered by tenant creation for physical provisioning |
| **HLD 2.0** | Platform architecture - shared infrastructure foundation |

### Key Architectural Principle

**Logical vs Physical Separation**: Tenant Management handles **logical** tenant entities (metadata, hierarchy, users). Physical AWS resource provisioning (ECS, EFS, RDS) is handled by Instance Management (BRS 2.7). When a tenant is created:

1. Tenant Management creates the logical tenant record with status `PENDING`
2. Tenant Management publishes `START_CLUSTER_CREATION` event to SQS
3. Instance Management provisions physical resources asynchronously
4. Instance Management publishes `CLUSTER_CREATION_COMPLETE` event to SQS
5. Tenant Management updates tenant status to `ACTIVE`

---

## 1. Architecture Overview

### 1.1 Design Philosophy

| Principle | Implementation |
|-----------|----------------|
| **Logical-Physical Separation** | Tenant = metadata, Instance = AWS resources |
| **Event-Driven Integration** | SQS messages connect Tenant → Instance Management |
| **Single Table Design** | DynamoDB with access pattern-driven GSIs |
| **Serverless First** | Lambda + API Gateway + DynamoDB |

### 1.2 High-Level Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BBWS Platform                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                       Tenant Management Service                        │ │
│   │                                                                        │ │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │ │
│   │   │   Tenant    │  │  Hierarchy  │  │    User     │  │  Lifecycle  │  │ │
│   │   │   CRUD      │  │  Service    │  │ Assignment  │  │   Service   │  │ │
│   │   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  │ │
│   │          │                │                │                │         │ │
│   └──────────┼────────────────┼────────────────┼────────────────┼─────────┘ │
│              │                │                │                │           │
│              └────────────────┼────────────────┼────────────────┘           │
│                               │                │                             │
│                      ┌────────▼────────────────▼────────┐                   │
│                      │          DynamoDB Table          │                   │
│                      │      (Single Table Design)       │                   │
│                      └──────────────────────────────────┘                   │
│                                      │                                       │
│                                      │ Events                                │
│                                      ▼                                       │
│                      ┌────────────────────────────────┐                     │
│                      │        SQS Queues              │                     │
│                      │  ┌──────────────────────────┐  │                     │
│                      │  │ START_CLUSTER_CREATION   │──┼──────┐              │
│                      │  └──────────────────────────┘  │      │              │
│                      │  ┌──────────────────────────┐  │      │              │
│                      │  │ CLUSTER_CREATION_COMPLETE│◄─┼──────┼────┐         │
│                      │  └──────────────────────────┘  │      │    │         │
│                      └────────────────────────────────┘      │    │         │
│                                                              │    │         │
├──────────────────────────────────────────────────────────────┼────┼─────────┤
│                                                              │    │         │
│   ┌──────────────────────────────────────────────────────────▼────┼───────┐ │
│   │                    Instance Management Service                 │       │ │
│   │                         (HLD 2.7)                              │       │ │
│   │                                                                │       │ │
│   │   Creates: ECS Service, EFS Access Point, RDS Database,       │       │ │
│   │            ALB Target Group, Cognito User Pool                 │       │ │
│   │                                                                │       │ │
│   │   On completion: Publishes CLUSTER_CREATION_COMPLETE ─────────────────┘ │
│   └──────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 Logical-Physical Integration Flow

```
┌─────────────┐         ┌───────────┐         ┌─────────────┐
│   Tenant    │         │    SQS    │         │  Instance   │
│ Management  │         │   Queue   │         │ Management  │
└──────┬──────┘         └─────┬─────┘         └──────┬──────┘
       │                      │                      │
       │  1. Create Tenant    │                      │
       │     (PENDING)        │                      │
       │──────────────────────┤                      │
       │                      │                      │
       │  2. Publish          │                      │
       │  START_CLUSTER_      │                      │
       │  CREATION            │                      │
       │─────────────────────>│                      │
       │                      │                      │
       │  Return 201          │                      │
       │  (status: PENDING)   │                      │
       │◄─────────────────────┤                      │
       │                      │                      │
       │                      │  3. Consume message  │
       │                      │─────────────────────>│
       │                      │                      │
       │                      │  4. Provision        │
       │                      │     AWS Resources    │
       │                      │     (async)          │
       │                      │                      │
       │                      │  5. Publish          │
       │                      │  CLUSTER_CREATION_   │
       │                      │  COMPLETE            │
       │                      │◄─────────────────────│
       │                      │                      │
       │  6. Consume message  │                      │
       │◄─────────────────────│                      │
       │                      │                      │
       │  7. Update status    │                      │
       │     to ACTIVE        │                      │
       │                      │                      │
```

---

## 2. System Context

### 2.1 Context Diagram

```
                              ┌─────────────────┐
                              │    Platform     │
                              │  Admin/Operator │
                              └────────┬────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│                        BBWS Tenant Management                             │
│                                                                           │
│   ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐     │
│   │  Tenant    │   │ Hierarchy  │   │    User    │   │ Lifecycle  │     │
│   │   CRUD     │   │   Mgmt     │   │ Assignment │   │   Status   │     │
│   └────────────┘   └────────────┘   └────────────┘   └────────────┘     │
│                                                                           │
└───────────────────────────────────┬───────────────────────────────────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
            ▼                       ▼                       ▼
    ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
    │   Instance    │      │     Site      │      │    Cognito    │
    │  Management   │      │  Management   │      │   (Identity)  │
    │   (BRS 2.7)   │      │   (BRS 2.6)   │      │               │
    └───────────────┘      └───────────────┘      └───────────────┘
```

### 2.2 Integration Points

| System | Direction | Purpose |
|--------|-----------|---------|
| **Instance Management (2.7)** | Outbound → Inbound | Trigger provisioning, receive completion |
| **Site Management (2.6)** | Outbound | Provide tenant context for site operations |
| **Cognito** | Both | Validate user exists, manage tenant groups |
| **DynamoDB Streams** | Outbound | Audit events to external systems |

---

## 3. Component Architecture

### 3.1 Tenant CRUD Service

**Responsibility**: Manage core tenant entity lifecycle.

| Operation | Description | Triggers |
|-----------|-------------|----------|
| Create | New tenant organisation | SQS: START_CLUSTER_CREATION |
| Read | Get tenant by ID | None |
| Update | Modify tenant metadata | Audit event |
| Delete | Soft delete (deprovision) | SQS: START_CLUSTER_DELETION |
| List | Query tenants with filters | None |

### 3.2 Hierarchy Service

**Responsibility**: Manage organisation structure within a tenant.

| Level | Description | Parent |
|-------|-------------|--------|
| Division | Top-level business unit | Tenant |
| Group | Department or function | Division |
| Team | Working team | Group |

### 3.3 User Assignment Service

**Responsibility**: Manage user-to-tenant relationships with roles.

| Role | Capabilities |
|------|--------------|
| **Admin** | Full tenant management, user management |
| **Operator** | Tenant operations, site management |
| **Viewer** | Read-only access |

### 3.4 Lifecycle Service

**Responsibility**: Manage tenant status transitions.

| From Status | To Status | Trigger | SQS Event |
|-------------|-----------|---------|-----------|
| (new) | PENDING | Create tenant | START_CLUSTER_CREATION |
| PENDING | ACTIVE | Provisioning complete | (inbound: CLUSTER_CREATION_COMPLETE) |
| ACTIVE | SUSPENDED | Admin action | (optional: SUSPEND_CLUSTER) |
| ACTIVE | PARKED | Admin action | START_CLUSTER_PARK |
| SUSPENDED | ACTIVE | Admin action | (optional: RESUME_CLUSTER) |
| PARKED | ACTIVE | Admin action | START_CLUSTER_UNPARK |
| ANY | DEPROVISIONED | Admin action | START_CLUSTER_DELETION |

---

## 4. Key Operations

### 4.1 Tenant Creation Flow

```
┌──────────┐   ┌────────────┐   ┌──────────┐   ┌───────────┐   ┌───────────┐
│ Operator │   │ API Gateway│   │  Lambda  │   │ DynamoDB  │   │    SQS    │
└────┬─────┘   └─────┬──────┘   └────┬─────┘   └─────┬─────┘   └─────┬─────┘
     │               │               │               │               │
     │ POST /tenants │               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ Invoke Lambda │               │               │
     │               │──────────────>│               │               │
     │               │               │               │               │
     │               │               │ Validate      │               │
     │               │               │ uniqueness    │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ Create tenant │               │
     │               │               │ (PENDING)     │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ Publish       │               │
     │               │               │ START_CLUSTER_│               │
     │               │               │ CREATION      │               │
     │               │               │──────────────────────────────>│
     │               │               │               │               │
     │ 201 Created   │               │               │               │
     │ (PENDING)     │               │               │               │
     │◄──────────────│◄──────────────│               │               │
```

### 4.2 Park/Unpark Flow

```
┌──────────┐   ┌────────────┐   ┌──────────┐   ┌───────────┐   ┌───────────┐
│  Admin   │   │ API Gateway│   │  Lambda  │   │ DynamoDB  │   │    SQS    │
└────┬─────┘   └─────┬──────┘   └────┬─────┘   └─────┬─────┘   └─────┬─────┘
     │               │               │               │               │
     │ POST /park    │               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ Invoke Lambda │               │               │
     │               │──────────────>│               │               │
     │               │               │               │               │
     │               │               │ Validate      │               │
     │               │               │ ACTIVE status │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ Update to     │               │
     │               │               │ PARKING       │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ Publish       │               │
     │               │               │ START_CLUSTER_│               │
     │               │               │ PARK          │               │
     │               │               │──────────────────────────────>│
     │               │               │               │               │
     │ 202 Accepted  │               │               │               │
     │◄──────────────│◄──────────────│               │               │
     │               │               │               │               │
     │               │               │               │               │
     │    ... Instance Management parks resources ...│               │
     │               │               │               │               │
     │               │               │ Consume       │               │
     │               │               │ CLUSTER_PARK_ │               │
     │               │               │ COMPLETE      │               │
     │               │               │◄──────────────────────────────│
     │               │               │               │               │
     │               │               │ Update to     │               │
     │               │               │ PARKED        │               │
     │               │               │──────────────>│               │
```

### 4.3 User Assignment Flow

```
┌──────────┐   ┌────────────┐   ┌──────────┐   ┌───────────┐   ┌───────────┐
│  Admin   │   │ API Gateway│   │  Lambda  │   │ DynamoDB  │   │  Cognito  │
└────┬─────┘   └─────┬──────┘   └────┬─────┘   └─────┬─────┘   └─────┬─────┘
     │               │               │               │               │
     │POST /users    │               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ Invoke Lambda │               │               │
     │               │──────────────>│               │               │
     │               │               │               │               │
     │               │               │ Validate user │               │
     │               │               │ exists        │               │
     │               │               │──────────────────────────────>│
     │               │               │               │               │
     │               │               │ Create        │               │
     │               │               │ assignment    │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ Add to        │               │
     │               │               │ tenant group  │               │
     │               │               │──────────────────────────────>│
     │               │               │               │               │
     │ 201 Created   │               │               │               │
     │◄──────────────│◄──────────────│               │               │
```

---

## 5. State Management

### 5.1 Tenant Status State Machine

```
                        ┌─────────────┐
                        │   (new)     │
                        └──────┬──────┘
                               │ Create
                               ▼
                        ┌─────────────┐
                        │   PENDING   │
                        └──────┬──────┘
                               │ Provisioning complete
                               ▼
     ┌──────────────────┬─────────────┬──────────────────┐
     │                  │   ACTIVE    │                  │
     │                  └──────┬──────┘                  │
     │                         │                         │
     │ Suspend                 │ Park                    │ Deprovision
     ▼                         ▼                         ▼
┌─────────────┐         ┌─────────────┐         ┌──────────────┐
│  SUSPENDED  │         │   PARKED    │         │DEPROVISIONED │
└──────┬──────┘         └──────┬──────┘         └──────────────┘
       │                       │                   (terminal)
       │ Reactivate            │ Unpark
       └───────────────────────┴─────────────────────┐
                                                     │
                                                     ▼
                                              ┌─────────────┐
                                              │   ACTIVE    │
                                              └─────────────┘
```

### 5.2 Status Definitions

| Status | Description | Resources |
|--------|-------------|-----------|
| **PENDING** | Logical tenant created, awaiting physical provisioning | None |
| **ACTIVE** | Fully operational, resources running | All provisioned |
| **SUSPENDED** | Temporarily disabled, resources paused | Resources exist but stopped |
| **PARKED** | Long-term inactive, resources released | Data archived, compute released |
| **DEPROVISIONED** | Permanently removed | None (archived) |

---

## 6. Data Architecture

### 6.1 DynamoDB Single Table Design

| Entity | PK Pattern | SK Pattern | Purpose |
|--------|------------|------------|---------|
| Tenant | `TENANT#{tenantId}` | `METADATA` | Core tenant data |
| Tenant Audit | `TENANT#{tenantId}` | `EVENT#{timestamp}#{eventId}` | Audit trail |
| Hierarchy | `TENANT#{tenantId}` | `HIER#{level}#{id}` | Org structure |
| User Assignment | `TENANT#{tenantId}` | `USER#{userId}` | User membership |
| User Tenants | `USER#{userId}` | `TENANT#{tenantId}` | Reverse lookup |

### 6.2 Global Secondary Indexes

| GSI | PK | SK | Access Pattern |
|-----|----|----|----------------|
| GSI1 | `GSI1PK` (ORG#{name}) | `GSI1SK` | Find by org name (uniqueness) |
| GSI2 | `GSI2PK` (STATUS#{status}) | `GSI2SK` (createdAt) | List by status |
| GSI3 | `GSI3PK` (USER#{userId}) | `GSI3SK` | Get user's tenants |

### 6.3 Event Schema

```
SQS Message: START_CLUSTER_CREATION
{
  "eventType": "START_CLUSTER_CREATION",
  "tenantId": "tenant-{uuid}",
  "timestamp": "2026-01-05T10:00:00Z",
  "organizationName": "Example Corp",
  "contactEmail": "admin@example.com",
  "requestedBy": "operator@bbws.com"
}

SQS Message: CLUSTER_CREATION_COMPLETE
{
  "eventType": "CLUSTER_CREATION_COMPLETE",
  "tenantId": "tenant-{uuid}",
  "timestamp": "2026-01-05T10:12:00Z",
  "status": "SUCCESS",
  "resources": {
    "ecsServiceArn": "arn:aws:ecs:...",
    "efsAccessPointId": "fsap-...",
    "cognitoUserPoolId": "af-south-1_xxx"
  }
}
```

---

## 7. Non-Functional Requirements

### 7.1 Performance

| Metric | Target | Rationale |
|--------|--------|-----------|
| API Response Time | < 200ms P95 | User experience |
| Tenant Creation (API) | < 500ms | Immediate acknowledgement |
| Full Provisioning | < 15 minutes | End-to-end including physical |
| Status Update | < 100ms | Real-time visibility |

### 7.2 Availability

| Metric | Target | Rationale |
|--------|--------|-----------|
| API Availability | 99.9% | Business-critical operations |
| Data Durability | 99.999999999% | DynamoDB standard |
| Message Durability | 99.999999999% | SQS standard |

### 7.3 Scalability

| Dimension | Target | Approach |
|-----------|--------|----------|
| Total Tenants | 1000+ | DynamoDB auto-scaling |
| Concurrent API Calls | 100/second | Lambda concurrency |
| Users per Tenant | 1000+ | Efficient partition design |

---

## 8. Security Architecture

### 8.1 Authentication & Authorization

| Component | Mechanism |
|-----------|-----------|
| API Authentication | Cognito JWT tokens |
| Authorization | Role-based (Admin, Operator, Viewer) |
| Tenant Scoping | JWT claims include tenant assignments |
| Service-to-Service | IAM roles for Lambda-to-SQS |

### 8.2 Data Protection

| Data Type | Protection |
|-----------|------------|
| At Rest | DynamoDB encryption (KMS) |
| In Transit | TLS 1.2+ |
| Credentials | No credentials stored (Cognito handles auth) |
| PII | Contact email encrypted at rest |

### 8.3 Tenant Isolation

| Layer | Mechanism |
|-------|-----------|
| API | JWT claims enforce tenant scope |
| Data | Partition key includes tenant ID |
| Audit | All operations logged with tenant context |

---

## 9. Technology Decisions

### 9.1 Technology Stack

| Component | Technology | Rationale |
|-----------|------------|-----------|
| API Layer | API Gateway + Lambda | Serverless, auto-scaling |
| Data Store | DynamoDB | Serverless, fast, single-table design |
| Async Messaging | SQS | Reliable, serverless queuing |
| Identity | Cognito | Managed user pools, JWT |
| Audit | DynamoDB Streams | Real-time event capture |

### 9.2 Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Data Model | Single Table Design | Efficient access patterns, reduced latency |
| Provisioning Trigger | SQS | Decoupled, reliable, retryable |
| Status Completion | SQS callback | Async completion notification |
| Tenant Scope | JWT Claims | Stateless authorization |

---

## 10. Constraints

| Constraint | Impact | Mitigation |
|------------|--------|------------|
| DynamoDB Item Size | 400KB limit | Large data in S3, reference in DDB |
| SQS Message Size | 256KB limit | Large payloads in S3 |
| Lambda Timeout | 15 minutes max | Step Functions for long processes |
| Cognito Groups | 10,000 per user pool | Multiple pools if needed |

---

## 11. References

| Document | Path |
|----------|------|
| BRS 2.5: Tenant Management | `BRS/2.5_BRS_Tenant_Management.md` |
| LLD 2.5: Tenant Management | `LLDs/2.5_LLD_Tenant_Management.md` |
| HLD 2.0: BBWS ECS WordPress | `HLDs/2.0_BBWS_ECS_WordPress_HLD.md` |
| HLD 2.7: WordPress Instance Management | `HLDs/2.7_HLD_WordPress_Instance_Management.md` |
| Tenant API OpenAPI Spec | `LLDs/openapi/tenant_api_openapi.yaml` |

---

**End of Document**
