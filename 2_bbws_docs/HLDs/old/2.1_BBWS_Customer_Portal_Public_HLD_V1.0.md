# BBWS Customer Portal (Public) - High-Level Design

**Version**: 1.3.5
**Created**: 2025-12-14
**Status**: Draft
**Document Type**: High-Level Design (HLD)
**Application**: Customer Portal (Public)
**Phase**: 0 (First to Market)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-14 | Agentic Architect | Initial version |
| 1.1 | 2025-12-14 | Agentic Architect | Python 3.12 runtime, simplified naming, e-commerce features |
| 1.2 | 2025-12-14 | Agentic Architect | Anonymous shopping, tenant-based cart/order, repo naming, per-component TF, UI-first milestones |
| 1.2.1 | 2025-12-14 | Agentic Architect | Cart type (UNREGISTERED/REGISTERED), Order/Payment always require TENANT#, tenant merge note, API base URL without version |
| 1.2.2 | 2025-12-14 | Agentic Architect | Soft delete pattern (active boolean), removed DELETE operations, cart merge association |
| 1.2.3 | 2025-12-14 | Agentic Architect | Added DynamoDB schemas repo, business approval gates for UI/messaging, BO review per milestone |
| 1.2.4 | 2025-12-14 | Agentic Architect | Added missing Invitation Lambda LLD to Section 13 |
| 1.2.5 | 2025-12-17 | HLD Architect | Updated LLD naming convention to hierarchical pattern (2.1.X_LLD_Name.md), added repository mapping, added OPS runbook naming |
| 1.2.6 | 2025-12-17 | HLD Architect | Updated repository names to include HLD prefix with underscore convention (2_bbws_* → 2_1_bbws_*) for traceability |
| 1.2.7 | 2025-12-19 | HLD Architect | Added Campaign Manager with full CRUD operations, Product CRUD operations, all entities now have id field, updated Campaign entity with required fields (code, description, discountPercentage, productId, termsConditionsLink, fromDate, toDate) |
| 1.2.8 | 2025-12-19 | HLD Architect | Added Operations Repository JSON configuration examples (Section 10.4): CloudWatch alarms/dashboards, AWS budgets, SNS topics, WAF rules, EventBridge rules, DLQ configuration |
| 1.2.9 | 2025-12-19 | HLD Architect | Added comprehensive JSON payload examples to all HATEOAS operations: Product (5.2), Campaign (5.3), Order (5.4) with request/response examples for all CRUD operations |
| 1.3.0 | 2025-12-19 | HLD Architect | Standardized field names across all entities: created_at→dateCreated, updated_at→dateLastUpdated, added lastUpdatedBy field to Product, Campaign, and Order JSON objects |
| 1.3.1 | 2025-12-19 | HLD Architect | Updated pagination pattern: replaced limit/next_token with pageSize/startAt, added moreAvailable boolean to all list operation responses |
| 1.3.2 | 2025-12-19 | HLD Architect | Added architectural decisions to Key Decisions section: Hierarchical HATEOAS API structure, pagination pattern, and Activatable Entity Pattern |
| 1.3.3 | 2025-12-19 | HLD Architect | Converted all field names from snake_case to camelCase: billingCycle, discountPercentage, productId, termsConditionsLink, fromDate, toDate, includeInactive, validOnly, customerEmail, billingAddress, postalCode, paymentMethod, campaignCode, tenantId, unitPrice, itemsCount, paymentDetails, payfastPaymentId, paidAt, cancellationReason, expiresAt, subscribedAt, entityType, orderId. Updated DynamoDB schema and GSI definitions to match camelCase convention |
| 1.3.4 | 2025-12-19 | HLD Architect | Added campaignId field to Order entity to properly reference Campaign by ID (in addition to campaignCode). Updated all Order JSON examples and DynamoDB schema. Order now has explicit references to both Product (via items[].productId) and Campaign (via campaignId) |
| 1.3.5 | 2025-12-19 | HLD Architect | Embedded full Campaign object into Order responses (denormalization for read performance). Order now returns complete campaign details including id, code, description, discountPercentage, productId, termsConditionsLink, fromDate, toDate, isValid. Request still uses campaignCode, backend enriches with full object |

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Application Overview](#2-application-overview)
3. [Screens](#3-screens)
4. [Microservices](#4-microservices)
5. [API Endpoints](#5-api-endpoints)
6. [Authentication](#6-authentication)
7. [Anonymous Shopping](#7-anonymous-shopping)
8. [DynamoDB Schema](#8-dynamodb-schema)
9. [Infrastructure](#9-infrastructure)
10. [Repositories](#10-repositories)
11. [Business Approval Requirements](#11-business-approval-requirements)
12. [Implementation Plan](#12-implementation-plan)
13. [LLDs Reference](#13-llds-reference)
14. [Appendices](#14-appendices)

---

## 1. Executive Summary

### 1.1 Purpose

The BBWS Customer Portal (Public) is the public-facing website for marketing, pricing, registration, and anonymous shopping. It allows visitors to browse products, add items to cart, and complete purchases without mandatory registration.

### 1.2 Business Value

- **First Impression**: Professional landing pages
- **Conversion Funnel**: Marketing → Pricing → Cart → Checkout
- **Anonymous Shopping**: Purchase without registration barrier
- **Lead Generation**: Newsletter subscriptions, contact forms
- **SEO Optimized**: Public content for search engines

### 1.3 Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Backend | Lambda (Python 3.12) | Serverless, pay-per-use, team expertise |
| Anonymous Shopping | Cookie-based ID | Lower friction, higher conversion |
| Tenant Creation | Auto on checkout | Email-based, OTP verification |
| Infrastructure | Per-component Terraform | Independent deployment, isolation |
| Development | UI-first + API mocks | Faster feedback, PO approval early |
| Data Deletion | Soft delete (active=false) | Audit trail, recovery, data integrity |
| API Pattern | No DELETE operations | Status updates for all state changes |
| API Structure | Hierarchical HATEOAS | URLs reflect entity relationships, explicit ownership context |
| Pagination | pageSize/startAt/moreAvailable | Client-friendly, simpler than limit/next_token |
| Entity Pattern | Activatable Entity Pattern | All entities: id, dateCreated, dateLastUpdated, lastUpdatedBy, active |

---

## 2. Application Overview

### 2.1 Application Definition

| Attribute | Value |
|-----------|-------|
| **HLD File** | `BBWS_Customer_Portal_Public_HLD.md` |
| **URL (PROD)** | `https://kimmyai.io` |
| **URL (SIT)** | `https://sit.kimmyai.io` |
| **URL (DEV)** | `https://dev.kimmyai.io` |
| **API Base (PROD)** | `https://api.kimmyai.io` |
| **API Base (SIT)** | `https://sit.api.kimmyai.io` |
| **API Base (DEV)** | `https://dev.api.kimmyai.io` |
| **Authentication** | None (public) + Cognito (login/register) |
| **Target Users** | Prospects, new customers, anonymous shoppers |
| **Priority** | Phase 0 (First to Market) |

### 2.2 Scope

**In Scope:**
- Landing pages (home, features, pricing, about, contact)
- Marketing pages (campaigns, offers)
- Pricing display (all products)
- Registration flow
- Login page (redirects to Private portal)
- Password reset
- Email verification
- Anonymous shopping cart
- Checkout flow (anonymous + registered)
- Payment processing
- Newsletter subscription
- Contact forms

**Out of Scope:**
- Authenticated dashboard (Private Portal)
- Site management (Private Portal)
- Admin functions (Admin Portal)

---

## 3. Screens

### 3.1 Screen Summary (21 Total)

| Category | Screens | Count |
|----------|---------|-------|
| Marketing | CPP-001 to CPP-005 | 5 |
| Auth | CPP-006 to CPP-011 | 6 |
| Campaign | CPP-012 | 1 |
| Legal | CPP-013 to CPP-015 | 3 |
| Shopping | CPP-016 to CPP-021 | 6 |
| **Total** | | **21** |

### 3.2 Screen List

#### Marketing Screens (5)

| # | Screen ID | Screen Name | Description |
|---|-----------|-------------|-------------|
| 1 | CPP-001 | Home | Landing page |
| 2 | CPP-002 | Features | Feature overview |
| 3 | CPP-003 | Pricing | All products on offer |
| 4 | CPP-004 | About | Company info |
| 5 | CPP-005 | Contact | Contact form (all types) |

#### Auth Screens (6)

| # | Screen ID | Screen Name | Description |
|---|-----------|-------------|-------------|
| 6 | CPP-006 | Register | Customer registration |
| 7 | CPP-007 | Login | Login form |
| 8 | CPP-008 | Forgot Password | Password reset request |
| 9 | CPP-009 | Reset Password | Set new password |
| 10 | CPP-010 | Verify Email | Email verification |
| 11 | CPP-011 | Accept Invitation | Accept org/tenant invite |

#### Campaign Screens (1)

| # | Screen ID | Screen Name | Description |
|---|-----------|-------------|-------------|
| 12 | CPP-012 | Campaign Landing | Promo campaign page (with status/validity) |

#### Legal Screens (3)

| # | Screen ID | Screen Name | Description |
|---|-----------|-------------|-------------|
| 13 | CPP-013 | Terms of Service | Legal terms |
| 14 | CPP-014 | Privacy Policy | Privacy policy |
| 15 | CPP-015 | Cookie Policy | Cookie consent |

#### Shopping Screens (6)

| # | Screen ID | Screen Name | Description |
|---|-----------|-------------|-------------|
| 16 | CPP-016 | Shopping Cart | View/edit cart (anonymous + logged-in) |
| 17 | CPP-017 | Checkout | Order details, email capture |
| 18 | CPP-018 | Payment | PayFast payment |
| 19 | CPP-019 | Order Confirmation | Success page |
| 20 | CPP-020 | Payment Failed | Retry options |
| 21 | CPP-021 | Newsletter Subscribe | Newsletter signup |

---

## 4. Microservices

### 4.1 Service Overview (3 Total)

| # | Service | Repository | API Prefix | Functions | Description |
|---|---------|------------|------------|-----------|-------------|
| 1 | Product Service | `2_1_bbws_product_lambda` | `/v1.0/products` | 5 | Product management |
| 2 | Order Service | `2_1_bbws_order_lambda` | `/v1.0/tenants/*/orders/*` | 4 | Order management |
| 3 | Campaign Service | `2_1_bbws_campaign_lambda` | `/v1.0/campaigns` | 5 | Campaign management |

### 4.2 Lambda Function Count

| Service | Functions | Total |
|---------|-----------|-------|
| Product | create-product, get-product, update-product, list-products, soft-delete-product | 5 |
| Order | create-order, get-order, list-orders, update-order | 4 |
| Campaign | create-campaign, get-campaign, update-campaign, list-campaigns, soft-delete-campaign | 5 |
| **Total** | | **14** |

### 4.3 Lambda Configuration

| Setting | Value |
|---------|-------|
| Runtime | Python 3.12 |
| Memory | 256MB |
| Timeout | 30s |
| Architecture | arm64 |

---

## 5. API Endpoints

### 5.1 API Structure

**Base URL (PROD)**: `https://api.kimmyai.io`
**Base URL (SIT)**: `https://sit.api.kimmyai.io`
**Base URL (DEV)**: `https://dev.api.kimmyai.io`

> **Note**: API version (`/v1.0`) is included in each endpoint path, not the base URL.

### 5.2 HATEOAS Operations: Product

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/products` | Create a new product |
| GET | `/v1.0/products/{productId}` | Get product details |
| GET | `/v1.0/products` | List all products (active only by default, use `?includeInactive=true` for all) |
| PUT | `/v1.0/products/{productId}` | Update product details |
| PUT | `/v1.0/products/{productId}` | Soft delete product (set active=false) |

#### 5.2.1 POST `/v1.0/products` - Create Product

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "name": "WordPress Professional Plan",
  "description": "Professional WordPress hosting with advanced features",
  "price": 299.99,
  "features": [
    "Up to 10 WordPress sites",
    "100GB storage",
    "Unlimited bandwidth",
    "Daily backups",
    "Priority support"
  ],
  "billingCycle": "monthly"
}
```

**Success Response (201 Created):**
```json
{
  "id": "prod_550e8400-e29b-41d4-a716-446655440000",
  "name": "WordPress Professional Plan",
  "description": "Professional WordPress hosting with advanced features",
  "price": 299.99,
  "features": [
    "Up to 10 WordPress sites",
    "100GB storage",
    "Unlimited bandwidth",
    "Daily backups",
    "Priority support"
  ],
  "billingCycle": "monthly",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:30:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Invalid product data",
  "details": [
    {
      "field": "price",
      "message": "Price must be a positive number"
    }
  ]
}
```

#### 5.2.2 GET `/v1.0/products/{productId}` - Get Product

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Success Response (200 OK):**
```json
{
  "id": "prod_550e8400-e29b-41d4-a716-446655440000",
  "name": "WordPress Professional Plan",
  "description": "Professional WordPress hosting with advanced features",
  "price": 299.99,
  "features": [
    "Up to 10 WordPress sites",
    "100GB storage",
    "Unlimited bandwidth",
    "Daily backups",
    "Priority support"
  ],
  "billingCycle": "monthly",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:30:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Product with id 'prod_550e8400-e29b-41d4-a716-446655440000' not found"
}
```

#### 5.2.3 GET `/v1.0/products` - List Products

**Query Parameters:**
- `includeInactive` (boolean, optional): Include soft-deleted products. Default: `false`
- `pageSize` (integer, optional): Number of items to return per page. Default: `50`, Max: `100`
- `startAt` (string, optional): Pagination token to start at a specific position

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Success Response (200 OK):**
```json
{
  "items": [
    {
      "id": "prod_550e8400-e29b-41d4-a716-446655440000",
      "name": "WordPress Professional Plan",
      "description": "Professional WordPress hosting with advanced features",
      "price": 299.99,
      "billingCycle": "monthly",
      "dateCreated": "2025-12-19T10:30:00Z",
      "dateLastUpdated": "2025-12-19T10:30:00Z",
      "lastUpdatedBy": "admin@kimmyai.io",
      "active": true
    },
    {
      "id": "prod_660e8400-e29b-41d4-a716-446655440001",
      "name": "WordPress Starter Plan",
      "description": "Basic WordPress hosting for small websites",
      "price": 99.99,
      "billingCycle": "monthly",
      "dateCreated": "2025-12-19T09:00:00Z",
      "dateLastUpdated": "2025-12-19T09:00:00Z",
      "lastUpdatedBy": "admin@kimmyai.io",
      "active": true
    }
  ],
  "startAt": "prod_660e8400-e29b-41d4-a716-446655440001",
  "moreAvailable": false
}
```

#### 5.2.4 PUT `/v1.0/products/{productId}` - Update Product

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "price": 279.99,
  "description": "Professional WordPress hosting with advanced features - Special offer!"
}
```

**Success Response (200 OK):**
```json
{
  "id": "prod_550e8400-e29b-41d4-a716-446655440000",
  "name": "WordPress Professional Plan",
  "description": "Professional WordPress hosting with advanced features - Special offer!",
  "price": 279.99,
  "features": [
    "Up to 10 WordPress sites",
    "100GB storage",
    "Unlimited bandwidth",
    "Daily backups",
    "Priority support"
  ],
  "billingCycle": "monthly",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T14:00:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

#### 5.2.5 PUT `/v1.0/products/{productId}` - Soft Delete Product

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "active": false
}
```

**Success Response (200 OK):**
```json
{
  "id": "prod_550e8400-e29b-41d4-a716-446655440000",
  "name": "WordPress Professional Plan",
  "description": "Professional WordPress hosting with advanced features",
  "price": 279.99,
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T15:00:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": false
}
```

### 5.3 HATEOAS Operations: Campaign

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/campaigns` | Create a new campaign |
| GET | `/v1.0/campaigns/{code}` | Get campaign details by code |
| GET | `/v1.0/campaigns` | List all campaigns (active only by default, use `?includeInactive=true` for all) |
| PUT | `/v1.0/campaigns/{code}` | Update campaign details |
| PUT | `/v1.0/campaigns/{code}` | Soft delete campaign (set active=false) |

#### 5.3.1 POST `/v1.0/campaigns` - Create Campaign

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "code": "SUMMER2025",
  "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
  "discountPercentage": 20.0,
  "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
  "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
  "fromDate": "2025-06-01",
  "toDate": "2025-08-31"
}
```

**Success Response (201 Created):**
```json
{
  "id": "camp_770e8400-e29b-41d4-a716-446655440002",
  "code": "SUMMER2025",
  "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
  "discountPercentage": 20.0,
  "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
  "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
  "fromDate": "2025-06-01",
  "toDate": "2025-08-31",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:30:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Invalid campaign data",
  "details": [
    {
      "field": "discountPercentage",
      "message": "Discount percentage must be between 0 and 100"
    },
    {
      "field": "fromDate",
      "message": "From date must be before to date"
    }
  ]
}
```

**Error Response (409 Conflict):**
```json
{
  "error": "ConflictError",
  "message": "Campaign with code 'SUMMER2025' already exists"
}
```

#### 5.3.2 GET `/v1.0/campaigns/{code}` - Get Campaign

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Success Response (200 OK):**
```json
{
  "id": "camp_770e8400-e29b-41d4-a716-446655440002",
  "code": "SUMMER2025",
  "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
  "discountPercentage": 20.0,
  "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
  "productName": "WordPress Professional Plan",
  "originalPrice": 299.99,
  "discountedPrice": 239.99,
  "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
  "fromDate": "2025-06-01",
  "toDate": "2025-08-31",
  "isValid": true,
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:30:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Campaign with code 'SUMMER2025' not found"
}
```

#### 5.3.3 GET `/v1.0/campaigns` - List Campaigns

**Query Parameters:**
- `includeInactive` (boolean, optional): Include soft-deleted campaigns. Default: `false`
- `validOnly` (boolean, optional): Only return campaigns valid today. Default: `false`
- `productId` (string, optional): Filter by product ID
- `pageSize` (integer, optional): Number of items to return per page. Default: `50`, Max: `100`
- `startAt` (string, optional): Pagination token to start at a specific position

**Request Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Success Response (200 OK):**
```json
{
  "items": [
    {
      "id": "camp_770e8400-e29b-41d4-a716-446655440002",
      "code": "SUMMER2025",
      "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
      "discountPercentage": 20.0,
      "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
      "productName": "WordPress Professional Plan",
      "fromDate": "2025-06-01",
      "toDate": "2025-08-31",
      "isValid": false,
      "dateCreated": "2025-12-19T10:30:00Z",
      "dateLastUpdated": "2025-12-19T10:30:00Z",
      "lastUpdatedBy": "admin@kimmyai.io",
      "active": true
    },
    {
      "id": "camp_880e8400-e29b-41d4-a716-446655440003",
      "code": "NEWYEAR2025",
      "description": "New Year 2025 - 30% off all plans",
      "discountPercentage": 30.0,
      "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
      "productName": "WordPress Professional Plan",
      "fromDate": "2025-01-01",
      "toDate": "2025-01-31",
      "isValid": false,
      "dateCreated": "2025-12-15T08:00:00Z",
      "dateLastUpdated": "2025-12-15T08:00:00Z",
      "lastUpdatedBy": "admin@kimmyai.io",
      "active": true
    }
  ],
  "startAt": "camp_880e8400-e29b-41d4-a716-446655440003",
  "moreAvailable": false
}
```

#### 5.3.4 PUT `/v1.0/campaigns/{code}` - Update Campaign

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "discountPercentage": 25.0,
  "description": "Summer 2025 Extended Offer - 25% off all WordPress plans",
  "toDate": "2025-09-15"
}
```

**Success Response (200 OK):**
```json
{
  "id": "camp_770e8400-e29b-41d4-a716-446655440002",
  "code": "SUMMER2025",
  "description": "Summer 2025 Extended Offer - 25% off all WordPress plans",
  "discountPercentage": 25.0,
  "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
  "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
  "fromDate": "2025-06-01",
  "toDate": "2025-09-15",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T16:00:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": true
}
```

#### 5.3.5 PUT `/v1.0/campaigns/{code}` - Soft Delete Campaign

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <admin-token>"
}
```

**Request Body:**
```json
{
  "active": false
}
```

**Success Response (200 OK):**
```json
{
  "id": "camp_770e8400-e29b-41d4-a716-446655440002",
  "code": "SUMMER2025",
  "description": "Summer 2025 Extended Offer - 25% off all WordPress plans",
  "discountPercentage": 25.0,
  "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T17:00:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": false
}
```

### 5.4 HATEOAS Operations: Order

Orders are always associated with a tenant (auto-created for anonymous).

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/tenants/{tenantId}/orders` | Create order from cart |
| GET | `/v1.0/tenants/{tenantId}/orders` | List orders (active only by default) |
| GET | `/v1.0/orders/{orderId}` | Get order details |
| PUT | `/v1.0/orders/{orderId}` | Update order (status=CANCELLED or active=false) |

#### 5.4.1 POST `/v1.0/tenants/{tenantId}/orders` - Create Order

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Request Body:**
```json
{
  "cartId": "cart_990e8400-e29b-41d4-a716-446655440004",
  "customerEmail": "customer@example.com",
  "billingAddress": {
    "street": "123 Main Street",
    "city": "Cape Town",
    "province": "Western Cape",
    "postalCode": "8001",
    "country": "ZA"
  },
  "paymentMethod": "payfast",
  "campaignCode": "SUMMER2025"
}
```

**Success Response (201 Created):**
```json
{
  "id": "order_aa0e8400-e29b-41d4-a716-446655440005",
  "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
  "customerEmail": "customer@example.com",
  "status": "PENDING_PAYMENT",
  "items": [
    {
      "id": "item_cc0e8400-e29b-41d4-a716-446655440007",
      "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
      "productName": "WordPress Professional Plan",
      "quantity": 1,
      "unitPrice": 299.99,
      "discount": 60.00,
      "subtotal": 239.99,
      "dateCreated": "2025-12-19T10:30:00Z",
      "dateLastUpdated": "2025-12-19T10:30:00Z",
      "lastUpdatedBy": "system",
      "active": true
    }
  ],
  "subtotal": 239.99,
  "tax": 35.99,
  "total": 275.98,
  "currency": "ZAR",
  "campaign": {
    "id": "camp_770e8400-e29b-41d4-a716-446655440002",
    "code": "SUMMER2025",
    "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
    "discountPercentage": 20.0,
    "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
    "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
    "fromDate": "2025-06-01",
    "toDate": "2025-08-31",
    "isValid": true,
    "dateCreated": "2025-12-19T10:30:00Z",
    "dateLastUpdated": "2025-12-19T10:30:00Z",
    "lastUpdatedBy": "admin@kimmyai.io",
    "active": true
  },
  "billingAddress": {
    "street": "123 Main Street",
    "city": "Cape Town",
    "province": "Western Cape",
    "postalCode": "8001",
    "country": "ZA"
  },
  "paymentMethod": "payfast",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:30:00Z",
  "lastUpdatedBy": "customer@example.com",
  "active": true
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Invalid order data",
  "details": [
    {
      "field": "customerEmail",
      "message": "Valid email address is required"
    }
  ]
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Cart with id 'cart_990e8400-e29b-41d4-a716-446655440004' not found or is empty"
}
```

#### 5.4.2 GET `/v1.0/tenants/{tenantId}/orders` - List Tenant Orders

**Query Parameters:**
- `includeInactive` (boolean, optional): Include soft-deleted orders. Default: `false`
- `status` (string, optional): Filter by order status. Values: `PENDING_PAYMENT`, `PAID`, `PROCESSING`, `COMPLETED`, `CANCELLED`, `REFUNDED`
- `pageSize` (integer, optional): Number of items to return per page. Default: `50`, Max: `100`
- `startAt` (string, optional): Pagination token to start at a specific position

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Success Response (200 OK):**
```json
{
  "items": [
    {
      "id": "order_aa0e8400-e29b-41d4-a716-446655440005",
      "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
      "customerEmail": "customer@example.com",
      "status": "PAID",
      "total": 275.98,
      "currency": "ZAR",
      "itemsCount": 1,
      "dateCreated": "2025-12-19T10:30:00Z",
      "dateLastUpdated": "2025-12-19T10:45:00Z",
      "lastUpdatedBy": "system",
      "active": true
    },
    {
      "id": "order_dd0e8400-e29b-41d4-a716-446655440008",
      "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
      "customerEmail": "customer@example.com",
      "status": "COMPLETED",
      "total": 99.99,
      "currency": "ZAR",
      "itemsCount": 1,
      "dateCreated": "2025-11-15T08:00:00Z",
      "dateLastUpdated": "2025-11-15T09:00:00Z",
      "lastUpdatedBy": "system",
      "active": true
    }
  ],
  "startAt": "order_dd0e8400-e29b-41d4-a716-446655440008",
  "moreAvailable": false
}
```

#### 5.4.3 GET `/v1.0/orders/{orderId}` - Get Order Details

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Success Response (200 OK):**
```json
{
  "id": "order_aa0e8400-e29b-41d4-a716-446655440005",
  "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
  "customerEmail": "customer@example.com",
  "status": "PAID",
  "items": [
    {
      "id": "item_cc0e8400-e29b-41d4-a716-446655440007",
      "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
      "productName": "WordPress Professional Plan",
      "quantity": 1,
      "unitPrice": 299.99,
      "discount": 60.00,
      "subtotal": 239.99,
      "dateCreated": "2025-12-19T10:30:00Z",
      "dateLastUpdated": "2025-12-19T10:30:00Z",
      "lastUpdatedBy": "system",
      "active": true
    }
  ],
  "subtotal": 239.99,
  "tax": 35.99,
  "total": 275.98,
  "currency": "ZAR",
  "campaign": {
    "id": "camp_770e8400-e29b-41d4-a716-446655440002",
    "code": "SUMMER2025",
    "description": "Summer 2025 Special Offer - 20% off all WordPress plans",
    "discountPercentage": 20.0,
    "productId": "prod_550e8400-e29b-41d4-a716-446655440000",
    "termsConditionsLink": "https://kimmyai.io/terms/campaigns/summer2025",
    "fromDate": "2025-06-01",
    "toDate": "2025-08-31",
    "isValid": true,
    "dateCreated": "2025-12-19T10:30:00Z",
    "dateLastUpdated": "2025-12-19T10:30:00Z",
    "lastUpdatedBy": "admin@kimmyai.io",
    "active": true
  },
  "billingAddress": {
    "street": "123 Main Street",
    "city": "Cape Town",
    "province": "Western Cape",
    "postalCode": "8001",
    "country": "ZA"
  },
  "paymentMethod": "payfast",
  "paymentDetails": {
    "paymentId": "payment_ee0e8400-e29b-41d4-a716-446655440009",
    "payfastPaymentId": "1234567",
    "status": "COMPLETED",
    "paidAt": "2025-12-19T10:45:00Z"
  },
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T10:45:00Z",
  "lastUpdatedBy": "system",
  "active": true
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "NotFound",
  "message": "Order with id 'order_aa0e8400-e29b-41d4-a716-446655440005' not found"
}
```

**Error Response (403 Forbidden):**
```json
{
  "error": "Forbidden",
  "message": "You do not have permission to access this order"
}
```

#### 5.4.4 PUT `/v1.0/orders/{orderId}` - Update Order

**Request Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <token>"
}
```

**Request Body (Cancel Order):**
```json
{
  "status": "CANCELLED",
  "cancellationReason": "Customer requested cancellation"
}
```

**Success Response (200 OK):**
```json
{
  "id": "order_aa0e8400-e29b-41d4-a716-446655440005",
  "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
  "customerEmail": "customer@example.com",
  "status": "CANCELLED",
  "cancellationReason": "Customer requested cancellation",
  "total": 275.98,
  "currency": "ZAR",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T11:00:00Z",
  "lastUpdatedBy": "customer@example.com",
  "active": true
}
```

**Request Body (Soft Delete Order):**
```json
{
  "active": false
}
```

**Success Response (200 OK):**
```json
{
  "id": "order_aa0e8400-e29b-41d4-a716-446655440005",
  "tenantId": "tenant_bb0e8400-e29b-41d4-a716-446655440006",
  "status": "CANCELLED",
  "dateCreated": "2025-12-19T10:30:00Z",
  "dateLastUpdated": "2025-12-19T11:30:00Z",
  "lastUpdatedBy": "admin@kimmyai.io",
  "active": false
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "ValidationError",
  "message": "Cannot cancel order",
  "details": [
    {
      "field": "status",
      "message": "Order with status 'COMPLETED' cannot be cancelled"
    }
  ]
}
```

---

## 6. Authentication

### 6.1 Public Access

Most endpoints are public (no auth required):
- Marketing pages
- Product listing
- Contact form
- Newsletter subscription
- Anonymous cart

### 6.2 Cognito Integration

For registered users:
- Registration creates Cognito user + tenant
- Login returns JWT for Private Portal
- Password reset via Cognito

---

## 7. Anonymous Shopping

### 7.1 Core Business Rules

| Rule | Description |
|------|-------------|
| **ORDER requires TENANT#** | Orders MUST always have a TENANT# (PK), even if tenant status is UNVALIDATED |
| **PAYMENT requires TENANT#** | Payments MUST always have a TENANT# (via Order), even if tenant status is UNVALIDATED |
| **CART is flexible** | Cart may or may not have a tenant association |
| **Cart Type** | `UNREGISTERED` (cookie-based) or `REGISTERED` (tenant-based) |
| **Order creates Tenant** | On order creation, always create tenant OR associate with existing one by email |

### 7.2 Anonymous User Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                  ANONYMOUS SHOPPING FLOW                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. BROWSE                                                      │
│     └── User visits site, browses products                     │
│                                                                 │
│  2. CART (Type: UNREGISTERED)                                   │
│     ├── System assigns cookie-based cart ID                    │
│     ├── Cart stored with type=UNREGISTERED                     │
│     ├── NO tenant association at this stage                    │
│     └── Endpoint: /v1.0/cart/{cartId}                          │
│                                                                 │
│  3. CHECKOUT (Tenant Creation)                                  │
│     ├── User enters email address                              │
│     ├── System looks up existing tenant by email               │
│     │   ├── EXISTS: Use existing tenant                        │
│     │   └── NOT EXISTS: Create tenant (status=UNVALIDATED)     │
│     ├── OTP sent to email for verification                     │
│     └── Tenant ID returned for order creation                  │
│                                                                 │
│  4. ORDER (Always has TENANT#)                                  │
│     ├── Order created with PK=TENANT#{tenantId}                │
│     ├── Tenant status may be UNVALIDATED                       │
│     ├── Endpoint: /v1.0/tenants/{tenantId}/orders              │
│     └── Cart items transferred to order                        │
│                                                                 │
│  5. PAYMENT (Always has TENANT# via Order)                      │
│     ├── Payment created under order (which has TENANT#)        │
│     ├── Endpoint: /v1.0/tenants/{id}/orders/{id}/payments      │
│     └── PayFast redirect                                       │
│                                                                 │
│  6. COMPLETION                                                  │
│     ├── PayFast webhook confirms payment                       │
│     ├── Order status updated                                   │
│     ├── Tenant status updated to VALIDATED (on successful OTP) │
│     └── User can later register with same email                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.3 Cart Types

| Type | Description | PK Pattern | Tenant Association |
|------|-------------|------------|-------------------|
| `UNREGISTERED` | Anonymous cart (cookie-based) | `CART#{cartId}` | None |
| `REGISTERED` | Logged-in user cart | `TENANT#{tenantId}` | Yes |

### 7.4 Tenant Status Lifecycle

| Status | Description | Can Create Orders? |
|--------|-------------|-------------------|
| `UNVALIDATED` | Created at checkout, email not verified | Yes |
| `VALIDATED` | Email verified via OTP | Yes |
| `REGISTERED` | Full Cognito registration complete | Yes |
| `SUSPENDED` | Account suspended | No |

### 7.5 Tenant Auto-Creation Rules

| Scenario | Action |
|----------|--------|
| Anonymous checkout (new email) | Create tenant with status=UNVALIDATED |
| Anonymous checkout (existing email) | Associate with existing tenant |
| OTP verified | Update tenant status to VALIDATED |
| User registers later | Update tenant status to REGISTERED, link Cognito user |
| Repeat purchase (same email) | Same tenant used (lookup by email) |

### 7.6 Cart Merge on Login

When anonymous user logs in:
1. Check if anonymous cart exists (cookie ID, type=UNREGISTERED)
2. Check if tenant cart exists (type=REGISTERED)
3. Merge anonymous cart items into tenant cart
4. Update cart type to REGISTERED
5. Associate anonymous cart record with newly validated tenant (set tenantId, update type)

> **Note**: Tenant validation is just a status change on a pre-created tenant record. No new tenant is created during login - the tenant already exists from checkout or registration.

### 7.7 Future Consideration: Tenant Merge

> **DESIGN NOTE**: Customers may want to merge tenants later (e.g., consolidate multiple email addresses into one account). This functionality should be considered in the Organisation Management feature of the Private Portal. The Order and Payment history must be preserved during any tenant merge operation.

**Implications for Order/Payment design:**
- Orders reference tenant by ID (immutable)
- Payment history linked to orders
- Tenant merge would update tenant reference OR maintain history with merge audit trail
- Organisation Management (Private Portal) will need "Merge Tenants" feature

---

## 8. DynamoDB Schema

### 8.1 Core Entity Rules

| Entity | Tenant Association | Rule |
|--------|-------------------|------|
| Cart (UNREGISTERED) | None | Cookie-based, no tenant |
| Cart (REGISTERED) | Required | Tenant-based |
| Order | **REQUIRED** | Always has TENANT# in PK |
| Payment | **REQUIRED** | Always has TENANT# via Order |
| Tenant | N/A | Created at checkout if not exists |

### 8.2 Public Portal Entities

> **Soft Delete Pattern**: All entities have an `active` boolean field (default=true). To delete, set `active=false`. Queries filter by `active=true` by default.

| Entity | PK | SK | Attributes |
|--------|----|----|------------|
| Tenant | `TENANT#{tenantId}` | `METADATA` | id, email, status (UNVALIDATED/VALIDATED/REGISTERED), active, dateCreated |
| Cart (Unregistered) | `CART#{cartId}` | `METADATA` | id, type=UNREGISTERED, active, dateCreated, expiresAt |
| CartItem (Unregistered) | `CART#{cartId}` | `ITEM#{itemId}` | id, productId, quantity, price, active |
| Cart (Registered) | `TENANT#{tenantId}#CART#{cartId}` | `METADATA` | id, type=REGISTERED, active, dateLastUpdated |
| CartItem (Registered) | `TENANT#{tenantId}#CART#{cartId}` | `ITEM#{itemId}` | id, productId, quantity, price, active |
| Order | `TENANT#{tenantId}` | `ORDER#{orderId}` | id, status, total, campaign (embedded object), active, dateCreated |
| OrderItem | `TENANT#{tenantId}#ORDER#{orderId}` | `ITEM#{itemId}` | id, productId, quantity, price, active |
| Payment | `TENANT#{tenantId}#ORDER#{orderId}` | `PAYMENT#{paymentId}` | id, amount, status, payfastId, active, paidAt |
| Product | `PRODUCT#{productId}` | `METADATA` | id, name, description, price, active, dateCreated, dateLastUpdated |
| NewsletterSub | `NEWSLETTER#{email}` | `METADATA` | id, active, subscribedAt, preferences |
| Campaign | `CAMPAIGN#{code}` | `METADATA` | id, code, description, discountPercentage, productId, termsConditionsLink, fromDate, toDate, active, dateCreated, dateLastUpdated |
| Contact | `CONTACT#{contactId}` | `METADATA` | id, email, type, message, active, dateCreated |

### 8.3 GSIs

| GSI Name | PK | SK | Purpose |
|----------|----|----|---------|
| EmailIndex | email | entityType | Find tenant by email |
| OrderStatusIndex | status | dateCreated | List orders by status |
| OrderTenantIndex | tenantId | dateCreated | List orders by tenant |
| PaymentOrderIndex | orderId | dateCreated | List payments by order |
| ProductActiveIndex | active | dateCreated | List active products |
| CampaignActiveIndex | active | fromDate | List active campaigns by date |
| CampaignProductIndex | productId | fromDate | List campaigns by product |
| TenantStatusIndex | status | dateCreated | List tenants by status |
| ActiveIndex | active | dateCreated | Filter by active status (sparse index, all entities) |

> **Query Pattern**: All list queries include `active=true` filter by default. Use `includeInactive=true` parameter to include soft-deleted records.

### 8.4 Key Relationships

```
┌─────────────────────────────────────────────────────────────────┐
│                    ENTITY RELATIONSHIPS                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  CART (UNREGISTERED)          TENANT                            │
│  PK: CART#{cartId}            PK: TENANT#{tenantId}             │
│  SK: METADATA                 SK: METADATA                      │
│  type: UNREGISTERED           status: UNVALIDATED/VALIDATED     │
│       │                              │                          │
│       │ (no tenant)                  │                          │
│       ▼                              ▼                          │
│  ─────────────────────────────────────────────────────────      │
│                                                                 │
│  CART (REGISTERED)            ORDER                             │
│  PK: TENANT#{id}#CART#{id}    PK: TENANT#{tenantId}             │
│  SK: METADATA                 SK: ORDER#{orderId}               │
│  type: REGISTERED                    │                          │
│       │                              │                          │
│       ▼                              ▼                          │
│  CARTITEM (REGISTERED)        ORDERITEM                         │
│  PK: TENANT#{id}#CART#{id}    PK: TENANT#{id}#ORDER#{id}        │
│  SK: ITEM#{itemId}            SK: ITEM#{itemId}                 │
│                                      │                          │
│                                      ▼                          │
│                              PAYMENT                            │
│                              PK: TENANT#{id}#ORDER#{id}         │
│                              SK: PAYMENT#{paymentId}            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.5 Product Entity Details

| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| id | String | Yes | Unique product identifier (UUID) |
| name | String | Yes | Product name |
| description | String | Yes | Product description |
| price | Number | Yes | Product price |
| active | Boolean | Yes | Active status (default=true, false=soft deleted) |
| created_at | String | Yes | Creation timestamp (ISO 8601) |
| updated_at | String | Yes | Last update timestamp (ISO 8601) |

### 8.6 Campaign Entity Details

| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| id | String | Yes | Unique campaign identifier (UUID) |
| code | String | Yes | Campaign code (used in PK and URLs) |
| description | String | Yes | Campaign description |
| discountPercentage | Number | Yes | Discount percentage (0-100) |
| productId | String | Yes | Associated product identifier |
| termsConditionsLink | String | Yes | URL to terms and conditions document |
| fromDate | String | Yes | Campaign start date (ISO 8601 format: YYYY-MM-DD) |
| toDate | String | Yes | Campaign end date (ISO 8601 format: YYYY-MM-DD) |
| active | Boolean | Yes | Active status (default=true, false=soft deleted) |
| created_at | String | Yes | Creation timestamp (ISO 8601) |
| updated_at | String | Yes | Last update timestamp (ISO 8601) |

---

## 9. Infrastructure

### 9.1 Per-Component Architecture

Each component manages its own infrastructure:

```
2_bbws_auth_lambda/
├── src/
│   └── handlers/
├── tests/
├── terraform/
│   ├── main.tf
│   ├── api_gateway.tf
│   ├── lambda.tf
│   ├── cloudfront.tf
│   └── variables.tf
└── README.md
```

### 9.2 AWS Services (Per Component)

| Service | Purpose |
|---------|---------|
| API Gateway | REST API (created per component) |
| Lambda | Python 3.12 handlers |
| CloudFront | CDN routing (per component) |
| DynamoDB | Shared table (accessed by component) |
| S3 | Static assets, deployment artifacts |
| Cognito | Shared user pool |
| SES | Email sending |

### 9.3 No Shared Infrastructure Repo

- Each Lambda component has its own `/terraform` folder
- Each component creates its own API Gateway resources
- CloudFront routing configured per component
- Domain routing managed at component level

---

## 10. Repositories

### 10.1 Repository List (6 Total)

| # | Repository | Type | Description |
|---|------------|------|-------------|
| 1 | `2_1_bbws_web_public` | Frontend | React SPA |
| 2 | `2_1_bbws_product_lambda` | Backend | Product service (Python) |
| 3 | `2_1_bbws_campaign_lambda` | Backend | Campaign service (Python) |
| 4 | `2_1_bbws_order_lambda` | Backend | Order service (Python) |
| 5 | `2_1_bbws_dynamodb_schemas` | Database | DynamoDB table schemas, GSIs, migrations |
| 6 | `2_1_bbws_operations` | Operations | Dashboards, Alerts, Budgets, Config, Guardrails, Firewall, SCPs etc |

### 10.2 Repository Naming Convention

```
2_bbws_web_public          # Frontend application
2_bbws_{service}_lambda    # Lambda backend services
```

**Rules:**
- Prefix: `2_bbws_` (project identifier)
- Lambda services end with `_lambda`
- No `svc` in names
- Each repo contains its own `/terraform` folder

### 10.3 Repository Structure

```
2_bbws_{service}_lambda/
├── src/
│   ├── handlers/          # Lambda handlers
│   ├── services/          # Business logic
│   ├── models/            # Data models
│   └── utils/             # Utilities
├── tests/
│   ├── unit/
│   └── integration/
├── terraform/
│   ├── main.tf
│   ├── api_gateway.tf
│   ├── lambda.tf
│   ├── iam.tf
│   ├── cloudfront.tf
│   ├── variables.tf
│   └── outputs.tf
├── requirements.txt
├── pytest.ini
└── README.md
```

### 10.4 Operations Repository - JSON Configuration Examples

The `2_1_bbws_operations` repository contains JSON configurations for monitoring, alerting, budgets, and security specific to the BBWS Customer Portal (Public). Below are example JSON payloads for operational configurations.

#### 10.4.1 CloudWatch Alarm - Product Lambda Error Rate

**Purpose**: Alert when Product Lambda error rate exceeds threshold

```json
{
  "AlarmName": "2-1-bbws-product-lambda-error-rate-alarm",
  "AlarmDescription": "Alert when Product Lambda error rate exceeds 5 errors in 5 minutes",
  "MetricName": "Errors",
  "Namespace": "AWS/Lambda",
  "Statistic": "Sum",
  "Period": 300,
  "EvaluationPeriods": 2,
  "Threshold": 5.0,
  "ComparisonOperator": "GreaterThanThreshold",
  "Dimensions": [
    {
      "Name": "FunctionName",
      "Value": "2-1-bbws-product-lambda-list-products"
    }
  ],
  "ActionsEnabled": true,
  "AlarmActions": [
    "arn:aws:sns:af-south-1:536580886816:2-1-bbws-critical-alerts"
  ],
  "TreatMissingData": "notBreaching",
  "Tags": [
    {
      "Key": "Project",
      "Value": "2.1"
    },
    {
      "Key": "Environment",
      "Value": "DEV"
    }
  ]
}
```

#### 10.4.2 CloudWatch Dashboard - Customer Portal Public

**Purpose**: Monitor all Customer Portal Public services performance

```json
{
  "DashboardName": "2-1-bbws-customer-portal-public-dashboard",
  "DashboardBody": {
    "widgets": [
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/Lambda", "Invocations", {"stat": "Sum", "label": "Product Lambda"}],
            ["...", {"stat": "Sum", "label": "Campaign Lambda"}],
            ["...", {"stat": "Sum", "label": "Order Lambda"}]
          ],
          "period": 300,
          "stat": "Sum",
          "region": "af-south-1",
          "title": "Lambda Invocations",
          "yAxis": {
            "left": {
              "label": "Count"
            }
          }
        }
      },
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/Lambda", "Errors", {"stat": "Sum", "label": "Product Errors", "color": "#d62728"}],
            ["...", {"stat": "Sum", "label": "Campaign Errors", "color": "#ff7f0e"}],
            ["...", {"stat": "Sum", "label": "Order Errors", "color": "#e377c2"}]
          ],
          "period": 300,
          "stat": "Sum",
          "region": "af-south-1",
          "title": "Lambda Errors",
          "yAxis": {
            "left": {
              "label": "Errors"
            }
          }
        }
      },
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/DynamoDB", "ConsumedReadCapacityUnits", {"stat": "Sum"}],
            [".", "ConsumedWriteCapacityUnits", {"stat": "Sum"}]
          ],
          "period": 300,
          "stat": "Sum",
          "region": "af-south-1",
          "title": "DynamoDB Capacity - Customer Portal",
          "yAxis": {
            "left": {
              "label": "Units"
            }
          }
        }
      },
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/ApiGateway", "Count", {"stat": "Sum", "label": "API Requests"}],
            [".", "4XXError", {"stat": "Sum", "label": "Client Errors"}],
            [".", "5XXError", {"stat": "Sum", "label": "Server Errors"}]
          ],
          "period": 300,
          "stat": "Sum",
          "region": "af-south-1",
          "title": "API Gateway Metrics"
        }
      }
    ]
  }
}
```

#### 10.4.3 AWS Budget - DEV Environment

**Purpose**: Track monthly costs for Customer Portal Public in DEV

```json
{
  "Budget": {
    "BudgetName": "2-1-bbws-customer-portal-public-dev-budget",
    "BudgetLimit": {
      "Amount": "500",
      "Unit": "USD"
    },
    "TimeUnit": "MONTHLY",
    "BudgetType": "COST",
    "CostFilters": {
      "TagKeyValue": [
        "user:Project$2.1",
        "user:Environment$DEV",
        "user:Application$CustomerPortalPublic"
      ]
    }
  },
  "NotificationsWithSubscribers": [
    {
      "Notification": {
        "NotificationType": "ACTUAL",
        "ComparisonOperator": "GREATER_THAN",
        "Threshold": 80,
        "ThresholdType": "PERCENTAGE",
        "NotificationState": "ALARM"
      },
      "Subscribers": [
        {
          "SubscriptionType": "EMAIL",
          "Address": "devops@bigbeard.co.za"
        }
      ]
    },
    {
      "Notification": {
        "NotificationType": "FORECASTED",
        "ComparisonOperator": "GREATER_THAN",
        "Threshold": 100,
        "ThresholdType": "PERCENTAGE",
        "NotificationState": "ALARM"
      },
      "Subscribers": [
        {
          "SubscriptionType": "EMAIL",
          "Address": "finance@bigbeard.co.za"
        }
      ]
    }
  ]
}
```

#### 10.4.4 SNS Topic - Critical Alerts

**Purpose**: Notification topic for critical alerts

```json
{
  "TopicName": "2-1-bbws-critical-alerts",
  "DisplayName": "BBWS Customer Portal Critical Alerts",
  "Attributes": {
    "DeliveryPolicy": {
      "http": {
        "defaultHealthyRetryPolicy": {
          "minDelayTarget": 20,
          "maxDelayTarget": 20,
          "numRetries": 3,
          "numMaxDelayRetries": 0,
          "numNoDelayRetries": 0,
          "numMinDelayRetries": 0,
          "backoffFunction": "linear"
        }
      }
    }
  },
  "Subscriptions": [
    {
      "Protocol": "email",
      "Endpoint": "oncall@bigbeard.co.za"
    },
    {
      "Protocol": "lambda",
      "Endpoint": "arn:aws:lambda:af-south-1:536580886816:function:2-1-bbws-alert-handler"
    }
  ],
  "Tags": [
    {
      "Key": "Project",
      "Value": "2.1"
    },
    {
      "Key": "Application",
      "Value": "CustomerPortalPublic"
    },
    {
      "Key": "Environment",
      "Value": "DEV"
    }
  ]
}
```

#### 10.4.5 WAF Web ACL - API Gateway Protection

**Purpose**: Protect Customer Portal Public API Gateway from attacks

```json
{
  "Name": "2-1-bbws-customer-portal-api-waf",
  "Scope": "REGIONAL",
  "DefaultAction": {
    "Allow": {}
  },
  "Rules": [
    {
      "Name": "RateLimitAnonymousUsers",
      "Priority": 1,
      "Statement": {
        "RateBasedStatement": {
          "Limit": 2000,
          "AggregateKeyType": "IP"
        }
      },
      "Action": {
        "Block": {
          "CustomResponse": {
            "ResponseCode": 429,
            "CustomResponseBodyKey": "rate-limit-response"
          }
        }
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "RateLimitAnonymousUsers"
      }
    },
    {
      "Name": "AWSManagedRulesCommonRuleSet",
      "Priority": 2,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesCommonRuleSet",
          "ExcludedRules": []
        }
      },
      "OverrideAction": {
        "None": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "AWSManagedRulesCommonRuleSet"
      }
    },
    {
      "Name": "AWSManagedRulesKnownBadInputsRuleSet",
      "Priority": 3,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesKnownBadInputsRuleSet"
        }
      },
      "OverrideAction": {
        "None": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "AWSManagedRulesKnownBadInputsRuleSet"
      }
    }
  ],
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "2-1-bbws-customer-portal-api-waf"
  },
  "CustomResponseBodies": {
    "rate-limit-response": {
      "ContentType": "APPLICATION_JSON",
      "Content": "{\"error\":\"TooManyRequests\",\"message\":\"Rate limit exceeded. Please try again later.\"}"
    }
  },
  "Tags": [
    {
      "Key": "Project",
      "Value": "2.1"
    },
    {
      "Key": "Application",
      "Value": "CustomerPortalPublic"
    }
  ]
}
```

#### 10.4.6 EventBridge Rule - Cleanup Cart Items

**Purpose**: Schedule daily cleanup of expired anonymous cart items

```json
{
  "Name": "2-1-bbws-daily-cart-cleanup",
  "Description": "Cleanup expired anonymous cart items daily at 2 AM SAST",
  "ScheduleExpression": "cron(0 0 * * ? *)",
  "State": "ENABLED",
  "Targets": [
    {
      "Id": "1",
      "Arn": "arn:aws:lambda:af-south-1:536580886816:function:2-1-bbws-cart-cleanup",
      "Input": "{\"action\": \"cleanup_expired_carts\", \"environment\": \"dev\", \"max_age_hours\": 168}",
      "RetryPolicy": {
        "MaximumRetryAttempts": 2,
        "MaximumEventAge": 3600
      },
      "DeadLetterConfig": {
        "Arn": "arn:aws:sqs:af-south-1:536580886816:2-1-bbws-lambda-dlq"
      }
    }
  ],
  "Tags": [
    {
      "Key": "Project",
      "Value": "2.1"
    },
    {
      "Key": "Application",
      "Value": "CustomerPortalPublic"
    },
    {
      "Key": "Environment",
      "Value": "DEV"
    }
  ]
}
```

#### 10.4.7 Lambda Dead Letter Queue

**Purpose**: Capture failed Lambda invocations for investigation

```json
{
  "QueueName": "2-1-bbws-lambda-dlq",
  "Attributes": {
    "MessageRetentionPeriod": "1209600",
    "VisibilityTimeout": "300",
    "ReceiveMessageWaitTimeSeconds": "20",
    "MaximumMessageSize": "262144",
    "KmsMasterKeyId": "alias/aws/sqs",
    "KmsDataKeyReusePeriodSeconds": "300"
  },
  "Tags": {
    "Project": "2.1",
    "Application": "CustomerPortalPublic",
    "Purpose": "DeadLetterQueue",
    "Service": "Lambda",
    "Environment": "DEV"
  }
}
```

**Associated CloudWatch Alarm:**
```json
{
  "AlarmName": "2-1-bbws-dlq-messages-alarm",
  "AlarmDescription": "Alert when messages appear in DLQ",
  "MetricName": "ApproximateNumberOfMessagesVisible",
  "Namespace": "AWS/SQS",
  "Dimensions": [
    {
      "Name": "QueueName",
      "Value": "2-1-bbws-lambda-dlq"
    }
  ],
  "Threshold": 1,
  "ComparisonOperator": "GreaterThanOrEqualToThreshold",
  "EvaluationPeriods": 1,
  "Period": 300,
  "Statistic": "Average",
  "ActionsEnabled": true,
  "AlarmActions": [
    "arn:aws:sns:af-south-1:536580886816:2-1-bbws-critical-alerts"
  ],
  "TreatMissingData": "notBreaching"
}
```

---

## 11. Business Approval Requirements

### 11.1 Artefacts Requiring Business Approval

The following artefacts **MUST** have Business Owner (BO) approval before deployment:

| Category | Artefacts | Approval Required |
|----------|-----------|-------------------|
| **UI/UX** | All screens, layouts, components, branding | BO Sign-off |
| **Email Templates** | Registration confirmation, password reset, OTP, order confirmation, payment receipt | BO Sign-off |
| **Customer Messaging** | Error messages, success messages, notifications, tooltips | BO Sign-off |
| **Marketing Content** | Landing page copy, feature descriptions, pricing display, campaign pages | BO Sign-off |
| **Legal Content** | Terms of Service, Privacy Policy, Cookie Policy | BO + Legal Sign-off |
| **Transactional Content** | Order summaries, payment confirmations, invoice text | BO + Finance Sign-off |

### 11.2 Business Approval Process

```
┌─────────────────────────────────────────────────────────────────┐
│              BUSINESS APPROVAL PROCESS                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. DEVELOPMENT                                                 │
│     └── Dev team completes artefact                            │
│                                                                 │
│  2. DEV REVIEW                                                  │
│     └── Technical review (code quality, security)              │
│                                                                 │
│  3. STAGING DEPLOYMENT                                          │
│     └── Deploy to SIT for business review                      │
│                                                                 │
│  4. BUSINESS OWNER REVIEW                                       │
│     ├── BO reviews UI/messaging/content in SIT                 │
│     ├── BO provides feedback or approval                       │
│     └── Iterate until BO sign-off obtained                     │
│                                                                 │
│  5. PRODUCTION DEPLOYMENT                                       │
│     └── Only after BO sign-off documented                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 11.3 Sign-off Documentation

| Milestone | Sign-off Required From | Documentation |
|-----------|------------------------|---------------|
| UI Screens | Product Owner, Business Owner | JIRA ticket with BO approval comment |
| Email Templates | Business Owner, Marketing | Confluence page with approved templates |
| Customer Messaging | Business Owner, UX Lead | Messaging matrix in Confluence |
| Legal Pages | Business Owner, Legal | Legal review ticket closed |
| Go-Live | Business Owner, Tech Lead | Release sign-off form |

---

## 12. Implementation Plan

### 12.1 UI-First Development Approach

```
┌─────────────────────────────────────────────────────────────────┐
│               UI-FIRST IMPLEMENTATION FLOW                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Phase 1: UI SCREENS                                            │
│  ├── Build all 21 screens in React                             │
│  ├── Use mock data (static JSON)                               │
│  ├── Component library setup                                   │
│  └── Responsive design                                         │
│                                                                 │
│  Phase 2: API MOCKS                                             │
│  ├── MSW (Mock Service Worker) setup                           │
│  ├── JSON Server for REST endpoints                            │
│  ├── Mock all 24 endpoints                                     │
│  └── Realistic test data                                       │
│                                                                 │
│  Phase 3: PLAYBACK & PO APPROVAL                                │
│  ├── Demo to Product Owner                                     │
│  ├── User flow walkthroughs                                    │
│  ├── Gather feedback                                           │
│  └── Iterate on UI/UX                                          │
│                                                                 │
│  Phase 4: BACKEND IMPLEMENTATION                                │
│  ├── Lambda functions (Python 3.12)                            │
│  ├── DynamoDB tables                                           │
│  ├── API Gateway configuration                                 │
│  └── Per-component Terraform                                   │
│                                                                 │
│  Phase 5: INTEGRATION                                           │
│  ├── Connect frontend to real APIs                             │
│  ├── E2E testing                                               │
│  ├── PayFast integration                                       │
│  └── Production deployment                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 12.2 Milestones (with Business Owner Gates)

> **IMPORTANT**: Each milestone requires **Business Owner (BO) Review** before proceeding to the next milestone. No milestone is considered complete without documented BO sign-off.

| # | Milestone | Deliverables | Tech Review | BO Review |
|---|-----------|--------------|-------------|-----------|
| 0.1 | UI Screens | 21 React screens with mock data | Dev Review | **BO Sign-off Required** |
| 0.2 | API Mocks | MSW handlers for all endpoints | Dev Review | **BO Sign-off Required** |
| 0.3 | Playback | Demo walkthrough, feedback collection | PO Review | **BO Approval Required** |
| 0.4 | Email Templates | All transactional email templates | Dev Review | **BO Sign-off Required** |
| 0.5 | Customer Messaging | Error/success messages, notifications | Dev Review | **BO Sign-off Required** |
| 0.6 | DynamoDB Schemas | 2_1_bbws_dynamodb_schemas + migrations | Dev Review | **BO Sign-off Required** |
| 0.7 | Auth Lambda | 2_1_bbws_auth_lambda + TF | Dev Review | **BO Sign-off Required** |
| 0.8 | Product Lambda | 2_1_bbws_product_lambda + TF | Dev Review | **BO Sign-off Required** |
| 0.9 | Campaign Lambda | 2_1_bbws_campaign_lambda + TF | Dev Review | **BO Sign-off Required** |
| 0.10 | Cart Lambda | 2_1_bbws_cart_lambda + TF | Dev Review | **BO Sign-off Required** |
| 0.11 | Order Lambda | 2_1_bbws_order_lambda + TF | Dev Review | **BO Sign-off Required** |
| 0.12 | Payment Lambda | 2_1_bbws_payment_lambda + TF | Dev Review | **BO Sign-off Required** |
| 0.13 | Contact Lambda | 2_1_bbws_contact_lambda + TF | Dev Review | **BO Sign-off Required** |
| 0.14 | Newsletter Lambda | 2_1_bbws_newsletter_lambda + TF | Dev Review | **BO Sign-off Required** |
| 0.15 | Invitation Lambda | 2_1_bbws_invitation_lambda + TF | Dev Review | **BO Sign-off Required** |
| 0.16 | Integration | Frontend + Backend connected | QA Review | **BO Sign-off Required** |
| 0.17 | E2E Testing | Full flow tests | QA Approval | **BO Sign-off Required** |
| 0.18 | UAT | User Acceptance Testing in SIT | QA Review | **BO Final Approval** |
| 0.19 | Production | Live deployment | Tech Lead | **BO Go-Live Approval** |

### 12.3 Milestone Gate Process

```
┌─────────────────────────────────────────────────────────────────┐
│              MILESTONE GATE PROCESS                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  For EACH milestone:                                            │
│                                                                 │
│  1. COMPLETE DELIVERABLES                                       │
│     └── Dev team completes all deliverables                    │
│                                                                 │
│  2. TECHNICAL REVIEW                                            │
│     └── Code review, security scan, unit tests pass            │
│                                                                 │
│  3. DEPLOY TO DEV                                               │
│     └── Deploy to DEV environment                              │
│                                                                 │
│  4. DEV TESTING                                                 │
│     └── Dev team validates in DEV                              │
│                                                                 │
│  5. DEPLOY TO SIT                                               │
│     └── Promote to SIT for BO review                           │
│                                                                 │
│  6. BUSINESS OWNER REVIEW                                       │
│     ├── BO reviews deliverables in SIT                         │
│     ├── BO provides feedback OR approval                       │
│     ├── If feedback: return to step 1                          │
│     └── If approved: document sign-off in JIRA                 │
│                                                                 │
│  7. MILESTONE COMPLETE                                          │
│     └── Proceed to next milestone                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 13. LLDs Reference

### 13.1 Parent HLD Information

| Attribute | Value |
|-----------|-------|
| HLD Document | `2.1_HLD_Customer_Portal_Public.md` |
| HLD Version | v1.3.0 |
| HLD Prefix | `2.1` |
| Total LLDs | 10 technical + 5 operational |

### 13.2 Technical LLDs (10 Documents)

Following the naming convention: `[HLD_Prefix].[LLD_Number]_LLD_[Name].md`

> **Repository Naming Convention:** All repositories follow the pattern `{HLD_Prefix}_bbws_{service}` where dots in the HLD prefix are replaced with underscores. Example: HLD `2.1` → Repository prefix `2_1`.

| LLD ID | LLD Name | Description | Repository | Status |
|--------|----------|-------------|------------|--------|
| 2.1.1 | `2.1.1_LLD_Frontend_Architecture.md` | React SPA, routing, state management | `2_1_bbws_web_public` | Draft |
| 2.1.2 | `2.1.2_LLD_Auth_Lambda.md` | Auth service design (register, login, password) | `2_1_bbws_auth_lambda` | Draft |
| 2.1.3 | `2.1.3_LLD_Campaign_Lambda.md` | Campaign service design (CRUD operations) | `2_1_bbws_campaign_lambda` | Draft |
| 2.1.4 | `2.1.4_LLD_Product_Lambda.md` | Product service design (CRUD operations) | `2_1_bbws_product_lambda` | Draft |
| 2.1.5 | `2.1.5_LLD_Contact_Lambda.md` | Contact form service design | `2_1_bbws_contact_lambda` | Draft |
| 2.1.6 | `2.1.6_LLD_Invitation_Lambda.md` | Invitation service design | `2_1_bbws_invitation_lambda` | Draft |
| 2.1.7 | `2.1.7_LLD_Cart_Lambda.md` | Cart service (anonymous + tenant) | `2_1_bbws_cart_lambda` | Draft |
| 2.1.8 | `2.1.8_LLD_Order_Lambda.md` | Order management service design | `2_1_bbws_order_lambda` | Draft |
| 2.1.9 | `2.1.9_LLD_Payment_Lambda.md` | PayFast payment integration | `2_1_bbws_payment_lambda` | Draft |
| 2.1.10 | `2.1.10_LLD_Newsletter_Lambda.md` | Newsletter subscription service | `2_1_bbws_newsletter_lambda` | Draft |

### 13.3 Operational Runbooks (5 Documents)

Following the naming convention: `[HLD_Prefix].[LLD_Number]_OPS_[Name].md`

| OPS ID | Runbook Name | Description | Status |
|--------|--------------|-------------|--------|
| 2.1.11 | `2.1.11_OPS_Deployment_Runbook.md` | Per-component deployment procedures | Draft |
| 2.1.12 | `2.1.12_OPS_Monitoring_Runbook.md` | CloudWatch dashboards and alerts | Draft |
| 2.1.13 | `2.1.13_OPS_Incident_Response_Runbook.md` | Incident and DR procedures | Draft |
| 2.1.14 | `2.1.14_OPS_Security_Runbook.md` | Security configuration and best practices | Draft |
| 2.1.15 | `2.1.15_OPS_Troubleshooting_Runbook.md` | General troubleshooting and issue resolution | Draft |

### 13.4 LLD Naming Convention

All LLDs derived from this HLD follow the hierarchical naming pattern:

**Pattern**: `[HLD_Prefix].[Sequential_Number]_[Type]_[Name].md`

**Example**:
- HLD Prefix: `2.1` (from `2.1_HLD_Customer_Portal_Public.md`)
- First LLD: `2.1.1_LLD_Frontend_Architecture.md`
- Second LLD: `2.1.2_LLD_Auth_Lambda.md`
- First OPS: `2.1.11_OPS_Deployment_Runbook.md`

This convention ensures:
- Clear parent-child relationship between HLD and LLDs
- Traceability across documentation hierarchy
- Easy navigation in document repositories
- Alignment with repository naming (e.g., `2.1.2_LLD_Auth_Lambda.md` → `2_1_bbws_auth_lambda`)

---

## 14. Appendices

### Appendix A: User Stories

| Story ID | User Story | Priority |
|----------|------------|----------|
| US-CPP-001 | As a visitor, I want to view the home page | P0 |
| US-CPP-002 | As a visitor, I want to view all products | P0 |
| US-CPP-003 | As a visitor, I want to add items to cart anonymously | P0 |
| US-CPP-004 | As a visitor, I want to checkout without registering | P0 |
| US-CPP-005 | As a visitor, I want to pay via PayFast | P0 |
| US-CPP-006 | As a visitor, I want to subscribe to newsletter | P1 |
| US-CPP-007 | As a visitor, I want to submit a contact form | P1 |
| US-CPP-008 | As a visitor, I want to register an account | P1 |
| US-CPP-009 | As a visitor, I want to view campaign offers | P1 |
| US-CPP-010 | As a visitor, I want to reset my password | P2 |

### Appendix B: Screen-to-Service Matrix

| Screen | Auth | Campaign | Product | Contact | Newsletter | Cart | Order | Payment | Invitation |
|--------|------|----------|---------|---------|------------|------|-------|---------|------------|
| CPP-001 Home | - | - | - | - | - | - | - | - | - |
| CPP-003 Pricing | - | - | ✓ | - | - | - | - | - | - |
| CPP-005 Contact | - | - | - | ✓ | - | - | - | - | - |
| CPP-006 Register | ✓ | - | - | - | - | - | - | - | - |
| CPP-007 Login | ✓ | - | - | - | - | - | - | - | - |
| CPP-012 Campaign | - | ✓ | - | - | - | - | - | - | - |
| CPP-016 Cart | - | - | - | - | - | ✓ | - | - | - |
| CPP-017 Checkout | ✓ | - | - | - | - | ✓ | ✓ | - | - |
| CPP-018 Payment | - | - | - | - | - | - | ✓ | ✓ | - |
| CPP-021 Newsletter | - | - | - | - | ✓ | - | - | - | - |

### Appendix C: Removed Endpoints (from v1.1)

| Endpoint | Reason |
|----------|--------|
| `POST /v1.0/campaigns/{code}/validate` | GET returns status/validity |
| `POST /v1.0/contact/enquiry` | /contact handles all types |
| `GET /v1.0/products/compare` | Compare functionality not needed |

---

## Related Documents

- [BBWS Customer Portal Private HLD](./BBWS_Customer_Portal_Private_HLD.md)
- [BBWS Admin Portal HLD](./BBWS_Admin_Portal_HLD.md)
- [Master Plan](/.claude/plans/twinkling-mapping-hamster.md)

---

**End of Document**
