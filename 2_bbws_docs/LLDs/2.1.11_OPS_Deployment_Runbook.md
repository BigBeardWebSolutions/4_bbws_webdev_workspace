# CPP Deployment Runbook

**Version**: 1.0
**Created**: 2025-12-15
**Status**: Draft
**Component**: Customer Portal Public - Deployment Operations
**Parent HLD**: [BBWS Customer Portal Public HLD](../BBWS_Customer_Portal_Public_HLD.md)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | Agentic Architect | Initial version |

---

## 1. Overview

### 1.1 Purpose

This runbook provides step-by-step procedures for deploying the Customer Portal Public (CPP) application across all environments (dev, sit, prod).

### 1.2 Scope

| Component | Repository | Deployment Method |
|-----------|------------|-------------------|
| Frontend SPA | 2_bbws_frontend | S3 + CloudFront |
| Auth Lambda | 2_bbws_auth_lambda | Terraform |
| Marketing Lambda | 2_bbws_marketing_lambda | Terraform |
| Product Lambda | 2_bbws_product_lambda | Terraform |
| Contact Lambda | 2_bbws_contact_lambda | Terraform |
| Invitation Lambda | 2_bbws_invitation_lambda | Terraform |
| Cart Lambda | 2_bbws_cart_lambda | Terraform |
| Order Lambda | 2_bbws_order_lambda | Terraform |
| Payment Lambda | 2_bbws_payment_lambda | Terraform |
| Newsletter Lambda | 2_bbws_newsletter_lambda | Terraform |

### 1.3 Environment Promotion Flow

```
DEV → SIT → PROD
```

**Important**: All fixes must be applied in DEV first and promoted through SIT to PROD.

---

## 2. Pre-Deployment Checklist

### 2.1 General Prerequisites

- [ ] AWS CLI configured with appropriate credentials
- [ ] Terraform >= 1.5.0 installed
- [ ] Node.js >= 18 installed (for frontend)
- [ ] Python >= 3.12 installed (for Lambda)
- [ ] Access to relevant AWS accounts
- [ ] VPN connected (if required)

### 2.2 Environment-Specific Prerequisites

| Environment | AWS Account | Region | Approval Required |
|-------------|-------------|--------|-------------------|
| dev | bbws-dev | af-south-1 | No |
| sit | bbws-sit | af-south-1 | Tech Lead |
| prod | bbws-prod | af-south-1 | Tech Lead + Business Owner |

### 2.3 Pre-Deployment Validation

```bash
# Verify AWS credentials
aws sts get-caller-identity

# Verify Terraform version
terraform version

# Verify environment variables
echo $ENVIRONMENT
echo $AWS_REGION
```

---

## 3. Lambda Deployment Procedures

### 3.1 Standard Lambda Deployment

#### Step 1: Pull Latest Code

```bash
cd /path/to/2_bbws_<service>_lambda
git checkout main
git pull origin main
```

#### Step 2: Run Tests

```bash
# Install dependencies
pip install -r requirements.txt -r requirements-dev.txt

# Run unit tests
pytest tests/ -v --cov=src --cov-report=term-missing

# Verify test coverage >= 80%
```

#### Step 3: Package Lambda

```bash
# Create deployment package
cd src
zip -r ../deployment.zip .
cd ..
pip install -r requirements.txt -t package/
cd package
zip -r ../deployment.zip .
```

#### Step 4: Terraform Plan

```bash
cd terraform

# Initialize Terraform
terraform init -backend-config="environments/${ENVIRONMENT}/backend.tfvars"

# Plan deployment
terraform plan \
  -var-file="environments/${ENVIRONMENT}/terraform.tfvars" \
  -out="${ENVIRONMENT}.tfplan"
```

#### Step 5: Review Plan Output

```bash
# Review changes
terraform show ${ENVIRONMENT}.tfplan

# Verify:
# - No unexpected resource deletions
# - Lambda function updates are expected
# - IAM policies are correct
```

#### Step 6: Apply Deployment

```bash
# Apply changes
terraform apply ${ENVIRONMENT}.tfplan

# Verify deployment
aws lambda get-function --function-name bbws-${ENVIRONMENT}-<service>
```

#### Step 7: Post-Deployment Verification

```bash
# Invoke Lambda with test event
aws lambda invoke \
  --function-name bbws-${ENVIRONMENT}-<service> \
  --payload '{"test": true}' \
  response.json

# Check response
cat response.json
```

### 3.2 Deployment Order (Dependencies)

Deploy in this order to respect dependencies:

1. **Infrastructure** (DynamoDB tables, S3 buckets)
2. **Auth Lambda** (no dependencies)
3. **Product Lambda** (no dependencies)
4. **Marketing Lambda** (no dependencies)
5. **Contact Lambda** (no dependencies)
6. **Newsletter Lambda** (no dependencies)
7. **Invitation Lambda** (depends on Auth)
8. **Cart Lambda** (depends on Product)
9. **Order Lambda** (depends on Cart)
10. **Payment Lambda** (depends on Order)
11. **Frontend** (depends on all APIs)

---

## 4. Frontend Deployment Procedures

### 4.1 Build Frontend

```bash
cd /path/to/2_bbws_frontend

# Install dependencies
npm ci

# Set environment
export VITE_API_URL=https://api.${ENVIRONMENT}.bigbeard.co.za
export VITE_ENV=${ENVIRONMENT}

# Build
npm run build

# Verify build
ls -la dist/
```

### 4.2 Deploy to S3

```bash
# Sync to S3
aws s3 sync dist/ s3://bbws-${ENVIRONMENT}-frontend/ \
  --delete \
  --cache-control "max-age=31536000" \
  --exclude "index.html"

# Deploy index.html with no-cache
aws s3 cp dist/index.html s3://bbws-${ENVIRONMENT}-frontend/index.html \
  --cache-control "no-cache, no-store, must-revalidate"
```

### 4.3 Invalidate CloudFront Cache

```bash
# Get distribution ID
DISTRIBUTION_ID=$(aws cloudfront list-distributions \
  --query "DistributionList.Items[?Origins.Items[0].DomainName=='bbws-${ENVIRONMENT}-frontend.s3.amazonaws.com'].Id" \
  --output text)

# Create invalidation
aws cloudfront create-invalidation \
  --distribution-id $DISTRIBUTION_ID \
  --paths "/*"

# Wait for completion
aws cloudfront wait invalidation-completed \
  --distribution-id $DISTRIBUTION_ID \
  --id <invalidation-id>
```

---

## 5. Environment-Specific Procedures

### 5.1 DEV Deployment

```bash
export ENVIRONMENT=dev
export AWS_PROFILE=bbws-dev
export AWS_REGION=af-south-1

# Deploy all services
./scripts/deploy-all.sh dev
```

### 5.2 SIT Deployment

**Requires Tech Lead Approval**

```bash
export ENVIRONMENT=sit
export AWS_PROFILE=bbws-sit
export AWS_REGION=af-south-1

# Verify DEV deployment successful
./scripts/verify-deployment.sh dev

# Deploy to SIT
./scripts/deploy-all.sh sit
```

### 5.3 PROD Deployment

**Requires Tech Lead + Business Owner Approval**

**PROD is READ-ONLY for non-deployment operations**

```bash
export ENVIRONMENT=prod
export AWS_PROFILE=bbws-prod
export AWS_REGION=af-south-1

# Verify SIT deployment successful
./scripts/verify-deployment.sh sit

# Create deployment ticket
# Get approvals documented

# Deploy to PROD
./scripts/deploy-all.sh prod

# Verify deployment
./scripts/verify-deployment.sh prod
```

---

## 6. Rollback Procedures

### 6.1 Lambda Rollback

```bash
# List Lambda versions
aws lambda list-versions-by-function \
  --function-name bbws-${ENVIRONMENT}-<service>

# Get previous version
PREVIOUS_VERSION=$(aws lambda list-versions-by-function \
  --function-name bbws-${ENVIRONMENT}-<service> \
  --query 'Versions[-2].Version' \
  --output text)

# Update alias to previous version
aws lambda update-alias \
  --function-name bbws-${ENVIRONMENT}-<service> \
  --name live \
  --function-version $PREVIOUS_VERSION
```

### 6.2 Frontend Rollback

```bash
# List S3 versions
aws s3api list-object-versions \
  --bucket bbws-${ENVIRONMENT}-frontend \
  --prefix index.html

# Restore previous version
aws s3api copy-object \
  --bucket bbws-${ENVIRONMENT}-frontend \
  --key index.html \
  --copy-source bbws-${ENVIRONMENT}-frontend/index.html?versionId=<previous-version-id>

# Invalidate CloudFront
aws cloudfront create-invalidation \
  --distribution-id $DISTRIBUTION_ID \
  --paths "/*"
```

### 6.3 Terraform Rollback

```bash
# Revert to previous state
git log --oneline terraform/

# Checkout previous commit
git checkout <previous-commit> -- terraform/

# Re-apply
terraform plan -var-file="environments/${ENVIRONMENT}/terraform.tfvars" -out=rollback.tfplan
terraform apply rollback.tfplan
```

---

## 7. Deployment Scripts

### 7.1 deploy-all.sh

```bash
#!/bin/bash
set -e

ENVIRONMENT=$1

if [ -z "$ENVIRONMENT" ]; then
  echo "Usage: ./deploy-all.sh <environment>"
  exit 1
fi

echo "Deploying to $ENVIRONMENT..."

# Deploy Lambdas
for service in auth product marketing contact newsletter invitation cart order payment; do
  echo "Deploying $service lambda..."
  cd ../2_bbws_${service}_lambda
  ./deploy.sh $ENVIRONMENT
  cd -
done

# Deploy Frontend
echo "Deploying frontend..."
cd ../2_bbws_frontend
./deploy.sh $ENVIRONMENT

echo "Deployment complete!"
```

### 7.2 verify-deployment.sh

```bash
#!/bin/bash
set -e

ENVIRONMENT=$1
API_URL="https://api.${ENVIRONMENT}.bigbeard.co.za"

echo "Verifying $ENVIRONMENT deployment..."

# Health checks
curl -s "${API_URL}/v1.0/health" | jq .
curl -s "${API_URL}/v1.0/products" | jq .

echo "Verification complete!"
```

---

## 8. Troubleshooting Deployment Issues

### 8.1 Common Issues

| Issue | Cause | Resolution |
|-------|-------|------------|
| Terraform state lock | Concurrent deployment | Wait or force-unlock |
| Lambda timeout during deploy | Package too large | Optimize dependencies |
| CloudFront 403 | S3 bucket policy | Verify OAI configuration |
| API Gateway 500 | Lambda execution error | Check CloudWatch logs |

### 8.2 Debug Commands

```bash
# Check Lambda logs
aws logs tail /aws/lambda/bbws-${ENVIRONMENT}-<service> --follow

# Check API Gateway logs
aws logs tail /aws/apigateway/bbws-${ENVIRONMENT} --follow

# Check deployment status
aws lambda get-function --function-name bbws-${ENVIRONMENT}-<service>
```

---

## 9. Contacts

| Role | Name | Contact |
|------|------|---------|
| DevOps Lead | TBD | TBD |
| Tech Lead | TBD | TBD |
| On-Call Engineer | TBD | TBD |

---

## 10. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| DevOps Lead | | | |
| Tech Lead | | | |

---

**End of Document**
