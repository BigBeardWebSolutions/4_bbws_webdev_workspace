# Portal Billing Service - Low-Level Design

**Version**: 1.0
**Created**: 2026-01-20
**Status**: Draft
**Component**: Portal Billing Service (`2_2_bbws_portal_svc_billing`)
**Parent HLD**: [HLD 2.2 BBWS Customer Portal Private](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md)
**Parent BRS**: [BRS 2.2 Customer Portal Private](../BRS/2.2_BRS_Customer_Portal_Private.md) - Epic 8

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-20 | LLD Architect Agent | Initial version covering Epic 8 (Billing & Subscriptions) |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [High Level Epic Overview](#2-high-level-epic-overview)
3. [Architecture Diagram](#3-architecture-diagram)
4. [API Design](#4-api-design)
5. [Lambda Functions](#5-lambda-functions)
6. [Sequence Diagrams](#6-sequence-diagrams)
7. [Data Models](#7-data-models)
8. [PayFast Integration](#8-payfast-integration)
9. [Security](#9-security)
10. [Error Handling](#10-error-handling)
11. [Monitoring and Alerting](#11-monitoring-and-alerting)
12. [NFRs](#12-nfrs)
13. [Troubleshooting Playbook](#13-troubleshooting-playbook)
14. [Tagging](#14-tagging)
15. [Risks and Mitigations](#15-risks-and-mitigations)
16. [TBC](#16-tbc)
17. [Definition of Terms](#17-definition-of-terms)
18. [Appendices](#18-appendices)
19. [References](#19-references)
20. [Signoff](#20-signoff)

---

## 1. Introduction

### 1.1 Purpose

This LLD provides implementation-level details for the Portal Billing Service, which handles subscription management, plan changes, payment processing, and invoice generation for authenticated customers in the Customer Portal Private application.

### 1.2 Scope

| In Scope | Out of Scope |
|----------|--------------|
| Subscription viewing and management | Public checkout (see 2.1.8_LLD_Order_Lambda) |
| Plan upgrades and downgrades | Payment gateway implementation (see 2.1.9_LLD_Payment_Lambda) |
| Payment history viewing | Admin billing operations |
| Invoice generation and download | Refund processing (admin only) |
| Checkout flow for authenticated users | White-label billing (Epic 10) |

### 1.3 Component Overview

| Attribute | Value |
|-----------|-------|
| Repository | `2_2_bbws_portal_svc_billing` |
| Runtime | Python 3.12 |
| Memory | 256MB (default), 512MB (checkout) |
| Timeout | 30s |
| Architecture | arm64 |
| API Prefix | `/portal/billing/*` |
| Authentication | Required (Cognito JWT) |

### 1.4 BRS/HLD References

| Reference | Document | Section |
|-----------|----------|---------|
| Epic 8 | BRS 2.2 | Billing & Subscriptions |
| US 8.1 | BRS 2.2 | View My Subscription |
| US 8.2 | BRS 2.2 | Upgrade My Plan |
| US 8.3 | BRS 2.2 | Downgrade My Plan |
| US 8.4 | BRS 2.2 | View Payment History |
| US 8.5 | BRS 2.2 | View and Download Invoice |
| US 8.6 | BRS 2.2 | Complete Payment via Checkout |
| BR-031 to BR-033 | BRS 2.2 | Billing Business Rules |

### 1.5 Dependencies

| Dependency | Purpose |
|------------|---------|
| AWS DynamoDB | Subscription, Order, Invoice storage |
| AWS S3 | Invoice PDF storage |
| PayFast API | Payment processing |
| AWS SES | Invoice email notifications |
| AWS Secrets Manager | PayFast credentials |
| Lambda Authorizer | JWT validation, tenant isolation |
| Order Lambda | Existing order processing (2.1.8) |
| Payment Lambda | PayFast integration (2.1.9) |

---

## 2. High Level Epic Overview

### 2.1 Epic 8: Billing & Subscriptions

| User Story # | User Story | Lambda Function | Test Scenario(s) |
|--------------|------------|-----------------|------------------|
| US 8.1 | View My Subscription | `get_subscription` | Given valid JWT and tenant, then subscription details returned |
| US 8.2 | Upgrade My Plan | `change_plan` | Given upgrade request, then proration calculated and checkout initiated |
| US 8.3 | Downgrade My Plan | `change_plan` | Given downgrade request, then scheduled for next billing cycle |
| US 8.4 | View Payment History | `list_payments` | Given valid JWT, then payment history returned with pagination |
| US 8.5 | View and Download Invoice | `get_invoice`, `download_invoice` | Given invoice ID, then invoice PDF generated and returned |
| US 8.6 | Complete Payment via Checkout | `create_checkout`, `confirm_payment` | Given checkout data, then PayFast redirect URL returned |

### 2.2 Business Rules Coverage

| Rule ID | Rule | Implementation |
|---------|------|----------------|
| BR-031 | Only super-admin can view billing for all tenants | Role check in Lambda Authorizer |
| BR-032 | Downgrade takes effect at end of current billing cycle | Set `effectiveDate` to `nextBillingDate` |
| BR-033 | Upgrade is effective immediately with proration | Calculate prorated amount, charge immediately |
| BR-034 | Invoice generated on successful payment | EventBridge trigger to invoice generator |
| BR-035 | Payment receipts sent via email | SES integration after payment confirmation |
| BR-036 | Failed payments trigger retry with exponential backoff | SQS + DLQ with retry logic |

---

## 3. Architecture Diagram

### 3.1 Component Architecture

```
                                  PORTAL BILLING SERVICE ARCHITECTURE
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  +---------+          +----------------+          +------------------+                           |
|  | React   |  HTTPS   |   API Gateway  |          |  Lambda          |                          |
|  | SPA     |--------->|   (REST)       |--------->|  Authorizer      |                          |
|  | (S3/CF) |          |                |          |  (JWT Validate)  |                          |
|  +---------+          +-------+--------+          +--------+---------+                          |
|                               |                            |                                     |
|                               | (Authenticated)            | (IAM Policy)                        |
|                               ▼                            ▼                                     |
|                       +-------+--------------------------------+--------+                        |
|                       |                 BILLING LAMBDAS                 |                        |
|                       |  +----------+  +----------+  +--------------+   |                        |
|                       |  |   get_   |  | change_  |  |    list_     |   |                        |
|                       |  |subscript.|  |  plan    |  |  payments    |   |                        |
|                       |  +----+-----+  +----+-----+  +------+-------+   |                        |
|                       |       |             |               |           |                        |
|                       |  +----+-----+  +----+-----+  +------+-------+   |                        |
|                       |  |   get_   |  | download_|  |   create_    |   |                        |
|                       |  | invoice  |  | invoice  |  |  checkout    |   |                        |
|                       |  +----+-----+  +----+-----+  +------+-------+   |                        |
|                       |       |             |               |           |                        |
|                       +-------+-------------+---------------+-----------+                        |
|                               |             |               |                                    |
|            +------------------+             |               +------------------+                 |
|            |                                |                                  |                 |
|            ▼                                ▼                                  ▼                 |
|    +-------+--------+              +--------+--------+              +----------+-------+         |
|    |   DynamoDB     |              |       S3        |              |     PayFast      |         |
|    |  +-----------+ |              |  +-----------+  |              |   (External)     |         |
|    |  |Subscription| |             |  |  Invoice  |  |              |                  |         |
|    |  +-----------+ |              |  |   PDFs    |  |              | POST /eng/process|         |
|    |  |   Order   | |              |  +-----------+  |              | ITN Webhook      |         |
|    |  +-----------+ |              +--------+--------+              +----------+-------+         |
|    |  |  Invoice  | |                       |                                  |                 |
|    |  +-----------+ |                       |                                  |                 |
|    |  |  Payment  | |                       |                                  ▼                 |
|    |  +-----------+ |                       |                       +----------+-------+         |
|    +----------------+                       |                       |   SQS (DLQ)      |         |
|                                             |                       | Payment Retry    |         |
|            +--------------------------------+                       +------------------+         |
|            |                                                                                     |
|            ▼                                                                                     |
|    +-------+--------+                                                                            |
|    |   EventBridge  |                                                                            |
|    | payment.success|------> Invoice Generator Lambda                                            |
|    | payment.failed |------> Notification Lambda (SES)                                           |
|    +----------------+                                                                            |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+
```

### 3.2 Data Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           BILLING DATA FLOW                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   SUBSCRIPTION VIEW                                                             │
│   ────────────────                                                              │
│   User → GET /subscription → DynamoDB(Subscription) → Response                  │
│                                                                                 │
│   PLAN CHANGE (UPGRADE)                                                         │
│   ─────────────────────                                                         │
│   User → POST /plan/change → Calculate Proration → Create Order                 │
│        → PayFast Checkout → ITN Webhook → Update Subscription                   │
│        → EventBridge → Generate Invoice → Email Receipt                         │
│                                                                                 │
│   PLAN CHANGE (DOWNGRADE)                                                       │
│   ─────────────────────────                                                     │
│   User → POST /plan/change → Validate → Schedule Change                         │
│        → DynamoDB(Subscription.pendingChange) → Cron Job at Billing Date        │
│        → Apply Change → Email Notification                                      │
│                                                                                 │
│   INVOICE DOWNLOAD                                                              │
│   ────────────────                                                              │
│   User → GET /invoices/{id}/download → Generate PDF → S3 → Signed URL           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. API Design

### 4.1 API Endpoints

| Method | Endpoint | Lambda | Description | Auth |
|--------|----------|--------|-------------|------|
| GET | `/portal/billing/subscription` | get_subscription | Get current subscription | JWT |
| GET | `/portal/billing/plans` | list_plans | List available plans | JWT |
| POST | `/portal/billing/plan/change` | change_plan | Upgrade/downgrade plan | JWT |
| POST | `/portal/billing/plan/preview` | preview_plan_change | Preview proration | JWT |
| GET | `/portal/billing/payments` | list_payments | Payment history | JWT |
| GET | `/portal/billing/invoices` | list_invoices | List invoices | JWT |
| GET | `/portal/billing/invoices/{id}` | get_invoice | Get invoice details | JWT |
| GET | `/portal/billing/invoices/{id}/download` | download_invoice | Download PDF | JWT |
| POST | `/portal/billing/checkout` | create_checkout | Initiate payment | JWT |
| POST | `/portal/billing/checkout/confirm` | confirm_payment | Confirm payment (internal) | API Key |

### 4.2 OpenAPI Specification

```yaml
openapi: 3.0.3
info:
  title: Portal Billing Service API
  version: 1.0.0
  description: Billing & Subscription management for Customer Portal Private

servers:
  - url: https://dev.portal-api.kimmyai.io/v1.0
    description: Development
  - url: https://sit.portal-api.kimmyai.io/v1.0
    description: SIT
  - url: https://portal-api.kimmyai.io/v1.0
    description: Production

paths:
  /portal/billing/subscription:
    get:
      summary: Get current subscription
      operationId: getSubscription
      tags: [Subscription]
      security:
        - bearerAuth: []
      parameters:
        - name: X-Tenant-ID
          in: header
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Subscription details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /portal/billing/plans:
    get:
      summary: List available plans
      operationId: listPlans
      tags: [Plans]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Available plans
          content:
            application/json:
              schema:
                type: object
                properties:
                  plans:
                    type: array
                    items:
                      $ref: '#/components/schemas/Plan'

  /portal/billing/plan/change:
    post:
      summary: Change subscription plan
      operationId: changePlan
      tags: [Subscription]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePlanRequest'
      responses:
        '200':
          description: Plan change initiated (downgrade scheduled)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanChangeResponse'
        '202':
          description: Checkout required for upgrade
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutRedirect'
        '400':
          $ref: '#/components/responses/BadRequest'

  /portal/billing/plan/preview:
    post:
      summary: Preview plan change proration
      operationId: previewPlanChange
      tags: [Subscription]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PreviewPlanRequest'
      responses:
        '200':
          description: Proration preview
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProrationPreview'

  /portal/billing/payments:
    get:
      summary: List payment history
      operationId: listPayments
      tags: [Payments]
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: Payment history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentListResponse'

  /portal/billing/invoices:
    get:
      summary: List invoices
      operationId: listInvoices
      tags: [Invoices]
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Invoice list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceListResponse'

  /portal/billing/invoices/{invoiceId}:
    get:
      summary: Get invoice details
      operationId: getInvoice
      tags: [Invoices]
      security:
        - bearerAuth: []
      parameters:
        - name: invoiceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Invoice details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '404':
          $ref: '#/components/responses/NotFound'

  /portal/billing/invoices/{invoiceId}/download:
    get:
      summary: Download invoice PDF
      operationId: downloadInvoice
      tags: [Invoices]
      security:
        - bearerAuth: []
      parameters:
        - name: invoiceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Invoice PDF download URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  downloadUrl:
                    type: string
                    format: uri
                  expiresAt:
                    type: string
                    format: date-time

  /portal/billing/checkout:
    post:
      summary: Create checkout session
      operationId: createCheckout
      tags: [Checkout]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCheckoutRequest'
      responses:
        '201':
          description: Checkout created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    SubscriptionResponse:
      type: object
      required:
        - subscriptionId
        - tenantId
        - plan
        - status
        - currentPeriodStart
        - currentPeriodEnd
      properties:
        subscriptionId:
          type: string
          format: uuid
        tenantId:
          type: string
          format: uuid
        plan:
          $ref: '#/components/schemas/Plan'
        status:
          type: string
          enum: [active, past_due, cancelled, trialing]
        currentPeriodStart:
          type: string
          format: date-time
        currentPeriodEnd:
          type: string
          format: date-time
        nextBillingDate:
          type: string
          format: date
        cancelAtPeriodEnd:
          type: boolean
        pendingChange:
          $ref: '#/components/schemas/PendingPlanChange'
        usage:
          $ref: '#/components/schemas/UsageMetrics'
        _links:
          $ref: '#/components/schemas/HATEOASLinks'

    Plan:
      type: object
      required:
        - planId
        - name
        - price
        - currency
        - interval
      properties:
        planId:
          type: string
        name:
          type: string
          example: "Professional"
        description:
          type: string
        price:
          type: number
          format: decimal
          example: 299.00
        currency:
          type: string
          default: ZAR
        interval:
          type: string
          enum: [monthly, annual]
        features:
          type: array
          items:
            type: string
        limits:
          type: object
          properties:
            sites:
              type: integer
            storage_gb:
              type: integer
            bandwidth_gb:
              type: integer

    ChangePlanRequest:
      type: object
      required:
        - newPlanId
      properties:
        newPlanId:
          type: string
        effectiveImmediately:
          type: boolean
          default: true
          description: For upgrades only

    PlanChangeResponse:
      type: object
      properties:
        changeType:
          type: string
          enum: [upgrade, downgrade]
        effectiveDate:
          type: string
          format: date
        message:
          type: string

    CheckoutRedirect:
      type: object
      properties:
        checkoutUrl:
          type: string
          format: uri
        orderId:
          type: string
          format: uuid
        amount:
          type: number
        currency:
          type: string

    ProrationPreview:
      type: object
      properties:
        currentPlan:
          $ref: '#/components/schemas/Plan'
        newPlan:
          $ref: '#/components/schemas/Plan'
        daysRemaining:
          type: integer
        creditAmount:
          type: number
        chargeAmount:
          type: number
        netAmount:
          type: number
        currency:
          type: string

    PendingPlanChange:
      type: object
      properties:
        newPlanId:
          type: string
        effectiveDate:
          type: string
          format: date
        changeType:
          type: string
          enum: [upgrade, downgrade]

    UsageMetrics:
      type: object
      properties:
        sitesUsed:
          type: integer
        sitesLimit:
          type: integer
        storageUsedGb:
          type: number
        storageLimitGb:
          type: integer
        bandwidthUsedGb:
          type: number
        bandwidthLimitGb:
          type: integer

    PaymentListResponse:
      type: object
      properties:
        payments:
          type: array
          items:
            $ref: '#/components/schemas/Payment'
        pagination:
          $ref: '#/components/schemas/Pagination'

    Payment:
      type: object
      properties:
        paymentId:
          type: string
          format: uuid
        amount:
          type: number
        currency:
          type: string
        status:
          type: string
          enum: [pending, completed, failed, refunded]
        method:
          type: string
        createdAt:
          type: string
          format: date-time
        invoiceId:
          type: string
          format: uuid

    InvoiceListResponse:
      type: object
      properties:
        invoices:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceSummary'
        pagination:
          $ref: '#/components/schemas/Pagination'

    InvoiceSummary:
      type: object
      properties:
        invoiceId:
          type: string
          format: uuid
        invoiceNumber:
          type: string
        amount:
          type: number
        currency:
          type: string
        status:
          type: string
          enum: [draft, issued, paid, void]
        issuedAt:
          type: string
          format: date-time
        dueDate:
          type: string
          format: date

    Invoice:
      allOf:
        - $ref: '#/components/schemas/InvoiceSummary'
        - type: object
          properties:
            tenant:
              type: object
              properties:
                name:
                  type: string
                email:
                  type: string
            lineItems:
              type: array
              items:
                $ref: '#/components/schemas/InvoiceLineItem'
            subtotal:
              type: number
            tax:
              type: number
            total:
              type: number
            paidAt:
              type: string
              format: date-time
            _links:
              $ref: '#/components/schemas/HATEOASLinks'

    InvoiceLineItem:
      type: object
      properties:
        description:
          type: string
        quantity:
          type: integer
        unitPrice:
          type: number
        amount:
          type: number

    CreateCheckoutRequest:
      type: object
      required:
        - planId
      properties:
        planId:
          type: string
        billingAddress:
          $ref: '#/components/schemas/BillingAddress'

    CheckoutResponse:
      type: object
      properties:
        checkoutId:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        paymentUrl:
          type: string
          format: uri
        expiresAt:
          type: string
          format: date-time

    BillingAddress:
      type: object
      properties:
        street:
          type: string
        city:
          type: string
        postalCode:
          type: string
        country:
          type: string

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    HATEOASLinks:
      type: object
      additionalProperties:
        type: object
        properties:
          href:
            type: string
          method:
            type: string

  responses:
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Unauthorized"

    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              details:
                type: object

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Not found"
```

---

## 5. Lambda Functions

### 5.1 Function Specifications

| Function | Handler | Memory | Timeout | Description |
|----------|---------|--------|---------|-------------|
| `get_subscription` | `handlers.billing.get_subscription.handler` | 256MB | 10s | Get subscription details |
| `list_plans` | `handlers.billing.list_plans.handler` | 256MB | 10s | List available plans |
| `change_plan` | `handlers.billing.change_plan.handler` | 512MB | 30s | Process plan change |
| `preview_plan_change` | `handlers.billing.preview_plan.handler` | 256MB | 10s | Calculate proration |
| `list_payments` | `handlers.billing.list_payments.handler` | 256MB | 10s | Payment history |
| `list_invoices` | `handlers.billing.list_invoices.handler` | 256MB | 10s | Invoice list |
| `get_invoice` | `handlers.billing.get_invoice.handler` | 256MB | 10s | Invoice details |
| `download_invoice` | `handlers.billing.download_invoice.handler` | 512MB | 30s | Generate PDF |
| `create_checkout` | `handlers.billing.create_checkout.handler` | 512MB | 30s | Initiate payment |

### 5.2 Lambda Layer Dependencies

```
python/
├── boto3
├── pydantic
├── aws-lambda-powertools
├── reportlab           # PDF generation
├── weasyprint          # HTML to PDF
└── requests            # PayFast API calls
```

### 5.3 Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `SUBSCRIPTION_TABLE` | DynamoDB table name | `dev-bbws-subscriptions` |
| `ORDER_TABLE` | DynamoDB orders table | `dev-bbws-orders` |
| `INVOICE_TABLE` | DynamoDB invoices table | `dev-bbws-invoices` |
| `PAYMENT_TABLE` | DynamoDB payments table | `dev-bbws-payments` |
| `INVOICE_BUCKET` | S3 bucket for PDFs | `dev-bbws-invoices` |
| `PAYFAST_SECRET_ARN` | Secrets Manager ARN | `arn:aws:secretsmanager:...` |
| `ENVIRONMENT` | Environment name | `dev` |
| `EVENT_BUS_NAME` | EventBridge bus | `bbws-events-dev` |

---

## 6. Sequence Diagrams

### 6.1 Get Subscription

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          GET SUBSCRIPTION SEQUENCE                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Frontend          API GW         Authorizer       Lambda          DynamoDB    │
│     │                │                │               │                │        │
│     │ GET /subscription               │               │                │        │
│     │───────────────►│                │               │                │        │
│     │                │ Validate JWT   │               │                │        │
│     │                │───────────────►│               │                │        │
│     │                │ IAM Policy     │               │                │        │
│     │                │◄───────────────│               │                │        │
│     │                │                │               │                │        │
│     │                │ Invoke Lambda  │               │                │        │
│     │                │───────────────────────────────►│                │        │
│     │                │                │               │ Query          │        │
│     │                │                │               │ Subscription   │        │
│     │                │                │               │───────────────►│        │
│     │                │                │               │ Data           │        │
│     │                │                │               │◄───────────────│        │
│     │                │                │               │                │        │
│     │                │                │               │ Query Usage    │        │
│     │                │                │               │───────────────►│        │
│     │                │                │               │ Metrics        │        │
│     │                │                │               │◄───────────────│        │
│     │                │                │               │                │        │
│     │                │ Response       │               │                │        │
│     │◄───────────────│◄──────────────────────────────│                │        │
│     │ { subscription, usage, _links } │               │                │        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Plan Upgrade Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           PLAN UPGRADE SEQUENCE                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Frontend     Lambda       DynamoDB      Order Svc     PayFast     EventBridge │
│     │           │             │             │             │             │       │
│     │ POST /plan/change       │             │             │             │       │
│     │──────────►│             │             │             │             │       │
│     │           │ Get Current │             │             │             │       │
│     │           │ Subscription│             │             │             │       │
│     │           │────────────►│             │             │             │       │
│     │           │◄────────────│             │             │             │       │
│     │           │             │             │             │             │       │
│     │           │ Calculate Proration       │             │             │       │
│     │           │ (Days remaining × rate)   │             │             │       │
│     │           │             │             │             │             │       │
│     │           │ Create Order│             │             │             │       │
│     │           │────────────────────────────►            │             │       │
│     │           │◄────────────────────────────            │             │       │
│     │           │             │             │             │             │       │
│     │           │ Initiate Payment          │             │             │       │
│     │           │────────────────────────────────────────►│             │       │
│     │           │ Checkout URL│             │             │             │       │
│     │           │◄────────────────────────────────────────│             │       │
│     │           │             │             │             │             │       │
│     │ 202 { checkoutUrl }     │             │             │             │       │
│     │◄──────────│             │             │             │             │       │
│     │           │             │             │             │             │       │
│     │ Redirect to PayFast     │             │             │             │       │
│     │═══════════════════════════════════════════════════►│             │       │
│     │           │             │             │             │             │       │
│     │           │             │    ITN Webhook (Async)    │             │       │
│     │           │◄════════════════════════════════════════│             │       │
│     │           │             │             │             │             │       │
│     │           │ Update Subscription (new plan)          │             │       │
│     │           │────────────►│             │             │             │       │
│     │           │             │             │             │             │       │
│     │           │ Emit payment.success      │             │             │       │
│     │           │────────────────────────────────────────────────────────►      │
│     │           │             │             │             │             │       │
│     │ Redirect to success page│             │             │             │       │
│     │◄═══════════════════════════════════════════════════│             │       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.3 Plan Downgrade Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          PLAN DOWNGRADE SEQUENCE                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Frontend          Lambda          DynamoDB        EventBridge    Cron Job      │
│     │                │                │                │             │          │
│     │ POST /plan/change (downgrade)   │                │             │          │
│     │───────────────►│                │                │             │          │
│     │                │ Get Subscription                │             │          │
│     │                │───────────────►│                │             │          │
│     │                │◄───────────────│                │             │          │
│     │                │                │                │             │          │
│     │                │ Validate (not already pending)  │             │          │
│     │                │                │                │             │          │
│     │                │ Update pendingChange            │             │          │
│     │                │ { newPlanId, effectiveDate }    │             │          │
│     │                │───────────────►│                │             │          │
│     │                │◄───────────────│                │             │          │
│     │                │                │                │             │          │
│     │                │ Emit subscription.downgrade_scheduled          │          │
│     │                │───────────────────────────────►│             │          │
│     │                │                │                │             │          │
│     │ 200 { message: "Downgrade scheduled for {date}" }│             │          │
│     │◄───────────────│                │                │             │          │
│     │                │                │                │             │          │
│     │                │                │                │ At billing  │          │
│     │                │                │                │ date        │          │
│     │                │                │                │────────────►│          │
│     │                │                │                │             │ Apply    │
│     │                │                │◄───────────────────────────────         │
│     │                │                │ Update plan, clear pending    │          │
│     │                │                │                │             │          │
│     │                │ Emit subscription.plan_changed  │             │          │
│     │                │◄───────────────────────────────────────────────          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.4 Invoice Download

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         INVOICE DOWNLOAD SEQUENCE                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Frontend          Lambda          DynamoDB            S3                       │
│     │                │                │                 │                       │
│     │ GET /invoices/{id}/download     │                 │                       │
│     │───────────────►│                │                 │                       │
│     │                │ Get Invoice    │                 │                       │
│     │                │───────────────►│                 │                       │
│     │                │ Invoice data   │                 │                       │
│     │                │◄───────────────│                 │                       │
│     │                │                │                 │                       │
│     │                │ Check if PDF exists              │                       │
│     │                │──────────────────────────────────►                       │
│     │                │                │                 │                       │
│     │                │ [If not exists] Generate PDF     │                       │
│     │                │ (ReportLab/WeasyPrint)           │                       │
│     │                │                │                 │                       │
│     │                │ Upload PDF to S3                 │                       │
│     │                │──────────────────────────────────►                       │
│     │                │                │                 │                       │
│     │                │ Generate Signed URL (15 min)     │                       │
│     │                │──────────────────────────────────►                       │
│     │                │ Signed URL     │                 │                       │
│     │                │◄──────────────────────────────────                       │
│     │                │                │                 │                       │
│     │ { downloadUrl, expiresAt }      │                 │                       │
│     │◄───────────────│                │                 │                       │
│     │                │                │                 │                       │
│     │ Download PDF via signed URL     │                 │                       │
│     │══════════════════════════════════════════════════►                       │
│     │◄══════════════════════════════════════════════════                       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Data Models

### 7.1 DynamoDB Single Table Design

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    BILLING DYNAMODB TABLE DESIGN                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│ Table: bbws-billing-{env}                                                       │
│ Capacity: On-Demand                                                             │
│ PITR: Enabled                                                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│ Primary Key:                                                                    │
│   PK: Partition Key (String)                                                    │
│   SK: Sort Key (String)                                                         │
│                                                                                 │
│ GSIs:                                                                           │
│   GSI1: GSI1PK (PK), GSI1SK (SK) - Status queries                              │
│   GSI2: GSI2PK (PK), GSI2SK (SK) - Date-based queries                          │
│                                                                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│ Entity: Subscription                                                            │
│ ─────────────────────                                                           │
│ PK: TENANT#{tenantId}                                                           │
│ SK: SUBSCRIPTION#{subscriptionId}                                               │
│ GSI1PK: SUBSCRIPTION_STATUS#{status}                                            │
│ GSI1SK: {nextBillingDate}                                                       │
│                                                                                 │
│ Attributes:                                                                     │
│   - subscriptionId (String, UUID)                                               │
│   - tenantId (String, UUID)                                                     │
│   - organisationId (String, UUID)                                               │
│   - planId (String)                                                             │
│   - planName (String)                                                           │
│   - status (String: active|past_due|cancelled|trialing)                        │
│   - currentPeriodStart (String, ISO8601)                                        │
│   - currentPeriodEnd (String, ISO8601)                                          │
│   - nextBillingDate (String, ISO8601)                                           │
│   - cancelAtPeriodEnd (Boolean)                                                 │
│   - pendingChange (Map: { newPlanId, effectiveDate, changeType })              │
│   - paymentMethodId (String)                                                    │
│   - createdAt (String, ISO8601)                                                 │
│   - updatedAt (String, ISO8601)                                                 │
│                                                                                 │
│ Entity: Invoice                                                                 │
│ ───────────────────                                                             │
│ PK: TENANT#{tenantId}                                                           │
│ SK: INVOICE#{invoiceId}                                                         │
│ GSI1PK: INVOICE_STATUS#{status}                                                 │
│ GSI1SK: {issuedAt}                                                              │
│ GSI2PK: TENANT#{tenantId}                                                       │
│ GSI2SK: INVOICE#{issuedAt}                                                      │
│                                                                                 │
│ Attributes:                                                                     │
│   - invoiceId (String, UUID)                                                    │
│   - invoiceNumber (String, e.g., INV-2026-00001)                               │
│   - tenantId (String, UUID)                                                     │
│   - subscriptionId (String, UUID)                                               │
│   - status (String: draft|issued|paid|void)                                    │
│   - lineItems (List of { description, quantity, unitPrice, amount })           │
│   - subtotal (Number)                                                           │
│   - tax (Number)                                                                │
│   - total (Number)                                                              │
│   - currency (String: ZAR)                                                      │
│   - issuedAt (String, ISO8601)                                                  │
│   - dueDate (String, ISO8601)                                                   │
│   - paidAt (String, ISO8601, optional)                                          │
│   - pdfS3Key (String, optional)                                                 │
│   - createdAt (String, ISO8601)                                                 │
│   - updatedAt (String, ISO8601)                                                 │
│                                                                                 │
│ Entity: Payment                                                                 │
│ ────────────────                                                                │
│ PK: TENANT#{tenantId}                                                           │
│ SK: PAYMENT#{paymentId}                                                         │
│ GSI1PK: PAYMENT_STATUS#{status}                                                 │
│ GSI1SK: {createdAt}                                                             │
│ GSI2PK: ORDER#{orderId}                                                         │
│ GSI2SK: PAYMENT#{paymentId}                                                     │
│                                                                                 │
│ Attributes:                                                                     │
│   - paymentId (String, UUID)                                                    │
│   - tenantId (String, UUID)                                                     │
│   - orderId (String, UUID)                                                      │
│   - invoiceId (String, UUID)                                                    │
│   - amount (Number)                                                             │
│   - currency (String: ZAR)                                                      │
│   - status (String: pending|completed|failed|refunded)                         │
│   - method (String: card|eft|instant_eft)                                      │
│   - payfastReference (String)                                                   │
│   - failureReason (String, optional)                                            │
│   - createdAt (String, ISO8601)                                                 │
│   - updatedAt (String, ISO8601)                                                 │
│                                                                                 │
│ Entity: Plan                                                                    │
│ ────────────────                                                                │
│ PK: PLAN#{planId}                                                               │
│ SK: METADATA                                                                    │
│                                                                                 │
│ Attributes:                                                                     │
│   - planId (String)                                                             │
│   - name (String)                                                               │
│   - description (String)                                                        │
│   - price (Number)                                                              │
│   - currency (String: ZAR)                                                      │
│   - interval (String: monthly|annual)                                          │
│   - features (List of String)                                                   │
│   - limits (Map: { sites, storage_gb, bandwidth_gb })                          │
│   - isActive (Boolean)                                                          │
│   - sortOrder (Number)                                                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Access Patterns

| Access Pattern | PK | SK | Index |
|----------------|----|----|-------|
| Get subscription by tenant | TENANT#{tenantId} | SUBSCRIPTION# | Table |
| List subscriptions by status | SUBSCRIPTION_STATUS#{status} | {nextBillingDate} | GSI1 |
| Get invoice by ID | TENANT#{tenantId} | INVOICE#{invoiceId} | Table |
| List invoices by tenant | TENANT#{tenantId} | INVOICE# | GSI2 |
| List invoices by status | INVOICE_STATUS#{status} | {issuedAt} | GSI1 |
| Get payment by ID | TENANT#{tenantId} | PAYMENT#{paymentId} | Table |
| List payments by tenant (date) | TENANT#{tenantId} | PAYMENT# | Table |
| Get payments for order | ORDER#{orderId} | PAYMENT# | GSI2 |
| Get plan by ID | PLAN#{planId} | METADATA | Table |
| List all active plans | Scan with filter | - | Table |

---

## 8. PayFast Integration

### 8.1 Integration Overview

| Integration Point | Method | Purpose |
|-------------------|--------|---------|
| Generate Signature | HMAC-MD5 | Request authentication |
| Payment Request | POST | Initiate payment |
| ITN Callback | POST | Receive payment notification |
| Query Transaction | GET | Verify payment status |

### 8.2 PayFast Configuration

```python
# src/services/payfast_client.py

class PayFastClient:
    def __init__(self, merchant_id: str, merchant_key: str, passphrase: str, sandbox: bool = False):
        self.merchant_id = merchant_id
        self.merchant_key = merchant_key
        self.passphrase = passphrase
        self.base_url = "https://sandbox.payfast.co.za" if sandbox else "https://www.payfast.co.za"

    def generate_signature(self, data: dict) -> str:
        """Generate MD5 signature for PayFast request."""
        # Sort and join parameters
        params = "&".join(f"{k}={quote_plus(str(v))}" for k, v in sorted(data.items()) if v)
        if self.passphrase:
            params += f"&passphrase={quote_plus(self.passphrase)}"
        return hashlib.md5(params.encode()).hexdigest()

    def create_checkout_url(self, order: Order) -> str:
        """Generate PayFast checkout URL."""
        data = {
            "merchant_id": self.merchant_id,
            "merchant_key": self.merchant_key,
            "return_url": f"{self.return_base_url}/billing/success?orderId={order.order_id}",
            "cancel_url": f"{self.return_base_url}/billing/cancelled?orderId={order.order_id}",
            "notify_url": f"{self.api_base_url}/webhooks/payfast/itn",
            "m_payment_id": order.order_id,
            "amount": f"{order.total:.2f}",
            "item_name": order.description,
            "item_description": f"Subscription: {order.plan_name}",
            "email_address": order.customer_email,
        }
        data["signature"] = self.generate_signature(data)
        return f"{self.base_url}/eng/process?" + urlencode(data)

    def verify_itn_signature(self, data: dict, signature: str) -> bool:
        """Verify ITN callback signature."""
        expected = self.generate_signature(data)
        return hmac.compare_digest(expected, signature)
```

### 8.3 ITN Webhook Handler

```python
# src/handlers/webhooks/payfast_itn.py

@tracer.capture_lambda_handler
def handler(event: dict, context: LambdaContext) -> dict:
    """Handle PayFast ITN (Instant Transaction Notification)."""
    body = parse_form_data(event["body"])

    # Verify signature
    signature = body.pop("signature", None)
    if not payfast_client.verify_itn_signature(body, signature):
        logger.warning("Invalid ITN signature")
        return {"statusCode": 400}

    # Verify source IP (PayFast IPs)
    source_ip = event["requestContext"]["identity"]["sourceIp"]
    if not is_payfast_ip(source_ip):
        logger.warning(f"Invalid source IP: {source_ip}")
        return {"statusCode": 403}

    payment_status = body.get("payment_status")
    order_id = body.get("m_payment_id")

    if payment_status == "COMPLETE":
        # Update subscription, create invoice
        await process_successful_payment(order_id, body)
    elif payment_status in ["FAILED", "CANCELLED"]:
        await process_failed_payment(order_id, body)

    return {"statusCode": 200}
```

---

## 9. Security

### 9.1 Security Controls

| Control | Implementation |
|---------|----------------|
| Authentication | Cognito JWT required for all endpoints |
| Authorization | Lambda Authorizer validates tenant access |
| Data Encryption | DynamoDB encryption at rest, TLS in transit |
| Secrets | PayFast credentials in Secrets Manager |
| Audit Logging | All billing operations logged to CloudWatch |
| PCI Compliance | No card data stored; PayFast handles payment |
| IP Whitelisting | ITN webhook restricted to PayFast IPs |

### 9.2 Tenant Isolation

```python
# All queries include tenant_id from JWT claims
def get_subscription(tenant_id: str) -> Subscription:
    response = table.query(
        KeyConditionExpression="PK = :pk AND begins_with(SK, :sk)",
        ExpressionAttributeValues={
            ":pk": f"TENANT#{tenant_id}",
            ":sk": "SUBSCRIPTION#"
        }
    )
    return Subscription.parse_obj(response["Items"][0]) if response["Items"] else None
```

---

## 10. Error Handling

### 10.1 Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| BILLING_001 | 404 | Subscription not found |
| BILLING_002 | 400 | Invalid plan change (same plan) |
| BILLING_003 | 400 | Downgrade already pending |
| BILLING_004 | 400 | Cannot downgrade below usage |
| BILLING_005 | 402 | Payment required |
| BILLING_006 | 404 | Invoice not found |
| BILLING_007 | 503 | PayFast unavailable |
| BILLING_008 | 400 | Invalid proration calculation |

### 10.2 Error Response Format

```json
{
  "error": {
    "code": "BILLING_004",
    "message": "Cannot downgrade: current usage exceeds new plan limits",
    "details": {
      "currentSites": 5,
      "newPlanLimit": 3
    }
  }
}
```

---

## 11. Monitoring and Alerting

### 11.1 CloudWatch Metrics

| Metric | Namespace | Description |
|--------|-----------|-------------|
| SubscriptionViews | BillingService | GET /subscription count |
| PlanChanges | BillingService | Plan change requests |
| PaymentSuccess | BillingService | Successful payments |
| PaymentFailure | BillingService | Failed payments |
| InvoiceGeneration | BillingService | Invoices generated |
| CheckoutAbandonment | BillingService | Abandoned checkouts |

### 11.2 CloudWatch Alarms

| Alarm | Threshold | Action |
|-------|-----------|--------|
| PaymentFailureRate | > 5% in 5min | SNS → PagerDuty |
| ITNProcessingErrors | > 3 in 5min | SNS → Engineering |
| HighCheckoutLatency | > 5s p95 | SNS → Engineering |
| InvoiceGenerationFailure | > 1 in 15min | SNS → Engineering |

### 11.3 Audit Events (EventBridge)

| Event | Detail Type | Trigger |
|-------|-------------|---------|
| subscription.created | SubscriptionCreated | New subscription |
| subscription.plan_changed | SubscriptionPlanChanged | Plan upgrade/downgrade |
| subscription.cancelled | SubscriptionCancelled | Cancellation |
| payment.success | PaymentSucceeded | Successful payment |
| payment.failed | PaymentFailed | Failed payment |
| invoice.generated | InvoiceGenerated | New invoice |

---

## 12. NFRs

| NFR | Target | Measurement |
|-----|--------|-------------|
| API Latency (p99) | < 500ms | CloudWatch |
| Availability | 99.9% | CloudWatch |
| Payment Processing | < 3s | Custom metric |
| Invoice Generation | < 10s | Custom metric |
| Concurrent Users | 100/tenant | Load test |
| Data Retention | 7 years (invoices) | DynamoDB TTL |

---

## 13. Troubleshooting Playbook

### 13.1 Payment Not Reflected

1. Check CloudWatch logs for ITN handler
2. Verify PayFast transaction in merchant portal
3. Check DynamoDB for payment record
4. Manually trigger payment reconciliation if needed

### 13.2 Invoice PDF Generation Failure

1. Check Lambda logs for errors
2. Verify S3 bucket permissions
3. Check ReportLab/WeasyPrint dependencies in layer
4. Regenerate PDF manually via admin API

### 13.3 Subscription Not Updated After Payment

1. Check EventBridge for payment.success event
2. Verify subscription update Lambda was triggered
3. Check DynamoDB for subscription record
4. Manually update subscription if ITN was lost

---

## 14. Tagging

| Tag Key | Value | Purpose |
|---------|-------|---------|
| Environment | dev/sit/prod | Environment identification |
| Project | bbws-portal | Project grouping |
| Component | billing-service | Component identification |
| Owner | platform-team | Ownership |
| CostCenter | portal | Cost allocation |
| ManagedBy | terraform | IaC tracking |

---

## 15. Risks and Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| PayFast downtime | Payment failures | Low | Retry queue, manual processing |
| ITN delivery failure | Subscription not updated | Medium | Periodic reconciliation job |
| Invoice PDF errors | Customer complaints | Low | Fallback to plain text email |
| Proration calculation errors | Revenue loss | Low | Comprehensive unit tests |
| Concurrent plan changes | Data inconsistency | Low | Optimistic locking in DynamoDB |

---

## 16. TBC

| Item | Description | Target Date |
|------|-------------|-------------|
| Subscription pause | Allow customers to pause subscription | Q2 2026 |
| Multiple payment methods | Store multiple cards | Q2 2026 |
| Usage-based billing | Metered billing for bandwidth | Q3 2026 |
| Dunning management | Automated failed payment recovery | Q2 2026 |

---

## 17. Definition of Terms

| Term | Definition |
|------|------------|
| Subscription | Recurring billing agreement for a plan |
| Plan | Product tier with pricing and limits |
| Proration | Pro-rated charge for mid-cycle changes |
| ITN | Instant Transaction Notification (PayFast webhook) |
| Invoice | Document detailing charges and payment |
| Dunning | Process of collecting failed payments |

---

## 18. Appendices

### 18.1 Plan Configuration

```json
{
  "plans": [
    {
      "planId": "entry",
      "name": "Entry",
      "price": 95.00,
      "currency": "ZAR",
      "interval": "monthly",
      "features": ["1 WordPress Site", "5GB Storage", "SSL Certificate"],
      "limits": { "sites": 1, "storage_gb": 5, "bandwidth_gb": 50 }
    },
    {
      "planId": "professional",
      "name": "Professional",
      "price": 299.00,
      "currency": "ZAR",
      "interval": "monthly",
      "features": ["5 WordPress Sites", "25GB Storage", "Priority Support"],
      "limits": { "sites": 5, "storage_gb": 25, "bandwidth_gb": 200 }
    },
    {
      "planId": "enterprise",
      "name": "Enterprise",
      "price": 999.00,
      "currency": "ZAR",
      "interval": "monthly",
      "features": ["Unlimited Sites", "100GB Storage", "24/7 Support", "SLA"],
      "limits": { "sites": -1, "storage_gb": 100, "bandwidth_gb": 1000 }
    }
  ]
}
```

### 18.2 Invoice Template Structure

```
┌─────────────────────────────────────────────────────┐
│                    INVOICE                          │
├─────────────────────────────────────────────────────┤
│ Invoice #: INV-2026-00123                           │
│ Date: January 20, 2026                              │
│ Due Date: January 20, 2026                          │
├─────────────────────────────────────────────────────┤
│ Bill To:                                            │
│   Acme Corporation                                  │
│   123 Main Street                                   │
│   Cape Town, 8001                                   │
│   South Africa                                      │
├─────────────────────────────────────────────────────┤
│ Description              Qty   Unit Price   Amount  │
│ ─────────────────────────────────────────────────   │
│ Professional Plan        1     R299.00     R299.00  │
│   (Jan 20 - Feb 19, 2026)                           │
├─────────────────────────────────────────────────────┤
│                          Subtotal:         R299.00  │
│                          VAT (15%):         R44.85  │
│                          ─────────────────────────  │
│                          Total:            R343.85  │
├─────────────────────────────────────────────────────┤
│ Payment Status: PAID                                │
│ Payment Date: January 20, 2026                      │
│ Payment Method: Credit Card                         │
└─────────────────────────────────────────────────────┘
```

---

## 19. References

| Document | Description |
|----------|-------------|
| [HLD 2.2](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md) | Parent High-Level Design |
| [BRS 2.2](../BRS/2.2_BRS_Customer_Portal_Private.md) | Business Requirements |
| [2.1.8_LLD_Order_Lambda](./2.1.8_LLD_Order_Lambda.md) | Order Processing LLD |
| [2.1.9_LLD_Payment_Lambda](./2.1.9_LLD_Payment_Lambda.md) | PayFast Integration LLD |
| [PayFast API Docs](https://developers.payfast.co.za/) | Payment gateway documentation |

---

## 20. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Tech Lead | | | |
| Backend Lead | | | |
| Finance Lead | | | |
| QA Lead | | | |
