# CPP Security Runbook

**Version**: 1.0
**Created**: 2025-12-15
**Status**: Draft
**Component**: Customer Portal Public - Security Operations
**Parent HLD**: [BBWS Customer Portal Public HLD](../BBWS_Customer_Portal_Public_HLD.md)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | Agentic Architect | Initial version |

---

## 1. Overview

### 1.1 Purpose

This runbook provides security procedures and incident response guidelines for the Customer Portal Public (CPP) application.

### 1.2 Security Architecture

| Layer | Controls |
|-------|----------|
| Edge | CloudFront, WAF, Shield |
| Network | VPC, Security Groups, NACLs |
| Application | Cognito, JWT, Input validation |
| Data | Encryption at rest, KMS |
| Identity | IAM, Cognito, Least privilege |

---

## 2. Security Controls

### 2.1 AWS WAF Rules

| Rule | Action | Description |
|------|--------|-------------|
| AWSManagedRulesCommonRuleSet | Block | Common attack patterns |
| AWSManagedRulesKnownBadInputsRuleSet | Block | Known malicious inputs |
| AWSManagedRulesSQLiRuleSet | Block | SQL injection |
| AWSManagedRulesLinuxRuleSet | Block | Linux-specific attacks |
| RateLimitRule | Block | >2000 requests/5min/IP |

### 2.2 WAF Configuration

```yaml
WebACL:
  Type: AWS::WAFv2::WebACL
  Properties:
    Name: bbws-${env}-waf
    Scope: CLOUDFRONT
    DefaultAction:
      Allow: {}
    Rules:
      - Name: AWSCommonRules
        Priority: 1
        OverrideAction:
          None: {}
        Statement:
          ManagedRuleGroupStatement:
            VendorName: AWS
            Name: AWSManagedRulesCommonRuleSet
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: AWSCommonRules
      - Name: RateLimit
        Priority: 2
        Action:
          Block: {}
        Statement:
          RateBasedStatement:
            Limit: 2000
            AggregateKeyType: IP
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: RateLimit
```

### 2.3 S3 Security

**All S3 buckets have public access blocked:**

```yaml
S3BucketPublicAccessBlock:
  Type: AWS::S3::PublicAccessBlockConfiguration
  Properties:
    BlockPublicAcls: true
    BlockPublicPolicy: true
    IgnorePublicAcls: true
    RestrictPublicBuckets: true
```

### 2.4 API Gateway Security

| Control | Configuration |
|---------|---------------|
| Throttling | 10,000 requests/second |
| Burst | 5,000 requests |
| Authentication | Cognito Authorizer (protected endpoints) |
| API Keys | Required for internal APIs |

---

## 3. Authentication & Authorization

### 3.1 Cognito Configuration

| Setting | Value |
|---------|-------|
| Password Policy | Min 8 chars, upper, lower, number, special |
| MFA | Optional (SMS/TOTP) |
| Token Expiry | Access: 1 hour, Refresh: 30 days |
| Account Recovery | Email verification |

### 3.2 JWT Validation

```python
def validate_jwt(token: str) -> dict:
    """Validate JWT token from Cognito."""
    try:
        # Get JWKS from Cognito
        jwks_url = f"https://cognito-idp.{REGION}.amazonaws.com/{USER_POOL_ID}/.well-known/jwks.json"

        # Decode and validate
        claims = jwt.decode(
            token,
            jwks_client.get_signing_key_from_jwt(token).key,
            algorithms=["RS256"],
            audience=CLIENT_ID,
            issuer=f"https://cognito-idp.{REGION}.amazonaws.com/{USER_POOL_ID}"
        )

        return claims
    except jwt.ExpiredSignatureError:
        raise UnauthorizedException("Token expired")
    except jwt.InvalidTokenError:
        raise UnauthorizedException("Invalid token")
```

### 3.3 Role-Based Access Control

| Role | Permissions |
|------|-------------|
| Anonymous | Browse products, view campaigns, contact |
| User | Cart, orders, profile |
| Admin | User management (via Admin Portal) |

---

## 4. Data Protection

### 4.1 Encryption at Rest

| Service | Encryption | Key |
|---------|------------|-----|
| DynamoDB | AES-256 | AWS managed |
| S3 | AES-256 | AWS managed |
| Secrets Manager | AES-256 | KMS CMK |
| CloudWatch Logs | AES-256 | AWS managed |

### 4.2 Encryption in Transit

| Connection | Protocol |
|------------|----------|
| Client to CloudFront | TLS 1.2+ |
| CloudFront to API Gateway | TLS 1.2 |
| API Gateway to Lambda | Internal AWS |
| Lambda to DynamoDB | TLS 1.2 |

### 4.3 Secrets Management

```bash
# Store secret
aws secretsmanager create-secret \
  --name bbws/${env}/payfast \
  --secret-string '{"merchantId":"xxx","merchantKey":"xxx","passphrase":"xxx"}'

# Rotate secret (90-day rotation)
aws secretsmanager rotate-secret \
  --secret-id bbws/${env}/payfast \
  --rotation-rules '{"AutomaticallyAfterDays": 90}'
```

### 4.4 PII Data Handling

| Data Type | Storage | Retention |
|-----------|---------|-----------|
| Email | DynamoDB (encrypted) | Account lifetime |
| Name | DynamoDB (encrypted) | Account lifetime |
| Payment details | NOT stored | N/A |
| Billing address | DynamoDB (encrypted) | Order lifetime |

---

## 5. Security Monitoring

### 5.1 CloudTrail Configuration

```yaml
CloudTrail:
  Type: AWS::CloudTrail::Trail
  Properties:
    TrailName: bbws-${env}-trail
    S3BucketName: bbws-${env}-cloudtrail-logs
    IsMultiRegionTrail: true
    EnableLogFileValidation: true
    IncludeGlobalServiceEvents: true
    EventSelectors:
      - ReadWriteType: All
        IncludeManagementEvents: true
        DataResources:
          - Type: AWS::S3::Object
            Values:
              - arn:aws:s3:::bbws-${env}-*/*
          - Type: AWS::Lambda::Function
            Values:
              - arn:aws:lambda:*:*:function:bbws-${env}-*
```

### 5.2 Security Alarms

```yaml
# Unauthorized API Call Alarm
UnauthorizedApiCallAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: bbws-${env}-unauthorized-api
    MetricName: UnauthorizedAttemptCount
    Namespace: CloudTrailMetrics
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 1
    Threshold: 10
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref SecuritySNSTopic

# Root Login Alarm
RootLoginAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: bbws-${env}-root-login
    MetricName: RootAccountUsage
    Namespace: CloudTrailMetrics
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 1
    Threshold: 0
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref SecuritySNSTopic
```

### 5.3 WAF Monitoring

```sql
-- WAF blocked requests query
fields @timestamp, action, httpRequest.clientIp, httpRequest.uri
| filter action = "BLOCK"
| sort @timestamp desc
| limit 100
```

---

## 6. Incident Response Procedures

### 6.1 Incident Classification

| Severity | Description | Response Time |
|----------|-------------|---------------|
| Critical | Data breach, system compromise | Immediate |
| High | Suspected intrusion, DDoS | 15 minutes |
| Medium | Failed login attempts, WAF blocks | 1 hour |
| Low | Security scan detected | Next business day |

### 6.2 Incident Response Steps

#### Step 1: Detection & Triage

```bash
# Check recent security events
aws logs filter-log-events \
  --log-group-name /aws/cloudtrail/bbws-${env} \
  --filter-pattern "{ $.errorCode = \"*UnauthorizedAccess*\" }"

# Check WAF logs
aws wafv2 get-sampled-requests \
  --web-acl-arn <web-acl-arn> \
  --rule-metric-name RateLimit \
  --scope CLOUDFRONT \
  --time-window StartTime=$(date -u -d '1 hour ago' +%s),EndTime=$(date -u +%s) \
  --max-items 100
```

#### Step 2: Containment

```bash
# Block IP via WAF
aws wafv2 update-ip-set \
  --name bbws-${env}-blocked-ips \
  --scope CLOUDFRONT \
  --id <ip-set-id> \
  --addresses "<malicious-ip>/32" \
  --lock-token <lock-token>

# Disable compromised user
aws cognito-idp admin-disable-user \
  --user-pool-id <user-pool-id> \
  --username <username>

# Revoke API keys if compromised
aws apigateway delete-api-key \
  --api-key <api-key-id>
```

#### Step 3: Investigation

```bash
# Get CloudTrail events for suspicious IP
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=Username,AttributeValue=<username> \
  --start-time $(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ)

# Check Lambda invocations
aws logs filter-log-events \
  --log-group-name /aws/lambda/bbws-${env}-auth \
  --filter-pattern "{ $.sourceIp = \"<suspicious-ip>\" }"
```

#### Step 4: Eradication & Recovery

```bash
# Force password reset for affected users
aws cognito-idp admin-reset-user-password \
  --user-pool-id <user-pool-id> \
  --username <username>

# Rotate compromised secrets
aws secretsmanager rotate-secret \
  --secret-id bbws/${env}/payfast

# Redeploy affected services
./scripts/deploy-all.sh ${env}
```

#### Step 5: Post-Incident Review

- [ ] Document incident timeline
- [ ] Identify root cause
- [ ] Document remediation steps
- [ ] Update runbooks
- [ ] Schedule lessons learned meeting

---

## 7. Security Checklists

### 7.1 Daily Security Checks

- [ ] Review WAF blocked requests
- [ ] Check for failed login attempts
- [ ] Verify CloudTrail logging active
- [ ] Review security alarms

### 7.2 Weekly Security Checks

- [ ] Review IAM access analyzer findings
- [ ] Check for unused credentials
- [ ] Review API Gateway access logs
- [ ] Verify backup integrity

### 7.3 Monthly Security Checks

- [ ] Review and rotate secrets
- [ ] Audit IAM policies
- [ ] Review security group rules
- [ ] Run vulnerability scan
- [ ] Review AWS Config compliance

---

## 8. Compliance Requirements

### 8.1 POPIA Compliance

| Requirement | Implementation |
|-------------|----------------|
| Lawful processing | User consent at registration |
| Purpose limitation | Only collect necessary data |
| Data minimization | PII limited to name, email, phone |
| Storage limitation | Retention policies defined |
| Security safeguards | Encryption, access controls |

### 8.2 PCI DSS Compliance

| Requirement | Implementation |
|-------------|----------------|
| No card data storage | PayFast handles all card data |
| Secure transmission | TLS 1.2+ everywhere |
| Access controls | IAM, Cognito |
| Logging | CloudTrail, CloudWatch |

---

## 9. Security Contacts

| Role | Name | Contact |
|------|------|---------|
| Security Lead | TBD | TBD |
| DevOps Lead | TBD | TBD |
| AWS Security | Enterprise Support | Support Portal |
| POPIA Officer | TBD | TBD |

---

## 10. Vulnerability Management

### 10.1 Vulnerability Scanning

```bash
# Run dependency scan
pip-audit -r requirements.txt

# Run Trivy scan on container images (if applicable)
trivy image bbws/${service}:latest

# Run SAST scan
bandit -r src/ -f json -o bandit-report.json
```

### 10.2 Patch Management

| Component | Patch Frequency | Responsibility |
|-----------|-----------------|----------------|
| Lambda runtime | AWS managed | AWS |
| Python packages | Monthly | DevOps |
| Node.js packages | Monthly | DevOps |
| Terraform providers | Quarterly | DevOps |

---

## 11. Access Management

### 11.1 AWS Account Access

| Role | Access Level | MFA Required |
|------|--------------|--------------|
| Admin | Full access | Yes |
| Developer | Dev environment only | Yes |
| ReadOnly | Prod read-only | Yes |

### 11.2 Principle of Least Privilege

```yaml
# Example Lambda execution role
LambdaExecutionRole:
  Type: AWS::IAM::Role
  Properties:
    AssumeRolePolicyDocument:
      Version: '2012-10-17'
      Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
    Policies:
      - PolicyName: MinimalAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource: !GetAtt DynamoDBTable.Arn
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${FunctionName}:*'
```

---

## 12. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Security Lead | | | |
| Tech Lead | | | |
| Compliance Officer | | | |

---

**End of Document**
