# CPP Troubleshooting Runbook

**Version**: 1.0
**Created**: 2025-12-15
**Status**: Draft
**Component**: Customer Portal Public - Troubleshooting Guide
**Parent HLD**: [BBWS Customer Portal Public HLD](../BBWS_Customer_Portal_Public_HLD.md)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | Agentic Architect | Initial version |

---

## 1. Overview

### 1.1 Purpose

This runbook provides step-by-step troubleshooting procedures for common issues in the Customer Portal Public (CPP) application.

### 1.2 Quick Reference

| Issue Category | Jump To |
|----------------|---------|
| Frontend Issues | [Section 2](#2-frontend-issues) |
| API Gateway Issues | [Section 3](#3-api-gateway-issues) |
| Lambda Issues | [Section 4](#4-lambda-issues) |
| DynamoDB Issues | [Section 5](#5-dynamodb-issues) |
| Authentication Issues | [Section 6](#6-authentication-issues) |
| Payment Issues | [Section 7](#7-payment-issues) |
| Performance Issues | [Section 8](#8-performance-issues) |

---

## 2. Frontend Issues

### 2.1 Page Not Loading (White Screen)

**Symptoms**: User sees blank page, browser console shows errors

**Diagnosis**:
```bash
# Check CloudFront distribution
aws cloudfront get-distribution --id $DISTRIBUTION_ID

# Check S3 bucket
aws s3 ls s3://bbws-${env}-frontend/

# Check for index.html
aws s3 head-object --bucket bbws-${env}-frontend --key index.html
```

**Resolution**:
```bash
# Re-deploy frontend
cd 2_bbws_frontend
npm run build
aws s3 sync dist/ s3://bbws-${env}-frontend/ --delete

# Invalidate cache
aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
```

### 2.2 CloudFront 403 Forbidden

**Symptoms**: User sees "Access Denied" or 403 error

**Diagnosis**:
```bash
# Check bucket policy
aws s3api get-bucket-policy --bucket bbws-${env}-frontend

# Check OAI configuration
aws cloudfront get-distribution --id $DISTRIBUTION_ID \
  --query 'Distribution.DistributionConfig.Origins.Items[0].S3OriginConfig'
```

**Resolution**:
```bash
# Update bucket policy for OAI access
aws s3api put-bucket-policy --bucket bbws-${env}-frontend --policy '{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": {
      "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity <OAI_ID>"
    },
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::bbws-${env}-frontend/*"
  }]
}'
```

### 2.3 CORS Errors

**Symptoms**: Browser console shows CORS policy errors

**Diagnosis**:
```bash
# Check API Gateway CORS configuration
aws apigateway get-method \
  --rest-api-id $API_ID \
  --resource-id $RESOURCE_ID \
  --http-method OPTIONS
```

**Resolution**:
```bash
# Enable CORS on API Gateway (via Terraform is preferred)
# Or manually add headers to Lambda response:
# 'Access-Control-Allow-Origin': '*'
# 'Access-Control-Allow-Headers': 'Content-Type,Authorization'
# 'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS'
```

---

## 3. API Gateway Issues

### 3.1 API Gateway 500 Internal Server Error

**Symptoms**: All API calls return 500 error

**Diagnosis**:
```bash
# Check API Gateway execution logs
aws logs tail /aws/apigateway/bbws-${env} --follow

# Check Lambda integration
aws apigateway get-integration \
  --rest-api-id $API_ID \
  --resource-id $RESOURCE_ID \
  --http-method GET
```

**Resolution**:
```bash
# Verify Lambda function exists and is accessible
aws lambda get-function --function-name bbws-${env}-<service>

# Check Lambda execution role permissions
aws iam get-role-policy --role-name bbws-${env}-lambda-role --policy-name DynamoDBAccess

# Redeploy API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name ${env}
```

### 3.2 API Gateway 429 Too Many Requests

**Symptoms**: Users getting throttled

**Diagnosis**:
```bash
# Check throttling settings
aws apigateway get-stage \
  --rest-api-id $API_ID \
  --stage-name ${env} \
  --query 'methodSettings'

# Check usage plans
aws apigateway get-usage-plans
```

**Resolution**:
```bash
# Increase throttling limits
aws apigateway update-stage \
  --rest-api-id $API_ID \
  --stage-name ${env} \
  --patch-operations op=replace,path=/throttling/rateLimit,value=10000

# Or update usage plan
aws apigateway update-usage-plan \
  --usage-plan-id $PLAN_ID \
  --patch-operations op=replace,path=/throttle/rateLimit,value=10000
```

### 3.3 API Gateway Timeout

**Symptoms**: Requests timeout after 30 seconds

**Diagnosis**:
```bash
# Check Lambda duration
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Duration \
  --dimensions Name=FunctionName,Value=bbws-${env}-<service> \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
  --period 300 \
  --statistics Maximum
```

**Resolution**:
- API Gateway has a 29-second hard limit
- Optimize Lambda code
- Consider async processing for long operations

---

## 4. Lambda Issues

### 4.1 Lambda Cold Start Issues

**Symptoms**: First request after idle period is slow

**Diagnosis**:
```bash
# Check cold start metrics
aws logs filter-log-events \
  --log-group-name /aws/lambda/bbws-${env}-<service> \
  --filter-pattern "REPORT" \
  --start-time $(date -u -d '1 hour ago' +%s000)
```

**Resolution**:
```bash
# Enable provisioned concurrency
aws lambda put-provisioned-concurrency-config \
  --function-name bbws-${env}-<service> \
  --qualifier live \
  --provisioned-concurrent-executions 5
```

### 4.2 Lambda Out of Memory

**Symptoms**: Lambda fails with "Runtime exited with error: signal: killed"

**Diagnosis**:
```bash
# Check memory usage
aws logs filter-log-events \
  --log-group-name /aws/lambda/bbws-${env}-<service> \
  --filter-pattern "Max Memory Used" \
  --start-time $(date -u -d '1 hour ago' +%s000)
```

**Resolution**:
```bash
# Increase memory allocation
aws lambda update-function-configuration \
  --function-name bbws-${env}-<service> \
  --memory-size 512
```

### 4.3 Lambda Permission Errors

**Symptoms**: Lambda fails with AccessDenied errors

**Diagnosis**:
```bash
# Check execution role
aws lambda get-function-configuration \
  --function-name bbws-${env}-<service> \
  --query 'Role'

# List role policies
aws iam list-attached-role-policies --role-name <role-name>
aws iam list-role-policies --role-name <role-name>
```

**Resolution**:
```bash
# Add missing permissions
aws iam put-role-policy \
  --role-name <role-name> \
  --policy-name DynamoDBAccess \
  --policy-document '{
    "Version": "2012-10-17",
    "Statement": [{
      "Effect": "Allow",
      "Action": ["dynamodb:*"],
      "Resource": "arn:aws:dynamodb:*:*:table/bbws-*"
    }]
  }'
```

### 4.4 Lambda Import Errors

**Symptoms**: Lambda fails to start with module import errors

**Diagnosis**:
```bash
# Check Lambda logs for import error
aws logs tail /aws/lambda/bbws-${env}-<service> --since 5m
```

**Resolution**:
```bash
# Rebuild deployment package with dependencies
pip install -r requirements.txt -t package/
cd package && zip -r ../deployment.zip .
cd .. && zip -g deployment.zip -r src/

# Update Lambda
aws lambda update-function-code \
  --function-name bbws-${env}-<service> \
  --zip-file fileb://deployment.zip
```

---

## 5. DynamoDB Issues

### 5.1 DynamoDB Throttling

**Symptoms**: ProvisionedThroughputExceededException errors

**Diagnosis**:
```bash
# Check throttled requests
aws cloudwatch get-metric-statistics \
  --namespace AWS/DynamoDB \
  --metric-name ThrottledRequests \
  --dimensions Name=TableName,Value=bbws-${env}-<table> \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
  --period 300 \
  --statistics Sum
```

**Resolution**:
```bash
# Tables should be on-demand, verify:
aws dynamodb describe-table \
  --table-name bbws-${env}-<table> \
  --query 'Table.BillingModeSummary'

# If not on-demand, switch:
aws dynamodb update-table \
  --table-name bbws-${env}-<table> \
  --billing-mode PAY_PER_REQUEST
```

### 5.2 DynamoDB Item Not Found

**Symptoms**: Data expected to exist returns null

**Diagnosis**:
```bash
# Query the item directly
aws dynamodb get-item \
  --table-name bbws-${env}-<table> \
  --key '{"PK": {"S": "ORDER#<id>"}, "SK": {"S": "METADATA"}}'

# Check if item exists with different key
aws dynamodb scan \
  --table-name bbws-${env}-<table> \
  --filter-expression "contains(PK, :id)" \
  --expression-attribute-values '{":id": {"S": "<id>"}}'
```

**Resolution**:
- Verify key format matches expected pattern
- Check if item was soft-deleted (active=false)
- Verify correct table is being queried

### 5.3 DynamoDB Global Table Replication Lag

**Symptoms**: Data not appearing in DR region

**Diagnosis**:
```bash
# Check replication status
aws dynamodb describe-table \
  --table-name bbws-${env}-<table> \
  --query 'Table.Replicas'

# Check replication latency metric
aws cloudwatch get-metric-statistics \
  --namespace AWS/DynamoDB \
  --metric-name ReplicationLatency \
  --dimensions Name=TableName,Value=bbws-${env}-<table> Name=ReceivingRegion,Value=eu-west-1 \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
  --period 300 \
  --statistics Average
```

**Resolution**:
- High latency is usually transient
- Check for throttling in either region
- Contact AWS support if persistent

---

## 6. Authentication Issues

### 6.1 User Cannot Login

**Symptoms**: Login fails with "Incorrect username or password"

**Diagnosis**:
```bash
# Check user exists
aws cognito-idp admin-get-user \
  --user-pool-id $USER_POOL_ID \
  --username <email>

# Check user status
aws cognito-idp admin-get-user \
  --user-pool-id $USER_POOL_ID \
  --username <email> \
  --query 'UserStatus'
```

**Resolution**:
```bash
# If user status is UNCONFIRMED, resend confirmation:
aws cognito-idp admin-confirm-sign-up \
  --user-pool-id $USER_POOL_ID \
  --username <email>

# If password reset needed:
aws cognito-idp admin-reset-user-password \
  --user-pool-id $USER_POOL_ID \
  --username <email>
```

### 6.2 JWT Token Expired

**Symptoms**: API returns 401 Unauthorized after successful login

**Diagnosis**:
```bash
# Decode JWT to check expiry (without verification)
echo $TOKEN | cut -d. -f2 | base64 -d | jq .exp

# Compare with current time
date +%s
```

**Resolution**:
- Frontend should refresh tokens automatically
- Check refresh token is being sent
- Verify refresh token hasn't expired (30 days)

### 6.3 Cognito Trigger Failures

**Symptoms**: Registration/login fails inconsistently

**Diagnosis**:
```bash
# Check Lambda trigger logs
aws logs tail /aws/lambda/bbws-${env}-cognito-trigger --since 5m

# List user pool triggers
aws cognito-idp describe-user-pool \
  --user-pool-id $USER_POOL_ID \
  --query 'UserPool.LambdaConfig'
```

**Resolution**:
- Check trigger Lambda permissions
- Verify trigger Lambda isn't timing out
- Check for errors in trigger Lambda logs

---

## 7. Payment Issues

### 7.1 PayFast Payment Not Processing

**Symptoms**: User redirected to PayFast but payment never completes

**Diagnosis**:
```bash
# Check payment record
aws dynamodb get-item \
  --table-name bbws-${env}-payments \
  --key '{"PK": {"S": "PAYMENT#<paymentId>"}, "SK": {"S": "METADATA"}}'

# Check webhook logs
aws logs filter-log-events \
  --log-group-name /aws/lambda/bbws-${env}-payment-webhook \
  --filter-pattern "paymentId" \
  --start-time $(date -u -d '1 hour ago' +%s000)
```

**Resolution**:
- Verify PayFast ITN endpoint is accessible
- Check PayFast dashboard for payment status
- Manually update order if payment confirmed in PayFast

### 7.2 ITN Webhook Not Received

**Symptoms**: Payment shows complete in PayFast but order stuck in PENDING

**Diagnosis**:
```bash
# Check API Gateway access logs for POST /payments/webhook
aws logs filter-log-events \
  --log-group-name /aws/apigateway/bbws-${env} \
  --filter-pattern "POST /v1.0/payments/webhook" \
  --start-time $(date -u -d '1 hour ago' +%s000)

# Verify PayFast IP whitelist
# PayFast IPs: 197.97.145.144/28, 197.97.145.160/28, 41.74.179.192/27
```

**Resolution**:
```bash
# Verify WAF isn't blocking PayFast
aws wafv2 get-sampled-requests \
  --web-acl-arn <waf-arn> \
  --rule-metric-name RateLimit \
  --scope REGIONAL \
  --time-window StartTime=$(date -u -d '1 hour ago' +%s),EndTime=$(date -u +%s) \
  --max-items 100

# Add PayFast IPs to allow list if blocked
```

### 7.3 Payment Signature Validation Failed

**Symptoms**: Webhook returns 400 "Invalid signature"

**Diagnosis**:
```bash
# Check signature calculation in logs
aws logs filter-log-events \
  --log-group-name /aws/lambda/bbws-${env}-payment-webhook \
  --filter-pattern "signature" \
  --start-time $(date -u -d '1 hour ago' +%s000)
```

**Resolution**:
- Verify passphrase matches PayFast dashboard
- Check URL encoding of parameters
- Ensure parameter order is alphabetical

---

## 8. Performance Issues

### 8.1 High API Latency

**Symptoms**: API responses taking >3 seconds

**Diagnosis**:
```bash
# Check Lambda duration
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Duration \
  --dimensions Name=FunctionName,Value=bbws-${env}-<service> \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
  --period 300 \
  --statistics p95

# Check DynamoDB latency
aws cloudwatch get-metric-statistics \
  --namespace AWS/DynamoDB \
  --metric-name SuccessfulRequestLatency \
  --dimensions Name=TableName,Value=bbws-${env}-<table> Name=Operation,Value=Query \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
  --period 300 \
  --statistics Average
```

**Resolution**:
- Add DynamoDB indexes for common queries
- Enable Lambda provisioned concurrency
- Optimize Lambda code (reduce dependencies)
- Use X-Ray to identify bottlenecks

### 8.2 CloudFront Cache Miss Rate High

**Symptoms**: Origin receiving too many requests

**Diagnosis**:
```bash
# Check cache hit ratio
aws cloudwatch get-metric-statistics \
  --namespace AWS/CloudFront \
  --metric-name CacheHitRate \
  --dimensions Name=DistributionId,Value=$DISTRIBUTION_ID \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
  --period 300 \
  --statistics Average
```

**Resolution**:
```bash
# Verify cache headers on S3 objects
aws s3api head-object \
  --bucket bbws-${env}-frontend \
  --key index.html \
  --query 'CacheControl'

# Update cache headers
aws s3 cp s3://bbws-${env}-frontend/static/ s3://bbws-${env}-frontend/static/ \
  --recursive \
  --cache-control "max-age=31536000" \
  --metadata-directive REPLACE
```

---

## 9. Common Log Queries

### 9.1 Find All Errors in Last Hour

```sql
fields @timestamp, @message, @logStream
| filter @message like /ERROR|Exception|error/
| sort @timestamp desc
| limit 200
```

### 9.2 Find Slow Requests

```sql
fields @timestamp, @message, @duration
| filter @type = "REPORT"
| filter @duration > 5000
| sort @duration desc
| limit 100
```

### 9.3 Find Failed Payments

```sql
fields @timestamp, @message, orderId, paymentId
| filter @message like /PaymentFailed|FAILED|signature/
| sort @timestamp desc
| limit 100
```

### 9.4 Track User Journey

```sql
fields @timestamp, @message, tenantId
| filter tenantId = "<tenant-id>"
| sort @timestamp asc
| limit 500
```

---

## 10. Contacts

| Issue Type | Primary Contact | Escalation |
|------------|-----------------|------------|
| Frontend | Frontend Dev | Tech Lead |
| API/Lambda | Backend Dev | Tech Lead |
| Infrastructure | DevOps | DevOps Lead |
| Payments | Backend Dev | Tech Lead + Business |
| Security | DevOps | Security Lead |

---

## 11. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Tech Lead | | | |
| DevOps Lead | | | |

---

**End of Document**
