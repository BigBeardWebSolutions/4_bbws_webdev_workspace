# CPP Invitation Lambda - Low-Level Design

**Version**: 1.0
**Created**: 2025-12-15
**Status**: Draft
**Component**: Invitation Service (2_bbws_invitation_lambda)
**Parent BRS**: [BRS 2.1.6: Invitation Management](../BRS/2.1.6_BRS_Invitation_Management.md)
**Parent HLD**: [HLD 2.1.6: Invitation Management](../HLDs/2.1.6_HLD_Invitation_Management.md)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | Agentic Architect | Initial version |

---

## 1. Introduction

### 1.1 Purpose

This LLD provides implementation-level details for the Invitation Lambda service, which handles organisation and tenant invitations for the Customer Portal Public application.

### 1.2 Component Overview

| Attribute | Value |
|-----------|-------|
| Repository | `2_bbws_invitation_lambda` |
| Runtime | Python 3.12 |
| Memory | 256MB |
| Timeout | 30s |
| Architecture | arm64 |

### 1.3 Lambda Functions (3 Total)

| Function | Endpoint | Description |
|----------|----------|-------------|
| get_invitation | GET /v1.0/invitations/{token} | Get invitation details |
| accept_invitation | POST /v1.0/invitations/{token}/accept | Accept invitation |
| decline_invitation | POST /v1.0/invitations/{token}/decline | Decline invitation |

---

## 2. High Level Epic Overview

| User Story # | Epic | User Story | Test Scenario(s) |
|--------------|------|------------|------------------|
| US-INV-001 | Invitations | As a user, I want to view invitation details | Given valid token, then invitation info shown |
| US-INV-002 | Invitations | As a user, I want to accept an invitation | Given accept, then user added to organisation |
| US-INV-003 | Invitations | As a user, I want to decline an invitation | Given decline, then invitation marked declined |
| US-INV-004 | Invitations | As a user, I see error for expired invitation | Given expired token, then 400 returned |

---

## 3. Component Diagram

```mermaid
classDiagram
    class InvitationHandler {
        -InvitationService invitationService
        -ResponseBuilder responseBuilder
        +handleGet(event dict, context LambdaContext) dict
        +handleAccept(event dict, context LambdaContext) dict
        +handleDecline(event dict, context LambdaContext) dict
    }

    class InvitationService {
        -InvitationRepository repository
        -TenantService tenantService
        -EmailService emailService
        +getInvitation(token str) Invitation
        +acceptInvitation(token str) void
        +declineInvitation(token str) void
        -validateInvitation(invitation Invitation) void
        -addUserToOrganisation(invitation Invitation) void
    }

    class InvitationRepository {
        -Table table
        +findByToken(token str) Optional~Invitation~
        +update(invitation Invitation) Invitation
        -toEntity(item dict) Invitation
    }

    class TenantService {
        -TenantRepository repository
        +addToOrganisation(tenantId str, orgId str, role str) void
    }

    class Invitation {
        +str invitationId
        +str token
        +str email
        +str organisationId
        +str organisationName
        +str role
        +InvitationStatus status
        +str expiresAt
        +bool active
        +str createdAt
    }

    class InvitationStatus {
        <<enumeration>>
        PENDING
        ACCEPTED
        DECLINED
        EXPIRED
    }

    class InvitationNotFoundException {
        +str message
    }

    class InvitationExpiredException {
        +str message
    }

    InvitationHandler --> InvitationService
    InvitationService --> InvitationRepository
    InvitationService --> TenantService
    InvitationRepository --> Invitation
    Invitation --> InvitationStatus
```

---

## 4. Sequence Diagrams

### 4.1 Get Invitation Flow

```mermaid
sequenceDiagram
    participant Client
    participant APIGateway
    participant InvitationHandler
    participant InvitationService
    participant InvitationRepository
    participant DynamoDB

    Client->>APIGateway: GET /v1.0/invitations/{token}
    APIGateway->>InvitationHandler: handleGet(event, context)

    rect rgb(240, 240, 255)
        Note over InvitationHandler: try block - Main Logic

        InvitationHandler->>InvitationService: getInvitation(token)

        InvitationService->>InvitationRepository: findByToken(token)
        InvitationRepository->>DynamoDB: query(TokenIndex, token)
        DynamoDB-->>InvitationRepository: item
        InvitationRepository-->>InvitationService: Optional~Invitation~

        alt Invitation not found
            InvitationService-->>InvitationHandler: throw InvitationNotFoundException
        end

        InvitationService->>InvitationService: validateInvitation(invitation)

        alt Invitation expired
            InvitationService-->>InvitationHandler: throw InvitationExpiredException
        end

        InvitationService-->>InvitationHandler: Invitation
        InvitationHandler-->>APIGateway: {statusCode: 200, body: invitation}
        APIGateway-->>Client: 200 OK
    end

    alt BusinessException (Expected Errors)
        Note over InvitationService: catch BusinessException
        InvitationHandler-->>APIGateway: {statusCode: 404, body: "Invitation not found"}
        InvitationHandler-->>APIGateway: {statusCode: 400, body: "Invitation expired"}
        APIGateway-->>Client: 404 / 400
    end

    alt UnexpectedException (System Errors)
        Note over InvitationHandler: catch UnexpectedException
        InvitationHandler->>InvitationHandler: logger.error(exception)
        InvitationHandler-->>APIGateway: {statusCode: 500, body: "Internal server error"}
        APIGateway-->>Client: 500 Internal Server Error
    end
```

### 4.2 Accept Invitation Flow

```mermaid
sequenceDiagram
    participant Client
    participant APIGateway
    participant InvitationHandler
    participant InvitationService
    participant InvitationRepository
    participant TenantService
    participant DynamoDB

    Client->>APIGateway: POST /v1.0/invitations/{token}/accept
    APIGateway->>InvitationHandler: handleAccept(event, context)

    rect rgb(240, 240, 255)
        Note over InvitationHandler: try block - Main Logic

        InvitationHandler->>InvitationService: acceptInvitation(token)

        InvitationService->>InvitationRepository: findByToken(token)
        InvitationRepository->>DynamoDB: query(TokenIndex, token)
        DynamoDB-->>InvitationRepository: item
        InvitationRepository-->>InvitationService: Invitation

        InvitationService->>InvitationService: validateInvitation(invitation)

        InvitationService->>TenantService: addToOrganisation(tenantId, orgId, role)
        TenantService->>DynamoDB: update_item(tenant)
        DynamoDB-->>TenantService: success
        TenantService-->>InvitationService: void

        InvitationService->>InvitationService: invitation.status = ACCEPTED
        InvitationService->>InvitationRepository: update(invitation)
        InvitationRepository->>DynamoDB: update_item(invitation)
        DynamoDB-->>InvitationRepository: success

        InvitationService-->>InvitationHandler: void
        InvitationHandler-->>APIGateway: {statusCode: 200, body: "Invitation accepted"}
        APIGateway-->>Client: 200 OK
    end

    alt BusinessException (Expected Errors)
        Note over InvitationService: catch BusinessException
        InvitationHandler-->>APIGateway: {statusCode: 400, body: "Invitation already used"}
        InvitationHandler-->>APIGateway: {statusCode: 400, body: "Invitation expired"}
        APIGateway-->>Client: 400 Bad Request
    end

    alt UnexpectedException (System Errors)
        Note over InvitationHandler: catch UnexpectedException
        InvitationHandler->>InvitationHandler: logger.error(exception)
        InvitationHandler-->>APIGateway: {statusCode: 500, body: "Internal server error"}
        APIGateway-->>Client: 500 Internal Server Error
    end
```

---

## 5. Data Models

### 5.1 DynamoDB Schema

#### Invitation Entity

| Attribute | Type | Description |
|-----------|------|-------------|
| PK | String | `INVITATION#{invitationId}` |
| SK | String | `METADATA` |
| invitationId | String | UUID |
| token | String | Unique token (URL-safe) |
| email | String | Invitee email |
| organisationId | String | Target organisation |
| organisationName | String | Organisation display name |
| role | String | Assigned role |
| status | String | PENDING, ACCEPTED, DECLINED, EXPIRED |
| expiresAt | String | ISO 8601 timestamp |
| active | Boolean | Soft delete flag |
| createdAt | String | ISO 8601 timestamp |

#### GSI: TokenIndex

| Attribute | Type |
|-----------|------|
| PK (token) | String |
| SK (status) | String |

### 5.2 Pydantic Models

```python
from pydantic import BaseModel, EmailStr, Field
from enum import Enum
from datetime import datetime

class InvitationStatus(str, Enum):
    PENDING = "PENDING"
    ACCEPTED = "ACCEPTED"
    DECLINED = "DECLINED"
    EXPIRED = "EXPIRED"

class Invitation(BaseModel):
    invitation_id: str = Field(..., alias="invitationId")
    token: str
    email: EmailStr
    organisation_id: str = Field(..., alias="organisationId")
    organisation_name: str = Field(..., alias="organisationName")
    role: str
    status: InvitationStatus
    expires_at: datetime = Field(..., alias="expiresAt")
    active: bool = True
    created_at: datetime = Field(..., alias="createdAt")

class InvitationResponse(BaseModel):
    email: EmailStr
    organisation_name: str = Field(..., alias="organisationName")
    role: str
    status: InvitationStatus
    expires_at: datetime = Field(..., alias="expiresAt")
    is_valid: bool = Field(..., alias="isValid")
```

---

## 6. Messaging and Notifications

| Event | Email Sent To | Template |
|-------|---------------|----------|
| Invitation accepted | Organisation admin | invitation_accepted |
| Invitation declined | Organisation admin | invitation_declined |

---

## 7. NFRs

| Metric | Target |
|--------|--------|
| Get invitation latency (p95) | < 200ms |
| Accept/decline latency (p95) | < 500ms |

---

## 8. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Token guessing | High | Use cryptographically secure tokens |
| Expired token usage | Low | Validate expiry on all operations |

---

## 9. Tagging

| Tag | Value |
|-----|-------|
| Project | BBWS |
| Component | InvitationLambda |
| CostCenter | BBWS-CPP |

---

## 10. Troubleshooting Playbook

| Issue | Resolution |
|-------|------------|
| Token not found | Verify token in DynamoDB TokenIndex |
| Already accepted | Check invitation status |

---

## 11. Security

- Tokens are cryptographically secure (UUID v4 + timestamp hash)
- Tokens expire after 7 days
- Single-use tokens (status changes on accept/decline)
- Rate limiting on token validation

---

## 12. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Technical Lead | | | |
| Business Owner | | | |

---

## 13. TBC

| # | Item | Status |
|---|------|--------|
| TBC-001 | Resend invitation functionality | Open |

---

## 14. Definition of Terms

| Term | Definition |
|------|------------|
| Invitation | Request to join an organisation |
| Token | Unique identifier for invitation URL |

---

## 15. Appendices

### Project Structure

```
2_bbws_invitation_lambda/
├── src/
│   ├── handlers/
│   │   ├── get_invitation.py
│   │   ├── accept_invitation.py
│   │   └── decline_invitation.py
│   ├── services/
│   │   ├── invitation_service.py
│   │   └── tenant_service.py
│   ├── repositories/
│   │   └── invitation_repository.py
│   └── models/
│       └── invitation.py
├── tests/
├── terraform/
└── requirements.txt
```

---

## 16. References

- [Parent HLD: BBWS Customer Portal Public](../BBWS_Customer_Portal_Public_HLD.md)

---

**End of Document**
