# Portal Organisation Service - Low-Level Design

**Version**: 1.0
**Created**: 2026-01-20
**Status**: Draft
**Component**: Portal Organisation Service (2_2_bbws_portal_svc_organisation)
**Parent HLD**: [HLD 2.2 Customer Portal Private](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md)
**Parent BRS**: [BRS 2.2 Customer Portal Private](../BRS/2.2_BRS_Customer_Portal_Private.md) - Epic 5: Organisation & User Management

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-20 | LLD Architect Agent | Initial version - Complete LLD for Portal Organisation Service |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [High Level Epic Overview](#2-high-level-epic-overview)
3. [Component Architecture](#3-component-architecture)
4. [API Design](#4-api-design)
5. [Lambda Functions](#5-lambda-functions)
6. [Data Models](#6-data-models)
7. [Sequence Diagrams](#7-sequence-diagrams)
8. [Security](#8-security)
9. [Error Handling](#9-error-handling)
10. [Monitoring & Alerting](#10-monitoring--alerting)
11. [NFRs](#11-nfrs)
12. [Troubleshooting Playbook](#12-troubleshooting-playbook)
13. [Signoff](#13-signoff)
14. [Definition of Terms](#14-definition-of-terms)
15. [Appendices](#15-appendices)
16. [References](#16-references)

---

## 1. Introduction

### 1.1 Purpose

This Low-Level Design (LLD) document provides implementation-level details for the **Portal Organisation Service**. This service manages organisations within the BBWS Customer Portal, including organisation CRUD operations, user management, invitation workflows, and role-based access control.

**Business Context**: The Organisation entity is the top-level container in the BBWS hierarchy model (Organisation -> Tenant(s) -> Sites). Users belong to an Organisation and are assigned to specific Tenants. This model is ideal for agencies managing multiple client tenants.

### 1.2 Component Overview

| Attribute | Value |
|-----------|-------|
| Repository | `2_2_bbws_portal_svc_organisation` |
| Runtime | Python 3.12 |
| Memory | 256-512MB (varies by function) |
| Timeout | 10-30s (varies by function) |
| Architecture | arm64 |
| Framework | AWS Lambda Powertools |
| API Prefix | `/portal/organisations/*` |

### 1.3 Lambda Functions (9 Total)

| Function | Endpoint | Description | Memory | Timeout |
|----------|----------|-------------|--------|---------|
| org-list | GET /portal/organisations | List user's organisations | 256MB | 10s |
| org-get | GET /portal/organisations/{orgId} | Get organisation details | 256MB | 10s |
| org-update | PUT /portal/organisations/{orgId} | Update organisation | 256MB | 15s |
| org-users-list | GET /portal/organisations/{orgId}/users | List organisation users | 256MB | 10s |
| org-users-invite | POST /portal/organisations/{orgId}/users/invite | Invite user to organisation | 512MB | 30s |
| org-users-update | PUT /portal/organisations/{orgId}/users/{userId} | Update user role | 256MB | 15s |
| org-users-remove | DELETE /portal/organisations/{orgId}/users/{userId} | Remove user from organisation | 256MB | 15s |
| org-invitations-list | GET /portal/organisations/{orgId}/invitations | List pending invitations | 256MB | 10s |
| org-invitations-cancel | DELETE /portal/organisations/{orgId}/invitations/{invitationId} | Cancel invitation | 256MB | 15s |

### 1.4 Dependencies

| Dependency | Purpose |
|------------|---------|
| AWS DynamoDB | Organisation, OrgUser, Invitation storage |
| AWS Cognito | User authentication, JWT validation |
| AWS API Gateway | REST API exposure |
| AWS SES | Invitation emails |
| AWS EventBridge | Event publishing for downstream systems |
| AWS SNS | Notifications for user management events |
| AWS CloudWatch | Logging, metrics, alarms |
| AWS Secrets Manager | Configuration secrets |

### 1.5 Related Documents

| Document | Relationship |
|----------|--------------|
| BRS 2.2 Customer Portal Private | Business requirements (Epic 5: US 5.1-5.8) |
| HLD 2.2 Customer Portal Private | Parent architecture |
| LLD 2.5 Tenant Management | Tenant operations (downstream of Organisation) |
| LLD 2.1.6 Invitation Lambda | Invitation acceptance/decline |

### 1.6 Business Rules Implemented

| Rule ID | Rule | Implementation |
|---------|------|----------------|
| BR-039 | Registration creates Organisation + first Tenant | Handled by Auth Public Service |
| BR-040 | Registering user becomes Organisation Admin | OrgUser created with super-admin role |
| BR-041 | Organisation can have multiple Tenants | OrgTenantsIndex GSI for lookup |
| BR-042 | Users belong to Organisation (not directly to Tenants) | OrgUser entity, UserOrgIndex GSI |
| BR-043 | Org Admins invite users to Organisation first | org-users-invite Lambda |
| BR-044 | Org Admins assign users to specific Tenants | TenantUser assignment via Tenant Service |
| BR-045 | Users can be assigned to multiple Tenants | Multiple TenantUser records per user |
| BR-046 | Users from Tenant A cannot access Tenant B unless assigned | Enforced at API authorization level |
| BR-047 | Hierarchy: Organisation -> Tenant(s) -> Sites | Data model structure |
| BR-048 | Users can switch between assigned Tenants | Tenant switcher in frontend |

---

## 2. High Level Epic Overview

### 2.1 Epic 5: Organisation & User Management

| User Story # | User Story | Test Scenario(s) |
|--------------|------------|------------------|
| US 5.1 | As an org admin, I want to view my organisation details so that I can see the overview | Given valid orgId, then complete organisation data returned |
| US 5.2 | As an org admin, I want to manage organisation settings so that I can configure policies | Given valid updates, then organisation updated with audit |
| US 5.3 | As an org admin, I want to invite users to my organisation so that they can collaborate | Given valid email and role, then invitation created and email sent |
| US 5.4 | As an org admin, I want to view all users in my organisation so that I can manage them | Given orgId, then paginated user list returned |
| US 5.5 | As an org admin, I want to assign users to specific tenants so that they can access those tenants | Handled by Portal Tenant Service |
| US 5.6 | As an org admin, I want to remove users from tenants so that they lose access to specific tenants | Handled by Portal Tenant Service |
| US 5.7 | As an org admin, I want to manage user roles so that users have appropriate permissions | Given userId and new role, then role updated |
| US 5.8 | As an org admin, I want to remove users from my organisation so that former members lose all access | Given userId, then user removed from org and all tenants |

### 2.2 User Roles

| Role | Code | Permissions |
|------|------|-------------|
| Super Admin | `super-admin` | Full access including billing, manage all admins |
| Admin | `admin` | Manage sites, users (except super-admin), tenants |
| User | `user` | Create/edit sites and content |
| Viewer | `viewer` | Read-only access |

---

## 3. Component Architecture

### 3.1 System Context Diagram

```
+-------------------------------------------------------------------------+
|                         SYSTEM CONTEXT                                   |
+-------------------------------------------------------------------------+
|                                                                         |
|    +----------------+          +---------------------------------+      |
|    |   Customer     |<-------->|  BBWS Customer Portal (Private) |      |
|    |   (Browser)    |   HTTPS  |                                 |      |
|    +----------------+          |  +-----------------------------+ |      |
|                                |  |  React SPA (S3+CloudFront)  | |      |
|                                |  +-----------------------------+ |      |
|                                |               |                  |      |
|                                |               v                  |      |
|                                |  +-----------------------------+ |      |
|                                |  |  API Gateway + Authorizer   | |      |
|                                |  +-----------------------------+ |      |
|                                +--------------+------------------+       |
|                                               |                          |
|         +-------------------------------------+------------------------+  |
|         |                                     |                        |  |
|         v                                     v                        v  |
|  +--------------+                  +------------------+         +--------+|
|  |   Cognito    |                  | Portal Org Svc   |         |  SES   ||
|  | (Customer    |                  | (This Service)   |         | (Email)||
|  |    Pool)     |                  +------------------+         +--------+|
|  +--------------+                           |                            |
|         |                          +--------+--------+                   |
|         |                          |                 |                   |
|         v                          v                 v                   |
|  +--------------+          +--------------+  +--------------+            |
|  | Portal Tenant|          |  DynamoDB    |  | EventBridge  |            |
|  |   Service    |          | (Data Store) |  |   (Events)   |            |
|  +--------------+          +--------------+  +--------------+            |
|                                                                         |
+-------------------------------------------------------------------------+
```

### 3.2 Class Structure

```
+-----------------------------------+
|       OrganisationHandler         |
+-----------------------------------+
| - OrganisationService service     |
| - RequestValidator validator      |
| - ResponseBuilder builder         |
+-----------------------------------+
| + handle(event, context): dict    |
| - extractBody(event): dict        |
| - extractPathParams(event): dict  |
| - extractQueryParams(event): dict |
+-----------------------------------+
              |
              v
+-----------------------------------+
|       OrganisationService         |
+-----------------------------------+
| - OrganisationDao orgDao          |
| - OrgUserDao orgUserDao           |
| - InvitationDao invitationDao     |
| - CognitoService cognitoService   |
| - EventPublisher eventPublisher   |
| - EmailService emailService       |
| - AuditLogger auditLogger         |
+-----------------------------------+
| + getOrganisation(orgId): Org     |
| + listOrganisations(userId): List |
| + updateOrganisation(orgId, req)  |
| + listOrgUsers(orgId, query): List|
| + inviteUser(orgId, req): Invite  |
| + updateUserRole(orgId, userId)   |
| + removeUser(orgId, userId): void |
| + listInvitations(orgId): List    |
| + cancelInvitation(orgId, invId)  |
| - validatePermissions(user, org)  |
| - publishEvent(type, detail): void|
+-----------------------------------+
              |
              v
+-----------------------------------+       +-----------------------------------+
|        OrganisationDao            |       |          OrgUserDao               |
+-----------------------------------+       +-----------------------------------+
| - Table table                     |       | - Table table                     |
| - str tableName                   |       | - str tableName                   |
+-----------------------------------+       +-----------------------------------+
| + getById(orgId): Optional[Org]   |       | + create(orgUser): OrgUser        |
| + update(org): Organisation       |       | + getByOrgAndUser(orgId, userId)  |
| + query(params): PaginatedResult  |       | + listByOrg(orgId): List[OrgUser] |
+-----------------------------------+       | + listByUser(userId): List[OrgUser]|
                                           | + update(orgUser): OrgUser        |
                                           | + delete(orgId, userId): void     |
                                           +-----------------------------------+
```

### 3.3 Package Structure

```
2_2_bbws_portal_svc_organisation/
+-- src/
|   +-- handlers/
|   |   +-- __init__.py
|   |   +-- org_list_handler.py
|   |   +-- org_get_handler.py
|   |   +-- org_update_handler.py
|   |   +-- org_users_list_handler.py
|   |   +-- org_users_invite_handler.py
|   |   +-- org_users_update_handler.py
|   |   +-- org_users_remove_handler.py
|   |   +-- org_invitations_list_handler.py
|   |   +-- org_invitations_cancel_handler.py
|   +-- services/
|   |   +-- __init__.py
|   |   +-- organisation_service.py
|   |   +-- cognito_service.py
|   |   +-- event_publisher.py
|   |   +-- email_service.py
|   +-- dao/
|   |   +-- __init__.py
|   |   +-- organisation_dao.py
|   |   +-- org_user_dao.py
|   |   +-- invitation_dao.py
|   +-- models/
|   |   +-- __init__.py
|   |   +-- organisation.py
|   |   +-- org_user.py
|   |   +-- invitation.py
|   |   +-- requests.py
|   |   +-- responses.py
|   +-- validators/
|   |   +-- __init__.py
|   |   +-- request_validator.py
|   |   +-- schemas.py
|   +-- utils/
|       +-- __init__.py
|       +-- response_builder.py
|       +-- audit_logger.py
+-- tests/
|   +-- unit/
|   |   +-- test_organisation_service.py
|   |   +-- test_org_user_dao.py
|   +-- integration/
|       +-- test_org_api.py
+-- terraform/
|   +-- main.tf
|   +-- variables.tf
|   +-- dynamodb.tf
|   +-- lambda.tf
|   +-- api_gateway.tf
|   +-- iam.tf
+-- openapi/
|   +-- organisation-api.yaml
+-- requirements.txt
+-- requirements-dev.txt
+-- README.md
```

---

## 4. API Design

### 4.1 Base URLs

| Environment | Base URL |
|-------------|----------|
| DEV | `https://dev.portal-api.kimmyai.io/v1.0` |
| SIT | `https://sit.portal-api.kimmyai.io/v1.0` |
| PROD | `https://portal-api.kimmyai.io/v1.0` |

### 4.2 Authentication

All endpoints require:
- **Authorization**: Bearer JWT token from Cognito
- JWT must contain `custom:org_id` claim for org-level operations
- JWT must contain `custom:roles` claim for authorization

### 4.3 Endpoint Summary

| Method | Path | Description | Auth Roles |
|--------|------|-------------|------------|
| GET | `/portal/organisations` | List my organisations | Any authenticated |
| GET | `/portal/organisations/{orgId}` | Get organisation | viewer+ |
| PUT | `/portal/organisations/{orgId}` | Update organisation | admin+ |
| GET | `/portal/organisations/{orgId}/users` | List org users | viewer+ |
| POST | `/portal/organisations/{orgId}/users/invite` | Invite user | admin+ |
| PUT | `/portal/organisations/{orgId}/users/{userId}` | Update user role | admin+ |
| DELETE | `/portal/organisations/{orgId}/users/{userId}` | Remove user | admin+ |
| GET | `/portal/organisations/{orgId}/invitations` | List pending invitations | admin+ |
| DELETE | `/portal/organisations/{orgId}/invitations/{invitationId}` | Cancel invitation | admin+ |

### 4.4 Endpoint Details

#### GET /portal/organisations - List My Organisations

**Description**: Returns list of organisations the authenticated user belongs to.

**Query Parameters**:
| Parameter | Type | Description | Default |
|-----------|------|-------------|---------|
| limit | integer | Page size (1-100) | 20 |
| nextToken | string | Pagination token | - |

**Response** (200 OK):
```json
{
  "data": {
    "items": [
      {
        "organisationId": "org-550e8400-e29b-41d4-a716-446655440000",
        "organisationName": "Acme Digital Agency",
        "role": "super-admin",
        "tenantCount": 5,
        "userCount": 12,
        "createdAt": "2026-01-15T10:30:00Z"
      }
    ],
    "count": 1,
    "nextToken": null
  },
  "meta": {
    "timestamp": "2026-01-20T12:00:00Z",
    "requestId": "req-abc123"
  },
  "_links": {
    "self": { "href": "/portal/organisations" }
  }
}
```

---

#### GET /portal/organisations/{orgId} - Get Organisation

**Description**: Returns organisation details including settings and statistics.

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| orgId | string | Organisation UUID |

**Response** (200 OK):
```json
{
  "data": {
    "organisationId": "org-550e8400-e29b-41d4-a716-446655440000",
    "organisationName": "Acme Digital Agency",
    "description": "Full-service digital marketing agency",
    "logo": "https://cdn.kimmyai.io/logos/org-550e.png",
    "address": {
      "street": "123 Main Street",
      "city": "Cape Town",
      "province": "Western Cape",
      "postalCode": "8001",
      "country": "South Africa"
    },
    "contactEmail": "admin@acmedigital.co.za",
    "contactPhone": "+27 21 123 4567",
    "website": "https://acmedigital.co.za",
    "billingEmail": "billing@acmedigital.co.za",
    "settings": {
      "mfaRequired": true,
      "defaultUserRole": "user",
      "invitationExpiryDays": 7
    },
    "statistics": {
      "tenantCount": 5,
      "userCount": 12,
      "siteCount": 23
    },
    "createdAt": "2026-01-15T10:30:00Z",
    "createdBy": "user@example.com",
    "updatedAt": "2026-01-19T14:30:00Z",
    "updatedBy": "admin@acmedigital.co.za"
  },
  "meta": {
    "timestamp": "2026-01-20T12:00:00Z",
    "requestId": "req-abc123"
  },
  "_links": {
    "self": { "href": "/portal/organisations/org-550e8400" },
    "users": { "href": "/portal/organisations/org-550e8400/users" },
    "tenants": { "href": "/portal/organisations/org-550e8400/tenants" },
    "invitations": { "href": "/portal/organisations/org-550e8400/invitations" }
  }
}
```

---

#### PUT /portal/organisations/{orgId} - Update Organisation

**Description**: Updates organisation details. Only admin or super-admin can update.

**Request Body**:
```json
{
  "organisationName": "Acme Digital Agency (Pty) Ltd",
  "description": "Award-winning digital marketing agency",
  "logo": "https://cdn.kimmyai.io/logos/org-550e-v2.png",
  "address": {
    "street": "456 Business Park",
    "city": "Cape Town",
    "province": "Western Cape",
    "postalCode": "8001",
    "country": "South Africa"
  },
  "contactEmail": "contact@acmedigital.co.za",
  "contactPhone": "+27 21 123 4567",
  "website": "https://acmedigital.co.za",
  "billingEmail": "accounts@acmedigital.co.za",
  "settings": {
    "mfaRequired": true,
    "defaultUserRole": "user",
    "invitationExpiryDays": 7
  }
}
```

**Response** (200 OK):
```json
{
  "data": {
    "organisationId": "org-550e8400-e29b-41d4-a716-446655440000",
    "organisationName": "Acme Digital Agency (Pty) Ltd",
    "updatedAt": "2026-01-20T12:05:00Z",
    "updatedBy": "admin@acmedigital.co.za",
    "message": "Organisation updated successfully"
  },
  "meta": {
    "timestamp": "2026-01-20T12:05:00Z",
    "requestId": "req-def456"
  },
  "_links": {
    "self": { "href": "/portal/organisations/org-550e8400" }
  }
}
```

---

#### GET /portal/organisations/{orgId}/users - List Organisation Users

**Description**: Returns paginated list of users in the organisation.

**Query Parameters**:
| Parameter | Type | Description | Default |
|-----------|------|-------------|---------|
| status | string | Filter by status (active, pending, suspended) | - |
| role | string | Filter by role | - |
| search | string | Search by name or email | - |
| limit | integer | Page size (1-100) | 20 |
| nextToken | string | Pagination token | - |

**Response** (200 OK):
```json
{
  "data": {
    "items": [
      {
        "userId": "user-123e4567-e89b-12d3-a456-426614174000",
        "email": "john.doe@acmedigital.co.za",
        "firstName": "John",
        "lastName": "Doe",
        "role": "admin",
        "status": "active",
        "assignedTenants": [
          {
            "tenantId": "tenant-abc123",
            "tenantName": "Client A",
            "role": "admin"
          }
        ],
        "lastLoginAt": "2026-01-19T09:15:00Z",
        "assignedAt": "2026-01-15T11:00:00Z",
        "assignedBy": "admin@acmedigital.co.za"
      }
    ],
    "count": 12,
    "nextToken": "eyJsYXN0RXZhbHVhdGVkS2V5Ijp7fX0="
  },
  "meta": {
    "timestamp": "2026-01-20T12:00:00Z",
    "requestId": "req-ghi789"
  },
  "_links": {
    "self": { "href": "/portal/organisations/org-550e8400/users" },
    "invite": { "href": "/portal/organisations/org-550e8400/users/invite" }
  }
}
```

---

#### POST /portal/organisations/{orgId}/users/invite - Invite User

**Description**: Sends invitation email to a new user to join the organisation.

**Request Body**:
```json
{
  "email": "newuser@example.com",
  "role": "user",
  "tenantAssignments": [
    {
      "tenantId": "tenant-abc123",
      "role": "user"
    }
  ],
  "message": "Welcome to our team! Looking forward to working with you."
}
```

**Response** (201 Created):
```json
{
  "data": {
    "invitationId": "inv-789xyz",
    "email": "newuser@example.com",
    "role": "user",
    "status": "pending",
    "expiresAt": "2026-01-27T12:10:00Z",
    "message": "Invitation sent to newuser@example.com"
  },
  "meta": {
    "timestamp": "2026-01-20T12:10:00Z",
    "requestId": "req-jkl012"
  },
  "_links": {
    "self": { "href": "/portal/organisations/org-550e8400/invitations/inv-789xyz" },
    "cancel": { "href": "/portal/organisations/org-550e8400/invitations/inv-789xyz" }
  }
}
```

---

#### PUT /portal/organisations/{orgId}/users/{userId} - Update User Role

**Description**: Updates user's organisation-level role. Only admin or super-admin can update roles.

**Request Body**:
```json
{
  "role": "admin"
}
```

**Response** (200 OK):
```json
{
  "data": {
    "userId": "user-123e4567",
    "email": "john.doe@acmedigital.co.za",
    "previousRole": "user",
    "newRole": "admin",
    "updatedAt": "2026-01-20T12:15:00Z",
    "updatedBy": "admin@acmedigital.co.za",
    "message": "User role updated successfully"
  },
  "meta": {
    "timestamp": "2026-01-20T12:15:00Z",
    "requestId": "req-mno345"
  },
  "_links": {
    "self": { "href": "/portal/organisations/org-550e8400/users/user-123e4567" },
    "organisation": { "href": "/portal/organisations/org-550e8400" }
  }
}
```

---

#### DELETE /portal/organisations/{orgId}/users/{userId} - Remove User

**Description**: Removes user from organisation. Also removes all tenant assignments.

**Response** (200 OK):
```json
{
  "data": {
    "userId": "user-123e4567",
    "email": "john.doe@acmedigital.co.za",
    "removedAt": "2026-01-20T12:20:00Z",
    "removedBy": "admin@acmedigital.co.za",
    "tenantsRemoved": ["tenant-abc123", "tenant-def456"],
    "message": "User removed from organisation and all tenants"
  },
  "meta": {
    "timestamp": "2026-01-20T12:20:00Z",
    "requestId": "req-pqr678"
  },
  "_links": {
    "organisation": { "href": "/portal/organisations/org-550e8400" },
    "users": { "href": "/portal/organisations/org-550e8400/users" }
  }
}
```

---

#### GET /portal/organisations/{orgId}/invitations - List Pending Invitations

**Description**: Returns list of pending invitations for the organisation.

**Query Parameters**:
| Parameter | Type | Description | Default |
|-----------|------|-------------|---------|
| status | string | Filter by status (pending, expired) | pending |
| limit | integer | Page size (1-100) | 20 |
| nextToken | string | Pagination token | - |

**Response** (200 OK):
```json
{
  "data": {
    "items": [
      {
        "invitationId": "inv-789xyz",
        "email": "pending@example.com",
        "role": "user",
        "status": "pending",
        "invitedBy": "admin@acmedigital.co.za",
        "invitedAt": "2026-01-18T10:00:00Z",
        "expiresAt": "2026-01-25T10:00:00Z"
      }
    ],
    "count": 3,
    "nextToken": null
  },
  "meta": {
    "timestamp": "2026-01-20T12:00:00Z",
    "requestId": "req-stu901"
  },
  "_links": {
    "self": { "href": "/portal/organisations/org-550e8400/invitations" },
    "invite": { "href": "/portal/organisations/org-550e8400/users/invite" }
  }
}
```

---

#### DELETE /portal/organisations/{orgId}/invitations/{invitationId} - Cancel Invitation

**Description**: Cancels a pending invitation. The invitation link will no longer work.

**Response** (200 OK):
```json
{
  "data": {
    "invitationId": "inv-789xyz",
    "email": "pending@example.com",
    "status": "cancelled",
    "cancelledAt": "2026-01-20T12:25:00Z",
    "cancelledBy": "admin@acmedigital.co.za",
    "message": "Invitation cancelled successfully"
  },
  "meta": {
    "timestamp": "2026-01-20T12:25:00Z",
    "requestId": "req-vwx234"
  },
  "_links": {
    "invitations": { "href": "/portal/organisations/org-550e8400/invitations" }
  }
}
```

### 4.5 Error Responses

| HTTP Status | Error Code | Description |
|-------------|------------|-------------|
| 400 | VALIDATION_ERROR | Request body validation failed |
| 401 | UNAUTHORIZED | Invalid or missing JWT token |
| 403 | FORBIDDEN | User lacks required permissions |
| 404 | ORGANISATION_NOT_FOUND | Organisation does not exist |
| 404 | USER_NOT_FOUND | User not found in organisation |
| 404 | INVITATION_NOT_FOUND | Invitation does not exist |
| 409 | USER_ALREADY_MEMBER | User is already a member |
| 409 | INVITATION_PENDING | Invitation already pending |
| 422 | CANNOT_REMOVE_SUPER_ADMIN | Cannot remove super-admin |
| 422 | CANNOT_REMOVE_LAST_ADMIN | Cannot remove last admin |
| 422 | CANNOT_DEMOTE_SELF | Cannot demote yourself |
| 429 | RATE_LIMITED | Too many requests |
| 500 | INTERNAL_ERROR | Server error |

**Error Response Format**:
```json
{
  "error": {
    "code": "CANNOT_REMOVE_SUPER_ADMIN",
    "message": "Cannot remove super-admin from organisation",
    "details": {
      "userId": "user-123e4567",
      "role": "super-admin"
    }
  },
  "meta": {
    "requestId": "req-abc123",
    "timestamp": "2026-01-20T12:00:00Z"
  }
}
```

---

## 5. Lambda Functions

### 5.1 Function Inventory

| Function | Handler | Runtime | Memory | Timeout | Concurrency |
|----------|---------|---------|--------|---------|-------------|
| bbws-org-list-{env} | handlers.org_list_handler.handler | Python 3.12 | 256MB | 10s | 50 |
| bbws-org-get-{env} | handlers.org_get_handler.handler | Python 3.12 | 256MB | 10s | 50 |
| bbws-org-update-{env} | handlers.org_update_handler.handler | Python 3.12 | 256MB | 15s | 20 |
| bbws-org-users-list-{env} | handlers.org_users_list_handler.handler | Python 3.12 | 256MB | 10s | 50 |
| bbws-org-users-invite-{env} | handlers.org_users_invite_handler.handler | Python 3.12 | 512MB | 30s | 10 |
| bbws-org-users-update-{env} | handlers.org_users_update_handler.handler | Python 3.12 | 256MB | 15s | 20 |
| bbws-org-users-remove-{env} | handlers.org_users_remove_handler.handler | Python 3.12 | 256MB | 15s | 10 |
| bbws-org-invitations-list-{env} | handlers.org_invitations_list_handler.handler | Python 3.12 | 256MB | 10s | 20 |
| bbws-org-invitations-cancel-{env} | handlers.org_invitations_cancel_handler.handler | Python 3.12 | 256MB | 15s | 10 |

### 5.2 Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| ENVIRONMENT | Current environment | `dev`, `sit`, `prod` |
| DYNAMODB_TABLE | Main table name | `bbws-portal-dev` |
| EVENT_BUS_NAME | EventBridge bus name | `bbws-events-dev` |
| SNS_TOPIC_ARN | Notifications topic | `arn:aws:sns:...` |
| SES_FROM_EMAIL | Email sender address | `noreply@kimmyai.io` |
| INVITATION_BASE_URL | Invitation link base | `https://portal.kimmyai.io/invitations` |
| LOG_LEVEL | Logging level | `INFO` |
| POWERTOOLS_SERVICE_NAME | Service name | `portal-organisation` |

### 5.3 Handler Implementation: Invite User

```python
from aws_lambda_powertools import Logger, Tracer, Metrics
from aws_lambda_powertools.event_handler import APIGatewayRestResolver
from aws_lambda_powertools.utilities.typing import LambdaContext
from aws_lambda_powertools.utilities.validation import validate
from aws_lambda_powertools.metrics import MetricUnit
import uuid
import secrets
from datetime import datetime, timedelta

from services.organisation_service import OrganisationService
from services.email_service import EmailService
from models.requests import InviteUserRequest
from utils.response_builder import ResponseBuilder
from validators.schemas import INVITE_USER_SCHEMA
from exceptions import (
    OrganisationNotFoundError,
    UserAlreadyMemberError,
    InvitationPendingError,
    ForbiddenError
)

logger = Logger()
tracer = Tracer()
metrics = Metrics()
app = APIGatewayRestResolver()

org_service = OrganisationService()
email_service = EmailService()
response_builder = ResponseBuilder()

@app.post("/portal/organisations/<org_id>/users/invite")
@tracer.capture_method
def invite_user(org_id: str):
    """Invite a new user to the organisation."""
    try:
        # 1. Parse and validate request
        body = app.current_event.json_body
        validate(event=body, schema=INVITE_USER_SCHEMA)
        request = InviteUserRequest(**body)

        # 2. Get authenticated user
        claims = app.current_event.request_context.authorizer.claims
        user_email = claims.get("email")
        user_roles = claims.get("custom:roles", "").split(",")

        # 3. Validate permissions (admin or super-admin required)
        if "admin" not in user_roles and "super-admin" not in user_roles:
            raise ForbiddenError("Insufficient permissions to invite users")

        # 4. Check if organisation exists and user has access
        organisation = org_service.get_organisation(org_id)
        if not organisation:
            raise OrganisationNotFoundError(org_id)

        # 5. Check if user is already a member
        existing_user = org_service.get_org_user_by_email(org_id, request.email)
        if existing_user:
            raise UserAlreadyMemberError(request.email)

        # 6. Check for pending invitation
        pending_invitation = org_service.get_pending_invitation(org_id, request.email)
        if pending_invitation:
            raise InvitationPendingError(request.email)

        # 7. Generate secure invitation token
        invitation_token = secrets.token_urlsafe(32)
        expiry_days = organisation.settings.get("invitationExpiryDays", 7)
        expires_at = datetime.utcnow() + timedelta(days=expiry_days)

        # 8. Create invitation
        invitation = org_service.create_invitation(
            org_id=org_id,
            email=request.email,
            role=request.role,
            tenant_assignments=request.tenant_assignments,
            token=invitation_token,
            expires_at=expires_at,
            invited_by=user_email
        )

        # 9. Send invitation email
        email_service.send_invitation_email(
            to_email=request.email,
            organisation_name=organisation.organisation_name,
            inviter_name=user_email,
            role=request.role,
            token=invitation_token,
            expires_at=expires_at,
            message=request.message
        )

        # 10. Record metric
        metrics.add_metric(name="InvitationsSent", unit=MetricUnit.Count, value=1)

        # 11. Return response
        return response_builder.created(
            data={
                "invitationId": invitation.invitation_id,
                "email": request.email,
                "role": request.role,
                "status": "pending",
                "expiresAt": expires_at.isoformat(),
                "message": f"Invitation sent to {request.email}"
            },
            links={
                "self": {"href": f"/portal/organisations/{org_id}/invitations/{invitation.invitation_id}"},
                "cancel": {"href": f"/portal/organisations/{org_id}/invitations/{invitation.invitation_id}"}
            }
        )

    except OrganisationNotFoundError as e:
        return response_builder.not_found(
            code="ORGANISATION_NOT_FOUND",
            message=str(e)
        )
    except UserAlreadyMemberError as e:
        return response_builder.conflict(
            code="USER_ALREADY_MEMBER",
            message=str(e)
        )
    except InvitationPendingError as e:
        return response_builder.conflict(
            code="INVITATION_PENDING",
            message=str(e)
        )
    except ForbiddenError as e:
        return response_builder.forbidden(
            code="FORBIDDEN",
            message=str(e)
        )

@logger.inject_lambda_context
@tracer.capture_lambda_handler
@metrics.log_metrics
def handler(event: dict, context: LambdaContext) -> dict:
    return app.resolve(event, context)
```

### 5.4 Handler Implementation: Remove User

```python
from aws_lambda_powertools import Logger, Tracer, Metrics
from aws_lambda_powertools.event_handler import APIGatewayRestResolver
from aws_lambda_powertools.utilities.typing import LambdaContext
from aws_lambda_powertools.metrics import MetricUnit

from services.organisation_service import OrganisationService
from services.event_publisher import EventPublisher
from utils.response_builder import ResponseBuilder
from exceptions import (
    OrganisationNotFoundError,
    UserNotFoundError,
    CannotRemoveSuperAdminError,
    CannotRemoveLastAdminError,
    ForbiddenError
)

logger = Logger()
tracer = Tracer()
metrics = Metrics()
app = APIGatewayRestResolver()

org_service = OrganisationService()
event_publisher = EventPublisher()
response_builder = ResponseBuilder()

@app.delete("/portal/organisations/<org_id>/users/<user_id>")
@tracer.capture_method
def remove_user(org_id: str, user_id: str):
    """Remove user from organisation and all associated tenants."""
    try:
        # 1. Get authenticated user
        claims = app.current_event.request_context.authorizer.claims
        current_user_email = claims.get("email")
        current_user_id = claims.get("sub")
        user_roles = claims.get("custom:roles", "").split(",")

        # 2. Validate permissions
        if "admin" not in user_roles and "super-admin" not in user_roles:
            raise ForbiddenError("Insufficient permissions to remove users")

        # 3. Get organisation
        organisation = org_service.get_organisation(org_id)
        if not organisation:
            raise OrganisationNotFoundError(org_id)

        # 4. Get user to be removed
        org_user = org_service.get_org_user(org_id, user_id)
        if not org_user:
            raise UserNotFoundError(user_id)

        # 5. Cannot remove super-admin
        if org_user.role == "super-admin":
            raise CannotRemoveSuperAdminError()

        # 6. Cannot remove last admin
        if org_user.role == "admin":
            admin_count = org_service.count_admins(org_id)
            if admin_count <= 1:
                raise CannotRemoveLastAdminError()

        # 7. Get user's tenant assignments
        tenant_assignments = org_service.list_user_tenant_assignments(org_id, user_id)
        tenants_removed = [ta.tenant_id for ta in tenant_assignments]

        # 8. Remove from all tenants first
        for tenant_assignment in tenant_assignments:
            org_service.remove_user_from_tenant(
                org_id=org_id,
                tenant_id=tenant_assignment.tenant_id,
                user_id=user_id
            )

        # 9. Remove from organisation
        org_service.remove_org_user(
            org_id=org_id,
            user_id=user_id,
            removed_by=current_user_email
        )

        # 10. Publish event
        event_publisher.publish(
            event_type="ORG_USER_REMOVED",
            detail={
                "organisationId": org_id,
                "userId": user_id,
                "email": org_user.email,
                "tenantsRemoved": tenants_removed,
                "removedBy": current_user_email
            }
        )

        # 11. Record metric
        metrics.add_metric(name="UsersRemoved", unit=MetricUnit.Count, value=1)

        # 12. Return response
        return response_builder.success(
            data={
                "userId": user_id,
                "email": org_user.email,
                "removedAt": datetime.utcnow().isoformat(),
                "removedBy": current_user_email,
                "tenantsRemoved": tenants_removed,
                "message": "User removed from organisation and all tenants"
            },
            links={
                "organisation": {"href": f"/portal/organisations/{org_id}"},
                "users": {"href": f"/portal/organisations/{org_id}/users"}
            }
        )

    except OrganisationNotFoundError as e:
        return response_builder.not_found(code="ORGANISATION_NOT_FOUND", message=str(e))
    except UserNotFoundError as e:
        return response_builder.not_found(code="USER_NOT_FOUND", message=str(e))
    except CannotRemoveSuperAdminError:
        return response_builder.unprocessable(
            code="CANNOT_REMOVE_SUPER_ADMIN",
            message="Cannot remove super-admin from organisation"
        )
    except CannotRemoveLastAdminError:
        return response_builder.unprocessable(
            code="CANNOT_REMOVE_LAST_ADMIN",
            message="Cannot remove last admin. Assign another admin first."
        )
    except ForbiddenError as e:
        return response_builder.forbidden(code="FORBIDDEN", message=str(e))

@logger.inject_lambda_context
@tracer.capture_lambda_handler
@metrics.log_metrics
def handler(event: dict, context: LambdaContext) -> dict:
    return app.resolve(event, context)
```

---

## 6. Data Models

### 6.1 DynamoDB Table Design

**Table Name**: `bbws-portal-{env}`

**Capacity Mode**: On-Demand (as per global standards)

**Primary Key**:
- **PK** (Partition Key): String
- **SK** (Sort Key): String

### 6.2 Item Patterns

| Entity | PK | SK | Purpose |
|--------|----|----|---------|
| Organisation | `ORG#{orgId}` | `METADATA` | Organisation details |
| OrgUser | `ORG#{orgId}` | `USER#{userId}` | User membership in org |
| Invitation | `ORG#{orgId}` | `INVITATION#{invitationId}` | Pending invitations |
| InvitationToken | `INVITATION_TOKEN#{token}` | `METADATA` | Token lookup |

### 6.3 Global Secondary Indexes

| Index | PK (GSI1PK/GSI2PK) | SK (GSI1SK/GSI2SK) | Purpose |
|-------|--------------------|--------------------|---------|
| GSI1 - UserOrgIndex | `USER#{userId}` | `ORG#{orgId}` | List organisations by user |
| GSI1 - InvitationEmailIndex | `INVITATION_EMAIL#{email}` | `ORG#{orgId}` | Lookup invitation by email |
| GSI2 - OrgStatusIndex | `ORG_STATUS#{status}` | `{createdAt}#{orgId}` | List orgs by status |
| GSI2 - InvitationStatusIndex | `INVITATION_STATUS#{status}` | `{expiresAt}#{invitationId}` | List pending/expired invitations |

### 6.4 Organisation Entity Schema

```json
{
  "PK": "ORG#org-550e8400-e29b-41d4-a716-446655440000",
  "SK": "METADATA",
  "organisationId": "org-550e8400-e29b-41d4-a716-446655440000",
  "organisationName": "Acme Digital Agency",
  "description": "Full-service digital marketing agency",
  "logo": "https://cdn.kimmyai.io/logos/org-550e.png",
  "address": {
    "street": "123 Main Street",
    "city": "Cape Town",
    "province": "Western Cape",
    "postalCode": "8001",
    "country": "South Africa"
  },
  "contactEmail": "admin@acmedigital.co.za",
  "contactPhone": "+27 21 123 4567",
  "website": "https://acmedigital.co.za",
  "billingEmail": "billing@acmedigital.co.za",
  "settings": {
    "mfaRequired": true,
    "defaultUserRole": "user",
    "invitationExpiryDays": 7
  },
  "status": "ACTIVE",
  "createdAt": "2026-01-15T10:30:00Z",
  "createdBy": "owner@example.com",
  "updatedAt": "2026-01-19T14:30:00Z",
  "updatedBy": "admin@acmedigital.co.za",
  "version": 3,
  "GSI2PK": "ORG_STATUS#ACTIVE",
  "GSI2SK": "2026-01-15T10:30:00Z#org-550e8400"
}
```

### 6.5 OrgUser Entity Schema

```json
{
  "PK": "ORG#org-550e8400-e29b-41d4-a716-446655440000",
  "SK": "USER#user-123e4567-e89b-12d3-a456-426614174000",
  "organisationId": "org-550e8400-e29b-41d4-a716-446655440000",
  "userId": "user-123e4567-e89b-12d3-a456-426614174000",
  "email": "john.doe@acmedigital.co.za",
  "firstName": "John",
  "lastName": "Doe",
  "role": "admin",
  "status": "active",
  "assignedAt": "2026-01-15T11:00:00Z",
  "assignedBy": "owner@example.com",
  "lastLoginAt": "2026-01-19T09:15:00Z",
  "GSI1PK": "USER#user-123e4567-e89b-12d3-a456-426614174000",
  "GSI1SK": "ORG#org-550e8400-e29b-41d4-a716-446655440000"
}
```

### 6.6 Invitation Entity Schema

```json
{
  "PK": "ORG#org-550e8400-e29b-41d4-a716-446655440000",
  "SK": "INVITATION#inv-789xyz-abc123",
  "invitationId": "inv-789xyz-abc123",
  "organisationId": "org-550e8400-e29b-41d4-a716-446655440000",
  "email": "newuser@example.com",
  "role": "user",
  "tenantAssignments": [
    {
      "tenantId": "tenant-abc123",
      "role": "user"
    }
  ],
  "token": "secure-token-abc123xyz789",
  "status": "pending",
  "message": "Welcome to our team!",
  "invitedBy": "admin@acmedigital.co.za",
  "invitedAt": "2026-01-18T10:00:00Z",
  "expiresAt": "2026-01-25T10:00:00Z",
  "acceptedAt": null,
  "declinedAt": null,
  "cancelledAt": null,
  "GSI1PK": "INVITATION_EMAIL#newuser@example.com",
  "GSI1SK": "ORG#org-550e8400",
  "GSI2PK": "INVITATION_STATUS#pending",
  "GSI2SK": "2026-01-25T10:00:00Z#inv-789xyz",
  "ttl": 1738058400
}
```

### 6.7 Invitation Token Lookup Schema

```json
{
  "PK": "INVITATION_TOKEN#secure-token-abc123xyz789",
  "SK": "METADATA",
  "invitationId": "inv-789xyz-abc123",
  "organisationId": "org-550e8400-e29b-41d4-a716-446655440000",
  "expiresAt": "2026-01-25T10:00:00Z",
  "ttl": 1738058400
}
```

### 6.8 Access Patterns

| # | Access Pattern | Key Condition | Index |
|---|----------------|---------------|-------|
| 1 | Get organisation by ID | PK = `ORG#{id}`, SK = `METADATA` | Table |
| 2 | List users in organisation | PK = `ORG#{id}`, SK begins_with `USER#` | Table |
| 3 | List invitations in organisation | PK = `ORG#{id}`, SK begins_with `INVITATION#` | Table |
| 4 | List organisations by user | GSI1PK = `USER#{userId}` | GSI1 |
| 5 | Get invitation by token | PK = `INVITATION_TOKEN#{token}`, SK = `METADATA` | Table |
| 6 | Get invitation by email | GSI1PK = `INVITATION_EMAIL#{email}` | GSI1 |
| 7 | List pending invitations (expiring) | GSI2PK = `INVITATION_STATUS#pending` | GSI2 |
| 8 | Get specific user in org | PK = `ORG#{id}`, SK = `USER#{userId}` | Table |

### 6.9 Pydantic Models

```python
from pydantic import BaseModel, Field, EmailStr
from typing import Optional, Dict, Any, List
from datetime import datetime
from enum import Enum

class OrgUserRole(str, Enum):
    SUPER_ADMIN = "super-admin"
    ADMIN = "admin"
    USER = "user"
    VIEWER = "viewer"

class OrgUserStatus(str, Enum):
    ACTIVE = "active"
    PENDING = "pending"
    SUSPENDED = "suspended"

class InvitationStatus(str, Enum):
    PENDING = "pending"
    ACCEPTED = "accepted"
    DECLINED = "declined"
    EXPIRED = "expired"
    CANCELLED = "cancelled"

class Address(BaseModel):
    street: Optional[str] = None
    city: Optional[str] = None
    province: Optional[str] = None
    postal_code: Optional[str] = Field(alias="postalCode", default=None)
    country: str = "South Africa"

    class Config:
        populate_by_name = True

class OrgSettings(BaseModel):
    mfa_required: bool = Field(alias="mfaRequired", default=False)
    default_user_role: OrgUserRole = Field(alias="defaultUserRole", default=OrgUserRole.USER)
    invitation_expiry_days: int = Field(alias="invitationExpiryDays", default=7)

    class Config:
        populate_by_name = True
        use_enum_values = True

class Organisation(BaseModel):
    organisation_id: str = Field(alias="organisationId")
    organisation_name: str = Field(alias="organisationName", min_length=2, max_length=100)
    description: Optional[str] = None
    logo: Optional[str] = None
    address: Optional[Address] = None
    contact_email: EmailStr = Field(alias="contactEmail")
    contact_phone: Optional[str] = Field(alias="contactPhone", default=None)
    website: Optional[str] = None
    billing_email: Optional[EmailStr] = Field(alias="billingEmail", default=None)
    settings: OrgSettings = Field(default_factory=OrgSettings)
    status: str = "ACTIVE"
    created_at: datetime = Field(alias="createdAt")
    created_by: str = Field(alias="createdBy")
    updated_at: Optional[datetime] = Field(alias="updatedAt", default=None)
    updated_by: Optional[str] = Field(alias="updatedBy", default=None)
    version: int = 1

    class Config:
        populate_by_name = True

class OrgUser(BaseModel):
    organisation_id: str = Field(alias="organisationId")
    user_id: str = Field(alias="userId")
    email: EmailStr
    first_name: Optional[str] = Field(alias="firstName", default=None)
    last_name: Optional[str] = Field(alias="lastName", default=None)
    role: OrgUserRole
    status: OrgUserStatus = OrgUserStatus.ACTIVE
    assigned_at: datetime = Field(alias="assignedAt")
    assigned_by: str = Field(alias="assignedBy")
    last_login_at: Optional[datetime] = Field(alias="lastLoginAt", default=None)

    class Config:
        populate_by_name = True
        use_enum_values = True

class TenantAssignment(BaseModel):
    tenant_id: str = Field(alias="tenantId")
    role: OrgUserRole

    class Config:
        populate_by_name = True
        use_enum_values = True

class Invitation(BaseModel):
    invitation_id: str = Field(alias="invitationId")
    organisation_id: str = Field(alias="organisationId")
    email: EmailStr
    role: OrgUserRole
    tenant_assignments: List[TenantAssignment] = Field(alias="tenantAssignments", default_factory=list)
    token: str
    status: InvitationStatus = InvitationStatus.PENDING
    message: Optional[str] = None
    invited_by: str = Field(alias="invitedBy")
    invited_at: datetime = Field(alias="invitedAt")
    expires_at: datetime = Field(alias="expiresAt")
    accepted_at: Optional[datetime] = Field(alias="acceptedAt", default=None)
    declined_at: Optional[datetime] = Field(alias="declinedAt", default=None)
    cancelled_at: Optional[datetime] = Field(alias="cancelledAt", default=None)

    class Config:
        populate_by_name = True
        use_enum_values = True

# Request Models
class UpdateOrganisationRequest(BaseModel):
    organisation_name: Optional[str] = Field(alias="organisationName", min_length=2, max_length=100, default=None)
    description: Optional[str] = None
    logo: Optional[str] = None
    address: Optional[Address] = None
    contact_email: Optional[EmailStr] = Field(alias="contactEmail", default=None)
    contact_phone: Optional[str] = Field(alias="contactPhone", default=None)
    website: Optional[str] = None
    billing_email: Optional[EmailStr] = Field(alias="billingEmail", default=None)
    settings: Optional[OrgSettings] = None

    class Config:
        populate_by_name = True

class InviteUserRequest(BaseModel):
    email: EmailStr
    role: OrgUserRole
    tenant_assignments: List[TenantAssignment] = Field(alias="tenantAssignments", default_factory=list)
    message: Optional[str] = Field(default=None, max_length=500)

    class Config:
        populate_by_name = True
        use_enum_values = True

class UpdateUserRoleRequest(BaseModel):
    role: OrgUserRole

    class Config:
        use_enum_values = True
```

---

## 7. Sequence Diagrams

### 7.1 Create Organisation (During Registration)

```
+----------+     +----------+    +-----------+    +----------+    +----------+
|  Client  |     | Auth Svc |    | Org Svc   |    | DynamoDB |    |Cognito   |
+----------+     +----------+    +-----------+    +----------+    +----------+
     |               |                |               |               |
     | POST /register                 |               |               |
     |-------------->|                |               |               |
     |               |                |               |               |
     |               | Create Cognito User            |               |
     |               |------------------------------------------------>|
     |               |<------------------------------------------------|
     |               | User Created with userId       |               |
     |               |                |               |               |
     |               | Generate orgId, tenantId       |               |
     |               |--------------->|               |               |
     |               |                |               |               |
     |               |                | Create Organisation           |
     |               |                | PK=ORG#{orgId}                 |
     |               |                |-------------->|               |
     |               |                |<--------------|               |
     |               |                |               |               |
     |               |                | Create OrgUser (super-admin)  |
     |               |                | PK=ORG#{orgId}, SK=USER#{userId}
     |               |                |-------------->|               |
     |               |                |<--------------|               |
     |               |                |               |               |
     |               |                | Create Tenant |               |
     |               |                | (via Tenant Service)          |
     |               |                |               |               |
     |               |<---------------|               |               |
     |               |                |               |               |
     |               | Update Cognito custom attributes               |
     |               | org_id, tenant_id, roles                       |
     |               |------------------------------------------------>|
     |               |<------------------------------------------------|
     |               |                |               |               |
     |<--------------|                |               |               |
     | 201 Created   |                |               |               |
     | {orgId, tenantId, token}       |               |               |
```

### 7.2 Invite User to Organisation

```
+---------+    +----------+    +-----------+    +----------+    +-----+
| Client  |    | API GW   |    | Org Svc   |    | DynamoDB |    | SES |
+---------+    +----------+    +-----------+    +----------+    +-----+
     |              |               |               |              |
     | POST /portal/organisations/{orgId}/users/invite             |
     |------------->|               |               |              |
     |              |               |               |              |
     |              | Validate JWT  |               |              |
     |              |-------------->|               |              |
     |              |<--------------|               |              |
     |              | Claims: email, roles          |              |
     |              |               |               |              |
     |              | Invoke Lambda |               |              |
     |              |-------------->|               |              |
     |              |               |               |              |
     |              |               | Check org exists             |
     |              |               | PK=ORG#{orgId}, SK=METADATA  |
     |              |               |-------------->|              |
     |              |               |<--------------|              |
     |              |               |               |              |
     |              |               | Check user not already member|
     |              |               | GSI1: INVITATION_EMAIL#{email}
     |              |               |-------------->|              |
     |              |               |<--------------|              |
     |              |               |               |              |
     |              |               | Generate token|              |
     |              |               | secrets.token_urlsafe(32)    |
     |              |               |               |              |
     |              |               | Create Invitation            |
     |              |               | PK=ORG#{orgId}, SK=INVITATION#{id}
     |              |               |-------------->|              |
     |              |               |<--------------|              |
     |              |               |               |              |
     |              |               | Create Token Lookup          |
     |              |               | PK=INVITATION_TOKEN#{token}  |
     |              |               |-------------->|              |
     |              |               |<--------------|              |
     |              |               |               |              |
     |              |               | Send Email    |              |
     |              |               |---------------------------->|
     |              |               |<----------------------------|
     |              |               |               |              |
     |              |<--------------|               |              |
     |<-------------|               |               |              |
     | 201 Created  |               |               |              |
     | {invitationId, expiresAt}    |               |              |
```

### 7.3 Accept Invitation

```
+----------+    +----------+    +------------+    +----------+    +---------+
|  Client  |    | API GW   |    | Invite Svc |    | Org Svc  |    | Cognito |
+----------+    +----------+    +------------+    +----------+    +---------+
     |               |                |                |               |
     | GET /invitations/{token}       |                |               |
     |-------------->|                |                |               |
     |               |--------------->|                |               |
     |               |                |                |               |
     |               |                | Lookup Token   |               |
     |               |                | PK=INVITATION_TOKEN#{token}    |
     |               |                |--------------->|               |
     |               |                |<---------------|               |
     |               |                |                |               |
     |               |                | Get Invitation |               |
     |               |                | (org name, role, etc.)         |
     |               |                |--------------->|               |
     |               |                |<---------------|               |
     |               |<---------------|                |               |
     |<--------------|                |                |               |
     | 200 OK (invitation details)    |                |               |
     |               |                |                |               |
     | POST /invitations/{token}/accept               |               |
     |-------------->|                |                |               |
     |               |--------------->|                |               |
     |               |                |                |               |
     |               |                | Validate token not expired     |
     |               |                |                |               |
     |               |                | Mark invitation ACCEPTED       |
     |               |                |--------------->|               |
     |               |                |<---------------|               |
     |               |                |                |               |
     |               |                | Create OrgUser |               |
     |               |                |--------------->|               |
     |               |                |<---------------|               |
     |               |                |                |               |
     |               |                | Create TenantUser(s)           |
     |               |                | (for each tenant assignment)   |
     |               |                |--------------->|               |
     |               |                |<---------------|               |
     |               |                |                |               |
     |               |                | Update Cognito |               |
     |               |                | (custom:org_id, etc.)          |
     |               |                |----------------------------->|
     |               |                |<-----------------------------|
     |               |                |                |               |
     |               |<---------------|                |               |
     |<--------------|                |                |               |
     | 200 OK (redirect to dashboard) |                |               |
```

### 7.4 Remove User from Organisation

```
+---------+    +----------+    +-----------+    +----------+    +------------+
| Client  |    | API GW   |    | Org Svc   |    | DynamoDB |    | EventBridge|
+---------+    +----------+    +-----------+    +----------+    +------------+
     |              |               |               |                |
     | DELETE /portal/organisations/{orgId}/users/{userId}          |
     |------------->|               |               |                |
     |              |               |               |                |
     |              | Validate JWT (admin/super-admin required)     |
     |              |-------------->|               |                |
     |              |               |               |                |
     |              |               | Get OrgUser   |                |
     |              |               |-------------->|                |
     |              |               |<--------------|                |
     |              |               |               |                |
     |              |               | Validate: not super-admin     |
     |              |               | Validate: not last admin       |
     |              |               |               |                |
     |              |               | List user's tenant assignments |
     |              |               |-------------->|                |
     |              |               |<--------------|                |
     |              |               |               |                |
     |              |               | Delete TenantUser records     |
     |              |               | (for each tenant)             |
     |              |               |-------------->|                |
     |              |               |<--------------|                |
     |              |               |               |                |
     |              |               | Delete OrgUser|                |
     |              |               |-------------->|                |
     |              |               |<--------------|                |
     |              |               |               |                |
     |              |               | Publish ORG_USER_REMOVED       |
     |              |               |------------------------------>|
     |              |               |               |                |
     |              |<--------------|               |                |
     |<-------------|               |               |                |
     | 200 OK       |               |               |                |
     | {tenantsRemoved: [...]}      |               |                |
```

---

## 8. Security

### 8.1 Authentication

**Cognito Configuration**:

| Setting | Value |
|---------|-------|
| User Pool | `bbws-customer-portal-{env}` |
| App Client | `bbws-portal-client-{env}` |
| Token Type | JWT (ID Token) |
| Token Expiry | 1 hour |
| Refresh Token Expiry | 30 days |

**Required JWT Claims**:

```json
{
  "sub": "user-uuid",
  "email": "user@example.com",
  "custom:org_id": "org-550e8400",
  "custom:tenant_ids": "tenant-abc,tenant-def",
  "custom:roles": "admin",
  "cognito:groups": ["OrgAdmins", "TenantUsers"]
}
```

### 8.2 Authorization

**Role-Based Access Control (RBAC)**:

| Endpoint | super-admin | admin | user | viewer |
|----------|-------------|-------|------|--------|
| GET /organisations | Yes | Yes | Yes | Yes |
| GET /organisations/{id} | Yes | Yes | Yes | Yes |
| PUT /organisations/{id} | Yes | Yes | No | No |
| GET /organisations/{id}/users | Yes | Yes | Yes | Yes |
| POST /{id}/users/invite | Yes | Yes | No | No |
| PUT /{id}/users/{userId} | Yes | Yes* | No | No |
| DELETE /{id}/users/{userId} | Yes | Yes* | No | No |
| GET /{id}/invitations | Yes | Yes | No | No |
| DELETE /{id}/invitations/{id} | Yes | Yes | No | No |

*Admin cannot modify super-admin users

### 8.3 Organisation-Level Access Control

- Users can only access organisations they belong to
- Organisation membership verified via OrgUser lookup (GSI1: UserOrgIndex)
- All API calls validate `custom:org_id` from JWT matches requested orgId

### 8.4 IAM Policies

**Lambda Execution Role**:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DynamoDBAccess",
      "Effect": "Allow",
      "Action": [
        "dynamodb:GetItem",
        "dynamodb:PutItem",
        "dynamodb:UpdateItem",
        "dynamodb:DeleteItem",
        "dynamodb:Query"
      ],
      "Resource": [
        "arn:aws:dynamodb:${region}:${account}:table/bbws-portal-${env}",
        "arn:aws:dynamodb:${region}:${account}:table/bbws-portal-${env}/index/*"
      ]
    },
    {
      "Sid": "SESAccess",
      "Effect": "Allow",
      "Action": [
        "ses:SendEmail",
        "ses:SendTemplatedEmail"
      ],
      "Resource": "arn:aws:ses:${region}:${account}:identity/*"
    },
    {
      "Sid": "EventBridgeAccess",
      "Effect": "Allow",
      "Action": [
        "events:PutEvents"
      ],
      "Resource": "arn:aws:events:${region}:${account}:event-bus/bbws-events-${env}"
    },
    {
      "Sid": "CloudWatchLogs",
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:${region}:${account}:log-group:/aws/lambda/bbws-org-*"
    }
  ]
}
```

### 8.5 Data Protection

| Aspect | Implementation |
|--------|----------------|
| Encryption at Rest | DynamoDB encryption with AWS-managed KMS |
| Encryption in Transit | TLS 1.2+ enforced |
| Invitation Token | 256-bit cryptographically secure random token |
| Token Storage | Hashed in database, cleartext in email link only |
| Input Validation | Pydantic schema validation on all inputs |
| Output Encoding | JSON response encoding |

---

## 9. Error Handling

### 9.1 Exception Hierarchy

```python
class OrganisationServiceError(Exception):
    """Base exception for organisation service errors."""
    pass

class BusinessException(OrganisationServiceError):
    """Business rule violation - client error (4xx)."""
    def __init__(self, code: str, message: str, details: dict = None):
        self.code = code
        self.message = message
        self.details = details or {}
        super().__init__(message)

class OrganisationNotFoundError(BusinessException):
    def __init__(self, org_id: str):
        super().__init__(
            code="ORGANISATION_NOT_FOUND",
            message=f"Organisation {org_id} not found",
            details={"organisationId": org_id}
        )

class UserNotFoundError(BusinessException):
    def __init__(self, user_id: str):
        super().__init__(
            code="USER_NOT_FOUND",
            message=f"User {user_id} not found in organisation",
            details={"userId": user_id}
        )

class UserAlreadyMemberError(BusinessException):
    def __init__(self, email: str):
        super().__init__(
            code="USER_ALREADY_MEMBER",
            message=f"User {email} is already a member",
            details={"email": email}
        )

class InvitationPendingError(BusinessException):
    def __init__(self, email: str):
        super().__init__(
            code="INVITATION_PENDING",
            message=f"Invitation already pending for {email}",
            details={"email": email}
        )

class InvitationNotFoundError(BusinessException):
    def __init__(self, invitation_id: str):
        super().__init__(
            code="INVITATION_NOT_FOUND",
            message=f"Invitation {invitation_id} not found",
            details={"invitationId": invitation_id}
        )

class CannotRemoveSuperAdminError(BusinessException):
    def __init__(self):
        super().__init__(
            code="CANNOT_REMOVE_SUPER_ADMIN",
            message="Cannot remove super-admin from organisation"
        )

class CannotRemoveLastAdminError(BusinessException):
    def __init__(self):
        super().__init__(
            code="CANNOT_REMOVE_LAST_ADMIN",
            message="Cannot remove last admin. Assign another admin first."
        )

class CannotDemoteSelfError(BusinessException):
    def __init__(self):
        super().__init__(
            code="CANNOT_DEMOTE_SELF",
            message="Cannot demote yourself"
        )

class ForbiddenError(BusinessException):
    def __init__(self, message: str):
        super().__init__(
            code="FORBIDDEN",
            message=message
        )
```

### 9.2 Error Code Reference

| Code | HTTP | Description | Retry |
|------|------|-------------|-------|
| VALIDATION_ERROR | 400 | Request body validation failed | No |
| UNAUTHORIZED | 401 | Missing or invalid JWT token | No |
| FORBIDDEN | 403 | Insufficient permissions | No |
| ORGANISATION_NOT_FOUND | 404 | Organisation does not exist | No |
| USER_NOT_FOUND | 404 | User not in organisation | No |
| INVITATION_NOT_FOUND | 404 | Invitation does not exist | No |
| USER_ALREADY_MEMBER | 409 | User is already a member | No |
| INVITATION_PENDING | 409 | Invitation already pending | No |
| CANNOT_REMOVE_SUPER_ADMIN | 422 | Cannot remove super-admin | No |
| CANNOT_REMOVE_LAST_ADMIN | 422 | Cannot remove last admin | No |
| CANNOT_DEMOTE_SELF | 422 | Cannot demote yourself | No |
| RATE_LIMITED | 429 | Too many requests | Yes (backoff) |
| INTERNAL_ERROR | 500 | Unexpected server error | Yes |

### 9.3 Retry Configuration

| Operation | Max Retries | Backoff | Notes |
|-----------|-------------|---------|-------|
| DynamoDB | 3 | Exponential (base 100ms) | Built into boto3 |
| SES | 3 | Exponential (base 200ms) | Custom implementation |
| EventBridge | 3 | Exponential (base 200ms) | Custom implementation |

---

## 10. Monitoring & Alerting

### 10.1 CloudWatch Metrics

**Custom Metrics** (Namespace: `BBWS/PortalOrganisation`):

| Metric | Unit | Dimensions | Description |
|--------|------|------------|-------------|
| InvitationsSent | Count | Environment | Invitation emails sent |
| InvitationsAccepted | Count | Environment | Invitations accepted |
| InvitationsDeclined | Count | Environment | Invitations declined |
| InvitationsExpired | Count | Environment | Invitations expired |
| UsersAdded | Count | Environment | Users added to org |
| UsersRemoved | Count | Environment | Users removed from org |
| RoleChanges | Count | Environment | User role changes |
| ValidationErrors | Count | Environment | Request validation failures |
| AuthorizationFailures | Count | Environment | Permission denied errors |

### 10.2 CloudWatch Alarms

| Alarm | Metric | Threshold | Period | Actions |
|-------|--------|-----------|--------|---------|
| HighValidationErrors | ValidationErrors | > 10 | 5 min | SNS Alert |
| HighAuthFailures | AuthorizationFailures | > 5 | 5 min | SNS Alert |
| InvitationEmailFailures | SES.Bounces | > 3 | 5 min | SNS Alert |
| LambdaErrors | Errors | > 5 | 5 min | SNS Alert |
| HighLatency | Duration | > 5s avg | 5 min | SNS Alert |

### 10.3 Dashboard Widgets

```json
{
  "widgets": [
    {
      "type": "metric",
      "properties": {
        "title": "Organisation Operations",
        "metrics": [
          ["BBWS/PortalOrganisation", "InvitationsSent"],
          [".", "InvitationsAccepted"],
          [".", "UsersAdded"],
          [".", "UsersRemoved"]
        ],
        "period": 300,
        "stat": "Sum"
      }
    },
    {
      "type": "metric",
      "properties": {
        "title": "Errors",
        "metrics": [
          ["BBWS/PortalOrganisation", "ValidationErrors"],
          [".", "AuthorizationFailures"]
        ],
        "period": 300,
        "stat": "Sum"
      }
    },
    {
      "type": "metric",
      "properties": {
        "title": "Lambda Performance",
        "metrics": [
          ["AWS/Lambda", "Invocations", "FunctionName", "bbws-org-list-${env}"],
          [".", ".", ".", "bbws-org-users-invite-${env}"],
          [".", "Errors", ".", "bbws-org-list-${env}"],
          [".", ".", ".", "bbws-org-users-invite-${env}"]
        ],
        "period": 300,
        "stat": "Sum"
      }
    }
  ]
}
```

### 10.4 Logging

**Log Structure** (JSON Lines format):

```json
{
  "timestamp": "2026-01-20T12:00:00.123Z",
  "level": "INFO",
  "service": "portal-organisation",
  "function": "bbws-org-users-invite",
  "requestId": "req-abc123",
  "xrayTraceId": "1-abc123-def456",
  "organisationId": "org-550e8400",
  "action": "INVITE_USER",
  "status": "SUCCESS",
  "duration": 234,
  "message": "Invitation sent to newuser@example.com"
}
```

**Log Groups**:

| Log Group | Retention | Purpose |
|-----------|-----------|---------|
| `/aws/lambda/bbws-org-list-{env}` | 30 days | List organisations logs |
| `/aws/lambda/bbws-org-get-{env}` | 30 days | Get organisation logs |
| `/aws/lambda/bbws-org-users-invite-{env}` | 30 days | Invitation logs |
| `/aws/lambda/bbws-org-users-remove-{env}` | 30 days | User removal logs |

---

## 11. NFRs

### 11.1 Performance

| Metric | Target | Measurement |
|--------|--------|-------------|
| List organisations response time | < 300ms | p99 |
| Get organisation response time | < 200ms | p99 |
| Update organisation response time | < 500ms | p99 |
| Invite user response time | < 2s | p99 (includes email) |
| List users response time (20 items) | < 500ms | p99 |
| DynamoDB read latency | < 10ms | p99 |
| Lambda cold start | < 3 seconds | p99 |

### 11.2 Scalability

| Aspect | Target |
|--------|--------|
| Concurrent API requests | 100 req/sec |
| Maximum organisations | 10,000+ without architecture changes |
| Maximum users per organisation | 500 |
| Maximum pending invitations | 100 per organisation |
| DynamoDB capacity | On-demand (auto-scaling) |
| Lambda concurrency | Auto-scaling (reserved: 50) |

### 11.3 Availability

| Metric | Target |
|--------|--------|
| API Uptime | 99.9% |
| RTO | 4 hours (DR failover) |
| RPO | 1 hour (backup frequency) |

### 11.4 Security

| Aspect | Implementation |
|--------|----------------|
| Authentication | Cognito JWT |
| Authorization | RBAC + Organisation-based |
| Encryption at rest | DynamoDB encryption (AWS KMS) |
| Encryption in transit | TLS 1.2+ |
| Input validation | Pydantic schema validation |
| Rate limiting | 100 req/sec |
| Invitation token | 256-bit secure random |

---

## 12. Troubleshooting Playbook

### 12.1 Invitation Email Not Received

**Symptoms**: User reports not receiving invitation email

**Diagnosis**:
```sql
-- Check CloudWatch Logs for email send
fields @timestamp, @message, email
| filter action = "SEND_INVITATION_EMAIL"
| filter email = "user@example.com"
| sort @timestamp desc
| limit 10
```

**Resolution**:
1. Check SES bounce/complaint metrics
2. Verify email address is correct
3. Check spam folder
4. Verify SES sending limits not exceeded
5. Resend invitation via admin UI

### 12.2 Cannot Remove User

**Symptoms**: 422 error when removing user

**Diagnosis**:
1. Check if user is super-admin (cannot be removed)
2. Check if user is last admin (cannot be removed)
3. Check requester's role (must be admin+)

**Resolution**:
1. If super-admin: Contact platform admin
2. If last admin: Assign another admin first
3. If permission issue: Use account with admin role

### 12.3 Invitation Expired

**Symptoms**: User clicks link but invitation is expired

**Diagnosis**:
```sql
-- Check invitation status
fields @timestamp, invitationId, status, expiresAt
| filter invitationId = "inv-xyz"
| limit 1
```

**Resolution**:
1. Admin cancels expired invitation
2. Admin sends new invitation
3. User accepts new invitation

### 12.4 User Cannot Access Organisation

**Symptoms**: User sees 403 Forbidden

**Diagnosis**:
1. Check JWT claims for org_id
2. Check OrgUser record exists
3. Check user status is active

**Resolution**:
1. Re-authenticate to refresh token
2. Verify user membership in org
3. Check if user was removed

---

## 13. Signoff

| Role | Name | Signature | Date |
|------|------|-----------|------|
| Technical Lead | | | |
| Security Engineer | | | |
| QA Lead | | | |
| DevOps Lead | | | |

---

## 14. Definition of Terms

| Term | Definition |
|------|------------|
| Organisation | Top-level entity grouping tenants and users |
| OrgUser | User membership record linking user to organisation |
| Tenant | Workspace within organisation containing sites |
| Invitation | Pending request for user to join organisation |
| Super-Admin | Highest permission level with full access |
| Admin | Can manage users and configuration |
| User | Can create and edit content |
| Viewer | Read-only access |
| HATEOAS | Hypermedia As The Engine Of Application State |
| GSI | Global Secondary Index (DynamoDB) |

---

## 15. Appendices

### Appendix A: OpenAPI Specification

See separate file: `openapi/organisation-api.yaml`

### Appendix B: Terraform Modules

See separate file: `terraform/README.md`

### Appendix C: Test Scenarios

| Scenario | Input | Expected Output |
|----------|-------|-----------------|
| List organisations - success | Valid JWT | 200 + organisation list |
| Get organisation - not found | Invalid orgId | 404 Not Found |
| Invite user - success | Valid email, role | 201 + invitation sent |
| Invite user - already member | Existing member email | 409 Conflict |
| Remove user - super-admin | Super-admin userId | 422 Unprocessable |
| Remove user - last admin | Last admin userId | 422 Unprocessable |
| Remove user - success | Regular user | 200 + user removed |
| Update role - success | Valid role | 200 + role updated |

### Appendix D: Email Templates

**Invitation Email**:
```html
Subject: You've been invited to join {organisationName} on BBWS

Hi,

{inviterName} has invited you to join {organisationName} on the BBWS Customer Portal.

Your role: {role}

Click the link below to accept this invitation:
{invitationLink}

This invitation expires on {expiresAt}.

{customMessage}

If you did not expect this invitation, you can safely ignore this email.

Best regards,
The BBWS Team
```

---

## 16. References

| Document | Location |
|----------|----------|
| BRS 2.2 Customer Portal Private | ../BRS/2.2_BRS_Customer_Portal_Private.md |
| HLD 2.2 Customer Portal Private | ../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md |
| LLD 2.5 Tenant Management | ./2.5_LLD_Tenant_Management.md |
| LLD 2.1.6 Invitation Lambda | ./2.1.6_LLD_Invitation_Lambda.md |
| AWS Lambda Powertools | https://docs.powertools.aws.dev/lambda/python/ |
| DynamoDB Best Practices | https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/best-practices.html |

---

**End of Document**
