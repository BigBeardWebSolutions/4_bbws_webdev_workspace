# LLD Specification: S3 and DynamoDB Infrastructure

**LLD Document**: `2.1.8_LLD_S3_and_DynamoDB.md`
**Version**: 1.0
**Date**: 2025-12-25
**Status**: Specification (Awaiting Plan Approval)

---

## 1. Overview

### 1.1 Purpose

Create a comprehensive Low-Level Design (LLD) document that specifies the infrastructure for S3 buckets and DynamoDB tables supporting the BBWS Customer Portal (Public) system, along with CI/CD pipelines for automated deployment with human approval gates.

### 1.2 Scope

**In Scope:**
- DynamoDB table schemas for Tenants, Products, and Campaigns
- S3 bucket configurations for HTML templates
- HTML email templates (order confirmations, receipts, notifications, invoices)
- Terraform modules for infrastructure as code
- GitHub Actions pipeline with validation and approval gates
- Environment-specific configurations (DEV, SIT, PROD)
- Cross-environment promotion workflows
- Terraform state management
- Disaster recovery configurations (PITR, backups, cross-region replication)
- Deployment and operational runbooks

**Out of Scope:**
- Lambda function code generation (covered in separate LLDs)
- Frontend application code
- API Gateway configurations
- Cognito user pool setup
- PayFast payment integration

### 1.3 Referenced Documents

| Document | Location | Purpose |
|----------|----------|---------|
| Customer Portal Public HLD v1.1 | `2_bbws_docs/HLDs/2.1_BBWS_Customer_Portal_Public_HLD_V1.1.md` | Parent architecture document |
| Order Lambda Code Gen Spec | `2_bbws_docs/LLDs/2.1.8_LLD_Order_Lambda_Code_Gen_Spec.md` | Prerequisites and integration patterns |
| Questions & Answers | `2_bbws_docs/LLDs/specs/questions.md` | Detailed requirements clarification |

---

## 2. Repository Structure

### 2.1 GitHub Repositories

| Repository | Purpose | Naming Convention |
|------------|---------|-------------------|
| `2_1_bbws_dynamodb_schemas` | DynamoDB table schemas (JSON), GSI definitions, migration scripts | Single repository |
| `2_1_bbws_s3_schemas` | S3 bucket configurations, HTML templates, template versioning | Single repository |

### 2.2 Repository Content Structure

#### 2.2.1 DynamoDB Repository Structure

```
2_1_bbws_dynamodb_schemas/
├── schemas/
│   ├── tenants/
│   │   ├── tenant.schema.json
│   │   └── README.md
│   ├── products/
│   │   ├── product.schema.json
│   │   └── README.md
│   └── campaigns/
│       ├── campaign.schema.json
│       └── README.md
├── terraform/
│   ├── dev/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── dev.tfvars
│   ├── sit/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── sit.tfvars
│   ├── prod/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── prod.tfvars
│   └── modules/
│       ├── dynamodb_table/
│       │   ├── main.tf
│       │   ├── variables.tf
│       │   ├── outputs.tf
│       │   └── README.md
│       ├── gsi/
│       │   ├── main.tf
│       │   ├── variables.tf
│       │   └── outputs.tf
│       └── backup/
│           ├── main.tf
│           ├── variables.tf
│           └── outputs.tf
├── migrations/
│   ├── README.md
│   └── scripts/
│       └── validate_schemas.py
├── .github/
│   └── workflows/
│       ├── validate-schemas.yml
│       ├── terraform-plan.yml
│       ├── terraform-apply-dev.yml
│       ├── terraform-apply-sit.yml
│       └── terraform-apply-prod.yml
├── tests/
│   ├── test_schemas.py
│   └── test_terraform.py
└── README.md
```

#### 2.2.2 S3 Repository Structure

```
2_1_bbws_s3_schemas/
├── templates/
│   ├── receipts/
│   │   ├── receipt.html
│   │   ├── receipt_internal.html
│   │   ├── order.html
│   │   └── order_internal.html
│   ├── notifications/
│   │   ├── order_confirmation_customer.html
│   │   ├── order_confirmation_internal.html
│   │   ├── payment_confirmation_customer.html
│   │   ├── payment_confirmation_internal.html
│   │   ├── site_creation_customer.html
│   │   └── site_creation_internal.html
│   └── invoices/
│       ├── invoice.html
│       └── invoice_internal.html
├── terraform/
│   ├── dev/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── dev.tfvars
│   ├── sit/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── sit.tfvars
│   ├── prod/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── prod.tfvars
│   └── modules/
│       ├── s3_bucket/
│       │   ├── main.tf
│       │   ├── variables.tf
│       │   ├── outputs.tf
│       │   └── README.md
│       ├── bucket_policy/
│       │   ├── main.tf
│       │   ├── variables.tf
│       │   └── outputs.tf
│       └── replication/
│           ├── main.tf
│           ├── variables.tf
│           └── outputs.tf
├── .github/
│   └── workflows/
│       ├── validate-templates.yml
│       ├── terraform-plan.yml
│       ├── terraform-apply-dev.yml
│       ├── terraform-apply-sit.yml
│       └── terraform-apply-prod.yml
├── tests/
│   ├── test_templates.py
│   └── test_terraform.py
└── README.md
```

---

## 3. DynamoDB Table Specifications

### 3.1 Tables to Create

| Table Name | PK Pattern | SK Pattern | Purpose |
|------------|------------|------------|---------|
| `tenants` | `TENANT#{tenantId}` | `METADATA` | Customer tenant records |
| `products` | `PRODUCT#{productId}` | `METADATA` | Product catalog |
| `campaigns` | `CAMPAIGN#{code}` | `METADATA` | Marketing campaigns |

### 3.2 Schema Requirements

#### 3.2.1 Tenant Table Schema

**Attributes:**
- `id` (String) - Tenant UUID
- `email` (String) - Customer email
- `status` (String) - UNVALIDATED | VALIDATED | REGISTERED | SUSPENDED
- `organizationName` (String, optional) - Organization name
- `destinationEmail` (String, optional) - Forms destination email
- `active` (Boolean) - Soft delete flag (default: true)
- `dateCreated` (String) - ISO 8601 timestamp
- `dateLastUpdated` (String) - ISO 8601 timestamp
- `lastUpdatedBy` (String) - User/system that made last update

**GSIs:**
- `EmailIndex` - PK: email, SK: entityType
- `TenantStatusIndex` - PK: status, SK: dateCreated
- `ActiveIndex` - PK: active, SK: dateCreated (sparse index)

#### 3.2.2 Product Table Schema

**Attributes:**
- `id` (String) - Product UUID
- `name` (String) - Product name
- `description` (String) - Product description
- `price` (Number) - Product price
- `features` (List) - List of feature strings
- `billingCycle` (String) - monthly | yearly
- `active` (Boolean) - Soft delete flag (default: true)
- `dateCreated` (String) - ISO 8601 timestamp
- `dateLastUpdated` (String) - ISO 8601 timestamp
- `lastUpdatedBy` (String) - User/system that made last update

**GSIs:**
- `ProductActiveIndex` - PK: active, SK: dateCreated
- `ActiveIndex` - PK: active, SK: dateCreated (sparse index)

#### 3.2.3 Campaign Table Schema

**Attributes:**
- `id` (String) - Campaign UUID
- `code` (String) - Campaign code (used in PK)
- `description` (String) - Campaign description
- `discountPercentage` (Number) - Discount 0-100
- `productId` (String) - Associated product UUID
- `termsConditionsLink` (String) - URL to T&C
- `fromDate` (String) - Start date (YYYY-MM-DD)
- `toDate` (String) - End date (YYYY-MM-DD)
- `active` (Boolean) - Soft delete flag (default: true)
- `dateCreated` (String) - ISO 8601 timestamp
- `dateLastUpdated` (String) - ISO 8601 timestamp
- `lastUpdatedBy` (String) - User/system that made last update

**GSIs:**
- `CampaignActiveIndex` - PK: active, SK: fromDate
- `CampaignProductIndex` - PK: productId, SK: fromDate
- `ActiveIndex` - PK: active, SK: dateCreated (sparse index)

### 3.3 DynamoDB Configuration

| Setting | Value | Rationale |
|---------|-------|-----------|
| **Capacity Mode** | On-Demand | Variable traffic patterns, no capacity planning |
| **Encryption** | AWS-managed (SSE-KMS) | Data protection at rest |
| **PITR** | Enabled | Point-in-time recovery for disaster recovery |
| **Backup** | AWS Backup (hourly) | Automated backup retention |
| **Deletion Protection** | Enabled (PROD only) | Prevent accidental table deletion |
| **TTL** | Not enabled | No automatic expiration needed |
| **Streams** | Enabled (New and Old Images) | Change data capture for auditing |

---

## 4. S3 Bucket Specifications

### 4.1 Buckets to Create

| Bucket Name | Purpose | Versioning | Replication |
|-------------|---------|------------|-------------|
| `bbws-templates-dev` | HTML templates (DEV) | Enabled | No |
| `bbws-templates-sit` | HTML templates (SIT) | Enabled | No |
| `bbws-templates-prod` | HTML templates (PROD) | Enabled | Yes (to eu-west-1) |

### 4.2 HTML Templates

#### 4.2.1 Template Categories

| Category | Customer Template | Internal Template | Purpose |
|----------|-------------------|-------------------|---------|
| **Order Confirmation** | `order_confirmation_customer.html` | `order_confirmation_internal.html` | Sent when order is created |
| **Payment Confirmation** | `payment_confirmation_customer.html` | `payment_confirmation_internal.html` | Sent when payment is successful |
| **Receipt** | `receipt.html` | `receipt_internal.html` | Payment receipt |
| **Order Summary** | `order.html` | `order_internal.html` | Order details |
| **Site Creation** | `site_creation_customer.html` | `site_creation_internal.html` | When WordPress site is provisioned |
| **Invoice** | `invoice.html` | `invoice_internal.html` | Billing invoice |

#### 4.2.2 Template Structure

Each HTML template must include:
- **Variables**: Mustache-style `{{variable}}` placeholders
- **Responsive Design**: Mobile-friendly email layout
- **Branding**: BBWS/KimmyAI logo and colors
- **Legal Footer**: Unsubscribe link, company address
- **Plain Text Alternative**: For email clients that don't support HTML

#### 4.2.3 Template Locations

```
s3://bbws-templates-{env}/receipts/receipt.html
s3://bbws-templates-{env}/receipts/receipt_internal.html
s3://bbws-templates-{env}/receipts/order.html
s3://bbws-templates-{env}/receipts/order_internal.html
s3://bbws-templates-{env}/notifications/order_confirmation_customer.html
s3://bbws-templates-{env}/notifications/order_confirmation_internal.html
s3://bbws-templates-{env}/notifications/payment_confirmation_customer.html
s3://bbws-templates-{env}/notifications/payment_confirmation_internal.html
s3://bbws-templates-{env}/notifications/site_creation_customer.html
s3://bbws-templates-{env}/notifications/site_creation_internal.html
s3://bbws-templates-{env}/invoices/invoice.html
s3://bbws-templates-{env}/invoices/invoice_internal.html
```

### 4.3 S3 Bucket Configuration

| Setting | Value | Rationale |
|---------|-------|-----------|
| **Public Access** | Block all public access | Security requirement |
| **Versioning** | Enabled | Template version tracking |
| **Encryption** | SSE-S3 (AES-256) | Data protection at rest |
| **Lifecycle Policy** | Keep all versions for 90 days | Version management |
| **Access Logging** | Enabled (to separate logging bucket) | Audit trail |
| **Object Lock** | Not enabled | No compliance hold needed |
| **Replication** | PROD only → eu-west-1 | Disaster recovery |

---

## 5. Terraform Module Structure

### 5.1 Terraform Design Principles

1. **Separate Modules**: Each component (table, bucket, GSI, backup) is a reusable module
2. **Environment-Specific**: Separate `.tfvars` files for DEV, SIT, PROD
3. **State Management**: S3 backend with DynamoDB locking, separate state per environment
4. **No Hardcoding**: All environment-specific values parameterized
5. **Resource Naming**: Follow naming conventions with environment suffix

### 5.2 State Management

| Environment | State Location | Lock Table |
|-------------|----------------|------------|
| DEV | `s3://bbws-terraform-state-dev/2_1_bbws_dynamodb_schemas/terraform.tfstate` | `terraform-state-lock-dev` |
| SIT | `s3://bbws-terraform-state-sit/2_1_bbws_dynamodb_schemas/terraform.tfstate` | `terraform-state-lock-sit` |
| PROD | `s3://bbws-terraform-state-prod/2_1_bbws_dynamodb_schemas/terraform.tfstate` | `terraform-state-lock-prod` |

**Separate State Files per Component:**
```
s3://bbws-terraform-state-{env}/
├── 2_1_bbws_dynamodb_schemas/
│   ├── tenants/terraform.tfstate
│   ├── products/terraform.tfstate
│   └── campaigns/terraform.tfstate
└── 2_1_bbws_s3_schemas/
    └── templates/terraform.tfstate
```

### 5.3 Resource Naming Conventions

#### 5.3.1 DynamoDB Tables

**Pattern**: `{domain}`

Examples:
- `tenants` (DEV, SIT, PROD all use same name, isolated by AWS account)
- `products`
- `campaigns`

**Rationale**: Simple domain names, environment isolation via separate AWS accounts

#### 5.3.2 S3 Buckets

**Pattern**: `bbws-{purpose}-{env}`

Examples:
- `bbws-templates-dev`
- `bbws-templates-sit`
- `bbws-templates-prod`

**Rationale**: Global S3 namespace requires unique names across environments

#### 5.3.3 Tagging Strategy

All resources must have the following tags:

| Tag Key | Tag Value | Required |
|---------|-----------|----------|
| `Environment` | dev / sit / prod | Yes |
| `Project` | BBWS WP Containers | Yes |
| `Owner` | Tebogo | Yes |
| `CostCenter` | AWS | Yes |
| `ManagedBy` | Terraform | Yes |
| `BackupPolicy` | daily / hourly | Yes (tables only) |
| `Component` | dynamodb / s3 | Yes |

---

## 6. GitHub Actions Pipeline

### 6.1 Pipeline Stages

| Stage | Purpose | Triggers | Approval Required |
|-------|---------|----------|-------------------|
| **1. Validation** | Terraform fmt/validate, schema validation, template validation | Push to `main` or PR | No |
| **2. Terraform Plan** | Generate terraform plan for review | After validation passes | No |
| **3. Approval Gate** | Human reviews terraform plan | After plan generation | **Yes** |
| **4. Deploy DEV** | Apply terraform to DEV environment | After approval | **Yes (manual trigger)** |
| **5. Test DEV** | Post-deployment validation tests | After DEV deploy | No |
| **6. Promote to SIT** | Apply terraform to SIT environment | Manual trigger after DEV tests pass | **Yes** |
| **7. Test SIT** | Integration tests in SIT | After SIT deploy | No |
| **8. Promote to PROD** | Apply terraform to PROD environment | Manual trigger after SIT tests pass | **Yes** |
| **9. Test PROD** | Smoke tests in PROD | After PROD deploy | No |

### 6.2 Approval Requirements

| Deployment Target | Approval Type | Approvers |
|-------------------|---------------|-----------|
| **Terraform Plan** | Manual review | Any team member |
| **DEV Deployment** | Manual approval gate | Lead Developer |
| **SIT Promotion** | Manual approval gate | Tech Lead + QA |
| **PROD Promotion** | Manual approval gate | Tech Lead + Product Owner |

### 6.3 Validation Steps

#### 6.3.1 DynamoDB Schema Validation

```bash
# Validate JSON schema syntax
python scripts/validate_schemas.py --schema schemas/tenants/tenant.schema.json

# Validate schema against AWS DynamoDB constraints
terraform validate

# Terraform format check
terraform fmt -check -recursive
```

#### 6.3.2 S3 Template Validation

```bash
# HTML syntax validation
tidy -q -e templates/**/*.html

# Mustache template variable validation
python scripts/validate_templates.py --check-variables

# Template rendering test
python scripts/test_render.py --template templates/receipts/receipt.html
```

#### 6.3.3 Terraform Validation

```bash
# Format check
terraform fmt -check -recursive

# Validate configuration
terraform validate

# Security scan
tfsec .

# Cost estimation
infracost breakdown --path .
```

### 6.4 Workflow Files

#### 6.4.1 `validate-schemas.yml` (DynamoDB)

```yaml
name: Validate DynamoDB Schemas
on:
  push:
    branches: [main]
    paths:
      - 'schemas/**'
      - 'terraform/**'
  pull_request:
    paths:
      - 'schemas/**'
      - 'terraform/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Validate JSON schemas
        run: python scripts/validate_schemas.py
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
      - name: Terraform Validate
        run: |
          cd terraform/dev
          terraform init -backend=false
          terraform validate
```

#### 6.4.2 `terraform-plan.yml`

```yaml
name: Terraform Plan
on:
  workflow_run:
    workflows: ["Validate DynamoDB Schemas"]
    types: [completed]
    branches: [main]

jobs:
  plan:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    strategy:
      matrix:
        environment: [dev, sit, prod]
    steps:
      - uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: af-south-1
          role-to-assume: ${{ secrets[format('AWS_ROLE_{0}', matrix.environment)] }}
      - name: Terraform Init
        run: |
          cd terraform/${{ matrix.environment }}
          terraform init
      - name: Terraform Plan
        run: |
          cd terraform/${{ matrix.environment }}
          terraform plan -var-file=${{ matrix.environment }}.tfvars -out=tfplan
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v3
        with:
          name: tfplan-${{ matrix.environment }}
          path: terraform/${{ matrix.environment }}/tfplan
```

#### 6.4.3 `terraform-apply-dev.yml`

```yaml
name: Deploy to DEV
on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "deploy-dev" to confirm'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: dev
      url: https://dev.api.kimmyai.io
    if: ${{ github.event.inputs.confirmation == 'deploy-dev' }}
    steps:
      - uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: af-south-1
          role-to-assume: ${{ secrets.AWS_ROLE_DEV }}
      - name: Terraform Init
        run: |
          cd terraform/dev
          terraform init
      - name: Terraform Apply
        run: |
          cd terraform/dev
          terraform apply -var-file=dev.tfvars -auto-approve
      - name: Post-Deployment Validation
        run: python tests/test_deployment.py --env dev
```

#### 6.4.4 `terraform-apply-sit.yml`

```yaml
name: Promote to SIT
on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "promote-sit" to confirm'
        required: true

jobs:
  promote:
    runs-on: ubuntu-latest
    environment:
      name: sit
      url: https://sit.api.kimmyai.io
    if: ${{ github.event.inputs.confirmation == 'promote-sit' }}
    steps:
      - uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: af-south-1
          role-to-assume: ${{ secrets.AWS_ROLE_SIT }}
      - name: Terraform Init
        run: |
          cd terraform/sit
          terraform init
      - name: Terraform Apply
        run: |
          cd terraform/sit
          terraform apply -var-file=sit.tfvars -auto-approve
      - name: Post-Deployment Validation
        run: python tests/test_deployment.py --env sit
```

#### 6.4.5 `terraform-apply-prod.yml`

```yaml
name: Promote to PROD
on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "promote-prod" to confirm'
        required: true

jobs:
  promote:
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: https://api.kimmyai.io
    if: ${{ github.event.inputs.confirmation == 'promote-prod' }}
    steps:
      - uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: af-south-1
          role-to-assume: ${{ secrets.AWS_ROLE_PROD }}
      - name: Terraform Init
        run: |
          cd terraform/prod
          terraform init
      - name: Terraform Apply
        run: |
          cd terraform/prod
          terraform apply -var-file=prod.tfvars -auto-approve
      - name: Post-Deployment Validation
        run: python tests/test_deployment.py --env prod
      - name: Notify Deployment
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
          -H 'Content-Type: application/json' \
          -d '{"text":"PROD deployment complete: DynamoDB and S3 infrastructure"}'
```

### 6.5 Rollback Strategy

**Rollback Mechanism**: Terraform state rollback

#### 6.5.1 Manual Rollback Process

```bash
# 1. List available state versions
aws s3api list-object-versions \
  --bucket bbws-terraform-state-{env} \
  --prefix 2_1_bbws_dynamodb_schemas/terraform.tfstate

# 2. Download previous state version
aws s3api get-object \
  --bucket bbws-terraform-state-{env} \
  --key 2_1_bbws_dynamodb_schemas/terraform.tfstate \
  --version-id {previous-version-id} \
  terraform.tfstate.backup

# 3. Restore previous state
terraform state push terraform.tfstate.backup

# 4. Verify state
terraform plan -var-file={env}.tfvars

# 5. Apply rollback
terraform apply -var-file={env}.tfvars -auto-approve
```

#### 6.5.2 Automated Rollback Workflow

```yaml
name: Rollback Infrastructure
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - dev
          - sit
          - prod
      version_id:
        description: 'State version ID to restore'
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: af-south-1
          role-to-assume: ${{ secrets[format('AWS_ROLE_{0}', github.event.inputs.environment)] }}
      - name: Restore State
        run: |
          aws s3api get-object \
            --bucket bbws-terraform-state-${{ github.event.inputs.environment }} \
            --key 2_1_bbws_dynamodb_schemas/terraform.tfstate \
            --version-id ${{ github.event.inputs.version_id }} \
            terraform.tfstate.backup
      - name: Push State
        run: terraform state push terraform.tfstate.backup
      - name: Apply Rollback
        run: |
          cd terraform/${{ github.event.inputs.environment }}
          terraform apply -var-file=${{ github.event.inputs.environment }}.tfvars -auto-approve
```

---

## 7. Disaster Recovery

### 7.1 DynamoDB Backup Strategy

| Backup Type | Frequency | Retention | PROD Cross-Region | Cost |
|-------------|-----------|-----------|-------------------|------|
| **PITR** | Continuous | 35 days | No | AWS Backup pricing |
| **AWS Backup** | Hourly | 90 days | Yes (to eu-west-1) | Based on storage |
| **On-Demand** | Manual | Indefinite | Optional | Pay per backup |

### 7.2 S3 Replication

| Bucket | Replication Enabled | Destination Region | Replication Rule |
|--------|---------------------|-------------------|------------------|
| `bbws-templates-dev` | No | N/A | N/A |
| `bbws-templates-sit` | No | N/A | N/A |
| `bbws-templates-prod` | Yes | eu-west-1 | Replicate all objects |

### 7.3 DR Terraform Configuration

**Note**: Multi-region deployment is **out of scope** for this LLD. DR-specific pipeline will be created separately.

---

## 8. Testing and Validation

### 8.1 Pre-Deployment Tests

| Test Type | Tool | Purpose |
|-----------|------|---------|
| Schema Validation | Python + JSON Schema | Validate DynamoDB schema syntax |
| Template Validation | HTML Tidy | Validate HTML syntax |
| Terraform Format | terraform fmt | Code formatting |
| Terraform Validation | terraform validate | Configuration validation |
| Security Scan | tfsec | Identify security issues |
| Cost Estimation | infracost | Estimate infrastructure costs |

### 8.2 Post-Deployment Tests

| Test Type | Tool | Purpose |
|-----------|------|---------|
| Table Accessibility | boto3 | Verify table exists and is accessible |
| Bucket Accessibility | boto3 | Verify bucket exists and is accessible |
| Template Upload | boto3 | Verify templates are uploaded correctly |
| Policy Validation | AWS CLI | Verify bucket policies are correct |
| Tag Verification | AWS CLI | Verify all resources are tagged |

---

## 9. Documentation Requirements

### 9.1 LLD Document Updates

The following diagrams and sections must be included in `2.1.8_LLD_S3_and_DynamoDB.md`:

#### 9.1.1 Architecture Diagrams

1. **DynamoDB Table Relationship Diagram**
   - Show PK/SK patterns
   - GSI relationships
   - Access patterns

2. **S3 Bucket Organization Diagram**
   - Folder structure
   - Template categories
   - Replication flow (PROD only)

3. **CI/CD Pipeline Flow Diagram**
   - Validation → Plan → Approval → Deploy → Test
   - Environment promotion flow
   - Rollback process

4. **Environment Promotion Diagram**
   - DEV → SIT → PROD flow
   - Approval gates
   - State management

#### 9.1.2 Sequence Diagrams

1. **Deployment Workflow**
   - Push code → Validate → Plan → Approve → Deploy

2. **Rollback Workflow**
   - Detect issue → Select version → Restore state → Apply

### 9.2 Runbooks

Create the following runbooks in `/Users/tebogotseka/Documents/agentic_work/2_bbws_docs/runbooks/`:

#### 9.2.1 Deployment Runbook

**File**: `2.1.8_Deployment_Runbook_S3_DynamoDB.md`

**Contents**:
- Initial setup (AWS credentials, Terraform backends)
- Deployment to DEV (step-by-step)
- Promotion to SIT (step-by-step)
- Promotion to PROD (step-by-step)
- Common deployment errors and solutions

#### 9.2.2 Promotion Runbook

**File**: `2.1.8_Promotion_Runbook_S3_DynamoDB.md`

**Contents**:
- Prerequisites checklist
- DEV → SIT promotion steps
- SIT → PROD promotion steps
- Approval process
- Post-promotion validation
- Rollback if promotion fails

#### 9.2.3 Troubleshooting Runbook

**File**: `2.1.8_Troubleshooting_Runbook_S3_DynamoDB.md`

**Contents**:
- Common issues and resolutions
- Terraform state lock issues
- DynamoDB table creation failures
- S3 bucket access denied errors
- Template upload failures
- Pipeline failures and debugging
- How to contact support

#### 9.2.4 Rollback Runbook

**File**: `2.1.8_Rollback_Runbook_S3_DynamoDB.md`

**Contents**:
- When to rollback
- Rollback prerequisites
- Manual rollback steps
- Automated rollback using GitHub Actions
- Post-rollback validation
- Rollback troubleshooting

---

## 10. Integration with Lambda Services

### 10.1 Resource Discovery Pattern

Lambda services will discover DynamoDB tables and S3 buckets using naming conventions:

**DynamoDB Tables**:
```python
# Lambda code references tables by name
TABLE_NAME = os.environ.get('DYNAMODB_TABLE', 'tenants')

# No hardcoded table ARNs or names in Lambda code
# Environment variables configured per environment in Lambda terraform
```

**S3 Buckets**:
```python
# Lambda code references buckets by naming pattern
TEMPLATE_BUCKET = f"bbws-templates-{os.environ.get('ENVIRONMENT')}"

# Templates accessed by key
TEMPLATE_KEY = "receipts/receipt.html"
```

### 10.2 IAM Permissions

Lambda functions will require IAM policies granting access to:
- DynamoDB: `dynamodb:GetItem`, `dynamodb:PutItem`, `dynamodb:Query`, `dynamodb:Scan`, `dynamodb:UpdateItem`
- S3: `s3:GetObject`, `s3:PutObject`, `s3:ListBucket`

**Note**: IAM policies are defined in Lambda-specific terraform, not in this LLD scope.

---

## 11. Success Criteria

### 11.1 Acceptance Criteria

- [ ] DynamoDB tables created with correct schemas in all environments
- [ ] All GSIs created and functional
- [ ] S3 buckets created with correct configurations
- [ ] All HTML templates uploaded to S3
- [ ] GitHub Actions pipeline runs successfully
- [ ] Approval gates function correctly
- [ ] DEV deployment successful
- [ ] SIT promotion successful
- [ ] PROD promotion successful (dry-run only, actual PROD deploy requires separate approval)
- [ ] Rollback process validated in DEV
- [ ] All runbooks created and reviewed
- [ ] LLD document complete with diagrams
- [ ] Post-deployment tests pass in all environments

### 11.2 Quality Gates

| Gate | Criteria | Blocker |
|------|----------|---------|
| Schema Validation | All JSON schemas valid | Yes |
| Template Validation | All HTML templates valid | Yes |
| Terraform Format | terraform fmt passes | Yes |
| Security Scan | No high/critical tfsec findings | Yes |
| Cost Estimation | Under $100/month for DEV/SIT | No (review required) |
| Deployment Success | terraform apply succeeds | Yes |
| Post-Deploy Tests | All tests pass | Yes |
| Tag Compliance | All resources tagged correctly | Yes |

---

## 12. Timeline and Milestones

| Phase | Milestone | Estimated Duration |
|-------|-----------|-------------------|
| **Phase 1** | Requirements analysis, LLD creation | TBD by project plan |
| **Phase 2** | Terraform module development | TBD by project plan |
| **Phase 3** | GitHub Actions pipeline creation | TBD by project plan |
| **Phase 4** | Testing and validation | TBD by project plan |
| **Phase 5** | Documentation and runbook creation | TBD by project plan |
| **Phase 6** | Review and approval | TBD by project plan |

---

## 13. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Terraform state corruption | High | S3 versioning enabled, regular state backups |
| DynamoDB table deletion | High | Deletion protection in PROD, IAM policies restrict delete |
| Template syntax errors | Medium | Automated validation in pipeline |
| Cost overrun | Medium | Infracost monitoring, budget alerts |
| Pipeline failure | Low | Comprehensive testing, rollback capability |
| Approval delays | Low | Clear approval process, notifications |

---

## 14. References

- [AWS DynamoDB Best Practices](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/best-practices.html)
- [AWS S3 Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html)
- [Terraform AWS Provider Documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Customer Portal Public HLD v1.1](../HLDs/2.1_BBWS_Customer_Portal_Public_HLD_V1.1.md)

---

**End of Specification**
