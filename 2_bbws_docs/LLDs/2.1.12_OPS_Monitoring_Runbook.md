# CPP Monitoring Runbook

**Version**: 1.0
**Created**: 2025-12-15
**Status**: Draft
**Component**: Customer Portal Public - Monitoring Operations
**Parent HLD**: [BBWS Customer Portal Public HLD](../BBWS_Customer_Portal_Public_HLD.md)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | Agentic Architect | Initial version |

---

## 1. Overview

### 1.1 Purpose

This runbook provides procedures for monitoring the Customer Portal Public (CPP) application, including dashboards, alerts, and response procedures.

### 1.2 Monitoring Stack

| Component | Tool | Purpose |
|-----------|------|---------|
| Metrics | CloudWatch Metrics | Performance monitoring |
| Logs | CloudWatch Logs | Centralized logging |
| Traces | X-Ray | Distributed tracing |
| Alerts | CloudWatch Alarms + SNS | Alert notifications |
| Dashboards | CloudWatch Dashboards | Visualization |

---

## 2. Key Metrics

### 2.1 Lambda Metrics

| Metric | Description | Threshold | Severity |
|--------|-------------|-----------|----------|
| Invocations | Total function invocations | N/A | Info |
| Errors | Function errors | > 1% | Critical |
| Duration | Execution time | > 5000ms p95 | Warning |
| Throttles | Throttled invocations | > 0 | Critical |
| ConcurrentExecutions | Concurrent runs | > 80% limit | Warning |
| DeadLetterErrors | DLQ failures | > 0 | Critical |

### 2.2 API Gateway Metrics

| Metric | Description | Threshold | Severity |
|--------|-------------|-----------|----------|
| 4XXError | Client errors | > 5% | Warning |
| 5XXError | Server errors | > 1% | Critical |
| Latency | Response time | > 3000ms p95 | Warning |
| Count | Request count | N/A | Info |
| IntegrationLatency | Backend latency | > 2000ms p95 | Warning |

### 2.3 DynamoDB Metrics

| Metric | Description | Threshold | Severity |
|--------|-------------|-----------|----------|
| ConsumedReadCapacityUnits | Read consumption | > 80% provisioned | Warning |
| ConsumedWriteCapacityUnits | Write consumption | > 80% provisioned | Warning |
| ThrottledRequests | Throttled requests | > 0 | Critical |
| SystemErrors | System errors | > 0 | Critical |
| UserErrors | User errors | > 1% | Warning |

### 2.4 CloudFront Metrics

| Metric | Description | Threshold | Severity |
|--------|-------------|-----------|----------|
| 4xxErrorRate | Client error rate | > 5% | Warning |
| 5xxErrorRate | Origin error rate | > 1% | Critical |
| CacheHitRate | Cache efficiency | < 80% | Warning |
| TotalErrorRate | Total errors | > 2% | Critical |

---

## 3. CloudWatch Alarms

### 3.1 Critical Alarms

```yaml
# Lambda Error Rate Alarm
LambdaErrorAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: bbws-${Environment}-lambda-errors
    AlarmDescription: Lambda error rate exceeded threshold
    MetricName: Errors
    Namespace: AWS/Lambda
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 2
    Threshold: 5
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref CriticalSNSTopic

# API Gateway 5XX Alarm
ApiGateway5XXAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: bbws-${Environment}-api-5xx
    AlarmDescription: API Gateway 5XX errors exceeded threshold
    MetricName: 5XXError
    Namespace: AWS/ApiGateway
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 1
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref CriticalSNSTopic

# DynamoDB Throttle Alarm
DynamoDBThrottleAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: bbws-${Environment}-dynamodb-throttle
    AlarmDescription: DynamoDB throttling detected
    MetricName: ThrottledRequests
    Namespace: AWS/DynamoDB
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 1
    Threshold: 0
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref CriticalSNSTopic
```

### 3.2 Warning Alarms

```yaml
# Lambda Duration Alarm
LambdaDurationAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: bbws-${Environment}-lambda-duration
    AlarmDescription: Lambda duration exceeded threshold
    MetricName: Duration
    Namespace: AWS/Lambda
    ExtendedStatistic: p95
    Period: 300
    EvaluationPeriods: 3
    Threshold: 5000
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref WarningSNSTopic

# API Gateway Latency Alarm
ApiGatewayLatencyAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: bbws-${Environment}-api-latency
    AlarmDescription: API Gateway latency exceeded threshold
    MetricName: Latency
    Namespace: AWS/ApiGateway
    ExtendedStatistic: p95
    Period: 300
    EvaluationPeriods: 3
    Threshold: 3000
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref WarningSNSTopic
```

---

## 4. CloudWatch Dashboards

### 4.1 Main Dashboard Widgets

```json
{
  "widgets": [
    {
      "type": "metric",
      "properties": {
        "title": "Lambda Invocations",
        "metrics": [
          ["AWS/Lambda", "Invocations", "FunctionName", "bbws-${env}-auth"],
          ["...", "bbws-${env}-cart"],
          ["...", "bbws-${env}-order"],
          ["...", "bbws-${env}-payment"]
        ],
        "period": 300,
        "stat": "Sum"
      }
    },
    {
      "type": "metric",
      "properties": {
        "title": "Lambda Errors",
        "metrics": [
          ["AWS/Lambda", "Errors", "FunctionName", "bbws-${env}-auth"],
          ["...", "bbws-${env}-cart"],
          ["...", "bbws-${env}-order"],
          ["...", "bbws-${env}-payment"]
        ],
        "period": 300,
        "stat": "Sum"
      }
    },
    {
      "type": "metric",
      "properties": {
        "title": "API Gateway Requests",
        "metrics": [
          ["AWS/ApiGateway", "Count", "ApiName", "bbws-${env}-api"]
        ],
        "period": 300,
        "stat": "Sum"
      }
    },
    {
      "type": "metric",
      "properties": {
        "title": "API Gateway Latency (p95)",
        "metrics": [
          ["AWS/ApiGateway", "Latency", "ApiName", "bbws-${env}-api"]
        ],
        "period": 300,
        "stat": "p95"
      }
    }
  ]
}
```

### 4.2 Dashboard Access

| Environment | Dashboard URL |
|-------------|---------------|
| dev | https://af-south-1.console.aws.amazon.com/cloudwatch/home?region=af-south-1#dashboards:name=bbws-dev-cpp |
| sit | https://af-south-1.console.aws.amazon.com/cloudwatch/home?region=af-south-1#dashboards:name=bbws-sit-cpp |
| prod | https://af-south-1.console.aws.amazon.com/cloudwatch/home?region=af-south-1#dashboards:name=bbws-prod-cpp |

---

## 5. Log Monitoring

### 5.1 Log Groups

| Component | Log Group |
|-----------|-----------|
| Auth Lambda | /aws/lambda/bbws-${env}-auth |
| Cart Lambda | /aws/lambda/bbws-${env}-cart |
| Order Lambda | /aws/lambda/bbws-${env}-order |
| Payment Lambda | /aws/lambda/bbws-${env}-payment |
| API Gateway | /aws/apigateway/bbws-${env} |

### 5.2 Log Queries

#### Error Query

```sql
fields @timestamp, @message, @logStream
| filter @message like /ERROR/
| sort @timestamp desc
| limit 100
```

#### Slow Request Query

```sql
fields @timestamp, @message, @duration
| filter @duration > 5000
| sort @duration desc
| limit 50
```

#### Payment Failure Query

```sql
fields @timestamp, @message
| filter @message like /PaymentFailed/ or @message like /payment_status.*FAILED/
| sort @timestamp desc
| limit 50
```

#### Failed Transactions Query

```sql
fields @timestamp, @message, orderId, paymentId
| filter @message like /TransactionFailed/ or @message like /status.*FAILED/
| sort @timestamp desc
| limit 100
```

### 5.3 Log Insights Alerts

```yaml
# Failed Payment Alert
FailedPaymentMetricFilter:
  Type: AWS::Logs::MetricFilter
  Properties:
    LogGroupName: /aws/lambda/bbws-${env}-payment
    FilterPattern: "PaymentFailed"
    MetricTransformations:
      - MetricName: FailedPayments
        MetricNamespace: BBWS/CPP
        MetricValue: 1

FailedPaymentAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: bbws-${env}-failed-payments
    MetricName: FailedPayments
    Namespace: BBWS/CPP
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 1
    Threshold: 3
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref CriticalSNSTopic
```

---

## 6. Alert Response Procedures

### 6.1 Critical Alert Response

| Alert | Initial Response | Escalation |
|-------|------------------|------------|
| Lambda Errors > 5 | Check CloudWatch logs, identify error pattern | DevOps Lead (15 min) |
| API 5XX > 1% | Check Lambda health, DynamoDB throttling | Tech Lead (15 min) |
| DynamoDB Throttle | Check capacity, consider on-demand | DevOps Lead (15 min) |
| Payment Failures > 3 | Check PayFast status, verify webhook | On-Call + Business (immediate) |

### 6.2 Warning Alert Response

| Alert | Initial Response | Escalation |
|-------|------------------|------------|
| Lambda Duration High | Check for inefficient queries | Next business day |
| API Latency High | Check downstream dependencies | DevOps Lead (1 hour) |
| Cache Hit Rate Low | Review caching strategy | Next sprint |

### 6.3 Escalation Matrix

| Severity | Response Time | Notification |
|----------|---------------|--------------|
| Critical | 15 minutes | SMS + Email + Slack |
| Warning | 1 hour | Email + Slack |
| Info | Next business day | Slack only |

---

## 7. Health Checks

### 7.1 Synthetic Monitoring

```bash
#!/bin/bash
# health-check.sh

API_URL="https://api.${ENVIRONMENT}.bigbeard.co.za"

# Check products endpoint
response=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/v1.0/products")
if [ "$response" != "200" ]; then
  echo "CRITICAL: Products endpoint returned $response"
  exit 2
fi

# Check health endpoint
response=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/v1.0/health")
if [ "$response" != "200" ]; then
  echo "CRITICAL: Health endpoint returned $response"
  exit 2
fi

echo "OK: All health checks passed"
exit 0
```

### 7.2 Scheduled Health Checks

| Check | Frequency | Timeout |
|-------|-----------|---------|
| API Health | Every 1 minute | 10 seconds |
| Products Endpoint | Every 5 minutes | 30 seconds |
| Frontend Load | Every 5 minutes | 30 seconds |

---

## 8. State Management Monitoring

### 8.1 Transaction State Table

Monitor the state management DynamoDB table for:

| State | Alert Condition | Action |
|-------|-----------------|--------|
| STUCK | Transaction in same state > 30 min | Investigate and retry |
| FAILED | Transaction failed | Check logs, manual intervention |
| LOST | No state update > 1 hour | Alert DevOps |

### 8.2 State Query

```sql
fields @timestamp, transactionId, state, updatedAt
| filter state = "PROCESSING" and @timestamp < ago(30m)
| sort @timestamp asc
| limit 100
```

---

## 9. Dead Letter Queue Monitoring

### 9.1 DLQ Alarms

```yaml
DLQMessageAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: bbws-${env}-dlq-messages
    AlarmDescription: Messages in Dead Letter Queue
    MetricName: ApproximateNumberOfMessagesVisible
    Namespace: AWS/SQS
    Dimensions:
      - Name: QueueName
        Value: bbws-${env}-dlq
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 1
    Threshold: 0
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref CriticalSNSTopic
```

### 9.2 DLQ Processing

```bash
# Check DLQ message count
aws sqs get-queue-attributes \
  --queue-url https://sqs.af-south-1.amazonaws.com/123456789012/bbws-${env}-dlq \
  --attribute-names ApproximateNumberOfMessagesVisible

# Receive and inspect messages
aws sqs receive-message \
  --queue-url https://sqs.af-south-1.amazonaws.com/123456789012/bbws-${env}-dlq \
  --max-number-of-messages 10
```

---

## 10. SNS Notification Configuration

### 10.1 SNS Topics

| Topic | Purpose | Subscribers |
|-------|---------|-------------|
| bbws-${env}-critical | Critical alerts | DevOps Team, On-Call |
| bbws-${env}-warning | Warning alerts | DevOps Team |
| bbws-${env}-info | Informational | Slack Channel |

### 10.2 Notification Templates

```json
{
  "AlarmName": "${alarm_name}",
  "AlarmDescription": "${alarm_description}",
  "AWSAccountId": "${account_id}",
  "NewStateValue": "${state}",
  "NewStateReason": "${reason}",
  "StateChangeTime": "${timestamp}",
  "Region": "af-south-1",
  "Environment": "${environment}"
}
```

---

## 11. Contacts

| Role | Name | Contact |
|------|------|---------|
| DevOps Lead | TBD | TBD |
| On-Call Primary | TBD | TBD |
| On-Call Secondary | TBD | TBD |

---

## 12. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| DevOps Lead | | | |
| Tech Lead | | | |

---

**End of Document**
