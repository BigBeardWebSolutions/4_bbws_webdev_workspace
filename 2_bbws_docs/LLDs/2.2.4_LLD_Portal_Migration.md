# Portal Migration Service - Low-Level Design

**Version**: 1.0
**Created**: 2026-01-20
**Status**: Draft
**Component**: Portal Migration Service (`2_2_bbws_portal_svc_migration`)
**Parent HLD**: [HLD 2.2 BBWS Customer Portal Private](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md)
**Parent BRS**: [BRS 2.2 Customer Portal Private](../BRS/2.2_BRS_Customer_Portal_Private.md) - Epic 7 (Site Management)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-20 | LLD Architect Agent | Initial version covering Epic 7 Migration functionality (US 7.8-7.10) |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [High Level Epic Overview](#2-high-level-epic-overview)
3. [Architecture Diagram](#3-architecture-diagram)
4. [API Design](#4-api-design)
5. [Lambda Functions](#5-lambda-functions)
6. [Sequence Diagrams](#6-sequence-diagrams)
7. [Data Models](#7-data-models)
8. [Security](#8-security)
9. [Error Handling](#9-error-handling)
10. [Monitoring and Alerting](#10-monitoring-and-alerting)
11. [NFRs](#11-nfrs)
12. [Troubleshooting Playbook](#12-troubleshooting-playbook)
13. [Tagging](#13-tagging)
14. [Risks and Mitigations](#14-risks-and-mitigations)
15. [TBC](#15-tbc)
16. [Definition of Terms](#16-definition-of-terms)
17. [Appendices](#17-appendices)
18. [References](#18-references)
19. [Signoff](#19-signoff)

---

## 1. Introduction

### 1.1 Purpose

This LLD provides implementation-level details for the Portal Migration Service, which handles WordPress site migrations from external hosting providers to the BBWS platform. The service supports two migration modes:
- **Mode A**: Full-access migration with admin credentials (plugin-based export/import)
- **Mode B**: Scrape-and-rebuild migration for sites without admin access (public content only)

### 1.2 Scope

| In Scope | Out of Scope |
|----------|--------------|
| Migration wizard initiation | Site provisioning (see 2.7_LLD_WordPress_Instance_Management) |
| Mode A: Full-access migration | WordPress plugin development |
| Mode B: Scrape-and-rebuild migration | DNS propagation |
| Migration progress tracking | Billing for migrations (see 2.2.5_LLD_Portal_Billing) |
| Migration logs and history | Post-migration site management (see 2.6_LLD_WordPress_Site_Management) |
| Credential validation | External site modifications |
| Content verification | Third-party integrations restoration |

### 1.3 Component Overview

| Attribute | Value |
|-----------|-------|
| Repository | `2_2_bbws_portal_svc_migration` |
| Runtime | Python 3.12 |
| Memory | 1024MB (migration workers), 256MB (API handlers) |
| Timeout | 30s (API), 900s (workers) |
| Architecture | arm64 |
| API Prefix | `/portal/migrations/*` |
| Authentication | Required (Cognito JWT) |

### 1.4 BRS/HLD References

| Reference | Document | Section |
|-----------|----------|---------|
| Epic 7 | BRS 2.2 | Site Management |
| US 7.8 | BRS 2.2 | Start WordPress Migration |
| US 7.9 | BRS 2.2 | Complete Mode A Migration (Full Access) |
| US 7.10 | BRS 2.2 | Complete Mode B Migration (Scrape & Rebuild) |
| CP-050 | BRS 2.2 | Migrations List screen |
| CP-051 | BRS 2.2 | Start Migration screen |
| CP-052 | BRS 2.2 | Migration Mode A screen |
| CP-053 | BRS 2.2 | Migration Mode B screen |
| CP-054 | BRS 2.2 | Migration Progress screen |
| CP-055 | BRS 2.2 | Migration Complete screen |

### 1.5 Dependencies

| Dependency | Purpose |
|------------|---------|
| AWS DynamoDB | Migration records, progress tracking |
| AWS SQS | Async migration job queue |
| AWS S3 | Migration artifacts (exports, media) |
| AWS Step Functions | Migration workflow orchestration |
| AWS SES | Migration notifications |
| AWS Secrets Manager | Source site credentials |
| Portal Site Service | Target site provisioning |
| Portal Instance Management | WordPress infrastructure |

---

## 2. High Level Epic Overview

### 2.1 Epic 7: Site Management - Migration (US 7.8-7.10)

| User Story # | User Story | Lambda Function | Test Scenario(s) |
|--------------|------------|-----------------|------------------|
| US 7.8 | Start WordPress Migration | `create_migration`, `get_migration` | Given valid source URL, then migration created |
| US 7.9 | Complete Mode A Migration | `start_mode_a`, `mode_a_worker` | Given valid admin credentials, then full export/import completed |
| US 7.10 | Complete Mode B Migration | `start_mode_b`, `mode_b_worker` | Given public URL, then content scraped and rebuilt |
| - | List Migrations | `list_migrations` | Given tenant ID, then migrations for tenant returned |
| - | Get Migration Logs | `get_migration_logs` | Given migration ID, then logs returned |
| - | Cancel Migration | `cancel_migration` | Given in-progress migration, then migration cancelled |

### 2.2 Migration Modes Comparison

| Aspect | Mode A (Full Access) | Mode B (Scrape & Rebuild) |
|--------|---------------------|---------------------------|
| Requirements | WordPress admin credentials | Public URL access |
| Data Transferred | Complete (DB + files) | Public content only |
| Plugins/Themes | Preserved | AI theme matching |
| User Accounts | Migrated | Not migrated |
| Draft Content | Included | Not included |
| Media Files | All files | Public media only |
| Estimated Time | 30 min - 4 hours | 1 - 8 hours |
| Success Rate | 95%+ | 85%+ |

### 2.3 Business Rules Coverage

| Rule ID | Rule | Implementation |
|---------|------|----------------|
| BR-027 | Migrations require active subscription | Check subscription status before start |
| BR-028 | Source site must be accessible | URL validation and connectivity check |
| BR-029 | Mode A requires valid WordPress admin | Credential validation before migration |
| BR-030 | Large migrations (>10GB) require estimated time disclosure | Show estimate on CP-054 |
| - | Source site preserved | Never modify source site |
| - | Migration can be cancelled | Support cancellation before 50% progress |

---

## 3. Architecture Diagram

### 3.1 Component Architecture

```
                               PORTAL MIGRATION SERVICE ARCHITECTURE
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  +---------+          +----------------+          +------------------+                           |
|  | React   |  HTTPS   |   API Gateway  |          |  Lambda          |                          |
|  | SPA     |--------->|   (REST)       |--------->|  Authorizer      |                          |
|  | (S3/CF) |          |                |          |  (JWT Validate)  |                          |
|  +---------+          +-------+--------+          +--------+---------+                          |
|                               |                            |                                     |
|                               | (Authenticated)            | (IAM Policy)                        |
|                               v                            v                                     |
|                       +-------+--------------------------------+                                 |
|                       |          MIGRATION API LAMBDAS         |                                 |
|                       |  +---------------+ +---------------+   |                                 |
|                       |  |list_migrations| |create_migration|  |                                 |
|                       |  +---------------+ +---------------+   |                                 |
|                       |  +---------------+ +---------------+   |                                 |
|                       |  | get_migration | |cancel_migration|  |                                 |
|                       |  +---------------+ +---------------+   |                                 |
|                       |  +---------------+                     |                                 |
|                       |  |get_mig_logs   |                     |                                 |
|                       |  +---------------+                     |                                 |
|                       +----------+-------------------------+---+                                 |
|                                  |                         |                                     |
|                                  v                         v                                     |
|                       +------------------+      +----------------------+                         |
|                       |    DynamoDB      |      |        SQS           |                        |
|                       |  (Single Table)  |      |  (Migration Queue)   |                        |
|                       |                  |      |                      |                        |
|                       | - MIGRATION      |      | - Mode A jobs        |                        |
|                       | - MIGRATION_LOG  |      | - Mode B jobs        |                        |
|                       +--------+---------+      +-----------+----------+                        |
|                                |                            |                                    |
|                                v                            v                                    |
|                       +---------------------------------------------------+                      |
|                       |              STEP FUNCTIONS WORKFLOW              |                      |
|                       |                                                   |                      |
|                       |  +-------------+     +-------------+              |                      |
|                       |  | Validate    |---->| Provision   |              |                      |
|                       |  | Source      |     | Target Site |              |                      |
|                       |  +-------------+     +------+------+              |                      |
|                       |                             |                     |                      |
|                       |                +------------+------------+        |                      |
|                       |                |                         |        |                      |
|                       |                v                         v        |                      |
|                       |        +---------------+        +---------------+ |                      |
|                       |        | MODE A WORKER |        | MODE B WORKER | |                      |
|                       |        | - Install plugin|      | - Scrape HTML | |                      |
|                       |        | - Export DB    |       | - Download media|                     |
|                       |        | - Export files |       | - AI theme match|                     |
|                       |        | - Import to tgt|       | - Rebuild WP   | |                     |
|                       |        +-------+-------+        +-------+-------+ |                      |
|                       |                |                        |         |                      |
|                       |                +------------+-----------+         |                      |
|                       |                             |                     |                      |
|                       |                             v                     |                      |
|                       |                     +---------------+             |                      |
|                       |                     |   Verify &    |             |                      |
|                       |                     |   Finalize    |             |                      |
|                       |                     +---------------+             |                      |
|                       +---------------------------------------------------+                      |
|                                                     |                                            |
|                       +-----------------------------+-----------------------------+              |
|                       |                             |                             |              |
|                       v                             v                             v              |
|            +------------------+          +------------------+          +------------------+       |
|            |       S3         |          |       SES        |          | Secrets Manager  |      |
|            | (Migration Data) |          | (Notifications)  |          | (Credentials)    |      |
|            |                  |          |                  |          |                  |      |
|            | - Exports        |          | - Started email  |          | - WP admin creds |      |
|            | - Media files    |          | - Progress email |          | - FTP/SFTP creds |      |
|            | - Logs           |          | - Complete email |          | - API keys       |      |
|            +------------------+          +------------------+          +------------------+       |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+

LEGEND:
+------+  Component/Service
------->  Data Flow
   |      Dependency
```

### 3.2 Step Functions State Machine

```
                           MIGRATION WORKFLOW STATE MACHINE
+-------------------------------------------------------------------------------------------+
|                                                                                           |
|  START                                                                                    |
|    |                                                                                      |
|    v                                                                                      |
|  +------------------+                                                                     |
|  | ValidateSource   |-----> [Source Invalid] -----> FAILED (reason: invalid_source)      |
|  +--------+---------+                                                                     |
|           | [Valid]                                                                       |
|           v                                                                               |
|  +------------------+                                                                     |
|  | CreateTargetSite |-----> [Provision Failed] --> FAILED (reason: provision_failed)     |
|  +--------+---------+                                                                     |
|           |                                                                               |
|           v                                                                               |
|  +------------------+                                                                     |
|  | DetermineMode    |                                                                     |
|  +--------+---------+                                                                     |
|           |                                                                               |
|     +-----+-----+                                                                         |
|     |           |                                                                         |
|     v           v                                                                         |
|  [Mode A]    [Mode B]                                                                     |
|     |           |                                                                         |
|     v           v                                                                         |
|  +----------+  +----------+                                                               |
|  | ModeA    |  | ModeB    |                                                               |
|  | Workflow |  | Workflow |                                                               |
|  +----+-----+  +----+-----+                                                               |
|       |             |                                                                     |
|       |  +----------+                                                                     |
|       |  |                                                                                |
|       v  v                                                                                |
|  +------------------+                                                                     |
|  | VerifyMigration  |-----> [Verification Failed] --> FAILED (reason: verify_failed)     |
|  +--------+---------+                                                                     |
|           | [Verified]                                                                    |
|           v                                                                               |
|  +------------------+                                                                     |
|  | SendNotification |                                                                     |
|  +--------+---------+                                                                     |
|           |                                                                               |
|           v                                                                               |
|        SUCCESS                                                                            |
|                                                                                           |
+-------------------------------------------------------------------------------------------+

MODE A WORKFLOW (Nested):
  InstallPlugin --> ExportDatabase --> ExportFiles --> ImportDatabase --> ImportFiles --> CleanUp

MODE B WORKFLOW (Nested):
  ScrapePages --> DownloadMedia --> MatchTheme --> BuildWordPress --> ImportContent --> CleanUp
```

### 3.3 Class Diagram

```
+--------------------------------------------------------------------------------------------------+
|                                      CLASS STRUCTURE                                              |
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  +-------------------------+              +-------------------------+                            |
|  |   MigrationController   |              |   MigrationService      |                            |
|  +-------------------------+              +-------------------------+                            |
|  | + list_migrations()     |------------->| + create(dto)           |                            |
|  | + create_migration()    |              | + get_by_id(id)         |                            |
|  | + get_migration()       |              | + list_for_tenant(t_id) |                            |
|  | + cancel_migration()    |              | + cancel(id)            |                            |
|  | + get_logs()            |              | + get_logs(id)          |                            |
|  +-------------------------+              +------------+------------+                            |
|                                                        |                                         |
|                                           +------------+------------+                            |
|                                           |                         |                            |
|                                           v                         v                            |
|                            +-------------------------+  +-------------------------+              |
|                            |  MigrationRepository    |  |  MigrationValidator     |              |
|                            +-------------------------+  +-------------------------+              |
|                            | + save(migration)       |  | + validate_url(url)     |              |
|                            | + find_by_id(id)        |  | + validate_credentials()|              |
|                            | + find_by_tenant(t_id)  |  | + check_source_access() |              |
|                            | + update_status(id,st)  |  | + estimate_size()       |              |
|                            | + add_log(id, log)      |  +-------------------------+              |
|                            +-------------------------+                                           |
|                                                                                                  |
|  +-------------------------+              +-------------------------+                            |
|  |   ModeAWorker           |              |   ModeBWorker           |                            |
|  +-------------------------+              +-------------------------+                            |
|  | - source_credentials    |              | - source_url            |                            |
|  | - target_site           |              | - target_site           |                            |
|  +-------------------------+              +-------------------------+                            |
|  | + install_plugin()      |              | + scrape_pages()        |                            |
|  | + export_database()     |              | + download_media()      |                            |
|  | + export_files()        |              | + match_theme()         |                            |
|  | + import_database()     |              | + build_wordpress()     |                            |
|  | + import_files()        |              | + import_content()      |                            |
|  | + verify_migration()    |              | + verify_migration()    |                            |
|  +-------------------------+              +-------------------------+                            |
|             |                                          |                                         |
|             +-------------------+----------------------+                                         |
|                                 |                                                                |
|                                 v                                                                |
|                  +-------------------------+                                                     |
|                  |   MigrationWorkerBase   |                                                     |
|                  +-------------------------+                                                     |
|                  | # migration_id          |                                                     |
|                  | # progress_callback     |                                                     |
|                  +-------------------------+                                                     |
|                  | # update_progress()     |                                                     |
|                  | # log_step()            |                                                     |
|                  | # handle_error()        |                                                     |
|                  +-------------------------+                                                     |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+

DATA CLASSES:

+-------------------------+     +-------------------------+     +-------------------------+
|   Migration (Entity)    |     |   MigrationLog          |     |   MigrationCredentials  |
+-------------------------+     +-------------------------+     +-------------------------+
| + id: str               |     | + migration_id: str     |     | + admin_url: str        |
| + tenant_id: str        |     | + timestamp: datetime   |     | + username: str         |
| + source_url: str       |     | + level: str            |     | + password: str (enc)   |
| + target_site_id: str   |     | + step: str             |     | + ftp_host: str         |
| + mode: MigrationMode   |     | + message: str          |     | + ftp_user: str         |
| + status: MigrationStatus|    | + details: dict         |     | + ftp_pass: str (enc)   |
| + progress_percent: int |     +-------------------------+     +-------------------------+
| + estimated_time: int   |
| + started_at: datetime  |
| + completed_at: datetime|
| + error_message: str    |
+-------------------------+

ENUMS:

+-------------------------+     +-------------------------+
|   MigrationMode         |     |   MigrationStatus       |
+-------------------------+     +-------------------------+
| MODE_A = "full_access"  |     | PENDING = "pending"     |
| MODE_B = "scrape_rebuild"|    | VALIDATING = "validating"|
+-------------------------+     | PROVISIONING = "prov"   |
                                | IN_PROGRESS = "progress"|
                                | VERIFYING = "verifying" |
                                | COMPLETED = "completed" |
                                | FAILED = "failed"       |
                                | CANCELLED = "cancelled" |
                                +-------------------------+
```

---

## 4. API Design

### 4.1 OpenAPI Specification

```yaml
openapi: 3.0.3
info:
  title: Portal Migration Service API
  description: WordPress migration service for BBWS Customer Portal
  version: 1.0.0
  contact:
    name: BBWS Platform Team
    email: platform@kimmyai.io

servers:
  - url: https://portal-api.kimmyai.io/v1.0
    description: Production
  - url: https://dev.portal-api.kimmyai.io/v1.0
    description: Development

security:
  - bearerAuth: []

paths:
  /portal/tenants/{tenantId}/migrations:
    get:
      summary: List migrations for tenant
      operationId: listMigrations
      tags: [Migrations]
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/PageToken'
        - $ref: '#/components/parameters/PageSize'
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, in_progress, completed, failed, cancelled]
      responses:
        '200':
          description: Migration list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      summary: Create new migration
      operationId: createMigration
      tags: [Migrations]
      parameters:
        - $ref: '#/components/parameters/TenantId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMigrationRequest'
      responses:
        '201':
          description: Migration created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          description: Source validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /portal/tenants/{tenantId}/migrations/{migrationId}:
    get:
      summary: Get migration details
      operationId: getMigration
      tags: [Migrations]
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/MigrationId'
      responses:
        '200':
          description: Migration details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /portal/tenants/{tenantId}/migrations/{migrationId}/cancel:
    post:
      summary: Cancel migration
      operationId: cancelMigration
      tags: [Migrations]
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/MigrationId'
      responses:
        '200':
          description: Migration cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationResponse'
        '400':
          description: Migration cannot be cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /portal/tenants/{tenantId}/migrations/{migrationId}/logs:
    get:
      summary: Get migration logs
      operationId: getMigrationLogs
      tags: [Migrations]
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/MigrationId'
        - name: level
          in: query
          schema:
            type: string
            enum: [info, warning, error]
        - $ref: '#/components/parameters/PageToken'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: Migration logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationLogsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /portal/tenants/{tenantId}/migrations/{migrationId}/start:
    post:
      summary: Start migration execution
      operationId: startMigration
      tags: [Migrations]
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/MigrationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/StartModeARequest'
                - $ref: '#/components/schemas/StartModeBRequest'
              discriminator:
                propertyName: mode
      responses:
        '202':
          description: Migration started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    TenantId:
      name: tenantId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    MigrationId:
      name: migrationId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    PageToken:
      name: pageToken
      in: query
      schema:
        type: string

    PageSize:
      name: pageSize
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    CreateMigrationRequest:
      type: object
      required:
        - sourceUrl
        - mode
      properties:
        sourceUrl:
          type: string
          format: uri
          description: URL of source WordPress site
          example: "https://example.com"
        mode:
          type: string
          enum: [full_access, scrape_rebuild]
        targetSiteName:
          type: string
          minLength: 3
          maxLength: 100
          description: Name for the new site

    StartModeARequest:
      type: object
      required:
        - mode
        - adminUrl
        - username
        - password
      properties:
        mode:
          type: string
          enum: [full_access]
        adminUrl:
          type: string
          format: uri
          example: "https://example.com/wp-admin"
        username:
          type: string
        password:
          type: string
          format: password
        ftpHost:
          type: string
        ftpUsername:
          type: string
        ftpPassword:
          type: string
          format: password

    StartModeBRequest:
      type: object
      required:
        - mode
        - contentScope
      properties:
        mode:
          type: string
          enum: [scrape_rebuild]
        contentScope:
          type: object
          properties:
            includePages:
              type: boolean
              default: true
            includePosts:
              type: boolean
              default: true
            includeMedia:
              type: boolean
              default: true
            maxDepth:
              type: integer
              minimum: 1
              maximum: 10
              default: 5
        themePreference:
          type: string
          enum: [auto_match, select_theme]
        selectedThemeId:
          type: string
          format: uuid

    MigrationResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Migration'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
        _links:
          $ref: '#/components/schemas/MigrationLinks'

    Migration:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
          format: uuid
        sourceUrl:
          type: string
          format: uri
        targetSiteId:
          type: string
          format: uuid
        targetSiteName:
          type: string
        mode:
          type: string
          enum: [full_access, scrape_rebuild]
        status:
          type: string
          enum: [pending, validating, provisioning, in_progress, verifying, completed, failed, cancelled]
        progressPercent:
          type: integer
          minimum: 0
          maximum: 100
        currentStep:
          type: string
        estimatedTimeMinutes:
          type: integer
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
        errorMessage:
          type: string
        stats:
          $ref: '#/components/schemas/MigrationStats'

    MigrationStats:
      type: object
      properties:
        pagesCount:
          type: integer
        postsCount:
          type: integer
        mediaCount:
          type: integer
        usersCount:
          type: integer
        pluginsCount:
          type: integer
        totalSizeMb:
          type: number

    MigrationListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Migration'
        meta:
          allOf:
            - $ref: '#/components/schemas/ResponseMeta'
            - type: object
              properties:
                totalCount:
                  type: integer
                pageToken:
                  type: string
        _links:
          $ref: '#/components/schemas/ListLinks'

    MigrationLogsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/MigrationLog'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    MigrationLog:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        level:
          type: string
          enum: [info, warning, error]
        step:
          type: string
        message:
          type: string
        details:
          type: object

    MigrationLinks:
      type: object
      properties:
        self:
          $ref: '#/components/schemas/Link'
        logs:
          $ref: '#/components/schemas/Link'
        cancel:
          $ref: '#/components/schemas/Link'
        targetSite:
          $ref: '#/components/schemas/Link'

    ListLinks:
      type: object
      properties:
        self:
          $ref: '#/components/schemas/Link'
        next:
          $ref: '#/components/schemas/Link'
        create:
          $ref: '#/components/schemas/Link'

    Link:
      type: object
      properties:
        href:
          type: string
          format: uri

    ResponseMeta:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        requestId:
          type: string

    ValidationErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: "SOURCE_VALIDATION_FAILED"
            message:
              type: string
            details:
              type: object
              properties:
                sourceAccessible:
                  type: boolean
                isWordPress:
                  type: boolean
                adminAccessible:
                  type: boolean
                estimatedSizeMb:
                  type: number

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
```

### 4.2 HATEOAS Links

```json
{
  "data": {
    "id": "mig_abc123",
    "status": "in_progress",
    "progressPercent": 45
  },
  "_links": {
    "self": { "href": "/portal/tenants/t_123/migrations/mig_abc123" },
    "logs": { "href": "/portal/tenants/t_123/migrations/mig_abc123/logs" },
    "cancel": { "href": "/portal/tenants/t_123/migrations/mig_abc123/cancel" },
    "targetSite": { "href": "/portal/tenants/t_123/sites/site_xyz" },
    "tenant": { "href": "/portal/tenants/t_123" }
  }
}
```

---

## 5. Lambda Functions

### 5.1 Function Inventory

| # | Function Name | Trigger | Memory | Timeout | Description |
|---|---------------|---------|--------|---------|-------------|
| 1 | `list_migrations` | API Gateway | 256MB | 30s | List migrations for tenant |
| 2 | `create_migration` | API Gateway | 256MB | 30s | Create migration record |
| 3 | `get_migration` | API Gateway | 256MB | 30s | Get migration details |
| 4 | `cancel_migration` | API Gateway | 256MB | 30s | Cancel in-progress migration |
| 5 | `get_migration_logs` | API Gateway | 256MB | 30s | Get migration logs |
| 6 | `start_migration` | API Gateway | 512MB | 60s | Start migration workflow |
| 7 | `mode_a_worker` | Step Functions | 1024MB | 900s | Full-access migration worker |
| 8 | `mode_b_worker` | Step Functions | 1024MB | 900s | Scrape-rebuild migration worker |
| 9 | `validate_source` | Step Functions | 512MB | 120s | Validate source WordPress |
| 10 | `verify_migration` | Step Functions | 512MB | 120s | Verify migration success |

### 5.2 Function: create_migration

```python
"""
Create Migration Handler
Creates a new migration record and validates source URL accessibility.
"""

import json
import uuid
from datetime import datetime
from typing import Any

from aws_lambda_powertools import Logger, Tracer
from aws_lambda_powertools.event_handler import APIGatewayRestResolver
from aws_lambda_powertools.event_handler.exceptions import BadRequestError
from pydantic import BaseModel, HttpUrl, validator

from src.services.migration_service import MigrationService
from src.services.source_validator import SourceValidator
from src.models.migration import Migration, MigrationMode, MigrationStatus
from src.utils.response import api_response, hateoas_links

logger = Logger()
tracer = Tracer()
app = APIGatewayRestResolver()

migration_service = MigrationService()
source_validator = SourceValidator()


class CreateMigrationRequest(BaseModel):
    """Request model for creating a migration."""
    source_url: HttpUrl
    mode: MigrationMode
    target_site_name: str | None = None

    @validator('source_url')
    def validate_url(cls, v):
        if not str(v).startswith(('http://', 'https://')):
            raise ValueError('URL must start with http:// or https://')
        return v


@app.post("/portal/tenants/<tenant_id>/migrations")
@tracer.capture_method
def create_migration(tenant_id: str) -> dict[str, Any]:
    """
    Create a new WordPress migration.

    Args:
        tenant_id: Target tenant ID from path

    Returns:
        Created migration with HATEOAS links
    """
    # Parse and validate request
    body = app.current_event.json_body
    request = CreateMigrationRequest(**body)

    # Get user context from authorizer
    user_id = app.current_event.request_context.authorizer.claims.get('sub')

    logger.info("Creating migration", extra={
        "tenant_id": tenant_id,
        "source_url": str(request.source_url),
        "mode": request.mode.value,
        "user_id": user_id
    })

    # Quick validation of source URL accessibility
    validation_result = source_validator.quick_validate(str(request.source_url))

    if not validation_result.accessible:
        raise BadRequestError(f"Source URL not accessible: {validation_result.error}")

    if not validation_result.is_wordpress:
        raise BadRequestError("Source site does not appear to be a WordPress site")

    # Create migration record
    migration = Migration(
        id=str(uuid.uuid4()),
        tenant_id=tenant_id,
        source_url=str(request.source_url),
        mode=request.mode,
        status=MigrationStatus.PENDING,
        target_site_name=request.target_site_name or f"Migrated Site {datetime.now().strftime('%Y%m%d')}",
        created_at=datetime.utcnow(),
        created_by=user_id,
        estimated_size_mb=validation_result.estimated_size_mb
    )

    # Save to DynamoDB
    saved_migration = migration_service.create(migration)

    logger.info("Migration created", extra={
        "migration_id": saved_migration.id,
        "status": saved_migration.status.value
    })

    # Return response with HATEOAS links
    return api_response(
        data=saved_migration.to_dict(),
        status_code=201,
        links=hateoas_links(
            self=f"/portal/tenants/{tenant_id}/migrations/{saved_migration.id}",
            start=f"/portal/tenants/{tenant_id}/migrations/{saved_migration.id}/start",
            logs=f"/portal/tenants/{tenant_id}/migrations/{saved_migration.id}/logs",
            tenant=f"/portal/tenants/{tenant_id}"
        )
    )


@logger.inject_lambda_context
@tracer.capture_lambda_handler
def handler(event: dict, context: Any) -> dict:
    """Lambda entry point."""
    return app.resolve(event, context)
```

### 5.3 Function: mode_a_worker

```python
"""
Mode A Worker - Full Access Migration
Handles WordPress migrations with admin credentials.
"""

import json
from datetime import datetime
from typing import Any

from aws_lambda_powertools import Logger, Tracer
import boto3

from src.services.migration_service import MigrationService
from src.services.wordpress_client import WordPressClient
from src.services.s3_service import S3Service
from src.models.migration import MigrationStatus

logger = Logger()
tracer = Tracer()

migration_service = MigrationService()
s3_service = S3Service()
secrets_manager = boto3.client('secretsmanager')


class ModeAWorker:
    """
    Full-access migration worker.

    Steps:
    1. Connect to source WordPress admin
    2. Install migration plugin
    3. Export database
    4. Export files
    5. Import to target site
    6. Verify migration
    """

    def __init__(self, migration_id: str, credentials: dict):
        self.migration_id = migration_id
        self.credentials = credentials
        self.migration = migration_service.get_by_id(migration_id)
        self.wp_client = None

    @tracer.capture_method
    def execute(self) -> dict:
        """Execute full migration workflow."""
        try:
            self._update_progress(5, "connecting", "Connecting to source WordPress...")
            self._connect_to_source()

            self._update_progress(15, "installing_plugin", "Installing migration plugin...")
            self._install_migration_plugin()

            self._update_progress(25, "exporting_database", "Exporting database...")
            db_export_path = self._export_database()

            self._update_progress(45, "exporting_files", "Exporting media files...")
            files_export_path = self._export_files()

            self._update_progress(65, "importing_database", "Importing database to target...")
            self._import_database(db_export_path)

            self._update_progress(80, "importing_files", "Importing files to target...")
            self._import_files(files_export_path)

            self._update_progress(90, "cleanup", "Cleaning up temporary files...")
            self._cleanup()

            self._update_progress(95, "verifying", "Verifying migration...")
            stats = self._get_migration_stats()

            self._update_progress(100, "completed", "Migration completed successfully")

            return {
                "status": "success",
                "migration_id": self.migration_id,
                "stats": stats
            }

        except Exception as e:
            logger.exception("Migration failed", extra={"migration_id": self.migration_id})
            self._update_status(MigrationStatus.FAILED, str(e))
            return {
                "status": "failed",
                "migration_id": self.migration_id,
                "error": str(e)
            }

    def _connect_to_source(self):
        """Connect to source WordPress using credentials."""
        self.wp_client = WordPressClient(
            admin_url=self.credentials['admin_url'],
            username=self.credentials['username'],
            password=self.credentials['password']
        )

        if not self.wp_client.test_connection():
            raise Exception("Failed to connect to source WordPress admin")

        self._log("info", "connecting", "Successfully connected to source WordPress")

    def _install_migration_plugin(self):
        """Install BBWS migration plugin on source site."""
        plugin_result = self.wp_client.install_plugin("bbws-migrator")

        if not plugin_result.success:
            raise Exception(f"Failed to install migration plugin: {plugin_result.error}")

        self._log("info", "installing_plugin", "Migration plugin installed and activated")

    def _export_database(self) -> str:
        """Export WordPress database from source."""
        export_result = self.wp_client.export_database()

        # Upload to S3
        s3_key = f"migrations/{self.migration_id}/database.sql.gz"
        s3_service.upload_file(export_result.file_path, s3_key)

        self._log("info", "exporting_database",
                  f"Database exported: {export_result.size_mb:.2f}MB")

        return s3_key

    def _export_files(self) -> str:
        """Export WordPress files from source."""
        # Use FTP/SFTP if credentials provided, otherwise use plugin
        if 'ftp_host' in self.credentials:
            export_result = self._export_via_ftp()
        else:
            export_result = self.wp_client.export_files()

        # Upload to S3
        s3_key = f"migrations/{self.migration_id}/files.tar.gz"
        s3_service.upload_file(export_result.file_path, s3_key)

        self._log("info", "exporting_files",
                  f"Files exported: {export_result.size_mb:.2f}MB, {export_result.file_count} files")

        return s3_key

    def _import_database(self, s3_key: str):
        """Import database to target WordPress site."""
        # Get target site connection from Instance Management service
        target_site = self._get_target_site()

        # Download and import
        local_path = s3_service.download_file(s3_key)
        target_site.import_database(local_path)

        self._log("info", "importing_database", "Database imported to target site")

    def _import_files(self, s3_key: str):
        """Import files to target WordPress site."""
        target_site = self._get_target_site()

        local_path = s3_service.download_file(s3_key)
        target_site.import_files(local_path)

        self._log("info", "importing_files", "Files imported to target site")

    def _cleanup(self):
        """Clean up temporary files and remove plugin from source."""
        try:
            self.wp_client.uninstall_plugin("bbws-migrator")
            s3_service.delete_migration_artifacts(self.migration_id)
        except Exception as e:
            self._log("warning", "cleanup", f"Cleanup warning: {e}")

    def _get_migration_stats(self) -> dict:
        """Get statistics about migrated content."""
        target_site = self._get_target_site()

        return {
            "pages_count": target_site.count_pages(),
            "posts_count": target_site.count_posts(),
            "media_count": target_site.count_media(),
            "users_count": target_site.count_users(),
            "plugins_count": target_site.count_plugins(),
            "total_size_mb": target_site.get_total_size_mb()
        }

    def _get_target_site(self):
        """Get target site client."""
        # Implementation would call Instance Management service
        pass

    def _update_progress(self, percent: int, step: str, message: str):
        """Update migration progress."""
        migration_service.update_progress(
            self.migration_id,
            progress_percent=percent,
            current_step=step
        )
        self._log("info", step, message)

    def _update_status(self, status: MigrationStatus, error_message: str = None):
        """Update migration status."""
        migration_service.update_status(
            self.migration_id,
            status=status,
            error_message=error_message
        )

    def _log(self, level: str, step: str, message: str, details: dict = None):
        """Add log entry for migration."""
        migration_service.add_log(
            self.migration_id,
            level=level,
            step=step,
            message=message,
            details=details or {}
        )


@logger.inject_lambda_context
@tracer.capture_lambda_handler
def handler(event: dict, context: Any) -> dict:
    """Lambda entry point for Step Functions."""
    migration_id = event['migration_id']
    credentials_secret_id = event['credentials_secret_id']

    # Retrieve credentials from Secrets Manager
    secret_response = secrets_manager.get_secret_value(SecretId=credentials_secret_id)
    credentials = json.loads(secret_response['SecretString'])

    worker = ModeAWorker(migration_id, credentials)
    return worker.execute()
```

### 5.4 Function: mode_b_worker

```python
"""
Mode B Worker - Scrape and Rebuild Migration
Handles WordPress migrations from public content only.
"""

import json
from datetime import datetime
from typing import Any, List

from aws_lambda_powertools import Logger, Tracer
import boto3

from src.services.migration_service import MigrationService
from src.services.web_scraper import WebScraper
from src.services.theme_matcher import ThemeMatcher
from src.services.wordpress_builder import WordPressBuilder
from src.services.s3_service import S3Service
from src.models.migration import MigrationStatus

logger = Logger()
tracer = Tracer()

migration_service = MigrationService()
s3_service = S3Service()


class ModeBWorker:
    """
    Scrape-and-rebuild migration worker.

    Steps:
    1. Scrape public pages and posts
    2. Download public media
    3. AI theme matching
    4. Build new WordPress
    5. Import scraped content
    6. Verify migration
    """

    def __init__(self, migration_id: str, content_scope: dict, theme_preference: str):
        self.migration_id = migration_id
        self.content_scope = content_scope
        self.theme_preference = theme_preference
        self.migration = migration_service.get_by_id(migration_id)
        self.scraper = WebScraper(self.migration.source_url)
        self.theme_matcher = ThemeMatcher()

    @tracer.capture_method
    def execute(self) -> dict:
        """Execute scrape-rebuild migration workflow."""
        try:
            self._update_progress(5, "analyzing", "Analyzing source site structure...")
            site_structure = self._analyze_site()

            self._update_progress(15, "scraping_pages", "Scraping pages...")
            pages = self._scrape_pages(site_structure)

            self._update_progress(35, "scraping_posts", "Scraping blog posts...")
            posts = self._scrape_posts(site_structure)

            self._update_progress(50, "downloading_media", "Downloading media files...")
            media = self._download_media(pages + posts)

            self._update_progress(65, "matching_theme", "Matching theme with AI...")
            theme_id = self._match_theme()

            self._update_progress(75, "building_wordpress", "Building new WordPress site...")
            self._build_wordpress(theme_id)

            self._update_progress(85, "importing_content", "Importing content...")
            self._import_content(pages, posts, media)

            self._update_progress(95, "verifying", "Verifying migration...")
            stats = self._get_migration_stats(pages, posts, media)

            self._update_progress(100, "completed", "Migration completed successfully")

            return {
                "status": "success",
                "migration_id": self.migration_id,
                "stats": stats
            }

        except Exception as e:
            logger.exception("Migration failed", extra={"migration_id": self.migration_id})
            self._update_status(MigrationStatus.FAILED, str(e))
            return {
                "status": "failed",
                "migration_id": self.migration_id,
                "error": str(e)
            }

    def _analyze_site(self) -> dict:
        """Analyze source site structure."""
        structure = self.scraper.analyze_structure(
            max_depth=self.content_scope.get('max_depth', 5)
        )

        self._log("info", "analyzing",
                  f"Found {len(structure['pages'])} pages, {len(structure['posts'])} posts")

        return structure

    def _scrape_pages(self, structure: dict) -> List[dict]:
        """Scrape all pages from source site."""
        if not self.content_scope.get('include_pages', True):
            return []

        pages = []
        for url in structure['pages']:
            try:
                page_content = self.scraper.scrape_page(url)
                pages.append(page_content)
            except Exception as e:
                self._log("warning", "scraping_pages",
                          f"Could not scrape page {url}: {e}")

        self._log("info", "scraping_pages", f"Scraped {len(pages)} pages")
        return pages

    def _scrape_posts(self, structure: dict) -> List[dict]:
        """Scrape all blog posts from source site."""
        if not self.content_scope.get('include_posts', True):
            return []

        posts = []
        for url in structure['posts']:
            try:
                post_content = self.scraper.scrape_post(url)
                posts.append(post_content)
            except Exception as e:
                self._log("warning", "scraping_posts",
                          f"Could not scrape post {url}: {e}")

        self._log("info", "scraping_posts", f"Scraped {len(posts)} posts")
        return posts

    def _download_media(self, content_items: List[dict]) -> List[dict]:
        """Download all media files referenced in content."""
        if not self.content_scope.get('include_media', True):
            return []

        # Extract unique media URLs from content
        media_urls = set()
        for item in content_items:
            media_urls.update(item.get('media_urls', []))

        media = []
        for url in media_urls:
            try:
                media_item = self.scraper.download_media(url)
                # Upload to S3
                s3_key = f"migrations/{self.migration_id}/media/{media_item['filename']}"
                s3_service.upload_file(media_item['local_path'], s3_key)
                media_item['s3_key'] = s3_key
                media.append(media_item)
            except Exception as e:
                self._log("warning", "downloading_media",
                          f"Could not download media {url}: {e}")

        self._log("info", "downloading_media", f"Downloaded {len(media)} media files")
        return media

    def _match_theme(self) -> str:
        """Use AI to match closest theme to source site."""
        if self.theme_preference == 'select_theme':
            return self.content_scope.get('selected_theme_id')

        # Take screenshot of source site
        screenshot = self.scraper.take_screenshot()

        # AI theme matching using Bedrock
        matched_theme = self.theme_matcher.match_theme(
            screenshot=screenshot,
            source_url=self.migration.source_url
        )

        self._log("info", "matching_theme",
                  f"Matched theme: {matched_theme['name']} (confidence: {matched_theme['confidence']}%)")

        return matched_theme['id']

    def _build_wordpress(self, theme_id: str):
        """Build new WordPress site with matched theme."""
        builder = WordPressBuilder(
            site_id=self.migration.target_site_id,
            theme_id=theme_id
        )

        builder.setup_wordpress()
        self._log("info", "building_wordpress", "WordPress site built with selected theme")

    def _import_content(self, pages: List[dict], posts: List[dict], media: List[dict]):
        """Import scraped content to target WordPress."""
        builder = WordPressBuilder(site_id=self.migration.target_site_id)

        # Import media first (needed for content references)
        media_mapping = {}
        for item in media:
            new_url = builder.import_media(item)
            media_mapping[item['original_url']] = new_url

        # Import pages
        for page in pages:
            builder.import_page(page, media_mapping)

        # Import posts
        for post in posts:
            builder.import_post(post, media_mapping)

        self._log("info", "importing_content",
                  f"Imported {len(pages)} pages, {len(posts)} posts, {len(media)} media files")

    def _get_migration_stats(self, pages: List[dict], posts: List[dict],
                             media: List[dict]) -> dict:
        """Get statistics about migrated content."""
        total_size = sum(m.get('size_bytes', 0) for m in media) / (1024 * 1024)

        return {
            "pages_count": len(pages),
            "posts_count": len(posts),
            "media_count": len(media),
            "users_count": 0,  # Not migrated in Mode B
            "plugins_count": 0,  # Not migrated in Mode B
            "total_size_mb": round(total_size, 2)
        }

    def _update_progress(self, percent: int, step: str, message: str):
        """Update migration progress."""
        migration_service.update_progress(
            self.migration_id,
            progress_percent=percent,
            current_step=step
        )
        self._log("info", step, message)

    def _update_status(self, status: MigrationStatus, error_message: str = None):
        """Update migration status."""
        migration_service.update_status(
            self.migration_id,
            status=status,
            error_message=error_message
        )

    def _log(self, level: str, step: str, message: str, details: dict = None):
        """Add log entry for migration."""
        migration_service.add_log(
            self.migration_id,
            level=level,
            step=step,
            message=message,
            details=details or {}
        )


@logger.inject_lambda_context
@tracer.capture_lambda_handler
def handler(event: dict, context: Any) -> dict:
    """Lambda entry point for Step Functions."""
    migration_id = event['migration_id']
    content_scope = event.get('content_scope', {})
    theme_preference = event.get('theme_preference', 'auto_match')

    worker = ModeBWorker(migration_id, content_scope, theme_preference)
    return worker.execute()
```

---

## 6. Sequence Diagrams

### 6.1 Start Migration (Mode A)

```
                           MODE A MIGRATION SEQUENCE
+--------+    +----------+    +---------+    +--------+    +-------+    +-------+
| React  |    | API GW   |    | Lambda  |    | DynamoDB|    | SQS   |    | Step  |
| SPA    |    |          |    |         |    |         |    |       |    | Func  |
+---+----+    +----+-----+    +----+----+    +----+----+    +---+---+    +---+---+
    |              |               |              |             |            |
    | POST /migrations             |              |             |            |
    |------------->|               |              |             |            |
    |              | Invoke        |              |             |            |
    |              |-------------->|              |             |            |
    |              |               |              |             |            |
    |              |               | Validate URL |             |            |
    |              |               |------------->|             |            |
    |              |               |<-------------|             |            |
    |              |               |              |             |            |
    |              |               | Save Migration             |            |
    |              |               |------------->|             |            |
    |              |               |<-------------|             |            |
    |              |               |              |             |            |
    |              | 201 Created   |              |             |            |
    |<-------------|<--------------|              |             |            |
    |              |               |              |             |            |
    | POST /migrations/{id}/start  |              |             |            |
    |------------->|               |              |             |            |
    |              | Invoke        |              |             |            |
    |              |-------------->|              |             |            |
    |              |               |              |             |            |
    |              |               | Store creds in Secrets Mgr |            |
    |              |               |----------------------------->           |
    |              |               |<-----------------------------           |
    |              |               |              |             |            |
    |              |               | Update status=VALIDATING   |            |
    |              |               |------------->|             |            |
    |              |               |              |             |            |
    |              |               | Start Step Function        |            |
    |              |               |---------------------------------------->|
    |              |               |              |             |            |
    |              | 202 Accepted  |              |             |            |
    |<-------------|<--------------|              |             |            |
    |              |               |              |             |            |
    |              |               |              |             | Execute    |
    |              |               |              |             | Workflow   |
    |              |               |              |             |<-----------|
    |              |               |              |             |            |
    | WebSocket: progress updates  |              |             |            |
    |<--------------------------------------------------------------|        |
    |              |               |              |             |            |
```

### 6.2 Migration Progress Polling

```
                           MIGRATION PROGRESS POLLING
+--------+    +----------+    +---------+    +---------+
| React  |    | API GW   |    | Lambda  |    | DynamoDB|
| SPA    |    |          |    |         |    |         |
+---+----+    +----+-----+    +----+----+    +----+----+
    |              |               |              |
    |    [Poll every 5 seconds]   |              |
    |              |               |              |
    | GET /migrations/{id}         |              |
    |------------->|               |              |
    |              | Invoke        |              |
    |              |-------------->|              |
    |              |               |              |
    |              |               | Query Migration
    |              |               |------------->|
    |              |               |<-------------|
    |              |               |              |
    |              | 200 OK        |              |
    |<-------------|<--------------|              |
    |              |  {            |              |
    |              |   status: "in_progress",     |
    |              |   progressPercent: 45,       |
    |              |   currentStep: "exporting"   |
    |              |  }            |              |
    |              |               |              |
    |  [Update progress bar]       |              |
    |              |               |              |
    |  [5 seconds later...]        |              |
    |              |               |              |
    | GET /migrations/{id}         |              |
    |------------->|               |              |
    |              |-------------->|              |
    |              |               |------------->|
    |              |               |<-------------|
    |              | 200 OK        |              |
    |<-------------|<--------------|              |
    |              |  {            |              |
    |              |   status: "completed",       |
    |              |   progressPercent: 100,      |
    |              |   stats: {...}               |
    |              |  }            |              |
    |              |               |              |
    |  [Navigate to success screen]|              |
    |              |               |              |
```

### 6.3 Mode B Scrape Workflow

```
                           MODE B SCRAPE WORKFLOW
+-------+    +--------+    +--------+    +-------+    +--------+    +-------+
| Step  |    | Lambda |    | Source |    |  S3   |    | Bedrock|    | Target|
| Func  |    | Worker |    | Site   |    |       |    |  (AI)  |    | WP    |
+---+---+    +---+----+    +---+----+    +---+---+    +---+----+    +---+---+
    |            |             |             |            |             |
    | Invoke     |             |             |            |             |
    |----------->|             |             |            |             |
    |            |             |             |            |             |
    |            | GET /       |             |            |             |
    |            |------------>|             |            |             |
    |            |<------------|             |            |             |
    |            |    HTML     |             |            |             |
    |            |             |             |            |             |
    |            | Analyze structure         |            |             |
    |            |-------------------------->|            |             |
    |            |             |             |            |             |
    |            | GET /page1  |             |            |             |
    |            |------------>|             |            |             |
    |            |<------------|             |            |             |
    |            |             |             |            |             |
    |            | GET /page2  |             |            |             |
    |            |------------>|             |            |             |
    |            |<------------|             |            |             |
    |            |             |             |            |             |
    |            | Download media            |            |             |
    |            |------------>|             |            |             |
    |            |<------------|             |            |             |
    |            |             |             |            |             |
    |            | Store media |             |            |             |
    |            |-------------------------->|            |             |
    |            |             |             |            |             |
    |            | Take screenshot           |            |             |
    |            |------------>|             |            |             |
    |            |<------------|             |            |             |
    |            |             |             |            |             |
    |            | Match theme (Claude)      |            |             |
    |            |-------------------------------------->|             |
    |            |<--------------------------------------|             |
    |            |     {theme: "theme_123", confidence: 85}            |
    |            |             |             |            |             |
    |            | Build WP site            |             |             |
    |            |---------------------------------------------------->|
    |            |             |             |            |             |
    |            | Import content           |             |             |
    |            |---------------------------------------------------->|
    |            |             |             |            |             |
    | Complete   |             |             |            |             |
    |<-----------|             |             |            |             |
    |            |             |             |            |             |
```

---

## 7. Data Models

### 7.1 DynamoDB Single Table Design

| Entity | PK | SK | Attributes |
|--------|----|----|------------|
| Migration | `TENANT#{tenant_id}` | `MIGRATION#{migration_id}` | All migration fields |
| MigrationLog | `MIGRATION#{migration_id}` | `LOG#{timestamp}` | level, step, message, details |

### 7.2 Entity Schemas

```python
# Migration Entity
{
    "PK": "TENANT#t_123",
    "SK": "MIGRATION#mig_abc",
    "entity_type": "MIGRATION",
    "id": "mig_abc",
    "tenant_id": "t_123",
    "source_url": "https://example.com",
    "target_site_id": "site_xyz",
    "target_site_name": "Migrated Site 20260120",
    "mode": "full_access",  # or "scrape_rebuild"
    "status": "in_progress",  # pending, validating, provisioning, in_progress, verifying, completed, failed, cancelled
    "progress_percent": 45,
    "current_step": "exporting_database",
    "estimated_time_minutes": 120,
    "started_at": "2026-01-20T10:00:00Z",
    "completed_at": null,
    "error_message": null,
    "stats": {
        "pages_count": 25,
        "posts_count": 100,
        "media_count": 500,
        "users_count": 5,
        "plugins_count": 12,
        "total_size_mb": 2500
    },
    "created_at": "2026-01-20T09:55:00Z",
    "created_by": "user_123",
    "GSI1PK": "MIGRATION#mig_abc",
    "GSI1SK": "METADATA"
}

# MigrationLog Entity
{
    "PK": "MIGRATION#mig_abc",
    "SK": "LOG#2026-01-20T10:05:00.000Z",
    "entity_type": "MIGRATION_LOG",
    "migration_id": "mig_abc",
    "timestamp": "2026-01-20T10:05:00.000Z",
    "level": "info",  # info, warning, error
    "step": "exporting_database",
    "message": "Database export completed: 150MB",
    "details": {
        "tables_count": 45,
        "rows_count": 15000
    }
}
```

### 7.3 GSI Definitions

| GSI Name | PK | SK | Purpose |
|----------|----|----|---------|
| GSI1 | `GSI1PK` | `GSI1SK` | Get migration by ID directly |
| MigrationStatusIndex | `status#tenant_id` | `created_at` | Filter by status within tenant |

### 7.4 Access Patterns

| Access Pattern | Operation | Key Condition |
|----------------|-----------|---------------|
| Get migration by ID | Query GSI1 | GSI1PK = MIGRATION#{id} |
| List migrations for tenant | Query | PK = TENANT#{tenant_id}, SK begins_with MIGRATION# |
| List migrations by status | Query MigrationStatusIndex | status#tenant_id = {status}#{tenant_id} |
| Get migration logs | Query | PK = MIGRATION#{id}, SK begins_with LOG# |
| Get recent logs | Query | PK = MIGRATION#{id}, SK begins_with LOG#, ScanIndexForward = false |

---

## 8. Security

### 8.1 Authentication & Authorization

| Aspect | Implementation |
|--------|----------------|
| API Authentication | Cognito JWT via Lambda Authorizer |
| Tenant Isolation | User can only access migrations in assigned tenants |
| Credential Storage | AWS Secrets Manager (encrypted, temporary) |
| Credential TTL | Deleted after migration completion or 24 hours |

### 8.2 Data Protection

| Data | Protection |
|------|------------|
| Source credentials | Encrypted in Secrets Manager, deleted post-migration |
| Migration exports | S3 with SSE-S3, deleted after 7 days |
| Logs | CloudWatch Logs with KMS encryption |
| DynamoDB | Encryption at rest enabled |

### 8.3 Source Site Security

| Concern | Mitigation |
|---------|------------|
| Credential misuse | Read-only operations, plugin auto-uninstall |
| Source modification | Never write to source (except temporary plugin) |
| Plugin safety | BBWS-signed plugin, security reviewed |
| Rate limiting | Respect robots.txt, max 10 requests/second |

### 8.4 IAM Policies

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DynamoDBAccess",
      "Effect": "Allow",
      "Action": [
        "dynamodb:Query",
        "dynamodb:PutItem",
        "dynamodb:UpdateItem",
        "dynamodb:GetItem"
      ],
      "Resource": [
        "arn:aws:dynamodb:*:*:table/bbws-*",
        "arn:aws:dynamodb:*:*:table/bbws-*/index/*"
      ],
      "Condition": {
        "ForAllValues:StringEquals": {
          "dynamodb:LeadingKeys": ["TENANT#${aws:PrincipalTag/tenant_id}*", "MIGRATION#*"]
        }
      }
    },
    {
      "Sid": "SecretsManagerAccess",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:CreateSecret",
        "secretsmanager:GetSecretValue",
        "secretsmanager:DeleteSecret"
      ],
      "Resource": "arn:aws:secretsmanager:*:*:secret:bbws/migrations/*"
    },
    {
      "Sid": "S3MigrationBucket",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::bbws-migrations-*/*"
    },
    {
      "Sid": "StepFunctionsExecution",
      "Effect": "Allow",
      "Action": "states:StartExecution",
      "Resource": "arn:aws:states:*:*:stateMachine:bbws-migration-*"
    }
  ]
}
```

---

## 9. Error Handling

### 9.1 Error Codes

| Code | HTTP Status | Description | User Message |
|------|-------------|-------------|--------------|
| `SOURCE_UNREACHABLE` | 422 | Source URL not accessible | "Unable to reach the source site. Please verify the URL." |
| `NOT_WORDPRESS` | 422 | Source is not WordPress | "The source site does not appear to be a WordPress site." |
| `INVALID_CREDENTIALS` | 401 | Admin credentials invalid | "Unable to authenticate with the source site. Please check your credentials." |
| `MIGRATION_NOT_FOUND` | 404 | Migration ID not found | "Migration not found." |
| `MIGRATION_IN_PROGRESS` | 409 | Migration already running | "A migration is already in progress for this source." |
| `CANNOT_CANCEL` | 400 | Migration past cancellation point | "This migration cannot be cancelled at this stage." |
| `EXPORT_FAILED` | 500 | Database/file export failed | "Failed to export data from source. Please try again." |
| `IMPORT_FAILED` | 500 | Import to target failed | "Failed to import data to target site. Please contact support." |
| `QUOTA_EXCEEDED` | 403 | Migration quota exceeded | "You have reached your migration limit. Please upgrade your plan." |

### 9.2 Retry Strategy

| Operation | Max Retries | Backoff | Idempotent |
|-----------|-------------|---------|------------|
| Source validation | 3 | Exponential (1s, 2s, 4s) | Yes |
| Database export | 2 | Linear (30s) | Yes |
| File export | 2 | Linear (60s) | Yes |
| Import operations | 2 | Linear (30s) | No (use checkpoints) |
| S3 uploads | 5 | Exponential | Yes |

### 9.3 Dead Letter Queue

```yaml
Resources:
  MigrationDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: bbws-migration-dlq-${env}
      MessageRetentionPeriod: 1209600  # 14 days

  MigrationQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: bbws-migration-queue-${env}
      VisibilityTimeout: 900  # 15 minutes
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt MigrationDLQ.Arn
        maxReceiveCount: 3
```

---

## 10. Monitoring and Alerting

### 10.1 CloudWatch Metrics

| Metric | Namespace | Dimensions | Threshold | Alarm |
|--------|-----------|------------|-----------|-------|
| `MigrationsStarted` | BBWS/Migration | Environment | - | - |
| `MigrationsCompleted` | BBWS/Migration | Environment, Mode | - | - |
| `MigrationsFailed` | BBWS/Migration | Environment, Mode | >5/hour | Alert |
| `MigrationDuration` | BBWS/Migration | Environment, Mode | p95 >4hrs | Warning |
| `SourceValidationErrors` | BBWS/Migration | Environment | >20/hour | Warning |
| `DLQMessageCount` | BBWS/Migration | Environment | >0 | Alert |

### 10.2 Dashboard Widgets

```json
{
  "widgets": [
    {
      "type": "metric",
      "title": "Migrations by Status",
      "properties": {
        "metrics": [
          ["BBWS/Migration", "MigrationsStarted"],
          ["BBWS/Migration", "MigrationsCompleted"],
          ["BBWS/Migration", "MigrationsFailed"]
        ],
        "period": 3600
      }
    },
    {
      "type": "metric",
      "title": "Migration Duration (p95)",
      "properties": {
        "metrics": [
          ["BBWS/Migration", "MigrationDuration", "Mode", "full_access", {"stat": "p95"}],
          ["BBWS/Migration", "MigrationDuration", "Mode", "scrape_rebuild", {"stat": "p95"}]
        ]
      }
    },
    {
      "type": "metric",
      "title": "Success Rate",
      "properties": {
        "metrics": [
          [{"expression": "m2/m1*100", "label": "Success %"}],
          ["BBWS/Migration", "MigrationsCompleted", {"id": "m2", "visible": false}],
          ["BBWS/Migration", "MigrationsStarted", {"id": "m1", "visible": false}]
        ]
      }
    }
  ]
}
```

### 10.3 Log Queries

```sql
-- Failed migrations by error type
fields @timestamp, migration_id, error_message
| filter level = "ERROR"
| stats count(*) as error_count by error_message
| sort error_count desc
| limit 10

-- Average migration duration by mode
fields @timestamp, migration_id, mode, duration_minutes
| filter status = "completed"
| stats avg(duration_minutes) as avg_duration by mode

-- Migrations stuck in progress
fields @timestamp, migration_id, status, progress_percent, current_step
| filter status = "in_progress" and @timestamp < now() - 4h
| sort @timestamp desc
```

### 10.4 SNS Alerts

| Alert | Condition | Recipients |
|-------|-----------|------------|
| Migration Failed | Any migration fails | platform-alerts |
| High Failure Rate | >10% failure rate in 1 hour | platform-alerts, oncall |
| DLQ Messages | Any message in DLQ | platform-alerts |
| Long Running Migration | Migration >6 hours | platform-alerts |

---

## 11. NFRs

### 11.1 Performance Requirements

| Requirement | Target | Measurement |
|-------------|--------|-------------|
| API Response Time | <500ms (p95) | CloudWatch metrics |
| Mode A Migration | <4 hours for <10GB | Migration duration metric |
| Mode B Migration | <8 hours for <1000 pages | Migration duration metric |
| Progress Update Latency | <5 seconds | Client polling frequency |
| Concurrent Migrations | 10 per tenant | Lambda concurrency |

### 11.2 Availability Requirements

| Requirement | Target |
|-------------|--------|
| API Availability | 99.9% |
| Migration Success Rate | >95% (Mode A), >85% (Mode B) |
| Recovery from failure | Automatic retry, manual resume |

### 11.3 Scalability Requirements

| Dimension | Limit | Notes |
|-----------|-------|-------|
| Migrations per tenant | 5 concurrent | Configurable |
| Source site size | 50GB max | Larger requires manual review |
| Pages (Mode B) | 1000 max | Can increase with plan |
| Media files | 10,000 max | Per migration |

---

## 12. Troubleshooting Playbook

### 12.1 Common Issues

| Issue | Symptoms | Resolution |
|-------|----------|------------|
| Source unreachable | 422 error on create | Verify URL, check firewall, try again |
| Invalid credentials | 401 on Mode A start | Verify WP admin credentials, check 2FA |
| Export timeout | Migration stuck at export | Check source site load, increase timeout |
| Import failure | Migration fails at import | Check target site health, manual recovery |
| Theme mismatch | Mode B site looks wrong | Manual theme selection, CSS adjustments |

### 12.2 Investigation Steps

```bash
# Check migration status
aws dynamodb query \
  --table-name bbws-portal-${env} \
  --key-condition-expression "PK = :pk AND begins_with(SK, :sk)" \
  --expression-attribute-values '{":pk": {"S": "MIGRATION#mig_abc"}, ":sk": {"S": "METADATA"}}'

# Get migration logs
aws logs filter-log-events \
  --log-group-name /aws/lambda/bbws-migration-worker-${env} \
  --filter-pattern "{$.migration_id = \"mig_abc\"}"

# Check Step Functions execution
aws stepfunctions describe-execution \
  --execution-arn arn:aws:states:region:account:execution:bbws-migration:exec_xyz

# Check DLQ for failed messages
aws sqs receive-message \
  --queue-url https://sqs.region.amazonaws.com/account/bbws-migration-dlq-${env} \
  --max-number-of-messages 10
```

### 12.3 Recovery Procedures

| Scenario | Procedure |
|----------|-----------|
| Partial migration | Resume from last checkpoint, skip completed steps |
| Corrupted export | Delete artifacts, restart from beginning |
| Target site issues | Fix target site, replay import step |
| Credential expired | Request new credentials, restart migration |

---

## 13. Tagging

### 13.1 Resource Tags

| Tag Key | Value | Purpose |
|---------|-------|---------|
| `Environment` | dev/sit/prod | Environment identification |
| `Project` | bbws | Project identification |
| `Service` | portal-migration | Service identification |
| `Owner` | platform-team | Ownership |
| `CostCenter` | CC-001 | Cost allocation |
| `ManagedBy` | terraform | IaC tracking |

---

## 14. Risks and Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Source site changes during migration | Data inconsistency | Medium | Snapshot approach, verification step |
| Large migrations timeout | Failed migration | Medium | Chunked exports, progress checkpoints |
| Theme matching inaccuracy | Poor user experience | Medium | Manual theme selection option |
| Source credential compromise | Security breach | Low | Short TTL, encrypted storage, audit logging |
| Mode B content blocked | Incomplete migration | Medium | Clear messaging, Mode A recommendation |

---

## 15. TBC

- [ ] AI theme matching model training and accuracy metrics
- [ ] WordPress plugin security audit
- [ ] Performance optimization for sites >20GB
- [ ] Real-time WebSocket progress updates
- [ ] Migration scheduling (off-peak hours)
- [ ] Migration preview/dry-run mode

---

## 16. Definition of Terms

| Term | Definition |
|------|------------|
| Mode A | Full-access migration using WordPress admin credentials |
| Mode B | Scrape-and-rebuild migration using public content only |
| Migration Artifact | Exported database, files, or media during migration |
| Theme Matching | AI-powered process to identify similar WordPress theme |
| Checkpoint | Progress marker allowing migration resume |
| Source Site | Original WordPress site being migrated from |
| Target Site | New BBWS WordPress site being migrated to |

---

## 17. Appendices

### Appendix A: Step Functions Definition

```json
{
  "Comment": "WordPress Migration Workflow",
  "StartAt": "ValidateSource",
  "States": {
    "ValidateSource": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${region}:${account}:function:validate_source",
      "Next": "CreateTargetSite",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "MigrationFailed"
      }]
    },
    "CreateTargetSite": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${region}:${account}:function:create_target_site",
      "Next": "DetermineMode",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "MigrationFailed"
      }]
    },
    "DetermineMode": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.mode",
          "StringEquals": "full_access",
          "Next": "ModeAWorkflow"
        },
        {
          "Variable": "$.mode",
          "StringEquals": "scrape_rebuild",
          "Next": "ModeBWorkflow"
        }
      ]
    },
    "ModeAWorkflow": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${region}:${account}:function:mode_a_worker",
      "TimeoutSeconds": 14400,
      "Next": "VerifyMigration",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "MigrationFailed"
      }]
    },
    "ModeBWorkflow": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${region}:${account}:function:mode_b_worker",
      "TimeoutSeconds": 28800,
      "Next": "VerifyMigration",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "MigrationFailed"
      }]
    },
    "VerifyMigration": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${region}:${account}:function:verify_migration",
      "Next": "SendSuccessNotification",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "MigrationFailed"
      }]
    },
    "SendSuccessNotification": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sns:publish",
      "Parameters": {
        "TopicArn": "arn:aws:sns:${region}:${account}:bbws-migration-notifications",
        "Message.$": "States.Format('Migration {} completed successfully', $.migration_id)"
      },
      "Next": "MigrationSucceeded"
    },
    "MigrationSucceeded": {
      "Type": "Succeed"
    },
    "MigrationFailed": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sns:publish",
      "Parameters": {
        "TopicArn": "arn:aws:sns:${region}:${account}:bbws-migration-alerts",
        "Message.$": "States.Format('Migration {} failed: {}', $.migration_id, $.error)"
      },
      "Next": "FailState"
    },
    "FailState": {
      "Type": "Fail",
      "Error": "MigrationFailed",
      "Cause": "Migration workflow failed"
    }
  }
}
```

---

## 18. References

| Document | Description |
|----------|-------------|
| [HLD 2.2](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md) | Parent HLD |
| [BRS 2.2](../BRS/2.2_BRS_Customer_Portal_Private.md) | Business Requirements |
| [2.6_LLD_WordPress_Site_Management](./2.6_LLD_WordPress_Site_Management.md) | Site management |
| [2.7_LLD_WordPress_Instance_Management](./2.7_LLD_WordPress_Instance_Management.md) | Instance provisioning |
| [AWS Step Functions](https://docs.aws.amazon.com/step-functions/) | Workflow orchestration |

---

## 19. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| LLD Author | LLD Architect Agent | 2026-01-20 | |
| Technical Reviewer | | | |
| Security Reviewer | | | |
| Product Owner | | | |

---

**End of Document**
