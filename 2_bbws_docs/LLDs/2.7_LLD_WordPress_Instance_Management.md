# WordPress Instance Management - Low-Level Design

**Version**: 1.0
**Created**: 2026-01-05
**Status**: Draft
**Component**: WordPress Instance Management Service (2_bbws_tenants_instances_lambda)
**Parent HLD**: [HLD 2.7 WordPress Instance Management](../HLDs/2.7_HLD_WordPress_Instance_Management.md)
**Parent BRS**: [BRS 2.7 WordPress Instance Management](../BRS/2.7_BRS_WordPress_Instance_Management.md)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-05 | Agentic Architect | Initial version - Complete LLD for WordPress Instance Management |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [High Level Epic Overview](#2-high-level-epic-overview)
3. [Architecture](#3-architecture)
4. [Provisioning Service](#4-provisioning-service)
5. [Lifecycle Service](#5-lifecycle-service)
6. [Identity Service](#6-identity-service)
7. [Deprovisioning Service](#7-deprovisioning-service)
8. [Data Model](#8-data-model)
9. [GitOps Workflow](#9-gitops-workflow)
10. [Lambda Functions](#10-lambda-functions)
11. [SQS Integration](#11-sqs-integration)
12. [Event Routing and Handling](#12-event-routing-and-handling)
13. [Security](#13-security)
14. [Monitoring & Alerting](#14-monitoring--alerting)
15. [Error Handling](#15-error-handling)
16. [NFRs](#16-nfrs)
17. [Risks and Mitigations](#17-risks-and-mitigations)
18. [Troubleshooting Playbook](#18-troubleshooting-playbook)
19. [Signoff](#19-signoff)
20. [Definition of Terms](#20-definition-of-terms)
21. [Appendix A: OpenAPI Specification](#appendix-a-openapi-specification)
22. [References](#22-references)

---

## 1. Introduction

### 1.1 Purpose

This Low-Level Design (LLD) document provides implementation-level details for the **WordPress Instance Management** microservice. This service orchestrates the creation, lifecycle management, and decommissioning of all AWS infrastructure resources required to run a dedicated WordPress instance for each tenant.

**Key Distinction**: This service handles **physical AWS resources** (ECS, EFS, RDS, ALB, Cognito). Logical tenant management (organization, users, metadata) is handled by Tenant Management (BRS 2.5).

### 1.2 Component Overview

| Attribute | Value |
|-----------|-------|
| Runtime | Python 3.12 |
| Memory | 256-1024MB (varies by function) |
| Timeout | 30-900s (varies by function) |
| Architecture | arm64 |
| Framework | AWS Lambda Powertools |

### 1.2.1 Repositories

| Repository | Purpose | Type |
|------------|---------|------|
| `2_bbws_ecs_terraform` | Platform infrastructure (VPC, ALB, ECS Cluster, RDS, EFS) - **existing, stable** | Once-off |
| `2_bbws_tenants_instances_lambda` | Instance management Lambda functions (CRUD, status, size) | Per-environment |
| `2_bbws_tenants_instances_dev` | Tenant Terraform configs and workflows (DEV) | Per-tenant |
| `2_bbws_tenants_instances_sit` | Tenant Terraform configs and workflows (SIT) | Per-tenant |
| `2_bbws_tenants_instances_prod` | Tenant Terraform configs and workflows (PROD) | Per-tenant |
| `2_bbws_tenants_event_handler` | ECS event handler Lambda (EventBridge → DynamoDB) | Once-off |
| `2_bbws_tenants_event_bridge` | EventBridge rules for ECS state sync | Once-off |

**Migration Note:**
- `2_bbws_ecs_terraform` remains unchanged - platform infrastructure is stable
- Existing tenants (`goldencrust`, `sunsetbistro`, etc.) remain in `2_bbws_ecs_terraform/terraform/tenants/`
- New tenants provisioned via API will use `2_bbws_tenants_instances_{env}` repos
- Existing tenant migration to new repos is optional and can be done incrementally

### 1.3 Lambda Functions Summary

| Domain | Functions | Description | Repository |
|--------|-----------|-------------|------------|
| API Gateway | 8 | CRUD operations, status, size management | `2_bbws_tenants_instances_lambda` |
| EventBridge | 1 | `synchronise-tenant-state` - ECS event handler | `2_bbws_tenants_event_handler` |

### 1.4 Infrastructure Classification

| Component | Type | Description |
|-----------|------|-------------|
| **Once-Off** | Shared | ALB, Listeners, ECS Cluster, EFS, EventBridge Rule, tenant-event-handler-lambda |
| **Per-Tenant** | Isolated | ECS Service, Task Definition, Target Group, Listener Rule, EFS Access Point |
| **Per-Environment** | Isolated | Separate repos per env (dev/sit/prod) with dedicated AWS credentials |

### 1.5 Dependencies

| Dependency | Purpose |
|------------|---------|
| AWS ECS | Container orchestration |
| AWS EFS | Persistent WordPress storage |
| AWS RDS MySQL | WordPress database |
| AWS ALB | Load balancing and routing |
| AWS Cognito | Per-tenant authentication |
| AWS Secrets Manager | Database credentials |
| AWS DynamoDB | Resource state tracking |
| AWS SQS | Async command/event handling |
| AWS EventBridge | ECS state change events |
| AWS CloudWatch | Logging, metrics, alarms |

### 1.6 Related Documents

| Document | Relationship |
|----------|--------------|
| BRS 2.7 WordPress Instance Management | Business requirements |
| HLD 2.7 WordPress Instance Management | Architecture design |
| BRS 2.5 Tenant Management | Triggers provisioning |
| HLD 2.0 BBWS ECS WordPress | Platform architecture |

---

## 2. High Level Epic Overview

| Epic | User Stories | Description |
|------|-------------|-------------|
| EPIC-001 | US-2.7-001 to US-2.7-005 | Customer Onboarding (Provisioning) |
| EPIC-002 | US-2.7-006 to US-2.7-010 | Lifecycle Management |
| EPIC-003 | US-2.7-011 to US-2.7-015 | Authentication Setup |
| EPIC-004 | US-2.7-016 to US-2.7-020 | Customer Offboarding (Deprovisioning) |

---

## 3. Architecture

### 3.1 Operation Classification

Operations are classified by their execution mechanism:

| Operation | Method | Mechanism | Latency | Reversible |
|-----------|--------|-----------|---------|------------|
| List Instances | GET | Direct ECS API | ~200ms | N/A |
| Get Instance | GET | Direct ECS API | ~150ms | N/A |
| Get Status | GET | Direct ECS API | ~150ms | N/A |
| Create Instance | POST | Terraform (GitOps) | 2-5 min | Yes |
| Update Instance | PUT | Terraform (GitOps) | 2-3 min | Yes |
| Delete Instance | DELETE | Terraform (GitOps) | 2-3 min | Yes |
| Scale Instance | PUT /size | Direct ECS API | 5-30 sec | Yes |
| Stop/Start | PUT /status | Direct ECS API | 5-30 sec | Yes |

### 3.2 GitOps Architecture

Infrastructure mutations (Create/Update/Delete) use Terraform via GitOps workflow:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         GitOps Flow (Mutations)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐              │
│  │   API    │    │ instance │    │   Git    │    │  GitHub  │              │
│  │ Gateway  │───▶│  Lambda  │───▶│  Helper  │───▶│   Repo   │              │
│  └──────────┘    └──────────┘    └──────────┘    └────┬─────┘              │
│                        │                              │                     │
│                        │ Generate .tf files           │                     │
│                        │ Generate workflow            │                     │
│                        ▼                              ▼                     │
│                  ┌──────────┐                   ┌──────────┐                │
│                  │TF_Helper │                   │ GitHub   │                │
│                  │GH_Author │                   │ Actions  │                │
│                  └──────────┘                   └────┬─────┘                │
│                                                      │                      │
│                                                      ▼                      │
│                                                ┌──────────┐                 │
│                                                │Terraform │                 │
│                                                │  Apply   │                 │
│                                                └────┬─────┘                 │
│                                                     │                       │
│                                                     ▼                       │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         AWS Resources                                 │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌───────────────┐  │  │
│  │  │   EFS   │ │   RDS   │ │   ECS   │ │   ALB   │ │   Cognito     │  │  │
│  │  │ Access  │ │ Database│ │ Service │ │ Target  │ │  User Pool    │  │  │
│  │  │ Point   │ │ + User  │ │ (tagged)│ │ Group   │ │  + Client     │  │  │
│  │  └─────────┘ └─────────┘ └────┬────┘ └─────────┘ └───────────────┘  │  │
│  └───────────────────────────────┼──────────────────────────────────────┘  │
│                                  │                                          │
│                                  ▼ (emits events)                           │
│                            ┌──────────┐                                     │
│                            │EventBridge│                                    │
│                            └────┬─────┘                                     │
│                                 │                                           │
│                                 ▼                                           │
│                            ┌──────────┐    ┌──────────┐                    │
│                            │ tenant-  │───▶│ DynamoDB │                    │
│                            │ state    │    │  State   │                    │
│                            │ Lambda   │    │  Store   │                    │
│                            └──────────┘    └──────────┘                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Direct ECS Operations Architecture

Operational commands (Scale/Stop/Start) and queries use direct ECS API:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Direct ECS Flow (Queries & Operations)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐              │
│  │   API    │    │ instance │    │   ECS    │    │   ECS    │              │
│  │ Gateway  │───▶│  Lambda  │───▶│  Helper  │───▶│  Cluster │              │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘              │
│                                                                              │
│  Operations:                                                                 │
│  • GET  /instances              → ECS_Helper.list_services()                │
│  • GET  /instances/{id}         → ECS_Helper.describe_service()             │
│  • GET  /instances/{id}/status  → ECS_Helper.get_service_status()           │
│  • PUT  /instances/{id}/status  → ECS_Helper.stop_service/start_service()   │
│  • PUT  /instances/{id}/size    → ECS_Helper.scale_service()                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Environment Isolation

Each environment has dedicated repositories and AWS credentials:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│       DEV       │    │       SIT       │    │      PROD       │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ instance-lambda │    │ instance-lambda │    │ instance-lambda │
│       │         │    │       │         │    │       │         │
│       ▼         │    │       ▼         │    │       ▼         │
│ 2_bbws_tenants_ │    │ 2_bbws_tenants_ │    │ 2_bbws_tenants_ │
│ instances_dev   │    │ instances_sit   │    │ instances_prod  │
│       │         │    │       │         │    │       │         │
│       ▼         │    │       ▼         │    │       ▼         │
│ AWS: 536580...  │    │ AWS: 815856...  │    │ AWS: 093646...  │
│ Region: eu-west │    │ Region: eu-west │    │ Region: af-south│
└─────────────────┘    └─────────────────┘    └─────────────────┘

Security: Each Lambda can ONLY write to its environment's repo
```

---

## 3A. REST API Layer (HATEOAS)

### 3A.1 Hierarchical URL Structure

All APIs follow hierarchical HATEOAS design aligning with HLD 2.7:

```
/v1.0/tenants/{tenantId}/instances
├── /                        (GET - list instances, POST - provision new instance)
└── /{instanceId}
    ├── /                    (GET - get instance details, PUT - update, DELETE - deprovision)
    ├── /status              (GET - get status, PUT - suspend/resume instance)
    └── /size                (PUT - scale instance)
```

### 3A.2 Instance Collection Operations

| Method | Path | Description | Triggers | Auth |
|--------|------|-------------|----------|------|
| GET | `/v1.0/tenants/{tenantId}/instances` | List all instances | Lambda | Admin |
| POST | `/v1.0/tenants/{tenantId}/instances` | Provision new instance | Lambda | Admin |

### 3A.3 Instance Resource Operations

| Method | Path | Description | Triggers | Auth |
|--------|------|-------------|----------|------|
| GET | `/v1.0/tenants/{tenantId}/instances/{instanceId}` | Get instance details | Lambda | Admin |
| PUT | `/v1.0/tenants/{tenantId}/instances/{instanceId}` | Update instance config | Lambda | Admin |
| DELETE | `/v1.0/tenants/{tenantId}/instances/{instanceId}` | Deprovision instance | Lambda | Admin |
| GET | `/v1.0/tenants/{tenantId}/instances/{instanceId}/status` | Get instance status | Lambda | Admin |
| PUT | `/v1.0/tenants/{tenantId}/instances/{instanceId}/status` | Suspend/Resume instance | Lambda | Admin |
| PUT | `/v1.0/tenants/{tenantId}/instances/{instanceId}/size` | Scale ECS service | Lambda | Admin |

### 3A.4 Provision Instance Request/Response

**Request:** `POST /v1.0/tenants/{tenantId}/instances`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| organizationName | String | Yes | Organization display name |
| contactEmail | String | Yes | Admin contact email |
| tier | String | Yes | STANDARD, PROFESSIONAL, ENTERPRISE |
| configuration.desiredCount | Number | No | Initial ECS task count (default: 2) |
| configuration.wordpressVersion | String | No | WordPress version (default: latest) |

**Response (202 Accepted):**

| Field | Description |
|-------|-------------|
| instanceId | Unique instance identifier |
| tenantId | Parent tenant identifier |
| status | PROVISIONING |
| message | Status message |
| _links.self | Link to instance resource |
| _links.collection | Link to instances collection |
| _links.status | Link to status sub-resource |

### 3A.5 API → Lambda → ECS Flow

1. Client sends request to API Gateway
2. Lambda validates request
3. Lambda creates instance record in DynamoDB (PROVISIONING)
4. Lambda executes provisioning steps
5. Lambda updates DynamoDB (ACTIVE/FAILED)
6. Lambda returns 202 Accepted with instanceId

---

## 4. Provisioning Service

### 4.1 Provisioning Steps

| Step | Lambda | Resource | Timeout | Rollback |
|------|--------|----------|---------|----------|
| 1 | `create-efs-access-point` | EFS Access Point | 60s | Delete AP |
| 2 | `create-rds-database` | MySQL DB + User | 120s | Drop DB/User |
| 3 | `store-db-credentials` | Secrets Manager | 30s | Delete Secret |
| 4 | `register-task-definition` | ECS Task Def | 60s | Deregister |
| 5 | `create-ecs-service` | ECS Service | 600s | Delete Service |
| 6 | `create-alb-target-group` | ALB Target Group + Rule | 60s | Delete TG/Rule |
| 7 | `create-cognito-pool` | Cognito User Pool + Client | 120s | Delete Pool |

### 4.2 Unified Tag Standard

All tenant resources MUST apply the following tags for traceability, cost allocation, and event-driven state synchronization.

| Tag Key | Value | Purpose | Example |
|---------|-------|---------|---------|
| `bbws:tenant-id` | `{tenantId}` | Tenant identification | `Bigbeard.co.za` |
| `bbws:project` | `BBWS-Phase-2.1-ECS` | Project tracking | Static |
| `bbws:cost-center` | `BBWS-AWS` | Cost allocation | Static |
| `bbws:opportunity` | `{opp-id}` | Sales opportunity (ACE) | `1234` |
| `bbws:managed-by` | `instance-management` | Resource ownership | Static |
| `bbws:environment` | `{env}` | Environment identification | `dev` / `sit` / `prod` |
| `bbws:component` | `{component}` | Component type | `wordpress` / `efs` / `alb` |

**Tag Application by Resource:**

| Resource | Tags Applied | Propagation |
|----------|--------------|-------------|
| ECS Service | All 7 tags | `propagate_tags = "SERVICE"` → Tasks |
| ECS Task Definition | All 7 tags | Inherited by tasks |
| EFS Access Point | All 7 tags | - |
| ALB Target Group | All 7 tags | - |
| ALB Listener Rule | All 7 tags | - |
| Cognito User Pool | All 7 tags | - |
| Secrets Manager Secret | All 7 tags | - |

**Tag Propagation Flow:**

ECS Service tags propagate to ECS Tasks via `propagate_tags = "SERVICE"`. When ECS emits events to EventBridge, these tags are included in the event detail, enabling the `tenant-event-handler-lambda` to identify the tenant without parsing service names.

### 4.3 EFS Access Point Configuration

| Parameter | Value | Description |
|-----------|-------|-------------|
| Root Directory | `/tenant-{tenantId}` | Isolated directory per tenant |
| POSIX User UID | 33 | www-data user |
| POSIX User GID | 33 | www-data group |
| Permissions | 755 | Directory permissions |
| Access Point Name | `tenant-{tenantId}-wp-content` | Unique name per tenant |

**Tags:** Apply all tags from Section 4.2 Unified Tag Standard with `bbws:component = efs`

### 4.4 RDS Database Configuration

| Parameter | Pattern | Description |
|-----------|---------|-------------|
| Database Name | `tenant_{tenantId}_db` | Unique database per tenant |
| Database User | `tenant_{tenantId}_user` | Dedicated user per tenant |
| Character Set | `utf8mb4` | Full Unicode support |
| Collation | `utf8mb4_unicode_ci` | Case-insensitive collation |

**Operations:**
1. Create database with UTF8MB4 character set
2. Create user with generated password
3. Grant all privileges on tenant database
4. Store credentials in Secrets Manager

### 4.5 ECS Task Definition

| Parameter | Value | Description |
|-----------|-------|-------------|
| Family | `tenant-{tenantId}-wordpress` | Task definition family name |
| CPU | 512 | vCPU units |
| Memory | 1024 | Memory in MB |
| Network Mode | awsvpc | VPC networking |
| Launch Type | FARGATE | Serverless compute |
| Execution Role | `bbws-ecs-execution-role` | ECR pull, Secrets Manager |
| Task Role | `bbws-ecs-task-role` | EFS access, CloudWatch |

**Container Configuration:**

| Parameter | Value |
|-----------|-------|
| Container Name | wordpress |
| Image | `{ecr-repo}/bbws-wordpress:{version}` |
| Port | 80 (HTTP) |
| Mount Point | `/var/www/html/wp-content` → EFS |

**Health Check:**

| Parameter | Value |
|-----------|-------|
| Command | `curl -f http://localhost/` |
| Interval | 30s |
| Timeout | 5s |
| Retries | 3 |
| Start Period | 60s |

**Environment Variables:**
- `WORDPRESS_DB_HOST`: RDS endpoint
- `WORDPRESS_DB_NAME`: `tenant_{tenantId}_db`

**Secrets (from Secrets Manager):**
- `WORDPRESS_DB_USER`
- `WORDPRESS_DB_PASSWORD`

### 4.6 ECS Service Configuration

| Parameter | Value | Description |
|-----------|-------|-------------|
| Service Name | `tenant-{tenantId}-wordpress` | Unique service per tenant |
| Cluster | `bbws-cluster` | Shared ECS cluster |
| Desired Count | 2 | Initial task count |
| Launch Type | FARGATE | Serverless compute |
| Platform Version | 1.4.0 | Fargate platform version |
| Assign Public IP | DISABLED | Private subnets only |

**Deployment Configuration:**

| Parameter | Value |
|-----------|-------|
| Circuit Breaker | Enabled with rollback |
| Minimum Healthy Percent | 50% |
| Maximum Percent | 200% |

**Tags:** Apply all tags from Section 4.2 Unified Tag Standard with `bbws:component = wordpress` and `propagate_tags = "SERVICE"`

### 4.7 ALB Configuration

#### 4.7.1 Infrastructure Classification

| Component | Type | Managed By | Description |
|-----------|------|------------|-------------|
| **Application Load Balancer** | Once-off | `2_bbws_ecs_terraform` | Shared ALB for all tenants |
| **HTTPS Listener (443)** | Once-off | `2_bbws_ecs_terraform` | Single listener with ACM cert |
| **HTTP Listener (80)** | Once-off | `2_bbws_ecs_terraform` | Redirects to HTTPS |
| **ACM Certificate** | Once-off | `2_bbws_ecs_terraform` | Wildcard cert `*.bbws.com` |
| **Default Target Group** | Once-off | `2_bbws_ecs_terraform` | Returns 503 for unmatched hosts |
| **Listener Rules** | Per-tenant | `2_bbws_tenants_instances_{env}` | Host-based routing per tenant |
| **Target Groups** | Per-tenant | `2_bbws_tenants_instances_{env}` | One TG per tenant ECS service |

#### 4.7.2 Once-Off Infrastructure (Platform Terraform)

**Application Load Balancer:**

| Parameter | Value |
|-----------|-------|
| Name | `bbws-alb-{env}` |
| Scheme | internet-facing |
| Type | application |
| Subnets | Public subnets (multi-AZ) |
| Security Group | `bbws-alb-sg-{env}` |
| Deletion Protection | true (prod), false (dev/sit) |

**HTTPS Listener:**

| Parameter | Value |
|-----------|-------|
| Port | 443 |
| Protocol | HTTPS |
| SSL Policy | ELBSecurityPolicy-TLS13-1-2-2021-06 |
| Certificate | `arn:aws:acm:{region}:{account}:certificate/{cert-id}` |
| Default Action | Forward to default-tg (503 response) |

**HTTP Listener:**

| Parameter | Value |
|-----------|-------|
| Port | 80 |
| Protocol | HTTP |
| Default Action | Redirect to HTTPS (301) |

**ACM Certificate:**

| Parameter | Value |
|-----------|-------|
| Domain | `*.bbws.com` |
| Validation | DNS (Route 53) |
| Type | Amazon-issued |

#### 4.7.3 Per-Tenant Infrastructure (Tenant Terraform)

**Target Group:**

| Parameter | Value |
|-----------|-------|
| Name | `bbws-{tenantId[:16]}-tg` (max 32 chars) |
| Protocol | HTTP |
| Port | 80 |
| Target Type | ip |
| VPC | `bbws-vpc-{env}` |
| Health Check Path | `/wp-admin/install.php` or `/` |
| Health Check Interval | 30s |
| Healthy Threshold | 2 |
| Unhealthy Threshold | 3 |
| Deregistration Delay | 30s |
| Tags | All 7 unified tags |

**Listener Rule:**

| Parameter | Value |
|-----------|-------|
| Listener ARN | HTTPS listener (443) |
| Condition Type | host-header |
| Host Pattern | `{tenantId}.bbws.com` |
| Action | Forward to tenant target group |
| Priority | Auto-assigned (1-50000 range) |
| Tags | All 7 unified tags |

#### 4.7.4 Host-Based Routing Pattern

```
┌─────────────────────────────────────────────────────────────────┐
│                     ALB (bbws-alb-{env})                        │
├─────────────────────────────────────────────────────────────────┤
│  HTTPS Listener (443)                                           │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Rule 1 (Priority 100):                                   │  │
│  │    IF host = "tenant-a.bbws.com" → tenant-a-tg            │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │  Rule 2 (Priority 200):                                   │  │
│  │    IF host = "tenant-b.bbws.com" → tenant-b-tg            │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │  Rule 3 (Priority 300):                                   │  │
│  │    IF host = "tenant-c.bbws.com" → tenant-c-tg            │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │  Default Rule:                                            │  │
│  │    No match → default-tg (503 Service Unavailable)        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.7.5 Listener Rule Priority Management

**Strategy:** Sequential assignment with gaps for insertions.

| Priority Range | Purpose |
|----------------|---------|
| 1-99 | Reserved for platform rules |
| 100-49999 | Tenant rules (100 increment) |
| 50000 | Default rule |

**Priority Assignment Algorithm:**

```python
def get_next_priority(existing_rules: list[int]) -> int:
    """
    Get next available priority for a new tenant rule.
    Uses 100 increment to allow insertions without reshuffling.
    """
    tenant_rules = [p for p in existing_rules if 100 <= p < 50000]
    if not tenant_rules:
        return 100
    return max(tenant_rules) + 100
```

**Terraform Implementation:**

```hcl
# In tenant Terraform config
resource "aws_lb_listener_rule" "tenant" {
  listener_arn = data.aws_lb_listener.https.arn

  # Priority managed by lookup or sequential assignment
  priority = var.rule_priority  # Assigned during provisioning

  condition {
    host_header {
      values = ["${var.tenant_id}.bbws.com"]
    }
  }

  action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.tenant.arn
  }

  tags = local.unified_tags
}
```

#### 4.7.6 DNS Configuration

| Record Type | Name | Value | TTL |
|-------------|------|-------|-----|
| CNAME | `{tenantId}.bbws.com` | `bbws-alb-{env}.{region}.elb.amazonaws.com` | 300 |

**Alternative (Wildcard):**

| Record Type | Name | Value | TTL |
|-------------|------|-------|-----|
| A (Alias) | `*.bbws.com` | ALB (alias record) | - |

**Note:** Wildcard DNS simplifies management - all tenant subdomains resolve to ALB, routing handled by listener rules.

### 4.8 Cognito User Pool Configuration

**User Pool:**

| Parameter | Value |
|-----------|-------|
| Pool Name | `bbws-tenant-{tenantId}-user-pool` |
| Auto Verify | email |
| MFA | OPTIONAL |
| Recovery | Verified email |

**Password Policy:**

| Parameter | Value |
|-----------|-------|
| Minimum Length | 8 |
| Require Uppercase | Yes |
| Require Lowercase | Yes |
| Require Numbers | Yes |
| Require Symbols | Yes |
| Temp Password Validity | 7 days |

**App Client:**

| Parameter | Value |
|-----------|-------|
| Client Name | `bbws-tenant-{tenantId}-client` |
| Generate Secret | Yes |
| Auth Flows | USER_PASSWORD_AUTH, REFRESH_TOKEN_AUTH |
| OAuth Flows | code |
| OAuth Scopes | openid, email, profile |
| Callback URL | `https://{DOMAIN}/tenant/{tenantId}/callback` |
| Logout URL | `https://{DOMAIN}/tenant/{tenantId}/logout` |

---

## 5. Lifecycle Service

### 5.1 Suspend Operation

**Steps:**
1. Update state to `SUSPENDING`
2. Scale ECS service to 0
3. Wait for tasks to drain (max 2 minutes)
4. Update state to `SUSPENDED`
5. Publish `CLUSTER_SUSPEND_COMPLETE` event

### 5.2 Resume Operation

**Steps:**
1. Update state to `RESUMING`
2. Get desired count from stored state (default: 2)
3. Scale ECS service to desired count
4. Wait for service to stabilize (max 5 minutes)
5. Update state to `ACTIVE`
6. Publish `CLUSTER_RESUME_COMPLETE` event

### 5.3 Scale Operation

**Steps:**
1. Validate desired count (2-10 range)
2. Update ECS service desired count
3. Update stored state with new count

**Constraints:**
- Minimum: 2 tasks
- Maximum: 10 tasks

---

## 6. Identity Service

### 6.1 WordPress OAuth Configuration

After Cognito User Pool is created, configure WordPress MiniOrange plugin via WP-CLI.

**Configuration Parameters:**

| Parameter | Value |
|-----------|-------|
| Provider | custom |
| Client ID | From Cognito |
| Client Secret | From Cognito |
| Scope | openid email profile |
| Authorize URL | `https://{domain}/oauth2/authorize` |
| Token URL | `https://{domain}/oauth2/token` |
| UserInfo URL | `https://{domain}/oauth2/userInfo` |

**Execution:** Via ECS Exec to running WordPress container

---

## 7. Deprovisioning Service

### 7.1 Deprovisioning Steps (Reverse Order)

| Step | Lambda | Resource | Timeout | Verify |
|------|--------|----------|---------|--------|
| 1 | `remove-alb-rule` | ALB Listener Rule | 30s | Rule deleted |
| 2 | `delete-target-group` | ALB Target Group | 30s | TG deleted |
| 3 | `stop-ecs-service` | ECS Service (scale to 0) | 120s | Tasks stopped |
| 4 | `delete-ecs-service` | ECS Service | 60s | Service deleted |
| 5 | `delete-cognito-pool` | Cognito User Pool | 60s | Pool deleted |
| 6 | `delete-secret` | Secrets Manager | 30s | Secret deleted |
| 7 | `archive-database` | RDS Snapshot | 300s | Snapshot created |
| 8 | `drop-database` | MySQL DB + User | 60s | DB dropped |
| 9 | `archive-efs` | EFS to S3 backup | 300s | Backup complete |
| 10 | `delete-access-point` | EFS Access Point | 60s | AP deleted |

### 7.2 Rollback on Failure

Rollback executes in reverse order of creation:

| Step | Resource | Action |
|------|----------|--------|
| 1 | Cognito User Pool | Delete pool |
| 2 | ALB Listener Rule | Delete rule |
| 3 | ALB Target Group | Delete target group |
| 4 | ECS Service | Scale to 0, then delete |
| 5 | EFS Access Point | Delete access point |
| 6 | RDS Database | Drop database and user |
| 7 | Secrets Manager | Delete secret (force) |
| 8 | DynamoDB State | Update to FAILED |

**Error Handling:** Each step logs errors but continues with remaining cleanup to ensure maximum resource removal.

---

## 8. Data Model

### 8.1 DynamoDB Table: `{env}-tenant-resources`

**Capacity Mode**: On-Demand

### 8.2 Item Patterns (Aligned with HLD 2.7)

| Entity | PK Pattern | SK Pattern | Purpose |
|--------|------------|------------|---------|
| Instance | `TENANT#{tenantId}` | `INSTANCE` | Instance metadata and state |
| Instance Resource | `TENANT#{tenantId}#INSTANCE` | `RESOURCE#{type}` | AWS resource ARNs (ECS, EFS, RDS, ALB, Cognito) |

### 8.3 Instance Schema

| Attribute | Type | Description |
|-----------|------|-------------|
| **Key Attributes** | | |
| PK | String | `TENANT#{tenantId}` |
| SK | String | `INSTANCE` |
| tenantId | String | Tenant identifier |
| **State Attributes** | | |
| provisioningState | String | Current state |
| lastError | String | Last error message |
| version | Number | Optimistic locking version |
| **AWS Resource ARNs** | | |
| ecsServiceArn | String | ECS service ARN |
| ecsTaskDefinitionArn | String | Task definition ARN |
| efsAccessPointId | String | EFS access point ID |
| efsAccessPointArn | String | EFS access point ARN |
| databaseName | String | MySQL database name |
| databaseUser | String | MySQL user name |
| databaseSecretArn | String | Secrets Manager ARN |
| albTargetGroupArn | String | ALB target group ARN |
| albListenerRuleArn | String | ALB listener rule ARN |
| cognitoUserPoolId | String | Cognito User Pool ID |
| cognitoAppClientId | String | Cognito App Client ID |
| desiredCount | Number | ECS desired task count |
| **Timestamp Attributes** | | |
| provisioningStartedAt | String | ISO 8601 timestamp |
| provisioningCompletedAt | String | ISO 8601 timestamp |
| createdAt | String | ISO 8601 timestamp |
| updatedAt | String | ISO 8601 timestamp |
| **GitOps Tracking Attributes** | | |
| workflowRunId | String | GitHub Actions workflow run ID |
| workflowStatus | String | queued / in_progress / completed / failed |
| lastCommitSha | String | Last Git commit SHA for this tenant |
| terraformStateKey | String | S3 key for Terraform state file |
| **Event Tracking Attributes** | | |
| lastEcsEvent | String | Last ECS event type received (e.g., `SERVICE_STEADY_STATE`) |
| lastEcsEventTime | String | ISO 8601 timestamp of last ECS event |
| **Business Context Attributes** | | |
| opportunityId | String | From `bbws:opportunity` tag (ACE opportunity ID) |
| costCenter | String | From `bbws:cost-center` tag |
| project | String | From `bbws:project` tag |

### 8.4 Provisioning States

| State | Description | Trigger |
|-------|-------------|---------|
| **GitOps States** | | |
| PENDING_PROVISIONING | Awaiting provisioning start | API request received |
| COMMITTING | Lambda committing Terraform files to Git | Git push started |
| WORKFLOW_QUEUED | GitHub workflow queued | Workflow triggered |
| WORKFLOW_RUNNING | GitHub workflow executing | Workflow started |
| PROVISIONING | Terraform apply in progress | ECS deployment event |
| ACTIVE | Running normally | `SERVICE_STEADY_STATE` event |
| **Operational States** | | |
| SCALING | Changing task count | `SERVICE_DESIRED_COUNT_UPDATED` event |
| SUSPENDING | Scaling to 0 | Stop API request |
| SUSPENDED | Scaled to 0, not running | Task count = 0 |
| RESUMING | Scaling back up | Start API request |
| **Deprovisioning States** | | |
| PENDING_DEPROVISIONING | Awaiting deprovisioning | Delete API request |
| DEPROVISIONING | Terraform destroy in progress | Destroy workflow running |
| DEPROVISIONED | All resources removed | Workflow completed |
| **Error States** | | |
| FAILED | Error occurred | `DEPLOYMENT_FAILED` or workflow failure |
| WORKFLOW_FAILED | GitHub workflow failed | Workflow conclusion = failure |

### 8.5 State Transitions (GitOps Model)

```
                              ┌─────────────────────┐
                              │ PENDING_PROVISIONING│
                              └──────────┬──────────┘
                                         │ Lambda commits to Git
                                         ▼
                              ┌─────────────────────┐
                              │     COMMITTING      │
                              └──────────┬──────────┘
                                         │ Workflow triggered
                                         ▼
                              ┌─────────────────────┐
                              │   WORKFLOW_QUEUED   │
                              └──────────┬──────────┘
                                         │ Workflow starts
                                         ▼
                              ┌─────────────────────┐
                              │   WORKFLOW_RUNNING  │──────────────┐
                              └──────────┬──────────┘              │
                                         │ Terraform apply starts   │ Failure
                                         ▼                          ▼
                              ┌─────────────────────┐    ┌─────────────────────┐
                              │    PROVISIONING     │    │   WORKFLOW_FAILED   │
                              └──────────┬──────────┘    └─────────────────────┘
                                         │ SERVICE_STEADY_STATE
                                         ▼
                              ┌─────────────────────┐
                              │       ACTIVE        │◄─────────────────────────┐
                              └──────────┬──────────┘                          │
                                         │                                     │
                   ┌─────────────────────┼─────────────────────┐              │
                   │                     │                     │              │
                   ▼                     ▼                     ▼              │
          ┌───────────────┐   ┌───────────────────┐   ┌───────────────┐      │
          │   SUSPENDING  │   │     SCALING       │   │  DEPROVISIONING│      │
          └───────┬───────┘   └─────────┬─────────┘   └───────┬───────┘      │
                  │                     │                     │              │
                  ▼                     │                     ▼              │
          ┌───────────────┐             │            ┌───────────────┐      │
          │   SUSPENDED   │             │            │  DEPROVISIONED │      │
          └───────┬───────┘             │            └───────────────┘      │
                  │                     │                                    │
                  ▼                     │                                    │
          ┌───────────────┐             │                                    │
          │   RESUMING    │─────────────┴────────────────────────────────────┘
          └───────────────┘
```

### 8.6 GSI Design

| Index | PK | SK | Purpose |
|-------|----|----|---------|
| GSI1 | `TENANT#{tenantId}#STATE` | `{state}#{updatedAt}` | List instances by provisioning state |

---

## 9. GitOps Workflow

### 9.1 Workflow Overview

Infrastructure mutations use a GitOps approach with Terraform managed via GitHub Actions:

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Lambda  │───▶│ Generate │───▶│   Git    │───▶│  GitHub  │───▶│Terraform │
│  Handler │    │ TF Files │    │  Commit  │    │ Actions  │    │  Apply   │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
```

### 9.2 Tenant Repository Structure

Each environment has a dedicated repository:

```
2_bbws_tenants_instances_{env}/
├── tenants/
│   ├── tenant-alpha/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── terraform.tfvars
│   ├── tenant-beta/
│   │   └── ...
│   └── tenant-gamma/
│       └── ...
├── modules/
│   └── wordpress-instance/
│       ├── main.tf
│       ├── ecs.tf
│       ├── alb.tf
│       ├── efs.tf
│       └── security_groups.tf
├── templates/
│   ├── tenant-workflow.yml.tpl
│   └── tenant-terraform.tf.tpl
├── backend.hcl
└── .github/workflows/
    ├── deploy-tenant-alpha.yml
    ├── deploy-tenant-beta.yml
    └── deploy-tenant-gamma.yml
```

### 9.3 Workflow Per Tenant

Each tenant gets a dedicated GitHub Actions workflow file:

```yaml
# .github/workflows/deploy-tenant-{tenant_id}.yml
name: Deploy {tenant_id}

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action'
        required: true
        type: choice
        options: [plan, apply, destroy]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: {environment}
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: {region}
      - name: Terraform Init
        working-directory: tenants/{tenant_id}
        run: terraform init
      - name: Terraform ${{ inputs.action }}
        working-directory: tenants/{tenant_id}
        run: terraform ${{ inputs.action }} -auto-approve
```

### 9.4 Provisioning Flow (GitOps)

| Step | Component | Action |
|------|-----------|--------|
| 1 | API Gateway | Receive POST /instances request |
| 2 | instance-create Lambda | Validate request |
| 3 | TF_Helper | Generate tenant Terraform files |
| 4 | GH_Actions_Author_Helper | Generate tenant workflow file |
| 5 | Git_Helper | Clone repo to EFS workspace |
| 6 | Git_Helper | Write files, commit, push |
| 7 | GH_Actions_API_Helper | Trigger workflow via GitHub API |
| 8 | GitHub Actions | Execute Terraform init/plan/apply |
| 9 | Terraform | Create ECS Service (tagged) |
| 10 | ECS | Emit state change event |
| 11 | EventBridge | Route to tenant-event-handler-lambda |
| 12 | tenant-event-handler-lambda | Update DynamoDB with ACTIVE status |

### 9.5 Update Flow (GitOps)

| Step | Component | Action |
|------|-----------|--------|
| 1 | API Gateway | Receive PUT /instances/{id} request |
| 2 | instance-update Lambda | Validate request |
| 3 | TF_Helper | Update terraform.tfvars with new config |
| 4 | Git_Helper | Commit and push changes |
| 5 | GH_Actions_API_Helper | Trigger workflow with action=apply |
| 6 | GitHub Actions | Execute Terraform apply |
| 7 | Terraform | Update ECS Service configuration |
| 8 | EventBridge | Route state change to tenant-event-handler-lambda |

### 9.6 Delete Flow (GitOps)

| Step | Component | Action |
|------|-----------|--------|
| 1 | API Gateway | Receive DELETE /instances/{id} request |
| 2 | instance-delete Lambda | Validate request |
| 3 | GH_Actions_API_Helper | Trigger workflow with action=destroy |
| 4 | GitHub Actions | Execute Terraform destroy |
| 5 | Terraform | Remove all tenant resources |
| 6 | Git_Helper | Remove tenant folder and workflow |
| 7 | Git_Helper | Commit and push cleanup |
| 8 | EventBridge | Route final state change |
| 9 | tenant-event-handler-lambda | Update DynamoDB with DEPROVISIONED status |

### 9.7 Terraform State Management

| Environment | State Backend | Lock Table |
|-------------|---------------|------------|
| DEV | `s3://bbws-terraform-state-dev/tenants/{tenant_id}/terraform.tfstate` | `bbws-terraform-locks-dev` |
| SIT | `s3://bbws-terraform-state-sit/tenants/{tenant_id}/terraform.tfstate` | `bbws-terraform-locks-sit` |
| PROD | `s3://bbws-terraform-state-prod/tenants/{tenant_id}/terraform.tfstate` | `bbws-terraform-locks-prod` |

**Error Handling:** On Terraform failure, workflow sets status to FAILED. Lambda polls workflow status and updates DynamoDB accordingly.

---

## 10. Lambda Functions

### 10.1 Function Specifications

| Function | Memory | Timeout | Concurrency | Trigger |
|----------|--------|---------|-------------|---------|
| `instance-list` | 256MB | 30s | 10 | API Gateway |
| `instance-create` | 1024MB | 900s | 5 | API Gateway |
| `instance-get` | 256MB | 30s | 10 | API Gateway |
| `instance-update` | 512MB | 300s | 5 | API Gateway |
| `instance-delete` | 1024MB | 900s | 5 | API Gateway |
| `instance-status-get` | 256MB | 30s | 10 | API Gateway |
| `instance-status-update` | 512MB | 300s | 5 | API Gateway |
| `instance-size-update` | 256MB | 60s | 10 | API Gateway |
| `synchronise-tenant-state` | 256MB | 30s | 10 | EventBridge (ECS Events) |

### 10.2 Lambda Environment Variables

| Variable | DEV | SIT | PROD | Description |
|----------|-----|-----|------|-------------|
| `GITHUB_REPO` | `2_bbws_tenants_instances_dev` | `2_bbws_tenants_instances_sit` | `2_bbws_tenants_instances_prod` | Target repo for Terraform files |
| `GITHUB_TOKEN_SECRET` | `dev/github/token` | `sit/github/token` | `prod/github/token` | Secrets Manager path for GitHub PAT |
| `ECS_CLUSTER` | `bbws-cluster-dev` | `bbws-cluster-sit` | `bbws-cluster-prod` | ECS cluster name |
| `AWS_REGION` | `eu-west-1` | `eu-west-1` | `af-south-1` | AWS region |
| `DYNAMODB_TABLE` | `dev-tenant-resources` | `sit-tenant-resources` | `prod-tenant-resources` | State table name |
| `WORKSPACE_PATH` | `/mnt/workspace` | `/mnt/workspace` | `/mnt/workspace` | EFS mount path for Git operations |

### 10.3 Helper Classes

Lambda handlers use the following helper classes for separation of concerns:

| Class | Location | Purpose | Dependencies |
|-------|----------|---------|--------------|
| `ECS_Helper` | `src/helpers/ecs_helper.py` | ECS API interactions (query, scale, stop/start) | boto3 |
| `TF_Helper` | `src/helpers/tf_helper.py` | Terraform file generation from templates | Jinja2 |
| `Git_Helper` | `src/helpers/git_helper.py` | Git repository operations (clone, commit, push) | GitPython |
| `GH_Actions_Author_Helper` | `src/helpers/gh_actions_author_helper.py` | GitHub Actions workflow YAML generation | Jinja2 |
| `GH_Actions_API_Helper` | `src/helpers/gh_actions_api_helper.py` | GitHub API interactions (trigger workflows) | requests |

#### 10.3.1 Helper → Operation Mapping

| Lambda Operation | Helpers Used |
|------------------|--------------|
| List Instances | `ECS_Helper.list_services()` |
| Get Instance | `ECS_Helper.describe_service()` |
| Get Status | `ECS_Helper.get_service_status()` |
| Create Instance | `TF_Helper` → `GH_Actions_Author_Helper` → `Git_Helper` → `GH_Actions_API_Helper` |
| Update Instance | `TF_Helper` → `Git_Helper` → `GH_Actions_API_Helper` |
| Delete Instance | `Git_Helper` → `GH_Actions_API_Helper` (trigger destroy) |
| Scale Instance | `ECS_Helper.scale_service()` |
| Stop Instance | `ECS_Helper.stop_service()` |
| Start Instance | `ECS_Helper.start_service()` |

#### 10.3.2 EFS Workspace Configuration

Git operations use EFS for persistent storage:

| Parameter | Value |
|-----------|-------|
| EFS Access Point | `bbws-lambda-workspace-ap` |
| Mount Path | `/mnt/workspace` |
| POSIX User | UID 1000, GID 1000 |
| Root Directory | `/lambda-workspace` |

**Workspace Structure:**

```
/mnt/workspace/
├── cache/
│   └── 2_bbws_tenants_instances_{env}/    # Cached repo clone
└── active/
    └── {request-id}/                       # Per-request workspace
        ├── tenants/{tenant-id}/
        └── .github/workflows/
```

### 10.4 Tenant State Lambda (Once-Off Infrastructure)

The `tenant-event-handler-lambda` is a **once-off** component deployed as part of platform infrastructure. It listens to ALL ECS events for the cluster and uses tags to identify tenants.

**Repository:** `2_bbws_tenants_event_handler`

**Deployed By:** `2_bbws_ecs_terraform`

#### 10.4.1 Component Classification

| Aspect | Value |
|--------|-------|
| Type | Once-off (shared infrastructure) |
| Trigger | EventBridge (all ECS events for cluster) |
| Output | DynamoDB state updates |
| Scaling | Single Lambda handles all tenants |

#### 10.4.2 EventBridge Rule Configuration

| Parameter | Value |
|-----------|-------|
| Rule Name | `bbws-ecs-state-sync-rule` |
| Source | `aws.ecs` |
| Detail Types | ECS Service Action, ECS Deployment State Change |
| Cluster Filter | `bbws-cluster-{env}` |
| Target | `tenant-event-handler-lambda` |

#### 10.4.3 Tag-Based Tenant Identification

The Lambda extracts tenant context from ECS event tags (see Section 4.2 Unified Tag Standard):

| Tag | Purpose |
|-----|---------|
| `bbws:tenant-id` | Primary key for DynamoDB update |
| `bbws:environment` | Environment validation |
| `bbws:project` | Project context |
| `bbws:cost-center` | Cost tracking |
| `bbws:opportunity` | Sales opportunity tracking |

#### 10.4.4 ECS Events Handled

| ECS Event | Detail Type | DynamoDB Status Update |
|-----------|-------------|------------------------|
| `SERVICE_STEADY_STATE` | ECS Service Action | `ACTIVE` |
| `SERVICE_TASK_START_IMPAIRED` | ECS Service Action | `FAILED` |
| `SERVICE_DESIRED_COUNT_UPDATED` | ECS Service Action | `SCALING` |
| `DEPLOYMENT_COMPLETED` | ECS Deployment State Change | `ACTIVE` |
| `DEPLOYMENT_FAILED` | ECS Deployment State Change | `FAILED` |
| `DEPLOYMENT_IN_PROGRESS` | ECS Deployment State Change | `PROVISIONING` |

#### 10.4.5 Lambda Processing Steps

| Step | Action | Description |
|------|--------|-------------|
| 1 | Receive event | EventBridge delivers ECS state change event |
| 2 | Extract tags | Read `detail.tags` array from event payload |
| 3 | Validate tenant | Check `bbws:tenant-id` tag exists |
| 4 | Validate environment | Confirm `bbws:environment` matches Lambda's env |
| 5 | Map status | Convert ECS event type to DynamoDB status |
| 6 | Update DynamoDB | Write to `PK=TENANT#{tenantId}`, `SK=INSTANCE` |
| 7 | Log result | CloudWatch log with tenant context |

#### 10.4.6 Architecture Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    ECS Cluster (shared)                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │ tenant-alpha    │  │ tenant-beta     │  │ tenant-gamma    │     │
│  │ (tagged)        │  │ (tagged)        │  │ (tagged)        │     │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘     │
└───────────┼────────────────────┼────────────────────┼───────────────┘
            │                    │                    │
            └────────────────────┼────────────────────┘
                                 ▼
            ┌─────────────────────────────────────────┐
            │      EventBridge Rule (once-off)        │
            │  Source: aws.ecs                        │
            │  Cluster: bbws-cluster-{env}            │
            └────────────────────┬────────────────────┘
                                 │
                                 ▼
            ┌─────────────────────────────────────────┐
            │     tenant-event-handler-lambda (once-off)      │
            │                                         │
            │  1. Extract tags from event             │
            │  2. Get bbws:tenant-id                  │
            │  3. Map event → status                  │
            │  4. Update DynamoDB                     │
            └────────────────────┬────────────────────┘
                                 │
                                 ▼
            ┌─────────────────────────────────────────┐
            │           DynamoDB (shared)             │
            │  PK: TENANT#{tenantId}                  │
            │  SK: INSTANCE                           │
            └─────────────────────────────────────────┘
```

#### 10.4.7 DynamoDB Update Payload

| Attribute | Source |
|-----------|--------|
| `provisioningState` | Mapped from ECS event |
| `lastEcsEvent` | Event type (e.g., `SERVICE_STEADY_STATE`) |
| `lastEcsEventTime` | Event timestamp |
| `updatedAt` | Current ISO 8601 timestamp |
| `opportunityId` | From `bbws:opportunity` tag |
| `costCenter` | From `bbws:cost-center` tag |

---

## 11. SQS Integration

### 11.1 Queue Configuration

| Queue | Purpose | Visibility Timeout | Retention | DLQ |
|-------|---------|-------------------|-----------|-----|
| `bbws-instance-provision` | START_CLUSTER_CREATION | 900s | 4 days | Yes |
| `bbws-instance-lifecycle` | Park/Unpark/Scale | 300s | 4 days | Yes |
| `bbws-instance-deprovision` | START_CLUSTER_DELETION | 900s | 14 days | Yes |
| `bbws-tenant-events` | Completion events | 30s | 4 days | No |

### 11.2 Message Schemas

**START_CLUSTER_CREATION:**

| Field | Type | Description |
|-------|------|-------------|
| eventType | String | `START_CLUSTER_CREATION` |
| tenantId | String | Tenant identifier |
| timestamp | ISO 8601 | Event timestamp |
| organizationName | String | Organization name |
| contactEmail | String | Admin email |
| requestedBy | String | Operator email |
| correlationId | UUID | Request correlation ID |

**CLUSTER_CREATION_COMPLETE:**

| Field | Type | Description |
|-------|------|-------------|
| eventType | String | `CLUSTER_CREATION_COMPLETE` |
| tenantId | String | Tenant identifier |
| timestamp | ISO 8601 | Event timestamp |
| status | String | SUCCESS or FAILED |
| resources.ecsServiceArn | String | ECS service ARN |
| resources.efsAccessPointId | String | EFS access point ID |
| resources.cognitoUserPoolId | String | Cognito pool ID |
| correlationId | UUID | Request correlation ID |

---

## 12. Event Routing and Handling

### 12.1 Event-Driven Architecture Overview

The instance management system uses **tag-based event routing** to synchronize ECS state changes with DynamoDB. A single EventBridge rule captures all tenant events, and the tenant-event-handler-lambda extracts the `bbws:tenant-id` tag to identify which tenant record to update.

```
┌─────────────────────────────────────────────────────────────────────┐
│                    ECS Cluster (shared, per-env)                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │ Service A       │  │ Service B       │  │ Service C       │     │
│  │ Tags:           │  │ Tags:           │  │ Tags:           │     │
│  │  tenant-id=A    │  │  tenant-id=B    │  │  tenant-id=C    │     │
│  │  opportunity=X  │  │  opportunity=Y  │  │  opportunity=Z  │     │
│  │  cost-center=.. │  │  cost-center=.. │  │  cost-center=.. │     │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘     │
└───────────┼────────────────────┼────────────────────┼───────────────┘
            │                    │                    │
            └────────────────────┼────────────────────┘
                                 │ (all ECS events)
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│              EventBridge Rule (once-off per env)                    │
│  ─────────────────────────────────────────────────────────────────  │
│  Name: bbws-ecs-state-sync-rule-{env}                               │
│  Source: aws.ecs                                                    │
│  Detail Types: ECS Service Action, ECS Deployment State Change      │
│  Cluster Filter: bbws-cluster-{env}                                 │
│  NO tenant filtering - receives ALL tenant events                   │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│              tenant-event-handler-lambda (once-off per env)                 │
│  ─────────────────────────────────────────────────────────────────  │
│  1. Receive event                                                   │
│  2. Extract tags from event.detail.tags[]                           │
│  3. Get bbws:tenant-id → tenant identification                      │
│  4. Get bbws:opportunity → business context                         │
│  5. Get bbws:cost-center → cost allocation                          │
│  6. Map ECS event type → DynamoDB status                            │
│  7. Update DynamoDB record                                          │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    DynamoDB (shared per env)                        │
│  PK: TENANT#{tenantId}  SK: INSTANCE                                │
│  Updated: provisioningState, lastEcsEvent, opportunityId, etc.      │
└─────────────────────────────────────────────────────────────────────┘
```

### 12.2 Infrastructure Classification

| Component | Type | Quantity | Managed By |
|-----------|------|----------|------------|
| EventBridge Rule | Once-off | 1 per env | `2_bbws_tenants_event_bridge` |
| tenant-event-handler-lambda | Once-off | 1 per env | `2_bbws_tenants_event_handler` |
| ECS Service Tags | Per-tenant | N per env | `2_bbws_tenants_instances_{env}` |

### 12.3 EventBridge Rule Configuration

**Rule: `bbws-ecs-state-sync-rule-{env}`**

```json
{
  "source": ["aws.ecs"],
  "detail-type": [
    "ECS Service Action",
    "ECS Deployment State Change",
    "ECS Task State Change"
  ],
  "detail": {
    "clusterArn": ["arn:aws:ecs:{region}:{account}:cluster/bbws-cluster-{env}"]
  }
}
```

| Parameter | Value |
|-----------|-------|
| Name | `bbws-ecs-state-sync-rule-{env}` |
| State | ENABLED |
| Target | `arn:aws:lambda:{region}:{account}:function:tenant-event-handler-lambda` |
| Retry Policy | 3 attempts, 60s between retries |
| Dead-letter Queue | `bbws-ecs-events-dlq-{env}` |

### 12.4 ECS Event Types and Status Mapping

| Event Type | Detail Type | Trigger | DynamoDB Status |
|------------|-------------|---------|-----------------|
| `SERVICE_STEADY_STATE` | ECS Service Action | Service stabilized | `ACTIVE` |
| `SERVICE_TASK_START_IMPAIRED` | ECS Service Action | Tasks failing to start | `FAILED` |
| `SERVICE_DESIRED_COUNT_UPDATED` | ECS Service Action | Scale operation | `SCALING` |
| `DEPLOYMENT_COMPLETED` | ECS Deployment State Change | Deployment finished | `ACTIVE` |
| `DEPLOYMENT_FAILED` | ECS Deployment State Change | Deployment failed | `FAILED` |
| `DEPLOYMENT_IN_PROGRESS` | ECS Deployment State Change | Deployment started | `PROVISIONING` |
| `TASK_STOPPED` | ECS Task State Change | Task terminated | Log only |
| `TASK_RUNNING` | ECS Task State Change | Task started | Log only |

### 12.5 Tag Extraction Logic

The tenant-event-handler-lambda uses the following algorithm to extract tenant identification from ECS events:

| Step | Action | Fallback |
|------|--------|----------|
| 1 | Check `event.detail.tags[]` array | - |
| 2 | Find tag with `key = "bbws:tenant-id"` | Reject event (not a managed service) |
| 3 | Validate `bbws:environment` matches Lambda env | Reject event (wrong environment) |
| 4 | Extract all `bbws:*` tags | Use defaults where missing |

**Python Implementation:**

```python
def extract_tenant_from_event(event: dict) -> dict | None:
    """Extract tenant information from ECS event tags."""
    tags = event.get('detail', {}).get('tags', [])

    # Convert to dictionary
    tag_dict = {tag['key']: tag['value'] for tag in tags}

    # Check for managed service
    tenant_id = tag_dict.get('bbws:tenant-id')
    if not tenant_id:
        logger.info("Ignoring event: not a managed tenant service")
        return None

    # Validate environment
    event_env = tag_dict.get('bbws:environment')
    if event_env != os.environ.get('ENVIRONMENT'):
        logger.warning(f"Environment mismatch: {event_env} != {os.environ.get('ENVIRONMENT')}")
        return None

    return {
        'tenant_id': tenant_id,
        'project': tag_dict.get('bbws:project'),
        'cost_center': tag_dict.get('bbws:cost-center'),
        'opportunity': tag_dict.get('bbws:opportunity'),
        'managed_by': tag_dict.get('bbws:managed-by'),
        'environment': event_env,
        'component': tag_dict.get('bbws:component')
    }
```

### 12.6 Edge Case Handling

| Scenario | Handling |
|----------|----------|
| No `bbws:tenant-id` tag | Ignore event (not a managed tenant service) |
| Environment mismatch | Ignore event (cross-env event leak) |
| Duplicate events | Idempotent update (last-write-wins) |
| Missing optional tags | Use defaults or NULL |
| Unknown event type | Log and ignore |
| Lambda timeout during update | Event retried by EventBridge |
| DynamoDB throttling | Exponential backoff retry |

### 12.7 Tenant State Lambda

**Function: `tenant-event-handler-lambda`**

| Attribute | Value |
|-----------|-------|
| Runtime | Python 3.12 |
| Memory | 256 MB |
| Timeout | 30 seconds |
| Architecture | arm64 |
| VPC | No (uses public DynamoDB endpoint) |

**Environment Variables:**

| Variable | Value | Description |
|----------|-------|-------------|
| `ENVIRONMENT` | `dev` / `sit` / `prod` | Current environment |
| `DYNAMODB_TABLE` | `bbws-tenants-{env}` | DynamoDB table name |
| `LOG_LEVEL` | `INFO` | Logging level |

**IAM Permissions:**

| Action | Resource | Purpose |
|--------|----------|---------|
| `dynamodb:UpdateItem` | `arn:aws:dynamodb:*:*:table/bbws-tenants-*` | Update tenant state |
| `dynamodb:GetItem` | `arn:aws:dynamodb:*:*:table/bbws-tenants-*` | Read current state |
| `logs:CreateLogGroup` | `*` | CloudWatch logging |
| `logs:CreateLogStream` | `*` | CloudWatch logging |
| `logs:PutLogEvents` | `*` | CloudWatch logging |

---

## 13. Security

### 13.1 IAM Roles

| Role | Purpose | Key Permissions |
|------|---------|-----------------|
| `bbws-instance-lambda-role-{env}` | Lambda execution | ECS, EFS, RDS, ALB, Cognito, Secrets Manager, SQS, DynamoDB |
| `bbws-ecs-execution-role-{env}` | ECS task execution | ECR pull, Secrets Manager read, CloudWatch logs |
| `bbws-ecs-task-role-{env}` | Container runtime | EFS access, CloudWatch metrics |
| `bbws-github-actions-role-{env}` | GitHub Actions OIDC | ECS, ALB, EFS, Secrets Manager |

### 13.2 Security Controls

| Control | Implementation |
|---------|----------------|
| Encryption at Rest | KMS for EFS, RDS, Secrets Manager |
| Encryption in Transit | TLS 1.2+ everywhere |
| Network Isolation | Private subnets, security groups |
| Secrets Management | Secrets Manager with rotation |
| IAM Least Privilege | Per-function roles |
| Resource Tagging | `bbws:tenant-id` on all resources |

### 13.3 Environment Isolation

The GitOps architecture enforces strict environment isolation through repository and credential separation.

#### 13.3.1 Repository Isolation

| Environment | Repository | AWS Account | Lambda Access |
|-------------|------------|-------------|---------------|
| DEV | `2_bbws_tenants_instances_dev` | 536580886816 | Write only to dev repo |
| SIT | `2_bbws_tenants_instances_sit` | 815856636111 | Write only to sit repo |
| PROD | `2_bbws_tenants_instances_prod` | 093646564004 | Write only to prod repo |

#### 13.3.2 GitHub Token Scoping

| Token | Scope | Repository Access | Purpose |
|-------|-------|-------------------|---------|
| `dev/github/token` | `repo` | `2_bbws_tenants_instances_dev` only | Lambda commits to dev repo |
| `sit/github/token` | `repo` | `2_bbws_tenants_instances_sit` only | Lambda commits to sit repo |
| `prod/github/token` | `repo` | `2_bbws_tenants_instances_prod` only | Lambda commits to prod repo |

**Token Configuration:**
- Each token is a Fine-grained Personal Access Token (PAT)
- Scope limited to single repository
- Permissions: `contents: write`, `actions: write`
- Stored in AWS Secrets Manager per environment

#### 13.3.3 Security Benefits

| Security Aspect | Single Repo (Alternative) | Per-Environment Repos (Chosen) |
|-----------------|---------------------------|-------------------------------|
| Credential Scope | One token accesses all envs | Token scoped to single env |
| Blast Radius | Compromised token affects all | Limited to single environment |
| Privilege Escalation | Possible across environments | Impossible - no cross-env access |
| Secret Leakage Risk | High - one token exposes all | Low - 1 token per Lambda |
| Audit Trail | Mixed in single repo | Clear separation per environment |
| Compliance | Complex to demonstrate isolation | Clear environment boundaries |

#### 13.3.4 IAM Policy for Lambda

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "SecretsManagerAccess",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:*:*:secret:{env}/github/token-*"
      ]
    },
    {
      "Sid": "EFSAccess",
      "Effect": "Allow",
      "Action": [
        "elasticfilesystem:ClientMount",
        "elasticfilesystem:ClientWrite"
      ],
      "Resource": [
        "arn:aws:elasticfilesystem:*:*:access-point/fsap-*"
      ],
      "Condition": {
        "StringEquals": {
          "elasticfilesystem:AccessPointArn": "arn:aws:elasticfilesystem:*:*:access-point/bbws-lambda-workspace-ap-{env}"
        }
      }
    }
  ]
}
```

#### 13.3.5 GitHub Actions OIDC Trust

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::{account}:oidc-provider/token.actions.githubusercontent.com"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
        },
        "StringLike": {
          "token.actions.githubusercontent.com:sub": "repo:your-org/2_bbws_tenants_instances_{env}:*"
        }
      }
    }
  ]
}
```

---

## 14. Monitoring & Alerting

### 14.1 CloudWatch Metrics

| Metric | Namespace | Alarm Threshold | Action |
|--------|-----------|-----------------|--------|
| ProvisioningDuration | BBWS/Instance | > 15 minutes | Alert ops |
| ProvisioningSuccess | BBWS/Instance | < 99% | Alert ops |
| ProvisioningFailures | BBWS/Instance | > 0 | Alert ops |
| RollbackCount | BBWS/Instance | > 0 | Alert ops |
| DLQMessageCount | AWS/SQS | > 0 | Alert ops |

### 14.2 CloudWatch Alarms

| Alarm | Condition | Severity | Notification |
|-------|-----------|----------|--------------|
| Provisioning Failure | Any failure | High | SNS → PagerDuty |
| Provisioning Timeout | > 20 minutes | High | SNS → PagerDuty |
| DLQ Messages | DLQ depth > 0 | Medium | SNS → Slack |
| Workflow Failed | GitHub workflow failure | High | SNS → PagerDuty |
| Terraform Plan Failed | Terraform plan errors | High | SNS → PagerDuty |
| Git Commit Failed | Lambda Git push failure | High | SNS → PagerDuty |

---

## 15. Error Handling

### 15.1 Error Codes

| Code | Description | Recovery Action |
|------|-------------|-----------------|
| **GitOps Errors** | | |
| GIT-001 | GitHub token expired or invalid | Rotate token in Secrets Manager |
| GIT-002 | Git push failed (conflict) | Fetch latest and retry |
| GIT-003 | EFS workspace mount failed | Check EFS access point |
| GIT-004 | Workflow trigger failed | Check GitHub API limits |
| WF-001 | Workflow queued timeout | Check GitHub runner availability |
| WF-002 | Workflow execution failed | Check workflow logs |
| TF-001 | Terraform init failed | Check backend config |
| TF-002 | Terraform plan failed | Check resource limits |
| TF-003 | Terraform apply failed | Check IAM permissions |
| TF-004 | Terraform state lock failed | Check S3/DynamoDB |
| **Infrastructure Errors** | | |
| PROV-001 | EFS access point creation failed | Retry with backoff |
| PROV-002 | Database creation failed | Check RDS capacity |
| PROV-003 | ECS service stabilization timeout | Check container logs |
| PROV-004 | ALB rule creation failed | Check listener capacity |
| PROV-005 | Cognito pool creation failed | Check service limits |
| PROV-006 | Rollback failed | Manual intervention required |

### 15.2 Retry Strategy

| Parameter | Value |
|-----------|-------|
| Max Retries | 3 |
| Initial Delay | 1 second |
| Max Delay | 60 seconds |
| Backoff Factor | 2 (exponential) |

**Retryable Exceptions:**
- ThrottlingException
- ServiceUnavailableException
- RequestLimitExceeded

---

## 16. NFRs

### 16.1 Performance

| Metric | Target | Measurement |
|--------|--------|-------------|
| Provisioning time | < 15 minutes | End-to-end |
| Deprovisioning time | < 10 minutes | End-to-end |
| Suspend time | < 2 minutes | ECS scale to 0 |
| Resume time | < 5 minutes | ECS scale up + healthy |

### 16.2 Availability

| Metric | Target |
|--------|--------|
| Provisioning success rate | > 99% |
| API availability | 99.9% |

---

## 17. Risks and Mitigations

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Provisioning timeout | Medium | High | Parallel steps where possible |
| Orphaned resources | Low | Medium | Daily cleanup job |
| Rollback failure | Low | Critical | Manual intervention runbook |
| RDS connection limit | Medium | High | Connection pooling |

---

## 18. Troubleshooting Playbook

### 18.1 GitOps Workflow Issues

#### Workflow Not Triggered
1. Check Lambda logs for Git commit success
2. Verify GitHub token has `actions:write` permission
3. Check GitHub API rate limits
4. Verify workflow file exists in `.github/workflows/`
5. Check GitHub Actions settings in repository

#### Workflow Stuck in Queued
1. Check GitHub Actions runner availability
2. Verify repository has workflow permissions enabled
3. Check for concurrent workflow limits
4. Cancel and re-trigger if stuck > 10 minutes

#### Terraform Apply Failed
1. Check workflow logs in GitHub Actions
2. Review Terraform plan output for errors
3. Verify IAM role permissions
4. Check Terraform state for locks
5. Verify resource limits not exceeded

### 18.2 Provisioning Stuck

1. Check Lambda execution logs in CloudWatch
2. Review DynamoDB for `provisioningState` and `workflowStatus`
3. Check GitHub workflow run status via API
4. If WORKFLOW_FAILED: check workflow logs
5. If stuck in COMMITTING: check EFS mount and Git credentials
6. To recover: manually trigger destroy workflow, delete DynamoDB record, retry

### 18.3 ECS Service Not Stabilizing

1. Check ECS service events
2. Review container logs in CloudWatch
3. Verify security groups allow health checks
4. Check EFS mount point accessibility
5. Verify database connectivity

### 18.4 Git Commit Failures

1. Verify EFS mount at `/mnt/workspace`
2. Check Lambda has GitPython installed
3. Verify GitHub token is valid: `gh auth status`
4. Check for merge conflicts in tenant folder
5. Verify repo write permissions

### 18.5 State Sync Issues (EventBridge)

1. Check EventBridge rule is enabled
2. Verify tenant-event-handler-lambda is receiving events
3. Check CloudWatch logs for lambda errors
4. Verify DynamoDB table permissions
5. Check event pattern matches ECS cluster ARN

---

## 19. Signoff

| Role | Name | Signature | Date |
|------|------|-----------|------|
| Technical Lead | | | |
| DevOps Lead | | | |
| Security Lead | | | |

---

## 20. Definition of Terms

| Term | Definition |
|------|------------|
| **Tenant** | Customer organization with dedicated WordPress resources |
| **Provisioning** | Creating all AWS resources for a tenant |
| **Deprovisioning** | Removing all AWS resources for a tenant |
| **Instance** | Complete WordPress environment (ECS + EFS + RDS + ALB + Cognito) |

---

## Appendix A: OpenAPI Specification

The full OpenAPI 3.0 specification for the WordPress Instance Management API is maintained in a separate file at `LLDs/openapi/2.7_instance_management_api.yaml`.

### A.1 API Summary

| Endpoint | Method | Operation ID | Mechanism | Description |
|----------|--------|--------------|-----------|-------------|
| `/tenants/{tenantId}/instances` | GET | listInstances | Direct ECS | List all instances for tenant |
| `/tenants/{tenantId}/instances` | POST | createInstance | Terraform | Provision new instance |
| `/tenants/{tenantId}/instances/{instanceId}` | GET | getInstance | Direct ECS | Get instance details |
| `/tenants/{tenantId}/instances/{instanceId}` | PUT | updateInstance | Terraform | Update instance configuration |
| `/tenants/{tenantId}/instances/{instanceId}` | DELETE | deleteInstance | Terraform | Deprovision instance |
| `/tenants/{tenantId}/instances/{instanceId}/status` | GET | getInstanceStatus | Direct ECS | Get instance running status |
| `/tenants/{tenantId}/instances/{instanceId}/status` | PUT | updateInstanceStatus | Direct ECS | Stop/Start instance |
| `/tenants/{tenantId}/instances/{instanceId}/size` | PUT | scaleInstance | Direct ECS | Scale instance task count |

### A.2 OpenAPI Specification

```yaml
openapi: 3.0.3
info:
  title: WordPress Instance Management API
  version: 1.0.0
  description: |
    API for managing WordPress instances per tenant in the BBWS platform.
    Uses GitOps (Terraform via GitHub Actions) for infrastructure mutations
    and direct ECS API for operational commands and queries.

servers:
  - url: https://api.{environment}.bbws.com/v1.0
    variables:
      environment:
        enum: [dev, sit, prod]
        default: dev

security:
  - CognitoAuth: []

paths:
  /tenants/{tenantId}/instances:
    get:
      operationId: listInstances
      summary: List all instances for a tenant
      tags: [Instances]
      parameters:
        - $ref: '#/components/parameters/TenantId'
      responses:
        '200':
          description: List of instances
          content:
            application/json:
              schema:
                type: object
                properties:
                  instances:
                    type: array
                    items:
                      $ref: '#/components/schemas/InstanceSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      operationId: createInstance
      summary: Create a new WordPress instance
      tags: [Instances]
      parameters:
        - $ref: '#/components/parameters/TenantId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInstanceRequest'
      responses:
        '202':
          description: Instance creation initiated (async via GitOps)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /tenants/{tenantId}/instances/{instanceId}:
    get:
      operationId: getInstance
      summary: Get instance details
      tags: [Instances]
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/InstanceId'
      responses:
        '200':
          description: Instance details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Instance'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      operationId: deleteInstance
      summary: Delete a WordPress instance
      tags: [Instances]
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/InstanceId'
      responses:
        '202':
          description: Instance deletion initiated (async via GitOps)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /tenants/{tenantId}/instances/{instanceId}/status:
    get:
      operationId: getInstanceStatus
      summary: Get instance running status
      tags: [Operations]
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/InstanceId'
      responses:
        '200':
          description: Instance status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstanceStatus'

    put:
      operationId: updateInstanceStatus
      summary: Stop or start an instance
      tags: [Operations]
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/InstanceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StatusUpdateRequest'
      responses:
        '200':
          description: Status update initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstanceStatus'

  /tenants/{tenantId}/instances/{instanceId}/size:
    put:
      operationId: scaleInstance
      summary: Scale instance task count
      tags: [Operations]
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/InstanceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScaleRequest'
      responses:
        '200':
          description: Scale operation initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstanceStatus'

components:
  parameters:
    TenantId:
      name: tenantId
      in: path
      required: true
      schema:
        type: string
      description: Tenant identifier

    InstanceId:
      name: instanceId
      in: path
      required: true
      schema:
        type: string
      description: Instance identifier (usually 'primary' for single-instance tenants)

  schemas:
    InstanceSummary:
      type: object
      properties:
        instanceId:
          type: string
        tenantId:
          type: string
        status:
          type: string
          enum: [ACTIVE, SUSPENDED, PROVISIONING, FAILED]
        desiredCount:
          type: integer
        runningCount:
          type: integer

    Instance:
      type: object
      properties:
        instanceId:
          type: string
        tenantId:
          type: string
        provisioningState:
          type: string
        ecsServiceArn:
          type: string
        efsAccessPointId:
          type: string
        albTargetGroupArn:
          type: string
        cognitoUserPoolId:
          type: string
        desiredCount:
          type: integer
        runningCount:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    InstanceStatus:
      type: object
      properties:
        instanceId:
          type: string
        status:
          type: string
          enum: [ACTIVE, SUSPENDED, SUSPENDING, RESUMING, SCALING]
        desiredCount:
          type: integer
        runningCount:
          type: integer
        pendingCount:
          type: integer

    CreateInstanceRequest:
      type: object
      required:
        - organizationName
        - contactEmail
      properties:
        organizationName:
          type: string
        contactEmail:
          type: string
          format: email
        opportunityId:
          type: string
          description: ACE opportunity ID for cost tracking
        desiredCount:
          type: integer
          default: 2
          minimum: 2
          maximum: 10

    StatusUpdateRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum: [stop, start]

    ScaleRequest:
      type: object
      required:
        - desiredCount
      properties:
        desiredCount:
          type: integer
          minimum: 2
          maximum: 10

    AsyncResponse:
      type: object
      properties:
        requestId:
          type: string
          format: uuid
        status:
          type: string
          enum: [PENDING, COMMITTING, WORKFLOW_QUEUED]
        message:
          type: string
        workflowUrl:
          type: string
          description: URL to GitHub workflow run (if available)

    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Missing or invalid authentication
    Forbidden:
      description: Insufficient permissions
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  securitySchemes:
    CognitoAuth:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: https://bbws-{env}.auth.{region}.amazoncognito.com/oauth2/authorize
          tokenUrl: https://bbws-{env}.auth.{region}.amazoncognito.com/oauth2/token
          scopes:
            openid: OpenID Connect
            email: Email address
            profile: User profile
```

---

## 22. References

| Document | Path |
|----------|------|
| BRS 2.7 WordPress Instance Management | `BRS/2.7_BRS_WordPress_Instance_Management.md` |
| HLD 2.7 WordPress Instance Management | `HLDs/2.7_HLD_WordPress_Instance_Management.md` |
| HLD 2.0 BBWS ECS WordPress | `HLDs/2.0_BBWS_ECS_WordPress_HLD.md` |
| OpenAPI Spec | `LLDs/openapi/tenant_api_openapi.yaml` |
| Terraform | `2_bbws_ecs_terraform/` |

---

**End of Document**
