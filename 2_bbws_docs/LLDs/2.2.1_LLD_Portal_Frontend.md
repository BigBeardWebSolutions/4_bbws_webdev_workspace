# Portal Frontend - Low-Level Design

**Version**: 1.0
**Created**: 2026-01-20
**Status**: Draft
**Component**: Portal Frontend SPA (`2_2_bbws_portal_private`)
**Parent HLD**: [HLD 2.2 BBWS Customer Portal Private](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md)
**Parent BRS**: [BRS 2.2 Customer Portal Private](../BRS/2.2_BRS_Customer_Portal_Private.md) - All Epics

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-20 | LLD Architect Agent | Initial version covering all frontend components for Epics 1-9 |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [Technology Stack](#2-technology-stack)
3. [Architecture Diagram](#3-architecture-diagram)
4. [Application Structure](#4-application-structure)
5. [Routing & Navigation](#5-routing--navigation)
6. [State Management](#6-state-management)
7. [Component Library](#7-component-library)
8. [Screen Specifications](#8-screen-specifications)
9. [API Integration](#9-api-integration)
10. [Authentication Flow](#10-authentication-flow)
11. [Error Handling](#11-error-handling)
12. [Performance Optimization](#12-performance-optimization)
13. [Testing Strategy](#13-testing-strategy)
14. [Build & Deployment](#14-build--deployment)
15. [Security](#15-security)
16. [Accessibility](#16-accessibility)
17. [Monitoring](#17-monitoring)
18. [NFRs](#18-nfrs)
19. [Risks and Mitigations](#19-risks-and-mitigations)
20. [References](#20-references)

---

## 1. Introduction

### 1.1 Purpose

This LLD provides implementation-level details for the Customer Portal Private frontend application, a React Single Page Application (SPA) that serves as the authenticated customer dashboard for BBWS. This frontend enables customers to manage their WordPress sites, subscriptions, billing, and support tickets.

### 1.2 Scope

| In Scope | Out of Scope |
|----------|--------------|
| Authenticated dashboard (all Epics 1-9) | Public marketing pages (Public Portal) |
| Organisation & Tenant management UI | Admin/staff functionality |
| Site management screens | Backend Lambda implementations |
| Billing & subscription screens | Database schema design |
| Support ticket screens | API contract definitions |
| Protected route handling | Mobile native apps |

### 1.3 Component Overview

| Attribute | Value |
|-----------|-------|
| Repository | `2_2_bbws_portal_private` |
| Technology | React 18, TypeScript, Vite |
| State Management | React Context + React Query |
| Styling | Tailwind CSS + CSS Modules |
| API Client | Axios with interceptors |
| Testing | Vitest, React Testing Library, Playwright |
| Hosting | S3 + CloudFront |

### 1.4 BRS/HLD References

| Reference | Document | Section |
|-----------|----------|---------|
| Epic 1-3 | BRS 2.2 | Authentication flows |
| Epic 4 | BRS 2.2 | Dashboard & Account Management |
| Epic 5 | BRS 2.2 | Organisation & User Management |
| Epic 6 | BRS 2.2 | Tenant Management |
| Epic 7 | BRS 2.2 | Site Management |
| Epic 8 | BRS 2.2 | Billing & Subscriptions |
| Epic 9 | BRS 2.2 | Support Tickets |
| Section 14 | BRS 2.2 | UX/UI Design |

---

## 2. Technology Stack

### 2.1 Production Dependencies

| Library | Version | Purpose |
|---------|---------|---------|
| react | ^18.3.1 | Core UI framework |
| react-dom | ^18.3.1 | React DOM rendering |
| react-router-dom | ^6.22.0 | Client-side routing |
| @tanstack/react-query | ^5.17.0 | Server state management |
| axios | ^1.6.5 | HTTP client |
| tailwindcss | ^3.4.1 | Utility-first CSS |
| @headlessui/react | ^1.7.18 | Accessible UI components |
| @heroicons/react | ^2.1.1 | Icon library |
| react-hook-form | ^7.49.3 | Form management |
| zod | ^3.22.4 | Schema validation |
| date-fns | ^3.2.0 | Date utilities |
| recharts | ^2.10.4 | Dashboard charts |

### 2.2 Development Dependencies

| Library | Version | Purpose |
|---------|---------|---------|
| vite | ^5.4.10 | Build tool and dev server |
| typescript | ^5.9.3 | Type safety |
| vitest | ^4.0.16 | Unit testing framework |
| @testing-library/react | ^16.3.1 | React component testing |
| playwright | ^1.41.0 | E2E testing |
| eslint | ^9.39.2 | Code linting |
| prettier | ^3.7.4 | Code formatting |
| msw | ^2.1.4 | API mocking |

### 2.3 Node.js Requirements

| Requirement | Minimum Version |
|-------------|-----------------|
| Node.js | >= 20.0.0 |
| npm | >= 10.0.0 |

---

## 3. Architecture Diagram

### 3.1 High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        PORTAL FRONTEND ARCHITECTURE                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         BROWSER (Client)                                 │   │
│   │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│   │  │                     React SPA (TypeScript)                       │    │   │
│   │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐│    │   │
│   │  │  │   Auth   │  │  Routes  │  │   State  │  │    Components   ││    │   │
│   │  │  │ Context  │  │  Guards  │  │  (Query) │  │    (UI Kit)     ││    │   │
│   │  │  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘│    │   │
│   │  └─────────────────────────────────────────────────────────────────┘    │   │
│   │                              │ Axios                                     │   │
│   │                              ▼                                           │   │
│   │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│   │  │                    API Client Layer                              │    │   │
│   │  │  - JWT Token Management (localStorage)                           │    │   │
│   │  │  - Request/Response Interceptors                                 │    │   │
│   │  │  - Automatic Token Refresh                                       │    │   │
│   │  │  - Error Handling & Retry                                        │    │   │
│   │  └─────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │ HTTPS                                      │
├────────────────────────────────────┼────────────────────────────────────────────┤
│                                    ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         AWS INFRASTRUCTURE                               │   │
│   │                                                                          │   │
│   │   ┌─────────────┐      ┌─────────────┐      ┌─────────────────────────┐ │   │
│   │   │ CloudFront  │      │     S3      │      │     API Gateway         │ │   │
│   │   │   (CDN)     │◄────►│  (Static)   │      │  + Lambda Authorizer    │ │   │
│   │   └─────────────┘      └─────────────┘      └───────────┬─────────────┘ │   │
│   │                                                         │               │   │
│   │                                                         ▼               │   │
│   │   ┌──────────────────────────────────────────────────────────────────┐  │   │
│   │   │                    Backend Services (Lambda)                      │  │   │
│   │   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐  │  │   │
│   │   │  │   Auth   │ │   Org    │ │  Tenant  │ │  Sites   │ │Billing │  │  │   │
│   │   │  │ Service  │ │ Service  │ │ Service  │ │ Service  │ │Service │  │  │   │
│   │   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └────────┘  │  │   │
│   │   └──────────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Component Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         COMPONENT ARCHITECTURE                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   src/                                                                          │
│   ├── app/                      # Application entry                             │
│   │   ├── App.tsx               # Root component                                │
│   │   ├── routes.tsx            # Route definitions                             │
│   │   └── providers.tsx         # Context providers                             │
│   │                                                                             │
│   ├── features/                 # Feature modules (Epic-aligned)                │
│   │   ├── auth/                 # Epic 3: Authentication                        │
│   │   ├── dashboard/            # Epic 4: Dashboard                             │
│   │   ├── organisations/        # Epic 5: Organisation Management               │
│   │   ├── tenants/              # Epic 6: Tenant Management                     │
│   │   ├── sites/                # Epic 7: Site Management                       │
│   │   ├── billing/              # Epic 8: Billing & Subscriptions               │
│   │   └── support/              # Epic 9: Support Tickets                       │
│   │                                                                             │
│   ├── components/               # Shared UI components                          │
│   │   ├── ui/                   # Base UI kit (Button, Input, Card, etc.)       │
│   │   ├── layout/               # Layout components (Header, Sidebar, etc.)     │
│   │   ├── forms/                # Form components                               │
│   │   └── data-display/         # Tables, Lists, Charts                         │
│   │                                                                             │
│   ├── hooks/                    # Custom React hooks                            │
│   │   ├── useAuth.ts            # Authentication hook                           │
│   │   ├── useTenant.ts          # Tenant context hook                           │
│   │   └── useApi.ts             # API query hooks                               │
│   │                                                                             │
│   ├── services/                 # API service layer                             │
│   │   ├── api.ts                # Axios instance & interceptors                 │
│   │   ├── auth.service.ts       # Auth API calls                                │
│   │   ├── org.service.ts        # Organisation API calls                        │
│   │   └── [feature].service.ts  # Feature-specific API calls                    │
│   │                                                                             │
│   ├── types/                    # TypeScript type definitions                   │
│   │   ├── api.types.ts          # API response types                            │
│   │   ├── domain.types.ts       # Domain entity types                           │
│   │   └── [feature].types.ts    # Feature-specific types                        │
│   │                                                                             │
│   ├── utils/                    # Utility functions                             │
│   │   ├── formatters.ts         # Date, currency, etc.                          │
│   │   ├── validators.ts         # Validation schemas (Zod)                      │
│   │   └── constants.ts          # App constants                                 │
│   │                                                                             │
│   └── styles/                   # Global styles                                 │
│       ├── globals.css           # Global CSS                                    │
│       └── tailwind.config.ts    # Tailwind configuration                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Application Structure

### 4.1 Feature Module Structure

Each feature module follows a consistent structure:

```
features/
└── [feature-name]/
    ├── index.ts                  # Public exports
    ├── routes.tsx                # Feature routes
    ├── components/               # Feature-specific components
    │   ├── [Feature]List.tsx
    │   ├── [Feature]Detail.tsx
    │   ├── [Feature]Form.tsx
    │   └── [Feature]Card.tsx
    ├── hooks/                    # Feature-specific hooks
    │   └── use[Feature].ts
    ├── services/                 # Feature API services
    │   └── [feature].service.ts
    ├── types/                    # Feature type definitions
    │   └── [feature].types.ts
    └── utils/                    # Feature utilities
        └── [feature].utils.ts
```

### 4.2 Epic-to-Feature Mapping

| Epic | Feature Module | Primary Screens |
|------|----------------|-----------------|
| Epic 3 | `features/auth` | Login, Profile, MFA Setup |
| Epic 4 | `features/dashboard` | Dashboard, Account Settings |
| Epic 5 | `features/organisations` | Org Details, Users, Invitations |
| Epic 6 | `features/tenants` | Tenant List, Tenant Details, Tenant Users |
| Epic 7 | `features/sites` | Sites List, Site Details, Migrations, DNS |
| Epic 8 | `features/billing` | Subscriptions, Plans, Invoices, Checkout |
| Epic 9 | `features/support` | Tickets List, Ticket Details, Create Ticket |

---

## 5. Routing & Navigation

### 5.1 Route Structure

```typescript
// src/app/routes.tsx

export const routes = {
  // Public routes (redirect to login if not authenticated)
  public: {
    login: '/login',
    forgotPassword: '/forgot-password',
    resetPassword: '/reset-password',
    acceptInvitation: '/invitation/:token',
  },

  // Protected routes (require authentication)
  protected: {
    // Dashboard (Epic 4)
    dashboard: '/',
    account: '/account',
    mfaSetup: '/account/mfa',

    // Organisation (Epic 5)
    organisation: '/organisation',
    organisationSettings: '/organisation/settings',
    organisationUsers: '/organisation/users',
    inviteUser: '/organisation/users/invite',

    // Tenants (Epic 6)
    tenants: '/tenants',
    tenantDetails: '/tenants/:tenantId',
    tenantUsers: '/tenants/:tenantId/users',
    createTenant: '/tenants/new',

    // Sites (Epic 7)
    sites: '/sites',
    siteDetails: '/sites/:siteId',
    siteEnvironments: '/sites/:siteId/environments',
    siteBackups: '/sites/:siteId/backups',
    createSite: '/sites/new',
    migrations: '/migrations',
    migrationDetails: '/migrations/:migrationId',
    startMigration: '/migrations/new',
    dnsSites: '/dns-sites',
    dnsSiteDetails: '/dns-sites/:siteId',

    // Billing (Epic 8)
    billing: '/billing',
    subscription: '/billing/subscription',
    plans: '/billing/plans',
    paymentHistory: '/billing/history',
    invoiceDetails: '/billing/invoices/:invoiceId',
    checkout: '/billing/checkout',

    // Support (Epic 9)
    support: '/support',
    ticketDetails: '/support/tickets/:ticketId',
    createTicket: '/support/tickets/new',
  },
};
```

### 5.2 Route Guards

```typescript
// src/components/guards/AuthGuard.tsx

interface AuthGuardProps {
  children: React.ReactNode;
  requiredRole?: 'admin' | 'member';
}

export const AuthGuard: React.FC<AuthGuardProps> = ({ children, requiredRole }) => {
  const { isAuthenticated, user, isLoading } = useAuth();
  const location = useLocation();

  if (isLoading) {
    return <LoadingSpinner />;
  }

  if (!isAuthenticated) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  if (requiredRole && user?.role !== requiredRole && user?.role !== 'super_admin') {
    return <Navigate to="/" replace />;
  }

  return <>{children}</>;
};
```

### 5.3 Navigation Menu Structure

```typescript
// src/components/layout/Sidebar.tsx

const navigationItems = [
  {
    name: 'Dashboard',
    href: '/',
    icon: HomeIcon,
    epic: 4,
  },
  {
    name: 'Organisation',
    href: '/organisation',
    icon: BuildingOfficeIcon,
    epic: 5,
    children: [
      { name: 'Overview', href: '/organisation' },
      { name: 'Users', href: '/organisation/users' },
      { name: 'Settings', href: '/organisation/settings' },
    ],
  },
  {
    name: 'Tenants',
    href: '/tenants',
    icon: UsersIcon,
    epic: 6,
  },
  {
    name: 'Sites',
    href: '/sites',
    icon: GlobeAltIcon,
    epic: 7,
    children: [
      { name: 'All Sites', href: '/sites' },
      { name: 'DNS Sites', href: '/dns-sites' },
      { name: 'Migrations', href: '/migrations' },
    ],
  },
  {
    name: 'Billing',
    href: '/billing',
    icon: CreditCardIcon,
    epic: 8,
    children: [
      { name: 'Subscription', href: '/billing/subscription' },
      { name: 'Plans', href: '/billing/plans' },
      { name: 'Payment History', href: '/billing/history' },
    ],
  },
  {
    name: 'Support',
    href: '/support',
    icon: QuestionMarkCircleIcon,
    epic: 9,
  },
];
```

---

## 6. State Management

### 6.1 State Strategy

| State Type | Solution | Use Case |
|------------|----------|----------|
| Server State | React Query | API data, caching, sync |
| Auth State | React Context | User, tokens, session |
| Tenant Context | React Context | Current tenant selection |
| UI State | Component State | Forms, modals, local UI |
| Form State | React Hook Form | Form inputs, validation |

### 6.2 Auth Context

```typescript
// src/contexts/AuthContext.tsx

interface AuthContextType {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  login: (email: string, password: string) => Promise<void>;
  logout: () => Promise<void>;
  refreshToken: () => Promise<void>;
}

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    // Check for existing session on mount
    const initAuth = async () => {
      const token = localStorage.getItem('accessToken');
      if (token) {
        try {
          const userData = await authService.getMe();
          setUser(userData);
        } catch {
          localStorage.removeItem('accessToken');
          localStorage.removeItem('refreshToken');
        }
      }
      setIsLoading(false);
    };
    initAuth();
  }, []);

  const login = async (email: string, password: string) => {
    const response = await authService.login(email, password);
    localStorage.setItem('accessToken', response.accessToken);
    localStorage.setItem('refreshToken', response.refreshToken);
    setUser(response.user);
  };

  const logout = async () => {
    await authService.logout();
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    setUser(null);
  };

  return (
    <AuthContext.Provider value={{ user, isAuthenticated: !!user, isLoading, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
};
```

### 6.3 Tenant Context

```typescript
// src/contexts/TenantContext.tsx

interface TenantContextType {
  currentTenant: Tenant | null;
  tenants: Tenant[];
  switchTenant: (tenantId: string) => void;
  isLoading: boolean;
}

export const TenantProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { user } = useAuth();
  const [currentTenant, setCurrentTenant] = useState<Tenant | null>(null);

  const { data: tenants = [], isLoading } = useQuery({
    queryKey: ['tenants', user?.id],
    queryFn: () => tenantService.getMyTenants(),
    enabled: !!user,
  });

  useEffect(() => {
    // Set default tenant on load
    if (tenants.length > 0 && !currentTenant) {
      const savedTenantId = localStorage.getItem('currentTenantId');
      const defaultTenant = tenants.find(t => t.id === savedTenantId) || tenants[0];
      setCurrentTenant(defaultTenant);
    }
  }, [tenants]);

  const switchTenant = (tenantId: string) => {
    const tenant = tenants.find(t => t.id === tenantId);
    if (tenant) {
      setCurrentTenant(tenant);
      localStorage.setItem('currentTenantId', tenantId);
    }
  };

  return (
    <TenantContext.Provider value={{ currentTenant, tenants, switchTenant, isLoading }}>
      {children}
    </TenantContext.Provider>
  );
};
```

### 6.4 React Query Configuration

```typescript
// src/app/providers.tsx

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 minutes
      gcTime: 30 * 60 * 1000, // 30 minutes (formerly cacheTime)
      retry: 3,
      retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
      refetchOnWindowFocus: false,
    },
    mutations: {
      retry: 1,
    },
  },
});
```

---

## 7. Component Library

### 7.1 Base UI Components

| Component | Props | Description |
|-----------|-------|-------------|
| `Button` | variant, size, loading, disabled | Primary action buttons |
| `Input` | type, error, label, placeholder | Form text inputs |
| `Select` | options, value, onChange | Dropdown select |
| `Checkbox` | checked, label, onChange | Boolean input |
| `Radio` | options, value, onChange | Single selection |
| `TextArea` | rows, maxLength, error | Multi-line text |
| `Modal` | open, onClose, title | Dialog overlay |
| `Toast` | type, message, duration | Notifications |
| `Card` | title, actions, children | Content container |
| `Badge` | variant, children | Status indicators |
| `Spinner` | size | Loading indicator |
| `Avatar` | src, name, size | User avatar |
| `Tabs` | tabs, activeTab, onChange | Tab navigation |
| `Table` | columns, data, pagination | Data table |
| `Pagination` | page, total, onChange | Page navigation |

### 7.2 Layout Components

| Component | Description |
|-----------|-------------|
| `AppLayout` | Main authenticated layout with sidebar |
| `Header` | Top navigation bar with user menu |
| `Sidebar` | Left navigation menu |
| `PageHeader` | Page title with breadcrumbs and actions |
| `ContentArea` | Main content container |
| `EmptyState` | No data placeholder |

### 7.3 Form Components

```typescript
// Example form component with React Hook Form + Zod

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const siteSchema = z.object({
  name: z.string().min(3, 'Name must be at least 3 characters'),
  domain: z.string().regex(/^[a-z0-9-]+$/, 'Invalid domain format'),
  templateId: z.string().uuid('Please select a template'),
});

type SiteFormData = z.infer<typeof siteSchema>;

export const CreateSiteForm: React.FC = () => {
  const { register, handleSubmit, formState: { errors, isSubmitting } } = useForm<SiteFormData>({
    resolver: zodResolver(siteSchema),
  });

  const onSubmit = async (data: SiteFormData) => {
    // Submit logic
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <Input
        label="Site Name"
        error={errors.name?.message}
        {...register('name')}
      />
      <Input
        label="Domain"
        error={errors.domain?.message}
        {...register('domain')}
      />
      <Button type="submit" loading={isSubmitting}>
        Create Site
      </Button>
    </form>
  );
};
```

---

## 8. Screen Specifications

### 8.1 Dashboard (CP-001)

| Attribute | Value |
|-----------|-------|
| Route | `/` |
| Epic | 4 |
| User Story | US 4.1 |

**Components:**
- `DashboardHeader`: Welcome message, quick actions
- `SitesSummaryWidget`: Site count by status, recent sites
- `SubscriptionWidget`: Current plan, usage metrics
- `TicketsWidget`: Open tickets count, recent tickets
- `QuickActionsCard`: Create Site, Get Support, View Billing

**API Calls:**
- `GET /portal/auth/dashboard` - Aggregated dashboard data

### 8.2 Sites List (CP-030)

| Attribute | Value |
|-----------|-------|
| Route | `/sites` |
| Epic | 7 |
| User Story | US 7.2 |

**Components:**
- `SitesHeader`: Title, Create Site button
- `SitesFilter`: Status filter, search
- `SitesTable`: Sortable table with site data
- `SiteRowActions`: View, Manage, Delete

**API Calls:**
- `GET /portal/sites?tenantId={tenantId}` - List sites

### 8.3 Subscription (CP-060)

| Attribute | Value |
|-----------|-------|
| Route | `/billing/subscription` |
| Epic | 8 |
| User Story | US 8.1 |

**Components:**
- `CurrentPlanCard`: Plan name, price, features
- `UsageMetrics`: Sites, storage, bandwidth
- `NextBillingCard`: Next billing date, amount
- `UpgradePrompt`: CTA to upgrade plan

**API Calls:**
- `GET /portal/billing/subscription` - Current subscription

### 8.4 Screen Summary Table

| Screen ID | Name | Route | Epic | User Stories |
|-----------|------|-------|------|--------------|
| CP-001 | Dashboard | `/` | 4 | US 4.1 |
| CP-002 | Account Settings | `/account` | 4 | US 4.2 |
| CP-003 | MFA Setup | `/account/mfa` | 4 | US 4.3 |
| CP-010 | Organisation | `/organisation` | 5 | US 5.1 |
| CP-011 | Organisation Settings | `/organisation/settings` | 5 | US 5.2 |
| CP-012 | Organisation Users | `/organisation/users` | 5 | US 5.4 |
| CP-013 | User Details | `/organisation/users/:id` | 5 | US 5.5-5.7 |
| CP-014 | Invite User | `/organisation/users/invite` | 5 | US 5.3 |
| CP-020 | Tenants | `/tenants` | 6 | US 6.1 |
| CP-021 | Tenant Details | `/tenants/:id` | 6 | US 6.3 |
| CP-022 | Create Tenant | `/tenants/new` | 6 | US 6.2 |
| CP-023 | Tenant Users | `/tenants/:id/users` | 6 | US 6.4 |
| CP-030 | Sites | `/sites` | 7 | US 7.2 |
| CP-031 | Site Details | `/sites/:id` | 7 | US 7.2 |
| CP-032 | Create Site | `/sites/new` | 7 | US 7.1 |
| CP-033 | Site Environments | `/sites/:id/environments` | 7 | US 7.3 |
| CP-034 | Site Backups | `/sites/:id/backups` | 7 | US 7.5-7.6 |
| CP-050 | Migrations | `/migrations` | 7 | US 7.8 |
| CP-051 | Start Migration | `/migrations/new` | 7 | US 7.8-7.10 |
| CP-060 | Subscription | `/billing/subscription` | 8 | US 8.1 |
| CP-061 | Change Plan | `/billing/plans` | 8 | US 8.2-8.3 |
| CP-062 | Payment History | `/billing/history` | 8 | US 8.4 |
| CP-063 | Invoice Details | `/billing/invoices/:id` | 8 | US 8.5 |
| CP-064 | Checkout | `/billing/checkout` | 8 | US 8.6 |
| CP-070 | Support Tickets | `/support` | 9 | US 9.1 |
| CP-071 | Create Ticket | `/support/tickets/new` | 9 | US 9.2 |
| CP-072 | Ticket Details | `/support/tickets/:id` | 9 | US 9.3-9.4 |

---

## 9. API Integration

### 9.1 API Client Configuration

```typescript
// src/services/api.ts

import axios, { AxiosInstance, AxiosError } from 'axios';

const API_BASE_URL = import.meta.env.VITE_API_URL;

export const api: AxiosInstance = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
  timeout: 30000,
});

// Request interceptor - add auth token
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('accessToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }

  // Add tenant header if available
  const tenantId = localStorage.getItem('currentTenantId');
  if (tenantId) {
    config.headers['X-Tenant-ID'] = tenantId;
  }

  return config;
});

// Response interceptor - handle errors, refresh token
api.interceptors.response.use(
  (response) => response,
  async (error: AxiosError) => {
    const originalRequest = error.config;

    // Handle 401 - try token refresh
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;

      try {
        const refreshToken = localStorage.getItem('refreshToken');
        const response = await authService.refreshToken(refreshToken);
        localStorage.setItem('accessToken', response.accessToken);

        originalRequest.headers.Authorization = `Bearer ${response.accessToken}`;
        return api(originalRequest);
      } catch {
        // Refresh failed - logout
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        window.location.href = '/login';
      }
    }

    return Promise.reject(error);
  }
);
```

### 9.2 Service Layer Pattern

```typescript
// src/services/site.service.ts

import { api } from './api';
import { Site, CreateSiteRequest, SiteListResponse } from '@/types';

export const siteService = {
  list: async (tenantId: string, params?: { status?: string; page?: number }) => {
    const response = await api.get<SiteListResponse>('/portal/sites', {
      params: { tenantId, ...params },
    });
    return response.data;
  },

  get: async (siteId: string) => {
    const response = await api.get<Site>(`/portal/sites/${siteId}`);
    return response.data;
  },

  create: async (data: CreateSiteRequest) => {
    const response = await api.post<Site>('/portal/sites', data);
    return response.data;
  },

  promote: async (siteId: string, targetEnv: 'sit' | 'prod') => {
    const response = await api.post(`/portal/sites/${siteId}/promote`, { targetEnv });
    return response.data;
  },

  createBackup: async (siteId: string) => {
    const response = await api.post(`/portal/sites/${siteId}/backups`);
    return response.data;
  },
};
```

### 9.3 React Query Hooks

```typescript
// src/features/sites/hooks/useSites.ts

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { siteService } from '@/services/site.service';
import { useTenant } from '@/hooks/useTenant';

export const useSites = (params?: { status?: string }) => {
  const { currentTenant } = useTenant();

  return useQuery({
    queryKey: ['sites', currentTenant?.id, params],
    queryFn: () => siteService.list(currentTenant!.id, params),
    enabled: !!currentTenant,
  });
};

export const useCreateSite = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: siteService.create,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['sites'] });
    },
  });
};
```

---

## 10. Authentication Flow

### 10.1 Login Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              LOGIN FLOW                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   User                    Frontend                    Auth API        Cognito   │
│    │                         │                           │               │      │
│    │  1. Enter credentials   │                           │               │      │
│    │─────────────────────────>                           │               │      │
│    │                         │  2. POST /auth/login      │               │      │
│    │                         │────────────────────────────>              │      │
│    │                         │                           │  3. InitiateAuth     │
│    │                         │                           │───────────────>      │
│    │                         │                           │  4. Tokens    │      │
│    │                         │                           │<───────────────      │
│    │                         │  5. { tokens, user }      │               │      │
│    │                         │<────────────────────────────              │      │
│    │                         │                           │               │      │
│    │  6. Store tokens        │                           │               │      │
│    │  7. Set auth context    │                           │               │      │
│    │  8. Redirect to /       │                           │               │      │
│    │<─────────────────────────                           │               │      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 10.2 Token Refresh Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           TOKEN REFRESH FLOW                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   API Interceptor            Auth API               Cognito                     │
│         │                       │                      │                        │
│   1. 401 Response               │                      │                        │
│   2. Check _retry flag          │                      │                        │
│         │  3. POST /auth/refresh │                      │                        │
│         │────────────────────────>                      │                        │
│         │                       │  4. InitiateAuth      │                        │
│         │                       │       (REFRESH_TOKEN) │                        │
│         │                       │───────────────────────>                        │
│         │                       │  5. New tokens        │                        │
│         │                       │<───────────────────────                        │
│         │  6. { accessToken }   │                      │                        │
│         │<────────────────────────                      │                        │
│   7. Update localStorage        │                      │                        │
│   8. Retry original request     │                      │                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 11. Error Handling

### 11.1 Error Boundary

```typescript
// src/components/ErrorBoundary.tsx

import { Component, ErrorInfo, ReactNode } from 'react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends Component<Props, State> {
  state: State = { hasError: false, error: null };

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('Error caught by boundary:', error, errorInfo);
    // Send to monitoring (e.g., Sentry)
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || <ErrorPage error={this.state.error} />;
    }
    return this.props.children;
  }
}
```

### 11.2 API Error Handling

```typescript
// src/utils/errors.ts

export interface ApiError {
  code: string;
  message: string;
  details?: Record<string, string[]>;
}

export const handleApiError = (error: AxiosError<ApiError>): string => {
  if (error.response?.data?.message) {
    return error.response.data.message;
  }

  switch (error.response?.status) {
    case 400: return 'Invalid request. Please check your input.';
    case 401: return 'Your session has expired. Please log in again.';
    case 403: return 'You don\'t have permission to perform this action.';
    case 404: return 'The requested resource was not found.';
    case 429: return 'Too many requests. Please try again later.';
    case 500: return 'An unexpected error occurred. Please try again.';
    default: return 'Something went wrong. Please try again.';
  }
};
```

### 11.3 Toast Notifications

```typescript
// src/hooks/useToast.ts

export const useToast = () => {
  const [toasts, setToasts] = useState<Toast[]>([]);

  const showToast = (type: 'success' | 'error' | 'warning' | 'info', message: string) => {
    const id = Date.now();
    setToasts(prev => [...prev, { id, type, message }]);
    setTimeout(() => removeToast(id), 5000);
  };

  return { toasts, showToast, showError: (m) => showToast('error', m) };
};
```

---

## 12. Performance Optimization

### 12.1 Code Splitting

```typescript
// src/app/routes.tsx

import { lazy, Suspense } from 'react';

// Lazy load feature modules
const Dashboard = lazy(() => import('@/features/dashboard'));
const Sites = lazy(() => import('@/features/sites'));
const Billing = lazy(() => import('@/features/billing'));
const Support = lazy(() => import('@/features/support'));

export const AppRoutes = () => (
  <Suspense fallback={<PageLoader />}>
    <Routes>
      <Route path="/" element={<Dashboard />} />
      <Route path="/sites/*" element={<Sites />} />
      <Route path="/billing/*" element={<Billing />} />
      <Route path="/support/*" element={<Support />} />
    </Routes>
  </Suspense>
);
```

### 12.2 Caching Strategy

| Data Type | Cache Time | Refetch On |
|-----------|------------|------------|
| User profile | 30 min | Login, profile update |
| Tenant list | 10 min | Tenant CRUD |
| Sites list | 5 min | Site CRUD, tab focus |
| Dashboard | 2 min | Page visit |
| Subscription | 10 min | Payment completion |

### 12.3 Image Optimization

- Use WebP format with JPEG fallback
- Lazy load images below fold
- Use srcset for responsive images
- Compress and resize on upload (S3)

---

## 13. Testing Strategy

### 13.1 Unit Tests (Vitest)

```typescript
// src/features/sites/components/__tests__/SiteCard.test.tsx

import { render, screen } from '@testing-library/react';
import { SiteCard } from '../SiteCard';

describe('SiteCard', () => {
  const mockSite = {
    id: 'site-1',
    name: 'My Site',
    domain: 'mysite.com',
    status: 'active',
  };

  it('renders site name and domain', () => {
    render(<SiteCard site={mockSite} />);
    expect(screen.getByText('My Site')).toBeInTheDocument();
    expect(screen.getByText('mysite.com')).toBeInTheDocument();
  });

  it('shows active status badge', () => {
    render(<SiteCard site={mockSite} />);
    expect(screen.getByText('Active')).toHaveClass('bg-green-100');
  });
});
```

### 13.2 Integration Tests (MSW)

```typescript
// src/features/sites/__tests__/sites.integration.test.tsx

import { setupServer } from 'msw/node';
import { rest } from 'msw';

const server = setupServer(
  rest.get('/portal/sites', (req, res, ctx) => {
    return res(ctx.json({ sites: [mockSite], total: 1 }));
  })
);

describe('Sites Page', () => {
  beforeAll(() => server.listen());
  afterEach(() => server.resetHandlers());
  afterAll(() => server.close());

  it('displays sites list', async () => {
    render(<SitesPage />, { wrapper: TestProviders });
    expect(await screen.findByText('My Site')).toBeInTheDocument();
  });
});
```

### 13.3 E2E Tests (Playwright)

```typescript
// e2e/sites.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Site Management', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login');
    await page.fill('[name="email"]', 'test@example.com');
    await page.fill('[name="password"]', 'Password123!');
    await page.click('button[type="submit"]');
    await page.waitForURL('/');
  });

  test('can create a new site', async ({ page }) => {
    await page.goto('/sites/new');
    await page.fill('[name="name"]', 'Test Site');
    await page.fill('[name="domain"]', 'testsite');
    await page.click('button:has-text("Create Site")');
    await expect(page).toHaveURL(/\/sites\/[a-z0-9-]+/);
  });
});
```

---

## 14. Build & Deployment

### 14.1 Environment Configuration

```typescript
// .env.example

VITE_API_URL=https://dev.portal-api.kimmyai.io/v1.0
VITE_COGNITO_USER_POOL_ID=eu-west-1_xxxxxxxxx
VITE_COGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxx
VITE_ENVIRONMENT=dev
```

### 14.2 Build Commands

```json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "build:dev": "vite build --mode development",
    "build:sit": "vite build --mode staging",
    "build:prod": "vite build --mode production",
    "preview": "vite preview",
    "test": "vitest",
    "test:coverage": "vitest --coverage",
    "e2e": "playwright test",
    "lint": "eslint src --ext ts,tsx",
    "format": "prettier --write src"
  }
}
```

### 14.3 CI/CD Pipeline

```yaml
# .github/workflows/deploy.yml

name: Deploy Portal Frontend

on:
  push:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint
      - run: npm run test:coverage
      - run: npm run build

  deploy-dev:
    needs: test
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: npm run build:dev
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: af-south-1
      - run: aws s3 sync dist/ s3://${{ secrets.S3_BUCKET }} --delete
      - run: aws cloudfront create-invalidation --distribution-id ${{ secrets.CF_DIST_ID }} --paths "/*"
```

---

## 15. Security

### 15.1 Security Measures

| Measure | Implementation |
|---------|----------------|
| XSS Prevention | React auto-escaping, CSP headers |
| CSRF Protection | SameSite cookies, token validation |
| Token Storage | localStorage with short TTL |
| API Security | HTTPS only, JWT validation |
| Input Validation | Zod schemas, server-side validation |
| Sensitive Data | Never log tokens, mask PII |

### 15.2 Content Security Policy

```
Content-Security-Policy:
  default-src 'self';
  script-src 'self' 'unsafe-inline';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https:;
  connect-src 'self' https://*.kimmyai.io;
  font-src 'self';
  frame-ancestors 'none';
```

---

## 16. Accessibility

### 16.1 WCAG 2.1 AA Compliance

| Requirement | Implementation |
|-------------|----------------|
| Keyboard Navigation | All interactive elements focusable |
| Screen Readers | ARIA labels, semantic HTML |
| Color Contrast | Minimum 4.5:1 ratio |
| Focus Indicators | Visible focus rings |
| Error Identification | Accessible form errors |
| Skip Links | Skip to main content |

---

## 17. Monitoring

### 17.1 Error Tracking

- **Tool**: Sentry
- **Events**: JavaScript errors, failed API calls
- **Context**: User ID, tenant ID, route

### 17.2 Performance Monitoring

- **Core Web Vitals**: LCP, FID, CLS
- **Custom Metrics**: Time to interactive, API latency
- **Tool**: CloudWatch RUM

---

## 18. NFRs

| NFR | Target | Measurement |
|-----|--------|-------------|
| Page Load | < 2s | Lighthouse |
| First Contentful Paint | < 1.5s | Core Web Vitals |
| Time to Interactive | < 3s | Lighthouse |
| Bundle Size | < 500KB gzipped | Build output |
| API Response Time | < 500ms | CloudWatch |
| Availability | 99.9% | CloudWatch |
| Browser Support | Last 2 versions | BrowserStack |

---

## 19. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Large bundle size | Slow load times | Code splitting, lazy loading |
| API failures | Poor UX | Retry logic, error boundaries, offline indicators |
| Token expiry during use | Session loss | Automatic refresh, graceful logout |
| State inconsistency | Data errors | React Query cache invalidation |
| Accessibility issues | Legal risk | Automated a11y testing in CI |

---

## 20. References

| Document | Description |
|----------|-------------|
| [HLD 2.2](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md) | Parent High-Level Design |
| [BRS 2.2](../BRS/2.2_BRS_Customer_Portal_Private.md) | Business Requirements |
| [2.2.2_LLD_Portal_Auth](./2.2.2_LLD_Portal_Auth.md) | Auth Service LLD |
| [2.2.3_LLD_Portal_Organisation](./2.2.3_LLD_Portal_Organisation.md) | Organisation Service LLD |
| [2.2.5_LLD_Portal_Billing](./2.2.5_LLD_Portal_Billing.md) | Billing Service LLD |
| [2.1.1_LLD_Frontend_Architecture](./2.1.1_LLD_Frontend_Architecture.md) | Public Portal Frontend (reference) |

---

## Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Tech Lead | | | |
| Frontend Lead | | | |
| UX Designer | | | |
| QA Lead | | | |
