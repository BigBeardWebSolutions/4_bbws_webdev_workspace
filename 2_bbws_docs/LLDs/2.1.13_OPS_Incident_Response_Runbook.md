# CPP Disaster Recovery Runbook

**Version**: 1.0
**Created**: 2025-12-15
**Status**: Draft
**Component**: Customer Portal Public - Disaster Recovery
**Parent HLD**: [BBWS Customer Portal Public HLD](../BBWS_Customer_Portal_Public_HLD.md)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | Agentic Architect | Initial version |

---

## 1. Overview

### 1.1 Purpose

This runbook provides procedures for disaster recovery operations for the Customer Portal Public (CPP) application, including failover to the DR region and failback procedures.

### 1.2 DR Strategy

**Strategy**: Multi-Site Active/Passive

| Aspect | Configuration |
|--------|---------------|
| Primary Region | af-south-1 (Cape Town, South Africa) |
| DR Region | eu-west-1 (Ireland) |
| RTO | 15 minutes |
| RPO | 1 hour |
| Failover Type | Route 53 DNS Failover |

### 1.3 Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                          Route 53                                    │
│                     (Health Check + Failover)                        │
└─────────────────────┬───────────────────────┬───────────────────────┘
                      │                       │
                      ▼                       ▼
        ┌─────────────────────┐   ┌─────────────────────┐
        │   af-south-1        │   │    eu-west-1        │
        │   (PRIMARY)         │   │    (DR/PASSIVE)     │
        │                     │   │                     │
        │  ┌───────────────┐  │   │  ┌───────────────┐  │
        │  │  CloudFront   │  │   │  │  CloudFront   │  │
        │  └───────────────┘  │   │  └───────────────┘  │
        │  ┌───────────────┐  │   │  ┌───────────────┐  │
        │  │  API Gateway  │  │   │  │  API Gateway  │  │
        │  └───────────────┘  │   │  └───────────────┘  │
        │  ┌───────────────┐  │   │  ┌───────────────┐  │
        │  │   Lambdas     │  │   │  │   Lambdas     │  │
        │  └───────────────┘  │   │  └───────────────┘  │
        │  ┌───────────────┐  │   │  ┌───────────────┐  │
        │  │   DynamoDB    │◄─┼───┼──│   DynamoDB    │  │
        │  │ Global Tables │  │   │  │ Global Tables │  │
        │  └───────────────┘  │   │  └───────────────┘  │
        │  ┌───────────────┐  │   │  ┌───────────────┐  │
        │  │      S3       │◄─┼───┼──│      S3       │  │
        │  │  (Replicated) │  │   │  │  (Replicated) │  │
        │  └───────────────┘  │   │  └───────────────┘  │
        └─────────────────────┘   └─────────────────────┘
                      │                       │
                      └───────────────────────┘
                         Cross-Region Replication
```

---

## 2. Replication Configuration

### 2.1 DynamoDB Global Tables

| Table | Primary Region | DR Region | Replication |
|-------|----------------|-----------|-------------|
| bbws-tenants | af-south-1 | eu-west-1 | Global Table |
| bbws-carts | af-south-1 | eu-west-1 | Global Table |
| bbws-orders | af-south-1 | eu-west-1 | Global Table |
| bbws-payments | af-south-1 | eu-west-1 | Global Table |
| bbws-products | af-south-1 | eu-west-1 | Global Table |
| bbws-campaigns | af-south-1 | eu-west-1 | Global Table |

### 2.2 S3 Cross-Region Replication

| Bucket | Primary | DR | Replication Rule |
|--------|---------|-----|------------------|
| bbws-prod-frontend | af-south-1 | eu-west-1 | All objects |
| bbws-prod-assets | af-south-1 | eu-west-1 | All objects |

### 2.3 DynamoDB Backup Schedule

| Backup Type | Frequency | Retention |
|-------------|-----------|-----------|
| Point-in-time recovery | Continuous | 35 days |
| On-demand backup | Hourly | 30 days |
| Cross-region copy | Hourly | 7 days |

---

## 3. Health Check Configuration

### 3.1 Route 53 Health Checks

```yaml
PrimaryHealthCheck:
  Type: AWS::Route53::HealthCheck
  Properties:
    HealthCheckConfig:
      Type: HTTPS
      FullyQualifiedDomainName: api.bigbeard.co.za
      Port: 443
      ResourcePath: /v1.0/health
      RequestInterval: 30
      FailureThreshold: 3
      EnableSNI: true
      Regions:
        - eu-west-1
        - us-east-1
        - ap-southeast-1

DRHealthCheck:
  Type: AWS::Route53::HealthCheck
  Properties:
    HealthCheckConfig:
      Type: HTTPS
      FullyQualifiedDomainName: api-dr.bigbeard.co.za
      Port: 443
      ResourcePath: /v1.0/health
      RequestInterval: 30
      FailureThreshold: 3
```

### 3.2 Failover DNS Records

```yaml
PrimaryRecord:
  Type: AWS::Route53::RecordSet
  Properties:
    Name: api.bigbeard.co.za
    Type: A
    SetIdentifier: primary
    Failover: PRIMARY
    HealthCheckId: !Ref PrimaryHealthCheck
    AliasTarget:
      DNSName: !GetAtt PrimaryApiGateway.RegionalDomainName
      HostedZoneId: !GetAtt PrimaryApiGateway.RegionalHostedZoneId

DRRecord:
  Type: AWS::Route53::RecordSet
  Properties:
    Name: api.bigbeard.co.za
    Type: A
    SetIdentifier: secondary
    Failover: SECONDARY
    HealthCheckId: !Ref DRHealthCheck
    AliasTarget:
      DNSName: !GetAtt DRApiGateway.RegionalDomainName
      HostedZoneId: !GetAtt DRApiGateway.RegionalHostedZoneId
```

---

## 4. Failover Procedures

### 4.1 Automatic Failover

Route 53 will automatically failover when:
- Primary health check fails 3 consecutive times (90 seconds)
- DNS TTL expires (60 seconds)

**Total automatic failover time: ~3-5 minutes**

### 4.2 Manual Failover Procedure

**When to use**: Planned maintenance, proactive failover before expected issues

#### Step 1: Verify DR Region Health

```bash
# Set DR region
export AWS_REGION=eu-west-1

# Check Lambda functions
aws lambda list-functions --query 'Functions[?starts_with(FunctionName, `bbws-prod`)]'

# Check API Gateway
aws apigateway get-rest-apis --query 'items[?name==`bbws-prod-api`]'

# Test DR endpoint directly
curl -s https://api-dr.bigbeard.co.za/v1.0/health
```

#### Step 2: Verify Data Replication

```bash
# Check DynamoDB Global Table status
aws dynamodb describe-table \
  --table-name bbws-orders \
  --query 'Table.Replicas'

# Verify recent data in DR
aws dynamodb scan \
  --table-name bbws-orders \
  --limit 5 \
  --region eu-west-1
```

#### Step 3: Update Route 53 Weights

```bash
# Get hosted zone ID
HOSTED_ZONE_ID=$(aws route53 list-hosted-zones \
  --query 'HostedZones[?Name==`bigbeard.co.za.`].Id' \
  --output text)

# Disable primary (set weight to 0)
aws route53 change-resource-record-sets \
  --hosted-zone-id $HOSTED_ZONE_ID \
  --change-batch '{
    "Changes": [{
      "Action": "UPSERT",
      "ResourceRecordSet": {
        "Name": "api.bigbeard.co.za",
        "Type": "A",
        "SetIdentifier": "primary",
        "Failover": "PRIMARY",
        "HealthCheckId": "<health-check-id>",
        "AliasTarget": {
          "DNSName": "<api-gw-domain>",
          "HostedZoneId": "<api-gw-zone>",
          "EvaluateTargetHealth": false
        }
      }
    }]
  }'
```

#### Step 4: Verify Failover

```bash
# Check DNS resolution
dig api.bigbeard.co.za

# Test API endpoint
curl -s https://api.bigbeard.co.za/v1.0/health

# Verify requests going to DR
aws logs tail /aws/lambda/bbws-prod-auth --region eu-west-1 --follow
```

#### Step 5: Notify Stakeholders

```bash
# Send notification
aws sns publish \
  --topic-arn arn:aws:sns:eu-west-1:123456789012:bbws-prod-alerts \
  --subject "BBWS CPP: Manual Failover to DR Region" \
  --message "Manual failover initiated to eu-west-1 at $(date). Primary region: af-south-1 is offline."
```

---

## 5. Failback Procedures

### 5.1 Pre-Failback Checklist

- [ ] Primary region issue resolved
- [ ] Primary region health checks passing
- [ ] DynamoDB replication caught up
- [ ] S3 replication complete
- [ ] All Lambda functions deployed in primary
- [ ] Tech Lead approval obtained
- [ ] Maintenance window scheduled

### 5.2 Failback Steps

#### Step 1: Verify Primary Region

```bash
export AWS_REGION=af-south-1

# Check all services
./scripts/verify-deployment.sh prod

# Test primary endpoint directly
curl -s https://api-primary.bigbeard.co.za/v1.0/health
```

#### Step 2: Sync Any DR-Only Data

```bash
# Check for any data written only to DR during failover
aws dynamodb scan \
  --table-name bbws-orders \
  --filter-expression "createdAt > :failover_time" \
  --expression-attribute-values '{":failover_time": {"S": "2025-12-15T00:00:00Z"}}' \
  --region eu-west-1

# Global Tables should auto-replicate, but verify
```

#### Step 3: Gradual Traffic Shift

```bash
# Enable primary with weighted routing (start with 10%)
# Gradually increase: 10% -> 25% -> 50% -> 100%

# Monitor error rates during shift
watch -n 5 'aws cloudwatch get-metric-statistics \
  --namespace AWS/ApiGateway \
  --metric-name 5XXError \
  --dimensions Name=ApiName,Value=bbws-prod-api \
  --start-time $(date -u -d "5 minutes ago" +%Y-%m-%dT%H:%M:%SZ) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
  --period 60 \
  --statistics Sum'
```

#### Step 4: Complete Failback

```bash
# Restore primary as PRIMARY failover record
# Restore DR as SECONDARY failover record

# Verify DNS
dig api.bigbeard.co.za
```

#### Step 5: Post-Failback Verification

```bash
# Run full health check suite
./scripts/full-health-check.sh prod

# Verify all Lambda functions
./scripts/verify-lambdas.sh prod af-south-1

# Check error rates (should be baseline)
```

---

## 6. DR Testing Procedures

### 6.1 Quarterly DR Test

| Test | Frequency | Duration | Impact |
|------|-----------|----------|--------|
| Health Check Verification | Weekly | 5 min | None |
| Replication Verification | Daily | 10 min | None |
| Failover Drill | Quarterly | 2 hours | Planned maintenance |
| Full DR Test | Annually | 4 hours | Planned maintenance |

### 6.2 DR Test Checklist

- [ ] Schedule maintenance window
- [ ] Notify stakeholders
- [ ] Document start time
- [ ] Execute failover
- [ ] Verify all endpoints functional
- [ ] Test critical user journeys
- [ ] Measure actual RTO
- [ ] Execute failback
- [ ] Document end time and findings
- [ ] Update runbook with lessons learned

### 6.3 Critical User Journeys to Test

| Journey | Steps | Expected Result |
|---------|-------|-----------------|
| Product Browse | GET /products | Products listed |
| Add to Cart | POST /cart/items | Item added |
| Checkout | POST /orders | Order created |
| Payment | POST /payments | Redirect to PayFast |
| Registration | POST /auth/register | User created |

---

## 7. Communication Plan

### 7.1 Stakeholder Notification

| Stakeholder | Notification Method | Timing |
|-------------|---------------------|--------|
| DevOps Team | Slack + SMS | Immediate |
| Tech Lead | SMS + Phone | Immediate |
| Business Owner | Email | Within 15 min |
| Customers | Status page | Within 30 min |

### 7.2 Status Page Updates

```bash
# Update status page
curl -X POST https://api.statuspage.io/v1/pages/PAGE_ID/incidents \
  -H "Authorization: OAuth $STATUSPAGE_TOKEN" \
  -d '{
    "incident": {
      "name": "Service Degradation - Failover in Progress",
      "status": "investigating",
      "body": "We are experiencing issues with our primary region and are failing over to our DR site. Service may be briefly interrupted."
    }
  }'
```

---

## 8. Recovery Metrics

### 8.1 RTO/RPO Targets

| Metric | Target | Measurement |
|--------|--------|-------------|
| RTO (Recovery Time Objective) | 15 minutes | Time from failure detection to service restoration |
| RPO (Recovery Point Objective) | 1 hour | Maximum data loss window |

### 8.2 Monitoring During DR Event

```bash
# Monitor replication lag
aws cloudwatch get-metric-statistics \
  --namespace AWS/DynamoDB \
  --metric-name ReplicationLatency \
  --dimensions Name=TableName,Value=bbws-orders \
  --start-time $(date -u -d "1 hour ago" +%Y-%m-%dT%H:%M:%SZ) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
  --period 60 \
  --statistics Average
```

---

## 9. Contacts

| Role | Name | Phone | Email |
|------|------|-------|-------|
| DevOps Lead | TBD | TBD | TBD |
| On-Call Primary | TBD | TBD | TBD |
| AWS TAM | TBD | TBD | TBD |
| Business Owner | TBD | TBD | TBD |

---

## 10. Appendix

### 10.1 Region-Specific Resources

| Resource | af-south-1 | eu-west-1 |
|----------|------------|-----------|
| API Gateway | bbws-prod-api | bbws-prod-api-dr |
| CloudFront | E1234567890ABC | E0987654321XYZ |
| S3 Frontend | bbws-prod-frontend | bbws-prod-frontend-dr |
| DynamoDB | bbws-* (Global Tables) | bbws-* (Global Tables) |

### 10.2 Emergency Contacts

| Service | Contact |
|---------|---------|
| AWS Support | Enterprise Support Portal |
| PayFast | support@payfast.co.za |
| Domain Registrar | TBD |

---

## 11. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| DevOps Lead | | | |
| Tech Lead | | | |
| Business Owner | | | |

---

**End of Document**
