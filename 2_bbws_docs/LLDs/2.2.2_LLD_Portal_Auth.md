# Portal Auth Service - Low-Level Design

**Version**: 1.0
**Created**: 2026-01-20
**Status**: Draft
**Component**: Portal Auth Service (`2_2_bbws_portal_svc_auth`)
**Parent HLD**: [HLD 2.2 BBWS Customer Portal Private](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md)
**Parent BRS**: [BRS 2.2 Customer Portal Private](../BRS/2.2_BRS_Customer_Portal_Private.md) - Epic 3 & 4

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-20 | LLD Architect Agent | Initial version covering Epic 3 (Authentication) and Epic 4 (Dashboard & Account Management) |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [High Level Epic Overview](#2-high-level-epic-overview)
3. [Architecture Diagram](#3-architecture-diagram)
4. [API Design](#4-api-design)
5. [Lambda Functions](#5-lambda-functions)
6. [Sequence Diagrams](#6-sequence-diagrams)
7. [Data Models](#7-data-models)
8. [Security](#8-security)
9. [Error Handling](#9-error-handling)
10. [Monitoring and Alerting](#10-monitoring-and-alerting)
11. [NFRs](#11-nfrs)
12. [Troubleshooting Playbook](#12-troubleshooting-playbook)
13. [Tagging](#13-tagging)
14. [Risks and Mitigations](#14-risks-and-mitigations)
15. [TBC](#15-tbc)
16. [Definition of Terms](#16-definition-of-terms)
17. [Appendices](#17-appendices)
18. [References](#18-references)
19. [Signoff](#19-signoff)

---

## 1. Introduction

### 1.1 Purpose

This LLD provides implementation-level details for the Portal Auth Service, which handles authenticated user operations within the Customer Portal Private application. This includes profile management, MFA configuration, session management, and dashboard data aggregation for authenticated customers.

> **Note**: This LLD covers **authenticated** portal operations (Epic 3 & 4). Public authentication operations (registration, login, password reset) are covered in [2.1.2_LLD_Auth_Lambda.md](./2.1.2_LLD_Auth_Lambda.md).

### 1.2 Scope

| In Scope | Out of Scope |
|----------|--------------|
| Profile viewing and updating | User registration (see 2.1.2_LLD_Auth_Lambda) |
| MFA enable/verify/disable | Login flow (see 2.1.2_LLD_Auth_Lambda) |
| Session management (logout) | Password reset (see 2.1.2_LLD_Auth_Lambda) |
| Dashboard data aggregation | Organisation management (see 2.2.3_LLD_Portal_Organisation) |
| Account settings management | Tenant management (see 2.5_LLD_Tenant_Management) |

### 1.3 Component Overview

| Attribute | Value |
|-----------|-------|
| Repository | `2_2_bbws_portal_svc_auth` |
| Runtime | Python 3.12 |
| Memory | 256MB (default), 512MB (dashboard) |
| Timeout | 30s |
| Architecture | arm64 |
| API Prefix | `/portal/auth/*` |
| Authentication | Required (Cognito JWT) |

### 1.4 BRS/HLD References

| Reference | Document | Section |
|-----------|----------|---------|
| Epic 3 | BRS 2.2 | Customer Authentication & Password Recovery |
| Epic 4 | BRS 2.2 | Dashboard & Account Management |
| US 3.8 | BRS 2.2 | View My Profile |
| US 3.9 | BRS 2.2 | Update My Profile |
| US 3.10 | BRS 2.2 | Enable MFA |
| US 3.11 | BRS 2.2 | Logout Securely |
| US 4.1 | BRS 2.2 | View Dashboard |
| US 4.2 | BRS 2.2 | Update Account Settings |
| US 4.3 | BRS 2.2 | Setup MFA |
| BR-001 to BR-026 | BRS 2.2 | Business Rules |

### 1.5 Dependencies

| Dependency | Purpose |
|------------|---------|
| AWS Cognito | User pool, MFA management, token operations |
| AWS DynamoDB | User profile data, session tracking |
| AWS SES | Security notification emails |
| AWS Secrets Manager | Cognito credentials, JWT secret |
| Lambda Authorizer | JWT validation, tenant isolation |

---

## 2. High Level Epic Overview

### 2.1 Epic 3: Customer Authentication & Password Recovery (Partial)

| User Story # | User Story | Lambda Function | Test Scenario(s) |
|--------------|------------|-----------------|------------------|
| US 3.8 | View My Profile | `get_me` | Given valid JWT, then profile data returned |
| US 3.9 | Update My Profile | `update_me` | Given valid data, then profile updated and audit logged |
| US 3.10 | Enable MFA | `enable_mfa`, `verify_mfa` | Given valid TOTP code, then MFA enabled |
| US 3.11 | Logout Securely | `logout` | Given active session, then token invalidated |

### 2.2 Epic 4: Dashboard & Account Management

| User Story # | User Story | Lambda Function | Test Scenario(s) |
|--------------|------------|-----------------|------------------|
| US 4.1 | View Dashboard | `get_dashboard` | Given valid JWT, then aggregated data returned |
| US 4.2 | Update Account Settings | `update_me` | Given valid preferences, then settings updated |
| US 4.3 | Setup MFA | `enable_mfa`, `disable_mfa` | Given valid code, then MFA state changed |

### 2.3 Business Rules Coverage

| Rule ID | Rule | Implementation |
|---------|------|----------------|
| BR-001 | Users must authenticate before accessing portal | Lambda Authorizer validates JWT |
| BR-004 | MFA can be enforced at organisation level | Check `org.mfa_required` before disable |
| BR-019 | Sessions expire after 30 minutes of inactivity | Token TTL check, refresh token logic |
| BR-020 | Refresh tokens valid for 7 days | Cognito configuration |
| BR-021 | Logout invalidates all active tokens | GlobalSignOut API call |
| BR-022 | Concurrent sessions allowed (max 5 devices) | Track sessions in DynamoDB |
| BR-023 | Password change invalidates all other sessions | GlobalSignOut on password change |
| BR-024 | Users can only access data belonging to their assigned tenants | Lambda Authorizer enforces |
| BR-026 | Audit logs are created for all data access operations | CloudWatch structured logging |

---

## 3. Architecture Diagram

### 3.1 Component Architecture

```
                                    PORTAL AUTH SERVICE ARCHITECTURE
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  +---------+          +----------------+          +------------------+                           |
|  | React   |  HTTPS   |   API Gateway  |          |  Lambda          |                          |
|  | SPA     |--------->|   (REST)       |--------->|  Authorizer      |                          |
|  | (S3/CF) |          |                |          |  (JWT Validate)  |                          |
|  +---------+          +-------+--------+          +--------+---------+                          |
|                               |                            |                                     |
|                               | (Authenticated)            | (IAM Policy)                        |
|                               v                            v                                     |
|                       +-------+--------------------------------+                                 |
|                       |            PORTAL AUTH LAMBDAS         |                                 |
|                       |  +----------+ +----------+ +----------+|                                 |
|                       |  | get_me   | |update_me | |enable_mfa||                                 |
|                       |  +----------+ +----------+ +----------+|                                 |
|                       |  +----------+ +----------+ +----------+|                                 |
|                       |  |verify_mfa| |disable_mfa| |  logout  ||                                |
|                       |  +----------+ +----------+ +----------+|                                 |
|                       |  +------------+                        |                                 |
|                       |  |get_dashboard|                       |                                 |
|                       |  +------------+                        |                                 |
|                       +---+----------+----------+--------------+                                 |
|                           |          |          |                                                |
|              +------------+          |          +------------+                                   |
|              |                       |                       |                                   |
|              v                       v                       v                                   |
|  +-----------------+     +-----------------+     +-----------------+                             |
|  |    Cognito      |     |    DynamoDB     |     |      SES        |                            |
|  |  (Customer Pool)|     |  (Single Table) |     | (Notifications) |                            |
|  |                 |     |                 |     |                 |                            |
|  | - MFA TOTP      |     | - USER entity   |     | - MFA enabled   |                            |
|  | - Token mgmt    |     | - SESSION entity|     | - Profile change|                            |
|  | - Global signout|     | - AUDIT entity  |     | - Security alert|                            |
|  +-----------------+     +-----------------+     +-----------------+                             |
|                                   |                                                              |
|                                   v                                                              |
|                          +----------------+                                                      |
|                          | Dashboard APIs |                                                      |
|                          | (Parallel Call)|                                                      |
|                          |                |                                                      |
|                          | - Tenant Svc   |                                                      |
|                          | - Site Svc     |                                                      |
|                          | - Billing Svc  |                                                      |
|                          | - Ticket Svc   |                                                      |
|                          +----------------+                                                      |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+

LEGEND:
+------+  Component/Service
------->  Data Flow
   |      Dependency
```

### 3.2 Class Diagram

```
+--------------------------------------------------------------------------------------------------+
|                                  CLASS STRUCTURE                                                  |
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  +------------------------+           +------------------------+                                 |
|  |    PortalAuthHandler   |           |    ResponseBuilder     |                                 |
|  +------------------------+           +------------------------+                                 |
|  | -authService: AuthSvc  |           | +success(data, code)   |                                 |
|  | -validator: Validator  |           | +error(msg, code, http)|                                 |
|  | -responseBuilder: RB   |           | +unauthorized(msg)     |                                 |
|  +------------------------+           | +forbidden(msg)        |                                 |
|  | +handle(event, ctx)    |           | +validation_error(errs)|                                 |
|  | -extractUser(event)    |           +------------------------+                                 |
|  | -extractBody(event)    |                                                                      |
|  +------------------------+                                                                      |
|            |                                                                                     |
|            v                                                                                     |
|  +------------------------+           +------------------------+                                 |
|  |  PortalAuthService     |           |     CognitoMFAClient   |                                 |
|  +------------------------+           +------------------------+                                 |
|  | -cognitoClient: CMC    |           | -boto3_client: client  |                                 |
|  | -userRepo: UserRepo    |           | -userPoolId: str       |                                 |
|  | -sessionRepo: SessRepo |           +------------------------+                                 |
|  | -emailService: EmailSvc|           | +associateMFADevice()  |                                 |
|  | -auditService: AuditSvc|           | +verifyTOTP(code)      |                                 |
|  +------------------------+           | +setUserMFAPref()      |                                 |
|  | +getMe(userId)         |           | +adminGetUser()        |                                 |
|  | +updateMe(userId, data)|           | +globalSignOut()       |                                 |
|  | +enableMFA(userId)     |           | +listDevices()         |                                 |
|  | +verifyMFA(userId,code)|           +------------------------+                                 |
|  | +disableMFA(userId,pwd)|                                                                      |
|  | +logout(userId, token) |                                                                      |
|  | +getDashboard(userId)  |                                                                      |
|  +------------------------+                                                                      |
|            |                                                                                     |
|            +--------------------+---------------------+                                          |
|            |                    |                     |                                          |
|            v                    v                     v                                          |
|  +------------------+  +------------------+  +------------------+                                 |
|  |   UserRepository |  | SessionRepository|  |   AuditService   |                                |
|  +------------------+  +------------------+  +------------------+                                 |
|  | -table: Table    |  | -table: Table    |  | -table: Table    |                                |
|  +------------------+  +------------------+  +------------------+                                 |
|  | +findById(id)    |  | +create(session) |  | +log(action,data)|                                |
|  | +findByEmail(e)  |  | +findByUser(id)  |  | +getByUser(id)   |                                |
|  | +update(user)    |  | +invalidate(id)  |  | +getByAction(act)|                                |
|  | +updateMFA(id,st)|  | +countActive(id) |  +------------------+                                |
|  +------------------+  +------------------+                                                       |
|                                                                                                  |
|  +----------------------------------+     +----------------------------------+                   |
|  |          User (Entity)           |     |        Session (Entity)         |                   |
|  +----------------------------------+     +----------------------------------+                   |
|  | +userId: str                     |     | +sessionId: str                  |                   |
|  | +email: str                      |     | +userId: str                     |                   |
|  | +firstName: str                  |     | +deviceFingerprint: str          |                   |
|  | +lastName: str                   |     | +ipAddress: str                  |                   |
|  | +phone: str (optional)           |     | +userAgent: str                  |                   |
|  | +orgId: str                      |     | +createdAt: datetime             |                   |
|  | +mfaEnabled: bool                |     | +expiresAt: datetime             |                   |
|  | +mfaSecret: str (encrypted)      |     | +active: bool                    |                   |
|  | +notificationPrefs: dict         |     +----------------------------------+                   |
|  | +lastLoginAt: datetime           |                                                            |
|  | +createdAt: datetime             |     +----------------------------------+                   |
|  | +updatedAt: datetime             |     |      AuditEntry (Entity)         |                   |
|  +----------------------------------+     +----------------------------------+                   |
|                                           | +auditId: str                    |                   |
|  +----------------------------------+     | +userId: str                     |                   |
|  |         MFASetup (DTO)           |     | +action: str                     |                   |
|  +----------------------------------+     | +resource: str                   |                   |
|  | +secretCode: str                 |     | +details: dict                   |                   |
|  | +qrCodeUrl: str                  |     | +ipAddress: str                  |                   |
|  | +manualEntryKey: str             |     | +timestamp: datetime             |                   |
|  | +recoveryCodes: list[str]        |     +----------------------------------+                   |
|  +----------------------------------+                                                            |
|                                                                                                  |
|  +----------------------------------+                                                            |
|  |      BusinessException           |                                                            |
|  +----------------------------------+                                                            |
|  | +message: str                    |                                                            |
|  | +code: str                       |                                                            |
|  | +statusCode: int                 |                                                            |
|  +----------------------------------+                                                            |
|            ^                                                                                     |
|            |                                                                                     |
|  +---------+----------+-----------+-----------+-----------+                                      |
|  |         |          |           |           |           |                                      |
|  v         v          v           v           v           v                                      |
| Invalid  Session   MFA        MFA        Organisation  Profile                                   |
| Token    Expired   Already    Disabled   MFA          Update                                     |
| Exception Exception Enabled   Exception  Required     Failed                                     |
|                    Exception             Exception    Exception                                  |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+
```

---

## 4. API Design

### 4.1 API Overview

**Base URL (DEV)**: `https://dev.portal-api.kimmyai.io/v1.0`
**Base URL (SIT)**: `https://sit.portal-api.kimmyai.io/v1.0`
**Base URL (PROD)**: `https://portal-api.kimmyai.io/v1.0`

**Authentication**: All endpoints require valid Cognito JWT in `Authorization: Bearer <token>` header.

### 4.2 OpenAPI Specification

```yaml
openapi: 3.0.3
info:
  title: Portal Auth Service API
  description: Authentication and profile management for Customer Portal Private
  version: 1.0.0
  contact:
    name: BBWS Platform Team
    email: platform@kimmyai.io

servers:
  - url: https://dev.portal-api.kimmyai.io/v1.0
    description: Development
  - url: https://sit.portal-api.kimmyai.io/v1.0
    description: System Integration Testing
  - url: https://portal-api.kimmyai.io/v1.0
    description: Production

security:
  - bearerAuth: []

paths:
  /portal/auth/me:
    get:
      operationId: getMe
      summary: Get current user profile
      description: Returns the authenticated user's profile information including linked organisations and tenants
      tags:
        - Profile
      responses:
        '200':
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'
    put:
      operationId: updateMe
      summary: Update current user profile
      description: Updates the authenticated user's profile information
      tags:
        - Profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  /portal/auth/mfa/enable:
    post:
      operationId: enableMFA
      summary: Enable MFA for current user
      description: Generates TOTP secret and QR code for MFA setup
      tags:
        - MFA
      responses:
        '200':
          description: MFA setup initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MFASetupResponse'
        '400':
          description: MFA already enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /portal/auth/mfa/verify:
    post:
      operationId: verifyMFA
      summary: Verify MFA code and complete setup
      description: Validates TOTP code and activates MFA for the user
      tags:
        - MFA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyMFARequest'
      responses:
        '200':
          description: MFA verified and enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MFAVerifyResponse'
        '400':
          description: Invalid or expired code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /portal/auth/mfa/disable:
    post:
      operationId: disableMFA
      summary: Disable MFA for current user
      description: Disables MFA after verifying password and current TOTP code
      tags:
        - MFA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DisableMFARequest'
      responses:
        '200':
          description: MFA disabled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Invalid password or code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Organisation policy requires MFA
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /portal/auth/mfa/recovery-codes:
    get:
      operationId: getRecoveryCodes
      summary: View recovery codes
      description: Returns remaining recovery codes (requires password verification)
      tags:
        - MFA
      parameters:
        - name: X-Verify-Password
          in: header
          required: true
          schema:
            type: string
          description: Current password for verification
      responses:
        '200':
          description: Recovery codes retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecoveryCodesResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Invalid password
        '500':
          $ref: '#/components/responses/InternalError'
    post:
      operationId: regenerateRecoveryCodes
      summary: Regenerate recovery codes
      description: Generates new recovery codes (invalidates previous codes)
      tags:
        - MFA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegenerateCodesRequest'
      responses:
        '200':
          description: New recovery codes generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecoveryCodesResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Invalid password
        '500':
          $ref: '#/components/responses/InternalError'

  /portal/auth/logout:
    post:
      operationId: logout
      summary: Logout current session
      description: Invalidates the current JWT token
      tags:
        - Session
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /portal/auth/logout-all:
    post:
      operationId: logoutAll
      summary: Logout all sessions
      description: Invalidates all active sessions across all devices
      tags:
        - Session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogoutAllRequest'
      responses:
        '200':
          description: All sessions terminated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Invalid password
        '500':
          $ref: '#/components/responses/InternalError'

  /portal/auth/sessions:
    get:
      operationId: listSessions
      summary: List active sessions
      description: Returns list of active sessions for current user
      tags:
        - Session
      responses:
        '200':
          description: Sessions retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /portal/dashboard:
    get:
      operationId: getDashboard
      summary: Get dashboard data
      description: Returns aggregated dashboard data including sites, subscriptions, and recent activity
      tags:
        - Dashboard
      responses:
        '200':
          description: Dashboard data retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    UserProfileResponse:
      type: object
      required:
        - data
        - meta
        - _links
      properties:
        data:
          $ref: '#/components/schemas/UserProfile'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
        _links:
          $ref: '#/components/schemas/UserLinks'

    UserProfile:
      type: object
      required:
        - userId
        - email
        - firstName
        - lastName
        - mfaEnabled
        - createdAt
      properties:
        userId:
          type: string
          format: uuid
        email:
          type: string
          format: email
        firstName:
          type: string
          maxLength: 50
        lastName:
          type: string
          maxLength: 50
        phone:
          type: string
          maxLength: 20
        mfaEnabled:
          type: boolean
        notificationPreferences:
          $ref: '#/components/schemas/NotificationPreferences'
        organisations:
          type: array
          items:
            $ref: '#/components/schemas/LinkedOrganisation'
        tenants:
          type: array
          items:
            $ref: '#/components/schemas/LinkedTenant'
        lastLoginAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    NotificationPreferences:
      type: object
      properties:
        emailBilling:
          type: boolean
          default: true
        emailSiteHealth:
          type: boolean
          default: true
        emailSupport:
          type: boolean
          default: true
        emailMarketing:
          type: boolean
          default: false

    LinkedOrganisation:
      type: object
      properties:
        orgId:
          type: string
          format: uuid
        name:
          type: string
        role:
          type: string
          enum: [super-admin, admin, user, viewer]

    LinkedTenant:
      type: object
      properties:
        tenantId:
          type: string
          format: uuid
        name:
          type: string
        role:
          type: string
          enum: [super-admin, admin, user, viewer]

    UpdateProfileRequest:
      type: object
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
        lastName:
          type: string
          minLength: 1
          maxLength: 50
        phone:
          type: string
          pattern: '^\+?[1-9]\d{1,14}$'
        notificationPreferences:
          $ref: '#/components/schemas/NotificationPreferences'

    MFASetupResponse:
      type: object
      required:
        - data
        - meta
      properties:
        data:
          type: object
          required:
            - qrCodeUrl
            - manualEntryKey
            - expiresAt
          properties:
            qrCodeUrl:
              type: string
              description: Data URL for QR code image
            manualEntryKey:
              type: string
              description: Base32-encoded secret for manual entry
            expiresAt:
              type: string
              format: date-time
              description: Setup expires if not verified within 10 minutes
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    VerifyMFARequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string
          pattern: '^\d{6}$'
          description: 6-digit TOTP code from authenticator app

    MFAVerifyResponse:
      type: object
      required:
        - data
        - meta
      properties:
        data:
          type: object
          required:
            - mfaEnabled
            - recoveryCodes
          properties:
            mfaEnabled:
              type: boolean
            recoveryCodes:
              type: array
              items:
                type: string
              minItems: 10
              maxItems: 10
              description: One-time use recovery codes (show only once)
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    DisableMFARequest:
      type: object
      required:
        - password
        - code
      properties:
        password:
          type: string
          description: Current account password
        code:
          type: string
          pattern: '^\d{6}$'
          description: Current TOTP code

    RegenerateCodesRequest:
      type: object
      required:
        - password
      properties:
        password:
          type: string
          description: Current account password

    RecoveryCodesResponse:
      type: object
      required:
        - data
        - meta
      properties:
        data:
          type: object
          properties:
            recoveryCodes:
              type: array
              items:
                type: string
            usedCount:
              type: integer
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    LogoutAllRequest:
      type: object
      required:
        - password
      properties:
        password:
          type: string
          description: Current account password for verification

    SessionsResponse:
      type: object
      required:
        - data
        - meta
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Session'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    Session:
      type: object
      properties:
        sessionId:
          type: string
        deviceType:
          type: string
        browser:
          type: string
        ipAddress:
          type: string
        location:
          type: string
        lastActiveAt:
          type: string
          format: date-time
        isCurrent:
          type: boolean

    DashboardResponse:
      type: object
      required:
        - data
        - meta
        - _links
      properties:
        data:
          $ref: '#/components/schemas/DashboardData'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
        _links:
          $ref: '#/components/schemas/DashboardLinks'

    DashboardData:
      type: object
      properties:
        user:
          type: object
          properties:
            firstName:
              type: string
            lastName:
              type: string
        currentTenant:
          type: object
          properties:
            tenantId:
              type: string
            name:
              type: string
        sites:
          type: object
          properties:
            total:
              type: integer
            healthy:
              type: integer
            warning:
              type: integer
            critical:
              type: integer
        subscription:
          type: object
          properties:
            plan:
              type: string
            status:
              type: string
            renewalDate:
              type: string
              format: date
        recentTickets:
          type: array
          items:
            type: object
            properties:
              ticketId:
                type: string
              subject:
                type: string
              status:
                type: string
              createdAt:
                type: string
                format: date-time
          maxItems: 5
        quickActions:
          type: array
          items:
            type: object
            properties:
              label:
                type: string
              href:
                type: string
              icon:
                type: string

    SuccessResponse:
      type: object
      required:
        - data
        - meta
      properties:
        data:
          type: object
          properties:
            message:
              type: string
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ErrorResponse:
      type: object
      required:
        - error
        - meta
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ResponseMeta:
      type: object
      required:
        - timestamp
        - requestId
      properties:
        timestamp:
          type: string
          format: date-time
        requestId:
          type: string
          format: uuid

    UserLinks:
      type: object
      properties:
        self:
          type: object
          properties:
            href:
              type: string
        organisations:
          type: object
          properties:
            href:
              type: string
        tenants:
          type: object
          properties:
            href:
              type: string
        settings:
          type: object
          properties:
            href:
              type: string

    DashboardLinks:
      type: object
      properties:
        self:
          type: object
          properties:
            href:
              type: string
        sites:
          type: object
          properties:
            href:
              type: string
        billing:
          type: object
          properties:
            href:
              type: string
        tickets:
          type: object
          properties:
            href:
              type: string

  responses:
    Unauthorized:
      description: Authentication required or token expired
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    BadRequest:
      description: Invalid request format
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ValidationError:
      description: Validation errors in request body
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
```

### 4.3 API Endpoint Summary

| Method | Endpoint | Lambda | Description |
|--------|----------|--------|-------------|
| GET | `/portal/auth/me` | `get_me` | Get current user profile |
| PUT | `/portal/auth/me` | `update_me` | Update current user profile |
| POST | `/portal/auth/mfa/enable` | `enable_mfa` | Generate MFA QR code |
| POST | `/portal/auth/mfa/verify` | `verify_mfa` | Verify TOTP and enable MFA |
| POST | `/portal/auth/mfa/disable` | `disable_mfa` | Disable MFA |
| GET | `/portal/auth/mfa/recovery-codes` | `get_recovery_codes` | View recovery codes |
| POST | `/portal/auth/mfa/recovery-codes` | `regenerate_recovery_codes` | Generate new codes |
| POST | `/portal/auth/logout` | `logout` | Logout current session |
| POST | `/portal/auth/logout-all` | `logout_all` | Logout all sessions |
| GET | `/portal/auth/sessions` | `list_sessions` | List active sessions |
| GET | `/portal/dashboard` | `get_dashboard` | Get dashboard data |

---

## 5. Lambda Functions

### 5.1 Function Overview

| # | Function Name | Memory | Timeout | Trigger | Description |
|---|---------------|--------|---------|---------|-------------|
| 1 | `get_me` | 256MB | 10s | API Gateway | Retrieve user profile |
| 2 | `update_me` | 256MB | 15s | API Gateway | Update user profile |
| 3 | `enable_mfa` | 256MB | 15s | API Gateway | Generate MFA setup |
| 4 | `verify_mfa` | 256MB | 15s | API Gateway | Verify TOTP code |
| 5 | `disable_mfa` | 256MB | 15s | API Gateway | Disable MFA |
| 6 | `get_recovery_codes` | 256MB | 10s | API Gateway | View recovery codes |
| 7 | `regenerate_recovery_codes` | 256MB | 15s | API Gateway | Generate new codes |
| 8 | `logout` | 128MB | 10s | API Gateway | Logout current session |
| 9 | `logout_all` | 256MB | 15s | API Gateway | Logout all sessions |
| 10 | `list_sessions` | 256MB | 10s | API Gateway | List active sessions |
| 11 | `get_dashboard` | 512MB | 30s | API Gateway | Aggregate dashboard data |

### 5.2 Function Details

#### 5.2.1 get_me

```python
# Handler: src/handlers/get_me.py

"""
Get current user profile.

Input: JWT token in Authorization header
Output: UserProfileResponse with linked orgs/tenants

Business Rules:
- BR-024: Only returns data for user's assigned tenants
- BR-026: Audit log created for profile access
"""

def handler(event: dict, context: LambdaContext) -> dict:
    try:
        # Extract user from Lambda Authorizer context
        user_id = event['requestContext']['authorizer']['userId']

        # Get profile from service
        profile = auth_service.get_me(user_id)

        # Build HATEOAS response
        return response_builder.success(
            data=profile.to_dict(),
            links={
                "self": {"href": "/portal/auth/me"},
                "organisations": {"href": "/portal/organisations"},
                "tenants": {"href": "/portal/tenants"},
                "settings": {"href": "/portal/auth/me"}
            }
        )
    except BusinessException as e:
        return response_builder.error(e.message, e.code, e.status_code)
    except Exception as e:
        logger.exception("Unexpected error in get_me")
        return response_builder.internal_error()
```

#### 5.2.2 enable_mfa

```python
# Handler: src/handlers/enable_mfa.py

"""
Enable MFA for current user.

Input: JWT token
Output: MFASetupResponse with QR code and manual key

Business Rules:
- BR-004: Check if MFA already enabled
- Setup expires after 10 minutes if not verified
"""

def handler(event: dict, context: LambdaContext) -> dict:
    try:
        user_id = event['requestContext']['authorizer']['userId']

        # Check if MFA already enabled
        user = user_repo.find_by_id(user_id)
        if user.mfa_enabled:
            raise MFAAlreadyEnabledException("MFA is already enabled")

        # Generate TOTP secret
        mfa_setup = auth_service.enable_mfa(user_id)

        return response_builder.success(data={
            "qrCodeUrl": mfa_setup.qr_code_url,
            "manualEntryKey": mfa_setup.manual_entry_key,
            "expiresAt": mfa_setup.expires_at.isoformat()
        })
    except BusinessException as e:
        return response_builder.error(e.message, e.code, e.status_code)
    except Exception as e:
        logger.exception("Unexpected error in enable_mfa")
        return response_builder.internal_error()
```

#### 5.2.3 get_dashboard

```python
# Handler: src/handlers/get_dashboard.py

"""
Get aggregated dashboard data.

Input: JWT token
Output: DashboardResponse with sites, subscription, tickets

This function makes parallel calls to other services for performance.
"""

import asyncio
import aiohttp

async def handler(event: dict, context: LambdaContext) -> dict:
    try:
        user_id = event['requestContext']['authorizer']['userId']
        tenant_id = event['requestContext']['authorizer']['tenantId']
        token = event['headers'].get('Authorization')

        # Parallel API calls for dashboard data
        async with aiohttp.ClientSession() as session:
            tasks = [
                fetch_sites_summary(session, tenant_id, token),
                fetch_subscription(session, tenant_id, token),
                fetch_recent_tickets(session, tenant_id, token),
                fetch_user_info(user_id)
            ]

            results = await asyncio.gather(*tasks, return_exceptions=True)

        # Build dashboard response (handle partial failures)
        dashboard = build_dashboard_response(results)

        return response_builder.success(
            data=dashboard,
            links={
                "self": {"href": "/portal/dashboard"},
                "sites": {"href": f"/portal/tenants/{tenant_id}/sites"},
                "billing": {"href": "/portal/subscription"},
                "tickets": {"href": "/portal/tickets"}
            }
        )
    except Exception as e:
        logger.exception("Unexpected error in get_dashboard")
        return response_builder.internal_error()
```

---

## 6. Sequence Diagrams

### 6.1 Get Profile Flow (US 3.8)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           GET PROFILE FLOW                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Client          API GW       Authorizer     get_me       DynamoDB    SES      │
│    │               │              │            │             │         │        │
│    │  GET /portal/auth/me        │            │             │         │        │
│    │──────────────>│              │            │             │         │        │
│    │               │              │            │             │         │        │
│    │               │  Validate JWT            │             │         │        │
│    │               │─────────────>│            │             │         │        │
│    │               │              │            │             │         │        │
│    │               │  IAM Policy  │            │             │         │        │
│    │               │<─────────────│            │             │         │        │
│    │               │              │            │             │         │        │
│    │               │  Invoke Lambda            │             │         │        │
│    │               │─────────────────────────>│             │         │        │
│    │               │              │            │             │         │        │
│    │               │              │            │  Query USER │         │        │
│    │               │              │            │────────────>│         │        │
│    │               │              │            │             │         │        │
│    │               │              │            │  User Data  │         │        │
│    │               │              │            │<────────────│         │        │
│    │               │              │            │             │         │        │
│    │               │              │            │  Query ORG_USER      │        │
│    │               │              │            │────────────>│         │        │
│    │               │              │            │             │         │        │
│    │               │              │            │  Orgs List  │         │        │
│    │               │              │            │<────────────│         │        │
│    │               │              │            │             │         │        │
│    │               │              │            │  Query TENANT_USER   │        │
│    │               │              │            │────────────>│         │        │
│    │               │              │            │             │         │        │
│    │               │              │            │  Tenants    │         │        │
│    │               │              │            │<────────────│         │        │
│    │               │              │            │             │         │        │
│    │               │              │            │  Log Audit  │         │        │
│    │               │              │            │────────────>│         │        │
│    │               │              │            │             │         │        │
│    │               │  200 OK + Profile         │             │         │        │
│    │<──────────────────────────────────────────│             │         │        │
│    │               │              │            │             │         │        │
│                                                                                 │
│  ALT: Token Expired                                                             │
│    │               │              │            │             │         │        │
│    │               │  Validate JWT            │             │         │        │
│    │               │─────────────>│            │             │         │        │
│    │               │              │            │             │         │        │
│    │               │  401 Unauthorized         │             │         │        │
│    │<──────────────│              │            │             │         │        │
│    │               │              │            │             │         │        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Enable MFA Flow (US 3.10)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ENABLE MFA FLOW                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Client       API GW      enable_mfa    Cognito     DynamoDB      SES          │
│    │            │             │            │           │           │            │
│    │  POST /portal/auth/mfa/enable        │           │           │            │
│    │───────────>│             │            │           │           │            │
│    │            │             │            │           │           │            │
│    │            │  Invoke     │            │           │           │            │
│    │            │────────────>│            │           │           │            │
│    │            │             │            │           │           │            │
│    │            │             │  Get User  │           │           │            │
│    │            │             │───────────────────────>│           │            │
│    │            │             │            │           │           │            │
│    │            │             │  User (mfa_enabled=false)         │            │
│    │            │             │<───────────────────────│           │            │
│    │            │             │            │           │           │            │
│    │            │             │  AssociateSoftwareToken           │            │
│    │            │             │───────────>│           │           │            │
│    │            │             │            │           │           │            │
│    │            │             │  SecretCode│           │           │            │
│    │            │             │<───────────│           │           │            │
│    │            │             │            │           │           │            │
│    │            │             │  Generate QR Code                 │            │
│    │            │             │  (totp://...)                     │            │
│    │            │             │            │           │           │            │
│    │            │             │  Store pending MFA setup          │            │
│    │            │             │───────────────────────>│           │            │
│    │            │             │            │           │           │            │
│    │  200 OK (qrCodeUrl, manualEntryKey)  │           │           │            │
│    │<───────────────────────────────────────────────────────────────            │
│    │            │             │            │           │           │            │
│    │  (User scans QR code with authenticator app)     │           │            │
│    │            │             │            │           │           │            │
│    │  POST /portal/auth/mfa/verify        │           │           │            │
│    │  { "code": "123456" }    │            │           │           │            │
│    │───────────>│             │            │           │           │            │
│    │            │             │            │           │           │            │
│    │            │  Invoke verify_mfa      │           │           │            │
│    │            │────────────>│            │           │           │            │
│    │            │             │            │           │           │            │
│    │            │             │  VerifySoftwareToken  │           │            │
│    │            │             │───────────>│           │           │            │
│    │            │             │            │           │           │            │
│    │            │             │  Success   │           │           │            │
│    │            │             │<───────────│           │           │            │
│    │            │             │            │           │           │            │
│    │            │             │  SetUserMFAPreference │           │            │
│    │            │             │───────────>│           │           │            │
│    │            │             │            │           │           │            │
│    │            │             │  Update User (mfa_enabled=true)   │            │
│    │            │             │───────────────────────>│           │           │
│    │            │             │            │           │           │            │
│    │            │             │  Generate Recovery Codes          │            │
│    │            │             │  (10 codes, hashed)    │           │            │
│    │            │             │───────────────────────>│           │            │
│    │            │             │            │           │           │            │
│    │            │             │  Send MFA enabled email           │            │
│    │            │             │───────────────────────────────────>│            │
│    │            │             │            │           │           │            │
│    │  200 OK (mfaEnabled, recoveryCodes)  │           │           │            │
│    │<───────────────────────────────────────────────────────────────            │
│    │            │             │            │           │           │            │
│                                                                                 │
│  ALT: Invalid Code                                                              │
│    │            │             │            │           │           │            │
│    │            │             │  VerifySoftwareToken  │           │            │
│    │            │             │───────────>│           │           │            │
│    │            │             │            │           │           │            │
│    │            │             │  CodeMismatchException│           │            │
│    │            │             │<───────────│           │           │            │
│    │            │             │            │           │           │            │
│    │            │             │  Increment failure count          │            │
│    │            │             │───────────────────────>│           │            │
│    │            │             │            │           │           │            │
│    │  400 Bad Request (Invalid code)      │           │           │            │
│    │<───────────────────────────────────────────────────────────────            │
│    │            │             │            │           │           │            │
│                                                                                 │
│  ALT: Rate Limited (5+ failures)                                                │
│    │            │             │            │           │           │            │
│    │  429 Too Many Requests (retry after 15 min)      │           │            │
│    │<───────────────────────────────────────────────────────────────            │
│    │            │             │            │           │           │            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.3 Logout Flow (US 3.11)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           LOGOUT FLOW                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Client       API GW       logout       Cognito     DynamoDB                   │
│    │            │             │            │           │                        │
│    │  POST /portal/auth/logout            │           │                        │
│    │  Authorization: Bearer <token>       │           │                        │
│    │───────────>│             │            │           │                        │
│    │            │             │            │           │                        │
│    │            │  Invoke     │            │           │                        │
│    │            │────────────>│            │           │                        │
│    │            │             │            │           │                        │
│    │            │             │  GlobalSignOut (access_token)                  │
│    │            │             │───────────>│           │                        │
│    │            │             │            │           │                        │
│    │            │             │  Success   │           │                        │
│    │            │             │<───────────│           │                        │
│    │            │             │            │           │                        │
│    │            │             │  Mark session inactive │                        │
│    │            │             │───────────────────────>│                        │
│    │            │             │            │           │                        │
│    │            │             │  Log audit │           │                        │
│    │            │             │───────────────────────>│                        │
│    │            │             │            │           │                        │
│    │  200 OK ("Logged out successfully")  │           │                        │
│    │<───────────────────────────────────────────────────                        │
│    │            │             │            │           │                        │
│    │  (Clear localStorage, redirect to /login)        │                        │
│    │            │             │            │           │                        │
│                                                                                 │
│  LOGOUT ALL DEVICES:                                                            │
│    │            │             │            │           │                        │
│    │  POST /portal/auth/logout-all        │           │                        │
│    │  { "password": "..." }   │            │           │                        │
│    │───────────>│             │            │           │                        │
│    │            │             │            │           │                        │
│    │            │  Invoke logout_all      │           │                        │
│    │            │────────────>│            │           │                        │
│    │            │             │            │           │                        │
│    │            │             │  AdminInitiateAuth (verify password)           │
│    │            │             │───────────>│           │                        │
│    │            │             │            │           │                        │
│    │            │             │  GlobalSignOut (all tokens)                    │
│    │            │             │───────────>│           │                        │
│    │            │             │            │           │                        │
│    │            │             │  Mark all sessions inactive                    │
│    │            │             │───────────────────────>│                        │
│    │            │             │            │           │                        │
│    │  200 OK ("All sessions terminated")  │           │                        │
│    │<───────────────────────────────────────────────────                        │
│    │            │             │            │           │                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.4 Dashboard Aggregation Flow (US 4.1)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       DASHBOARD AGGREGATION FLOW                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Client      API GW    get_dashboard    Sites Svc   Billing Svc   Ticket Svc   │
│    │           │            │              │            │            │          │
│    │  GET /portal/dashboard │              │            │            │          │
│    │──────────>│            │              │            │            │          │
│    │           │            │              │            │            │          │
│    │           │  Invoke    │              │            │            │          │
│    │           │───────────>│              │            │            │          │
│    │           │            │              │            │            │          │
│    │           │            │  PARALLEL REQUESTS:      │            │          │
│    │           │            │              │            │            │          │
│    │           │            │  GET /portal/tenants/{id}/sites/summary          │
│    │           │            │─────────────>│            │            │          │
│    │           │            │              │            │            │          │
│    │           │            │  GET /portal/subscription │            │          │
│    │           │            │────────────────────────────>          │          │
│    │           │            │              │            │            │          │
│    │           │            │  GET /portal/tickets?limit=5&status=open         │
│    │           │            │────────────────────────────────────────>          │
│    │           │            │              │            │            │          │
│    │           │            │  Sites: {total: 5, healthy: 4, warning: 1}       │
│    │           │            │<─────────────│            │            │          │
│    │           │            │              │            │            │          │
│    │           │            │  Subscription: {plan: "Pro", status: "active"}   │
│    │           │            │<────────────────────────────          │          │
│    │           │            │              │            │            │          │
│    │           │            │  Tickets: [{id, subject, status}...]  │          │
│    │           │            │<────────────────────────────────────────          │
│    │           │            │              │            │            │          │
│    │           │            │  Aggregate results       │            │          │
│    │           │            │              │            │            │          │
│    │  200 OK (DashboardResponse)          │            │            │          │
│    │<──────────────────────────────────────────────────────────────────         │
│    │           │            │              │            │            │          │
│                                                                                 │
│  ALT: Partial Failure (e.g., Sites service timeout)                             │
│    │           │            │              │            │            │          │
│    │           │            │  Sites: TIMEOUT          │            │          │
│    │           │            │<─────────────│            │            │          │
│    │           │            │              │            │            │          │
│    │           │            │  Return available data + error widget │          │
│    │           │            │              │            │            │          │
│    │  200 OK (partial data, sites.error: true)        │            │          │
│    │<──────────────────────────────────────────────────────────────────         │
│    │           │            │              │            │            │          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Data Models

### 7.1 DynamoDB Schema

#### 7.1.1 Table: `bbws-portal-{env}`

Single-table design supporting multiple entity types.

| Entity | PK | SK | Attributes |
|--------|----|----|------------|
| User | `USER#{userId}` | `METADATA` | email, firstName, lastName, phone, mfaEnabled, notificationPrefs, lastLoginAt, createdAt, updatedAt |
| UserMFA | `USER#{userId}` | `MFA` | mfaSecret (encrypted), mfaMethod, recoveryCodes (hashed), setupExpiresAt |
| Session | `USER#{userId}` | `SESSION#{sessionId}` | deviceFingerprint, ipAddress, userAgent, createdAt, expiresAt, active |
| AuditLog | `USER#{userId}` | `AUDIT#{timestamp}` | action, resource, details, ipAddress, userAgent |

#### 7.1.2 GSIs

| GSI Name | PK | SK | Purpose |
|----------|----|----|---------|
| UserEmailIndex | email | entity_type | Find user by email |
| SessionActiveIndex | userId | active#expiresAt | List active sessions |

#### 7.1.3 Example Items

```json
// User entity
{
  "PK": "USER#550e8400-e29b-41d4-a716-446655440000",
  "SK": "METADATA",
  "entity_type": "USER",
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "email": "john.doe@example.com",
  "firstName": "John",
  "lastName": "Doe",
  "phone": "+27821234567",
  "mfaEnabled": true,
  "notificationPrefs": {
    "emailBilling": true,
    "emailSiteHealth": true,
    "emailSupport": true,
    "emailMarketing": false
  },
  "lastLoginAt": "2026-01-20T10:30:00Z",
  "createdAt": "2025-06-15T08:00:00Z",
  "updatedAt": "2026-01-20T10:30:00Z"
}

// User MFA entity
{
  "PK": "USER#550e8400-e29b-41d4-a716-446655440000",
  "SK": "MFA",
  "entity_type": "USER_MFA",
  "mfaSecret": "AES256:encrypted_base32_secret",
  "mfaMethod": "TOTP",
  "recoveryCodes": [
    "$argon2id$v=19$m=65536,t=3,p=4$hash1",
    "$argon2id$v=19$m=65536,t=3,p=4$hash2"
  ],
  "codesUsed": 0,
  "setupExpiresAt": null,
  "enabledAt": "2026-01-15T14:00:00Z"
}

// Session entity
{
  "PK": "USER#550e8400-e29b-41d4-a716-446655440000",
  "SK": "SESSION#sess_abc123def456",
  "entity_type": "SESSION",
  "sessionId": "sess_abc123def456",
  "deviceFingerprint": "Chrome-MacOS-1920x1080",
  "ipAddress": "197.80.100.50",
  "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)",
  "location": "Cape Town, ZA",
  "createdAt": "2026-01-20T10:30:00Z",
  "expiresAt": "2026-01-27T10:30:00Z",
  "lastActiveAt": "2026-01-20T11:00:00Z",
  "active": true
}

// Audit Log entity
{
  "PK": "USER#550e8400-e29b-41d4-a716-446655440000",
  "SK": "AUDIT#2026-01-20T10:30:00.000Z",
  "entity_type": "AUDIT",
  "action": "MFA_ENABLED",
  "resource": "USER/550e8400-e29b-41d4-a716-446655440000",
  "details": {
    "mfaMethod": "TOTP",
    "recoveryCodesGenerated": 10
  },
  "ipAddress": "197.80.100.50",
  "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)",
  "timestamp": "2026-01-20T10:30:00Z"
}
```

### 7.2 Pydantic Models

```python
# src/models/user.py

from pydantic import BaseModel, EmailStr, Field
from typing import Optional
from datetime import datetime
from enum import Enum

class NotificationPreferences(BaseModel):
    email_billing: bool = Field(True, alias="emailBilling")
    email_site_health: bool = Field(True, alias="emailSiteHealth")
    email_support: bool = Field(True, alias="emailSupport")
    email_marketing: bool = Field(False, alias="emailMarketing")

    class Config:
        populate_by_name = True

class User(BaseModel):
    user_id: str = Field(..., alias="userId")
    email: EmailStr
    first_name: str = Field(..., alias="firstName", min_length=1, max_length=50)
    last_name: str = Field(..., alias="lastName", min_length=1, max_length=50)
    phone: Optional[str] = Field(None, pattern=r'^\+?[1-9]\d{1,14}$')
    mfa_enabled: bool = Field(False, alias="mfaEnabled")
    notification_prefs: NotificationPreferences = Field(
        default_factory=NotificationPreferences,
        alias="notificationPreferences"
    )
    last_login_at: Optional[datetime] = Field(None, alias="lastLoginAt")
    created_at: datetime = Field(..., alias="createdAt")
    updated_at: datetime = Field(..., alias="updatedAt")

    class Config:
        populate_by_name = True

class UpdateProfileRequest(BaseModel):
    first_name: Optional[str] = Field(None, alias="firstName", min_length=1, max_length=50)
    last_name: Optional[str] = Field(None, alias="lastName", min_length=1, max_length=50)
    phone: Optional[str] = Field(None, pattern=r'^\+?[1-9]\d{1,14}$')
    notification_preferences: Optional[NotificationPreferences] = Field(
        None, alias="notificationPreferences"
    )

    class Config:
        populate_by_name = True

class MFASetup(BaseModel):
    secret_code: str = Field(..., alias="secretCode")
    qr_code_url: str = Field(..., alias="qrCodeUrl")
    manual_entry_key: str = Field(..., alias="manualEntryKey")
    expires_at: datetime = Field(..., alias="expiresAt")

    class Config:
        populate_by_name = True

class VerifyMFARequest(BaseModel):
    code: str = Field(..., pattern=r'^\d{6}$')

class DisableMFARequest(BaseModel):
    password: str = Field(..., min_length=1)
    code: str = Field(..., pattern=r'^\d{6}$')

class Session(BaseModel):
    session_id: str = Field(..., alias="sessionId")
    device_type: str = Field(..., alias="deviceType")
    browser: str
    ip_address: str = Field(..., alias="ipAddress")
    location: Optional[str] = None
    last_active_at: datetime = Field(..., alias="lastActiveAt")
    is_current: bool = Field(False, alias="isCurrent")

    class Config:
        populate_by_name = True

class DashboardData(BaseModel):
    user: dict
    current_tenant: dict = Field(..., alias="currentTenant")
    sites: dict
    subscription: dict
    recent_tickets: list = Field(..., alias="recentTickets")
    quick_actions: list = Field(..., alias="quickActions")

    class Config:
        populate_by_name = True
```

---

## 8. Security

### 8.1 Authentication

| Component | Implementation |
|-----------|----------------|
| Token Type | Cognito JWT (RS256) |
| Access Token TTL | 1 hour |
| Refresh Token TTL | 7 days |
| Token Validation | Lambda Authorizer |
| Token Storage (Frontend) | HttpOnly cookie (refresh), memory (access) |

### 8.2 MFA Implementation

| Component | Implementation |
|-----------|----------------|
| MFA Method | TOTP (Time-based One-Time Password) |
| Algorithm | SHA-1, 6 digits, 30-second window |
| QR Code Format | `otpauth://totp/BBWS:{email}?secret={base32}&issuer=BBWS` |
| Recovery Codes | 10 codes, Argon2id hashed, single-use |
| Failed Attempts | 5 attempts, then 15-minute lockout (BR-005) |

### 8.3 Rate Limiting

| Operation | Limit | Window | BR Reference |
|-----------|-------|--------|--------------|
| MFA verify | 5 attempts | 15 minutes | BR-005 |
| MFA disable | 5 attempts | 1 hour | BR-005 |
| Profile update | 10 requests | 1 minute | - |
| Dashboard | 30 requests | 1 minute | - |

### 8.4 Data Protection

| Data | At Rest | In Transit |
|------|---------|------------|
| User PII | AES-256 (DynamoDB encryption) | TLS 1.2+ |
| MFA Secret | AES-256 (application-level) | TLS 1.2+ |
| Recovery Codes | Argon2id hash | TLS 1.2+ |
| JWT Tokens | N/A | TLS 1.2+ |
| Audit Logs | AES-256 (DynamoDB encryption) | TLS 1.2+ |

### 8.5 Audit Logging

All operations are logged with:
- User ID
- Action type
- Resource affected
- IP address
- User agent
- Timestamp
- Request ID

```python
# Audit actions
AUDIT_ACTIONS = [
    "PROFILE_VIEW",
    "PROFILE_UPDATE",
    "MFA_ENABLE_STARTED",
    "MFA_ENABLED",
    "MFA_DISABLED",
    "RECOVERY_CODES_VIEWED",
    "RECOVERY_CODES_REGENERATED",
    "SESSION_CREATED",
    "SESSION_TERMINATED",
    "ALL_SESSIONS_TERMINATED",
    "DASHBOARD_VIEW"
]
```

---

## 9. Error Handling

### 9.1 Error Response Format

```json
{
  "error": {
    "code": "MFA_ALREADY_ENABLED",
    "message": "MFA is already enabled for this account",
    "details": {
      "enabledAt": "2026-01-15T14:00:00Z"
    }
  },
  "meta": {
    "timestamp": "2026-01-20T10:30:00Z",
    "requestId": "req-abc123"
  }
}
```

### 9.2 Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `UNAUTHORIZED` | 401 | Missing or invalid JWT token |
| `TOKEN_EXPIRED` | 401 | JWT token has expired |
| `FORBIDDEN` | 403 | User lacks permission for action |
| `ORG_MFA_REQUIRED` | 403 | Organisation policy requires MFA |
| `INVALID_PASSWORD` | 400 | Password verification failed |
| `INVALID_MFA_CODE` | 400 | MFA code verification failed |
| `MFA_ALREADY_ENABLED` | 400 | MFA is already enabled |
| `MFA_NOT_ENABLED` | 400 | MFA is not enabled |
| `MFA_SETUP_EXPIRED` | 400 | MFA setup session expired |
| `RATE_LIMITED` | 429 | Too many requests |
| `VALIDATION_ERROR` | 422 | Request validation failed |
| `PROFILE_UPDATE_FAILED` | 500 | Failed to update profile |
| `INTERNAL_ERROR` | 500 | Unexpected server error |

### 9.3 Exception Hierarchy

```python
# src/utils/exceptions.py

class BusinessException(Exception):
    """Base exception for business logic errors."""
    def __init__(self, message: str, code: str, status_code: int = 400):
        self.message = message
        self.code = code
        self.status_code = status_code
        super().__init__(message)

class UnauthorizedException(BusinessException):
    def __init__(self, message: str = "Authentication required"):
        super().__init__(message, "UNAUTHORIZED", 401)

class TokenExpiredException(BusinessException):
    def __init__(self, message: str = "Token has expired"):
        super().__init__(message, "TOKEN_EXPIRED", 401)

class ForbiddenException(BusinessException):
    def __init__(self, message: str = "Access denied"):
        super().__init__(message, "FORBIDDEN", 403)

class OrgMFARequiredException(BusinessException):
    def __init__(self):
        super().__init__(
            "MFA is required by your organisation policy",
            "ORG_MFA_REQUIRED",
            403
        )

class InvalidPasswordException(BusinessException):
    def __init__(self):
        super().__init__("Invalid password", "INVALID_PASSWORD", 400)

class InvalidMFACodeException(BusinessException):
    def __init__(self):
        super().__init__("Invalid MFA code", "INVALID_MFA_CODE", 400)

class MFAAlreadyEnabledException(BusinessException):
    def __init__(self, message: str = "MFA is already enabled"):
        super().__init__(message, "MFA_ALREADY_ENABLED", 400)

class MFANotEnabledException(BusinessException):
    def __init__(self):
        super().__init__("MFA is not enabled", "MFA_NOT_ENABLED", 400)

class MFASetupExpiredException(BusinessException):
    def __init__(self):
        super().__init__("MFA setup session expired", "MFA_SETUP_EXPIRED", 400)

class RateLimitedException(BusinessException):
    def __init__(self, retry_after: int):
        super().__init__(
            f"Rate limit exceeded. Try again in {retry_after} seconds",
            "RATE_LIMITED",
            429
        )
        self.retry_after = retry_after

class ValidationException(BusinessException):
    def __init__(self, errors: dict):
        super().__init__("Validation failed", "VALIDATION_ERROR", 422)
        self.errors = errors
```

---

## 10. Monitoring and Alerting

### 10.1 CloudWatch Metrics

| Metric | Namespace | Description | Alarm Threshold |
|--------|-----------|-------------|-----------------|
| `MFAEnableAttempts` | `BBWS/PortalAuth` | MFA enable requests | N/A |
| `MFAVerifyFailures` | `BBWS/PortalAuth` | Failed MFA verifications | > 50/min |
| `ProfileUpdateLatency` | `BBWS/PortalAuth` | Profile update p95 latency | > 2000ms |
| `DashboardLatency` | `BBWS/PortalAuth` | Dashboard load p95 latency | > 3000ms |
| `LogoutAllRequests` | `BBWS/PortalAuth` | Security-related logouts | > 10/hour |
| `RateLimitHits` | `BBWS/PortalAuth` | Rate limit triggers | > 100/hour |

### 10.2 CloudWatch Alarms

| Alarm Name | Metric | Threshold | Period | Actions |
|------------|--------|-----------|--------|---------|
| `PortalAuthHighErrorRate` | 5XXError | > 1% | 5 min | SNS → PagerDuty |
| `PortalAuthHighLatency` | p95 Latency | > 2000ms | 5 min | SNS → Slack |
| `MFAVerifyFailureSpike` | MFAVerifyFailures | > 50 | 5 min | SNS → Security Team |
| `SuspiciousLogoutAll` | LogoutAllRequests | > 10 | 1 hour | SNS → Security Team |

### 10.3 Structured Logging

```python
# Log format
{
    "timestamp": "2026-01-20T10:30:00.000Z",
    "level": "INFO",
    "requestId": "req-abc123",
    "userId": "user-uuid",
    "action": "MFA_ENABLED",
    "duration_ms": 250,
    "status": "success",
    "metadata": {
        "mfaMethod": "TOTP",
        "recoveryCodesGenerated": 10
    }
}
```

### 10.4 Log Queries (CloudWatch Insights)

```sql
-- Find MFA failures
fields @timestamp, @message, userId, action
| filter action = "MFA_VERIFY_FAILED"
| sort @timestamp desc
| limit 100

-- Dashboard latency analysis
fields @timestamp, duration_ms, userId
| filter action = "DASHBOARD_VIEW"
| stats avg(duration_ms), percentile(duration_ms, 95) by bin(5m)

-- Security events
fields @timestamp, userId, action, ipAddress
| filter action in ["ALL_SESSIONS_TERMINATED", "MFA_DISABLED", "PASSWORD_CHANGED"]
| sort @timestamp desc
| limit 100
```

### 10.5 X-Ray Tracing

Enable X-Ray for:
- Lambda function invocations
- DynamoDB calls
- Cognito API calls
- Cross-service dashboard calls

---

## 11. NFRs

### 11.1 Performance

| Metric | Target | Measurement |
|--------|--------|-------------|
| GET /portal/auth/me latency (p95) | < 500ms | CloudWatch |
| PUT /portal/auth/me latency (p95) | < 1000ms | CloudWatch |
| MFA enable/verify latency (p95) | < 1500ms | CloudWatch |
| GET /portal/dashboard latency (p95) | < 2000ms | CloudWatch |
| Lambda cold start | < 1000ms | X-Ray |
| Concurrent requests | 100/second | Load test |

### 11.2 Availability

| Metric | Target |
|--------|--------|
| Uptime | 99.9% |
| Error rate | < 0.1% |
| RTO | 4 hours |
| RPO | 1 hour |

### 11.3 Scalability

- Lambda auto-scales to handle traffic spikes
- DynamoDB on-demand capacity
- Cognito handles up to 400 requests/second
- CloudFront caching for dashboard static elements

### 11.4 Security

- All data encrypted at rest (AES-256)
- All data encrypted in transit (TLS 1.2+)
- MFA secrets encrypted at application level
- Recovery codes hashed with Argon2id
- Session management prevents session fixation
- Rate limiting prevents brute force attacks

---

## 12. Troubleshooting Playbook

### 12.1 Common Issues

| Issue | Symptoms | Root Cause | Resolution |
|-------|----------|------------|------------|
| Profile not loading | 500 error on GET /me | DynamoDB throttling | Check DynamoDB metrics, enable PITR |
| MFA setup fails | QR code not generated | Cognito association failed | Check Cognito user pool config |
| MFA verify always fails | Invalid code error | Clock skew on user device | Advise user to sync device time |
| Logout not working | Token still valid | Cognito sign-out failed | Use admin sign-out, check logs |
| Dashboard timeout | 504 Gateway Timeout | Downstream service slow | Check dependent service health |
| Rate limited too often | 429 errors | Legitimate traffic spike | Increase rate limits, review patterns |

### 12.2 Diagnostic Steps

#### Profile Not Loading

```bash
# 1. Check Lambda logs
aws logs filter-log-events \
  --log-group-name /aws/lambda/portal-auth-get-me \
  --filter-pattern "ERROR" \
  --start-time $(date -d "1 hour ago" +%s000)

# 2. Check DynamoDB metrics
aws cloudwatch get-metric-statistics \
  --namespace AWS/DynamoDB \
  --metric-name ThrottledRequests \
  --dimensions Name=TableName,Value=bbws-portal-dev \
  --start-time $(date -d "1 hour ago" --iso-8601=seconds) \
  --end-time $(date --iso-8601=seconds) \
  --period 300 \
  --statistics Sum

# 3. Test DynamoDB query directly
aws dynamodb get-item \
  --table-name bbws-portal-dev \
  --key '{"PK": {"S": "USER#<user-id>"}, "SK": {"S": "METADATA"}}'
```

#### MFA Issues

```bash
# 1. Check user MFA status in Cognito
aws cognito-idp admin-get-user \
  --user-pool-id <pool-id> \
  --username <email>

# 2. Check MFA preferences
aws cognito-idp admin-get-user \
  --user-pool-id <pool-id> \
  --username <email> \
  | jq '.MFAOptions, .UserMFASettingList'

# 3. Check pending MFA setup in DynamoDB
aws dynamodb get-item \
  --table-name bbws-portal-dev \
  --key '{"PK": {"S": "USER#<user-id>"}, "SK": {"S": "MFA"}}'
```

### 12.3 Runbook Links

| Runbook | Description | Location |
|---------|-------------|----------|
| User Profile Issues | Troubleshooting user profile problems | `runbooks/user_profile_runbook.md` |
| MFA Troubleshooting | MFA enable/disable issues | `runbooks/mfa_runbook.md` |
| Session Management | Session and token issues | `runbooks/session_runbook.md` |
| Dashboard Performance | Slow dashboard loads | `runbooks/dashboard_runbook.md` |

---

## 13. Tagging

### 13.1 AWS Resource Tags

| Tag | Value |
|-----|-------|
| Project | BBWS |
| Application | CustomerPortalPrivate |
| Component | PortalAuth |
| Service | portal-svc-auth |
| Environment | {dev\|sit\|prod} |
| CostCenter | BBWS-CPP |
| Owner | platform-team |
| ManagedBy | terraform |

### 13.2 Lambda Tags

```hcl
# terraform/variables.tf
variable "common_tags" {
  default = {
    Project     = "BBWS"
    Application = "CustomerPortalPrivate"
    Component   = "PortalAuth"
    Service     = "portal-svc-auth"
    ManagedBy   = "terraform"
  }
}
```

---

## 14. Risks and Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Cognito throttling | Medium | Low | Implement exponential backoff, request limit increase |
| DynamoDB throttling | Medium | Low | On-demand capacity, monitor consumed capacity |
| MFA secret compromise | High | Very Low | Application-level encryption, key rotation |
| Session hijacking | High | Low | Secure cookies, device fingerprinting, IP validation |
| Brute force on MFA | Medium | Medium | Rate limiting (BR-005), account lockout |
| Dashboard service cascade failure | Medium | Low | Circuit breaker, partial response pattern |
| Clock skew causing MFA failures | Low | Medium | Documentation, user guidance |

---

## 15. TBC

| # | Item | Status | Notes |
|---|------|--------|-------|
| TBC-001 | Passkey/WebAuthn support | Open | Phase 2 consideration |
| TBC-002 | SMS MFA option | Open | Cost analysis required |
| TBC-003 | Session device management UI | Open | UX design needed |
| TBC-004 | Activity history page | Open | Requirements refinement |
| TBC-005 | Email change workflow | Open | Security review required |

---

## 16. Definition of Terms

| Term | Definition |
|------|------------|
| JWT | JSON Web Token - stateless authentication token |
| TOTP | Time-based One-Time Password - 6-digit code from authenticator app |
| MFA | Multi-Factor Authentication - additional security beyond password |
| Lambda Authorizer | API Gateway component that validates JWT tokens |
| Recovery Code | One-time backup code for MFA access if device lost |
| Session | Active authentication context for a user device |
| Tenant Isolation | Security principle ensuring users only access their tenant data |
| HATEOAS | Hypermedia as the Engine of Application State - REST API pattern |

---

## 17. Appendices

### Appendix A: Project Structure

```
2_2_bbws_portal_svc_auth/
├── src/
│   ├── __init__.py
│   ├── handlers/
│   │   ├── __init__.py
│   │   ├── get_me.py
│   │   ├── update_me.py
│   │   ├── enable_mfa.py
│   │   ├── verify_mfa.py
│   │   ├── disable_mfa.py
│   │   ├── get_recovery_codes.py
│   │   ├── regenerate_recovery_codes.py
│   │   ├── logout.py
│   │   ├── logout_all.py
│   │   ├── list_sessions.py
│   │   └── get_dashboard.py
│   ├── services/
│   │   ├── __init__.py
│   │   ├── auth_service.py
│   │   ├── cognito_mfa_client.py
│   │   ├── session_service.py
│   │   ├── audit_service.py
│   │   └── dashboard_service.py
│   ├── repositories/
│   │   ├── __init__.py
│   │   ├── user_repository.py
│   │   ├── session_repository.py
│   │   └── audit_repository.py
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── session.py
│   │   ├── audit.py
│   │   └── requests.py
│   └── utils/
│       ├── __init__.py
│       ├── exceptions.py
│       ├── validators.py
│       ├── response_builder.py
│       ├── encryption.py
│       └── rate_limiter.py
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   ├── unit/
│   │   ├── test_auth_service.py
│   │   ├── test_mfa_service.py
│   │   ├── test_session_service.py
│   │   └── test_repositories.py
│   └── integration/
│       ├── test_profile_endpoints.py
│       ├── test_mfa_endpoints.py
│       └── test_session_endpoints.py
├── terraform/
│   ├── main.tf
│   ├── lambda.tf
│   ├── api_gateway.tf
│   ├── iam.tf
│   ├── dynamodb.tf
│   ├── cloudwatch.tf
│   ├── variables.tf
│   └── outputs.tf
├── openapi/
│   └── portal_auth_api.yaml
├── requirements.txt
├── requirements-dev.txt
├── pytest.ini
├── Makefile
└── README.md
```

### Appendix B: Environment Variables

```bash
# Lambda environment variables
COGNITO_USER_POOL_ID=af-south-1_xxxxxxxx
COGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxx
DYNAMODB_TABLE_NAME=bbws-portal-{env}
MFA_ENCRYPTION_KEY_ARN=arn:aws:secretsmanager:af-south-1:xxx:secret:mfa-key
ENVIRONMENT={dev|sit|prod}
LOG_LEVEL=INFO
SITE_SERVICE_URL=https://{env}.portal-api.kimmyai.io/v1.0
BILLING_SERVICE_URL=https://{env}.portal-api.kimmyai.io/v1.0
TICKET_SERVICE_URL=https://{env}.portal-api.kimmyai.io/v1.0
```

### Appendix C: Terraform Module Example

```hcl
# terraform/lambda.tf

module "get_me_lambda" {
  source = "../modules/lambda"

  function_name = "portal-auth-get-me"
  handler       = "src.handlers.get_me.handler"
  runtime       = "python3.12"
  memory_size   = 256
  timeout       = 10
  architecture  = "arm64"

  environment_variables = {
    COGNITO_USER_POOL_ID = var.cognito_user_pool_id
    DYNAMODB_TABLE_NAME  = var.dynamodb_table_name
    ENVIRONMENT          = var.environment
    LOG_LEVEL            = var.log_level
  }

  tags = merge(var.common_tags, {
    Function = "get_me"
  })
}

module "enable_mfa_lambda" {
  source = "../modules/lambda"

  function_name = "portal-auth-enable-mfa"
  handler       = "src.handlers.enable_mfa.handler"
  runtime       = "python3.12"
  memory_size   = 256
  timeout       = 15
  architecture  = "arm64"

  environment_variables = {
    COGNITO_USER_POOL_ID     = var.cognito_user_pool_id
    DYNAMODB_TABLE_NAME      = var.dynamodb_table_name
    MFA_ENCRYPTION_KEY_ARN   = var.mfa_encryption_key_arn
    ENVIRONMENT              = var.environment
    LOG_LEVEL                = var.log_level
  }

  tags = merge(var.common_tags, {
    Function = "enable_mfa"
  })
}

module "get_dashboard_lambda" {
  source = "../modules/lambda"

  function_name = "portal-auth-get-dashboard"
  handler       = "src.handlers.get_dashboard.handler"
  runtime       = "python3.12"
  memory_size   = 512  # Higher memory for parallel calls
  timeout       = 30
  architecture  = "arm64"

  environment_variables = {
    COGNITO_USER_POOL_ID = var.cognito_user_pool_id
    DYNAMODB_TABLE_NAME  = var.dynamodb_table_name
    SITE_SERVICE_URL     = var.site_service_url
    BILLING_SERVICE_URL  = var.billing_service_url
    TICKET_SERVICE_URL   = var.ticket_service_url
    ENVIRONMENT          = var.environment
    LOG_LEVEL            = var.log_level
  }

  tags = merge(var.common_tags, {
    Function = "get_dashboard"
  })
}
```

---

## 18. References

| Document | Description | Location |
|----------|-------------|----------|
| HLD 2.2 Customer Portal Private | Parent architecture document | `HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md` |
| BRS 2.2 Customer Portal Private | Business requirements | `BRS/2.2_BRS_Customer_Portal_Private.md` |
| LLD 2.1.2 Auth Lambda | Public auth reference | `LLDs/2.1.2_LLD_Auth_Lambda.md` |
| AWS Cognito MFA | Cognito TOTP MFA documentation | [AWS Docs](https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-mfa-totp.html) |
| Pydantic Documentation | Data validation library | [Pydantic](https://docs.pydantic.dev/) |
| OpenAPI 3.0 Specification | API specification standard | [OpenAPI](https://spec.openapis.org/oas/v3.0.3) |

---

## 19. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Technical Lead | | | |
| Security Architect | | | |
| Product Owner | | | |
| DevOps Lead | | | |

---

**End of Document**
