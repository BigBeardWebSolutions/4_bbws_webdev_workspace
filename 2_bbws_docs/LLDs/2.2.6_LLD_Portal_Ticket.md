# Portal Ticket Service - Low-Level Design

**Version**: 1.0
**Created**: 2026-01-20
**Status**: Draft
**Component**: Portal Ticket Service (`2_2_bbws_portal_svc_ticket`)
**Parent HLD**: [HLD 2.2 BBWS Customer Portal Private](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md)
**Parent BRS**: [BRS 2.2 Customer Portal Private](../BRS/2.2_BRS_Customer_Portal_Private.md) - Epic 9 (Support Tickets)

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-20 | LLD Architect Agent | Initial version covering Epic 9 Support Tickets functionality (US 9.1-9.4) |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [High Level Epic Overview](#2-high-level-epic-overview)
3. [Architecture Diagram](#3-architecture-diagram)
4. [API Design](#4-api-design)
5. [Lambda Functions](#5-lambda-functions)
6. [Sequence Diagrams](#6-sequence-diagrams)
7. [Data Models](#7-data-models)
8. [Security](#8-security)
9. [Error Handling](#9-error-handling)
10. [Monitoring and Alerting](#10-monitoring-and-alerting)
11. [NFRs](#11-nfrs)
12. [Troubleshooting Playbook](#12-troubleshooting-playbook)
13. [Tagging](#13-tagging)
14. [Risks and Mitigations](#14-risks-and-mitigations)
15. [TBC](#15-tbc)
16. [Definition of Terms](#16-definition-of-terms)
17. [Appendices](#17-appendices)
18. [References](#18-references)
19. [Signoff](#19-signoff)

---

## 1. Introduction

### 1.1 Purpose

This LLD provides implementation-level details for the Portal Ticket Service, which handles customer support ticket creation, viewing, and communication. The service enables customers to submit support requests, track ticket status, and communicate with the support team through follow-up messages.

### 1.2 Scope

| In Scope | Out of Scope |
|----------|--------------|
| Ticket creation and submission | Ticket assignment to agents (Admin Portal) |
| Ticket listing and filtering | SLA management (Admin Portal) |
| Ticket detail viewing | Agent responses (Admin Portal) |
| Follow-up message submission | Escalation workflows (Admin Portal) |
| File attachments | Knowledge base / FAQ |
| Email notifications | Live chat support |
| Ticket status tracking | Phone support integration |

### 1.3 Component Overview

| Attribute | Value |
|-----------|-------|
| Repository | `2_2_bbws_portal_svc_ticket` |
| Runtime | Python 3.12 |
| Memory | 256MB (API handlers), 512MB (attachment processor) |
| Timeout | 30s |
| Architecture | arm64 |
| API Prefix | `/portal/tickets/*` |
| Authentication | Required (Cognito JWT) |

### 1.4 BRS/HLD References

| Reference | Document | Section |
|-----------|----------|---------|
| Epic 9 | BRS 2.2 | Support Tickets |
| US 9.1 | BRS 2.2 | View My Tickets |
| US 9.2 | BRS 2.2 | Create Support Ticket |
| US 9.3 | BRS 2.2 | View Ticket Details |
| US 9.4 | BRS 2.2 | Reply to Ticket |
| CP-070 | BRS 2.2 | My Tickets screen |
| CP-071 | BRS 2.2 | Create Ticket screen |
| CP-072 | BRS 2.2 | Ticket Details screen |
| CP-073 | BRS 2.2 | Ticket Follow-ups screen |
| CP-074 | BRS 2.2 | Reply to Ticket screen |

### 1.5 Dependencies

| Dependency | Purpose |
|------------|---------|
| AWS DynamoDB | Ticket and follow-up storage |
| AWS S3 | Attachment storage |
| AWS SES | Email notifications |
| AWS SNS | Support team alerts |
| AWS EventBridge | Async event processing |
| Lambda Authorizer | JWT validation, tenant isolation |

---

## 2. High Level Epic Overview

### 2.1 Epic 9: Support Tickets (US 9.1-9.4)

| User Story # | User Story | Lambda Function | Test Scenario(s) |
|--------------|------------|-----------------|------------------|
| US 9.1 | View My Tickets | `list_tickets` | Given valid JWT, then tickets for tenant returned |
| US 9.2 | Create Support Ticket | `create_ticket` | Given valid data, then ticket created with unique ID |
| US 9.3 | View Ticket Details | `get_ticket`, `list_followups` | Given valid ticket ID, then ticket thread displayed |
| US 9.4 | Reply to Ticket | `create_followup` | Given open ticket, then follow-up added to thread |

### 2.2 Ticket Lifecycle

```
                              TICKET LIFECYCLE
+------------------------------------------------------------------------+
|                                                                        |
|   CUSTOMER ACTION              STATUS              SUPPORT ACTION      |
|   ----------------             ------              --------------      |
|                                                                        |
|   [Create Ticket] --------->  OPEN  <----------- [Ticket Received]    |
|                                 |                                      |
|                                 v                                      |
|                            IN_PROGRESS <-------- [Agent Assigned]      |
|                                 |                                      |
|             +-------------------+-------------------+                  |
|             |                   |                   |                  |
|             v                   v                   v                  |
|   [Add Follow-up]      [Agent Responds]    [Request Info]             |
|             |                   |                   |                  |
|             +-------------------+-------------------+                  |
|                                 |                                      |
|                                 v                                      |
|                             RESOLVED <---------- [Mark Resolved]       |
|                                 |                                      |
|   [No Response 7 days]         v                                       |
|             |              [Re-open?]                                   |
|             |                   |                                      |
|             v                   v                                      |
|          CLOSED <--------- [Close Ticket]                              |
|                                                                        |
+------------------------------------------------------------------------+
```

### 2.3 Ticket Categories

| Category | Description | Auto-Routing |
|----------|-------------|--------------|
| `billing` | Payment, subscription, invoice issues | Billing team queue |
| `technical` | Site issues, errors, performance | Technical support queue |
| `account` | User management, access issues | Account team queue |
| `migration` | Migration issues, requests | Migration team queue |
| `general` | General inquiries | General queue |

### 2.4 Ticket Priority

| Priority | SLA Response | SLA Resolution | Description |
|----------|--------------|----------------|-------------|
| `critical` | 1 hour | 4 hours | Site down, security breach |
| `high` | 4 hours | 24 hours | Major functionality broken |
| `medium` | 24 hours | 72 hours | Feature not working correctly |
| `low` | 48 hours | 1 week | General questions, minor issues |

---

## 3. Architecture Diagram

### 3.1 Component Architecture

```
                               PORTAL TICKET SERVICE ARCHITECTURE
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  +---------+          +----------------+          +------------------+                           |
|  | React   |  HTTPS   |   API Gateway  |          |  Lambda          |                          |
|  | SPA     |--------->|   (REST)       |--------->|  Authorizer      |                          |
|  | (S3/CF) |          |                |          |  (JWT Validate)  |                          |
|  +---------+          +-------+--------+          +--------+---------+                          |
|                               |                            |                                     |
|                               | (Authenticated)            | (IAM Policy)                        |
|                               v                            v                                     |
|                       +-------+--------------------------------+                                 |
|                       |           TICKET API LAMBDAS           |                                 |
|                       |  +-------------+ +-------------+       |                                 |
|                       |  |list_tickets | |create_ticket|       |                                 |
|                       |  +-------------+ +-------------+       |                                 |
|                       |  +-------------+ +---------------+     |                                 |
|                       |  | get_ticket  | |list_followups |     |                                 |
|                       |  +-------------+ +---------------+     |                                 |
|                       |  +----------------+                    |                                 |
|                       |  | create_followup|                    |                                 |
|                       |  +----------------+                    |                                 |
|                       +----------+-------------------------+---+                                 |
|                                  |                         |                                     |
|                                  v                         v                                     |
|                       +------------------+      +----------------------+                         |
|                       |    DynamoDB      |      |    EventBridge       |                        |
|                       |  (Single Table)  |      |  (Ticket Events)     |                        |
|                       |                  |      |                      |                        |
|                       | - TICKET         |      | - ticket.created     |                        |
|                       | - FOLLOWUP       |      | - ticket.replied     |                        |
|                       +--------+---------+      | - ticket.escalated   |                        |
|                                |                +-----------+----------+                        |
|                                |                            |                                    |
|                       +--------+--------+         +---------+---------+                         |
|                       |                 |         |                   |                         |
|                       v                 v         v                   v                         |
|            +------------------+  +------------+  +--------+   +----------------+                |
|            |       S3         |  | CloudWatch |  |  SES   |   |      SNS       |               |
|            | (Attachments)    |  |   (Logs)   |  | (Email)|   | (Support Alert)|               |
|            |                  |  |            |  |        |   |                |               |
|            | - Max 10MB/file  |  | - Ticket   |  | - New  |   | - New ticket   |               |
|            | - Virus scanned  |  |   events   |  | ticket |   | - Escalation   |               |
|            | - 90 day TTL     |  |            |  | - Reply|   | - Critical     |               |
|            +------------------+  +------------+  +--------+   +----------------+                |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+

LEGEND:
+------+  Component/Service
------->  Data Flow
   |      Dependency
```

### 3.2 Class Diagram

```
+--------------------------------------------------------------------------------------------------+
|                                      CLASS STRUCTURE                                              |
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  +-------------------------+              +-------------------------+                            |
|  |   TicketController      |              |   TicketService         |                            |
|  +-------------------------+              +-------------------------+                            |
|  | + list_tickets()        |------------->| + create(dto)           |                            |
|  | + create_ticket()       |              | + get_by_id(id)         |                            |
|  | + get_ticket()          |              | + list_for_tenant(t_id) |                            |
|  | + list_followups()      |              | + add_followup(id, dto) |                            |
|  | + create_followup()     |              | + get_followups(id)     |                            |
|  +-------------------------+              +------------+------------+                            |
|                                                        |                                         |
|                                           +------------+------------+                            |
|                                           |                         |                            |
|                                           v                         v                            |
|                            +-------------------------+  +-------------------------+              |
|                            |  TicketRepository       |  |  AttachmentService      |              |
|                            +-------------------------+  +-------------------------+              |
|                            | + save(ticket)          |  | + upload(file, ticket)  |              |
|                            | + find_by_id(id)        |  | + get_url(key)          |              |
|                            | + find_by_tenant(t_id)  |  | + delete(key)           |              |
|                            | + add_followup(id, f)   |  | + scan_virus(file)      |              |
|                            | + get_followups(id)     |  +-------------------------+              |
|                            +-------------------------+                                           |
|                                                                                                  |
|  +-------------------------+              +-------------------------+                            |
|  |   NotificationService   |              |   EventPublisher        |                            |
|  +-------------------------+              +-------------------------+                            |
|  | + send_ticket_created() |              | + publish(event_type,   |                            |
|  | + send_followup_added() |              |           payload)      |                            |
|  | + alert_support_team()  |              +-------------------------+                            |
|  +-------------------------+                                                                     |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+

DATA CLASSES:

+-------------------------+     +-------------------------+     +-------------------------+
|   Ticket (Entity)       |     |   FollowUp (Entity)     |     |   Attachment            |
+-------------------------+     +-------------------------+     +-------------------------+
| + id: str               |     | + id: str               |     | + id: str               |
| + tenant_id: str        |     | + ticket_id: str        |     | + filename: str         |
| + subject: str          |     | + author_type: str      |     | + content_type: str     |
| + description: str      |     | + author_id: str        |     | + size_bytes: int       |
| + category: Category    |     | + author_name: str      |     | + s3_key: str           |
| + priority: Priority    |     | + message: str          |     | + created_at: datetime  |
| + status: TicketStatus  |     | + attachments: List     |     +-------------------------+
| + site_id: str (opt)    |     | + created_at: datetime  |
| + attachments: List     |     +-------------------------+
| + created_at: datetime  |
| + created_by: str       |
| + updated_at: datetime  |
| + resolved_at: datetime |
| + closed_at: datetime   |
+-------------------------+

ENUMS:

+-------------------------+     +-------------------------+     +-------------------------+
|   Category              |     |   Priority              |     |   TicketStatus          |
+-------------------------+     +-------------------------+     +-------------------------+
| BILLING = "billing"     |     | CRITICAL = "critical"   |     | OPEN = "open"           |
| TECHNICAL = "technical" |     | HIGH = "high"           |     | IN_PROGRESS = "progress"|
| ACCOUNT = "account"     |     | MEDIUM = "medium"       |     | RESOLVED = "resolved"   |
| MIGRATION = "migration" |     | LOW = "low"             |     | CLOSED = "closed"       |
| GENERAL = "general"     |     +-------------------------+     +-------------------------+
+-------------------------+

+-------------------------+
|   AuthorType            |
+-------------------------+
| CUSTOMER = "customer"   |
| SUPPORT = "support"     |
| SYSTEM = "system"       |
+-------------------------+
```

---

## 4. API Design

### 4.1 OpenAPI Specification

```yaml
openapi: 3.0.3
info:
  title: Portal Ticket Service API
  description: Support ticket management for BBWS Customer Portal
  version: 1.0.0
  contact:
    name: BBWS Platform Team
    email: platform@kimmyai.io

servers:
  - url: https://portal-api.kimmyai.io/v1.0
    description: Production
  - url: https://dev.portal-api.kimmyai.io/v1.0
    description: Development

security:
  - bearerAuth: []

paths:
  /portal/tickets:
    get:
      summary: List tickets for current user
      operationId: listTickets
      tags: [Tickets]
      parameters:
        - $ref: '#/components/parameters/PageToken'
        - $ref: '#/components/parameters/PageSize'
        - name: status
          in: query
          schema:
            type: string
            enum: [open, in_progress, resolved, closed]
        - name: category
          in: query
          schema:
            type: string
            enum: [billing, technical, account, migration, general]
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [created_at, updated_at]
            default: updated_at
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Ticket list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Create new ticket
      operationId: createTicket
      tags: [Tickets]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/CreateTicketRequest'
      responses:
        '201':
          description: Ticket created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /portal/tickets/{ticketId}:
    get:
      summary: Get ticket details
      operationId: getTicket
      tags: [Tickets]
      parameters:
        - $ref: '#/components/parameters/TicketId'
      responses:
        '200':
          description: Ticket details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /portal/tickets/{ticketId}/followups:
    get:
      summary: List follow-ups for ticket
      operationId: listFollowups
      tags: [Tickets]
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/PageToken'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: Follow-up list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FollowupListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      summary: Add follow-up to ticket
      operationId: createFollowup
      tags: [Tickets]
      parameters:
        - $ref: '#/components/parameters/TicketId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/CreateFollowupRequest'
      responses:
        '201':
          description: Follow-up created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FollowupResponse'
        '400':
          description: Ticket is closed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /portal/tickets/{ticketId}/attachments/{attachmentId}:
    get:
      summary: Download attachment
      operationId: downloadAttachment
      tags: [Tickets]
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - name: attachmentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Presigned URL for download
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttachmentDownloadResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    TicketId:
      name: ticketId
      in: path
      required: true
      schema:
        type: string
        pattern: '^TKT-[A-Z0-9]{8}$'
        example: TKT-ABC12345

    PageToken:
      name: pageToken
      in: query
      schema:
        type: string

    PageSize:
      name: pageSize
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    CreateTicketRequest:
      type: object
      required:
        - subject
        - description
        - category
        - priority
      properties:
        subject:
          type: string
          minLength: 10
          maxLength: 200
          description: Brief summary of the issue
          example: "Cannot access WordPress admin panel"
        description:
          type: string
          minLength: 20
          maxLength: 5000
          description: Detailed description of the issue
        category:
          type: string
          enum: [billing, technical, account, migration, general]
        priority:
          type: string
          enum: [critical, high, medium, low]
        siteId:
          type: string
          format: uuid
          description: Related site ID (optional)
        attachments:
          type: array
          items:
            type: string
            format: binary
          maxItems: 5
          description: File attachments (max 10MB each, max 5 files)

    CreateFollowupRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          minLength: 1
          maxLength: 5000
          description: Follow-up message content
        attachments:
          type: array
          items:
            type: string
            format: binary
          maxItems: 5

    TicketResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Ticket'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
        _links:
          $ref: '#/components/schemas/TicketLinks'

    Ticket:
      type: object
      properties:
        id:
          type: string
          pattern: '^TKT-[A-Z0-9]{8}$'
          example: TKT-ABC12345
        tenantId:
          type: string
          format: uuid
        subject:
          type: string
        description:
          type: string
        category:
          type: string
          enum: [billing, technical, account, migration, general]
        priority:
          type: string
          enum: [critical, high, medium, low]
        status:
          type: string
          enum: [open, in_progress, resolved, closed]
        siteId:
          type: string
          format: uuid
        siteName:
          type: string
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/Attachment'
        followupCount:
          type: integer
        lastFollowupAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: string
        createdByName:
          type: string
        updatedAt:
          type: string
          format: date-time
        resolvedAt:
          type: string
          format: date-time
        closedAt:
          type: string
          format: date-time

    Attachment:
      type: object
      properties:
        id:
          type: string
        filename:
          type: string
        contentType:
          type: string
        sizeBytes:
          type: integer
        createdAt:
          type: string
          format: date-time

    TicketListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Ticket'
        meta:
          allOf:
            - $ref: '#/components/schemas/ResponseMeta'
            - type: object
              properties:
                totalCount:
                  type: integer
                pageToken:
                  type: string
                statusCounts:
                  type: object
                  properties:
                    open:
                      type: integer
                    in_progress:
                      type: integer
                    resolved:
                      type: integer
                    closed:
                      type: integer
        _links:
          $ref: '#/components/schemas/ListLinks'

    FollowupResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Followup'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    Followup:
      type: object
      properties:
        id:
          type: string
        ticketId:
          type: string
        authorType:
          type: string
          enum: [customer, support, system]
        authorId:
          type: string
        authorName:
          type: string
        message:
          type: string
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/Attachment'
        createdAt:
          type: string
          format: date-time

    FollowupListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Followup'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    AttachmentDownloadResponse:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: Presigned URL valid for 15 minutes
        expiresAt:
          type: string
          format: date-time

    TicketLinks:
      type: object
      properties:
        self:
          $ref: '#/components/schemas/Link'
        followups:
          $ref: '#/components/schemas/Link'
        site:
          $ref: '#/components/schemas/Link'
        tenant:
          $ref: '#/components/schemas/Link'

    ListLinks:
      type: object
      properties:
        self:
          $ref: '#/components/schemas/Link'
        next:
          $ref: '#/components/schemas/Link'
        create:
          $ref: '#/components/schemas/Link'

    Link:
      type: object
      properties:
        href:
          type: string
          format: uri

    ResponseMeta:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        requestId:
          type: string

    ValidationErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: "VALIDATION_ERROR"
            message:
              type: string
            fields:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  message:
                    type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
```

### 4.2 HATEOAS Links

```json
{
  "data": {
    "id": "TKT-ABC12345",
    "subject": "Cannot access WordPress admin",
    "status": "open"
  },
  "_links": {
    "self": { "href": "/portal/tickets/TKT-ABC12345" },
    "followups": { "href": "/portal/tickets/TKT-ABC12345/followups" },
    "site": { "href": "/portal/tenants/t_123/sites/site_xyz" },
    "tenant": { "href": "/portal/tenants/t_123" }
  }
}
```

---

## 5. Lambda Functions

### 5.1 Function Inventory

| # | Function Name | Trigger | Memory | Timeout | Description |
|---|---------------|---------|--------|---------|-------------|
| 1 | `list_tickets` | API Gateway | 256MB | 30s | List tickets for current user/tenant |
| 2 | `create_ticket` | API Gateway | 512MB | 30s | Create new support ticket |
| 3 | `get_ticket` | API Gateway | 256MB | 30s | Get ticket details |
| 4 | `list_followups` | API Gateway | 256MB | 30s | List follow-ups for ticket |
| 5 | `create_followup` | API Gateway | 512MB | 30s | Add follow-up to ticket |
| 6 | `process_attachment` | S3 Event | 512MB | 60s | Virus scan uploaded attachment |
| 7 | `send_notification` | EventBridge | 256MB | 30s | Send email notifications |

### 5.2 Function: list_tickets

```python
"""
List Tickets Handler
Lists all tickets for the authenticated user's tenant(s).
"""

from typing import Any, Optional
from datetime import datetime

from aws_lambda_powertools import Logger, Tracer
from aws_lambda_powertools.event_handler import APIGatewayRestResolver
from pydantic import BaseModel, Field

from src.services.ticket_service import TicketService
from src.models.ticket import TicketStatus, Category
from src.utils.response import api_response, hateoas_links

logger = Logger()
tracer = Tracer()
app = APIGatewayRestResolver()

ticket_service = TicketService()


class ListTicketsParams(BaseModel):
    """Query parameters for listing tickets."""
    status: Optional[TicketStatus] = None
    category: Optional[Category] = None
    sort_by: str = Field(default="updated_at", alias="sortBy")
    sort_order: str = Field(default="desc", alias="sortOrder")
    page_size: int = Field(default=20, ge=1, le=100, alias="pageSize")
    page_token: Optional[str] = Field(default=None, alias="pageToken")


@app.get("/portal/tickets")
@tracer.capture_method
def list_tickets() -> dict[str, Any]:
    """
    List tickets for the authenticated user.

    Returns tickets across all tenants the user has access to,
    ordered by most recently updated.
    """
    # Parse query parameters
    params = ListTicketsParams(**app.current_event.query_string_parameters or {})

    # Get user context from authorizer
    user_id = app.current_event.request_context.authorizer.claims.get('sub')
    tenant_ids = app.current_event.request_context.authorizer.claims.get('custom:tenant_ids', '').split(',')

    logger.info("Listing tickets", extra={
        "user_id": user_id,
        "tenant_ids": tenant_ids,
        "status_filter": params.status.value if params.status else None
    })

    # Query tickets
    result = ticket_service.list_for_user(
        tenant_ids=tenant_ids,
        status=params.status,
        category=params.category,
        sort_by=params.sort_by,
        sort_order=params.sort_order,
        page_size=params.page_size,
        page_token=params.page_token
    )

    # Get status counts for summary
    status_counts = ticket_service.get_status_counts(tenant_ids)

    return api_response(
        data=[t.to_dict() for t in result.items],
        meta={
            "totalCount": result.total_count,
            "pageToken": result.next_page_token,
            "statusCounts": status_counts
        },
        links=hateoas_links(
            self="/portal/tickets",
            next=f"/portal/tickets?pageToken={result.next_page_token}" if result.next_page_token else None,
            create="/portal/tickets"
        )
    )


@logger.inject_lambda_context
@tracer.capture_lambda_handler
def handler(event: dict, context: Any) -> dict:
    """Lambda entry point."""
    return app.resolve(event, context)
```

### 5.3 Function: create_ticket

```python
"""
Create Ticket Handler
Creates a new support ticket with optional attachments.
"""

import uuid
from datetime import datetime
from typing import Any, List

from aws_lambda_powertools import Logger, Tracer
from aws_lambda_powertools.event_handler import APIGatewayRestResolver
from aws_lambda_powertools.event_handler.exceptions import BadRequestError
from pydantic import BaseModel, Field, validator

from src.services.ticket_service import TicketService
from src.services.attachment_service import AttachmentService
from src.services.notification_service import NotificationService
from src.services.event_publisher import EventPublisher
from src.models.ticket import Ticket, TicketStatus, Category, Priority
from src.utils.response import api_response, hateoas_links
from src.utils.ticket_id import generate_ticket_id

logger = Logger()
tracer = Tracer()
app = APIGatewayRestResolver()

ticket_service = TicketService()
attachment_service = AttachmentService()
notification_service = NotificationService()
event_publisher = EventPublisher()


class CreateTicketRequest(BaseModel):
    """Request model for creating a ticket."""
    subject: str = Field(..., min_length=10, max_length=200)
    description: str = Field(..., min_length=20, max_length=5000)
    category: Category
    priority: Priority
    site_id: str | None = Field(default=None, alias="siteId")

    @validator('subject')
    def validate_subject(cls, v):
        if v.strip() == "":
            raise ValueError('Subject cannot be empty')
        return v.strip()


@app.post("/portal/tickets")
@tracer.capture_method
def create_ticket() -> dict[str, Any]:
    """
    Create a new support ticket.

    Handles multipart form data with optional file attachments.
    """
    # Get user context from authorizer
    user_id = app.current_event.request_context.authorizer.claims.get('sub')
    user_email = app.current_event.request_context.authorizer.claims.get('email')
    user_name = app.current_event.request_context.authorizer.claims.get('name', user_email)
    tenant_id = app.current_event.request_context.authorizer.claims.get('custom:current_tenant')

    if not tenant_id:
        raise BadRequestError("No tenant selected. Please select a tenant first.")

    # Parse form data (handles both JSON and multipart)
    body = app.current_event.json_body or {}
    request = CreateTicketRequest(**body)

    logger.info("Creating ticket", extra={
        "tenant_id": tenant_id,
        "user_id": user_id,
        "category": request.category.value,
        "priority": request.priority.value
    })

    # Generate unique ticket ID
    ticket_id = generate_ticket_id()  # Format: TKT-XXXXXXXX

    # Create ticket entity
    ticket = Ticket(
        id=ticket_id,
        tenant_id=tenant_id,
        subject=request.subject,
        description=request.description,
        category=request.category,
        priority=request.priority,
        status=TicketStatus.OPEN,
        site_id=request.site_id,
        created_at=datetime.utcnow(),
        created_by=user_id,
        created_by_name=user_name,
        updated_at=datetime.utcnow()
    )

    # Handle file attachments if present
    attachments = []
    if hasattr(app.current_event, 'decoded_body') and app.current_event.decoded_body:
        files = app.current_event.decoded_body.get('attachments', [])
        for file_data in files[:5]:  # Max 5 attachments
            attachment = attachment_service.upload(
                file_data=file_data,
                ticket_id=ticket_id,
                uploaded_by=user_id
            )
            attachments.append(attachment)

    ticket.attachments = attachments

    # Save ticket
    saved_ticket = ticket_service.create(ticket)

    # Send notifications asynchronously via EventBridge
    event_publisher.publish(
        event_type="ticket.created",
        payload={
            "ticket_id": saved_ticket.id,
            "tenant_id": tenant_id,
            "category": saved_ticket.category.value,
            "priority": saved_ticket.priority.value,
            "subject": saved_ticket.subject,
            "created_by_email": user_email
        }
    )

    logger.info("Ticket created", extra={
        "ticket_id": saved_ticket.id,
        "status": saved_ticket.status.value
    })

    return api_response(
        data=saved_ticket.to_dict(),
        status_code=201,
        links=hateoas_links(
            self=f"/portal/tickets/{saved_ticket.id}",
            followups=f"/portal/tickets/{saved_ticket.id}/followups",
            tenant=f"/portal/tenants/{tenant_id}"
        )
    )


@logger.inject_lambda_context
@tracer.capture_lambda_handler
def handler(event: dict, context: Any) -> dict:
    """Lambda entry point."""
    return app.resolve(event, context)
```

### 5.4 Function: create_followup

```python
"""
Create Follow-up Handler
Adds a follow-up message to an existing ticket.
"""

import uuid
from datetime import datetime
from typing import Any

from aws_lambda_powertools import Logger, Tracer
from aws_lambda_powertools.event_handler import APIGatewayRestResolver
from aws_lambda_powertools.event_handler.exceptions import BadRequestError, NotFoundError
from pydantic import BaseModel, Field

from src.services.ticket_service import TicketService
from src.services.attachment_service import AttachmentService
from src.services.event_publisher import EventPublisher
from src.models.ticket import TicketStatus, AuthorType
from src.models.followup import FollowUp
from src.utils.response import api_response

logger = Logger()
tracer = Tracer()
app = APIGatewayRestResolver()

ticket_service = TicketService()
attachment_service = AttachmentService()
event_publisher = EventPublisher()


class CreateFollowupRequest(BaseModel):
    """Request model for creating a follow-up."""
    message: str = Field(..., min_length=1, max_length=5000)


@app.post("/portal/tickets/<ticket_id>/followups")
@tracer.capture_method
def create_followup(ticket_id: str) -> dict[str, Any]:
    """
    Add a follow-up message to a ticket.

    Only allowed if ticket is not closed.
    """
    # Get user context from authorizer
    user_id = app.current_event.request_context.authorizer.claims.get('sub')
    user_email = app.current_event.request_context.authorizer.claims.get('email')
    user_name = app.current_event.request_context.authorizer.claims.get('name', user_email)
    user_tenant_ids = app.current_event.request_context.authorizer.claims.get('custom:tenant_ids', '').split(',')

    # Get ticket and verify access
    ticket = ticket_service.get_by_id(ticket_id)

    if not ticket:
        raise NotFoundError(f"Ticket {ticket_id} not found")

    if ticket.tenant_id not in user_tenant_ids:
        raise NotFoundError(f"Ticket {ticket_id} not found")

    # Check ticket status
    if ticket.status == TicketStatus.CLOSED:
        raise BadRequestError(
            "This ticket is closed. Please create a new ticket for further assistance."
        )

    # Parse request
    body = app.current_event.json_body or {}
    request = CreateFollowupRequest(**body)

    logger.info("Creating follow-up", extra={
        "ticket_id": ticket_id,
        "user_id": user_id
    })

    # Create follow-up entity
    followup = FollowUp(
        id=str(uuid.uuid4()),
        ticket_id=ticket_id,
        author_type=AuthorType.CUSTOMER,
        author_id=user_id,
        author_name=user_name,
        message=request.message,
        created_at=datetime.utcnow()
    )

    # Handle file attachments if present
    attachments = []
    if hasattr(app.current_event, 'decoded_body') and app.current_event.decoded_body:
        files = app.current_event.decoded_body.get('attachments', [])
        for file_data in files[:5]:
            attachment = attachment_service.upload(
                file_data=file_data,
                ticket_id=ticket_id,
                followup_id=followup.id,
                uploaded_by=user_id
            )
            attachments.append(attachment)

    followup.attachments = attachments

    # Save follow-up
    saved_followup = ticket_service.add_followup(ticket_id, followup)

    # Update ticket updated_at timestamp
    ticket_service.update_timestamp(ticket_id)

    # Publish event for notifications
    event_publisher.publish(
        event_type="ticket.followup_added",
        payload={
            "ticket_id": ticket_id,
            "followup_id": saved_followup.id,
            "tenant_id": ticket.tenant_id,
            "author_type": "customer",
            "author_email": user_email
        }
    )

    logger.info("Follow-up created", extra={
        "ticket_id": ticket_id,
        "followup_id": saved_followup.id
    })

    return api_response(
        data=saved_followup.to_dict(),
        status_code=201
    )


@logger.inject_lambda_context
@tracer.capture_lambda_handler
def handler(event: dict, context: Any) -> dict:
    """Lambda entry point."""
    return app.resolve(event, context)
```

### 5.5 Function: send_notification

```python
"""
Send Notification Handler
Handles EventBridge events to send email notifications.
"""

from typing import Any

from aws_lambda_powertools import Logger, Tracer
import boto3

from src.services.ticket_service import TicketService
from src.services.user_service import UserService
from src.templates.email_templates import (
    TICKET_CREATED_CUSTOMER,
    TICKET_CREATED_SUPPORT,
    FOLLOWUP_ADDED_SUPPORT
)

logger = Logger()
tracer = Tracer()

ticket_service = TicketService()
user_service = UserService()
ses_client = boto3.client('ses')
sns_client = boto3.client('sns')

SUPPORT_EMAIL = "support@kimmyai.io"
SUPPORT_SNS_TOPIC = "arn:aws:sns:{region}:{account}:bbws-support-alerts"


@tracer.capture_method
def handle_ticket_created(payload: dict):
    """Handle ticket.created event."""
    ticket_id = payload['ticket_id']
    created_by_email = payload['created_by_email']
    category = payload['category']
    priority = payload['priority']
    subject = payload['subject']

    # Send confirmation email to customer
    ses_client.send_email(
        Source=SUPPORT_EMAIL,
        Destination={'ToAddresses': [created_by_email]},
        Message={
            'Subject': {'Data': f"Support Ticket Created: {ticket_id}"},
            'Body': {
                'Html': {
                    'Data': TICKET_CREATED_CUSTOMER.format(
                        ticket_id=ticket_id,
                        subject=subject
                    )
                }
            }
        }
    )

    # Alert support team
    sns_client.publish(
        TopicArn=SUPPORT_SNS_TOPIC,
        Subject=f"[{priority.upper()}] New Ticket: {ticket_id}",
        Message=f"""
New support ticket submitted.

Ticket ID: {ticket_id}
Category: {category}
Priority: {priority}
Subject: {subject}

View in Admin Portal: https://admin.kimmyai.io/tickets/{ticket_id}
        """,
        MessageAttributes={
            'priority': {'DataType': 'String', 'StringValue': priority},
            'category': {'DataType': 'String', 'StringValue': category}
        }
    )

    logger.info("Ticket created notifications sent", extra={"ticket_id": ticket_id})


@tracer.capture_method
def handle_followup_added(payload: dict):
    """Handle ticket.followup_added event."""
    ticket_id = payload['ticket_id']
    followup_id = payload['followup_id']
    author_type = payload['author_type']

    if author_type == 'customer':
        # Customer added follow-up, notify support
        sns_client.publish(
            TopicArn=SUPPORT_SNS_TOPIC,
            Subject=f"Customer Reply: {ticket_id}",
            Message=f"""
Customer has replied to ticket {ticket_id}.

View in Admin Portal: https://admin.kimmyai.io/tickets/{ticket_id}
            """
        )

    logger.info("Follow-up notifications sent", extra={
        "ticket_id": ticket_id,
        "followup_id": followup_id
    })


@logger.inject_lambda_context
@tracer.capture_lambda_handler
def handler(event: dict, context: Any) -> dict:
    """Lambda entry point for EventBridge."""
    event_type = event.get('detail-type')
    payload = event.get('detail', {})

    logger.info("Processing notification event", extra={
        "event_type": event_type
    })

    if event_type == 'ticket.created':
        handle_ticket_created(payload)
    elif event_type == 'ticket.followup_added':
        handle_followup_added(payload)
    else:
        logger.warning("Unknown event type", extra={"event_type": event_type})

    return {"status": "processed"}
```

---

## 6. Sequence Diagrams

### 6.1 Create Ticket

```
                              CREATE TICKET SEQUENCE
+--------+    +----------+    +---------+    +--------+    +-------+    +-------+
| React  |    | API GW   |    | Lambda  |    | DynamoDB|    |  S3   |    | Event |
| SPA    |    |          |    |         |    |         |    |       |    | Bridge|
+---+----+    +----+-----+    +----+----+    +----+----+    +---+---+    +---+---+
    |              |               |              |             |            |
    | POST /tickets (multipart)    |              |             |            |
    |------------->|               |              |             |            |
    |              | Invoke        |              |             |            |
    |              |-------------->|              |             |            |
    |              |               |              |             |            |
    |              |               | Validate input             |            |
    |              |               |------+      |             |            |
    |              |               |<-----+      |             |            |
    |              |               |              |             |            |
    |              |               | Generate ticket ID         |            |
    |              |               |------+      |             |            |
    |              |               |<-----+   TKT-XXXXXXXX     |            |
    |              |               |              |             |            |
    |              |               | Upload attachments         |            |
    |              |               |---------------------------------------->|
    |              |               |<----------------------------------------|
    |              |               |              |             |            |
    |              |               | Save ticket  |             |            |
    |              |               |------------->|             |            |
    |              |               |<-------------|             |            |
    |              |               |              |             |            |
    |              |               | Publish ticket.created     |            |
    |              |               |------------------------------------------------>|
    |              |               |              |             |            |
    |              | 201 Created   |              |             |            |
    |<-------------|<--------------|              |             |            |
    |              |  {id: "TKT-ABC12345"}        |             |            |
    |              |               |              |             |            |
    |              |               |              |             | Send email |
    |              |               |              |             |<-----------|
    |              |               |              |             |            |
```

### 6.2 View Ticket Thread

```
                           VIEW TICKET THREAD SEQUENCE
+--------+    +----------+    +---------+    +---------+
| React  |    | API GW   |    | Lambda  |    | DynamoDB|
| SPA    |    |          |    |         |    |         |
+---+----+    +----+-----+    +----+----+    +----+----+
    |              |               |              |
    | GET /tickets/{id}            |              |
    |------------->|               |              |
    |              | Invoke        |              |
    |              |-------------->|              |
    |              |               |              |
    |              |               | Query ticket |
    |              |               |------------->|
    |              |               |<-------------|
    |              |               |              |
    |              |               | Verify tenant access
    |              |               |------+      |
    |              |               |<-----+      |
    |              |               |              |
    |              | 200 OK        |              |
    |<-------------|<--------------|              |
    |              |  {ticket data}|              |
    |              |               |              |
    | GET /tickets/{id}/followups  |              |
    |------------->|               |              |
    |              |-------------->|              |
    |              |               |              |
    |              |               | Query followups
    |              |               |------------->|
    |              |               |<-------------|
    |              |               |              |
    |              | 200 OK        |              |
    |<-------------|<--------------|              |
    |              | {followups}   |              |
    |              |               |              |
    |  [Render ticket thread]      |              |
    |              |               |              |
```

### 6.3 Add Follow-up

```
                              ADD FOLLOW-UP SEQUENCE
+--------+    +----------+    +---------+    +--------+    +-------+
| React  |    | API GW   |    | Lambda  |    | DynamoDB|    | Event |
| SPA    |    |          |    |         |    |         |    | Bridge|
+---+----+    +----+-----+    +----+----+    +----+----+    +---+---+
    |              |               |              |             |
    | POST /tickets/{id}/followups |              |             |
    |------------->|               |              |             |
    |              | Invoke        |              |             |
    |              |-------------->|              |             |
    |              |               |              |             |
    |              |               | Get ticket   |             |
    |              |               |------------->|             |
    |              |               |<-------------|             |
    |              |               |              |             |
    |              |               | Check status != CLOSED      |
    |              |               |------+      |             |
    |              |               |<-----+      |             |
    |              |               |              |             |
    |              |               | Save follow-up             |
    |              |               |------------->|             |
    |              |               |<-------------|             |
    |              |               |              |             |
    |              |               | Update ticket timestamp     |
    |              |               |------------->|             |
    |              |               |              |             |
    |              |               | Publish followup.added     |
    |              |               |---------------------------------------->|
    |              |               |              |             |
    |              | 201 Created   |              |             |
    |<-------------|<--------------|              |             |
    |              |  {followup}   |              |             |
    |              |               |              |             |
    |  [Append to thread]          |              |             |
    |              |               |              |             |
```

---

## 7. Data Models

### 7.1 DynamoDB Single Table Design

| Entity | PK | SK | Attributes |
|--------|----|----|------------|
| Ticket | `TENANT#{tenant_id}` | `TICKET#{ticket_id}` | All ticket fields |
| FollowUp | `TICKET#{ticket_id}` | `FOLLOWUP#{timestamp}` | message, author, attachments |
| Attachment | `TICKET#{ticket_id}` | `ATTACHMENT#{attachment_id}` | filename, s3_key, size |

### 7.2 Entity Schemas

```python
# Ticket Entity
{
    "PK": "TENANT#t_123",
    "SK": "TICKET#TKT-ABC12345",
    "entity_type": "TICKET",
    "id": "TKT-ABC12345",
    "tenant_id": "t_123",
    "subject": "Cannot access WordPress admin panel",
    "description": "I'm getting a 403 error when trying to access...",
    "category": "technical",
    "priority": "high",
    "status": "open",  # open, in_progress, resolved, closed
    "site_id": "site_xyz",
    "site_name": "My Website",
    "attachments": [
        {
            "id": "att_001",
            "filename": "screenshot.png",
            "content_type": "image/png",
            "size_bytes": 245000,
            "s3_key": "tickets/TKT-ABC12345/att_001/screenshot.png",
            "created_at": "2026-01-20T10:00:00Z"
        }
    ],
    "followup_count": 3,
    "last_followup_at": "2026-01-20T14:30:00Z",
    "created_at": "2026-01-20T10:00:00Z",
    "created_by": "user_123",
    "created_by_name": "John Smith",
    "updated_at": "2026-01-20T14:30:00Z",
    "resolved_at": null,
    "closed_at": null,
    "GSI1PK": "TICKET#TKT-ABC12345",
    "GSI1SK": "METADATA",
    "GSI2PK": "TENANT#t_123#STATUS#open",
    "GSI2SK": "2026-01-20T10:00:00Z"
}

# FollowUp Entity
{
    "PK": "TICKET#TKT-ABC12345",
    "SK": "FOLLOWUP#2026-01-20T12:00:00.000Z",
    "entity_type": "FOLLOWUP",
    "id": "fu_001",
    "ticket_id": "TKT-ABC12345",
    "author_type": "customer",  # customer, support, system
    "author_id": "user_123",
    "author_name": "John Smith",
    "message": "I've attached another screenshot showing the error...",
    "attachments": [
        {
            "id": "att_002",
            "filename": "error_log.txt",
            "content_type": "text/plain",
            "size_bytes": 5000,
            "s3_key": "tickets/TKT-ABC12345/fu_001/error_log.txt"
        }
    ],
    "created_at": "2026-01-20T12:00:00Z"
}
```

### 7.3 GSI Definitions

| GSI Name | PK | SK | Purpose |
|----------|----|----|---------|
| GSI1 | `GSI1PK` | `GSI1SK` | Get ticket by ID directly |
| TicketStatusIndex | `GSI2PK` | `GSI2SK` | Filter by status within tenant |

### 7.4 Access Patterns

| Access Pattern | Operation | Key Condition |
|----------------|-----------|---------------|
| Get ticket by ID | Query GSI1 | GSI1PK = TICKET#{id} |
| List tickets for tenant | Query | PK = TENANT#{tenant_id}, SK begins_with TICKET# |
| List tickets by status | Query TicketStatusIndex | GSI2PK = TENANT#{id}#STATUS#{status} |
| Get follow-ups for ticket | Query | PK = TICKET#{id}, SK begins_with FOLLOWUP# |
| Get recent follow-ups | Query | PK = TICKET#{id}, SK begins_with FOLLOWUP#, ScanIndexForward = false |

---

## 8. Security

### 8.1 Authentication & Authorization

| Aspect | Implementation |
|--------|----------------|
| API Authentication | Cognito JWT via Lambda Authorizer |
| Tenant Isolation | User can only access tickets in assigned tenants |
| Ticket Ownership | Customer can only view/update their own tenant's tickets |
| Attachment Access | Presigned URLs with 15-minute expiry |

### 8.2 Data Protection

| Data | Protection |
|------|------------|
| Ticket content | DynamoDB encryption at rest |
| Attachments | S3 SSE-S3, presigned URLs |
| Email content | TLS in transit, SES encryption |
| Logs | CloudWatch Logs encryption |

### 8.3 Attachment Security

| Control | Implementation |
|---------|----------------|
| File size limit | 10MB per file |
| File count limit | 5 files per ticket/follow-up |
| Allowed types | Images, PDFs, text files, logs |
| Virus scanning | ClamAV Lambda layer |
| Storage isolation | Per-ticket S3 prefix |

### 8.4 Rate Limiting

| Endpoint | Rate Limit | Window |
|----------|------------|--------|
| POST /tickets | 10 tickets | per hour per user |
| POST /followups | 20 follow-ups | per hour per ticket |
| GET endpoints | 100 requests | per minute per user |

### 8.5 IAM Policies

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DynamoDBTicketAccess",
      "Effect": "Allow",
      "Action": [
        "dynamodb:Query",
        "dynamodb:PutItem",
        "dynamodb:UpdateItem",
        "dynamodb:GetItem"
      ],
      "Resource": [
        "arn:aws:dynamodb:*:*:table/bbws-portal-*",
        "arn:aws:dynamodb:*:*:table/bbws-portal-*/index/*"
      ]
    },
    {
      "Sid": "S3AttachmentAccess",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject"
      ],
      "Resource": "arn:aws:s3:::bbws-ticket-attachments-*/*"
    },
    {
      "Sid": "EventBridgePublish",
      "Effect": "Allow",
      "Action": "events:PutEvents",
      "Resource": "arn:aws:events:*:*:event-bus/bbws-portal-*"
    },
    {
      "Sid": "SESEmailAccess",
      "Effect": "Allow",
      "Action": "ses:SendEmail",
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "ses:FromAddress": "support@kimmyai.io"
        }
      }
    }
  ]
}
```

---

## 9. Error Handling

### 9.1 Error Codes

| Code | HTTP Status | Description | User Message |
|------|-------------|-------------|--------------|
| `TICKET_NOT_FOUND` | 404 | Ticket ID not found | "Ticket not found." |
| `TICKET_CLOSED` | 400 | Cannot modify closed ticket | "This ticket is closed. Please create a new ticket." |
| `INVALID_CATEGORY` | 422 | Invalid category value | "Please select a valid category." |
| `ATTACHMENT_TOO_LARGE` | 413 | File exceeds 10MB | "File size must be less than 10MB." |
| `TOO_MANY_ATTACHMENTS` | 422 | More than 5 files | "Maximum 5 attachments allowed." |
| `INVALID_FILE_TYPE` | 422 | File type not allowed | "This file type is not supported." |
| `RATE_LIMIT_EXCEEDED` | 429 | Too many requests | "Please wait before submitting another ticket." |
| `VIRUS_DETECTED` | 400 | Malware in attachment | "The uploaded file contains malware and was rejected." |

### 9.2 Retry Strategy

| Operation | Max Retries | Backoff | Idempotent |
|-----------|-------------|---------|------------|
| DynamoDB writes | 3 | Exponential | Yes (conditional) |
| S3 uploads | 3 | Exponential | Yes |
| SES emails | 2 | Linear (5s) | Yes |
| SNS publish | 2 | Linear (2s) | Yes |

---

## 10. Monitoring and Alerting

### 10.1 CloudWatch Metrics

| Metric | Namespace | Dimensions | Threshold | Alarm |
|--------|-----------|------------|-----------|-------|
| `TicketsCreated` | BBWS/Ticket | Environment | - | - |
| `TicketResponseTime` | BBWS/Ticket | Environment | p95 >500ms | Warning |
| `FollowupsCreated` | BBWS/Ticket | Environment | - | - |
| `AttachmentUploads` | BBWS/Ticket | Environment | - | - |
| `VirusDetected` | BBWS/Ticket | Environment | >0 | Alert |
| `TicketErrors` | BBWS/Ticket | Environment | >10/hour | Alert |

### 10.2 Dashboard Widgets

```json
{
  "widgets": [
    {
      "type": "metric",
      "title": "Tickets Created",
      "properties": {
        "metrics": [
          ["BBWS/Ticket", "TicketsCreated", "Environment", "prod"]
        ],
        "period": 3600
      }
    },
    {
      "type": "metric",
      "title": "Tickets by Category",
      "properties": {
        "metrics": [
          ["BBWS/Ticket", "TicketsCreated", "Category", "billing"],
          ["BBWS/Ticket", "TicketsCreated", "Category", "technical"],
          ["BBWS/Ticket", "TicketsCreated", "Category", "account"],
          ["BBWS/Ticket", "TicketsCreated", "Category", "general"]
        ]
      }
    },
    {
      "type": "metric",
      "title": "API Response Time (p95)",
      "properties": {
        "metrics": [
          ["BBWS/Ticket", "TicketResponseTime", {"stat": "p95"}]
        ]
      }
    }
  ]
}
```

### 10.3 Log Queries

```sql
-- Tickets created per hour
fields @timestamp, ticket_id, category, priority
| filter entity_type = "TICKET"
| stats count(*) as ticket_count by bin(1h)

-- Failed ticket creations
fields @timestamp, @message
| filter level = "ERROR" and @message like /create_ticket/
| sort @timestamp desc
| limit 50

-- Attachment upload failures
fields @timestamp, ticket_id, filename, error_message
| filter level = "ERROR" and step = "attachment_upload"
| sort @timestamp desc
```

### 10.4 SNS Alerts

| Alert | Condition | Recipients |
|-------|-----------|------------|
| High Priority Ticket | priority = critical | support-urgent |
| Virus Detected | Any virus detection | security-team |
| High Volume | >50 tickets/hour | support-managers |

---

## 11. NFRs

### 11.1 Performance Requirements

| Requirement | Target | Measurement |
|-------------|--------|-------------|
| API Response Time | <500ms (p95) | CloudWatch metrics |
| Ticket Creation | <2 seconds | End-to-end timing |
| Attachment Upload | <5 seconds (10MB) | Upload timing |
| List Tickets | <300ms (p95) | Query timing |

### 11.2 Availability Requirements

| Requirement | Target |
|-------------|--------|
| API Availability | 99.9% |
| Attachment Storage | 99.99% |
| Email Delivery | 99% |

### 11.3 Scalability Requirements

| Dimension | Limit | Notes |
|-----------|-------|-------|
| Tickets per tenant | Unlimited | Pagination required |
| Attachments per ticket | 50 total | Across all follow-ups |
| Follow-ups per ticket | 100 | Soft limit |
| Concurrent users | 500 | Per environment |

---

## 12. Troubleshooting Playbook

### 12.1 Common Issues

| Issue | Symptoms | Resolution |
|-------|----------|------------|
| Ticket not created | 500 error | Check DynamoDB throttling, Lambda logs |
| Attachment upload failed | Timeout | Check S3 permissions, file size |
| Email not received | No confirmation | Check SES delivery logs, spam folder |
| Ticket not visible | Empty list | Verify tenant assignment, check filters |

### 12.2 Investigation Steps

```bash
# Check ticket exists
aws dynamodb query \
  --table-name bbws-portal-${env} \
  --key-condition-expression "GSI1PK = :pk" \
  --expression-attribute-values '{":pk": {"S": "TICKET#TKT-ABC12345"}}' \
  --index-name GSI1

# Get Lambda logs for ticket creation
aws logs filter-log-events \
  --log-group-name /aws/lambda/bbws-ticket-create-${env} \
  --filter-pattern "{$.ticket_id = \"TKT-ABC12345\"}"

# Check SES delivery status
aws ses get-send-statistics

# Check S3 attachment
aws s3 ls s3://bbws-ticket-attachments-${env}/tickets/TKT-ABC12345/
```

---

## 13. Tagging

### 13.1 Resource Tags

| Tag Key | Value | Purpose |
|---------|-------|---------|
| `Environment` | dev/sit/prod | Environment identification |
| `Project` | bbws | Project identification |
| `Service` | portal-ticket | Service identification |
| `Owner` | platform-team | Ownership |
| `CostCenter` | CC-001 | Cost allocation |
| `ManagedBy` | terraform | IaC tracking |

---

## 14. Risks and Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Spam tickets | Support overload | Medium | Rate limiting, CAPTCHA |
| Large attachments | Storage costs | Medium | File size limits, lifecycle policies |
| Malware uploads | Security breach | Low | Virus scanning, file type restrictions |
| Missed notifications | Poor customer experience | Medium | Email delivery monitoring, retry logic |
| Data exposure | Privacy violation | Low | Tenant isolation, access logging |

---

## 15. TBC

- [ ] Ticket templates for common issues
- [ ] Auto-categorization using AI
- [ ] SLA tracking and alerts
- [ ] Customer satisfaction surveys
- [ ] Ticket merging capability
- [ ] Knowledge base integration

---

## 16. Definition of Terms

| Term | Definition |
|------|------------|
| Ticket | Support request submitted by a customer |
| Follow-up | Message in a ticket conversation thread |
| Category | Classification of ticket type (billing, technical, etc.) |
| Priority | Urgency level affecting SLA |
| SLA | Service Level Agreement for response/resolution time |
| Attachment | File uploaded with ticket or follow-up |

---

## 17. Appendices

### Appendix A: Ticket ID Generation

```python
import random
import string

def generate_ticket_id() -> str:
    """
    Generate unique ticket ID in format TKT-XXXXXXXX.

    Uses a combination of:
    - 8 alphanumeric characters (uppercase + digits)
    - Excludes ambiguous characters (0, O, I, L)
    """
    chars = string.ascii_uppercase + string.digits
    chars = chars.replace('0', '').replace('O', '').replace('I', '').replace('L', '')

    suffix = ''.join(random.choices(chars, k=8))
    return f"TKT-{suffix}"
```

### Appendix B: Email Templates

```python
TICKET_CREATED_CUSTOMER = """
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: #1a73e8; color: white; padding: 20px; text-align: center; }
        .content { padding: 20px; background: #f9f9f9; }
        .ticket-id { font-size: 24px; font-weight: bold; color: #1a73e8; }
        .footer { padding: 20px; text-align: center; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Support Ticket Created</h1>
        </div>
        <div class="content">
            <p>Hello,</p>
            <p>Your support ticket has been created successfully.</p>
            <p class="ticket-id">{ticket_id}</p>
            <p><strong>Subject:</strong> {subject}</p>
            <p>Our support team will review your request and respond as soon as possible.</p>
            <p>You can view and track your ticket by logging into your <a href="https://portal.kimmyai.io/support/tickets/{ticket_id}">Customer Portal</a>.</p>
        </div>
        <div class="footer">
            <p>BBWS Support Team | support@kimmyai.io</p>
        </div>
    </div>
</body>
</html>
"""
```

---

## 18. References

| Document | Description |
|----------|-------------|
| [HLD 2.2](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md) | Parent HLD |
| [BRS 2.2](../BRS/2.2_BRS_Customer_Portal_Private.md) | Business Requirements |
| [2.2.7_LLD_Portal_Notification](./2.2.7_LLD_Portal_Notification.md) | Notification service |
| [AWS SES](https://docs.aws.amazon.com/ses/) | Email service |

---

## 19. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| LLD Author | LLD Architect Agent | 2026-01-20 | |
| Technical Reviewer | | | |
| Security Reviewer | | | |
| Product Owner | | | |

---

**End of Document**
