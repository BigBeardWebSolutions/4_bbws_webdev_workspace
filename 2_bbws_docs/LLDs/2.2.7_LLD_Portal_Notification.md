# Portal Notification Service - Low-Level Design

**Version**: 1.0
**Created**: 2026-01-20
**Status**: Draft
**Component**: Portal Notification Service (`2_2_bbws_portal_svc_notification`)
**Parent HLD**: [HLD 2.2 BBWS Customer Portal Private](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md)
**Parent BRS**: [BRS 2.2 Customer Portal Private](../BRS/2.2_BRS_Customer_Portal_Private.md) - Cross-cutting

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-20 | LLD Architect Agent | Initial version covering cross-cutting notification functionality |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [High Level Overview](#2-high-level-overview)
3. [Architecture Diagram](#3-architecture-diagram)
4. [API Design](#4-api-design)
5. [Lambda Functions](#5-lambda-functions)
6. [Sequence Diagrams](#6-sequence-diagrams)
7. [Data Models](#7-data-models)
8. [Security](#8-security)
9. [Error Handling](#9-error-handling)
10. [Monitoring and Alerting](#10-monitoring-and-alerting)
11. [NFRs](#11-nfrs)
12. [Troubleshooting Playbook](#12-troubleshooting-playbook)
13. [Tagging](#13-tagging)
14. [Risks and Mitigations](#14-risks-and-mitigations)
15. [TBC](#15-tbc)
16. [Definition of Terms](#16-definition-of-terms)
17. [Appendices](#17-appendices)
18. [References](#18-references)
19. [Signoff](#19-signoff)

---

## 1. Introduction

### 1.1 Purpose

This LLD provides implementation-level details for the Portal Notification Service, which is a **cross-cutting service** responsible for managing all notifications across the BBWS Customer Portal. The service handles:
- **Email notifications** via AWS SES (transactional, alerts, marketing)
- **In-app notifications** stored in DynamoDB and displayed in the portal
- **Push notifications** (future - mobile app integration)
- **SMS notifications** (future - critical alerts)

### 1.2 Scope

| In Scope | Out of Scope |
|----------|--------------|
| Email notifications (SES) | Marketing campaign management |
| In-app notification bell/list | Admin notification management |
| Notification preferences | SMS/Push implementation (deferred) |
| Event-driven notification triggers | Third-party notification services |
| Notification templates | Customer email list management |
| Read/unread status tracking | Notification analytics dashboard |

### 1.3 Component Overview

| Attribute | Value |
|-----------|-------|
| Repository | `2_2_bbws_portal_svc_notification` |
| Runtime | Python 3.12 |
| Memory | 256MB (API handlers), 512MB (email sender) |
| Timeout | 30s |
| Architecture | arm64 |
| API Prefix | `/portal/notifications/*` |
| Authentication | Required (Cognito JWT) |

### 1.4 Cross-Cutting Integration

This service integrates with all other portal services via EventBridge:

| Source Service | Event Types |
|----------------|-------------|
| Portal Auth Service | `user.registered`, `user.password_changed`, `user.mfa_enabled` |
| Portal Organisation Service | `user.invited`, `user.role_changed`, `org.settings_updated` |
| Portal Tenant Service | `tenant.created`, `tenant.user_added` |
| Portal Site Service | `site.created`, `site.launched`, `backup.completed`, `backup.failed` |
| Portal Migration Service | `migration.started`, `migration.completed`, `migration.failed` |
| Portal Billing Service | `subscription.renewed`, `payment.success`, `payment.failed`, `invoice.ready` |
| Portal Ticket Service | `ticket.created`, `ticket.replied`, `ticket.resolved` |

### 1.5 Dependencies

| Dependency | Purpose |
|------------|---------|
| AWS DynamoDB | Notification storage |
| AWS SES | Email delivery |
| AWS EventBridge | Event subscription |
| AWS S3 | Email templates, attachments |
| AWS Secrets Manager | SES credentials, API keys |
| Lambda Authorizer | JWT validation |

---

## 2. High Level Overview

### 2.1 Notification Types

| Type | Channel | Purpose | Examples |
|------|---------|---------|----------|
| `transactional` | Email | Critical system actions | Email verification, password reset |
| `alert` | Email + In-app | Time-sensitive notifications | Site down, payment failed |
| `informational` | Email + In-app | General updates | Migration complete, backup ready |
| `marketing` | Email | Promotional content | New features, tips |
| `system` | In-app | Platform announcements | Maintenance windows |

### 2.2 Notification Categories

| Category | Icon | Color | Examples |
|----------|------|-------|----------|
| `site` | Globe | Blue | Site created, launched, backup completed |
| `billing` | Credit Card | Green | Payment success, invoice ready |
| `security` | Shield | Red | Password changed, MFA enabled |
| `team` | Users | Purple | User invited, role changed |
| `support` | Headset | Orange | Ticket replied, resolved |
| `migration` | Upload | Teal | Migration started, completed |
| `system` | Info | Gray | Maintenance, announcements |

### 2.3 Notification Preferences

Users can configure notification preferences at the account level:

| Preference | Default | Options |
|------------|---------|---------|
| Email notifications | Enabled | All, Critical only, None |
| In-app notifications | Enabled | All, None |
| Marketing emails | Enabled | Enabled, Disabled |
| Digest frequency | Instant | Instant, Daily, Weekly |
| Quiet hours | None | Custom time range |

---

## 3. Architecture Diagram

### 3.1 Component Architecture

```
                            PORTAL NOTIFICATION SERVICE ARCHITECTURE
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|                                    EVENT SOURCES (All Services)                                   |
|  +--------+ +--------+ +--------+ +--------+ +--------+ +--------+ +--------+                   |
|  | Auth   | | Org    | | Tenant | | Site   | | Billing| | Ticket | | Migr   |                   |
|  | Service| | Service| | Service| | Service| | Service| | Service| | Service|                   |
|  +---+----+ +---+----+ +---+----+ +---+----+ +---+----+ +---+----+ +---+----+                   |
|      |          |          |          |          |          |          |                         |
|      +----------+----------+----------+----------+----------+----------+                         |
|                                       |                                                          |
|                                       v                                                          |
|                          +------------------------+                                              |
|                          |      EventBridge       |                                              |
|                          |   (bbws-portal-bus)    |                                              |
|                          |                        |                                              |
|                          | Rules:                 |                                              |
|                          | - notification.*       |                                              |
|                          | - *.created/completed  |                                              |
|                          +----------+-------------+                                              |
|                                     |                                                            |
|                    +----------------+----------------+                                            |
|                    |                                 |                                            |
|                    v                                 v                                            |
|         +------------------+              +------------------+                                    |
|         | Event Processor  |              |  Email Sender    |                                   |
|         | Lambda           |              |  Lambda          |                                   |
|         |                  |              |                  |                                   |
|         | - Create in-app  |              | - Render template|                                   |
|         | - Check prefs    |              | - Send via SES   |                                   |
|         | - Route to email |              | - Track delivery |                                   |
|         +--------+---------+              +--------+---------+                                   |
|                  |                                 |                                             |
|         +--------+---------+                       |                                             |
|         |                  |                       |                                             |
|         v                  v                       v                                             |
|  +-----------+     +-----------+           +-----------+                                         |
|  | DynamoDB  |     |    SQS    |           |    SES    |                                        |
|  | (Notifs)  |     | (Email Q) |           |  (Email)  |                                        |
|  |           |     |           |           |           |                                        |
|  | - NOTIF   |     | - Batched |           | - Send    |                                        |
|  | - PREF    |     | - Retries |           | - Track   |                                        |
|  +-----------+     +-----------+           +-----------+                                         |
|        |                                         |                                               |
|        v                                         v                                               |
|  +----------------------------------+    +------------------+                                    |
|  |   CUSTOMER PORTAL API           |    |    S3 Bucket     |                                    |
|  |                                  |    | (Templates)      |                                    |
|  |  GET /notifications             |    |                  |                                    |
|  |  PUT /notifications/{id}/read   |    | - HTML templates |                                    |
|  |  GET /notifications/preferences |    | - Email assets   |                                    |
|  |  PUT /notifications/preferences |    +------------------+                                    |
|  +----------------------------------+                                                            |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+

LEGEND:
+------+  Component/Service
------->  Data Flow (Events)
- - - ->  Data Flow (API)
```

### 3.2 Event Flow Diagram

```
                              NOTIFICATION EVENT FLOW
+-------------------------------------------------------------------------------------------+
|                                                                                           |
|  [Event Source]                                                                           |
|       |                                                                                   |
|       | PutEvents                                                                         |
|       v                                                                                   |
|  +------------------+                                                                     |
|  |   EventBridge    |                                                                     |
|  +--------+---------+                                                                     |
|           |                                                                               |
|           | Rule Match: source = "bbws.*" AND detail-type = "notification.*"              |
|           |                                                                               |
|           v                                                                               |
|  +------------------+                                                                     |
|  | Event Processor  |                                                                     |
|  +--------+---------+                                                                     |
|           |                                                                               |
|           | 1. Parse event                                                                |
|           | 2. Get user preferences                                                       |
|           | 3. Check quiet hours                                                          |
|           |                                                                               |
|     +-----+-----+-----+                                                                   |
|     |           |     |                                                                   |
|     v           v     v                                                                   |
|  [In-App]   [Email]  [Skip]                                                               |
|     |           |                                                                         |
|     v           v                                                                         |
|  +--------+  +--------+                                                                   |
|  |DynamoDB|  |  SQS   |                                                                   |
|  | (save) |  | (queue)|                                                                   |
|  +--------+  +---+----+                                                                   |
|                  |                                                                         |
|                  v                                                                         |
|           +------------------+                                                             |
|           |  Email Sender    |                                                             |
|           +--------+---------+                                                             |
|                    |                                                                       |
|                    | 1. Get template                                                       |
|                    | 2. Render with data                                                   |
|                    | 3. Send via SES                                                       |
|                    |                                                                       |
|                    v                                                                       |
|              +----------+                                                                  |
|              |   SES    |                                                                  |
|              +----+-----+                                                                  |
|                   |                                                                        |
|                   v                                                                        |
|              [Customer Inbox]                                                              |
|                                                                                           |
+-------------------------------------------------------------------------------------------+
```

### 3.3 Class Diagram

```
+--------------------------------------------------------------------------------------------------+
|                                      CLASS STRUCTURE                                              |
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  +---------------------------+              +---------------------------+                        |
|  |  NotificationController   |              |  NotificationService      |                        |
|  +---------------------------+              +---------------------------+                        |
|  | + list_notifications()    |------------->| + list_for_user(user_id)  |                        |
|  | + mark_read()             |              | + mark_read(id)           |                        |
|  | + mark_all_read()         |              | + mark_all_read(user_id)  |                        |
|  | + get_preferences()       |              | + create(notification)    |                        |
|  | + update_preferences()    |              | + get_unread_count(uid)   |                        |
|  +---------------------------+              +-------------+-------------+                        |
|                                                           |                                      |
|                                              +------------+------------+                         |
|                                              |                         |                         |
|                                              v                         v                         |
|                            +---------------------------+  +---------------------------+          |
|                            | NotificationRepository    |  |  PreferenceRepository     |          |
|                            +---------------------------+  +---------------------------+          |
|                            | + save(notification)      |  | + get_for_user(user_id)   |          |
|                            | + find_for_user(user_id)  |  | + save(preferences)       |          |
|                            | + mark_read(id)           |  | + get_default()           |          |
|                            | + count_unread(user_id)   |  +---------------------------+          |
|                            +---------------------------+                                         |
|                                                                                                  |
|  +---------------------------+              +---------------------------+                        |
|  |  EventProcessor           |              |  EmailService             |                        |
|  +---------------------------+              +---------------------------+                        |
|  | + process_event(event)    |              | + send_email(to, template,|                        |
|  | + check_preferences()     |              |              data)        |                        |
|  | + should_notify()         |              | + render_template(name,   |                        |
|  | + create_notification()   |              |                 data)     |                        |
|  | + queue_email()           |              | + track_delivery(msg_id)  |                        |
|  +---------------------------+              +---------------------------+                        |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+

DATA CLASSES:

+---------------------------+     +---------------------------+     +---------------------------+
|   Notification (Entity)   |     |   Preference (Entity)     |     |   EmailMessage            |
+---------------------------+     +---------------------------+     +---------------------------+
| + id: str                 |     | + user_id: str            |     | + to: str                 |
| + user_id: str            |     | + email_enabled: bool     |     | + subject: str            |
| + type: NotificationType  |     | + inapp_enabled: bool     |     | + template_name: str      |
| + category: Category      |     | + marketing_enabled: bool |     | + template_data: dict     |
| + title: str              |     | + digest_frequency: str   |     | + attachments: List       |
| + message: str            |     | + quiet_hours_start: str  |     | + created_at: datetime    |
| + data: dict              |     | + quiet_hours_end: str    |     +---------------------------+
| + link: str               |     | + categories: dict        |
| + read: bool              |     | + updated_at: datetime    |
| + created_at: datetime    |     +---------------------------+
| + read_at: datetime       |
+---------------------------+

ENUMS:

+---------------------------+     +---------------------------+
|   NotificationType        |     |   Category                |
+---------------------------+     +---------------------------+
| TRANSACTIONAL = "trans"   |     | SITE = "site"             |
| ALERT = "alert"           |     | BILLING = "billing"       |
| INFORMATIONAL = "info"    |     | SECURITY = "security"     |
| MARKETING = "marketing"   |     | TEAM = "team"             |
| SYSTEM = "system"         |     | SUPPORT = "support"       |
+---------------------------+     | MIGRATION = "migration"   |
                                  | SYSTEM = "system"         |
                                  +---------------------------+
```

---

## 4. API Design

### 4.1 OpenAPI Specification

```yaml
openapi: 3.0.3
info:
  title: Portal Notification Service API
  description: Notification management for BBWS Customer Portal
  version: 1.0.0
  contact:
    name: BBWS Platform Team
    email: platform@kimmyai.io

servers:
  - url: https://portal-api.kimmyai.io/v1.0
    description: Production
  - url: https://dev.portal-api.kimmyai.io/v1.0
    description: Development

security:
  - bearerAuth: []

paths:
  /portal/notifications:
    get:
      summary: List notifications for current user
      operationId: listNotifications
      tags: [Notifications]
      parameters:
        - name: unreadOnly
          in: query
          schema:
            type: boolean
            default: false
        - name: category
          in: query
          schema:
            type: string
            enum: [site, billing, security, team, support, migration, system]
        - $ref: '#/components/parameters/PageToken'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: Notification list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /portal/notifications/count:
    get:
      summary: Get unread notification count
      operationId: getUnreadCount
      tags: [Notifications]
      responses:
        '200':
          description: Unread count
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnreadCountResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /portal/notifications/{notificationId}/read:
    put:
      summary: Mark notification as read
      operationId: markRead
      tags: [Notifications]
      parameters:
        - $ref: '#/components/parameters/NotificationId'
      responses:
        '200':
          description: Notification marked as read
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /portal/notifications/read-all:
    put:
      summary: Mark all notifications as read
      operationId: markAllRead
      tags: [Notifications]
      responses:
        '200':
          description: All notifications marked as read
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MarkAllReadResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /portal/notifications/preferences:
    get:
      summary: Get notification preferences
      operationId: getPreferences
      tags: [Notifications]
      responses:
        '200':
          description: User preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PreferencesResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      summary: Update notification preferences
      operationId: updatePreferences
      tags: [Notifications]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePreferencesRequest'
      responses:
        '200':
          description: Preferences updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PreferencesResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    NotificationId:
      name: notificationId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    PageToken:
      name: pageToken
      in: query
      schema:
        type: string

    PageSize:
      name: pageSize
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    NotificationListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Notification'
        meta:
          allOf:
            - $ref: '#/components/schemas/ResponseMeta'
            - type: object
              properties:
                totalCount:
                  type: integer
                unreadCount:
                  type: integer
                pageToken:
                  type: string
        _links:
          $ref: '#/components/schemas/ListLinks'

    NotificationResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Notification'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    Notification:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [transactional, alert, informational, marketing, system]
        category:
          type: string
          enum: [site, billing, security, team, support, migration, system]
        title:
          type: string
        message:
          type: string
        link:
          type: string
          description: Deep link into portal
        data:
          type: object
          description: Additional context data
        read:
          type: boolean
        createdAt:
          type: string
          format: date-time
        readAt:
          type: string
          format: date-time

    UnreadCountResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            count:
              type: integer
            byCategory:
              type: object
              additionalProperties:
                type: integer
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    MarkAllReadResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            markedCount:
              type: integer
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    PreferencesResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Preferences'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    Preferences:
      type: object
      properties:
        emailEnabled:
          type: boolean
          description: Receive email notifications
        inAppEnabled:
          type: boolean
          description: Receive in-app notifications
        marketingEnabled:
          type: boolean
          description: Receive marketing emails
        digestFrequency:
          type: string
          enum: [instant, daily, weekly]
          description: How often to receive digest emails
        quietHours:
          type: object
          properties:
            enabled:
              type: boolean
            start:
              type: string
              format: time
              example: "22:00"
            end:
              type: string
              format: time
              example: "08:00"
            timezone:
              type: string
              example: "Africa/Johannesburg"
        categories:
          type: object
          description: Per-category email preferences
          properties:
            site:
              type: boolean
            billing:
              type: boolean
            security:
              type: boolean
            team:
              type: boolean
            support:
              type: boolean
            migration:
              type: boolean

    UpdatePreferencesRequest:
      type: object
      properties:
        emailEnabled:
          type: boolean
        inAppEnabled:
          type: boolean
        marketingEnabled:
          type: boolean
        digestFrequency:
          type: string
          enum: [instant, daily, weekly]
        quietHours:
          type: object
          properties:
            enabled:
              type: boolean
            start:
              type: string
              format: time
            end:
              type: string
              format: time
            timezone:
              type: string
        categories:
          type: object
          additionalProperties:
            type: boolean

    ListLinks:
      type: object
      properties:
        self:
          $ref: '#/components/schemas/Link'
        next:
          $ref: '#/components/schemas/Link'

    Link:
      type: object
      properties:
        href:
          type: string
          format: uri

    ResponseMeta:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        requestId:
          type: string

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
```

---

## 5. Lambda Functions

### 5.1 Function Inventory

| # | Function Name | Trigger | Memory | Timeout | Description |
|---|---------------|---------|--------|---------|-------------|
| 1 | `list_notifications` | API Gateway | 256MB | 30s | List notifications for user |
| 2 | `get_unread_count` | API Gateway | 256MB | 10s | Get unread notification count |
| 3 | `mark_read` | API Gateway | 256MB | 10s | Mark notification as read |
| 4 | `mark_all_read` | API Gateway | 256MB | 30s | Mark all notifications as read |
| 5 | `get_preferences` | API Gateway | 256MB | 10s | Get user preferences |
| 6 | `update_preferences` | API Gateway | 256MB | 10s | Update user preferences |
| 7 | `process_event` | EventBridge | 512MB | 30s | Process notification events |
| 8 | `send_email` | SQS | 512MB | 60s | Send email via SES |
| 9 | `send_digest` | EventBridge Schedule | 512MB | 120s | Send daily/weekly digests |

### 5.2 Function: process_event

```python
"""
Process Notification Event Handler
Handles events from EventBridge and creates notifications.
"""

import uuid
from datetime import datetime
from typing import Any, Optional

from aws_lambda_powertools import Logger, Tracer
import boto3

from src.services.notification_service import NotificationService
from src.services.preference_service import PreferenceService
from src.services.email_queue import EmailQueue
from src.models.notification import Notification, NotificationType, Category
from src.templates.notification_templates import TEMPLATES

logger = Logger()
tracer = Tracer()

notification_service = NotificationService()
preference_service = PreferenceService()
email_queue = EmailQueue()


# Event to notification mapping
EVENT_MAPPINGS = {
    # Site events
    "site.created": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.SITE,
        "title": "Site Created",
        "message": "Your new site '{site_name}' has been created successfully.",
        "email_template": "site_created",
        "link": "/tenants/{tenant_id}/sites/{site_id}"
    },
    "site.launched": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.SITE,
        "title": "Site Launched",
        "message": "Your site '{site_name}' is now live at {domain}.",
        "email_template": "site_launched",
        "link": "/tenants/{tenant_id}/sites/{site_id}"
    },
    "backup.completed": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.SITE,
        "title": "Backup Complete",
        "message": "Backup for '{site_name}' completed successfully.",
        "email_template": None,  # In-app only
        "link": "/tenants/{tenant_id}/sites/{site_id}/backups"
    },
    "backup.failed": {
        "type": NotificationType.ALERT,
        "category": Category.SITE,
        "title": "Backup Failed",
        "message": "Backup for '{site_name}' failed. Please check site status.",
        "email_template": "backup_failed",
        "link": "/tenants/{tenant_id}/sites/{site_id}/backups"
    },

    # Billing events
    "payment.success": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.BILLING,
        "title": "Payment Successful",
        "message": "Payment of {amount} received. Thank you!",
        "email_template": "payment_success",
        "link": "/billing/history"
    },
    "payment.failed": {
        "type": NotificationType.ALERT,
        "category": Category.BILLING,
        "title": "Payment Failed",
        "message": "Payment of {amount} failed. Please update your payment method.",
        "email_template": "payment_failed",
        "link": "/billing/subscription"
    },
    "invoice.ready": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.BILLING,
        "title": "Invoice Ready",
        "message": "Invoice #{invoice_number} for {amount} is ready for download.",
        "email_template": "invoice_ready",
        "link": "/billing/invoices/{invoice_id}"
    },

    # Migration events
    "migration.started": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.MIGRATION,
        "title": "Migration Started",
        "message": "Migration from {source_url} has started.",
        "email_template": None,
        "link": "/tenants/{tenant_id}/migrations/{migration_id}"
    },
    "migration.completed": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.MIGRATION,
        "title": "Migration Complete",
        "message": "Migration to '{site_name}' completed successfully.",
        "email_template": "migration_completed",
        "link": "/tenants/{tenant_id}/migrations/{migration_id}"
    },
    "migration.failed": {
        "type": NotificationType.ALERT,
        "category": Category.MIGRATION,
        "title": "Migration Failed",
        "message": "Migration to '{site_name}' failed: {error}",
        "email_template": "migration_failed",
        "link": "/tenants/{tenant_id}/migrations/{migration_id}"
    },

    # Team events
    "user.invited": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.TEAM,
        "title": "Invitation Sent",
        "message": "Invitation sent to {email} to join your organisation.",
        "email_template": None,
        "link": "/organisation/users"
    },
    "user.joined": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.TEAM,
        "title": "New Team Member",
        "message": "{name} has joined your organisation.",
        "email_template": None,
        "link": "/organisation/users"
    },

    # Security events
    "user.password_changed": {
        "type": NotificationType.TRANSACTIONAL,
        "category": Category.SECURITY,
        "title": "Password Changed",
        "message": "Your password was changed. If this wasn't you, contact support.",
        "email_template": "password_changed",
        "link": "/settings"
    },
    "user.mfa_enabled": {
        "type": NotificationType.TRANSACTIONAL,
        "category": Category.SECURITY,
        "title": "MFA Enabled",
        "message": "Multi-factor authentication has been enabled on your account.",
        "email_template": "mfa_enabled",
        "link": "/settings/mfa"
    },

    # Support events
    "ticket.replied": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.SUPPORT,
        "title": "Ticket Update",
        "message": "Support has replied to your ticket #{ticket_id}.",
        "email_template": "ticket_replied",
        "link": "/support/tickets/{ticket_id}"
    },
    "ticket.resolved": {
        "type": NotificationType.INFORMATIONAL,
        "category": Category.SUPPORT,
        "title": "Ticket Resolved",
        "message": "Your ticket #{ticket_id} has been resolved.",
        "email_template": "ticket_resolved",
        "link": "/support/tickets/{ticket_id}"
    }
}


@tracer.capture_method
def process_event(event_type: str, payload: dict, user_id: str) -> Optional[Notification]:
    """
    Process an event and create notification if applicable.

    Args:
        event_type: Event type (e.g., "site.created")
        payload: Event payload with context data
        user_id: Target user ID

    Returns:
        Created notification or None if preferences disabled
    """
    mapping = EVENT_MAPPINGS.get(event_type)
    if not mapping:
        logger.warning("Unknown event type", extra={"event_type": event_type})
        return None

    # Get user preferences
    preferences = preference_service.get_for_user(user_id)

    # Check if category is enabled
    category = mapping["category"]
    if not preferences.categories.get(category.value, True):
        logger.info("Category disabled for user", extra={
            "user_id": user_id,
            "category": category.value
        })
        return None

    # Check quiet hours
    if preference_service.is_quiet_hours(preferences):
        logger.info("In quiet hours, deferring email", extra={"user_id": user_id})
        # Still create in-app notification, defer email

    # Format message with payload data
    title = mapping["title"]
    message = mapping["message"].format(**payload)
    link = mapping["link"].format(**payload) if mapping["link"] else None

    # Create in-app notification
    notification = None
    if preferences.inapp_enabled:
        notification = Notification(
            id=str(uuid.uuid4()),
            user_id=user_id,
            type=mapping["type"],
            category=category,
            title=title,
            message=message,
            link=link,
            data=payload,
            read=False,
            created_at=datetime.utcnow()
        )
        notification_service.create(notification)

        logger.info("In-app notification created", extra={
            "notification_id": notification.id,
            "user_id": user_id,
            "event_type": event_type
        })

    # Queue email if enabled and template exists
    email_template = mapping.get("email_template")
    if preferences.email_enabled and email_template:
        email_queue.enqueue(
            user_id=user_id,
            template_name=email_template,
            template_data={
                "title": title,
                "message": message,
                "link": f"https://portal.kimmyai.io{link}" if link else None,
                **payload
            }
        )

        logger.info("Email queued", extra={
            "user_id": user_id,
            "template": email_template
        })

    return notification


@logger.inject_lambda_context
@tracer.capture_lambda_handler
def handler(event: dict, context: Any) -> dict:
    """Lambda entry point for EventBridge."""
    event_type = event.get('detail-type')
    payload = event.get('detail', {})
    user_id = payload.get('user_id')

    if not user_id:
        logger.error("No user_id in event payload")
        return {"status": "error", "message": "Missing user_id"}

    logger.info("Processing notification event", extra={
        "event_type": event_type,
        "user_id": user_id
    })

    notification = process_event(event_type, payload, user_id)

    return {
        "status": "processed",
        "notification_id": notification.id if notification else None
    }
```

### 5.3 Function: send_email

```python
"""
Send Email Handler
Processes SQS queue and sends emails via SES.
"""

import json
from typing import Any, List

from aws_lambda_powertools import Logger, Tracer
import boto3
from jinja2 import Environment, FileSystemLoader, select_autoescape

from src.services.user_service import UserService
from src.services.template_service import TemplateService

logger = Logger()
tracer = Tracer()

ses_client = boto3.client('ses')
user_service = UserService()
template_service = TemplateService()

FROM_EMAIL = "BBWS <noreply@kimmyai.io>"
REPLY_TO = "support@kimmyai.io"


@tracer.capture_method
def send_email(to_email: str, template_name: str, template_data: dict) -> str:
    """
    Send email using SES.

    Args:
        to_email: Recipient email address
        template_name: Name of email template
        template_data: Data to render in template

    Returns:
        SES message ID
    """
    # Load and render template
    subject, html_body, text_body = template_service.render_email(
        template_name,
        template_data
    )

    # Send via SES
    response = ses_client.send_email(
        Source=FROM_EMAIL,
        Destination={
            'ToAddresses': [to_email]
        },
        Message={
            'Subject': {'Data': subject, 'Charset': 'UTF-8'},
            'Body': {
                'Html': {'Data': html_body, 'Charset': 'UTF-8'},
                'Text': {'Data': text_body, 'Charset': 'UTF-8'}
            }
        },
        ReplyToAddresses=[REPLY_TO],
        Tags=[
            {'Name': 'template', 'Value': template_name},
            {'Name': 'environment', 'Value': 'prod'}
        ]
    )

    message_id = response['MessageId']

    logger.info("Email sent", extra={
        "message_id": message_id,
        "to": to_email,
        "template": template_name
    })

    return message_id


@logger.inject_lambda_context
@tracer.capture_lambda_handler
def handler(event: dict, context: Any) -> dict:
    """Lambda entry point for SQS."""
    records = event.get('Records', [])
    results = []

    for record in records:
        try:
            body = json.loads(record['body'])
            user_id = body['user_id']
            template_name = body['template_name']
            template_data = body['template_data']

            # Get user email
            user = user_service.get_by_id(user_id)
            if not user or not user.email:
                logger.warning("User not found or no email", extra={"user_id": user_id})
                continue

            # Add user name to template data
            template_data['user_name'] = user.name or user.email.split('@')[0]

            # Send email
            message_id = send_email(user.email, template_name, template_data)

            results.append({
                "status": "sent",
                "message_id": message_id,
                "user_id": user_id
            })

        except Exception as e:
            logger.exception("Failed to send email", extra={
                "record_id": record.get('messageId')
            })
            results.append({
                "status": "failed",
                "error": str(e)
            })

    return {"processed": len(results), "results": results}
```

### 5.4 Function: list_notifications

```python
"""
List Notifications Handler
Lists notifications for the authenticated user.
"""

from typing import Any, Optional

from aws_lambda_powertools import Logger, Tracer
from aws_lambda_powertools.event_handler import APIGatewayRestResolver
from pydantic import BaseModel, Field

from src.services.notification_service import NotificationService
from src.models.notification import Category
from src.utils.response import api_response, hateoas_links

logger = Logger()
tracer = Tracer()
app = APIGatewayRestResolver()

notification_service = NotificationService()


class ListNotificationsParams(BaseModel):
    """Query parameters for listing notifications."""
    unread_only: bool = Field(default=False, alias="unreadOnly")
    category: Optional[Category] = None
    page_size: int = Field(default=20, ge=1, le=100, alias="pageSize")
    page_token: Optional[str] = Field(default=None, alias="pageToken")


@app.get("/portal/notifications")
@tracer.capture_method
def list_notifications() -> dict[str, Any]:
    """
    List notifications for the authenticated user.

    Returns paginated list with unread count.
    """
    params = ListNotificationsParams(**app.current_event.query_string_parameters or {})

    user_id = app.current_event.request_context.authorizer.claims.get('sub')

    logger.info("Listing notifications", extra={
        "user_id": user_id,
        "unread_only": params.unread_only
    })

    result = notification_service.list_for_user(
        user_id=user_id,
        unread_only=params.unread_only,
        category=params.category,
        page_size=params.page_size,
        page_token=params.page_token
    )

    unread_count = notification_service.get_unread_count(user_id)
    count_by_category = notification_service.get_unread_count_by_category(user_id)

    return api_response(
        data=[n.to_dict() for n in result.items],
        meta={
            "totalCount": result.total_count,
            "unreadCount": unread_count,
            "unreadByCategory": count_by_category,
            "pageToken": result.next_page_token
        },
        links=hateoas_links(
            self="/portal/notifications",
            next=f"/portal/notifications?pageToken={result.next_page_token}" if result.next_page_token else None
        )
    )


@logger.inject_lambda_context
@tracer.capture_lambda_handler
def handler(event: dict, context: Any) -> dict:
    """Lambda entry point."""
    return app.resolve(event, context)
```

---

## 6. Sequence Diagrams

### 6.1 Event-Driven Notification Flow

```
                           EVENT-DRIVEN NOTIFICATION FLOW
+--------+    +----------+    +---------+    +--------+    +-------+    +-------+
| Source |    | Event    |    | Process |    |DynamoDB|    |  SQS  |    | Email |
| Service|    | Bridge   |    | Lambda  |    |        |    |       |    | Lambda|
+---+----+    +----+-----+    +----+----+    +----+----+    +---+---+    +---+---+
    |              |               |              |             |            |
    | PutEvents    |               |              |             |            |
    |------------->|               |              |             |            |
    |              |               |              |             |            |
    |              | Invoke (rule match)          |             |            |
    |              |-------------->|              |             |            |
    |              |               |              |             |            |
    |              |               | Get user preferences       |            |
    |              |               |------------->|             |            |
    |              |               |<-------------|             |            |
    |              |               |              |             |            |
    |              |               | Check category enabled     |            |
    |              |               |------+      |             |            |
    |              |               |<-----+      |             |            |
    |              |               |              |             |            |
    |              |               | Save in-app notification   |            |
    |              |               |------------->|             |            |
    |              |               |<-------------|             |            |
    |              |               |              |             |            |
    |              |               | Queue email  |             |            |
    |              |               |---------------------------->|           |
    |              |               |              |             |            |
    |              | Complete      |              |             |            |
    |              |<--------------|              |             |            |
    |              |               |              |             |            |
    |              |               |              |             | Poll queue |
    |              |               |              |             |<-----------|
    |              |               |              |             |            |
    |              |               |              |             | Get user email
    |              |               |              |<--------------------------|
    |              |               |              |--------------------------->|
    |              |               |              |             |            |
    |              |               |              |             | Send SES   |
    |              |               |              |             |----------->|
    |              |               |              |             |            |
```

### 6.2 Get Notifications (In-App)

```
                              GET NOTIFICATIONS SEQUENCE
+--------+    +----------+    +---------+    +---------+
| React  |    | API GW   |    | Lambda  |    | DynamoDB|
| SPA    |    |          |    |         |    |         |
+---+----+    +----+-----+    +----+----+    +----+----+
    |              |               |              |
    | GET /notifications?unreadOnly=true         |
    |------------->|               |              |
    |              | Invoke        |              |
    |              |-------------->|              |
    |              |               |              |
    |              |               | Query notifications
    |              |               |------------->|
    |              |               |<-------------|
    |              |               |              |
    |              |               | Get unread count
    |              |               |------------->|
    |              |               |<-------------|
    |              |               |              |
    |              | 200 OK        |              |
    |<-------------|<--------------|              |
    |              | {             |              |
    |              |   data: [...],|              |
    |              |   meta: {     |              |
    |              |     unreadCount: 5           |
    |              |   }           |              |
    |              | }             |              |
    |              |               |              |
    |  [Update notification bell badge]          |
    |              |               |              |
```

### 6.3 Mark Notification Read

```
                           MARK NOTIFICATION READ SEQUENCE
+--------+    +----------+    +---------+    +---------+
| React  |    | API GW   |    | Lambda  |    | DynamoDB|
| SPA    |    |          |    |         |    |         |
+---+----+    +----+-----+    +----+----+    +----+----+
    |              |               |              |
    | [User clicks notification]  |              |
    |              |               |              |
    | PUT /notifications/{id}/read               |
    |------------->|               |              |
    |              | Invoke        |              |
    |              |-------------->|              |
    |              |               |              |
    |              |               | Update notification
    |              |               | read=true, read_at=now
    |              |               |------------->|
    |              |               |<-------------|
    |              |               |              |
    |              | 200 OK        |              |
    |<-------------|<--------------|              |
    |              | {notification}|              |
    |              |               |              |
    |  [Navigate to notification.link]           |
    |  [Decrement badge count]    |              |
    |              |               |              |
```

---

## 7. Data Models

### 7.1 DynamoDB Single Table Design

| Entity | PK | SK | Attributes |
|--------|----|----|------------|
| Notification | `USER#{user_id}` | `NOTIF#{created_at}#{id}` | All notification fields |
| Preference | `USER#{user_id}` | `PREFERENCE` | All preference fields |

### 7.2 Entity Schemas

```python
# Notification Entity
{
    "PK": "USER#user_123",
    "SK": "NOTIF#2026-01-20T10:00:00Z#notif_abc",
    "entity_type": "NOTIFICATION",
    "id": "notif_abc",
    "user_id": "user_123",
    "type": "informational",
    "category": "site",
    "title": "Site Created",
    "message": "Your new site 'My Website' has been created successfully.",
    "link": "/tenants/t_123/sites/site_xyz",
    "data": {
        "site_id": "site_xyz",
        "site_name": "My Website",
        "tenant_id": "t_123"
    },
    "read": false,
    "created_at": "2026-01-20T10:00:00Z",
    "read_at": null,
    "GSI1PK": "USER#user_123#UNREAD",
    "GSI1SK": "2026-01-20T10:00:00Z"
}

# Preference Entity
{
    "PK": "USER#user_123",
    "SK": "PREFERENCE",
    "entity_type": "PREFERENCE",
    "user_id": "user_123",
    "email_enabled": true,
    "inapp_enabled": true,
    "marketing_enabled": false,
    "digest_frequency": "instant",
    "quiet_hours": {
        "enabled": true,
        "start": "22:00",
        "end": "08:00",
        "timezone": "Africa/Johannesburg"
    },
    "categories": {
        "site": true,
        "billing": true,
        "security": true,
        "team": true,
        "support": true,
        "migration": true
    },
    "updated_at": "2026-01-20T10:00:00Z"
}
```

### 7.3 GSI Definitions

| GSI Name | PK | SK | Purpose |
|----------|----|----|---------|
| UnreadNotificationsIndex | `GSI1PK` | `GSI1SK` | List unread notifications efficiently |

### 7.4 Access Patterns

| Access Pattern | Operation | Key Condition |
|----------------|-----------|---------------|
| List all notifications | Query | PK = USER#{user_id}, SK begins_with NOTIF# |
| List unread notifications | Query GSI1 | GSI1PK = USER#{user_id}#UNREAD |
| Get notification by ID | Query | PK = USER#{user_id}, SK contains {id} |
| Get preferences | GetItem | PK = USER#{user_id}, SK = PREFERENCE |
| Count unread | Query GSI1 | GSI1PK = USER#{user_id}#UNREAD (count only) |

---

## 8. Security

### 8.1 Authentication & Authorization

| Aspect | Implementation |
|--------|----------------|
| API Authentication | Cognito JWT via Lambda Authorizer |
| User Isolation | Users can only access their own notifications |
| Email Verification | SES verified domain |

### 8.2 Data Protection

| Data | Protection |
|------|------------|
| Notification content | DynamoDB encryption at rest |
| Email content | TLS in transit, SES encryption |
| User preferences | DynamoDB encryption at rest |
| PII in notifications | Minimal PII, redacted in logs |

### 8.3 Email Security

| Control | Implementation |
|---------|----------------|
| SPF | DNS record configured |
| DKIM | SES domain verification |
| DMARC | Policy configured |
| Unsubscribe | One-click unsubscribe link |
| Rate limiting | SES sending quotas |

### 8.4 IAM Policies

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DynamoDBNotificationAccess",
      "Effect": "Allow",
      "Action": [
        "dynamodb:Query",
        "dynamodb:GetItem",
        "dynamodb:PutItem",
        "dynamodb:UpdateItem"
      ],
      "Resource": [
        "arn:aws:dynamodb:*:*:table/bbws-portal-*",
        "arn:aws:dynamodb:*:*:table/bbws-portal-*/index/*"
      ]
    },
    {
      "Sid": "SESEmailAccess",
      "Effect": "Allow",
      "Action": "ses:SendEmail",
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "ses:FromAddress": "noreply@kimmyai.io"
        }
      }
    },
    {
      "Sid": "S3TemplateAccess",
      "Effect": "Allow",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::bbws-email-templates-*/*"
    },
    {
      "Sid": "SQSAccess",
      "Effect": "Allow",
      "Action": [
        "sqs:SendMessage",
        "sqs:ReceiveMessage",
        "sqs:DeleteMessage"
      ],
      "Resource": "arn:aws:sqs:*:*:bbws-notification-*"
    }
  ]
}
```

---

## 9. Error Handling

### 9.1 Error Codes

| Code | HTTP Status | Description | User Message |
|------|-------------|-------------|--------------|
| `NOTIFICATION_NOT_FOUND` | 404 | Notification ID not found | "Notification not found." |
| `INVALID_PREFERENCE` | 400 | Invalid preference value | "Invalid preference setting." |
| `EMAIL_DELIVERY_FAILED` | 500 | SES delivery failed | (Retry silently) |
| `TEMPLATE_NOT_FOUND` | 500 | Email template missing | (Use fallback) |

### 9.2 Retry Strategy

| Operation | Max Retries | Backoff | Idempotent |
|-----------|-------------|---------|------------|
| DynamoDB writes | 3 | Exponential | Yes |
| SES emails | 3 | Exponential | Yes (MessageDeduplicationId) |
| SQS processing | 3 | Via DLQ | Yes |

### 9.3 Dead Letter Queue

```yaml
Resources:
  NotificationDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: bbws-notification-dlq-${env}
      MessageRetentionPeriod: 1209600  # 14 days

  NotificationEmailQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: bbws-notification-email-${env}
      VisibilityTimeout: 90
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt NotificationDLQ.Arn
        maxReceiveCount: 3
```

---

## 10. Monitoring and Alerting

### 10.1 CloudWatch Metrics

| Metric | Namespace | Dimensions | Threshold | Alarm |
|--------|-----------|------------|-----------|-------|
| `NotificationsCreated` | BBWS/Notification | Environment, Category | - | - |
| `EmailsSent` | BBWS/Notification | Environment, Template | - | - |
| `EmailsFailed` | BBWS/Notification | Environment | >10/hour | Alert |
| `UnreadCount` | BBWS/Notification | Environment | - | - |
| `SESBounceRate` | AWS/SES | - | >5% | Alert |
| `SESComplaintRate` | AWS/SES | - | >0.1% | Alert |

### 10.2 Dashboard Widgets

```json
{
  "widgets": [
    {
      "type": "metric",
      "title": "Notifications by Category",
      "properties": {
        "metrics": [
          ["BBWS/Notification", "NotificationsCreated", "Category", "site"],
          ["BBWS/Notification", "NotificationsCreated", "Category", "billing"],
          ["BBWS/Notification", "NotificationsCreated", "Category", "security"],
          ["BBWS/Notification", "NotificationsCreated", "Category", "support"]
        ],
        "period": 3600
      }
    },
    {
      "type": "metric",
      "title": "Email Delivery",
      "properties": {
        "metrics": [
          ["BBWS/Notification", "EmailsSent"],
          ["BBWS/Notification", "EmailsFailed"]
        ]
      }
    },
    {
      "type": "metric",
      "title": "SES Health",
      "properties": {
        "metrics": [
          ["AWS/SES", "Bounce"],
          ["AWS/SES", "Complaint"]
        ]
      }
    }
  ]
}
```

### 10.3 Log Queries

```sql
-- Notifications created per hour by category
fields @timestamp, category
| filter entity_type = "NOTIFICATION"
| stats count(*) by bin(1h), category

-- Failed email deliveries
fields @timestamp, to_email, template, error_message
| filter level = "ERROR" and @message like /send_email/
| sort @timestamp desc
| limit 50

-- User preference updates
fields @timestamp, user_id, changes
| filter action = "update_preferences"
| sort @timestamp desc
```

---

## 11. NFRs

### 11.1 Performance Requirements

| Requirement | Target | Measurement |
|-------------|--------|-------------|
| API Response Time | <200ms (p95) | CloudWatch metrics |
| Event Processing | <5 seconds | Event-to-notification latency |
| Email Delivery | <30 seconds (p95) | SES metrics |
| Unread Count | <100ms | Query timing |

### 11.2 Availability Requirements

| Requirement | Target |
|-------------|--------|
| API Availability | 99.9% |
| Email Delivery | 99% (with retry) |
| Event Processing | 99.9% |

### 11.3 Scalability Requirements

| Dimension | Limit | Notes |
|-----------|-------|-------|
| Notifications per user | 1000 (displayed) | Older archived |
| Events per second | 100 | Across all sources |
| Emails per hour | 10,000 | SES quota |

---

## 12. Troubleshooting Playbook

### 12.1 Common Issues

| Issue | Symptoms | Resolution |
|-------|----------|------------|
| Notifications not appearing | Empty list | Check EventBridge rules, Lambda logs |
| Email not received | No email | Check SES delivery logs, spam folder |
| High unread count | Badge shows wrong number | Re-count unread, check GSI |
| Preferences not saving | Settings reset | Check DynamoDB writes, validation |

### 12.2 Investigation Steps

```bash
# Check EventBridge rules
aws events list-rules --event-bus-name bbws-portal-${env}

# Check SES delivery
aws ses get-send-statistics

# Check SES bounce/complaint
aws ses get-identity-notification-attributes \
  --identities kimmyai.io

# Check notification count
aws dynamodb query \
  --table-name bbws-portal-${env} \
  --index-name UnreadNotificationsIndex \
  --key-condition-expression "GSI1PK = :pk" \
  --expression-attribute-values '{":pk": {"S": "USER#user_123#UNREAD"}}' \
  --select COUNT

# Check DLQ for failed emails
aws sqs receive-message \
  --queue-url https://sqs.region.amazonaws.com/account/bbws-notification-dlq-${env}
```

---

## 13. Tagging

### 13.1 Resource Tags

| Tag Key | Value | Purpose |
|---------|-------|---------|
| `Environment` | dev/sit/prod | Environment identification |
| `Project` | bbws | Project identification |
| `Service` | portal-notification | Service identification |
| `Owner` | platform-team | Ownership |
| `CostCenter` | CC-001 | Cost allocation |
| `ManagedBy` | terraform | IaC tracking |

---

## 14. Risks and Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Email deliverability issues | Missed notifications | Medium | Multiple channels, monitoring |
| High SES costs | Budget overrun | Low | Email batching, digests |
| Notification fatigue | Users disable all | Medium | Smart defaults, categories |
| Event processing delays | Stale notifications | Low | SQS batching, scaling |
| PII in notifications | Privacy violation | Low | Minimal PII, encryption |

---

## 15. TBC

- [ ] Push notifications (mobile app)
- [ ] SMS notifications (critical alerts)
- [ ] Email analytics dashboard
- [ ] A/B testing for email templates
- [ ] Notification grouping/threading
- [ ] Real-time WebSocket notifications

---

## 16. Definition of Terms

| Term | Definition |
|------|------------|
| In-app notification | Notification displayed in portal UI |
| Transactional email | Critical system email (e.g., password reset) |
| Digest | Batched notification summary email |
| Quiet hours | Time period when emails are deferred |
| Unsubscribe | User opt-out from marketing emails |

---

## 17. Appendices

### Appendix A: Email Templates

Templates are stored in S3 and rendered using Jinja2.

**Template Structure:**
```
s3://bbws-email-templates-{env}/
   base.html           # Base layout
   site_created.html
   payment_success.html
   payment_failed.html
   ticket_replied.html
   migration_completed.html
   ...
```

**Base Template:**
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: #1a73e8; color: white; padding: 30px; text-align: center; }
        .content { padding: 30px; background: #ffffff; }
        .button { display: inline-block; background: #1a73e8; color: white;
                  padding: 12px 24px; text-decoration: none; border-radius: 4px; }
        .footer { padding: 20px; text-align: center; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://portal.kimmyai.io/logo.png" alt="BBWS" height="40">
        </div>
        <div class="content">
            {% block content %}{% endblock %}
        </div>
        <div class="footer">
            <p>BBWS WordPress Hosting | <a href="{{ unsubscribe_url }}">Unsubscribe</a></p>
            <p><a href="https://portal.kimmyai.io/settings/notifications">Manage Preferences</a></p>
        </div>
    </div>
</body>
</html>
```

### Appendix B: EventBridge Rule

```json
{
  "Name": "bbws-notification-rule",
  "EventBusName": "bbws-portal-bus",
  "EventPattern": {
    "source": [
      "bbws.site",
      "bbws.billing",
      "bbws.migration",
      "bbws.ticket",
      "bbws.auth",
      "bbws.organisation"
    ],
    "detail-type": [
      {"prefix": "site."},
      {"prefix": "payment."},
      {"prefix": "migration."},
      {"prefix": "ticket."},
      {"prefix": "user."}
    ]
  },
  "Targets": [
    {
      "Id": "notification-processor",
      "Arn": "arn:aws:lambda:{region}:{account}:function:bbws-notification-process-{env}"
    }
  ]
}
```

---

## 18. References

| Document | Description |
|----------|-------------|
| [HLD 2.2](../HLDs/2.2_BBWS_Customer_Portal_Private_HLD.md) | Parent HLD |
| [BRS 2.2](../BRS/2.2_BRS_Customer_Portal_Private.md) | Business Requirements |
| [AWS SES](https://docs.aws.amazon.com/ses/) | Email service |
| [AWS EventBridge](https://docs.aws.amazon.com/eventbridge/) | Event bus |

---

## 19. Signoff

| Role | Name | Date | Signature |
|------|------|------|-----------|
| LLD Author | LLD Architect Agent | 2026-01-20 | |
| Technical Reviewer | | | |
| Security Reviewer | | | |
| Product Owner | | | |

---

**End of Document**
