openapi: 3.0.3
info:
  title: BBWS Payment API
  description: |
    Payment processing API for BBWS Customer Portal Public.
    Integrates with PayFast payment gateway for South African customers.

    ## Integration Flow
    1. Client initiates payment via `POST /v1.0/payments`
    2. Client redirects user to PayFast using returned `paymentUrl`
    3. PayFast sends ITN callback to `POST /v1.0/payments/itn`
    4. Client polls `GET /v1.0/payments/{paymentId}` for status

  version: 1.0.0
  contact:
    name: BBWS Platform Team
    email: platform@bbws.io

servers:
  - url: https://api.dev.bbws.io/v1.0
    description: Development (Sandbox PayFast)
  - url: https://api.sit.bbws.io/v1.0
    description: SIT (Sandbox PayFast)
  - url: https://api.bbws.io/v1.0
    description: Production (Live PayFast)

tags:
  - name: Payments
    description: Payment processing operations

paths:
  /payments:
    post:
      tags:
        - Payments
      summary: Initiate payment
      description: |
        Creates a new payment record and returns PayFast form data for redirect.
        The client should use the returned `paymentUrl` and `paymentData` to
        redirect the user to PayFast for payment completion.
      operationId: initiatePayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitiatePaymentRequest'
            example:
              orderId: "ORD-550e8400-e29b-41d4-a716-446655440000"
              returnUrl: "https://buy.bbws.io/order/success"
              cancelUrl: "https://buy.bbws.io/order/cancelled"
      responses:
        '201':
          description: Payment initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InitiatePaymentResponse'
              example:
                paymentId: "PAY-550e8400-e29b-41d4-a716-446655440001"
                status: "PENDING"
                paymentUrl: "https://sandbox.payfast.co.za/eng/process"
                paymentData:
                  merchant_id: "10000100"
                  merchant_key: "46f0cd694581a"
                  return_url: "https://buy.bbws.io/order/success?paymentId=PAY-550e8400"
                  cancel_url: "https://buy.bbws.io/order/cancelled?paymentId=PAY-550e8400"
                  notify_url: "https://api.dev.bbws.io/v1.0/payments/itn"
                  name_first: "John"
                  name_last: "Doe"
                  email_address: "john@example.com"
                  cell_number: "+27821234567"
                  m_payment_id: "PAY-550e8400-e29b-41d4-a716-446655440001"
                  amount: "95.00"
                  item_name: "BBWS Entry Plan"
                  item_description: "Monthly subscription for BBWS Entry Plan"
                  signature: "a1b2c3d4e5f6g7h8i9j0"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: "VALIDATION_ERROR"
                  message: "Invalid order ID format"
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: "ORDER_NOT_FOUND"
                  message: "Order ORD-xxx not found"
        '422':
          description: Order not in valid state for payment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: "INVALID_ORDER_STATUS"
                  message: "Order must be in PENDING status to initiate payment"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/itn:
    post:
      tags:
        - Payments
      summary: PayFast ITN webhook
      description: |
        Instant Transaction Notification endpoint called by PayFast servers.

        **Security Requirements:**
        - Source IP must be from PayFast IP ranges
        - Signature must be validated
        - Payment verified with PayFast server

        **PayFast IP Ranges:**
        - 197.97.145.144/28
        - 197.97.145.160/28
        - 41.74.179.192/27
      operationId: handleITN
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/PayFastITN'
      responses:
        '200':
          description: ITN processed successfully
          content:
            text/plain:
              schema:
                type: string
                example: "OK"
        '400':
          description: Invalid ITN (signature mismatch, invalid data)
          content:
            text/plain:
              schema:
                type: string
                example: "Invalid signature"
        '404':
          description: Payment not found
          content:
            text/plain:
              schema:
                type: string
                example: "Payment not found"
        '500':
          description: Internal server error
          content:
            text/plain:
              schema:
                type: string
                example: "Internal error"

  /payments/{paymentId}:
    get:
      tags:
        - Payments
      summary: Get payment details
      description: |
        Retrieve payment status and details by payment ID.
        Use this endpoint to poll for payment completion after
        redirecting user to PayFast.
      operationId: getPayment
      parameters:
        - name: paymentId
          in: path
          required: true
          description: Payment identifier (returned from initiate payment)
          schema:
            type: string
            pattern: '^PAY-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
          example: "PAY-550e8400-e29b-41d4-a716-446655440001"
      responses:
        '200':
          description: Payment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
              example:
                paymentId: "PAY-550e8400-e29b-41d4-a716-446655440001"
                orderId: "ORD-550e8400-e29b-41d4-a716-446655440000"
                amount: 95.00
                currency: "ZAR"
                status: "COMPLETED"
                payFastReference: "12345678"
                paymentMethod: "cc"
                createdAt: "2026-01-05T10:30:00Z"
                updatedAt: "2026-01-05T10:35:00Z"
        '404':
          description: Payment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: "PAYMENT_NOT_FOUND"
                  message: "Payment PAY-xxx not found"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    InitiatePaymentRequest:
      type: object
      required:
        - orderId
        - returnUrl
        - cancelUrl
      properties:
        orderId:
          type: string
          description: Order ID to process payment for
          pattern: '^ORD-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
          example: "ORD-550e8400-e29b-41d4-a716-446655440000"
        returnUrl:
          type: string
          format: uri
          description: URL to redirect user after successful payment
          example: "https://buy.bbws.io/order/success"
        cancelUrl:
          type: string
          format: uri
          description: URL to redirect user if payment is cancelled
          example: "https://buy.bbws.io/order/cancelled"

    InitiatePaymentResponse:
      type: object
      properties:
        paymentId:
          type: string
          description: Unique payment identifier
          example: "PAY-550e8400-e29b-41d4-a716-446655440001"
        status:
          $ref: '#/components/schemas/PaymentStatus'
        paymentUrl:
          type: string
          format: uri
          description: PayFast payment URL to redirect user to
          example: "https://sandbox.payfast.co.za/eng/process"
        paymentData:
          $ref: '#/components/schemas/PayFastFormData'

    PayFastFormData:
      type: object
      description: |
        Form data to POST to PayFast payment URL.
        All fields should be included as hidden form inputs.
      properties:
        merchant_id:
          type: string
          description: PayFast merchant ID
        merchant_key:
          type: string
          description: PayFast merchant key
        return_url:
          type: string
          format: uri
          description: Success redirect URL
        cancel_url:
          type: string
          format: uri
          description: Cancel redirect URL
        notify_url:
          type: string
          format: uri
          description: ITN webhook URL
        name_first:
          type: string
          description: Customer first name
        name_last:
          type: string
          description: Customer last name
        email_address:
          type: string
          format: email
          description: Customer email
        cell_number:
          type: string
          description: Customer phone (E.164 format)
        m_payment_id:
          type: string
          description: Our payment reference (same as paymentId)
        amount:
          type: string
          description: Payment amount in ZAR (2 decimal places)
          pattern: '^\d+\.\d{2}$'
        item_name:
          type: string
          description: Item name (max 100 chars)
        item_description:
          type: string
          description: Item description (max 255 chars)
        signature:
          type: string
          description: MD5 signature (lowercase hex)

    PayFastITN:
      type: object
      description: PayFast Instant Transaction Notification payload
      required:
        - m_payment_id
        - pf_payment_id
        - payment_status
        - amount_gross
        - signature
      properties:
        m_payment_id:
          type: string
          description: Our payment reference
        pf_payment_id:
          type: string
          description: PayFast payment reference
        payment_status:
          type: string
          description: Payment status from PayFast
          enum:
            - COMPLETE
            - FAILED
            - PENDING
            - CANCELLED
        item_name:
          type: string
        item_description:
          type: string
        amount_gross:
          type: string
          description: Total amount paid
        amount_fee:
          type: string
          description: PayFast fee
        amount_net:
          type: string
          description: Net amount after fees
        name_first:
          type: string
        name_last:
          type: string
        email_address:
          type: string
        merchant_id:
          type: string
        signature:
          type: string
          description: MD5 signature for validation

    Payment:
      type: object
      properties:
        paymentId:
          type: string
          description: Unique payment identifier
        orderId:
          type: string
          description: Associated order ID
        amount:
          type: number
          format: double
          description: Payment amount in ZAR
        currency:
          type: string
          default: "ZAR"
          description: Currency code
        status:
          $ref: '#/components/schemas/PaymentStatus'
        payFastReference:
          type: string
          description: PayFast pf_payment_id (set after ITN)
          nullable: true
        paymentMethod:
          type: string
          description: Payment method used (cc, eft, etc.)
          nullable: true
        errorMessage:
          type: string
          description: Error details if payment failed
          nullable: true
        createdAt:
          type: string
          format: date-time
          description: Payment creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp

    PaymentStatus:
      type: string
      enum:
        - PENDING
        - PROCESSING
        - COMPLETED
        - FAILED
        - CANCELLED
        - REFUNDED
      description: |
        Payment status lifecycle:
        - PENDING: Payment created, awaiting user action
        - PROCESSING: User redirected to PayFast
        - COMPLETED: Payment successful (ITN received with COMPLETE)
        - FAILED: Payment failed
        - CANCELLED: User cancelled payment
        - REFUNDED: Payment refunded

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: Error code
            message:
              type: string
              description: Human-readable error message
            details:
              type: object
              description: Additional error details
              additionalProperties: true
        requestId:
          type: string
          description: Request ID for troubleshooting
        timestamp:
          type: string
          format: date-time

  securitySchemes:
    apiKey:
      type: apiKey
      in: header
      name: X-Api-Key
      description: API Gateway API key

security:
  - apiKey: []
