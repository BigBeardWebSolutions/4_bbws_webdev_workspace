# BRS 2.7: WordPress Tenant Management API

**Version**: 1.0 (Final)
**Document ID**: BRS-2.7
**Created**: 2026-01-05
**Last Updated**: 2026-01-05
**Status**: Final
**Author**: Platform Architecture Team
**Reviewed By**: TBD
**Approved By**: TBD

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 0.1 | 2026-01-05 | Platform Architecture | Initial draft from plan |
| 1.0 | 2026-01-05 | Platform Architecture | Final version |

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Scope Definition](#2-scope-definition)
3. [Actors and Personas](#3-actors-and-personas)
4. [Infrastructure Components](#4-infrastructure-components)
5. [Epic 1: WordPress Infrastructure Provisioning](#5-epic-1-wordpress-infrastructure-provisioning)
6. [Epic 2: Infrastructure Lifecycle Management](#6-epic-2-infrastructure-lifecycle-management)
7. [Epic 3: Cognito-WordPress Integration](#7-epic-3-cognito-wordpress-integration)
8. [Epic 4: Deprovisioning](#8-epic-4-deprovisioning)
9. [API Endpoints](#9-api-endpoints)
10. [State Machines](#10-state-machines)
11. [Data Models](#11-data-models)
12. [Business Rules](#12-business-rules)
13. [Non-Functional Requirements](#13-non-functional-requirements)
14. [Error Handling and Recovery](#14-error-handling-and-recovery)
15. [Monitoring and Observability](#15-monitoring-and-observability)
16. [Security Requirements](#16-security-requirements)
17. [Constraints](#17-constraints)
18. [Assumptions and Risks](#18-assumptions-and-risks)
19. [Glossary](#19-glossary)
20. [References](#20-references)
21. [Sign-Off](#21-sign-off)

---

## 1. Executive Summary

### 1.1 Purpose

The **WordPress Tenant Management API** is the infrastructure provisioning layer of the BBWS multi-tenant WordPress hosting platform. It is responsible for orchestrating the creation, management, and destruction of all AWS infrastructure resources required to run a dedicated WordPress instance for each tenant.

This API serves as the critical bridge between:
- **Logical tenant entities** (organizations, users, metadata stored in DynamoDB)
- **Physical AWS infrastructure** (ECS services, EFS access points, RDS databases, ALB rules, Cognito User Pools)

### 1.2 System Overview

The WordPress Tenant Management API is an **internal API** that is NOT exposed to customers. It is consumed by:
- The Tenant API (BRS 2.5) after tenant creation to provision infrastructure
- Platform operators via CLI scripts for manual provisioning operations
- DevOps automation for infrastructure lifecycle management

### 1.3 Business Value

| Value Proposition | Benefit |
|-------------------|---------|
| Infrastructure Automation | Reduces provisioning from 2+ hours manual to < 15 minutes automated |
| Multi-Tenant Isolation | Ensures complete resource isolation between tenants |
| Lifecycle Management | Handles creation, suspension, scaling, and clean deprovisioning |
| Cognito Integration | Per-tenant User Pools with WordPress SSO |
| Cost Optimization | Right-sized resources per tenant with auto-scaling |
| Rollback Capability | Automatic rollback on provisioning failures prevents orphaned resources |

### 1.4 How This API Differs From Other APIs

| API | Responsibility | Infrastructure Involvement |
|-----|----------------|---------------------------|
| **Tenant API (BRS 2.5)** | Organization CRUD, user assignments | **None** - purely DynamoDB operations |
| **WordPress API (BRS 2.6)** | Site content, templates, plugins | **None** - WordPress-level operations |
| **WordPress Tenant Management API (This BRS)** | Provision/deprovision ALL AWS resources | **Full** - ECS, EFS, RDS, ALB, Cognito |

### 1.5 Key Stakeholders

| Stakeholder | Interest | Responsibility |
|-------------|----------|----------------|
| Platform Operators | Primary users for provisioning | Execute provisioning operations |
| DevOps Engineers | Infrastructure management | Manage Terraform, troubleshoot failures |
| Security Engineers | Resource isolation | Validate security configurations |
| Tenant API (System) | Automation consumer | Triggers provisioning after tenant creation |

---

## 2. Scope Definition

### 2.1 In Scope

| Category | Components |
|----------|------------|
| **ECS Provisioning** | Task definitions, ECS services, auto-scaling policies, health checks |
| **EFS Management** | Access point creation per tenant, mount configurations, backups |
| **RDS Database** | Per-tenant database creation, MySQL user provisioning |
| **ALB Configuration** | Target groups, listener rules, path-based routing |
| **Cognito User Pool** | Per-tenant User Pool, App Client, domain setup, groups |
| **Cognito-WordPress Integration** | MiniOrange plugin configuration, OAuth endpoints |
| **Secrets Management** | Database credentials, Cognito secrets in Secrets Manager |
| **Lifecycle Operations** | Suspend, resume, scale, update container version |
| **Deprovisioning** | Complete resource cleanup, database archival, orphan detection |
| **Monitoring** | Health checks, CloudWatch metrics, resource status tracking |

### 2.2 Out of Scope

| Category | Handled By | Reference |
|----------|------------|-----------|
| Tenant organization management | Tenant API | BRS 2.5 |
| Site content management | WordPress API | BRS 2.6 |
| Template and plugin management | WordPress API | BRS 2.6 |
| User authentication flows | Cognito | Direct user interaction |
| Billing and payments | Customer Portal / Order API | BRS 2.1 |

### 2.3 Scope Boundary Summary

```
+------------------+     +------------------+     +------------------+
|   BRS 2.5        |     |   BRS 2.7        |     |   BRS 2.6        |
|   Tenant API     |     |   WP Tenant Mgmt |     |   WordPress API  |
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
| - Org CRUD       |     | - ECS Service    |     | - Sites CRUD     |
| - Hierarchy      |     | - EFS Access Pt  |     | - Templates      |
| - User Assign    |     | - RDS Database   |     | - Plugins        |
| - Status Mgmt    |     | - ALB Rules      |     | - WP REST API    |
|                  |     | - Cognito Pool   |     |                  |
+------------------+     +------------------+     +------------------+
     DynamoDB              AWS Resources           WordPress Layer
```

---

## 3. Actors and Personas

### 3.1 Primary Actors

| Actor | Type | Description | Authentication |
|-------|------|-------------|----------------|
| **Platform Operator** | Human | Provisions and manages WordPress infrastructure | Cognito + MFA |
| **DevOps Engineer** | Human | Manages underlying infrastructure, troubleshoots | IAM + SSO |
| **Tenant API (System)** | System | Triggers provisioning after tenant creation | IAM Role |
| **CloudWatch (System)** | System | Triggers auto-scaling, health check failures | AWS Service |

### 3.2 Persona Details

**Platform Operator - Sarah**
| Attribute | Description |
|-----------|-------------|
| Responsibility | Onboarding new customer tenants |
| Tools | CLI scripts, Admin Portal |
| Tasks | Provision WordPress instances, monitor status, troubleshoot failures |
| Frequency | Multiple times daily during growth phases |

**DevOps Engineer - Mike**
| Attribute | Description |
|-----------|-------------|
| Responsibility | Infrastructure management |
| Tools | Terraform, AWS Console, CLI |
| Tasks | Update Terraform modules, investigate failures, update container images |
| Frequency | Weekly maintenance, on-demand troubleshooting |

---

## 4. Infrastructure Components

### 4.1 ECS Fargate Configuration

| Component | Configuration |
|-----------|--------------|
| Cluster | `bbws-cluster` (shared across tenants) |
| Task CPU | 512 (0.5 vCPU) per tenant |
| Task Memory | 1024 MB (1 GB) per tenant |
| Desired Count | 2 tasks (multi-AZ high availability) |
| Auto-scaling | Min 2, Max 10, CPU 70%, Memory 80% |
| Platform Version | Fargate 1.4.0+ (required for EFS) |
| Deployment | Rolling update with circuit breaker |

**Service Naming Convention**: `tenant-{tenantId}-wordpress`

### 4.2 EFS (Elastic File System)

| Component | Configuration |
|-----------|--------------|
| Filesystem | Shared EFS with encryption at rest |
| Access Point | One per tenant |
| Mount Path | `/var/www/html/wp-content` |
| Throughput Mode | Elastic |
| POSIX User | www-data (33:33) |
| IAM Authorization | Enabled |

**Access Point Naming Convention**: `tenant-{tenantId}-wp-content`

### 4.3 RDS (MySQL)

| Component | Configuration |
|-----------|--------------|
| Instance | Shared RDS MySQL instance |
| Database per tenant | `tenant_{tenantId}_db` |
| User per tenant | `tenant_{tenantId}_user` |
| Character Set | UTF8MB4 |
| Credentials | AWS Secrets Manager |
| Encryption | KMS at rest |

### 4.4 ALB (Application Load Balancer)

| Component | Configuration |
|-----------|--------------|
| ALB | Shared internal ALB |
| Target Group | One per tenant |
| Listener Rule | Path-based routing with unique priority |
| Health Check Path | `/` |
| Health Check Interval | 30 seconds |
| Deregistration Delay | 30 seconds |

**Target Group Naming Convention**: `tenant-{tenantId}-tg`

### 4.5 Cognito User Pool

| Component | Configuration |
|-----------|--------------|
| User Pool | Per-tenant (dedicated) |
| App Client | Per-tenant with client secret |
| Domain | `bbws-tenant-{id}-{env}.auth.af-south-1.amazoncognito.com` |
| Groups | Admin, Operator, Viewer |
| MFA | Optional (TOTP) |
| Password Policy | Minimum 8 chars, uppercase, lowercase, number, special |
| Email Verification | Enabled |

---

## 5. Epic 1: WordPress Infrastructure Provisioning

**Epic ID**: EPIC-WPTM-001
**Description**: Provision complete WordPress infrastructure for a tenant
**Priority**: Critical
**Story Points**: 21

### US-WPTM-001: Provision WordPress Instance

**User Story:**
> As a Platform Operator,
> I want to provision a complete WordPress infrastructure for a tenant,
> So that the customer has an isolated, running WordPress instance.

**Pre-conditions:**
- Tenant exists in DynamoDB with status `PENDING_PROVISIONING`
- Shared infrastructure is available (VPC, ECS cluster, RDS, EFS)
- Operator has appropriate IAM permissions

**Positive Scenario: Successful Provisioning**

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | Operator executes: `python provision_wordpress.py --tenant-id tenant-1` | CLI receives command |
| 2 | API validates tenant exists and is in `PENDING_PROVISIONING` status | Validation passes |
| 3 | API creates EFS access point for tenant | Access point created with tenant directory |
| 4 | API creates MySQL database and user in shared RDS | Database and user created |
| 5 | API stores database credentials in Secrets Manager | Secret created/updated |
| 6 | API registers ECS task definition with tenant-specific config | Task definition registered |
| 7 | API creates ECS service with 2 tasks | Service created, tasks launching |
| 8 | API creates ALB target group and listener rule | Routing configured |
| 9 | API waits for service to stabilize (max 10 minutes) | Health checks passing |
| 10 | API updates tenant status to `ACTIVE` | Status updated in DynamoDB |
| 11 | API publishes `WORDPRESS_PROVISIONED` event to SQS | Event published |
| 12 | API returns success with resource ARNs | Response returned |

**Negative Scenario: ECS Service Fails to Stabilize**

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | Provisioning starts successfully | Resources being created |
| 2 | ECS tasks fail health checks repeatedly | Stabilization failing |
| 3 | API detects stabilization timeout after 10 minutes | Timeout detected |
| 4 | API initiates rollback: removes ALB rule, ECS service, EFS access point | Rollback in progress |
| 5 | API sets tenant status to `PROVISIONING_FAILED` | Status updated |
| 6 | API logs failure details for investigation | Logs written |
| 7 | API returns error with rollback confirmation | Error response returned |

**Acceptance Criteria:**
- [ ] AC-001: Complete provisioning in < 15 minutes
- [ ] AC-002: All resources tagged with `bbws:tenant-id`
- [ ] AC-003: Rollback completes on any failure
- [ ] AC-004: ECS service has 2 running tasks across 2 AZs
- [ ] AC-005: WordPress accessible via ALB path
- [ ] AC-006: Database credentials stored in Secrets Manager
- [ ] AC-007: Error messages are clear and actionable
- [ ] AC-008: Idempotency key supported for retry safety

---

### US-WPTM-002: Configure ECS Service

**User Story:**
> As the WordPress Tenant Management API,
> I want to create an ECS service for a tenant,
> So that WordPress containers are running with proper isolation.

**Task Definition Configuration:**
```json
{
  "family": "tenant-{tenantId}-wordpress",
  "cpu": "512",
  "memory": "1024",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "executionRoleArn": "arn:aws:iam::{account}:role/bbws-ecs-execution-role",
  "taskRoleArn": "arn:aws:iam::{account}:role/bbws-ecs-task-role",
  "volumes": [
    {
      "name": "wp-content",
      "efsVolumeConfiguration": {
        "fileSystemId": "{efs-id}",
        "transitEncryption": "ENABLED",
        "authorizationConfig": {
          "accessPointId": "{access-point-id}",
          "iam": "ENABLED"
        }
      }
    }
  ],
  "containerDefinitions": [
    {
      "name": "wordpress",
      "image": "{ecr-repo}/bbws-wordpress:{version}",
      "portMappings": [{"containerPort": 80, "protocol": "tcp"}],
      "mountPoints": [{"sourceVolume": "wp-content", "containerPath": "/var/www/html/wp-content"}],
      "secrets": [
        {"name": "WORDPRESS_DB_USER", "valueFrom": "{secret-arn}:username::"},
        {"name": "WORDPRESS_DB_PASSWORD", "valueFrom": "{secret-arn}:password::"}
      ],
      "healthCheck": {
        "command": ["CMD-SHELL", "curl -f http://localhost/ || exit 1"],
        "interval": 30,
        "timeout": 5,
        "retries": 3,
        "startPeriod": 60
      }
    }
  ]
}
```

**Acceptance Criteria:**
- [ ] AC-001: Task definition uses Fargate 1.4.0+
- [ ] AC-002: EFS volume mounted at `/var/www/html/wp-content`
- [ ] AC-003: Secrets injected from Secrets Manager
- [ ] AC-004: Health check configured with 60s start period
- [ ] AC-005: Deployment circuit breaker enabled
- [ ] AC-006: Service runs in private subnets only

---

### US-WPTM-003: Create EFS Access Point

**User Story:**
> As the WordPress Tenant Management API,
> I want to create an EFS access point for a tenant,
> So that each tenant has isolated persistent storage.

**Acceptance Criteria:**
- [ ] AC-001: Access point creates directory at `/tenant-{tenantId}`
- [ ] AC-002: POSIX user set to www-data (33:33)
- [ ] AC-003: Access point tagged with `bbws:tenant-id`
- [ ] AC-004: IAM authorization enabled
- [ ] AC-005: Root directory permissions set to 755

---

### US-WPTM-004: Create Tenant Database

**User Story:**
> As the WordPress Tenant Management API,
> I want to create a MySQL database for a tenant,
> So that WordPress has isolated database storage.

**Acceptance Criteria:**
- [ ] AC-001: Database created with UTF8MB4 character set
- [ ] AC-002: User has privileges only to their database
- [ ] AC-003: Password meets complexity requirements (16+ chars, mixed case, numbers, symbols)
- [ ] AC-004: Credentials stored in Secrets Manager with rotation enabled
- [ ] AC-005: Database name follows pattern `tenant_{tenantId}_db`

---

### US-WPTM-005: Configure ALB Routing

**User Story:**
> As the WordPress Tenant Management API,
> I want to configure ALB routing for a tenant,
> So that requests are routed to the correct ECS service.

**Acceptance Criteria:**
- [ ] AC-001: Target group registered with ECS service
- [ ] AC-002: Listener rule with unique priority (based on tenant creation order)
- [ ] AC-003: Health checks passing before traffic routed
- [ ] AC-004: Deregistration delay set to 30 seconds
- [ ] AC-005: Sticky sessions enabled for WordPress admin

---

## 6. Epic 2: Infrastructure Lifecycle Management

**Epic ID**: EPIC-WPTM-002
**Description**: Manage infrastructure lifecycle operations
**Priority**: High
**Story Points**: 13

### US-WPTM-006: Suspend WordPress Instance

**User Story:**
> As a Platform Operator,
> I want to suspend a tenant's WordPress instance,
> So that resources are freed while preserving data.

**Pre-conditions:**
- Tenant is in `ACTIVE` status
- Operator has suspend permission

**Suspension Flow:**
| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | API sets tenant status to `SUSPENDED` | Status updated |
| 2 | API sets ECS service desired count to 0 | Tasks draining |
| 3 | API removes ALB listener rule (optional) | Traffic blocked |
| 4 | Data preserved in EFS and RDS | No data loss |

**Acceptance Criteria:**
- [ ] AC-001: ECS desired count set to 0
- [ ] AC-002: Data preserved (EFS, RDS)
- [ ] AC-003: Tenant status updated to `SUSPENDED`
- [ ] AC-004: Suspension completes within 2 minutes
- [ ] AC-005: `TENANT_SUSPENDED` event published

---

### US-WPTM-007: Resume WordPress Instance

**User Story:**
> As a Platform Operator,
> I want to resume a suspended tenant's WordPress instance,
> So that the customer can access their site again.

**Acceptance Criteria:**
- [ ] AC-001: Service resumes within 5 minutes
- [ ] AC-002: WordPress data intact
- [ ] AC-003: ALB routing restored
- [ ] AC-004: Auto-scaling policies active
- [ ] AC-005: Tenant status updated to `ACTIVE`
- [ ] AC-006: `TENANT_RESUMED` event published

---

### US-WPTM-008: Scale WordPress Resources

**User Story:**
> As a Platform Operator,
> I want to scale a tenant's WordPress resources,
> So that performance matches demand.

**Acceptance Criteria:**
- [ ] AC-001: Horizontal scaling: min 2, max 10 tasks supported
- [ ] AC-002: Vertical scaling: task definition version increment
- [ ] AC-003: Zero-downtime deployment
- [ ] AC-004: Cost impact logged
- [ ] AC-005: Scaling completes within 10 minutes

---

### US-WPTM-009: Update Container Version

**User Story:**
> As a DevOps Engineer,
> I want to update a tenant's WordPress container version,
> So that security patches and updates are applied.

**Acceptance Criteria:**
- [ ] AC-001: Rolling deployment with zero downtime
- [ ] AC-002: Automatic rollback on failure
- [ ] AC-003: Audit log of version change
- [ ] AC-004: WordPress version tracked in tenant metadata
- [ ] AC-005: Health check validation before completion

---

## 7. Epic 3: Cognito-WordPress Integration

**Epic ID**: EPIC-WPTM-003
**Description**: Provision and configure Cognito for tenant authentication
**Priority**: High
**Story Points**: 8

### US-WPTM-010: Create Cognito User Pool

**User Story:**
> As the WordPress Tenant Management API,
> I want to create a Cognito User Pool for a tenant,
> So that tenant users can authenticate.

**User Pool Configuration:**
```json
{
  "PoolName": "bbws-tenant-{tenantId}-user-pool",
  "Policies": {
    "PasswordPolicy": {
      "MinimumLength": 8,
      "RequireUppercase": true,
      "RequireLowercase": true,
      "RequireNumbers": true,
      "RequireSymbols": true
    }
  },
  "MfaConfiguration": "OPTIONAL",
  "AutoVerifiedAttributes": ["email"],
  "AccountRecoverySetting": {
    "RecoveryMechanisms": [{"Name": "verified_email", "Priority": 1}]
  }
}
```

**Acceptance Criteria:**
- [ ] AC-001: User Pool created with unique name
- [ ] AC-002: Password policy enforced
- [ ] AC-003: MFA optional (TOTP)
- [ ] AC-004: Email verification enabled
- [ ] AC-005: User Pool tagged with `bbws:tenant-id`

---

### US-WPTM-011: Configure Cognito App Client

**User Story:**
> As the WordPress Tenant Management API,
> I want to configure a Cognito App Client,
> So that WordPress can authenticate against Cognito.

**Acceptance Criteria:**
- [ ] AC-001: Client secret generated
- [ ] AC-002: Secret stored in Secrets Manager
- [ ] AC-003: OAuth code flow enabled
- [ ] AC-004: Callback URLs configured for WordPress
- [ ] AC-005: Token validity periods configured (access: 1h, refresh: 30d)

---

### US-WPTM-012: Set Up WordPress OAuth Plugin

**User Story:**
> As the WordPress Tenant Management API,
> I want to configure the WordPress OAuth plugin,
> So that users can log in via Cognito SSO.

**Acceptance Criteria:**
- [ ] AC-001: MiniOrange (or equivalent) plugin activated
- [ ] AC-002: Cognito endpoints configured
- [ ] AC-003: Test authentication succeeds
- [ ] AC-004: Role mapping configured (Cognito groups to WP roles)
- [ ] AC-005: Plugin settings stored securely

---

## 8. Epic 4: Deprovisioning

**Epic ID**: EPIC-WPTM-004
**Description**: Complete resource cleanup when a tenant is offboarded
**Priority**: High
**Story Points**: 8

### US-WPTM-013: Deprovision WordPress Instance

**User Story:**
> As a Platform Operator,
> I want to completely deprovision a tenant's WordPress infrastructure,
> So that all resources are removed when a customer leaves.

**Deprovisioning Sequence:**
| Step | Action | Resource |
|------|--------|----------|
| 1 | Update tenant status to `PENDING_DEPROVISIONING` | DynamoDB |
| 2 | Remove ALB listener rule | ALB |
| 3 | Delete ALB target group | ALB |
| 4 | Stop ECS service (desired count = 0) | ECS |
| 5 | Wait for tasks to terminate | ECS |
| 6 | Delete ECS service | ECS |
| 7 | Delete EFS access point | EFS |
| 8 | Archive database (snapshot) | RDS |
| 9 | Drop MySQL database and user | RDS |
| 10 | Delete Secrets Manager secrets | Secrets Manager |
| 11 | Delete Cognito User Pool | Cognito |
| 12 | Update tenant status to `DEPROVISIONED` | DynamoDB |

**Acceptance Criteria:**
- [ ] AC-001: All resources removed (verified by tag scan)
- [ ] AC-002: Database archived before deletion (configurable)
- [ ] AC-003: No orphaned resources after completion
- [ ] AC-004: Deprovisioning completes in < 10 minutes
- [ ] AC-005: `TENANT_DEPROVISIONED` audit event logged
- [ ] AC-006: Rollback supported if deprovisioning fails midway

---

### US-WPTM-014: Archive Tenant Data Before Deletion

**User Story:**
> As a Platform Operator,
> I want tenant data archived before deletion,
> So that data can be recovered if needed.

**Acceptance Criteria:**
- [ ] AC-001: RDS snapshot created before database drop
- [ ] AC-002: EFS data backed up to S3
- [ ] AC-003: 90-day retention policy applied
- [ ] AC-004: Archives tagged with tenant ID and deletion date
- [ ] AC-005: S3 lifecycle policy for automatic cleanup

---

## 9. API Endpoints

### 9.1 Provisioning Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/internal/tenants/{tenantId}/wordpress/provision` | Provision infrastructure | IAM/JWT |
| GET | `/internal/tenants/{tenantId}/wordpress/status` | Get provisioning status | IAM/JWT |
| DELETE | `/internal/tenants/{tenantId}/wordpress` | Deprovision all | IAM/JWT |

### 9.2 Resource Management Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| PUT | `/internal/tenants/{tenantId}/wordpress/scale` | Scale resources | IAM/JWT |
| PUT | `/internal/tenants/{tenantId}/wordpress/suspend` | Suspend instance | IAM/JWT |
| PUT | `/internal/tenants/{tenantId}/wordpress/resume` | Resume instance | IAM/JWT |
| PUT | `/internal/tenants/{tenantId}/wordpress/version` | Update container version | IAM/JWT |

### 9.3 Cognito Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/internal/tenants/{tenantId}/cognito/provision` | Provision Cognito | IAM/JWT |
| GET | `/internal/tenants/{tenantId}/cognito/status` | Get Cognito status | IAM/JWT |
| DELETE | `/internal/tenants/{tenantId}/cognito` | Delete User Pool | IAM/JWT |

### 9.4 Health and Status Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/internal/tenants/{tenantId}/wordpress/health` | Get infrastructure health | IAM/JWT |
| GET | `/internal/tenants/{tenantId}/wordpress/resources` | List provisioned resources | IAM/JWT |

---

## 10. State Machines

### 10.1 Provisioning State Machine

```
                   PENDING_PROVISIONING
                           |
                           v
                    PROVISIONING_EFS
                           |
           +---------------+---------------+
           | Success                       | Failure
           v                               v
    PROVISIONING_RDS                  FAILED (rollback)
           |
           v
    PROVISIONING_ECS
           |
           v
     CONFIGURING_ALB
           |
           v
  PROVISIONING_COGNITO
           |
           v
  CONFIGURING_WORDPRESS
           |
           v
         ACTIVE
```

**State Descriptions:**

| State | Description | Timeout |
|-------|-------------|---------|
| PENDING_PROVISIONING | Initial state, awaiting provisioning | - |
| PROVISIONING_EFS | Creating EFS access point | 60s |
| PROVISIONING_RDS | Creating database and user | 120s |
| PROVISIONING_ECS | Creating task definition and service | 600s |
| CONFIGURING_ALB | Creating target group and listener rule | 60s |
| PROVISIONING_COGNITO | Creating User Pool and App Client | 120s |
| CONFIGURING_WORDPRESS | Configuring WordPress OAuth plugin | 120s |
| ACTIVE | Fully provisioned and operational | - |
| FAILED | Provisioning failed (rollback triggered) | - |

### 10.2 Deprovisioning State Machine

```
         ACTIVE
            |
            v
  PENDING_DEPROVISIONING
            |
            v
      REMOVING_ALB
            |
            v
      REMOVING_ECS
            |
            v
      REMOVING_EFS
            |
            v
     ARCHIVING_RDS
            |
            v
    REMOVING_COGNITO
            |
            v
     DEPROVISIONED
```

---

## 11. Data Models

### 11.1 ProvisioningState Enum

```python
class ProvisioningState(Enum):
    PENDING_PROVISIONING = "PENDING_PROVISIONING"
    PROVISIONING_EFS = "PROVISIONING_EFS"
    PROVISIONING_RDS = "PROVISIONING_RDS"
    PROVISIONING_ECS = "PROVISIONING_ECS"
    CONFIGURING_ALB = "CONFIGURING_ALB"
    PROVISIONING_COGNITO = "PROVISIONING_COGNITO"
    CONFIGURING_WORDPRESS = "CONFIGURING_WORDPRESS"
    ACTIVE = "ACTIVE"
    SUSPENDED = "SUSPENDED"
    PENDING_DEPROVISIONING = "PENDING_DEPROVISIONING"
    DEPROVISIONED = "DEPROVISIONED"
    FAILED = "FAILED"
```

### 11.2 TenantResources Data Model

```python
@dataclass
class TenantResources:
    tenant_id: str
    ecs_service_arn: Optional[str] = None
    ecs_task_definition_arn: Optional[str] = None
    efs_access_point_id: Optional[str] = None
    efs_access_point_arn: Optional[str] = None
    database_name: Optional[str] = None
    database_user: Optional[str] = None
    database_secret_arn: Optional[str] = None
    alb_target_group_arn: Optional[str] = None
    alb_listener_rule_arn: Optional[str] = None
    cognito_user_pool_id: Optional[str] = None
    cognito_user_pool_arn: Optional[str] = None
    cognito_app_client_id: Optional[str] = None
    cognito_domain: Optional[str] = None
    provisioning_state: ProvisioningState = ProvisioningState.PENDING_PROVISIONING
    provisioning_started_at: Optional[datetime] = None
    provisioning_completed_at: Optional[datetime] = None
    last_error: Optional[str] = None
    created_at: datetime = field(default_factory=datetime.utcnow)
    updated_at: datetime = field(default_factory=datetime.utcnow)
```

### 11.3 DynamoDB Table Schema

**Table Name:** `{env}-tenant-resources`

**Primary Key:**
- PK (Partition Key): `TENANT#{tenantId}`
- SK (Sort Key): `RESOURCES`

**Attributes:**

| Attribute | Type | Description |
|-----------|------|-------------|
| PK | String | Partition key |
| SK | String | Sort key |
| tenantId | String | Tenant identifier |
| provisioningState | String | Current provisioning state |
| ecsServiceArn | String | ECS service ARN |
| ecsTaskDefinitionArn | String | Task definition ARN |
| efsAccessPointId | String | EFS access point ID |
| databaseName | String | MySQL database name |
| databaseSecretArn | String | Secrets Manager ARN |
| albTargetGroupArn | String | ALB target group ARN |
| albListenerRuleArn | String | ALB listener rule ARN |
| cognitoUserPoolId | String | Cognito User Pool ID |
| cognitoAppClientId | String | Cognito App Client ID |
| provisioningStartedAt | String | ISO 8601 timestamp |
| provisioningCompletedAt | String | ISO 8601 timestamp |
| lastError | String | Last error message |
| createdAt | String | ISO 8601 timestamp |
| updatedAt | String | ISO 8601 timestamp |
| version | Number | Optimistic locking version |

---

## 12. Business Rules

### 12.1 Provisioning Rules

| Rule ID | Rule | Rationale |
|---------|------|-----------|
| BR-PROV-001 | Tenant must be in `PENDING_PROVISIONING` status to start provisioning | Prevent duplicate provisioning |
| BR-PROV-002 | Minimum 2 ECS tasks across 2 AZs | High availability requirement |
| BR-PROV-003 | All resources tagged with `bbws:tenant-id` | Resource tracking and cost allocation |
| BR-PROV-004 | Database names follow `tenant_{id}_db` pattern | Naming consistency |
| BR-PROV-005 | Provisioning must complete within 15 minutes | SLA requirement |
| BR-PROV-006 | Failed provisioning must rollback all resources | Prevent orphaned resources |
| BR-PROV-007 | Idempotency key required for provisioning requests | Prevent duplicate operations |

### 12.2 Resource Naming Conventions

| Resource | Pattern | Example |
|----------|---------|---------|
| ECS Service | `tenant-{tenantId}-wordpress` | `tenant-abc123-wordpress` |
| Task Definition | `tenant-{tenantId}-wordpress` | `tenant-abc123-wordpress` |
| EFS Access Point | `tenant-{tenantId}-wp-content` | `tenant-abc123-wp-content` |
| Database | `tenant_{tenantId}_db` | `tenant_abc123_db` |
| DB User | `tenant_{tenantId}_user` | `tenant_abc123_user` |
| Secret | `bbws/{env}/tenant-{tenantId}/db` | `bbws/dev/tenant-abc123/db` |
| Target Group | `tenant-{tenantId}-tg` | `tenant-abc123-tg` |
| Cognito Pool | `bbws-tenant-{tenantId}-user-pool` | `bbws-tenant-abc123-user-pool` |

### 12.3 Resource Limits Per Tenant

| Resource | Default | Maximum | Configurable |
|----------|---------|---------|--------------|
| ECS Tasks | 2 | 10 | Yes |
| Task vCPU | 0.5 | 2 | Yes |
| Task Memory | 1 GB | 4 GB | Yes |
| EFS Storage | Unlimited | Unlimited | N/A |
| Database Size | 5 GB | 100 GB | Yes |

### 12.4 Timeout Policies

| Operation | Timeout | Retry |
|-----------|---------|-------|
| EFS Access Point Creation | 60 seconds | 3 |
| Database Creation | 120 seconds | 3 |
| ECS Service Stabilization | 600 seconds | 1 |
| ALB Rule Configuration | 60 seconds | 3 |
| Cognito User Pool Creation | 120 seconds | 3 |
| Full Provisioning (total) | 900 seconds | 1 |
| Deprovisioning (total) | 600 seconds | 1 |

### 12.5 Lifecycle Rules

| Rule ID | Rule | Rationale |
|---------|------|-----------|
| BR-LIFE-001 | Suspended tenants retain all data | Data preservation |
| BR-LIFE-002 | Resume must restore within 5 minutes | SLA requirement |
| BR-LIFE-003 | Scaling requires active tenant status | Prevent scaling failures |
| BR-LIFE-004 | Container updates use rolling deployment | Zero downtime |
| BR-LIFE-005 | Deprovisioning archives data before deletion | Recovery capability |

---

## 13. Non-Functional Requirements

### 13.1 Performance

| Metric | Target | Measurement |
|--------|--------|-------------|
| Provisioning time | < 15 minutes | End-to-end |
| Deprovisioning time | < 10 minutes | End-to-end |
| API response time | < 500ms | P95 |
| ECS service stabilization | < 5 minutes | Tasks healthy |
| Resume from suspended | < 5 minutes | To active |

### 13.2 Availability

| Metric | Target | Measurement |
|--------|--------|-------------|
| API availability | 99.9% | Monthly uptime |
| Provisioning success rate | > 99% | Successful completions |
| ECS service availability | 99.9% per tenant | Per tenant uptime |

### 13.3 Resource Isolation Guarantees

| Resource | Isolation Level | Implementation |
|----------|-----------------|----------------|
| Compute | Container | Fargate microVM |
| Storage | Access Point | EFS access points with IAM |
| Database | Logical | Separate databases in shared instance |
| Network | Security Group | Per-tier security groups |
| Identity | User Pool | Per-tenant Cognito |

### 13.4 Scalability

| Metric | Target |
|--------|--------|
| Concurrent provisioning | 10 tenants |
| Total tenants | 100+ (initial), 1000+ (scale) |
| Tasks per tenant | 2-10 (auto-scaling) |

---

## 14. Error Handling and Recovery

### 14.1 Rollback Procedures

**Rollback is triggered when any provisioning step fails.**

```python
def rollback_provisioning(tenant_id: str, resources: TenantResources):
    """Rollback in reverse order of creation"""

    # 1. Remove Cognito resources
    if resources.cognito_user_pool_id:
        delete_cognito_user_pool(resources.cognito_user_pool_id)

    # 2. Remove ALB configuration
    if resources.alb_listener_rule_arn:
        delete_listener_rule(resources.alb_listener_rule_arn)
    if resources.alb_target_group_arn:
        delete_target_group(resources.alb_target_group_arn)

    # 3. Remove ECS service
    if resources.ecs_service_arn:
        update_service_desired_count(resources.ecs_service_arn, 0)
        wait_for_tasks_to_stop()
        delete_service(resources.ecs_service_arn)

    # 4. Remove EFS access point
    if resources.efs_access_point_id:
        delete_access_point(resources.efs_access_point_id)

    # 5. Remove database and user
    if resources.database_name:
        drop_database(resources.database_name)
        drop_user(resources.database_user)

    # 6. Remove secrets
    if resources.database_secret_arn:
        delete_secret(resources.database_secret_arn, force=True)

    # 7. Update tenant status
    update_provisioning_state(tenant_id, ProvisioningState.FAILED)
```

### 14.2 Orphan Resource Detection

**Daily scheduled job to detect orphaned resources:**

| Step | Action | Alert |
|------|--------|-------|
| 1 | Scan all resources with `bbws:tenant-id` tag | N/A |
| 2 | Compare with DynamoDB tenant records | N/A |
| 3 | Flag resources without matching active tenant | Medium |
| 4 | Alert operations team for manual review | SNS |

### 14.3 Dead Letter Queue Configuration

| Queue | Max Receive | Retention | Alarm |
|-------|-------------|-----------|-------|
| Provisioning DLQ | 3 | 14 days | DLQ depth > 0 |
| Deprovisioning DLQ | 3 | 14 days | DLQ depth > 0 |

### 14.4 Error Codes

| Code | Description | Recovery Action |
|------|-------------|-----------------|
| PROV-001 | EFS access point creation failed | Retry with backoff |
| PROV-002 | Database creation failed | Check RDS capacity |
| PROV-003 | ECS service stabilization timeout | Check container logs |
| PROV-004 | ALB rule creation failed | Check listener capacity |
| PROV-005 | Cognito pool creation failed | Check service limits |
| PROV-006 | Rollback failed | Manual intervention required |

---

## 15. Monitoring and Observability

### 15.1 CloudWatch Metrics

| Metric | Namespace | Alarm Threshold | Action |
|--------|-----------|-----------------|--------|
| ProvisioningDuration | BBWS/WordPress | > 15 minutes | Alert ops |
| ProvisioningSuccess | BBWS/WordPress | < 95% success | Alert ops |
| ProvisioningFailures | BBWS/WordPress | > 5/hour | Alert ops |
| ECSTaskCount | AWS/ECS | < desiredCount | Auto-scale |
| ECSCPUUtilization | AWS/ECS | > 90% | Auto-scale |
| ECSMemoryUtilization | AWS/ECS | > 90% | Auto-scale |
| DLQMessageCount | AWS/SQS | > 0 | Alert ops |

### 15.2 CloudWatch Alarms

| Alarm | Condition | Severity | Notification |
|-------|-----------|----------|--------------|
| Provisioning Failure | Any failure | High | SNS -> PagerDuty |
| Provisioning Timeout | > 20 minutes | High | SNS -> PagerDuty |
| ECS Tasks Unhealthy | Running < desired for 5 min | Critical | SNS -> PagerDuty |
| DLQ Message | DLQ depth > 0 | Medium | SNS -> Slack |
| Orphan Resources | Detected orphans | Low | SNS -> Email |

### 15.3 Logging

| Log Group | Retention | Content |
|-----------|-----------|---------|
| `/bbws/wordpress-tenant-mgmt/api` | 30 days | API requests/responses |
| `/bbws/wordpress-tenant-mgmt/provisioning` | 90 days | Provisioning operations |
| `/bbws/wordpress-tenant-mgmt/errors` | 90 days | Error details |
| `/aws/ecs/tenant-{tenantId}-wordpress` | 30 days | Container logs |

---

## 16. Security Requirements

### 16.1 Authentication and Authorization

| Component | Method | Details |
|-----------|--------|---------|
| API Authentication | IAM / JWT | Internal API with IAM for system, JWT for operators |
| Cognito | Per-tenant pools | Complete tenant isolation |
| Secrets | Secrets Manager | Database credentials, Cognito secrets |

### 16.2 Encryption

| Data Type | At Rest | In Transit |
|-----------|---------|------------|
| EFS | KMS (AWS-managed) | TLS 1.2+ |
| RDS | KMS (AWS-managed) | TLS 1.2+ |
| Secrets | KMS | HTTPS |
| API Requests | N/A | TLS 1.2+ |

### 16.3 Network Security

| Control | Implementation |
|---------|----------------|
| VPC | Private subnets only |
| Security Groups | Least privilege per tier |
| NAT Gateway | Outbound only for container pulls |
| VPC Endpoints | ECR, Secrets Manager, CloudWatch |

### 16.4 IAM Roles

| Role | Purpose | Permissions |
|------|---------|-------------|
| `bbws-ecs-execution-role` | ECS task execution | ECR pull, Secrets Manager read, CloudWatch logs |
| `bbws-ecs-task-role` | Container runtime | EFS access, CloudWatch metrics |
| `bbws-provisioning-lambda-role` | Provisioning Lambda | Full ECS, EFS, RDS, ALB, Cognito, Secrets Manager |

---

## 17. Constraints

| Constraint | Description | Impact |
|------------|-------------|--------|
| Fargate Platform | Must use Fargate 1.4.0+ for EFS | Limits to specific regions |
| Shared RDS | Database per tenant, not instance per tenant | Cost vs isolation tradeoff |
| Shared EFS | Access point per tenant | Performance may be affected at scale |
| ALB Listener Rules | Max 100 rules per listener | May need multiple listeners at scale |
| Cognito Limits | 60 User Pools per account (default) | Request limit increase |

---

## 18. Assumptions and Risks

### 18.1 Assumptions

| ID | Assumption | Validation |
|----|------------|------------|
| A-001 | Shared VPC infrastructure is provisioned | Verify VPC exists |
| A-002 | ECS cluster is created | Verify cluster exists |
| A-003 | Shared RDS instance is available | Verify RDS status |
| A-004 | Shared EFS filesystem is created | Verify EFS exists |
| A-005 | ALB is provisioned | Verify ALB exists |
| A-006 | IAM roles are created | Verify roles exist |

### 18.2 Risks

| ID | Risk | Probability | Impact | Mitigation |
|----|------|-------------|--------|------------|
| R-001 | Provisioning timeout | Medium | High | Increase timeout, parallel steps |
| R-002 | Orphaned resources | Low | Medium | Daily cleanup job |
| R-003 | RDS connection exhaustion | Medium | High | Connection pooling, limits per tenant |
| R-004 | EFS throughput bottleneck | Low | Medium | Monitor throughput, consider bursting |
| R-005 | Rollback failure | Low | Critical | Manual intervention procedures |
| R-006 | Service limit reached | Low | High | Request limit increases proactively |

---

## 19. Glossary

| Term | Definition |
|------|------------|
| **Tenant** | A customer organization that has one or more WordPress instances |
| **Provisioning** | The process of creating all AWS resources for a tenant |
| **Deprovisioning** | The process of removing all AWS resources for a tenant |
| **ECS** | Amazon Elastic Container Service - runs Docker containers |
| **Fargate** | Serverless compute for ECS - no EC2 management |
| **EFS** | Amazon Elastic File System - shared file storage |
| **ALB** | Application Load Balancer - HTTP/HTTPS routing |
| **Cognito** | Amazon Cognito - user authentication service |
| **Access Point** | EFS feature for isolated directory access |
| **Task Definition** | ECS blueprint for running containers |
| **Service** | ECS construct that maintains desired task count |

---

## 20. References

| Document | Path |
|----------|------|
| BRS 2.5 Tenant Management | `BRS/2.5_BRS_Tenant_Management.md` |
| BRS 2.6 WordPress Technical Management | `BRS/2.6_BRS_WordPress_Technical_Management.md` |
| HLD 2.0 BBWS ECS WordPress | `HLDs/2.0_BBWS_ECS_WordPress_HLD.md` |
| LLD Tenant Management | `LLDs/Tenant_Management_LLD.md` |
| LLD Cognito Tenant Pools | `LLDs/Cognito_Tenant_Pools_LLD.md` |
| LLD Container | `LLDs/Container_LLD.md` |
| LLD VPC | `LLDs/VPC_LLD.md` |

---

## 21. Sign-Off

| Role | Name | Signature | Date |
|------|------|-----------|------|
| Product Owner | | | |
| Technical Lead | | | |
| DevOps Lead | | | |
| Security Lead | | | |

---

**End of Document**
