# BRS 2.6: WordPress Technical Management

**Version**: 1.0 (Final)
**Date**: 2026-01-05
**Status**: Final
**Document Owner**: BBWS Platform Team
**Integration Method**: WordPress REST API
**Container Architecture**: One ECS Task per Tenant (WordPress Multisite)

---

## Document Control

| Version | Date       | Author      | Changes                           |
|---------|------------|-------------|-----------------------------------|
| 0.1     | 2026-01-04 | Planning    | Initial draft from planning phase |
| 1.0     | 2026-01-05 | Finalization| Final version after review        |

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Scope Definition](#2-scope-definition)
3. [Actors and Personas](#3-actors-and-personas)
4. [Domain 1: Sites API](#4-domain-1-sites-api)
5. [Domain 2: Templates API](#5-domain-2-templates-api)
6. [Domain 3: Plugins API](#6-domain-3-plugins-api)
7. [Domain 4: SQS Operations](#7-domain-4-sqs-operations)
8. [Business Rules](#8-business-rules)
9. [API Endpoints](#9-api-endpoints)
10. [Data Model](#10-data-model)
11. [Non-Functional Requirements](#11-non-functional-requirements)
12. [Error Handling](#12-error-handling)
13. [Value-Add Features](#13-value-add-features)
14. [References](#14-references)
15. [Glossary](#15-glossary)
16. [Sign-Off](#16-sign-off)

---

## 1. Executive Summary

### 1.1 Purpose

This Business Requirements Specification (BRS) defines the functional and non-functional requirements for the WordPress Technical Management module of the BBWS (Black Business Web Solutions) Platform. This module provides the API layer that exposes WordPress functionality to consumers (Customer Portal Private, Admin Portal).

### 1.2 What is WordPress Technical Management?

**WordPress Technical Management** is the API layer that serves as the interface between frontend applications and the underlying WordPress infrastructure managed by the ECS WordPress Hosting Platform. It enables customers to manage their WordPress sites, apply templates, install plugins, and handle asynchronous site operations.

This BRS covers **four distinct domains**:

| Domain | Description | User Stories |
|--------|-------------|--------------|
| **Sites API** | WordPress site CRUD operations, configuration, and lifecycle management | 9 |
| **Templates API** | WordPress site template management and application | 5 |
| **Plugins API** | WordPress plugin marketplace and per-site plugin management | 6 |
| **SQS Operations** | Asynchronous site creation via event-driven architecture | 4 |
| **Total** | | **24** |

### 1.3 Key Differentiators from Other APIs

| API | Scope | Primary Consumer |
|-----|-------|------------------|
| **WordPress Technical Management (This BRS)** | Sites, Templates, Plugins, Async Creation | Customer Portal Private, Admin Portal |
| **Tenant Management (BRS 2.5)** | Organisation/Tenant management, User invitations | Customer Portal Private, Admin Portal |
| **WordPress Tenant Mgmt API (BRS 2.7)** | Infrastructure provisioning (ECS, RDS, EFS) | Internal agents, backend orchestration |

### 1.4 Business Value

- **Self-Service Site Management**: Customers create and manage WordPress sites without BBWS staff intervention
- **Template Standardization**: Consistent site creation through approved templates
- **Plugin Ecosystem**: Managed plugin installation with security vetting
- **Scalable Creation**: SQS-based async processing handles high-volume site creation

### 1.5 Container Architecture: One Task per Tenant

**Decision:** Each **Tenant** (WordPress installation) runs in its own dedicated ECS Fargate task. Sites are managed within WordPress Multisite.

```
+---------------------------------------------------------+
|                      Customer A                          |
+---------------------------------------------------------+
        |                                    |
        v                                    v
+---------------------+            +---------------------+
|     Tenant 1        |            |     Tenant 2        |
|  (ECS Task 1)       |            |  (ECS Task 2)       |
|  WordPress Instance |            |  WordPress Instance |
|  +---------------+  |            |  +---------------+  |
|  | Site A        |  |            |  | Site D        |  |
|  | Site B        |  |            |  | Site E        |  |
|  | Site C        |  |            |  +---------------+  |
|  +---------------+  |            |  (Multisite)        |
|  (Multisite)        |            +---------------------+
+---------------------+
```

#### Entity Relationships

| Entity | Maps To | Cardinality |
|--------|---------|-------------|
| **Customer/Organisation** | Cognito User Pool | 1 customer : many tenants |
| **Tenant** | ECS Task + WordPress Instance | 1:1:1 |
| **Site** | WordPress Multisite Site | 1 tenant : many sites |

#### Why One Task per Tenant?

| Benefit | Description |
|---------|-------------|
| **Tenant Isolation** | Each WordPress instance isolated at container level |
| **Cost Efficiency** | Multiple sites share one container (WordPress Multisite) |
| **Flexible Scaling** | Customers can add tenants for more isolation/resources |
| **Park/Unpark at Tenant Level** | Stop entire WordPress instance to save costs |
| **Resource Allocation** | CPU/memory per tenant based on subscription tier |

#### Cost Implications

| Tier | vCPU | Memory | Sites per Tenant | Est. Cost/Tenant/Month |
|------|------|--------|------------------|------------------------|
| Basic | 0.25 | 0.5 GB | Up to 5 | ~$8-10 |
| Standard | 0.5 | 1 GB | Up to 20 | ~$15-20 |
| Premium | 1.0 | 2 GB | Up to 50 | ~$30-40 |
| Enterprise | 2.0 | 4 GB | Unlimited | ~$60-80 |
| Parked | 0 | 0 | N/A | $0 |

### 1.6 Integration Architecture: WordPress REST API

This module integrates with WordPress instances using the **native WordPress REST API** (`/wp-json/wp/v2/`).

#### Why WordPress REST API?

| Benefit | Description |
|---------|-------------|
| Native to WordPress | Built-in, well-documented, maintained by WordPress core team |
| RESTful Interface | Standard HTTP methods, JSON responses, easy to integrate |
| No Additional Dependencies | No custom plugins or CLI tools required |
| Secure | Supports JWT and Application Passwords authentication |
| Widely Adopted | Industry standard for WordPress integrations |

#### Security: Internal Only - Not Exposed to Outside World

The WordPress REST API is accessible **only** through internal Lambda functions via the private ALB. It is **never exposed** to the public internet.

```
+---------------------------------------------------------------+
|                      Customer Portal                           |
|                   (Public - Internet Facing)                   |
+---------------------------------------------------------------+
                              |
                              | HTTPS (Public API Gateway)
                              v
+---------------------------------------------------------------+
|              WordPress Technical Management API                |
|                    (Lambda Functions)                          |
|                      [VPC Connected]                           |
+---------------------------------------------------------------+
                              |
                              | HTTPS (Private - VPC Only)
                              v
+---------------------------------------------------------------+
|                 Internal ALB (Private Subnets)                 |
|                   [Not Internet Accessible]                    |
+---------------------------------------------------------------+
                              |
            +-----------------+-----------------+
            |                 |                 |
            v                 v                 v
     +-----------+     +-----------+     +-----------+
     |  Tenant A |     |  Tenant B |     |  Tenant C |
     | WordPress |     | WordPress |     | WordPress |
     |   (ECS)   |     |   (ECS)   |     |   (ECS)   |
     | /wp-json/ |     | /wp-json/ |     | /wp-json/ |
     +-----------+     +-----------+     +-----------+
            |                 |                 |
            +-----------------+-----------------+
                     Private Subnets Only
```

**Access Path:** `Lambda (VPC) -> Internal ALB -> ECS -> WordPress REST API`

**Security Controls:**
- ALB is in private subnets (no internet gateway)
- Security groups allow only Lambda -> ALB -> ECS traffic
- WordPress `/wp-json/` endpoint not publicly accessible
- Application Passwords stored in Secrets Manager

#### Authentication Method

**Application Passwords** (WordPress 5.6+):

```http
GET /wp-json/wp/v2/posts
Authorization: Basic base64(username:application_password)
```

| Aspect | Implementation |
|--------|----------------|
| Method | HTTP Basic Auth with Application Passwords |
| Storage | Application password stored in AWS Secrets Manager |
| Per-Tenant | Each tenant WordPress has dedicated application password |
| Rotation | Passwords rotated via Secrets Manager rotation Lambda |
| Scope | Full REST API access for management operations |

---

## 2. Scope Definition

### 2.1 In Scope

**Domain 1: Sites API**
- Create WordPress site
- Update WordPress site configuration
- Get site details
- List sites (by tenant/organisation)
- Delete/archive site
- Suspend/activate site
- Clone site
- Site status management (PROVISIONING, ACTIVE, SUSPENDED, DEPROVISIONING, FAILED)
- Park/unpark tenant (stop/start ECS container) - *See BRS 2.5 Tenant Management*
- Environment management (DEV, SIT, PROD)
- Environment promotion workflow

**Domain 2: Templates API**
- List available templates
- Get template details
- Create template (admin only)
- Update template
- Delete template (soft delete)
- Apply template to site
- Preview template

**Domain 3: Plugins API**
- List available plugins (marketplace)
- Install plugin to site
- Uninstall plugin from site
- Configure plugin settings
- Update plugin version
- Enable/disable plugin
- Plugin compatibility checking
- Security vulnerability scanning

**Domain 4: SQS - WP Site Creator**
- Async site creation request submission
- Site creation status polling
- Site creation completion notification
- Dead letter queue handling
- Retry policies with exponential backoff
- Event publishing for downstream consumers

### 2.2 Out of Scope

| Category | Handled By |
|----------|------------|
| Tenant Organisation Management | Tenant API (BRS 2.5) |
| Infrastructure Provisioning | WordPress Tenant Management API (BRS 2.7) |
| User Authentication | Cognito |
| Billing and Payments | Billing Service |

---

## 3. Actors and Personas

### 3.1 Actor Definitions

| Actor | Description | API Access |
|-------|-------------|------------|
| **Tenant Admin** | Customer with admin role in their organisation | Full CRUD on their sites, apply templates, manage plugins |
| **Site Owner** | Customer who owns specific site(s) | Manage their assigned sites |
| **Team Member** | Customer with user role | Create/edit sites per permissions |
| **Viewer** | Read-only customer | View sites only |
| **Platform Admin** | BBWS staff (Admin Portal) | Cross-tenant site management, template creation |
| **System** | SQS consumers, automated processes | Async site creation, event processing |

### 3.2 Cognito Groups Mapping

| Cognito Group | Sites API | Templates API | Plugins API | SQS |
|---------------|-----------|---------------|-------------|-----|
| CUSTOMER_SUPER_ADMIN | Full | Read + Apply | Full | Via API |
| CUSTOMER_ADMIN | Full | Read + Apply | Full | Via API |
| CUSTOMER_USER | Create/Edit/Read | Read + Apply | Read/Install | Via API |
| CUSTOMER_VIEWER | Read | Read | Read | N/A |
| super-admin (Staff) | Full Cross-Tenant | Full CRUD | Full | Monitor |

---

## 4. Domain 1: Sites API

### 4.1 Epic: Site Lifecycle Management

This epic covers all user stories related to WordPress site creation, configuration, and lifecycle management.

---

#### US-SITES-001: Create WordPress Site

**User Story:**
> As a Tenant Admin,
> I want to create a new WordPress site,
> So that I can launch a new website for my business.

**Pre-conditions:**
- User is authenticated with valid JWT
- User has admin or user role in tenant
- Tenant has available site quota
- Active subscription exists

**Positive Scenario:**
1. Customer navigates to Sites page
2. Customer clicks "Create New Site"
3. Customer enters: site name, subdomain, template selection
4. FrontendUI calls Sites API POST `/v1.0/tenants/{tenantId}/sites`
5. Sites API validates request (quota, name uniqueness)
6. Sites API publishes SiteCreationRequest to SQS
7. Sites API returns 202 Accepted with siteId and status=PROVISIONING
8. SQS consumer processes async creation
9. Site status updates to ACTIVE when ready
10. Customer receives notification

**Negative Scenarios:**

| Condition | HTTP Status | Error Message |
|-----------|-------------|---------------|
| Site quota exceeded | 422 | "Site limit reached for your plan" |
| Subdomain taken | 409 | "Subdomain is already in use" |
| No active subscription | 402 | "Active subscription required" |
| Invalid subdomain format | 400 | "Subdomain must be 3-63 characters, lowercase alphanumeric and hyphens" |

**Acceptance Criteria:**
- [ ] Site creation returns 202 Accepted with siteId
- [ ] Site status is initially PROVISIONING
- [ ] Subdomain uniqueness is validated
- [ ] Site quota is enforced per subscription tier
- [ ] SQS message is published for async processing
- [ ] Error messages MUST be clear and actionable

---

#### US-SITES-002: Update Site Configuration

**User Story:**
> As a Site Owner,
> I want to update my site configuration,
> So that I can customize site settings.

**Pre-conditions:**
- User is authenticated with valid JWT
- User is site owner or tenant admin
- Site exists and is in ACTIVE status

**Positive Scenario:**
1. Customer navigates to site settings
2. Customer modifies configuration (name, settings)
3. Frontend calls PUT `/v1.0/tenants/{tenantId}/sites/{siteId}`
4. API validates changes
5. API updates site configuration
6. Returns 200 OK with updated site

**Acceptance Criteria:**
- [ ] Only site owner or tenant admin can update
- [ ] Subdomain changes require DNS propagation warning
- [ ] Configuration changes are audited
- [ ] Returns 404 if site not found
- [ ] Returns 403 if user lacks permission

---

#### US-SITES-003: Get Site Details

**User Story:**
> As a Customer,
> I want to view my site details,
> So that I can see current configuration and status.

**Pre-conditions:**
- User is authenticated with valid JWT
- User has at least viewer role
- Site exists in user's tenant

**Response includes:**
- Site ID, name, subdomain
- Status (PROVISIONING/ACTIVE/SUSPENDED/FAILED)
- Environment (DEV/SIT/PROD)
- Template applied
- Plugins installed
- Health status
- Created/Updated timestamps

**Acceptance Criteria:**
- [ ] Returns full site details for authorized users
- [ ] Returns 404 if site not found
- [ ] Returns 403 if user lacks access
- [ ] Health status reflects current site condition

---

#### US-SITES-004: List Sites

**User Story:**
> As a Customer,
> I want to view all sites in my tenant,
> So that I can manage my website portfolio.

**Pre-conditions:**
- User is authenticated with valid JWT
- User has at least viewer role in tenant

**Positive Scenario:**
1. Customer navigates to Sites page
2. Frontend calls GET `/v1.0/tenants/{tenantId}/sites`
3. API returns paginated list of sites
4. Customer can filter and sort results

**Acceptance Criteria:**
- [ ] Paginated list with status indicators
- [ ] Filter by status, environment
- [ ] Sort by name, created, updated
- [ ] Returns empty array if no sites
- [ ] Includes site count in response

---

#### US-SITES-005: Delete/Archive Site

**User Story:**
> As a Tenant Admin,
> I want to delete a WordPress site,
> So that I can remove sites that are no longer needed.

**Pre-conditions:**
- User is authenticated with valid JWT
- User is tenant admin
- Site exists

**Positive Scenario:**
1. Tenant admin selects site for deletion
2. System displays confirmation with data loss warning
3. For PROD sites, system initiates 24-hour soft-delete period
4. System creates backup before deletion
5. Frontend calls DELETE `/v1.0/tenants/{tenantId}/sites/{siteId}`
6. Site status changes to DEPROVISIONING
7. Site is removed after retention period

**Business Rules Applied:**
- BR-SITE-004: PROD sites require 24-hour soft-delete
- BR-SITE-005: Backup created before deletion
- BR-SITE-006: Only tenant admin can delete sites

**Acceptance Criteria:**
- [ ] Confirmation dialog with data loss warning
- [ ] Backup created before deletion
- [ ] PROD sites have 24-hour soft-delete period
- [ ] DEV/SIT sites can be deleted immediately
- [ ] Returns 403 if user is not tenant admin

---

#### US-SITES-006: Suspend/Activate Site

**User Story:**
> As a Tenant Admin,
> I want to suspend a site temporarily,
> So that I can take it offline without deleting it.

**Pre-conditions:**
- User is authenticated with valid JWT
- User is tenant admin or site owner
- Site exists and is in ACTIVE or SUSPENDED status

**Positive Scenario (Suspend):**
1. Admin selects site and clicks "Suspend"
2. Frontend calls PUT `/v1.0/tenants/{tenantId}/sites/{siteId}/status` with status=SUSPENDED
3. Site becomes inaccessible
4. CloudFront returns 503 for site requests

**Positive Scenario (Activate):**
1. Admin selects suspended site and clicks "Activate"
2. Frontend calls PUT with status=ACTIVE
3. Site becomes accessible again

**Acceptance Criteria:**
- [ ] Suspended sites return 503 from CloudFront
- [ ] Site can be reactivated later
- [ ] Status change is logged
- [ ] Email notification sent to site owner

---

#### US-SITES-007: Clone Site

**User Story:**
> As a Site Owner,
> I want to clone an existing site,
> So that I can create a copy for testing or new projects.

**Pre-conditions:**
- User is authenticated with valid JWT
- User has admin or user role
- Source site exists and is ACTIVE
- Tenant has available site quota

**Positive Scenario:**
1. User selects site and clicks "Clone"
2. User enters new site name and subdomain
3. Frontend calls POST `/v1.0/tenants/{tenantId}/sites/{siteId}/clone`
4. API creates SQS message for async cloning
5. Returns 202 Accepted with new siteId
6. Database and files are duplicated
7. New site has new identifiers

**Acceptance Criteria:**
- [ ] Database and files duplicated
- [ ] New site has new identifiers (siteId, subdomain)
- [ ] Cloned site inherits template and plugins
- [ ] Original site is not affected
- [ ] Site quota is enforced

---

#### US-SITES-008: Promote Environment

**User Story:**
> As a Tenant Admin,
> I want to promote a site from DEV to SIT to PROD,
> So that I can follow a proper deployment workflow.

**Pre-conditions:**
- User is authenticated with valid JWT
- User is tenant admin
- Site exists in source environment
- Target environment site slot available

**Positive Scenario:**
1. Admin selects DEV site and clicks "Promote to SIT"
2. System creates backup of source site
3. Frontend calls POST `/v1.0/tenants/{tenantId}/sites/{siteId}/promote`
4. Site is cloned to target environment
5. Admin receives notification when complete

**Business Rules Applied:**
- BR-SITE-007: Sites follow DEV -> SIT -> PROD promotion
- BR-SITE-008: PROD environment is read-only

**Acceptance Criteria:**
- [ ] DEV can promote to SIT only
- [ ] SIT can promote to PROD only
- [ ] PROD cannot be promoted (read-only per CLAUDE.md)
- [ ] Backup created before promotion
- [ ] Returns 422 if invalid promotion path

---

#### US-SITES-009: Park/Unpark Tenant (Cross-Reference: BRS 2.5)

> **Note:** Parking/unparking operates at the **Tenant level**, not the Site level. Since a Tenant = WordPress Instance = ECS Task, parking stops the entire WordPress container, making all sites within that tenant unavailable. This user story is documented here for context but is **implemented in BRS 2.5 Tenant Management**.

**User Story:**
> As a Tenant Admin,
> I want to park a tenant (WordPress instance) when it's not in use,
> So that I can reduce costs while preserving all sites for future use.

**Pre-conditions:**
- User is authenticated with valid JWT
- User has admin role in organisation
- Tenant exists and is in ACTIVE status (for parking)
- Tenant exists and is in PARKED status (for unparking)

**Park Tenant Flow:**
1. Customer navigates to Tenant details page
2. Customer clicks "Park Tenant"
3. System displays confirmation: "Parking will stop the WordPress instance. ALL sites in this tenant will be unavailable until unparked. Cold start takes 30-90 seconds."
4. Customer confirms
5. Frontend calls PUT `/v1.0/tenants/{tenantId}/park`
6. Tenant API sets tenant status to PARKED
7. Tenant API sets ECS service desiredCount to 0
8. ECS container stops gracefully
9. CloudFront returns static "Tenant Parked" page for all site requests
10. Customer sees success message

**Unpark Tenant Flow:**
1. Customer navigates to Tenant details page
2. Customer clicks "Unpark Tenant"
3. Frontend calls PUT `/v1.0/tenants/{tenantId}/unpark`
4. Tenant API sets ECS service desiredCount to 1
5. Tenant API sets tenant status to STARTING
6. ECS container starts (30-90 seconds)
7. ALB health check passes
8. Tenant API sets tenant status to ACTIVE
9. All sites within tenant become available
10. Customer receives notification when tenant is ready

**Acceptance Criteria:**
- [ ] Park sets ECS desiredCount to 0
- [ ] Unpark sets ECS desiredCount to 1
- [ ] Tenant status transitions: ACTIVE -> PARKED -> STARTING -> ACTIVE
- [ ] CloudFront serves static parked page for all sites in tenant
- [ ] Cold start time < 90 seconds
- [ ] User notified when unparked tenant is ready
- [ ] Parked tenants incur $0 ECS compute cost

**Business Rules:**
- BR-TENANT-PARK-001: Parked tenants retain all data (EFS, database)
- BR-TENANT-PARK-002: All sites within parked tenant return "Tenant Parked" page
- BR-TENANT-PARK-003: Auto-unpark on first request (optional enhancement)

**See:** BRS 2.5 Tenant Management for full implementation details

---

## 5. Domain 2: Templates API

### 5.1 Epic: Template Management

This epic covers user stories related to WordPress template discovery, preview, and application.

---

#### US-TEMP-001: List Available Templates

**User Story:**
> As a Customer,
> I want to view available templates,
> So that I can choose a design for my new site.

**Pre-conditions:**
- User is authenticated with valid JWT

**Positive Scenario:**
1. Customer navigates to Templates page
2. Frontend calls GET `/v1.0/templates`
3. API returns list of PUBLISHED templates
4. Customer can filter by category

**Response includes:**
- Template name, thumbnail, description
- Category (Business, Portfolio, Blog, E-commerce)
- Rating, usage count
- Preview link

**Acceptance Criteria:**
- [ ] Only PUBLISHED templates visible to customers
- [ ] Templates filterable by category
- [ ] Thumbnail images load correctly
- [ ] Usage count and ratings displayed

---

#### US-TEMP-002: Get Template Details

**User Story:**
> As a Customer,
> I want to view template details,
> So that I can evaluate if it meets my needs.

**Pre-conditions:**
- User is authenticated with valid JWT
- Template exists and is PUBLISHED

**Response includes:**
- Full description, screenshots
- Included plugins
- Supported WordPress version
- Demo URL

**Acceptance Criteria:**
- [ ] Full template details returned
- [ ] Screenshots gallery available
- [ ] Plugin dependencies listed
- [ ] Returns 404 for non-existent templates

---

#### US-TEMP-003: Apply Template to Site

**User Story:**
> As a Site Owner,
> I want to apply a template to my site,
> So that I can quickly set up my website design.

**Pre-conditions:**
- User is authenticated with valid JWT
- User is site owner or tenant admin
- Site exists and is ACTIVE
- Template is PUBLISHED

**Positive Scenario:**
1. Customer selects site and chooses template
2. System displays warning about content replacement
3. Customer confirms
4. Frontend calls POST `/v1.0/tenants/{tenantId}/sites/{siteId}/apply-template`
5. API validates compatibility
6. API applies template theme and default content
7. Site updated with new template

**Acceptance Criteria:**
- [ ] Template compatibility validated
- [ ] Warning about data replacement shown
- [ ] Site theme and default content updated
- [ ] Included plugins installed automatically
- [ ] Returns 422 if incompatible

---

#### US-TEMP-004: Create Template (Admin Only)

**User Story:**
> As a Platform Admin,
> I want to create new templates,
> So that I can expand the template marketplace.

**Pre-conditions:**
- User is authenticated as Platform Admin (super-admin)

**Positive Scenario:**
1. Admin navigates to Template Management
2. Admin uploads theme configuration
3. Admin fills template metadata
4. Frontend calls POST `/admin/templates`
5. Template saved as DRAFT
6. Admin can preview and publish when ready

**Acceptance Criteria:**
- [ ] Admin uploads theme configuration
- [ ] Template saved as DRAFT initially
- [ ] Admin can publish when ready
- [ ] Version follows semver format
- [ ] Returns 403 for non-admin users

---

#### US-TEMP-005: Preview Template

**User Story:**
> As a Customer,
> I want to preview a template,
> So that I can see how it looks before applying.

**Pre-conditions:**
- User is authenticated with valid JWT
- Template exists and is PUBLISHED

**Positive Scenario:**
1. Customer clicks "Preview" on template
2. Frontend calls GET `/v1.0/templates/{templateId}/preview`
3. API returns demo URL
4. Demo site opens in new tab

**Acceptance Criteria:**
- [ ] Demo site opens in new tab
- [ ] Demo has clear preview branding
- [ ] Preview URL is time-limited or read-only

---

## 6. Domain 3: Plugins API

### 6.1 Epic: Plugin Management

This epic covers user stories related to WordPress plugin discovery, installation, and management.

---

#### US-PLUG-001: List Available Plugins

**User Story:**
> As a Customer,
> I want to view available plugins in the marketplace,
> So that I can enhance my site functionality.

**Pre-conditions:**
- User is authenticated with valid JWT

**Positive Scenario:**
1. Customer navigates to Plugin Marketplace
2. Frontend calls GET `/v1.0/plugins`
3. API returns list of available plugins
4. Customer can filter and search

**Response includes:**
- Plugin name, description, icon
- Category (SEO, Security, Performance, Forms)
- Rating, install count
- Pricing (free or premium)
- Compatibility info

**Acceptance Criteria:**
- [ ] Marketplace displays all approved plugins
- [ ] Blocklisted plugins not shown
- [ ] Filter by category and pricing
- [ ] Search by name/description

---

#### US-PLUG-002: Install Plugin to Site

**User Story:**
> As a Site Owner,
> I want to install a plugin on my site,
> So that I can add new functionality.

**Pre-conditions:**
- User is authenticated with valid JWT
- User is site owner or has install permission
- Site exists and is ACTIVE
- Plugin is not blocklisted

**Positive Scenario:**
1. Customer selects plugin and clicks "Install"
2. Frontend calls POST `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins`
3. API runs security scan
4. API validates compatibility
5. API installs and activates plugin
6. Returns success with plugin details

**Negative Scenarios:**

| Condition | HTTP Status | Error Message |
|-----------|-------------|---------------|
| Plugin has known vulnerability | 422 | "Plugin has security vulnerabilities and cannot be installed" |
| Incompatible version | 422 | "Plugin requires WordPress X.X or higher" |
| Plugin conflicts | 409 | "Plugin conflicts with [existing plugin]" |
| Plugin blocklisted | 422 | "This plugin is not available for installation" |

**Acceptance Criteria:**
- [ ] Site is in ACTIVE status
- [ ] Plugin compatibility validated
- [ ] Security scan runs before install
- [ ] Plugin activated after install
- [ ] Conflicts detected and reported

---

#### US-PLUG-003: Uninstall Plugin from Site

**User Story:**
> As a Site Owner,
> I want to uninstall a plugin from my site,
> So that I can remove functionality I no longer need.

**Pre-conditions:**
- User is authenticated with valid JWT
- User is site owner or tenant admin
- Plugin is installed on site

**Positive Scenario:**
1. Customer selects installed plugin and clicks "Uninstall"
2. System displays confirmation with data warning
3. Customer confirms
4. Frontend calls DELETE `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins/{pluginId}`
5. Plugin deactivated and removed
6. Returns success

**Acceptance Criteria:**
- [ ] Confirmation with data warning shown
- [ ] Plugin deactivated before removal
- [ ] Plugin files removed
- [ ] Returns 404 if plugin not installed

---

#### US-PLUG-004: Configure Plugin Settings

**User Story:**
> As a Site Owner,
> I want to configure plugin settings,
> So that I can customize plugin behavior.

**Pre-conditions:**
- User is authenticated with valid JWT
- User is site owner or tenant admin
- Plugin is installed and active

**Positive Scenario:**
1. Customer navigates to plugin settings
2. Customer modifies configuration
3. Frontend calls PUT `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins/{pluginId}/config`
4. API saves configuration
5. Plugin reconfigured

**Acceptance Criteria:**
- [ ] Configuration saved successfully
- [ ] Plugin reconfigured with new settings
- [ ] Invalid configuration rejected with clear error

---

#### US-PLUG-005: Update Plugin

**User Story:**
> As a Site Owner,
> I want to update a plugin to the latest version,
> So that I can get new features and security fixes.

**Pre-conditions:**
- User is authenticated with valid JWT
- User is site owner or tenant admin
- Plugin has available update
- Site is ACTIVE

**Positive Scenario:**
1. System displays available update notification
2. Customer clicks "Update"
3. Frontend calls PUT `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins/{pluginId}/update`
4. API updates plugin to latest version
5. API validates site health after update
6. Returns success

**Acceptance Criteria:**
- [ ] Plugin updated to latest version
- [ ] Site health validated after update
- [ ] Configuration preserved after update
- [ ] Rollback available if update fails

---

#### US-PLUG-006: Enable/Disable Plugin

**User Story:**
> As a Site Owner,
> I want to enable or disable a plugin,
> So that I can control active functionality without uninstalling.

**Pre-conditions:**
- User is authenticated with valid JWT
- User is site owner or tenant admin
- Plugin is installed on site

**Positive Scenario:**
1. Customer toggles plugin status
2. Frontend calls PUT `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins/{pluginId}/status`
3. Plugin activated or deactivated
4. Status change reflected immediately

**Acceptance Criteria:**
- [ ] Plugin activated or deactivated
- [ ] Status change reflected immediately
- [ ] No data loss when disabling
- [ ] Plugin can be re-enabled later

---

## 7. Domain 4: SQS Operations

### 7.1 Architecture Overview

```
                                    +------------------------------+
                                    |       Customer Portal        |
                                    +-------------+----------------+
                                                  |
                                                  v
                                    +------------------------------+
                                    |          Sites API           |
                                    +-------------+----------------+
                                                  |
                        +-------------------------+-------------------------+
                        |                         |                         |
                        v                         v                         v
          +---------------------+   +---------------------+   +---------------------+
          |  Site Creation Queue|   |  Site Update Queue  |   | Site Deletion Queue |
          +----------+----------+   +----------+----------+   +----------+----------+
                     |                         |                         |
                     v                         v                         v
          +---------------------+   +---------------------+   +---------------------+
          | Site Creator Lambda |   | Site Updater Lambda |   | Site Deleter Lambda |
          +----------+----------+   +----------+----------+   +----------+----------+
                     |                         |                         |
                     +-------------------------+-------------------------+
                                               |
                                               v
                                    +------------------------------+
                                    |    Dead Letter Queue (DLQ)   |
                                    +-------------+----------------+
                                                  |
                                                  v
                                    +------------------------------+
                                    | CloudWatch Alarm -> SNS -> Ops|
                                    +------------------------------+
```

### 7.2 Queue Configuration

**Site Creation Queue:**
- Queue Name: `bbws-wp-site-creation-{env}`
- Visibility Timeout: 900 seconds (15 minutes)
- Message Retention: 4 days

**Site Update Queue:**
- Queue Name: `bbws-wp-site-update-{env}`
- Visibility Timeout: 600 seconds (10 minutes)
- Message Retention: 4 days

**Site Deletion Queue:**
- Queue Name: `bbws-wp-site-deletion-{env}`
- Visibility Timeout: 600 seconds (10 minutes)
- Message Retention: 4 days

**Dead Letter Queue (Shared):**
- Queue Name: `bbws-wp-site-operations-dlq-{env}`
- Max Receive Count: 3
- Message Retention: 14 days

**Retry Policy:**
- Exponential backoff: 1s, 2s, 4s, 8s... (capped at 5 minutes)
- Maximum retries: 3

### 7.3 Epic: Async Site Operations

---

#### US-SQS-001: Submit Async Site Creation

**User Story:**
> As a Customer,
> I want site creation to happen asynchronously,
> So that I receive immediate feedback while the site is provisioned.

**Pre-conditions:**
- Site creation request validated
- Site record created with PROVISIONING status

**Flow:**
1. Sites API receives POST `/v1.0/tenants/{tenantId}/sites`
2. Sites API creates Site record with status=PROVISIONING
3. Sites API publishes SiteCreationRequest to SQS
4. Sites API returns 202 Accepted immediately
5. Lambda picks up message and provisions resources
6. Lambda updates Site status to ACTIVE
7. Lambda publishes completion event to SNS

**Message Schema - SiteCreationRequest:**
```json
{
  "messageType": "SITE_CREATION_REQUEST",
  "correlationId": "uuid",
  "timestamp": "ISO8601",
  "payload": {
    "siteId": "uuid",
    "tenantId": "uuid",
    "siteName": "string",
    "subdomain": "string",
    "templateId": "uuid|null",
    "environment": "DEV",
    "configuration": {
      "wordpressVersion": "6.5",
      "phpVersion": "8.2",
      "plugins": ["pluginId1"]
    }
  }
}
```

**Acceptance Criteria:**
- [ ] API returns 202 Accepted immediately
- [ ] SQS message contains all required data
- [ ] Correlation ID enables request tracking
- [ ] Site status updates as provisioning progresses

---

#### US-SQS-002: Poll Site Creation Status

**User Story:**
> As a Customer,
> I want to check site creation status,
> So that I know when my site is ready.

**Pre-conditions:**
- Site creation request submitted
- Site record exists

**Flow:**
1. Customer polls GET `/v1.0/tenants/{tenantId}/sites/{siteId}`
2. API returns current status: PROVISIONING, ACTIVE, or FAILED
3. Customer continues polling until terminal state

**Acceptance Criteria:**
- [ ] Customer polls GET `/v1.0/tenants/{tenantId}/sites/{siteId}`
- [ ] Returns PROVISIONING, ACTIVE, or FAILED
- [ ] Includes progress percentage when available
- [ ] Recommended polling interval: 5 seconds

---

#### US-SQS-003: Handle Creation Failure

**User Story:**
> As a System,
> I want failed site creations to be retried,
> So that transient failures don't cause permanent issues.

**Pre-conditions:**
- Site creation Lambda encountered error
- Message still within retry limit

**Flow (Retry):**
1. Lambda throws error
2. SQS waits visibility timeout
3. Message reprocessed with exponential backoff
4. Retry up to 3 times

**Flow (DLQ):**
1. After 3 failures, message moves to DLQ
2. CloudWatch alarm triggers
3. SNS notification sent to operations
4. Site status set to FAILED

**Acceptance Criteria:**
- [ ] Retry 3 times with exponential backoff
- [ ] Move to DLQ after 3 failures
- [ ] CloudWatch alarm triggers on DLQ message
- [ ] Site status set to FAILED
- [ ] Operations team notified

---

#### US-SQS-004: Receive Completion Notification

**User Story:**
> As a Customer,
> I want to receive notification when my site is ready,
> So that I don't have to keep polling.

**Pre-conditions:**
- Site creation completed (success or failure)
- Customer notification preferences configured

**Flow:**
1. Site Creator Lambda completes successfully
2. Lambda publishes SiteCreationComplete to SNS
3. Notification Service subscribes to SNS
4. Email sent to customer with site URL

**Message Schema - SiteCreationComplete:**
```json
{
  "eventType": "SITE_CREATION_COMPLETE",
  "payload": {
    "siteId": "uuid",
    "tenantId": "uuid",
    "status": "ACTIVE",
    "siteUrl": "https://subdomain.wpdev.kimmyai.io",
    "provisioningDuration": 180
  }
}
```

**Acceptance Criteria:**
- [ ] SNS publishes SiteCreationComplete event
- [ ] Notification Service emails customer
- [ ] Email includes site URL and login instructions
- [ ] Failure notifications include next steps

---

## 8. Business Rules

### 8.1 Site Business Rules

| Rule ID | Rule |
|---------|------|
| BR-SITE-001 | Subdomain must be unique across all tenants |
| BR-SITE-002 | Subdomain: 3-63 characters, lowercase alphanumeric and hyphens |
| BR-SITE-003 | Site quota enforced per subscription tier |
| BR-SITE-004 | PROD sites require 24-hour soft-delete before permanent removal |
| BR-SITE-005 | Backup created before deletion |
| BR-SITE-006 | Only tenant admin can delete sites |
| BR-SITE-007 | Sites follow DEV -> SIT -> PROD promotion only |
| BR-SITE-008 | PROD environment is read-only |

### 8.2 Template Business Rules

| Rule ID | Rule |
|---------|------|
| BR-TEMP-001 | Only PUBLISHED templates visible to customers |
| BR-TEMP-002 | Template cannot be deleted if in use |
| BR-TEMP-003 | Template version must follow semver format |
| BR-TEMP-004 | Applying template replaces theme |
| BR-TEMP-005 | Template compatibility must be validated before application |

### 8.3 Plugin Business Rules

| Rule ID | Rule |
|---------|------|
| BR-PLUG-001 | Blocklisted plugins cannot be installed |
| BR-PLUG-002 | Security scan runs before installation |
| BR-PLUG-003 | Plugin conflicts must be detected before installation |
| BR-PLUG-004 | Plugin updates preserve configuration |
| BR-PLUG-005 | Uninstall must warn about potential data loss |

### 8.4 SQS Business Rules

| Rule ID | Rule |
|---------|------|
| BR-SQS-001 | Maximum 3 retries before DLQ |
| BR-SQS-002 | Exponential backoff between retries |
| BR-SQS-003 | DLQ messages trigger CloudWatch alarm |
| BR-SQS-004 | Site creation must complete within 15 minutes |
| BR-SQS-005 | Idempotency key prevents duplicate processing |

---

## 9. API Endpoints

### 9.1 Sites API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1.0/tenants/{tenantId}/sites` | Create new site |
| GET | `/v1.0/tenants/{tenantId}/sites` | List sites |
| GET | `/v1.0/tenants/{tenantId}/sites/{siteId}` | Get site details |
| PUT | `/v1.0/tenants/{tenantId}/sites/{siteId}` | Update site config |
| DELETE | `/v1.0/tenants/{tenantId}/sites/{siteId}` | Delete site |
| POST | `/v1.0/tenants/{tenantId}/sites/{siteId}/clone` | Clone site |
| PUT | `/v1.0/tenants/{tenantId}/sites/{siteId}/status` | Suspend/activate |
| POST | `/v1.0/tenants/{tenantId}/sites/{siteId}/promote` | Promote environment |
| GET | `/v1.0/tenants/{tenantId}/sites/{siteId}/health` | Get site health |
| POST | `/v1.0/tenants/{tenantId}/sites/{siteId}/backup` | Create backup |
| POST | `/v1.0/tenants/{tenantId}/sites/{siteId}/restore` | Restore from backup |

### 9.2 Tenant-Level Endpoints (See BRS 2.5)

| Method | Endpoint | Description |
|--------|----------|-------------|
| PUT | `/v1.0/tenants/{tenantId}/park` | Park tenant (stop container) |
| PUT | `/v1.0/tenants/{tenantId}/unpark` | Unpark tenant (start container) |

### 9.3 Templates API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/v1.0/templates` | List templates |
| GET | `/v1.0/templates/{templateId}` | Get template details |
| POST | `/v1.0/tenants/{tenantId}/sites/{siteId}/apply-template` | Apply template |
| GET | `/v1.0/templates/{templateId}/preview` | Get preview URL |

**Admin Endpoints:**

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/admin/templates` | Create template |
| PUT | `/admin/templates/{templateId}` | Update template |
| DELETE | `/admin/templates/{templateId}` | Delete template |
| POST | `/admin/templates/{templateId}/publish` | Publish template |

### 9.4 Plugins API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/v1.0/plugins` | List marketplace |
| GET | `/v1.0/plugins/{pluginId}` | Get plugin details |
| GET | `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins` | List installed |
| POST | `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins` | Install plugin |
| DELETE | `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins/{pluginId}` | Uninstall |
| PUT | `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins/{pluginId}/config` | Configure |
| PUT | `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins/{pluginId}/update` | Update |
| PUT | `/v1.0/tenants/{tenantId}/sites/{siteId}/plugins/{pluginId}/status` | Enable/disable |

---

## 10. Data Model

### 10.1 Site Data Model

```json
{
  "PK": "TENANT#{tenantId}",
  "SK": "SITE#{siteId}",
  "siteId": "uuid",
  "tenantId": "uuid",
  "siteName": "string",
  "subdomain": "string",
  "status": "PROVISIONING|ACTIVE|SUSPENDED|DEPROVISIONING|FAILED",
  "environment": "DEV|SIT|PROD",
  "templateId": "uuid|null",
  "wordpressVersion": "string",
  "phpVersion": "string",
  "createdAt": "ISO8601",
  "updatedAt": "ISO8601",
  "healthStatus": "HEALTHY|DEGRADED|UNHEALTHY|UNKNOWN"
}
```

### 10.2 Template Data Model

```json
{
  "PK": "TEMPLATE",
  "SK": "TEMPLATE#{templateId}",
  "templateId": "uuid",
  "name": "string",
  "description": "string",
  "category": "BUSINESS|PORTFOLIO|BLOG|ECOMMERCE|OTHER",
  "version": "string",
  "thumbnailUrl": "string",
  "demoUrl": "string",
  "status": "DRAFT|PUBLISHED|ARCHIVED",
  "minWordPressVersion": "string",
  "includedPlugins": ["pluginId"],
  "usageCount": "number",
  "createdAt": "ISO8601"
}
```

### 10.3 Plugin Data Models

**Marketplace Plugin:**
```json
{
  "PK": "PLUGIN",
  "SK": "PLUGIN#{pluginId}",
  "pluginId": "uuid",
  "name": "string",
  "description": "string",
  "category": "SEO|SECURITY|PERFORMANCE|FORMS|ECOMMERCE|OTHER",
  "rating": "number (1-5)",
  "installCount": "number",
  "pricing": "FREE|PREMIUM",
  "isBlocklisted": "boolean",
  "lastSecurityScan": "ISO8601"
}
```

**Installed Plugin:**
```json
{
  "PK": "SITE#{siteId}",
  "SK": "PLUGIN#{pluginId}",
  "installedVersion": "string",
  "isActive": "boolean",
  "configuration": {},
  "installedAt": "ISO8601"
}
```

---

## 11. Non-Functional Requirements

### 11.1 Performance

| Requirement | Specification |
|-------------|---------------|
| API Response Time | < 500ms for 95th percentile |
| Site Creation Time | < 15 minutes end-to-end |
| Template List Load | < 2 seconds |
| Plugin Marketplace Load | < 2 seconds |
| Concurrent Site Creations | Support 10 simultaneous |

### 11.2 Security

| Aspect | Implementation |
|--------|----------------|
| Authentication | JWT from Cognito |
| Authorization | Tenant-scoped, role-based |
| Plugin Scanning | Automated vulnerability scan |
| Audit Logging | All CRUD operations logged |
| Data Encryption | At rest and in transit |

### 11.3 Availability

| Metric | Target |
|--------|--------|
| API Availability | 99.9% |
| SQS Availability | 99.999% (AWS SLA) |
| RTO | 4 hours |
| RPO | 1 hour |

### 11.4 Scalability

| Aspect | Specification |
|--------|---------------|
| DynamoDB Capacity | On-demand mode |
| Lambda Concurrency | Auto-scaling |
| SQS Throughput | Unlimited (standard queues) |

---

## 12. Error Handling

### 12.1 API Error Responses

| Status | Error Type | Description |
|--------|------------|-------------|
| 400 | Bad Request | Invalid request syntax or parameters |
| 401 | Unauthorized | Missing or invalid JWT |
| 402 | Payment Required | No active subscription |
| 403 | Forbidden | Insufficient permissions |
| 404 | Not Found | Resource not found |
| 409 | Conflict | Resource conflict (e.g., subdomain taken) |
| 422 | Unprocessable Entity | Business rule violation |
| 429 | Too Many Requests | Rate limit exceeded |
| 500 | Internal Server Error | Unexpected server error |
| 503 | Service Unavailable | Service temporarily unavailable |

### 12.2 SQS Error Handling

| Error Type | Handling |
|------------|----------|
| Transient Failure | Retry with exponential backoff |
| Permanent Failure | Move to DLQ after 3 attempts |
| Timeout | Extend visibility, retry |
| Malformed Message | Log, move to DLQ immediately |

---

## 13. Value-Add Features

### 13.1 Differentiators from Basic Hosting

The following capabilities differentiate BBWS from commodity ISP/WordPress hosting providers and represent significant customer value-add:

| Feature | Value Beyond Basic Hosting |
|---------|---------------------------|
| **Site Management API** | Self-service site creation, cloning, promotion between environments (DEV -> SIT -> PROD) - not available in basic hosting |
| **Template Marketplace** | Pre-built, vetted templates with one-click application - reduces time-to-launch from days to minutes |
| **Plugin Management** | Curated plugin marketplace with security scanning, compatibility checking, and managed updates - eliminates plugin security risks |
| **Domain Parking/Unparking** | Cost-saving feature to stop containers for inactive tenants while preserving data - customers only pay for active usage |
| **Environment Promotion** | Built-in DEV -> SIT -> PROD workflow with backups - enterprise-grade deployment pipeline |
| **Health Monitoring** | Integrated site health checks and alerts - proactive issue detection |

### 13.2 Business Impact

These features transform BBWS from a hosting provider into a **managed WordPress platform**, commanding premium pricing and increasing customer retention through platform lock-in via value, not restriction.

---

## 14. References

| Document | Path |
|----------|------|
| BRS 2.0: ECS WordPress | `/Users/tebogotseka/Documents/agentic_work/2_bbws_docs/BRS/2.0_BRS_ECS_WordPress.md` |
| BRS 2.1: Customer Portal Public | `/Users/tebogotseka/Documents/agentic_work/2_bbws_docs/BRS/2.1_BRS_Customer_Portal_Public.md` |
| BRS 2.2: Customer Portal Private | `/Users/tebogotseka/Documents/agentic_work/2_bbws_docs/BRS/2.2_BRS_Customer_Portal_Private.md` |
| BRS 2.5: Tenant Management | (Cross-reference for park/unpark) |
| BRS 2.7: WordPress Tenant Management API | (Infrastructure provisioning) |
| HLD 2.1: Customer Portal Public | `/Users/tebogotseka/Documents/agentic_work/2_bbws_docs/HLDs/2.1_BBWS_Customer_Portal_Public_HLD_V1.1.md` |

---

## 15. Glossary

| Term | Definition |
|------|------------|
| **Tenant** | A WordPress installation running in a dedicated ECS task |
| **Site** | A WordPress Multisite site within a tenant |
| **Template** | Pre-configured WordPress theme with default content |
| **Plugin** | WordPress plugin available in the BBWS marketplace |
| **Environment** | DEV, SIT, or PROD deployment stage |
| **Parking** | Stopping an ECS task to save costs while preserving data |
| **DLQ** | Dead Letter Queue for failed message processing |
| **ALB** | Application Load Balancer |
| **ECS** | Elastic Container Service |
| **JWT** | JSON Web Token for authentication |

---

## 16. Sign-Off

| Role | Name | Signature | Date |
|------|------|-----------|------|
| Product Owner | | | |
| Technical Lead | | | |
| Solutions Architect | | | |
| QA Lead | | | |

---

**End of Document**
