# Worker 1: create_order Lambda Implementation

**Worker ID**: Worker 1
**Lambda Function**: create_order
**Type**: API Handler
**Endpoint**: POST /v1.0/orders
**Priority**: High
**Status**: PENDING

---

## Objective

Implement the `create_order` Lambda function that accepts new order requests via API Gateway, validates the request data, and publishes a message to SQS for asynchronous processing.

---

## Specifications

### API Endpoint
- **Method**: POST
- **Path**: /v1.0/orders
- **Authentication**: Cognito JWT (Bearer token)
- **Request Body**: CreateOrderRequest (JSON)
- **Response**: 202 Accepted with orderId and orderNumber

### Functionality

1. **Extract and validate JWT claims**
   - Extract tenantId from `event['requestContext']['authorizer']['claims']['custom:tenantId']`
   - Extract userId from JWT claims

2. **Parse and validate request body**
   - Parse JSON body from `event['body']`
   - Validate against CreateOrderRequest Pydantic model
   - Required fields: customerEmail, items[], billingAddress
   - Optional fields: campaignCode

3. **Generate order identifiers**
   - Generate orderId: UUID v4 (`str(uuid.uuid4())`)
   - Note: orderNumber will be generated by Worker 5 (sequential)

4. **Enrich order data**
   - Add tenantId from JWT
   - Add userId from JWT
   - Add dateCreated (ISO 8601 timestamp)
   - Add status = "pending"

5. **Publish to SQS**
   - Queue: `bbws-order-creation-{env}` (from environment variable)
   - Message body: Complete order data as JSON
   - Message attributes: tenantId, orderId

6. **Return response**
   - Status: 202 Accepted
   - Body: CreateOrderResponse with orderId, status, message

---

## Implementation Requirements

### 1. Handler File

**Location**: `src/handlers/create_order.py`

**Structure**:
```python
import json
import logging
import os
import uuid
from datetime import datetime
from typing import Dict, Any
import boto3
from src.models.requests import CreateOrderRequest
from src.models.responses import CreateOrderResponse
from src.services.sqs_service import SQSService

logger = logging.getLogger()
logger.setLevel(os.environ.get('LOG_LEVEL', 'INFO'))

# Initialize SQS client outside handler for reuse
sqs_client = boto3.client('sqs')
sqs_queue_url = os.environ['SQS_QUEUE_URL']
sqs_service = SQSService(sqs_client, sqs_queue_url)

def lambda_handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    """
    Lambda handler for creating new orders.

    Accepts order requests via API Gateway, validates the data,
    and publishes to SQS for asynchronous processing.

    Args:
        event: API Gateway proxy event
        context: Lambda context

    Returns:
        API Gateway response (202 Accepted)
    """
    try:
        # Extract tenant ID from JWT
        # Parse request body
        # Validate with Pydantic
        # Generate order ID
        # Publish to SQS
        # Return 202 response
        pass

    except ValueError as e:
        # 400 Bad Request
        pass
    except Exception as e:
        # 500 Internal Server Error
        pass
```

### 2. Pydantic Models

**Location**: `src/models/requests.py`

```python
from pydantic import BaseModel, Field, validator
from typing import List, Optional

class OrderItemRequest(BaseModel):
    """Order item in create request."""
    productId: str = Field(..., description="Product identifier")
    productName: str = Field(..., description="Product name")
    quantity: int = Field(..., ge=1, description="Quantity (min 1)")
    unitPrice: float = Field(..., ge=0, description="Unit price")

    @validator('quantity')
    def validate_quantity(cls, v):
        if v < 1:
            raise ValueError("Quantity must be at least 1")
        return v

class BillingAddressRequest(BaseModel):
    """Billing address in create request."""
    fullName: str = Field(..., min_length=1)
    addressLine1: str = Field(..., min_length=1)
    addressLine2: Optional[str] = None
    city: str = Field(..., min_length=1)
    stateProvince: str = Field(..., min_length=1)
    postalCode: str = Field(..., min_length=1)
    country: str = Field(..., min_length=2, max_length=2)  # ISO 3166-1 alpha-2

class CreateOrderRequest(BaseModel):
    """Request model for creating a new order."""
    customerEmail: str = Field(..., description="Customer email address")
    items: List[OrderItemRequest] = Field(..., min_items=1)
    billingAddress: BillingAddressRequest
    campaignCode: Optional[str] = None

    @validator('customerEmail')
    def validate_email(cls, v):
        # Basic email validation
        if '@' not in v or '.' not in v:
            raise ValueError("Invalid email address")
        return v.lower()

    @validator('items')
    def validate_items(cls, v):
        if not v:
            raise ValueError("At least one item is required")
        return v
```

**Location**: `src/models/responses.py`

```python
from pydantic import BaseModel, Field
from typing import Optional

class CreateOrderResponse(BaseModel):
    """Response model for order creation."""
    orderId: str = Field(..., description="Unique order identifier")
    orderNumber: Optional[str] = Field(None, description="Human-readable order number (assigned later)")
    status: str = Field(default="pending", description="Order status")
    message: str = Field(default="Order accepted for processing")
```

### 3. SQS Service

**Location**: `src/services/sqs_service.py`

```python
import json
import logging
from typing import Dict, Any

logger = logging.getLogger(__name__)

class SQSService:
    """Service for SQS operations."""

    def __init__(self, sqs_client, queue_url: str):
        self.sqs = sqs_client
        self.queue_url = queue_url

    def publish_order_message(self, order_data: Dict[str, Any]) -> str:
        """
        Publish order creation message to SQS.

        Args:
            order_data: Complete order data dictionary

        Returns:
            SQS message ID

        Raises:
            Exception: If SQS publish fails
        """
        try:
            response = self.sqs.send_message(
                QueueUrl=self.queue_url,
                MessageBody=json.dumps(order_data),
                MessageAttributes={
                    'tenantId': {
                        'StringValue': order_data.get('tenantId', ''),
                        'DataType': 'String'
                    },
                    'orderId': {
                        'StringValue': order_data.get('orderId', ''),
                        'DataType': 'String'
                    }
                }
            )

            message_id = response['MessageId']
            logger.info(f"Published order to SQS: {message_id}")
            return message_id

        except Exception as e:
            logger.error(f"Failed to publish to SQS: {str(e)}")
            raise
```

### 4. Unit Tests

**Location**: `tests/unit/test_create_order_handler.py`

```python
import pytest
import json
from unittest.mock import Mock, patch
from src.handlers.create_order import lambda_handler

@pytest.fixture
def api_gateway_event():
    """Sample API Gateway event."""
    return {
        'httpMethod': 'POST',
        'path': '/v1.0/orders',
        'body': json.dumps({
            'customerEmail': 'customer@example.com',
            'items': [
                {
                    'productId': 'prod-123',
                    'productName': 'Test Product',
                    'quantity': 2,
                    'unitPrice': 50.00
                }
            ],
            'billingAddress': {
                'fullName': 'John Doe',
                'addressLine1': '123 Main St',
                'city': 'Cape Town',
                'stateProvince': 'Western Cape',
                'postalCode': '8001',
                'country': 'ZA'
            }
        }),
        'requestContext': {
            'authorizer': {
                'claims': {
                    'custom:tenantId': 'tenant-123',
                    'sub': 'user-456'
                }
            }
        }
    }

def test_create_order_success(api_gateway_event):
    """Test successful order creation."""
    with patch('src.handlers.create_order.sqs_service') as mock_sqs:
        mock_sqs.publish_order_message.return_value = 'msg-123'

        response = lambda_handler(api_gateway_event, None)

        assert response['statusCode'] == 202
        body = json.loads(response['body'])
        assert body['success'] is True
        assert 'orderId' in body['data']
        assert body['data']['status'] == 'pending'

def test_create_order_invalid_email(api_gateway_event):
    """Test order creation with invalid email."""
    body_data = json.loads(api_gateway_event['body'])
    body_data['customerEmail'] = 'invalid-email'
    api_gateway_event['body'] = json.dumps(body_data)

    response = lambda_handler(api_gateway_event, None)

    assert response['statusCode'] == 400
    body = json.loads(response['body'])
    assert 'error' in body

def test_create_order_missing_items(api_gateway_event):
    """Test order creation without items."""
    body_data = json.loads(api_gateway_event['body'])
    body_data['items'] = []
    api_gateway_event['body'] = json.dumps(body_data)

    response = lambda_handler(api_gateway_event, None)

    assert response['statusCode'] == 400

def test_create_order_sqs_failure(api_gateway_event):
    """Test SQS publish failure."""
    with patch('src.handlers.create_order.sqs_service') as mock_sqs:
        mock_sqs.publish_order_message.side_effect = Exception("SQS error")

        response = lambda_handler(api_gateway_event, None)

        assert response['statusCode'] == 500
```

**Location**: `tests/unit/test_sqs_service.py`

```python
import pytest
from unittest.mock import Mock
from src.services.sqs_service import SQSService

def test_publish_order_message_success():
    """Test successful message publishing."""
    mock_sqs_client = Mock()
    mock_sqs_client.send_message.return_value = {'MessageId': 'msg-123'}

    service = SQSService(mock_sqs_client, 'https://sqs.queue.url')

    order_data = {
        'orderId': 'order-123',
        'tenantId': 'tenant-456'
    }

    message_id = service.publish_order_message(order_data)

    assert message_id == 'msg-123'
    mock_sqs_client.send_message.assert_called_once()

def test_publish_order_message_failure():
    """Test message publishing failure."""
    mock_sqs_client = Mock()
    mock_sqs_client.send_message.side_effect = Exception("SQS error")

    service = SQSService(mock_sqs_client, 'https://sqs.queue.url')

    with pytest.raises(Exception):
        service.publish_order_message({'orderId': 'test'})
```

### 5. Integration Tests

**Location**: `tests/integration/test_create_order_integration.py`

```python
import pytest
import json
from moto import mock_sqs
import boto3
from src.handlers.create_order import lambda_handler

@mock_sqs
def test_create_order_full_flow():
    """Test complete create order flow with mocked SQS."""
    # Setup mock SQS
    sqs = boto3.client('sqs', region_name='eu-west-1')
    queue = sqs.create_queue(QueueName='test-order-queue')
    queue_url = queue['QueueUrl']

    # Mock environment
    import os
    os.environ['SQS_QUEUE_URL'] = queue_url

    # Create test event
    event = {
        'httpMethod': 'POST',
        'body': json.dumps({
            'customerEmail': 'test@example.com',
            'items': [{'productId': 'p1', 'productName': 'Product 1', 'quantity': 1, 'unitPrice': 10.0}],
            'billingAddress': {
                'fullName': 'Test User',
                'addressLine1': '123 St',
                'city': 'City',
                'stateProvince': 'State',
                'postalCode': '12345',
                'country': 'US'
            }
        }),
        'requestContext': {
            'authorizer': {
                'claims': {
                    'custom:tenantId': 'tenant-1',
                    'sub': 'user-1'
                }
            }
        }
    }

    # Execute handler
    response = lambda_handler(event, None)

    # Verify response
    assert response['statusCode'] == 202

    # Verify SQS message
    messages = sqs.receive_message(QueueUrl=queue_url, MaxNumberOfMessages=1)
    assert 'Messages' in messages
    assert len(messages['Messages']) == 1
```

---

## Environment Variables

```bash
# Required
SQS_QUEUE_URL=https://sqs.{region}.amazonaws.com/{account}/bbws-order-creation-{env}
LOG_LEVEL=INFO

# Optional
ENABLE_XRAY=false
```

---

## Deliverables

1. ✅ `src/handlers/create_order.py` - Lambda handler implementation
2. ✅ `src/models/requests.py` - CreateOrderRequest, OrderItemRequest, BillingAddressRequest
3. ✅ `src/models/responses.py` - CreateOrderResponse
4. ✅ `src/services/sqs_service.py` - SQS publishing service
5. ✅ `tests/unit/test_create_order_handler.py` - Handler unit tests
6. ✅ `tests/unit/test_sqs_service.py` - SQS service unit tests
7. ✅ `tests/integration/test_create_order_integration.py` - Integration tests
8. ✅ `output.md` - Worker output documentation

---

## Success Criteria

- ✅ Handler validates request using Pydantic models
- ✅ Handler extracts tenantId from JWT claims
- ✅ Handler generates valid UUID v4 for orderId
- ✅ Handler publishes complete order data to SQS
- ✅ Handler returns 202 Accepted with orderId
- ✅ Error handling for invalid requests (400)
- ✅ Error handling for SQS failures (500)
- ✅ Unit test coverage ≥ 80%
- ✅ All tests passing
- ✅ PEP 8 compliant
- ✅ Type hints on all functions
- ✅ Docstrings on all public functions

---

## References

- Stage 2 Plan: `../plan.md`
- LLD: `../../../2.1.8_LLD_Order_Lambda.md`
- Stage 1 Requirements: `../../stage-1-repository-requirements/worker-2-requirements-extraction/output.md`

---

**Status**: READY FOR EXECUTION
**Estimated Effort**: 4-6 hours
**Dependencies**: None (can start immediately)
